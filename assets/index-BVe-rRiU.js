var SF=Object.defineProperty;var IF=(i,e,t)=>e in i?SF(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var pe=(i,e,t)=>IF(i,typeof e!="symbol"?e+"":e,t);import{e as n0,a as Ot,j as Dt,f as CF,h as ec,i as MF,g as OC,d as FC,_ as RF}from"./index-BS7m11OF.js";import{g as PF,e as BF,u as DF,s as OF,a as FF,h as ny,f as kF,m as LF,au as NF,ap as _w,av as zF,Y as l1,V as s0,p as c1,a7 as kC,a9 as LC,aw as UF,ax as VF,ay as jF,ar as NC,C as vg,j as zC,at as UC,az as HF,aq as GF,as as $F}from"./useCursorPointer--aUSJxL9.js";function WF(i,e){for(var t=0;t<e.length;t++){const r=e[t];if(typeof r!="string"&&!Array.isArray(r)){for(const a in r)if(a!=="default"&&!(a in i)){const h=Object.getOwnPropertyDescriptor(r,a);h&&Object.defineProperty(i,a,h.get?h:{enumerable:!0,get:()=>r[a]})}}}return Object.freeze(Object.defineProperty(i,Symbol.toStringTag,{value:"Module"}))}var qF=n0("user","User",[["path",{d:"M15 7.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0m4.5 13c-.475-9.333-14.525-9.333-15 0",key:"svg-0"}]]),XF=n0("ambulance","Ambulance",[["path",{d:"M6.9 10h4m-2-2v4m.307 4.455C9.207 17.86 8.095 19 6.724 19s-2.483-1.14-2.483-2.546m4.966 0c0-1.405-1.112-2.545-2.483-2.545s-2.483 1.14-2.483 2.545m4.966 0h5.586m-10.552 0H3V6a1 1 0 0 1 1-1h9.793a1 1 0 0 1 1 1v2.182m5.586 8.272c0 1.406-1.111 2.546-2.482 2.546s-2.483-1.14-2.483-2.546m4.965 0c0-1.405-1.111-2.545-2.482-2.545s-2.483 1.14-2.483 2.545m4.965 0H21v-5.09l-2.515-2.579a2 2 0 0 0-1.431-.603h-2.26m.62 8.272h-.62m0 0V8.182",key:"svg-0"}]]),ZF=n0("location-selected","LocationSelected",[["path",{d:"M12.435 16.86a.75.75 0 0 1-.87 0C7.809 14.183 3.822 8.677 7.852 4.698A5.9 5.9 0 0 1 12 3c1.556 0 3.048.61 4.148 1.697 4.03 3.979.043 9.485-3.713 12.164",key:"svg-0"}],["path",{d:"m6.5 17-2 4h15l-2-4M12 11a2 2 0 1 0 0-4 2 2 0 0 0 0 4",key:"svg-1"}]]),YF=n0("telephone","Telephone",[["path",{d:"M15.6 14.522c-2.395 2.52-8.504-3.534-6.1-6.064 1.468-1.545-.19-3.31-1.108-4.609-1.723-2.435-5.504.927-5.39 3.066.363 6.746 7.66 14.74 14.726 14.042 2.21-.218 4.75-4.21 2.215-5.669-1.268-.73-3.009-2.17-4.343-.767",key:"svg-0"}]]);function KF(i){return PF("MuiSvgIcon",i)}BF("MuiSvgIcon",["root","colorPrimary","colorSecondary","colorAction","colorError","colorDisabled","fontSizeInherit","fontSizeSmall","fontSizeMedium","fontSizeLarge"]);const JF=i=>{const{color:e,fontSize:t,classes:r}=i,a={root:["root",e!=="inherit"&&`color${ny(e)}`,`fontSize${ny(t)}`]};return kF(a,KF,r)},QF=OF("svg",{name:"MuiSvgIcon",slot:"Root",overridesResolver:(i,e)=>{const{ownerState:t}=i;return[e.root,t.color!=="inherit"&&e[`color${ny(t.color)}`],e[`fontSize${ny(t.fontSize)}`]]}})(LF(({theme:i})=>{var e,t,r,a,h,y,s,T,B,F,V,X,se,ne;return{userSelect:"none",width:"1em",height:"1em",display:"inline-block",flexShrink:0,transition:(a=(e=i.transitions)==null?void 0:e.create)==null?void 0:a.call(e,"fill",{duration:(r=(t=(i.vars??i).transitions)==null?void 0:t.duration)==null?void 0:r.shorter}),variants:[{props:K=>!K.hasSvgAsChild,style:{fill:"currentColor"}},{props:{fontSize:"inherit"},style:{fontSize:"inherit"}},{props:{fontSize:"small"},style:{fontSize:((y=(h=i.typography)==null?void 0:h.pxToRem)==null?void 0:y.call(h,20))||"1.25rem"}},{props:{fontSize:"medium"},style:{fontSize:((T=(s=i.typography)==null?void 0:s.pxToRem)==null?void 0:T.call(s,24))||"1.5rem"}},{props:{fontSize:"large"},style:{fontSize:((F=(B=i.typography)==null?void 0:B.pxToRem)==null?void 0:F.call(B,35))||"2.1875rem"}},...Object.entries((i.vars??i).palette).filter(([,K])=>K&&K.main).map(([K])=>{var ue,_e;return{props:{color:K},style:{color:(_e=(ue=(i.vars??i).palette)==null?void 0:ue[K])==null?void 0:_e.main}}}),{props:{color:"action"},style:{color:(X=(V=(i.vars??i).palette)==null?void 0:V.action)==null?void 0:X.active}},{props:{color:"disabled"},style:{color:(ne=(se=(i.vars??i).palette)==null?void 0:se.action)==null?void 0:ne.disabled}},{props:{color:"inherit"},style:{color:void 0}}]}})),u1=Ot.forwardRef(function(e,t){const r=DF({props:e,name:"MuiSvgIcon"}),{children:a,className:h,color:y="inherit",component:s="svg",fontSize:T="medium",htmlColor:B,inheritViewBox:F=!1,titleAccess:V,viewBox:X="0 0 24 24",...se}=r,ne=Ot.isValidElement(a)&&a.type==="svg",K={...r,color:y,component:s,fontSize:T,instanceFontSize:e.fontSize,inheritViewBox:F,viewBox:X,hasSvgAsChild:ne},ue={};F||(ue.viewBox=X);const _e=JF(K);return Dt.jsxs(QF,{as:s,className:FF(_e.root,h),focusable:"false",color:B,"aria-hidden":V?void 0:!0,role:V?"img":void 0,ref:t,...ue,...se,...ne&&a.props,ownerState:K,children:[ne?a.props.children:a,V?Dt.jsx("title",{children:V}):null]})});u1.muiName="SvgIcon";function ek(i,e){function t(r,a){return Dt.jsx(u1,{"data-testid":`${e}Icon`,ref:a,...r,children:i})}return t.muiName=u1.muiName,Ot.memo(Ot.forwardRef(t))}const Im=new s0,gw=new s0,tk=new s0,XE=new c1;function ik(i,e,t){const r=Im.setFromMatrixPosition(i.matrixWorld);r.project(e);const a=t.width/2,h=t.height/2;return[r.x*a+a,-(r.y*h)+h]}function rk(i,e){const t=Im.setFromMatrixPosition(i.matrixWorld),r=gw.setFromMatrixPosition(e.matrixWorld),a=t.sub(r),h=e.getWorldDirection(tk);return a.angleTo(h)>Math.PI/2}function nk(i,e,t,r){const a=Im.setFromMatrixPosition(i.matrixWorld),h=a.clone();h.project(e),XE.set(h.x,h.y),t.setFromCamera(XE,e);const y=t.intersectObjects(r,!0);if(y.length){const s=y[0].distance;return a.distanceTo(t.ray.origin)<s}return!0}function sk(i,e){if(e instanceof LC)return e.zoom;if(e instanceof kC){const t=Im.setFromMatrixPosition(i.matrixWorld),r=gw.setFromMatrixPosition(e.matrixWorld),a=e.fov*Math.PI/180,h=t.distanceTo(r);return 1/(2*Math.tan(a/2)*h)}else return 1}function ok(i,e,t){if(e instanceof kC||e instanceof LC){const r=Im.setFromMatrixPosition(i.matrixWorld),a=gw.setFromMatrixPosition(e.matrixWorld),h=r.distanceTo(a),y=(t[1]-t[0])/(e.far-e.near),s=t[1]-y*e.far;return Math.round(y*h+s)}}const h1=i=>Math.abs(i)<1e-10?0:i;function VC(i,e,t=""){let r="matrix3d(";for(let a=0;a!==16;a++)r+=h1(e[a]*i.elements[a])+(a!==15?",":")");return t+r}const ak=(i=>e=>VC(e,i))([1,-1,1,1,1,-1,1,1,1,-1,1,1,1,-1,1,1]),lk=(i=>(e,t)=>VC(e,i(t),"translate(-50%,-50%)"))(i=>[1/i,1/i,1/i,1,-1/i,-1/i,-1/i,-1,1/i,1/i,1/i,1,1,1,1,1]);function ck(i){return i&&typeof i=="object"&&"current"in i}const jC=Ot.forwardRef(({children:i,eps:e=.001,style:t,className:r,prepend:a,center:h,fullscreen:y,portal:s,distanceFactor:T,sprite:B=!1,transform:F=!1,occlude:V,onOcclude:X,castShadow:se,receiveShadow:ne,material:K,geometry:ue,zIndexRange:_e=[16777271,0],calculatePosition:ke=ik,as:we="div",wrapperClass:ge,pointerEvents:Le="auto",...$e},Ye)=>{const{gl:St,camera:Pt,scene:vt,size:yt,raycaster:hi,events:Pi,viewport:Si}=NF(),[qt]=Ot.useState(()=>document.createElement(we)),Br=Ot.useRef(),xr=Ot.useRef(null),os=Ot.useRef(0),pi=Ot.useRef([0,0]),mn=Ot.useRef(null),as=Ot.useRef(null),Kr=(s==null?void 0:s.current)||Pi.connected||St.domElement.parentNode,si=Ot.useRef(null),$s=Ot.useRef(!1),ls=Ot.useMemo(()=>V&&V!=="blending"||Array.isArray(V)&&V.length&&ck(V[0]),[V]);Ot.useLayoutEffect(()=>{const Re=St.domElement;V&&V==="blending"?(Re.style.zIndex=`${Math.floor(_e[0]/2)}`,Re.style.position="absolute",Re.style.pointerEvents="none"):(Re.style.zIndex=null,Re.style.position=null,Re.style.pointerEvents=null)},[V]),Ot.useLayoutEffect(()=>{if(xr.current){const Re=Br.current=CF.createRoot(qt);if(vt.updateMatrixWorld(),F)qt.style.cssText="position:absolute;top:0;left:0;pointer-events:none;overflow:hidden;";else{const sr=ke(xr.current,Pt,yt);qt.style.cssText=`position:absolute;top:0;left:0;transform:translate3d(${sr[0]}px,${sr[1]}px,0);transform-origin:0 0;`}return Kr&&(a?Kr.prepend(qt):Kr.appendChild(qt)),()=>{Kr&&Kr.removeChild(qt),Re.unmount()}}},[Kr,F]),Ot.useLayoutEffect(()=>{ge&&(qt.className=ge)},[ge]);const cs=Ot.useMemo(()=>F?{position:"absolute",top:0,left:0,width:yt.width,height:yt.height,transformStyle:"preserve-3d",pointerEvents:"none"}:{position:"absolute",transform:h?"translate3d(-50%,-50%,0)":"none",...y&&{top:-yt.height/2,left:-yt.width/2,width:yt.width,height:yt.height},...t},[t,h,y,yt,F]),fr=Ot.useMemo(()=>({position:"absolute",pointerEvents:Le}),[Le]);Ot.useLayoutEffect(()=>{if($s.current=!1,F){var Re;(Re=Br.current)==null||Re.render(Ot.createElement("div",{ref:mn,style:cs},Ot.createElement("div",{ref:as,style:fr},Ot.createElement("div",{ref:Ye,className:r,style:t,children:i}))))}else{var sr;(sr=Br.current)==null||sr.render(Ot.createElement("div",{ref:Ye,style:cs,className:r,children:i}))}});const br=Ot.useRef(!0);_w(Re=>{if(xr.current){Pt.updateMatrixWorld(),xr.current.updateWorldMatrix(!0,!1);const sr=F?pi.current:ke(xr.current,Pt,yt);if(F||Math.abs(os.current-Pt.zoom)>e||Math.abs(pi.current[0]-sr[0])>e||Math.abs(pi.current[1]-sr[1])>e){const Xn=rk(xr.current,Pt);let _n=!1;ls&&(Array.isArray(V)?_n=V.map(Zn=>Zn.current):V!=="blending"&&(_n=[vt]));const At=br.current;if(_n){const Zn=nk(xr.current,Pt,hi,_n);br.current=Zn&&!Xn}else br.current=!Xn;At!==br.current&&(X?X(!br.current):qt.style.display=br.current?"block":"none");const Wr=Math.floor(_e[0]/2),gn=V?ls?[_e[0],Wr]:[Wr-1,0]:_e;if(qt.style.zIndex=`${ok(xr.current,Pt,gn)}`,F){const[Zn,Ti]=[yt.width/2,yt.height/2],kr=Pt.projectionMatrix.elements[5]*Ti,{isOrthographicCamera:Ln,top:Ws,left:bo,bottom:wo,right:yi}=Pt,ws=ak(Pt.matrixWorldInverse),us=Ln?`scale(${kr})translate(${h1(-(yi+bo)/2)}px,${h1((Ws+wo)/2)}px)`:`translateZ(${kr}px)`;let Cn=xr.current.matrixWorld;B&&(Cn=Pt.matrixWorldInverse.clone().transpose().copyPosition(Cn).scale(xr.current.scale),Cn.elements[3]=Cn.elements[7]=Cn.elements[11]=0,Cn.elements[15]=1),qt.style.width=yt.width+"px",qt.style.height=yt.height+"px",qt.style.perspective=Ln?"":`${kr}px`,mn.current&&as.current&&(mn.current.style.transform=`${us}${ws}translate(${Zn}px,${Ti}px)`,as.current.style.transform=lk(Cn,1/((T||10)/400)))}else{const Zn=T===void 0?1:sk(xr.current,Pt)*T;qt.style.transform=`translate3d(${sr[0]}px,${sr[1]}px,0) scale(${Zn})`}pi.current=sr,os.current=Pt.zoom}}if(!ls&&si.current&&!$s.current)if(F){if(mn.current){const sr=mn.current.children[0];if(sr!=null&&sr.clientWidth&&sr!=null&&sr.clientHeight){const{isOrthographicCamera:Xn}=Pt;if(Xn||ue)$e.scale&&(Array.isArray($e.scale)?$e.scale instanceof s0?si.current.scale.copy($e.scale.clone().divideScalar(1)):si.current.scale.set(1/$e.scale[0],1/$e.scale[1],1/$e.scale[2]):si.current.scale.setScalar(1/$e.scale));else{const _n=(T||10)/400,At=sr.clientWidth*_n,Wr=sr.clientHeight*_n;si.current.scale.set(At,Wr,1)}$s.current=!0}}}else{const sr=qt.children[0];if(sr!=null&&sr.clientWidth&&sr!=null&&sr.clientHeight){const Xn=1/Si.factor,_n=sr.clientWidth*Xn,At=sr.clientHeight*Xn;si.current.scale.set(_n,At,1),$s.current=!0}si.current.lookAt(Re.camera.position)}});const kn=Ot.useMemo(()=>({vertexShader:F?void 0:`
          /*
            This shader is from the THREE's SpriteMaterial.
            We need to turn the backing plane into a Sprite
            (make it always face the camera) if "transfrom"
            is false.
          */
          #include <common>

          void main() {
            vec2 center = vec2(0., 1.);
            float rotation = 0.0;

            // This is somewhat arbitrary, but it seems to work well
            // Need to figure out how to derive this dynamically if it even matters
            float size = 0.03;

            vec4 mvPosition = modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );
            vec2 scale;
            scale.x = length( vec3( modelMatrix[ 0 ].x, modelMatrix[ 0 ].y, modelMatrix[ 0 ].z ) );
            scale.y = length( vec3( modelMatrix[ 1 ].x, modelMatrix[ 1 ].y, modelMatrix[ 1 ].z ) );

            bool isPerspective = isPerspectiveMatrix( projectionMatrix );
            if ( isPerspective ) scale *= - mvPosition.z;

            vec2 alignedPosition = ( position.xy - ( center - vec2( 0.5 ) ) ) * scale * size;
            vec2 rotatedPosition;
            rotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;
            rotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;
            mvPosition.xy += rotatedPosition;

            gl_Position = projectionMatrix * mvPosition;
          }
      `,fragmentShader:`
        void main() {
          gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
        }
      `}),[F]);return Ot.createElement("group",zF({},$e,{ref:xr}),V&&!ls&&Ot.createElement("mesh",{castShadow:se,receiveShadow:ne,ref:si},ue||Ot.createElement("planeGeometry",null),K||Ot.createElement("shaderMaterial",{side:l1,vertexShader:kn.vertexShader,fragmentShader:kn.fragmentShader})))});var yw=Mm(),Gi=i=>Cm(i,yw),vw=Mm();Gi.write=i=>Cm(i,vw);var o0=Mm();Gi.onStart=i=>Cm(i,o0);var xw=Mm();Gi.onFrame=i=>Cm(i,xw);var bw=Mm();Gi.onFinish=i=>Cm(i,bw);var fd=[];Gi.setTimeout=(i,e)=>{const t=Gi.now()+e,r=()=>{const h=fd.findIndex(y=>y.cancel==r);~h&&fd.splice(h,1),ic-=~h?1:0},a={time:t,handler:i,cancel:r};return fd.splice(HC(t),0,a),ic+=1,GC(),a};var HC=i=>~(~fd.findIndex(e=>e.time>i)||~fd.length);Gi.cancel=i=>{o0.delete(i),xw.delete(i),bw.delete(i),yw.delete(i),vw.delete(i)};Gi.sync=i=>{d1=!0,Gi.batchedUpdates(i),d1=!1};Gi.throttle=i=>{let e;function t(){try{i(...e)}finally{e=null}}function r(...a){e=a,Gi.onStart(t)}return r.handler=i,r.cancel=()=>{o0.delete(t),e=null},r};var ww=typeof window<"u"?window.requestAnimationFrame:()=>{};Gi.use=i=>ww=i;Gi.now=typeof performance<"u"?()=>performance.now():Date.now;Gi.batchedUpdates=i=>i();Gi.catch=console.error;Gi.frameLoop="always";Gi.advance=()=>{Gi.frameLoop!=="demand"?console.warn("Cannot call the manual advancement of rafz whilst frameLoop is not set as demand"):WC()};var tc=-1,ic=0,d1=!1;function Cm(i,e){d1?(e.delete(i),i(0)):(e.add(i),GC())}function GC(){tc<0&&(tc=0,Gi.frameLoop!=="demand"&&ww($C))}function uk(){tc=-1}function $C(){~tc&&(ww($C),Gi.batchedUpdates(WC))}function WC(){const i=tc;tc=Gi.now();const e=HC(tc);if(e&&(qC(fd.splice(0,e),t=>t.handler()),ic-=e),!ic){uk();return}o0.flush(),yw.flush(i?Math.min(64,tc-i):16.667),xw.flush(),vw.flush(),bw.flush()}function Mm(){let i=new Set,e=i;return{add(t){ic+=e==i&&!i.has(t)?1:0,i.add(t)},delete(t){return ic-=e==i&&i.has(t)?1:0,i.delete(t)},flush(t){e.size&&(i=new Set,ic-=e.size,qC(e,r=>r(t)&&i.add(r)),ic+=i.size,e=i)}}}function qC(i,e){i.forEach(t=>{try{e(t)}catch(r){Gi.catch(r)}})}var hk=Object.defineProperty,dk=(i,e)=>{for(var t in e)hk(i,t,{get:e[t],enumerable:!0})},Yo={};dk(Yo,{assign:()=>pk,colors:()=>sc,createStringInterpolator:()=>Tw,skipAnimation:()=>ZC,to:()=>XC,willAdvance:()=>Ew});function f1(){}var fk=(i,e,t)=>Object.defineProperty(i,e,{value:t,writable:!0,configurable:!0}),Qt={arr:Array.isArray,obj:i=>!!i&&i.constructor.name==="Object",fun:i=>typeof i=="function",str:i=>typeof i=="string",num:i=>typeof i=="number",und:i=>i===void 0};function Za(i,e){if(Qt.arr(i)){if(!Qt.arr(e)||i.length!==e.length)return!1;for(let t=0;t<i.length;t++)if(i[t]!==e[t])return!1;return!0}return i===e}var _r=(i,e)=>i.forEach(e);function el(i,e,t){if(Qt.arr(i)){for(let r=0;r<i.length;r++)e.call(t,i[r],`${r}`);return}for(const r in i)i.hasOwnProperty(r)&&e.call(t,i[r],r)}var mo=i=>Qt.und(i)?[]:Qt.arr(i)?i:[i];function qp(i,e){if(i.size){const t=Array.from(i);i.clear(),_r(t,e)}}var zp=(i,...e)=>qp(i,t=>t(...e)),Aw=()=>typeof window>"u"||!window.navigator||/ServerSideRendering|^Deno\//.test(window.navigator.userAgent),Tw,XC,sc=null,ZC=!1,Ew=f1,pk=i=>{i.to&&(XC=i.to),i.now&&(Gi.now=i.now),i.colors!==void 0&&(sc=i.colors),i.skipAnimation!=null&&(ZC=i.skipAnimation),i.createStringInterpolator&&(Tw=i.createStringInterpolator),i.requestAnimationFrame&&Gi.use(i.requestAnimationFrame),i.batchedUpdates&&(Gi.batchedUpdates=i.batchedUpdates),i.willAdvance&&(Ew=i.willAdvance),i.frameLoop&&(Gi.frameLoop=i.frameLoop)},Xp=new Set,po=[],Tx=[],sy=0,a0={get idle(){return!Xp.size&&!po.length},start(i){sy>i.priority?(Xp.add(i),Gi.onStart(mk)):(YC(i),Gi(p1))},advance:p1,sort(i){if(sy)Gi.onFrame(()=>a0.sort(i));else{const e=po.indexOf(i);~e&&(po.splice(e,1),KC(i))}},clear(){po=[],Xp.clear()}};function mk(){Xp.forEach(YC),Xp.clear(),Gi(p1)}function YC(i){po.includes(i)||KC(i)}function KC(i){po.splice(_k(po,e=>e.priority>i.priority),0,i)}function p1(i){const e=Tx;for(let t=0;t<po.length;t++){const r=po[t];sy=r.priority,r.idle||(Ew(r),r.advance(i),r.idle||e.push(r))}return sy=0,Tx=po,Tx.length=0,po=e,po.length>0}function _k(i,e){const t=i.findIndex(e);return t<0?i.length:t}var gk={transparent:0,aliceblue:4042850303,antiquewhite:4209760255,aqua:16777215,aquamarine:2147472639,azure:4043309055,beige:4126530815,bisque:4293182719,black:255,blanchedalmond:4293643775,blue:65535,blueviolet:2318131967,brown:2771004159,burlywood:3736635391,burntsienna:3934150143,cadetblue:1604231423,chartreuse:2147418367,chocolate:3530104575,coral:4286533887,cornflowerblue:1687547391,cornsilk:4294499583,crimson:3692313855,cyan:16777215,darkblue:35839,darkcyan:9145343,darkgoldenrod:3095792639,darkgray:2846468607,darkgreen:6553855,darkgrey:2846468607,darkkhaki:3182914559,darkmagenta:2332068863,darkolivegreen:1433087999,darkorange:4287365375,darkorchid:2570243327,darkred:2332033279,darksalmon:3918953215,darkseagreen:2411499519,darkslateblue:1211993087,darkslategray:793726975,darkslategrey:793726975,darkturquoise:13554175,darkviolet:2483082239,deeppink:4279538687,deepskyblue:12582911,dimgray:1768516095,dimgrey:1768516095,dodgerblue:512819199,firebrick:2988581631,floralwhite:4294635775,forestgreen:579543807,fuchsia:4278255615,gainsboro:3705462015,ghostwhite:4177068031,gold:4292280575,goldenrod:3668254975,gray:2155905279,green:8388863,greenyellow:2919182335,grey:2155905279,honeydew:4043305215,hotpink:4285117695,indianred:3445382399,indigo:1258324735,ivory:4294963455,khaki:4041641215,lavender:3873897215,lavenderblush:4293981695,lawngreen:2096890111,lemonchiffon:4294626815,lightblue:2916673279,lightcoral:4034953471,lightcyan:3774873599,lightgoldenrodyellow:4210742015,lightgray:3553874943,lightgreen:2431553791,lightgrey:3553874943,lightpink:4290167295,lightsalmon:4288707327,lightseagreen:548580095,lightskyblue:2278488831,lightslategray:2005441023,lightslategrey:2005441023,lightsteelblue:2965692159,lightyellow:4294959359,lime:16711935,limegreen:852308735,linen:4210091775,magenta:4278255615,maroon:2147483903,mediumaquamarine:1724754687,mediumblue:52735,mediumorchid:3126187007,mediumpurple:2473647103,mediumseagreen:1018393087,mediumslateblue:2070474495,mediumspringgreen:16423679,mediumturquoise:1221709055,mediumvioletred:3340076543,midnightblue:421097727,mintcream:4127193855,mistyrose:4293190143,moccasin:4293178879,navajowhite:4292783615,navy:33023,oldlace:4260751103,olive:2155872511,olivedrab:1804477439,orange:4289003775,orangered:4282712319,orchid:3664828159,palegoldenrod:4008225535,palegreen:2566625535,paleturquoise:2951671551,palevioletred:3681588223,papayawhip:4293907967,peachpuff:4292524543,peru:3448061951,pink:4290825215,plum:3718307327,powderblue:2967529215,purple:2147516671,rebeccapurple:1714657791,red:4278190335,rosybrown:3163525119,royalblue:1097458175,saddlebrown:2336560127,salmon:4202722047,sandybrown:4104413439,seagreen:780883967,seashell:4294307583,sienna:2689740287,silver:3233857791,skyblue:2278484991,slateblue:1784335871,slategray:1887473919,slategrey:1887473919,snow:4294638335,springgreen:16744447,steelblue:1182971135,tan:3535047935,teal:8421631,thistle:3636451583,tomato:4284696575,turquoise:1088475391,violet:4001558271,wheat:4125012991,white:4294967295,whitesmoke:4126537215,yellow:4294902015,yellowgreen:2597139199},qo="[-+]?\\d*\\.?\\d+",oy=qo+"%";function l0(...i){return"\\(\\s*("+i.join(")\\s*,\\s*(")+")\\s*\\)"}var yk=new RegExp("rgb"+l0(qo,qo,qo)),vk=new RegExp("rgba"+l0(qo,qo,qo,qo)),xk=new RegExp("hsl"+l0(qo,oy,oy)),bk=new RegExp("hsla"+l0(qo,oy,oy,qo)),wk=/^#([0-9a-fA-F]{1})([0-9a-fA-F]{1})([0-9a-fA-F]{1})$/,Ak=/^#([0-9a-fA-F]{1})([0-9a-fA-F]{1})([0-9a-fA-F]{1})([0-9a-fA-F]{1})$/,Tk=/^#([0-9a-fA-F]{6})$/,Ek=/^#([0-9a-fA-F]{8})$/;function Sk(i){let e;return typeof i=="number"?i>>>0===i&&i>=0&&i<=4294967295?i:null:(e=Tk.exec(i))?parseInt(e[1]+"ff",16)>>>0:sc&&sc[i]!==void 0?sc[i]:(e=yk.exec(i))?(Zh(e[1])<<24|Zh(e[2])<<16|Zh(e[3])<<8|255)>>>0:(e=vk.exec(i))?(Zh(e[1])<<24|Zh(e[2])<<16|Zh(e[3])<<8|KE(e[4]))>>>0:(e=wk.exec(i))?parseInt(e[1]+e[1]+e[2]+e[2]+e[3]+e[3]+"ff",16)>>>0:(e=Ek.exec(i))?parseInt(e[1],16)>>>0:(e=Ak.exec(i))?parseInt(e[1]+e[1]+e[2]+e[2]+e[3]+e[3]+e[4]+e[4],16)>>>0:(e=xk.exec(i))?(ZE(YE(e[1]),xg(e[2]),xg(e[3]))|255)>>>0:(e=bk.exec(i))?(ZE(YE(e[1]),xg(e[2]),xg(e[3]))|KE(e[4]))>>>0:null}function Ex(i,e,t){return t<0&&(t+=1),t>1&&(t-=1),t<1/6?i+(e-i)*6*t:t<1/2?e:t<2/3?i+(e-i)*(2/3-t)*6:i}function ZE(i,e,t){const r=t<.5?t*(1+e):t+e-t*e,a=2*t-r,h=Ex(a,r,i+1/3),y=Ex(a,r,i),s=Ex(a,r,i-1/3);return Math.round(h*255)<<24|Math.round(y*255)<<16|Math.round(s*255)<<8}function Zh(i){const e=parseInt(i,10);return e<0?0:e>255?255:e}function YE(i){return(parseFloat(i)%360+360)%360/360}function KE(i){const e=parseFloat(i);return e<0?0:e>1?255:Math.round(e*255)}function xg(i){const e=parseFloat(i);return e<0?0:e>100?1:e/100}function JE(i){let e=Sk(i);if(e===null)return i;e=e||0;const t=(e&4278190080)>>>24,r=(e&16711680)>>>16,a=(e&65280)>>>8,h=(e&255)/255;return`rgba(${t}, ${r}, ${a}, ${h})`}var lm=(i,e,t)=>{if(Qt.fun(i))return i;if(Qt.arr(i))return lm({range:i,output:e,extrapolate:t});if(Qt.str(i.output[0]))return Tw(i);const r=i,a=r.output,h=r.range||[0,1],y=r.extrapolateLeft||r.extrapolate||"extend",s=r.extrapolateRight||r.extrapolate||"extend",T=r.easing||(B=>B);return B=>{const F=Ck(B,h);return Ik(B,h[F],h[F+1],a[F],a[F+1],T,y,s,r.map)}};function Ik(i,e,t,r,a,h,y,s,T){let B=T?T(i):i;if(B<e){if(y==="identity")return B;y==="clamp"&&(B=e)}if(B>t){if(s==="identity")return B;s==="clamp"&&(B=t)}return r===a?r:e===t?i<=e?r:a:(e===-1/0?B=-B:t===1/0?B=B-e:B=(B-e)/(t-e),B=h(B),r===-1/0?B=-B:a===1/0?B=B+r:B=B*(a-r)+r,B)}function Ck(i,e){for(var t=1;t<e.length-1&&!(e[t]>=i);++t);return t-1}var Mk={linear:i=>i},cm=Symbol.for("FluidValue.get"),vd=Symbol.for("FluidValue.observers"),ya=i=>!!(i&&i[cm]),fo=i=>i&&i[cm]?i[cm]():i,QE=i=>i[vd]||null;function Rk(i,e){i.eventObserved?i.eventObserved(e):i(e)}function ay(i,e){const t=i[vd];t&&t.forEach(r=>{Rk(r,e)})}var Pk=class{constructor(i){if(!i&&!(i=this.get))throw Error("Unknown getter");Bk(this,i)}},Bk=(i,e)=>JC(i,cm,e);function Rm(i,e){if(i[cm]){let t=i[vd];t||JC(i,vd,t=new Set),t.has(e)||(t.add(e),i.observerAdded&&i.observerAdded(t.size,e))}return e}function ly(i,e){const t=i[vd];if(t&&t.has(e)){const r=t.size-1;r?t.delete(e):i[vd]=null,i.observerRemoved&&i.observerRemoved(r,e)}}var JC=(i,e,t)=>Object.defineProperty(i,e,{value:t,writable:!0,configurable:!0}),Gg=/[+\-]?(?:0|[1-9]\d*)(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,Dk=/(#(?:[0-9a-f]{2}){2,4}|(#[0-9a-f]{3})|(rgb|hsl)a?\((-?\d+%?[,\s]+){2,3}\s*[\d\.]+%?\))/gi,eS=new RegExp(`(${Gg.source})(%|[a-z]+)`,"i"),Ok=/rgba\(([0-9\.-]+), ([0-9\.-]+), ([0-9\.-]+), ([0-9\.-]+)\)/gi,c0=/var\((--[a-zA-Z0-9-_]+),? ?([a-zA-Z0-9 ()%#.,-]+)?\)/,QC=i=>{const[e,t]=Fk(i);if(!e||Aw())return i;const r=window.getComputedStyle(document.documentElement).getPropertyValue(e);if(r)return r.trim();if(t&&t.startsWith("--")){const a=window.getComputedStyle(document.documentElement).getPropertyValue(t);return a||i}else{if(t&&c0.test(t))return QC(t);if(t)return t}return i},Fk=i=>{const e=c0.exec(i);if(!e)return[,];const[,t,r]=e;return[t,r]},Sx,kk=(i,e,t,r,a)=>`rgba(${Math.round(e)}, ${Math.round(t)}, ${Math.round(r)}, ${a})`,eM=i=>{Sx||(Sx=sc?new RegExp(`(${Object.keys(sc).join("|")})(?!\\w)`,"g"):/^\b$/);const e=i.output.map(h=>fo(h).replace(c0,QC).replace(Dk,JE).replace(Sx,JE)),t=e.map(h=>h.match(Gg).map(Number)),a=t[0].map((h,y)=>t.map(s=>{if(!(y in s))throw Error('The arity of each "output" value must be equal');return s[y]})).map(h=>lm({...i,output:h}));return h=>{var T;const y=!eS.test(e[0])&&((T=e.find(B=>eS.test(B)))==null?void 0:T.replace(Gg,""));let s=0;return e[0].replace(Gg,()=>`${a[s++](h)}${y||""}`).replace(Ok,kk)}},Sw="react-spring: ",tM=i=>{const e=i;let t=!1;if(typeof e!="function")throw new TypeError(`${Sw}once requires a function parameter`);return(...r)=>{t||(e(...r),t=!0)}},Lk=tM(console.warn);function Nk(){Lk(`${Sw}The "interpolate" function is deprecated in v9 (use "to" instead)`)}var zk=tM(console.warn);function Uk(){zk(`${Sw}Directly calling start instead of using the api object is deprecated in v9 (use ".start" instead), this will be removed in later 0.X.0 versions`)}function u0(i){return Qt.str(i)&&(i[0]=="#"||/\d/.test(i)||!Aw()&&c0.test(i)||i in(sc||{}))}var Iw=Aw()?Ot.useEffect:Ot.useLayoutEffect,Vk=()=>{const i=Ot.useRef(!1);return Iw(()=>(i.current=!0,()=>{i.current=!1}),[]),i};function iM(){const i=Ot.useState()[1],e=Vk();return()=>{e.current&&i(Math.random())}}function jk(i,e){const[t]=Ot.useState(()=>({inputs:e,result:i()})),r=Ot.useRef(),a=r.current;let h=a;return h?e&&h.inputs&&Hk(e,h.inputs)||(h={inputs:e,result:i()}):h=t,Ot.useEffect(()=>{r.current=h,a==t&&(t.inputs=t.result=void 0)},[h]),h.result}function Hk(i,e){if(i.length!==e.length)return!1;for(let t=0;t<i.length;t++)if(i[t]!==e[t])return!1;return!0}var rM=i=>Ot.useEffect(i,Gk),Gk=[];function tS(i){const e=Ot.useRef();return Ot.useEffect(()=>{e.current=i}),e.current}var um=Symbol.for("Animated:node"),$k=i=>!!i&&i[um]===i,_a=i=>i&&i[um],Cw=(i,e)=>fk(i,um,e),h0=i=>i&&i[um]&&i[um].getPayload(),nM=class{constructor(){Cw(this,this)}getPayload(){return this.payload||[]}},Pm=class extends nM{constructor(i){super(),this._value=i,this.done=!0,this.durationProgress=0,Qt.num(this._value)&&(this.lastPosition=this._value)}static create(i){return new Pm(i)}getPayload(){return[this]}getValue(){return this._value}setValue(i,e){return Qt.num(i)&&(this.lastPosition=i,e&&(i=Math.round(i/e)*e,this.done&&(this.lastPosition=i))),this._value===i?!1:(this._value=i,!0)}reset(){const{done:i}=this;this.done=!1,Qt.num(this._value)&&(this.elapsedTime=0,this.durationProgress=0,this.lastPosition=this._value,i&&(this.lastVelocity=null),this.v0=null)}},hm=class extends Pm{constructor(i){super(0),this._string=null,this._toString=lm({output:[i,i]})}static create(i){return new hm(i)}getValue(){const i=this._string;return i??(this._string=this._toString(this._value))}setValue(i){if(Qt.str(i)){if(i==this._string)return!1;this._string=i,this._value=1}else if(super.setValue(i))this._string=null;else return!1;return!0}reset(i){i&&(this._toString=lm({output:[this.getValue(),i]})),this._value=0,super.reset()}},cy={dependencies:null},Mw=class extends nM{constructor(i){super(),this.source=i,this.setValue(i)}getValue(i){const e={};return el(this.source,(t,r)=>{$k(t)?e[r]=t.getValue(i):ya(t)?e[r]=fo(t):i||(e[r]=t)}),e}setValue(i){this.source=i,this.payload=this._makePayload(i)}reset(){this.payload&&_r(this.payload,i=>i.reset())}_makePayload(i){if(i){const e=new Set;return el(i,this._addToPayload,e),Array.from(e)}}_addToPayload(i){cy.dependencies&&ya(i)&&cy.dependencies.add(i);const e=h0(i);e&&_r(e,t=>this.add(t))}},sM=class extends Mw{constructor(i){super(i)}static create(i){return new sM(i)}getValue(){return this.source.map(i=>i.getValue())}setValue(i){const e=this.getPayload();return i.length==e.length?e.map((t,r)=>t.setValue(i[r])).some(Boolean):(super.setValue(i.map(Wk)),!0)}};function Wk(i){return(u0(i)?hm:Pm).create(i)}function m1(i){const e=_a(i);return e?e.constructor:Qt.arr(i)?sM:u0(i)?hm:Pm}var iS=(i,e)=>{const t=!Qt.fun(i)||i.prototype&&i.prototype.isReactComponent;return Ot.forwardRef((r,a)=>{const h=Ot.useRef(null),y=t&&Ot.useCallback(ne=>{h.current=Zk(a,ne)},[a]),[s,T]=Xk(r,e),B=iM(),F=()=>{const ne=h.current;if(t&&!ne)return;(ne?e.applyAnimatedValues(ne,s.getValue(!0)):!1)===!1&&B()},V=new qk(F,T),X=Ot.useRef();Iw(()=>(X.current=V,_r(T,ne=>Rm(ne,V)),()=>{X.current&&(_r(X.current.deps,ne=>ly(ne,X.current)),Gi.cancel(X.current.update))})),Ot.useEffect(F,[]),rM(()=>()=>{const ne=X.current;_r(ne.deps,K=>ly(K,ne))});const se=e.getComponentProps(s.getValue());return Ot.createElement(i,{...se,ref:y})})},qk=class{constructor(i,e){this.update=i,this.deps=e}eventObserved(i){i.type=="change"&&Gi.write(this.update)}};function Xk(i,e){const t=new Set;return cy.dependencies=t,i.style&&(i={...i,style:e.createAnimatedStyle(i.style)}),i=new Mw(i),cy.dependencies=null,[i,t]}function Zk(i,e){return i&&(Qt.fun(i)?i(e):i.current=e),e}var rS=Symbol.for("AnimatedComponent"),Yk=(i,{applyAnimatedValues:e=()=>!1,createAnimatedStyle:t=a=>new Mw(a),getComponentProps:r=a=>a}={})=>{const a={applyAnimatedValues:e,createAnimatedStyle:t,getComponentProps:r},h=y=>{const s=nS(y)||"Anonymous";return Qt.str(y)?y=h[y]||(h[y]=iS(y,a)):y=y[rS]||(y[rS]=iS(y,a)),y.displayName=`Animated(${s})`,y};return el(i,(y,s)=>{Qt.arr(i)&&(s=nS(y)),h[s]=h(y)}),{animated:h}},nS=i=>Qt.str(i)?i:i&&Qt.str(i.displayName)?i.displayName:Qt.fun(i)&&i.name||null;function _u(i,...e){return Qt.fun(i)?i(...e):i}var Zp=(i,e)=>i===!0||!!(e&&i&&(Qt.fun(i)?i(e):mo(i).includes(e))),oM=(i,e)=>Qt.obj(i)?e&&i[e]:i,aM=(i,e)=>i.default===!0?i[e]:i.default?i.default[e]:void 0,Kk=i=>i,Rw=(i,e=Kk)=>{let t=Jk;i.default&&i.default!==!0&&(i=i.default,t=Object.keys(i));const r={};for(const a of t){const h=e(i[a],a);Qt.und(h)||(r[a]=h)}return r},Jk=["config","onProps","onStart","onChange","onPause","onResume","onRest"],Qk={config:1,from:1,to:1,ref:1,loop:1,reset:1,pause:1,cancel:1,reverse:1,immediate:1,default:1,delay:1,onProps:1,onStart:1,onChange:1,onPause:1,onResume:1,onRest:1,onResolve:1,items:1,trail:1,sort:1,expires:1,initial:1,enter:1,update:1,leave:1,children:1,onDestroyed:1,keys:1,callId:1,parentId:1};function eL(i){const e={};let t=0;if(el(i,(r,a)=>{Qk[a]||(e[a]=r,t++)}),t)return e}function lM(i){const e=eL(i);if(e){const t={to:e};return el(i,(r,a)=>a in e||(t[a]=r)),t}return{...i}}function dm(i){return i=fo(i),Qt.arr(i)?i.map(dm):u0(i)?Yo.createStringInterpolator({range:[0,1],output:[i,i]})(1):i}function tL(i){for(const e in i)return!0;return!1}function _1(i){return Qt.fun(i)||Qt.arr(i)&&Qt.obj(i[0])}function iL(i,e){var t;(t=i.ref)==null||t.delete(i),e==null||e.delete(i)}function rL(i,e){var t;e&&i.ref!==e&&((t=i.ref)==null||t.delete(i),e.add(i),i.ref=e)}var nL={default:{tension:170,friction:26}},g1={...nL.default,mass:1,damping:1,easing:Mk.linear,clamp:!1},sL=class{constructor(){this.velocity=0,Object.assign(this,g1)}};function oL(i,e,t){t&&(t={...t},sS(t,e),e={...t,...e}),sS(i,e),Object.assign(i,e);for(const y in g1)i[y]==null&&(i[y]=g1[y]);let{frequency:r,damping:a}=i;const{mass:h}=i;return Qt.und(r)||(r<.01&&(r=.01),a<0&&(a=0),i.tension=Math.pow(2*Math.PI/r,2)*h,i.friction=4*Math.PI*a*h/r),i}function sS(i,e){if(!Qt.und(e.decay))i.duration=void 0;else{const t=!Qt.und(e.tension)||!Qt.und(e.friction);(t||!Qt.und(e.frequency)||!Qt.und(e.damping)||!Qt.und(e.mass))&&(i.duration=void 0,i.decay=void 0),t&&(i.frequency=void 0)}}var oS=[],aL=class{constructor(){this.changed=!1,this.values=oS,this.toValues=null,this.fromValues=oS,this.config=new sL,this.immediate=!1}};function cM(i,{key:e,props:t,defaultProps:r,state:a,actions:h}){return new Promise((y,s)=>{let T,B,F=Zp(t.cancel??(r==null?void 0:r.cancel),e);if(F)se();else{Qt.und(t.pause)||(a.paused=Zp(t.pause,e));let ne=r==null?void 0:r.pause;ne!==!0&&(ne=a.paused||Zp(ne,e)),T=_u(t.delay||0,e),ne?(a.resumeQueue.add(X),h.pause()):(h.resume(),X())}function V(){a.resumeQueue.add(X),a.timeouts.delete(B),B.cancel(),T=B.time-Gi.now()}function X(){T>0&&!Yo.skipAnimation?(a.delayed=!0,B=Gi.setTimeout(se,T),a.pauseQueue.add(V),a.timeouts.add(B)):se()}function se(){a.delayed&&(a.delayed=!1),a.pauseQueue.delete(V),a.timeouts.delete(B),i<=(a.cancelId||0)&&(F=!0);try{h.start({...t,callId:i,cancel:F},y)}catch(ne){s(ne)}}})}var Pw=(i,e)=>e.length==1?e[0]:e.some(t=>t.cancelled)?pd(i.get()):e.every(t=>t.noop)?uM(i.get()):$o(i.get(),e.every(t=>t.finished)),uM=i=>({value:i,noop:!0,finished:!0,cancelled:!1}),$o=(i,e,t=!1)=>({value:i,finished:e,cancelled:t}),pd=i=>({value:i,cancelled:!0,finished:!1});function hM(i,e,t,r){const{callId:a,parentId:h,onRest:y}=e,{asyncTo:s,promise:T}=t;return!h&&i===s&&!e.reset?T:t.promise=(async()=>{t.asyncId=a,t.asyncTo=i;const B=Rw(e,(ue,_e)=>_e==="onRest"?void 0:ue);let F,V;const X=new Promise((ue,_e)=>(F=ue,V=_e)),se=ue=>{const _e=a<=(t.cancelId||0)&&pd(r)||a!==t.asyncId&&$o(r,!1);if(_e)throw ue.result=_e,V(ue),ue},ne=(ue,_e)=>{const ke=new aS,we=new lS;return(async()=>{if(Yo.skipAnimation)throw fm(t),we.result=$o(r,!1),V(we),we;se(ke);const ge=Qt.obj(ue)?{...ue}:{..._e,to:ue};ge.parentId=a,el(B,($e,Ye)=>{Qt.und(ge[Ye])&&(ge[Ye]=$e)});const Le=await r.start(ge);return se(ke),t.paused&&await new Promise($e=>{t.resumeQueue.add($e)}),Le})()};let K;if(Yo.skipAnimation)return fm(t),$o(r,!1);try{let ue;Qt.arr(i)?ue=(async _e=>{for(const ke of _e)await ne(ke)})(i):ue=Promise.resolve(i(ne,r.stop.bind(r))),await Promise.all([ue.then(F),X]),K=$o(r.get(),!0,!1)}catch(ue){if(ue instanceof aS)K=ue.result;else if(ue instanceof lS)K=ue.result;else throw ue}finally{a==t.asyncId&&(t.asyncId=h,t.asyncTo=h?s:void 0,t.promise=h?T:void 0)}return Qt.fun(y)&&Gi.batchedUpdates(()=>{y(K,r,r.item)}),K})()}function fm(i,e){qp(i.timeouts,t=>t.cancel()),i.pauseQueue.clear(),i.resumeQueue.clear(),i.asyncId=i.asyncTo=i.promise=void 0,e&&(i.cancelId=e)}var aS=class extends Error{constructor(){super("An async animation has been interrupted. You see this error because you forgot to use `await` or `.catch(...)` on its returned promise.")}},lS=class extends Error{constructor(){super("SkipAnimationSignal")}},y1=i=>i instanceof Bw,lL=1,Bw=class extends Pk{constructor(){super(...arguments),this.id=lL++,this._priority=0}get priority(){return this._priority}set priority(i){this._priority!=i&&(this._priority=i,this._onPriorityChange(i))}get(){const i=_a(this);return i&&i.getValue()}to(...i){return Yo.to(this,i)}interpolate(...i){return Nk(),Yo.to(this,i)}toJSON(){return this.get()}observerAdded(i){i==1&&this._attach()}observerRemoved(i){i==0&&this._detach()}_attach(){}_detach(){}_onChange(i,e=!1){ay(this,{type:"change",parent:this,value:i,idle:e})}_onPriorityChange(i){this.idle||a0.sort(this),ay(this,{type:"priority",parent:this,priority:i})}},Su=Symbol.for("SpringPhase"),dM=1,fM=2,pM=4,Ix=i=>(i[Su]&dM)>0,Wl=i=>(i[Su]&fM)>0,Bp=i=>(i[Su]&pM)>0,cS=(i,e)=>e?i[Su]|=fM|dM:i[Su]&=-3,uS=(i,e)=>e?i[Su]|=pM:i[Su]&=-5,cL=class extends Bw{constructor(i,e){if(super(),this.animation=new aL,this.defaultProps={},this._state={paused:!1,delayed:!1,pauseQueue:new Set,resumeQueue:new Set,timeouts:new Set},this._pendingCalls=new Set,this._lastCallId=0,this._lastToId=0,this._memoizedDuration=0,!Qt.und(i)||!Qt.und(e)){const t=Qt.obj(i)?{...i}:{...e,from:i};Qt.und(t.default)&&(t.default=!0),this.start(t)}}get idle(){return!(Wl(this)||this._state.asyncTo)||Bp(this)}get goal(){return fo(this.animation.to)}get velocity(){const i=_a(this);return i instanceof Pm?i.lastVelocity||0:i.getPayload().map(e=>e.lastVelocity||0)}get hasAnimated(){return Ix(this)}get isAnimating(){return Wl(this)}get isPaused(){return Bp(this)}get isDelayed(){return this._state.delayed}advance(i){let e=!0,t=!1;const r=this.animation;let{toValues:a}=r;const{config:h}=r,y=h0(r.to);!y&&ya(r.to)&&(a=mo(fo(r.to))),r.values.forEach((B,F)=>{if(B.done)return;const V=B.constructor==hm?1:y?y[F].lastPosition:a[F];let X=r.immediate,se=V;if(!X){if(se=B.lastPosition,h.tension<=0){B.done=!0;return}let ne=B.elapsedTime+=i;const K=r.fromValues[F],ue=B.v0!=null?B.v0:B.v0=Qt.arr(h.velocity)?h.velocity[F]:h.velocity;let _e;const ke=h.precision||(K==V?.005:Math.min(1,Math.abs(V-K)*.001));if(Qt.und(h.duration))if(h.decay){const we=h.decay===!0?.998:h.decay,ge=Math.exp(-(1-we)*ne);se=K+ue/(1-we)*(1-ge),X=Math.abs(B.lastPosition-se)<=ke,_e=ue*ge}else{_e=B.lastVelocity==null?ue:B.lastVelocity;const we=h.restVelocity||ke/10,ge=h.clamp?0:h.bounce,Le=!Qt.und(ge),$e=K==V?B.v0>0:K<V;let Ye,St=!1;const Pt=1,vt=Math.ceil(i/Pt);for(let yt=0;yt<vt&&(Ye=Math.abs(_e)>we,!(!Ye&&(X=Math.abs(V-se)<=ke,X)));++yt){Le&&(St=se==V||se>V==$e,St&&(_e=-_e*ge,se=V));const hi=-h.tension*1e-6*(se-V),Pi=-h.friction*.001*_e,Si=(hi+Pi)/h.mass;_e=_e+Si*Pt,se=se+_e*Pt}}else{let we=1;h.duration>0&&(this._memoizedDuration!==h.duration&&(this._memoizedDuration=h.duration,B.durationProgress>0&&(B.elapsedTime=h.duration*B.durationProgress,ne=B.elapsedTime+=i)),we=(h.progress||0)+ne/this._memoizedDuration,we=we>1?1:we<0?0:we,B.durationProgress=we),se=K+h.easing(we)*(V-K),_e=(se-B.lastPosition)/i,X=we==1}B.lastVelocity=_e,Number.isNaN(se)&&(console.warn("Got NaN while animating:",this),X=!0)}y&&!y[F].done&&(X=!1),X?B.done=!0:e=!1,B.setValue(se,h.round)&&(t=!0)});const s=_a(this),T=s.getValue();if(e){const B=fo(r.to);(T!==B||t)&&!h.decay?(s.setValue(B),this._onChange(B)):t&&h.decay&&this._onChange(T),this._stop()}else t&&this._onChange(T)}set(i){return Gi.batchedUpdates(()=>{this._stop(),this._focus(i),this._set(i)}),this}pause(){this._update({pause:!0})}resume(){this._update({pause:!1})}finish(){if(Wl(this)){const{to:i,config:e}=this.animation;Gi.batchedUpdates(()=>{this._onStart(),e.decay||this._set(i,!1),this._stop()})}return this}update(i){return(this.queue||(this.queue=[])).push(i),this}start(i,e){let t;return Qt.und(i)?(t=this.queue||[],this.queue=[]):t=[Qt.obj(i)?i:{...e,to:i}],Promise.all(t.map(r=>this._update(r))).then(r=>Pw(this,r))}stop(i){const{to:e}=this.animation;return this._focus(this.get()),fm(this._state,i&&this._lastCallId),Gi.batchedUpdates(()=>this._stop(e,i)),this}reset(){this._update({reset:!0})}eventObserved(i){i.type=="change"?this._start():i.type=="priority"&&(this.priority=i.priority+1)}_prepareNode(i){const e=this.key||"";let{to:t,from:r}=i;t=Qt.obj(t)?t[e]:t,(t==null||_1(t))&&(t=void 0),r=Qt.obj(r)?r[e]:r,r==null&&(r=void 0);const a={to:t,from:r};return Ix(this)||(i.reverse&&([t,r]=[r,t]),r=fo(r),Qt.und(r)?_a(this)||this._set(t):this._set(r)),a}_update({...i},e){const{key:t,defaultProps:r}=this;i.default&&Object.assign(r,Rw(i,(y,s)=>/^on/.test(s)?oM(y,t):y)),dS(this,i,"onProps"),Op(this,"onProps",i,this);const a=this._prepareNode(i);if(Object.isFrozen(this))throw Error("Cannot animate a `SpringValue` object that is frozen. Did you forget to pass your component to `animated(...)` before animating its props?");const h=this._state;return cM(++this._lastCallId,{key:t,props:i,defaultProps:r,state:h,actions:{pause:()=>{Bp(this)||(uS(this,!0),zp(h.pauseQueue),Op(this,"onPause",$o(this,Dp(this,this.animation.to)),this))},resume:()=>{Bp(this)&&(uS(this,!1),Wl(this)&&this._resume(),zp(h.resumeQueue),Op(this,"onResume",$o(this,Dp(this,this.animation.to)),this))},start:this._merge.bind(this,a)}}).then(y=>{if(i.loop&&y.finished&&!(e&&y.noop)){const s=mM(i);if(s)return this._update(s,!0)}return y})}_merge(i,e,t){if(e.cancel)return this.stop(!0),t(pd(this));const r=!Qt.und(i.to),a=!Qt.und(i.from);if(r||a)if(e.callId>this._lastToId)this._lastToId=e.callId;else return t(pd(this));const{key:h,defaultProps:y,animation:s}=this,{to:T,from:B}=s;let{to:F=T,from:V=B}=i;a&&!r&&(!e.default||Qt.und(F))&&(F=V),e.reverse&&([F,V]=[V,F]);const X=!Za(V,B);X&&(s.from=V),V=fo(V);const se=!Za(F,T);se&&this._focus(F);const ne=_1(e.to),{config:K}=s,{decay:ue,velocity:_e}=K;(r||a)&&(K.velocity=0),e.config&&!ne&&oL(K,_u(e.config,h),e.config!==y.config?_u(y.config,h):void 0);let ke=_a(this);if(!ke||Qt.und(F))return t($o(this,!0));const we=Qt.und(e.reset)?a&&!e.default:!Qt.und(V)&&Zp(e.reset,h),ge=we?V:this.get(),Le=dm(F),$e=Qt.num(Le)||Qt.arr(Le)||u0(Le),Ye=!ne&&(!$e||Zp(y.immediate||e.immediate,h));if(se){const yt=m1(F);if(yt!==ke.constructor)if(Ye)ke=this._set(Le);else throw Error(`Cannot animate between ${ke.constructor.name} and ${yt.name}, as the "to" prop suggests`)}const St=ke.constructor;let Pt=ya(F),vt=!1;if(!Pt){const yt=we||!Ix(this)&&X;(se||yt)&&(vt=Za(dm(ge),Le),Pt=!vt),(!Za(s.immediate,Ye)&&!Ye||!Za(K.decay,ue)||!Za(K.velocity,_e))&&(Pt=!0)}if(vt&&Wl(this)&&(s.changed&&!we?Pt=!0:Pt||this._stop(T)),!ne&&((Pt||ya(T))&&(s.values=ke.getPayload(),s.toValues=ya(F)?null:St==hm?[1]:mo(Le)),s.immediate!=Ye&&(s.immediate=Ye,!Ye&&!we&&this._set(T)),Pt)){const{onRest:yt}=s;_r(hL,Pi=>dS(this,e,Pi));const hi=$o(this,Dp(this,T));zp(this._pendingCalls,hi),this._pendingCalls.add(t),s.changed&&Gi.batchedUpdates(()=>{var Pi;s.changed=!we,yt==null||yt(hi,this),we?_u(y.onRest,hi):(Pi=s.onStart)==null||Pi.call(s,hi,this)})}we&&this._set(ge),ne?t(hM(e.to,e,this._state,this)):Pt?this._start():Wl(this)&&!se?this._pendingCalls.add(t):t(uM(ge))}_focus(i){const e=this.animation;i!==e.to&&(QE(this)&&this._detach(),e.to=i,QE(this)&&this._attach())}_attach(){let i=0;const{to:e}=this.animation;ya(e)&&(Rm(e,this),y1(e)&&(i=e.priority+1)),this.priority=i}_detach(){const{to:i}=this.animation;ya(i)&&ly(i,this)}_set(i,e=!0){const t=fo(i);if(!Qt.und(t)){const r=_a(this);if(!r||!Za(t,r.getValue())){const a=m1(t);!r||r.constructor!=a?Cw(this,a.create(t)):r.setValue(t),r&&Gi.batchedUpdates(()=>{this._onChange(t,e)})}}return _a(this)}_onStart(){const i=this.animation;i.changed||(i.changed=!0,Op(this,"onStart",$o(this,Dp(this,i.to)),this))}_onChange(i,e){e||(this._onStart(),_u(this.animation.onChange,i,this)),_u(this.defaultProps.onChange,i,this),super._onChange(i,e)}_start(){const i=this.animation;_a(this).reset(fo(i.to)),i.immediate||(i.fromValues=i.values.map(e=>e.lastPosition)),Wl(this)||(cS(this,!0),Bp(this)||this._resume())}_resume(){Yo.skipAnimation?this.finish():a0.start(this)}_stop(i,e){if(Wl(this)){cS(this,!1);const t=this.animation;_r(t.values,a=>{a.done=!0}),t.toValues&&(t.onChange=t.onPause=t.onResume=void 0),ay(this,{type:"idle",parent:this});const r=e?pd(this.get()):$o(this.get(),Dp(this,i??t.to));zp(this._pendingCalls,r),t.changed&&(t.changed=!1,Op(this,"onRest",r,this))}}};function Dp(i,e){const t=dm(e),r=dm(i.get());return Za(r,t)}function mM(i,e=i.loop,t=i.to){const r=_u(e);if(r){const a=r!==!0&&lM(r),h=(a||i).reverse,y=!a||a.reset;return pm({...i,loop:e,default:!1,pause:void 0,to:!h||_1(t)?t:void 0,from:y?i.from:void 0,reset:y,...a})}}function pm(i){const{to:e,from:t}=i=lM(i),r=new Set;return Qt.obj(e)&&hS(e,r),Qt.obj(t)&&hS(t,r),i.keys=r.size?Array.from(r):null,i}function uL(i){const e=pm(i);return Qt.und(e.default)&&(e.default=Rw(e)),e}function hS(i,e){el(i,(t,r)=>t!=null&&e.add(r))}var hL=["onStart","onRest","onChange","onPause","onResume"];function dS(i,e,t){i.animation[t]=e[t]!==aM(e,t)?oM(e[t],i.key):void 0}function Op(i,e,...t){var r,a,h,y;(a=(r=i.animation)[e])==null||a.call(r,...t),(y=(h=i.defaultProps)[e])==null||y.call(h,...t)}var dL=["onStart","onChange","onRest"],fL=1,pL=class{constructor(e,t){this.id=fL++,this.springs={},this.queue=[],this._lastAsyncId=0,this._active=new Set,this._changed=new Set,this._started=!1,this._state={paused:!1,pauseQueue:new Set,resumeQueue:new Set,timeouts:new Set},this._events={onStart:new Map,onChange:new Map,onRest:new Map},this._onFrame=this._onFrame.bind(this),t&&(this._flush=t),e&&this.start({default:!0,...e})}get idle(){return!this._state.asyncTo&&Object.values(this.springs).every(e=>e.idle&&!e.isDelayed&&!e.isPaused)}get item(){return this._item}set item(e){this._item=e}get(){const e={};return this.each((t,r)=>e[r]=t.get()),e}set(e){for(const t in e){const r=e[t];Qt.und(r)||this.springs[t].set(r)}}update(e){return e&&this.queue.push(pm(e)),this}start(e){let{queue:t}=this;return e?t=mo(e).map(pm):this.queue=[],this._flush?this._flush(this,t):(xM(this,t),v1(this,t))}stop(e,t){if(e!==!!e&&(t=e),t){const r=this.springs;_r(mo(t),a=>r[a].stop(!!e))}else fm(this._state,this._lastAsyncId),this.each(r=>r.stop(!!e));return this}pause(e){if(Qt.und(e))this.start({pause:!0});else{const t=this.springs;_r(mo(e),r=>t[r].pause())}return this}resume(e){if(Qt.und(e))this.start({pause:!1});else{const t=this.springs;_r(mo(e),r=>t[r].resume())}return this}each(e){el(this.springs,e)}_onFrame(){const{onStart:e,onChange:t,onRest:r}=this._events,a=this._active.size>0,h=this._changed.size>0;(a&&!this._started||h&&!this._started)&&(this._started=!0,qp(e,([T,B])=>{B.value=this.get(),T(B,this,this._item)}));const y=!a&&this._started,s=h||y&&r.size?this.get():null;h&&t.size&&qp(t,([T,B])=>{B.value=s,T(B,this,this._item)}),y&&(this._started=!1,qp(r,([T,B])=>{B.value=s,T(B,this,this._item)}))}eventObserved(e){if(e.type=="change")this._changed.add(e.parent),e.idle||this._active.add(e.parent);else if(e.type=="idle")this._active.delete(e.parent);else return;Gi.onFrame(this._onFrame)}};function v1(i,e){return Promise.all(e.map(t=>_M(i,t))).then(t=>Pw(i,t))}async function _M(i,e,t){const{keys:r,to:a,from:h,loop:y,onRest:s,onResolve:T}=e,B=Qt.obj(e.default)&&e.default;y&&(e.loop=!1),a===!1&&(e.to=null),h===!1&&(e.from=null);const F=Qt.arr(a)||Qt.fun(a)?a:void 0;F?(e.to=void 0,e.onRest=void 0,B&&(B.onRest=void 0)):_r(dL,K=>{const ue=e[K];if(Qt.fun(ue)){const _e=i._events[K];e[K]=({finished:ke,cancelled:we})=>{const ge=_e.get(ue);ge?(ke||(ge.finished=!1),we&&(ge.cancelled=!0)):_e.set(ue,{value:null,finished:ke||!1,cancelled:we||!1})},B&&(B[K]=e[K])}});const V=i._state;e.pause===!V.paused?(V.paused=e.pause,zp(e.pause?V.pauseQueue:V.resumeQueue)):V.paused&&(e.pause=!0);const X=(r||Object.keys(i.springs)).map(K=>i.springs[K].start(e)),se=e.cancel===!0||aM(e,"cancel")===!0;(F||se&&V.asyncId)&&X.push(cM(++i._lastAsyncId,{props:e,state:V,actions:{pause:f1,resume:f1,start(K,ue){se?(fm(V,i._lastAsyncId),ue(pd(i))):(K.onRest=s,ue(hM(F,K,V,i)))}}})),V.paused&&await new Promise(K=>{V.resumeQueue.add(K)});const ne=Pw(i,await Promise.all(X));if(y&&ne.finished&&!(t&&ne.noop)){const K=mM(e,y,a);if(K)return xM(i,[K]),_M(i,K,!0)}return T&&Gi.batchedUpdates(()=>T(ne,i,i.item)),ne}function fS(i,e){const t={...i.springs};return e&&_r(mo(e),r=>{Qt.und(r.keys)&&(r=pm(r)),Qt.obj(r.to)||(r={...r,to:void 0}),vM(t,r,a=>yM(a))}),gM(i,t),t}function gM(i,e){el(e,(t,r)=>{i.springs[r]||(i.springs[r]=t,Rm(t,i))})}function yM(i,e){const t=new cL;return t.key=i,e&&Rm(t,e),t}function vM(i,e,t){e.keys&&_r(e.keys,r=>{(i[r]||(i[r]=t(r)))._prepareNode(e)})}function xM(i,e){_r(e,t=>{vM(i.springs,t,r=>yM(r,i))})}var d0=({children:i,...e})=>{const t=Ot.useContext(uy),r=e.pause||!!t.pause,a=e.immediate||!!t.immediate;e=jk(()=>({pause:r,immediate:a}),[r,a]);const{Provider:h}=uy;return Ot.createElement(h,{value:e},i)},uy=mL(d0,{});d0.Provider=uy.Provider;d0.Consumer=uy.Consumer;function mL(i,e){return Object.assign(i,Ot.createContext(e)),i.Provider._context=i,i.Consumer._context=i,i}var _L=()=>{const i=[],e=function(r){Uk();const a=[];return _r(i,(h,y)=>{if(Qt.und(r))a.push(h.start());else{const s=t(r,h,y);s&&a.push(h.start(s))}}),a};e.current=i,e.add=function(r){i.includes(r)||i.push(r)},e.delete=function(r){const a=i.indexOf(r);~a&&i.splice(a,1)},e.pause=function(){return _r(i,r=>r.pause(...arguments)),this},e.resume=function(){return _r(i,r=>r.resume(...arguments)),this},e.set=function(r){_r(i,(a,h)=>{const y=Qt.fun(r)?r(h,a):r;y&&a.set(y)})},e.start=function(r){const a=[];return _r(i,(h,y)=>{if(Qt.und(r))a.push(h.start());else{const s=this._getProps(r,h,y);s&&a.push(h.start(s))}}),a},e.stop=function(){return _r(i,r=>r.stop(...arguments)),this},e.update=function(r){return _r(i,(a,h)=>a.update(this._getProps(r,a,h))),this};const t=function(r,a,h){return Qt.fun(r)?r(h,a):r};return e._getProps=t,e};function gL(i,e,t){const r=Qt.fun(e)&&e;r&&!t&&(t=[]);const a=Ot.useMemo(()=>r||arguments.length==3?_L():void 0,[]),h=Ot.useRef(0),y=iM(),s=Ot.useMemo(()=>({ctrls:[],queue:[],flush(_e,ke){const we=fS(_e,ke);return h.current>0&&!s.queue.length&&!Object.keys(we).some(Le=>!_e.springs[Le])?v1(_e,ke):new Promise(Le=>{gM(_e,we),s.queue.push(()=>{Le(v1(_e,ke))}),y()})}}),[]),T=Ot.useRef([...s.ctrls]),B=[],F=tS(i)||0;Ot.useMemo(()=>{_r(T.current.slice(i,F),_e=>{iL(_e,a),_e.stop(!0)}),T.current.length=i,V(F,i)},[i]),Ot.useMemo(()=>{V(0,Math.min(F,i))},t);function V(_e,ke){for(let we=_e;we<ke;we++){const ge=T.current[we]||(T.current[we]=new pL(null,s.flush)),Le=r?r(we,ge):e[we];Le&&(B[we]=uL(Le))}}const X=T.current.map((_e,ke)=>fS(_e,B[ke])),se=Ot.useContext(d0),ne=tS(se),K=se!==ne&&tL(se);Iw(()=>{h.current++,s.ctrls=T.current;const{queue:_e}=s;_e.length&&(s.queue=[],_r(_e,ke=>ke())),_r(T.current,(ke,we)=>{a==null||a.add(ke),K&&ke.start({default:se});const ge=B[we];ge&&(rL(ke,ge.ref),ke.ref?ke.queue.push(ge):ke.start(ge))})}),rM(()=>()=>{_r(s.ctrls,_e=>_e.stop(!0))});const ue=X.map(_e=>({..._e}));return a?[ue,a]:ue}function yL(i,e){const t=Qt.fun(i),[[r],a]=gL(1,t?i:[i],t?[]:e);return t||arguments.length==2?[r,a]:r}var vL=class extends Bw{constructor(i,e){super(),this.source=i,this.idle=!0,this._active=new Set,this.calc=lm(...e);const t=this._get(),r=m1(t);Cw(this,r.create(t))}advance(i){const e=this._get(),t=this.get();Za(e,t)||(_a(this).setValue(e),this._onChange(e,this.idle)),!this.idle&&pS(this._active)&&Cx(this)}_get(){const i=Qt.arr(this.source)?this.source.map(fo):mo(fo(this.source));return this.calc(...i)}_start(){this.idle&&!pS(this._active)&&(this.idle=!1,_r(h0(this),i=>{i.done=!1}),Yo.skipAnimation?(Gi.batchedUpdates(()=>this.advance()),Cx(this)):a0.start(this))}_attach(){let i=1;_r(mo(this.source),e=>{ya(e)&&Rm(e,this),y1(e)&&(e.idle||this._active.add(e),i=Math.max(i,e.priority+1))}),this.priority=i,this._start()}_detach(){_r(mo(this.source),i=>{ya(i)&&ly(i,this)}),this._active.clear(),Cx(this)}eventObserved(i){i.type=="change"?i.idle?this.advance():(this._active.add(i.parent),this._start()):i.type=="idle"?this._active.delete(i.parent):i.type=="priority"&&(this.priority=mo(this.source).reduce((e,t)=>Math.max(e,(y1(t)?t.priority:0)+1),0))}};function xL(i){return i.idle!==!1}function pS(i){return!i.size||Array.from(i).every(xL)}function Cx(i){i.idle||(i.idle=!0,_r(h0(i),e=>{e.done=!0}),ay(i,{type:"idle",parent:i}))}Yo.assign({createStringInterpolator:eM,to:(i,e)=>new vL(i,e)});var bL=["primitive"].concat(Object.keys(UF).filter(i=>/^[A-Z]/.test(i)).map(i=>i[0].toLowerCase()+i.slice(1)));Yo.assign({createStringInterpolator:eM,colors:gk,frameLoop:"demand"});VF(()=>{Gi.advance()});var wL=Yk(bL,{applyAnimatedValues:jF}),mS=wL.animated;const AL={mapBoxUrl:"pk.eyJ1IjoieGRvcmUiLCJhIjoiY204YmFocXM0MGc2ajJqcTE4d3huYnZieiJ9.ATmgUrULtENCjGLuK5XG-A"},is={SCALE:10,DEFAULT_PATH:"/models/hospital_building.glb"},TL=[{id:"hospital-bach-mai",name:"Bach Mai Hospital",coordinates:[105.8419,21.0022,0],modelPath:is.DEFAULT_PATH,scale:is.SCALE,address:"78 Giai Phong Street, Phuong Mai, Dong Da District, Hanoi",phone:"1900 888 926",status:"available",patients:1250,city:"Hanoi"},{id:"hospital-viet-duc",name:"Viet Duc Hospital",coordinates:[105.8486,21.0196,0],modelPath:is.DEFAULT_PATH,scale:is.SCALE,address:"40 Trang Thi Street, Hang Bong, Hoan Kiem District, Hanoi",phone:"024 3825 3531",status:"full",patients:1500,city:"Hanoi"},{id:"hospital-108",name:"Central Military Hospital 108",coordinates:[105.8502,21.0183,0],modelPath:is.DEFAULT_PATH,scale:is.SCALE,address:"1 Tran Hung Dao Street, Bach Dang, Hai Ba Trung District, Hanoi",phone:"024 6278 4009",status:"available",patients:980,city:"Hanoi"},{id:"hospital-e",name:"Hospital E Hanoi",coordinates:[105.7969,21.0289,0],modelPath:is.DEFAULT_PATH,scale:is.SCALE,address:"89 Tran Cung Street, Nghia Tan, Cau Giay District, Hanoi",phone:"024 3574 1111",status:"available",patients:750,city:"Hanoi"},{id:"hospital-thanh-nhan",name:"Thanh Nhan Hospital",coordinates:[105.8562,21.0075,0],modelPath:is.DEFAULT_PATH,scale:is.SCALE,address:"42 Thanh Nhan Street, Hai Ba Trung District, Hanoi",phone:"024 3869 2131",status:"full",patients:1100,city:"Hanoi"},{id:"hospital-saint-paul",name:"Saint Paul Hospital",coordinates:[105.8474,21.0219,0],modelPath:is.DEFAULT_PATH,scale:is.SCALE,address:"12 Chu Van An Street, Dien Bien, Ba Dinh District, Hanoi",phone:"024 3823 4937",status:"available",patients:620,city:"Hanoi"},{id:"hospital-vinmec",name:"Vinmec Times City Hospital",coordinates:[105.8686,20.9947,0],modelPath:is.DEFAULT_PATH,scale:is.SCALE,address:"458 Minh Khai Street, Hai Ba Trung District, Hanoi",phone:"024 3974 3556",status:"available",patients:800,city:"Hanoi"},{id:"hospital-hong-ngoc",name:"Hong Ngoc Hospital",coordinates:[105.7927,21.035,0],modelPath:is.DEFAULT_PATH,scale:is.SCALE,address:"55 Yen Ninh Street, Truc Bach, Ba Dinh District, Hanoi",phone:"024 3927 5568",status:"full",patients:450,city:"Hanoi"},{id:"hospital-103",name:"Military Hospital 103",coordinates:[105.7836,21.0472,0],modelPath:"/models/hospital_building.glb",scale:2,address:"261 Phung Hung Street, Hoan Kiem District, Hanoi",phone:"024 3829 3031",status:"available",patients:890,city:"Hanoi"},{id:"hospital-k",name:"K Hospital Tan Trieu",coordinates:[105.7978,20.9647,0],modelPath:"/models/hospital_building.glb",scale:2,address:"30 Cau Buou Street, Tan Trieu, Thanh Tri District, Hanoi",phone:"024 3861 5320",status:"full",patients:1300,city:"Hanoi"},{id:"hospital-ung-buou-hanoi",name:"Hanoi Oncology Hospital",coordinates:[105.7912,21.0234,0],modelPath:"/models/hospital_building.glb",scale:2,address:"30 Cau Buou Street, Tan Trieu, Thanh Tri District, Hanoi",phone:"024 3861 5320",status:"available",patients:750,city:"Hanoi"},{id:"hospital-phu-nu-hanoi",name:"Hanoi Obstetrics and Gynecology Hospital",coordinates:[105.8123,21.0345,0],modelPath:"/models/hospital_building.glb",scale:2,address:"929 La Thanh Street, Ba Dinh District, Hanoi",phone:"024 3834 3181",status:"available",patients:620,city:"Hanoi"},{id:"hospital-tam-than-hanoi",name:"Hanoi Psychiatric Hospital",coordinates:[105.8234,21.0456,0],modelPath:"/models/hospital_building.glb",scale:2,address:"193 Nguyen Luong Bang Street, Dong Da District, Hanoi",phone:"024 3852 2141",status:"full",patients:450,city:"Hanoi"},{id:"hospital-da-khoa-hanoi",name:"Hanoi General Hospital",coordinates:[105.8345,21.0567,0],modelPath:"/models/hospital_building.glb",scale:2,address:"29 Hang Bong Street, Hoan Kiem District, Hanoi",phone:"024 3825 3531",status:"available",patients:850,city:"Hanoi"},{id:"hospital-nhi-hanoi",name:"National Children's Hospital",coordinates:[105.8456,21.0678,0],modelPath:"/models/hospital_building.glb",scale:2,address:"18/879 La Thanh Street, Dong Da District, Hanoi",phone:"024 6273 8532",status:"full",patients:1200,city:"Hanoi"},{id:"hospital-mat-hanoi",name:"National Eye Hospital",coordinates:[105.8567,21.0789,0],modelPath:"/models/hospital_building.glb",scale:2,address:"85 Ba Trieu Street, Hai Ba Trung District, Hanoi",phone:"024 3943 3571",status:"available",patients:680,city:"Hanoi"},{id:"hospital-rang-ham-mat-hanoi",name:"National Hospital of Odonto-Stomatology",coordinates:[105.8678,21.089,0],modelPath:"/models/hospital_building.glb",scale:2,address:"40B Trang Thi Street, Hoan Kiem District, Hanoi",phone:"024 3826 3852",status:"available",patients:550,city:"Hanoi"},{id:"hospital-y-hoc-co-truyen",name:"National Hospital of Traditional Medicine",coordinates:[105.8789,21.0901,0],modelPath:"/models/hospital_building.glb",scale:2,address:"29 Nguyen Binh Khiem Street, Hai Ba Trung District, Hanoi",phone:"024 3826 3852",status:"available",patients:420,city:"Hanoi"}],EL=[{id:"hospital-danang",name:"Da Nang Hospital",coordinates:[108.2208,16.0545,0],modelPath:"/models/hospital_building.glb",scale:2,address:"124 Hai Phong Street, Thach Thang, Hai Chau District, Da Nang",phone:"0236 3821 118",status:"available",patients:890,city:"Da Nang"},{id:"hospital-ung-buou-danang",name:"Da Nang Oncology Hospital",coordinates:[108.2187,16.0479,0],modelPath:"/models/hospital_building.glb",scale:2,address:"42 Nguyen Thi Nghia Street, Hai Chau District, Da Nang",phone:"0236 3847 520",status:"full",patients:670,city:"Da Nang"},{id:"hospital-phuc-hoi-danang",name:"Da Nang Rehabilitation Hospital",coordinates:[108.2234,16.0512,0],modelPath:"/models/hospital_building.glb",scale:2,address:"103 Hung Vuong Street, Hai Chau District, Da Nang",phone:"0236 3821 321",status:"available",patients:450,city:"Da Nang"},{id:"hospital-phu-nu-danang",name:"Da Nang Obstetrics and Gynecology Hospital",coordinates:[108.2156,16.0534,0],modelPath:"/models/hospital_building.glb",scale:2,address:"402 Le Van Hien Street, Son Tra District, Da Nang",phone:"0236 3929 444",status:"available",patients:520,city:"Da Nang"},{id:"hospital-tam-than-danang",name:"Da Nang Psychiatric Hospital",coordinates:[108.2198,16.0467,0],modelPath:"/models/hospital_building.glb",scale:2,address:"193 Nguyen Luong Bang Street, Lien Chieu District, Da Nang",phone:"0236 3842 326",status:"full",patients:380,city:"Da Nang"}],SL=[{id:"hospital-cho-ray",name:"Cho Ray Hospital",coordinates:[106.6706,10.7579,0],modelPath:"/models/hospital_building.glb",scale:2,address:"201B Nguyen Chi Thanh Street, Ward 12, District 5, Ho Chi Minh City",phone:"028 3855 4137",status:"available",patients:1600,city:"Ho Chi Minh City"},{id:"hospital-115",name:"People's Hospital 115",coordinates:[106.6841,10.7689,0],modelPath:"/models/hospital_building.glb",scale:2,address:"527 Su Van Hanh Street, Ward 12, District 10, Ho Chi Minh City",phone:"028 3865 2368",status:"full",patients:1200,city:"Ho Chi Minh City"},{id:"hospital-thong-nhat",name:"Thong Nhat Hospital",coordinates:[106.6645,10.7892,0],modelPath:"/models/hospital_building.glb",scale:2,address:"1 Ly Thuong Kiet Street, Ward 7, Tan Binh District, Ho Chi Minh City",phone:"028 3864 1111",status:"available",patients:950,city:"Ho Chi Minh City"},{id:"hospital-tu-du",name:"Tu Du Hospital",coordinates:[106.6883,10.7531,0],modelPath:"/models/hospital_building.glb",scale:2,address:"284 Cong Quynh Street, Pham Ngu Lao Ward, District 1, Ho Chi Minh City",phone:"028 5404 2829",status:"full",patients:1100,city:"Ho Chi Minh City"},{id:"hospital-binh-dan",name:"Binh Dan Hospital",coordinates:[106.6932,10.7602,0],modelPath:"/models/hospital_building.glb",scale:2,address:"371 Dien Bien Phu Street, Ward 4, District 3, Ho Chi Minh City",phone:"028 3839 7225",status:"available",patients:850,city:"Ho Chi Minh City"}],IL=[...TL,...EL,...SL];async function bM(i,e,t,r){return r._parse(i,e,t,r)}function tl(i,e){if(!i)throw new Error(e||"loader assertion failed.")}const f0=!!(typeof process!="object"||String(process)!=="[object process]"||process.browser),_S=typeof process<"u"&&process.version&&/v([0-9]*)/.exec(process.version);_S&&parseFloat(_S[1]);const bg=globalThis,Yh=globalThis.process||{},CL=globalThis.navigator||{};function wM(i){var r,a;if(typeof window<"u"&&((r=window.process)==null?void 0:r.type)==="renderer"||typeof process<"u"&&((a=process.versions)!=null&&a.electron))return!0;const t=typeof navigator<"u"&&navigator.userAgent;return!!(t&&t.indexOf("Electron")>=0)}function Du(){return!(typeof process=="object"&&String(process)==="[object process]"&&!(process!=null&&process.browser))||wM()}function ML(i){return Du()?wM()?"Electron":(CL.userAgent||"").indexOf("Edge")>-1?"Edge":globalThis.chrome?"Chrome":globalThis.safari?"Safari":globalThis.mozInnerScreenX?"Firefox":"Unknown":"Node"}const AM="4.1.0";function RL(i){try{const e=window[i],t="__storage_test__";return e.setItem(t,t),e.removeItem(t),e}catch{return null}}class PL{constructor(e,t,r="sessionStorage"){this.storage=RL(r),this.id=e,this.config=t,this._loadConfiguration()}getConfiguration(){return this.config}setConfiguration(e){if(Object.assign(this.config,e),this.storage){const t=JSON.stringify(this.config);this.storage.setItem(this.id,t)}}_loadConfiguration(){let e={};if(this.storage){const t=this.storage.getItem(this.id);e=t?JSON.parse(t):{}}return Object.assign(this.config,e),this}}function BL(i){let e;return i<10?e=`${i.toFixed(2)}ms`:i<100?e=`${i.toFixed(1)}ms`:i<1e3?e=`${i.toFixed(0)}ms`:e=`${(i/1e3).toFixed(2)}s`,e}function DL(i,e=8){const t=Math.max(e-i.length,0);return`${" ".repeat(t)}${i}`}var hy;(function(i){i[i.BLACK=30]="BLACK",i[i.RED=31]="RED",i[i.GREEN=32]="GREEN",i[i.YELLOW=33]="YELLOW",i[i.BLUE=34]="BLUE",i[i.MAGENTA=35]="MAGENTA",i[i.CYAN=36]="CYAN",i[i.WHITE=37]="WHITE",i[i.BRIGHT_BLACK=90]="BRIGHT_BLACK",i[i.BRIGHT_RED=91]="BRIGHT_RED",i[i.BRIGHT_GREEN=92]="BRIGHT_GREEN",i[i.BRIGHT_YELLOW=93]="BRIGHT_YELLOW",i[i.BRIGHT_BLUE=94]="BRIGHT_BLUE",i[i.BRIGHT_MAGENTA=95]="BRIGHT_MAGENTA",i[i.BRIGHT_CYAN=96]="BRIGHT_CYAN",i[i.BRIGHT_WHITE=97]="BRIGHT_WHITE"})(hy||(hy={}));const OL=10;function gS(i){return typeof i!="string"?i:(i=i.toUpperCase(),hy[i]||hy.WHITE)}function FL(i,e,t){return!Du&&typeof i=="string"&&(e&&(i=`\x1B[${gS(e)}m${i}\x1B[39m`),t&&(i=`\x1B[${gS(t)+OL}m${i}\x1B[49m`)),i}function kL(i,e=["constructor"]){const t=Object.getPrototypeOf(i),r=Object.getOwnPropertyNames(t),a=i;for(const h of r){const y=a[h];typeof y=="function"&&(e.find(s=>h===s)||(a[h]=y.bind(i)))}}function Dw(i,e){if(!i)throw new Error("Assertion failed")}function Kh(){var e,t,r;let i;if(Du()&&bg.performance)i=(t=(e=bg==null?void 0:bg.performance)==null?void 0:e.now)==null?void 0:t.call(e);else if("hrtime"in Yh){const a=(r=Yh==null?void 0:Yh.hrtime)==null?void 0:r.call(Yh);i=a[0]*1e3+a[1]/1e6}else i=Date.now();return i}const Jh={debug:Du()&&console.debug||console.log,log:console.log,info:console.info,warn:console.warn,error:console.error},LL={enabled:!0,level:0};function Qh(){}const yS={},vS={once:!0};class Bm{constructor({id:e}={id:""}){this.VERSION=AM,this._startTs=Kh(),this._deltaTs=Kh(),this.userData={},this.LOG_THROTTLE_TIMEOUT=0,this.id=e,this.userData={},this._storage=new PL(`__probe-${this.id}__`,LL),this.timeStamp(`${this.id} started`),kL(this),Object.seal(this)}set level(e){this.setLevel(e)}get level(){return this.getLevel()}isEnabled(){return this._storage.config.enabled}getLevel(){return this._storage.config.level}getTotal(){return Number((Kh()-this._startTs).toPrecision(10))}getDelta(){return Number((Kh()-this._deltaTs).toPrecision(10))}set priority(e){this.level=e}get priority(){return this.level}getPriority(){return this.level}enable(e=!0){return this._storage.setConfiguration({enabled:e}),this}setLevel(e){return this._storage.setConfiguration({level:e}),this}get(e){return this._storage.config[e]}set(e,t){this._storage.setConfiguration({[e]:t})}settings(){console.table?console.table(this._storage.config):console.log(this._storage.config)}assert(e,t){if(!e)throw new Error(t||"Assertion failed")}warn(e){return this._getLogFunction(0,e,Jh.warn,arguments,vS)}error(e){return this._getLogFunction(0,e,Jh.error,arguments)}deprecated(e,t){return this.warn(`\`${e}\` is deprecated and will be removed in a later version. Use \`${t}\` instead`)}removed(e,t){return this.error(`\`${e}\` has been removed. Use \`${t}\` instead`)}probe(e,t){return this._getLogFunction(e,t,Jh.log,arguments,{time:!0,once:!0})}log(e,t){return this._getLogFunction(e,t,Jh.debug,arguments)}info(e,t){return this._getLogFunction(e,t,console.info,arguments)}once(e,t){return this._getLogFunction(e,t,Jh.debug||Jh.info,arguments,vS)}table(e,t,r){return t?this._getLogFunction(e,t,console.table||Qh,r&&[r],{tag:zL(t)}):Qh}time(e,t){return this._getLogFunction(e,t,console.time?console.time:console.info)}timeEnd(e,t){return this._getLogFunction(e,t,console.timeEnd?console.timeEnd:console.info)}timeStamp(e,t){return this._getLogFunction(e,t,console.timeStamp||Qh)}group(e,t,r={collapsed:!1}){const a=xS({logLevel:e,message:t,opts:r}),{collapsed:h}=r;return a.method=(h?console.groupCollapsed:console.group)||console.info,this._getLogFunction(a)}groupCollapsed(e,t,r={}){return this.group(e,t,Object.assign({},r,{collapsed:!0}))}groupEnd(e){return this._getLogFunction(e,"",console.groupEnd||Qh)}withGroup(e,t,r){this.group(e,t)();try{r()}finally{this.groupEnd(e)()}}trace(){console.trace&&console.trace()}_shouldLog(e){return this.isEnabled()&&this.getLevel()>=TM(e)}_getLogFunction(e,t,r,a,h){if(this._shouldLog(e)){h=xS({logLevel:e,message:t,args:a,opts:h}),r=r||h.method,Dw(r),h.total=this.getTotal(),h.delta=this.getDelta(),this._deltaTs=Kh();const y=h.tag||h.message;if(h.once&&y)if(!yS[y])yS[y]=Kh();else return Qh;return t=NL(this.id,h.message,h),r.bind(console,t,...h.args)}return Qh}}Bm.VERSION=AM;function TM(i){if(!i)return 0;let e;switch(typeof i){case"number":e=i;break;case"object":e=i.logLevel||i.priority||0;break;default:return 0}return Dw(Number.isFinite(e)&&e>=0),e}function xS(i){const{logLevel:e,message:t}=i;i.logLevel=TM(e);const r=i.args?Array.from(i.args):[];for(;r.length&&r.shift()!==t;);switch(typeof e){case"string":case"function":t!==void 0&&r.unshift(t),i.message=e;break;case"object":Object.assign(i,e);break}typeof i.message=="function"&&(i.message=i.message());const a=typeof i.message;return Dw(a==="string"||a==="object"),Object.assign(i,{args:r},i.opts)}function NL(i,e,t){if(typeof e=="string"){const r=t.time?DL(BL(t.total)):"";e=t.time?`${i}: ${r}  ${e}`:`${i}: ${e}`,e=FL(e,t.color,t.background)}return e}function zL(i){for(const e in i)for(const t in i[e])return t||"untitled";return"empty"}const Mx="4.3.2",UL=Mx[0]>="0"&&Mx[0]<="9"?`v${Mx}`:"";function VL(){const i=new Bm({id:"loaders.gl"});return globalThis.loaders=globalThis.loaders||{},globalThis.loaders.log=i,globalThis.loaders.version=UL,globalThis.probe=globalThis.probe||{},globalThis.probe.loaders=i,i}const jL=VL();function HL(i,e){return EM(i||{},e)}function EM(i,e,t=0){if(t>3)return e;const r={...i};for(const[a,h]of Object.entries(e))h&&typeof h=="object"&&!Array.isArray(h)?r[a]=EM(r[a]||{},e[a],t+1):r[a]=e[a];return r}function GL(i){var e;globalThis.loaders||(globalThis.loaders={}),(e=globalThis.loaders).modules||(e.modules={}),Object.assign(globalThis.loaders.modules,i)}function $L(i){var t,r;return((r=(t=globalThis.loaders)==null?void 0:t.modules)==null?void 0:r[i])||null}const WL="latest";function qL(){var i;return(i=globalThis._loadersgl_)!=null&&i.version||(globalThis._loadersgl_=globalThis._loadersgl_||{},globalThis._loadersgl_.version="4.3.2"),globalThis._loadersgl_.version}const SM=qL();function il(i,e){if(!i)throw new Error(e||"loaders.gl assertion failed.")}const _o=typeof process!="object"||String(process)!=="[object process]"||process.browser,Ow=typeof importScripts=="function",XL=typeof window<"u"&&typeof window.orientation<"u",bS=typeof process<"u"&&process.version&&/v([0-9]*)/.exec(process.version);bS&&parseFloat(bS[1]);class ZL{constructor(e,t){pe(this,"name");pe(this,"workerThread");pe(this,"isRunning",!0);pe(this,"result");pe(this,"_resolve",()=>{});pe(this,"_reject",()=>{});this.name=e,this.workerThread=t,this.result=new Promise((r,a)=>{this._resolve=r,this._reject=a})}postMessage(e,t){this.workerThread.postMessage({source:"loaders.gl",type:e,payload:t})}done(e){il(this.isRunning),this.isRunning=!1,this._resolve(e)}error(e){il(this.isRunning),this.isRunning=!1,this._reject(e)}}class Rx{terminate(){}}const Px=new Map;function YL(i){il(i.source&&!i.url||!i.source&&i.url);let e=Px.get(i.source||i.url);return e||(i.url&&(e=KL(i.url),Px.set(i.url,e)),i.source&&(e=IM(i.source),Px.set(i.source,e))),il(e),e}function KL(i){if(!i.startsWith("http"))return i;const e=JL(i);return IM(e)}function IM(i){const e=new Blob([i],{type:"application/javascript"});return URL.createObjectURL(e)}function JL(i){return`try {
  importScripts('${i}');
} catch (error) {
  console.error(error);
  throw error;
}`}function CM(i,e=!0,t){const r=t||new Set;if(i){if(wS(i))r.add(i);else if(wS(i.buffer))r.add(i.buffer);else if(!ArrayBuffer.isView(i)){if(e&&typeof i=="object")for(const a in i)CM(i[a],e,r)}}return t===void 0?Array.from(r):[]}function wS(i){return i?i instanceof ArrayBuffer||typeof MessagePort<"u"&&i instanceof MessagePort||typeof ImageBitmap<"u"&&i instanceof ImageBitmap||typeof OffscreenCanvas<"u"&&i instanceof OffscreenCanvas:!1}const Bx=()=>{};class x1{constructor(e){pe(this,"name");pe(this,"source");pe(this,"url");pe(this,"terminated",!1);pe(this,"worker");pe(this,"onMessage");pe(this,"onError");pe(this,"_loadableURL","");const{name:t,source:r,url:a}=e;il(r||a),this.name=t,this.source=r,this.url=a,this.onMessage=Bx,this.onError=h=>console.log(h),this.worker=_o?this._createBrowserWorker():this._createNodeWorker()}static isSupported(){return typeof Worker<"u"&&_o||typeof Rx<"u"&&!_o}destroy(){this.onMessage=Bx,this.onError=Bx,this.worker.terminate(),this.terminated=!0}get isRunning(){return!!this.onMessage}postMessage(e,t){t=t||CM(e),this.worker.postMessage(e,t)}_getErrorFromErrorEvent(e){let t="Failed to load ";return t+=`worker ${this.name} from ${this.url}. `,e.message&&(t+=`${e.message} in `),e.lineno&&(t+=`:${e.lineno}:${e.colno}`),new Error(t)}_createBrowserWorker(){this._loadableURL=YL({source:this.source,url:this.url});const e=new Worker(this._loadableURL,{name:this.name});return e.onmessage=t=>{t.data?this.onMessage(t.data):this.onError(new Error("No data received"))},e.onerror=t=>{this.onError(this._getErrorFromErrorEvent(t)),this.terminated=!0},e.onmessageerror=t=>console.error(t),e}_createNodeWorker(){let e;if(this.url){const r=this.url.includes(":/")||this.url.startsWith("/")?this.url:`./${this.url}`;e=new Rx(r,{eval:!1})}else if(this.source)e=new Rx(this.source,{eval:!0});else throw new Error("no worker");return e.on("message",t=>{this.onMessage(t)}),e.on("error",t=>{this.onError(t)}),e.on("exit",t=>{}),e}}class QL{constructor(e){pe(this,"name","unnamed");pe(this,"source");pe(this,"url");pe(this,"maxConcurrency",1);pe(this,"maxMobileConcurrency",1);pe(this,"onDebug",()=>{});pe(this,"reuseWorkers",!0);pe(this,"props",{});pe(this,"jobQueue",[]);pe(this,"idleQueue",[]);pe(this,"count",0);pe(this,"isDestroyed",!1);this.source=e.source,this.url=e.url,this.setProps(e)}static isSupported(){return x1.isSupported()}destroy(){this.idleQueue.forEach(e=>e.destroy()),this.isDestroyed=!0}setProps(e){this.props={...this.props,...e},e.name!==void 0&&(this.name=e.name),e.maxConcurrency!==void 0&&(this.maxConcurrency=e.maxConcurrency),e.maxMobileConcurrency!==void 0&&(this.maxMobileConcurrency=e.maxMobileConcurrency),e.reuseWorkers!==void 0&&(this.reuseWorkers=e.reuseWorkers),e.onDebug!==void 0&&(this.onDebug=e.onDebug)}async startJob(e,t=(a,h,y)=>a.done(y),r=(a,h)=>a.error(h)){const a=new Promise(h=>(this.jobQueue.push({name:e,onMessage:t,onError:r,onStart:h}),this));return this._startQueuedJob(),await a}async _startQueuedJob(){if(!this.jobQueue.length)return;const e=this._getAvailableWorker();if(!e)return;const t=this.jobQueue.shift();if(t){this.onDebug({message:"Starting job",name:t.name,workerThread:e,backlog:this.jobQueue.length});const r=new ZL(t.name,e);e.onMessage=a=>t.onMessage(r,a.type,a.payload),e.onError=a=>t.onError(r,a),t.onStart(r);try{await r.result}catch(a){console.error(`Worker exception: ${a}`)}finally{this.returnWorkerToQueue(e)}}}returnWorkerToQueue(e){!_o||this.isDestroyed||!this.reuseWorkers||this.count>this._getMaxConcurrency()?(e.destroy(),this.count--):this.idleQueue.push(e),this.isDestroyed||this._startQueuedJob()}_getAvailableWorker(){if(this.idleQueue.length>0)return this.idleQueue.shift()||null;if(this.count<this._getMaxConcurrency()){this.count++;const e=`${this.name.toLowerCase()} (#${this.count} of ${this.maxConcurrency})`;return new x1({name:e,source:this.source,url:this.url})}return null}_getMaxConcurrency(){return XL?this.maxMobileConcurrency:this.maxConcurrency}}const e4={maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:!0,onDebug:()=>{}},Jl=class Jl{constructor(e){pe(this,"props");pe(this,"workerPools",new Map);this.props={...e4},this.setProps(e),this.workerPools=new Map}static isSupported(){return x1.isSupported()}static getWorkerFarm(e={}){return Jl._workerFarm=Jl._workerFarm||new Jl({}),Jl._workerFarm.setProps(e),Jl._workerFarm}destroy(){for(const e of this.workerPools.values())e.destroy();this.workerPools=new Map}setProps(e){this.props={...this.props,...e};for(const t of this.workerPools.values())t.setProps(this._getWorkerPoolProps())}getWorkerPool(e){const{name:t,source:r,url:a}=e;let h=this.workerPools.get(t);return h||(h=new QL({name:t,source:r,url:a}),h.setProps(this._getWorkerPoolProps()),this.workerPools.set(t,h)),h}_getWorkerPoolProps(){return{maxConcurrency:this.props.maxConcurrency,maxMobileConcurrency:this.props.maxMobileConcurrency,reuseWorkers:this.props.reuseWorkers,onDebug:this.props.onDebug}}};pe(Jl,"_workerFarm");let dy=Jl;function t4(i,e={}){const t=e[i.id]||{},r=_o?`${i.id}-worker.js`:`${i.id}-worker-node.js`;let a=t.workerUrl;if(!a&&i.id==="compression"&&(a=e.workerUrl),e._workerType==="test"&&(_o?a=`modules/${i.module}/dist/${r}`:a=`modules/${i.module}/src/workers/${i.id}-worker-node.ts`),!a){let h=i.version;h==="latest"&&(h=WL);const y=h?`@${h}`:"";a=`https://unpkg.com/@loaders.gl/${i.module}${y}/dist/${r}`}return il(a),a}function i4(i,e=SM){il(i,"no worker provided");const t=i.version;return!(!e||!t)}const Dx={};async function bu(i,e=null,t={},r=null){return e&&(i=r4(i,e,t,r)),Dx[i]=Dx[i]||n4(i),await Dx[i]}function r4(i,e,t={},r=null){if(!t.useLocalLibraries&&i.startsWith("http"))return i;r=r||i;const a=t.modules||{};return a[r]?a[r]:_o?t.CDN?(il(t.CDN.startsWith("http")),`${t.CDN}/${e}@${SM}/dist/libs/${r}`):Ow?`../src/libs/${r}`:`modules/${e}/src/libs/${r}`:`modules/${e}/dist/libs/${r}`}async function n4(i){if(i.endsWith("wasm"))return await o4(i);if(!_o)try{const{requireFromFile:t}=globalThis.loaders||{};return await(t==null?void 0:t(i))}catch(t){return console.error(t),null}if(Ow)return importScripts(i);const e=await a4(i);return s4(e,i)}function s4(i,e){if(!_o){const{requireFromString:r}=globalThis.loaders||{};return r==null?void 0:r(i,e)}if(Ow)return eval.call(globalThis,i),null;const t=document.createElement("script");t.id=e;try{t.appendChild(document.createTextNode(i))}catch{t.text=i}return document.body.appendChild(t),null}async function o4(i){const{readFileAsArrayBuffer:e}=globalThis.loaders||{};return _o||!e||i.startsWith("http")?await(await fetch(i)).arrayBuffer():await e(i)}async function a4(i){const{readFileAsText:e}=globalThis.loaders||{};return _o||!e||i.startsWith("http")?await(await fetch(i)).text():await e(i)}function l4(i,e){return!dy.isSupported()||!_o&&!(e!=null&&e._nodeWorkers)?!1:i.worker&&(e==null?void 0:e.worker)}async function c4(i,e,t,r,a){const h=i.id,y=t4(i,t),T=dy.getWorkerFarm(t).getWorkerPool({name:h,url:y});t=JSON.parse(JSON.stringify(t)),r=JSON.parse(JSON.stringify(r||{}));const B=await T.startJob("process-on-worker",u4.bind(null,a));return B.postMessage("process",{input:e,options:t,context:r}),await(await B.result).result}async function u4(i,e,t,r){switch(t){case"done":e.done(r);break;case"error":e.error(new Error(r.error));break;case"process":const{id:a,input:h,options:y}=r;try{const s=await i(h,y);e.postMessage("done",{id:a,result:s})}catch(s){const T=s instanceof Error?s.message:"unknown error";e.postMessage("error",{id:a,error:T})}break;default:console.warn(`parse-with-worker unknown message ${t}`)}}function h4(i,e=5){return typeof i=="string"?i.slice(0,e):ArrayBuffer.isView(i)?AS(i.buffer,i.byteOffset,e):i instanceof ArrayBuffer?AS(i,0,e):""}function AS(i,e,t){if(i.byteLength<=e+t)return"";const r=new DataView(i);let a="";for(let h=0;h<t;h++)a+=String.fromCharCode(r.getUint8(e+h));return a}function d4(i){try{return JSON.parse(i)}catch{throw new Error(`Failed to parse JSON from data starting with "${h4(i)}"`)}}function f4(i,e,t){if(t=t||i.byteLength,i.byteLength<t||e.byteLength<t)return!1;const r=new Uint8Array(i),a=new Uint8Array(e);for(let h=0;h<r.length;++h)if(r[h]!==a[h])return!1;return!0}function p4(...i){return m4(i)}function m4(i){const e=i.map(h=>h instanceof ArrayBuffer?new Uint8Array(h):h),t=e.reduce((h,y)=>h+y.byteLength,0),r=new Uint8Array(t);let a=0;for(const h of e)r.set(h,a),a+=h.byteLength;return r.buffer}function MM(i,e,t){const r=t!==void 0?new Uint8Array(i).subarray(e,e+t):new Uint8Array(i).subarray(e);return new Uint8Array(r).buffer}function Dm(i,e){return tl(i>=0),tl(e>0),i+(e-1)&-4}function _4(i,e,t){let r;if(i instanceof ArrayBuffer)r=new Uint8Array(i);else{const a=i.byteOffset,h=i.byteLength;r=new Uint8Array(i.buffer||i.arrayBuffer,a,h)}return e.set(r,t),t+Dm(r.byteLength,4)}async function g4(i){const e=[];for await(const t of i)e.push(t);return p4(...e)}function TS(){let i;if(typeof window<"u"&&window.performance)i=window.performance.now();else if(typeof process<"u"&&process.hrtime){const e=process.hrtime();i=e[0]*1e3+e[1]/1e6}else i=Date.now();return i}class ES{constructor(e,t){this.sampleSize=1,this.time=0,this.count=0,this.samples=0,this.lastTiming=0,this.lastSampleTime=0,this.lastSampleCount=0,this._count=0,this._time=0,this._samples=0,this._startTime=0,this._timerPending=!1,this.name=e,this.type=t,this.reset()}reset(){return this.time=0,this.count=0,this.samples=0,this.lastTiming=0,this.lastSampleTime=0,this.lastSampleCount=0,this._count=0,this._time=0,this._samples=0,this._startTime=0,this._timerPending=!1,this}setSampleSize(e){return this.sampleSize=e,this}incrementCount(){return this.addCount(1),this}decrementCount(){return this.subtractCount(1),this}addCount(e){return this._count+=e,this._samples++,this._checkSampling(),this}subtractCount(e){return this._count-=e,this._samples++,this._checkSampling(),this}addTime(e){return this._time+=e,this.lastTiming=e,this._samples++,this._checkSampling(),this}timeStart(){return this._startTime=TS(),this._timerPending=!0,this}timeEnd(){return this._timerPending?(this.addTime(TS()-this._startTime),this._timerPending=!1,this._checkSampling(),this):this}getSampleAverageCount(){return this.sampleSize>0?this.lastSampleCount/this.sampleSize:0}getSampleAverageTime(){return this.sampleSize>0?this.lastSampleTime/this.sampleSize:0}getSampleHz(){return this.lastSampleTime>0?this.sampleSize/(this.lastSampleTime/1e3):0}getAverageCount(){return this.samples>0?this.count/this.samples:0}getAverageTime(){return this.samples>0?this.time/this.samples:0}getHz(){return this.time>0?this.samples/(this.time/1e3):0}_checkSampling(){this._samples===this.sampleSize&&(this.lastSampleTime=this._time,this.lastSampleCount=this._count,this.count+=this._count,this.time+=this._time,this.samples+=this._samples,this._time=0,this._count=0,this._samples=0)}}class p0{constructor(e){this.stats={},this.id=e.id,this.stats={},this._initializeStats(e.stats),Object.seal(this)}get(e,t="count"){return this._getOrCreate({name:e,type:t})}get size(){return Object.keys(this.stats).length}reset(){for(const e of Object.values(this.stats))e.reset();return this}forEach(e){for(const t of Object.values(this.stats))e(t)}getTable(){const e={};return this.forEach(t=>{e[t.name]={time:t.time||0,count:t.count||0,average:t.getAverageTime()||0,hz:t.getHz()||0}}),e}_initializeStats(e=[]){e.forEach(t=>this._getOrCreate(t))}_getOrCreate(e){const{name:t,type:r}=e;let a=this.stats[t];return a||(e instanceof ES?a=e:a=new ES(t,r),this.stats[t]=a),a}}let y4="";const SS={};function v4(i){for(const e in SS)if(i.startsWith(e)){const t=SS[e];i=i.replace(e,t)}return!i.startsWith("http://")&&!i.startsWith("https://")&&(i=`${y4}${i}`),i}function x4(i){return i&&typeof i=="object"&&i.isBuffer}function RM(i){if(x4(i))return i;if(i instanceof ArrayBuffer)return i;if(ArrayBuffer.isView(i))return i.byteOffset===0&&i.byteLength===i.buffer.byteLength?i.buffer:i.buffer.slice(i.byteOffset,i.byteOffset+i.byteLength);if(typeof i=="string"){const e=i;return new TextEncoder().encode(e).buffer}if(i&&typeof i=="object"&&i._toArrayBuffer)return i._toArrayBuffer();throw new Error("toArrayBuffer")}function PM(i){const e=i?i.lastIndexOf("/"):-1;return e>=0?i.substr(e+1):""}function b4(i){const e=i?i.lastIndexOf("/"):-1;return e>=0?i.substr(0,e):""}const w4=i=>typeof i=="boolean",Yp=i=>typeof i=="function",Om=i=>i!==null&&typeof i=="object",IS=i=>Om(i)&&i.constructor==={}.constructor,A4=i=>!!i&&typeof i[Symbol.iterator]=="function",T4=i=>i&&typeof i[Symbol.asyncIterator]=="function",Ou=i=>typeof Response<"u"&&i instanceof Response||i&&i.arrayBuffer&&i.text&&i.json,Fu=i=>typeof Blob<"u"&&i instanceof Blob,E4=i=>i&&typeof i=="object"&&i.isBuffer,S4=i=>typeof ReadableStream<"u"&&i instanceof ReadableStream||Om(i)&&Yp(i.tee)&&Yp(i.cancel)&&Yp(i.getReader),I4=i=>Om(i)&&Yp(i.read)&&Yp(i.pipe)&&w4(i.readable),BM=i=>S4(i)||I4(i);class C4 extends Error{constructor(t,r){super(t);pe(this,"reason");pe(this,"url");pe(this,"response");this.reason=r.reason,this.url=r.url,this.response=r.response}}const M4=/^data:([-\w.]+\/[-\w.+]+)(;|,)/,R4=/^([-\w.]+\/[-\w.+]+)/;function CS(i,e){return i.toLowerCase()===e.toLowerCase()}function P4(i){const e=R4.exec(i);return e?e[1]:i}function MS(i){const e=M4.exec(i);return e?e[1]:""}const DM=/\?.*/;function B4(i){const e=i.match(DM);return e&&e[0]}function Fw(i){return i.replace(DM,"")}function D4(i){if(i.length<50)return i;const e=i.slice(i.length-15);return`${i.substr(0,32)}...${e}`}function m0(i){return Ou(i)?i.url:Fu(i)?i.name||"":typeof i=="string"?i:""}function kw(i){if(Ou(i)){const e=i,t=e.headers.get("content-type")||"",r=Fw(e.url);return P4(t)||MS(r)}return Fu(i)?i.type||"":typeof i=="string"?MS(i):""}function O4(i){return Ou(i)?i.headers["content-length"]||-1:Fu(i)?i.size:typeof i=="string"?i.length:i instanceof ArrayBuffer||ArrayBuffer.isView(i)?i.byteLength:-1}async function OM(i){if(Ou(i))return i;const e={},t=O4(i);t>=0&&(e["content-length"]=String(t));const r=m0(i),a=kw(i);a&&(e["content-type"]=a);const h=await L4(i);h&&(e["x-first-bytes"]=h),typeof i=="string"&&(i=new TextEncoder().encode(i));const y=new Response(i,{headers:e});return Object.defineProperty(y,"url",{value:r}),y}async function F4(i){if(!i.ok)throw await k4(i)}async function k4(i){const e=D4(i.url);let t=`Failed to fetch resource (${i.status}) ${i.statusText}: ${e}`;t=t.length>100?`${t.slice(0,100)}...`:t;const r={reason:i.statusText,url:i.url,response:i};try{const a=i.headers.get("Content-Type");r.reason=!i.bodyUsed&&(a!=null&&a.includes("application/json"))?await i.json():await i.text()}catch{}return new C4(t,r)}async function L4(i){if(typeof i=="string")return`data:,${i.slice(0,5)}`;if(i instanceof Blob){const t=i.slice(0,5);return await new Promise(r=>{const a=new FileReader;a.onload=h=>{var y;return r((y=h==null?void 0:h.target)==null?void 0:y.result)},a.readAsDataURL(t)})}if(i instanceof ArrayBuffer){const t=i.slice(0,5);return`data:base64,${N4(t)}`}return null}function N4(i){let e="";const t=new Uint8Array(i);for(let r=0;r<t.byteLength;r++)e+=String.fromCharCode(t[r]);return btoa(e)}function z4(i){return!U4(i)&&!V4(i)}function U4(i){return i.startsWith("http:")||i.startsWith("https:")}function V4(i){return i.startsWith("data:")}async function RS(i,e){var t,r;if(typeof i=="string"){const a=v4(i);return z4(a)&&(t=globalThis.loaders)!=null&&t.fetchNode?(r=globalThis.loaders)==null?void 0:r.fetchNode(a,e):await fetch(a,e)}return await OM(i)}const PS=new Bm({id:"loaders.gl"});class j4{log(){return()=>{}}info(){return()=>{}}warn(){return()=>{}}error(){return()=>{}}}class H4{constructor(){pe(this,"console");this.console=console}log(...e){return this.console.log.bind(this.console,...e)}info(...e){return this.console.info.bind(this.console,...e)}warn(...e){return this.console.warn.bind(this.console,...e)}error(...e){return this.console.error.bind(this.console,...e)}}const FM={fetch:null,mimeType:void 0,nothrow:!1,log:new H4,useLocalLibraries:!1,CDN:"https://unpkg.com/@loaders.gl",worker:!0,maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:f0,_nodeWorkers:!1,_workerType:"",limit:0,_limitMB:0,batchSize:"auto",batchDebounceMs:0,metadata:!1,transforms:[]},G4={throws:"nothrow",dataType:"(no longer used)",uri:"baseUri",method:"fetch.method",headers:"fetch.headers",body:"fetch.body",mode:"fetch.mode",credentials:"fetch.credentials",cache:"fetch.cache",redirect:"fetch.redirect",referrer:"fetch.referrer",referrerPolicy:"fetch.referrerPolicy",integrity:"fetch.integrity",keepalive:"fetch.keepalive",signal:"fetch.signal"};function kM(){globalThis.loaders=globalThis.loaders||{};const{loaders:i}=globalThis;return i._state||(i._state={}),i._state}function LM(){const i=kM();return i.globalOptions=i.globalOptions||{...FM},i.globalOptions}function $4(i,e,t,r){return t=t||[],t=Array.isArray(t)?t:[t],W4(i,t),X4(e,i,r)}function W4(i,e){BS(i,null,FM,G4,e);for(const t of e){const r=i&&i[t.id]||{},a=t.options&&t.options[t.id]||{},h=t.deprecatedOptions&&t.deprecatedOptions[t.id]||{};BS(r,t.id,a,h,e)}}function BS(i,e,t,r,a){const h=e||"Top level",y=e?`${e}.`:"";for(const s in i){const T=!e&&Om(i[s]),B=s==="baseUri"&&!e,F=s==="workerUrl"&&e;if(!(s in t)&&!B&&!F){if(s in r)PS.warn(`${h} loader option '${y}${s}' no longer supported, use '${r[s]}'`)();else if(!T){const V=q4(s,a);PS.warn(`${h} loader option '${y}${s}' not recognized. ${V}`)()}}}}function q4(i,e){const t=i.toLowerCase();let r="";for(const a of e)for(const h in a.options){if(i===h)return`Did you mean '${a.id}.${h}'?`;const y=h.toLowerCase();(t.startsWith(y)||y.startsWith(t))&&(r=r||`Did you mean '${a.id}.${h}'?`)}return r}function X4(i,e,t){const a={...i.options||{}};return Z4(a,t),a.log===null&&(a.log=new j4),DS(a,LM()),DS(a,e),a}function DS(i,e){for(const t in e)if(t in e){const r=e[t];IS(r)&&IS(i[t])?i[t]={...i[t],...e[t]}:i[t]=e[t]}}function Z4(i,e){e&&!("baseUri"in i)&&(i.baseUri=e)}function Lw(i){return i?(Array.isArray(i)&&(i=i[0]),Array.isArray(i==null?void 0:i.extensions)):!1}function Nw(i){tl(i,"null loader"),tl(Lw(i),"invalid loader");let e;return Array.isArray(i)&&(e=i[1],i=i[0],i={...i,options:{...i.options,...e}}),(i!=null&&i.parseTextSync||i!=null&&i.parseText)&&(i.text=!0),i.text||(i.binary=!0),i}const NM=()=>{const i=kM();return i.loaderRegistry=i.loaderRegistry||[],i.loaderRegistry};function Y4(i){const e=NM();i=Array.isArray(i)?i:[i];for(const t of i){const r=Nw(t);e.find(a=>r===a)||e.unshift(r)}}function K4(){return NM()}const J4=/\.([^.]+)$/;async function Q4(i,e=[],t,r){if(!zM(i))return null;let a=OS(i,e,{...t,nothrow:!0},r);if(a)return a;if(Fu(i)&&(i=await i.slice(0,10).arrayBuffer(),a=OS(i,e,t,r)),!a&&!(t!=null&&t.nothrow))throw new Error(UM(i));return a}function OS(i,e=[],t,r){if(!zM(i))return null;if(e&&!Array.isArray(e))return Nw(e);let a=[];e&&(a=a.concat(e)),t!=null&&t.ignoreRegisteredLoaders||a.push(...K4()),tN(a);const h=eN(i,a,t,r);if(!h&&!(t!=null&&t.nothrow))throw new Error(UM(i));return h}function eN(i,e,t,r){const a=m0(i),h=kw(i),y=Fw(a)||(r==null?void 0:r.url);let s=null,T="";return t!=null&&t.mimeType&&(s=Ox(e,t==null?void 0:t.mimeType),T=`match forced by supplied MIME type ${t==null?void 0:t.mimeType}`),s=s||iN(e,y),T=T||(s?`matched url ${y}`:""),s=s||Ox(e,h),T=T||(s?`matched MIME type ${h}`:""),s=s||nN(e,i),T=T||(s?`matched initial data ${VM(i)}`:""),t!=null&&t.fallbackMimeType&&(s=s||Ox(e,t==null?void 0:t.fallbackMimeType),T=T||(s?`matched fallback MIME type ${h}`:"")),T&&jL.log(1,`selectLoader selected ${s==null?void 0:s.name}: ${T}.`),s}function zM(i){return!(i instanceof Response&&i.status===204)}function UM(i){const e=m0(i),t=kw(i);let r="No valid loader found (";r+=e?`${PM(e)}, `:"no url provided, ",r+=`MIME type: ${t?`"${t}"`:"not provided"}, `;const a=i?VM(i):"";return r+=a?` first bytes: "${a}"`:"first bytes: not available",r+=")",r}function tN(i){for(const e of i)Nw(e)}function iN(i,e){const t=e&&J4.exec(e),r=t&&t[1];return r?rN(i,r):null}function rN(i,e){e=e.toLowerCase();for(const t of i)for(const r of t.extensions)if(r.toLowerCase()===e)return t;return null}function Ox(i,e){var t;for(const r of i)if((t=r.mimeTypes)!=null&&t.some(a=>CS(e,a))||CS(e,`application/x.${r.id}`))return r;return null}function nN(i,e){if(!e)return null;for(const t of i)if(typeof e=="string"){if(sN(e,t))return t}else if(ArrayBuffer.isView(e)){if(FS(e.buffer,e.byteOffset,t))return t}else if(e instanceof ArrayBuffer&&FS(e,0,t))return t;return null}function sN(i,e){return e.testText?e.testText(i):(Array.isArray(e.tests)?e.tests:[e.tests]).some(r=>i.startsWith(r))}function FS(i,e,t){return(Array.isArray(t.tests)?t.tests:[t.tests]).some(a=>oN(i,e,t,a))}function oN(i,e,t,r){if(r instanceof ArrayBuffer)return f4(r,i,r.byteLength);switch(typeof r){case"function":return r(i);case"string":const a=b1(i,e,r.length);return r===a;default:return!1}}function VM(i,e=5){return typeof i=="string"?i.slice(0,e):ArrayBuffer.isView(i)?b1(i.buffer,i.byteOffset,e):i instanceof ArrayBuffer?b1(i,0,e):""}function b1(i,e,t){if(i.byteLength<e+t)return"";const r=new DataView(i);let a="";for(let h=0;h<t;h++)a+=String.fromCharCode(r.getUint8(e+h));return a}const aN=256*1024;function*lN(i,e){const t=(e==null?void 0:e.chunkSize)||aN;let r=0;const a=new TextEncoder;for(;r<i.length;){const h=Math.min(i.length-r,t),y=i.slice(r,r+h);r+=h,yield a.encode(y)}}const cN=256*1024;function*uN(i,e={}){const{chunkSize:t=cN}=e;let r=0;for(;r<i.byteLength;){const a=Math.min(i.byteLength-r,t),h=new ArrayBuffer(a),y=new Uint8Array(i,r,a);new Uint8Array(h).set(y),r+=a,yield h}}const hN=1024*1024;async function*dN(i,e){const t=(e==null?void 0:e.chunkSize)||hN;let r=0;for(;r<i.size;){const a=r+t,h=await i.slice(r,a).arrayBuffer();r=a,yield h}}function kS(i,e){return f0?fN(i,e):pN(i)}async function*fN(i,e){const t=i.getReader();let r;try{for(;;){const a=r||t.read();e!=null&&e._streamReadAhead&&(r=t.read());const{done:h,value:y}=await a;if(h)return;yield RM(y)}}catch{t.releaseLock()}}async function*pN(i,e){for await(const t of i)yield RM(t)}function mN(i,e){if(typeof i=="string")return lN(i,e);if(i instanceof ArrayBuffer)return uN(i,e);if(Fu(i))return dN(i,e);if(BM(i))return kS(i,e);if(Ou(i))return kS(i.body,e);throw new Error("makeIterator")}const jM="Cannot convert supplied data type";function _N(i,e,t){if(e.text&&typeof i=="string")return i;if(E4(i)&&(i=i.buffer),i instanceof ArrayBuffer){const r=i;return e.text&&!e.binary?new TextDecoder("utf8").decode(r):r}if(ArrayBuffer.isView(i)){if(e.text&&!e.binary)return new TextDecoder("utf8").decode(i);let r=i.buffer;const a=i.byteLength||i.length;return(i.byteOffset!==0||a!==r.byteLength)&&(r=r.slice(i.byteOffset,i.byteOffset+a)),r}throw new Error(jM)}async function gN(i,e,t){const r=i instanceof ArrayBuffer||ArrayBuffer.isView(i);if(typeof i=="string"||r)return _N(i,e);if(Fu(i)&&(i=await OM(i)),Ou(i)){const a=i;return await F4(a),e.binary?await a.arrayBuffer():await a.text()}if(BM(i)&&(i=mN(i,t)),A4(i)||T4(i))return g4(i);throw new Error(jM)}function HM(i,e){const t=LM(),r=i||t;return typeof r.fetch=="function"?r.fetch:Om(r.fetch)?a=>RS(a,r.fetch):e!=null&&e.fetch?e==null?void 0:e.fetch:RS}function yN(i,e,t){if(t)return t;const r={fetch:HM(e,i),...i};if(r.url){const a=Fw(r.url);r.baseUrl=a,r.queryString=B4(r.url),r.filename=PM(a),r.baseUrl=b4(a)}return Array.isArray(r.loaders)||(r.loaders=null),r}function vN(i,e){if(i&&!Array.isArray(i))return i;let t;if(i&&(t=Array.isArray(i)?i:[i]),e&&e.loaders){const r=Array.isArray(e.loaders)?e.loaders:[e.loaders];t=t?[...t,...r]:r}return t&&t.length?t:void 0}async function fy(i,e,t,r){e&&!Array.isArray(e)&&!Lw(e)&&(r=void 0,t=e,e=void 0),i=await i,t=t||{};const a=m0(i),y=vN(e,r),s=await Q4(i,y,t);return s?(t=$4(t,s,y,a),r=yN({url:a,_parse:fy,loaders:y},t,r||null),await xN(s,i,t,r)):null}async function xN(i,e,t,r){if(i4(i),t=HL(i.options,t),Ou(e)){const h=e,{ok:y,redirected:s,status:T,statusText:B,type:F,url:V}=h,X=Object.fromEntries(h.headers.entries());r.response={headers:X,ok:y,redirected:s,status:T,statusText:B,type:F,url:V}}e=await gN(e,i,t);const a=i;if(a.parseTextSync&&typeof e=="string")return a.parseTextSync(e,t,r);if(l4(i,t))return await c4(i,e,t,r,fy);if(a.parseText&&typeof e=="string")return await a.parseText(e,t,r);if(a.parse)return await a.parse(e,t,r);throw il(!a.parseSync),new Error(`${i.id} loader - no parser found and worker is disabled`)}function bN(i){switch(i.constructor){case Int8Array:return"int8";case Uint8Array:case Uint8ClampedArray:return"uint8";case Int16Array:return"int16";case Uint16Array:return"uint16";case Int32Array:return"int32";case Uint32Array:return"uint32";case Float32Array:return"float32";case Float64Array:return"float64";default:return"null"}}function wN(i){let e=1/0,t=1/0,r=1/0,a=-1/0,h=-1/0,y=-1/0;const s=i.POSITION?i.POSITION.value:[],T=s&&s.length;for(let B=0;B<T;B+=3){const F=s[B],V=s[B+1],X=s[B+2];e=F<e?F:e,t=V<t?V:t,r=X<r?X:r,a=F>a?F:a,h=V>h?V:h,y=X>y?X:y}return[[e,t,r],[a,h,y]]}function AN(i,e,t){const r=bN(e.value),a=t||TN(e);return{name:i,type:{type:"fixed-size-list",listSize:e.size,children:[{name:"value",type:r}]},nullable:!1,metadata:a}}function TN(i){const e={};return"byteOffset"in i&&(e.byteOffset=i.byteOffset.toString(10)),"byteStride"in i&&(e.byteStride=i.byteStride.toString(10)),"normalized"in i&&(e.normalized=i.normalized.toString()),e}async function w1(i,e,t,r){let a,h;!Array.isArray(e)&&!Lw(e)?(a=[],h=e):(a=e,h=t);const y=HM(h);let s=i;return typeof i=="string"&&(s=await y(i)),Fu(i)&&(s=await y(i)),Array.isArray(a)?await fy(s,a,h):await fy(s,a,h)}const EN="4.3.2";var DC;const SN=(DC=globalThis.loaders)==null?void 0:DC.parseImageNode,A1=typeof Image<"u",T1=typeof ImageBitmap<"u",IN=!!SN,E1=f0?!0:IN;function CN(i){switch(i){case"auto":return T1||A1||E1;case"imagebitmap":return T1;case"image":return A1;case"data":return E1;default:throw new Error(`@loaders.gl/images: image ${i} not supported in this environment`)}}function MN(){if(T1)return"imagebitmap";if(A1)return"image";if(E1)return"data";throw new Error("Install '@loaders.gl/polyfills' to parse images under Node.js")}function RN(i){const e=PN(i);if(!e)throw new Error("Not an image");return e}function GM(i){switch(RN(i)){case"data":return i;case"image":case"imagebitmap":const e=document.createElement("canvas"),t=e.getContext("2d");if(!t)throw new Error("getImageData");return e.width=i.width,e.height=i.height,t.drawImage(i,0,0),t.getImageData(0,0,i.width,i.height);default:throw new Error("getImageData")}}function PN(i){return typeof ImageBitmap<"u"&&i instanceof ImageBitmap?"imagebitmap":typeof Image<"u"&&i instanceof Image?"image":i&&typeof i=="object"&&i.data&&i.width&&i.height?"data":null}const BN=/^data:image\/svg\+xml/,DN=/\.svg((\?|#).*)?$/;function zw(i){return i&&(BN.test(i)||DN.test(i))}function ON(i,e){if(zw(e)){let r=new TextDecoder().decode(i);try{typeof unescape=="function"&&typeof encodeURIComponent=="function"&&(r=unescape(encodeURIComponent(r)))}catch(h){throw new Error(h.message)}return`data:image/svg+xml;base64,${btoa(r)}`}return $M(i,e)}function $M(i,e){if(zw(e))throw new Error("SVG cannot be parsed directly to imagebitmap");return new Blob([new Uint8Array(i)])}async function WM(i,e,t){const r=ON(i,t),a=self.URL||self.webkitURL,h=typeof r!="string"&&a.createObjectURL(r);try{return await FN(h||r,e)}finally{h&&a.revokeObjectURL(h)}}async function FN(i,e){const t=new Image;return t.src=i,e.image&&e.image.decode&&t.decode?(await t.decode(),t):await new Promise((r,a)=>{try{t.onload=()=>r(t),t.onerror=h=>{const y=h instanceof Error?h.message:"error";a(new Error(y))}}catch(h){a(h)}})}const kN={};let LS=!0;async function LN(i,e,t){let r;zw(t)?r=await WM(i,e,t):r=$M(i,t);const a=e&&e.imagebitmap;return await NN(r,a)}async function NN(i,e=null){if((zN(e)||!LS)&&(e=null),e)try{return await createImageBitmap(i,e)}catch(t){console.warn(t),LS=!1}return await createImageBitmap(i)}function zN(i){for(const e in i||kN)return!1;return!0}function UN(i){return!GN(i,"ftyp",4)||(i[8]&96)===0?null:VN(i)}function VN(i){switch(jN(i,8,12).replace("\0"," ").trim()){case"avif":case"avis":return{extension:"avif",mimeType:"image/avif"};default:return null}}function jN(i,e,t){return String.fromCharCode(...i.slice(e,t))}function HN(i){return[...i].map(e=>e.charCodeAt(0))}function GN(i,e,t=0){const r=HN(e);for(let a=0;a<r.length;++a)if(r[a]!==i[a+t])return!1;return!0}const va=!1,Kp=!0;function Uw(i){const e=Fm(i);return WN(e)||ZN(e)||qN(e)||XN(e)||$N(e)}function $N(i){const e=new Uint8Array(i instanceof DataView?i.buffer:i),t=UN(e);return t?{mimeType:t.mimeType,width:0,height:0}:null}function WN(i){const e=Fm(i);return e.byteLength>=24&&e.getUint32(0,va)===2303741511?{mimeType:"image/png",width:e.getUint32(16,va),height:e.getUint32(20,va)}:null}function qN(i){const e=Fm(i);return e.byteLength>=10&&e.getUint32(0,va)===1195984440?{mimeType:"image/gif",width:e.getUint16(6,Kp),height:e.getUint16(8,Kp)}:null}function XN(i){const e=Fm(i);return e.byteLength>=14&&e.getUint16(0,va)===16973&&e.getUint32(2,Kp)===e.byteLength?{mimeType:"image/bmp",width:e.getUint32(18,Kp),height:e.getUint32(22,Kp)}:null}function ZN(i){const e=Fm(i);if(!(e.byteLength>=3&&e.getUint16(0,va)===65496&&e.getUint8(2)===255))return null;const{tableMarkers:r,sofMarkers:a}=YN();let h=2;for(;h+9<e.byteLength;){const y=e.getUint16(h,va);if(a.has(y))return{mimeType:"image/jpeg",height:e.getUint16(h+5,va),width:e.getUint16(h+7,va)};if(!r.has(y))return null;h+=2,h+=e.getUint16(h,va)}return null}function YN(){const i=new Set([65499,65476,65484,65501,65534]);for(let t=65504;t<65520;++t)i.add(t);return{tableMarkers:i,sofMarkers:new Set([65472,65473,65474,65475,65477,65478,65479,65481,65482,65483,65485,65486,65487,65502])}}function Fm(i){if(i instanceof DataView)return i;if(ArrayBuffer.isView(i))return new DataView(i.buffer);if(i instanceof ArrayBuffer)return new DataView(i);throw new Error("toDataView")}async function KN(i,e){var a;const{mimeType:t}=Uw(i)||{},r=(a=globalThis.loaders)==null?void 0:a.parseImageNode;return tl(r),await r(i,t)}async function JN(i,e,t){e=e||{};const a=(e.image||{}).type||"auto",{url:h}=t||{},y=QN(a);let s;switch(y){case"imagebitmap":s=await LN(i,e,h);break;case"image":s=await WM(i,e,h);break;case"data":s=await KN(i);break;default:tl(!1)}return a==="data"&&(s=GM(s)),s}function QN(i){switch(i){case"auto":case"data":return MN();default:return CN(i),i}}const ez=["png","jpg","jpeg","gif","webp","bmp","ico","svg","avif"],tz=["image/png","image/jpeg","image/gif","image/webp","image/avif","image/bmp","image/vnd.microsoft.icon","image/svg+xml"],iz={image:{type:"auto",decode:!0}},qM={dataType:null,batchType:null,id:"image",module:"images",name:"Images",version:EN,mimeTypes:tz,extensions:ez,parse:JN,tests:[i=>!!Uw(new DataView(i))],options:iz},Fx={};function rz(i){if(Fx[i]===void 0){const e=f0?sz(i):nz(i);Fx[i]=e}return Fx[i]}function nz(i){var a,h;const e=["image/png","image/jpeg","image/gif"],t=((a=globalThis.loaders)==null?void 0:a.imageFormatsNode)||e;return!!((h=globalThis.loaders)==null?void 0:h.parseImageNode)&&t.includes(i)}function sz(i){switch(i){case"image/avif":case"image/webp":return oz(i);default:return!0}}function oz(i){try{return document.createElement("canvas").toDataURL(i).indexOf(`data:${i}`)===0}catch{return!1}}const gr=new Bm({id:"deck"});let S1={};function az(i){S1=i}function bs(i,e,t,r){gr.level>0&&S1[i]&&S1[i].call(null,e,t,r)}function lz(i){const e=i[0],t=i[i.length-1];return e==="{"&&t==="}"||e==="["&&t==="]"}const cz={dataType:null,batchType:null,id:"JSON",name:"JSON",module:"",version:"",options:{},extensions:["json","geojson"],mimeTypes:["application/json","application/geo+json"],testText:lz,parseTextSync:JSON.parse};function uz(){const i="9.1.11",e=globalThis.deck&&globalThis.deck.VERSION;if(e&&e!==i)throw new Error(`deck.gl - multiple versions detected: ${e} vs ${i}`);return e||(gr.log(1,`deck.gl ${i}`)(),globalThis.deck={...globalThis.deck,VERSION:i,version:i,log:gr,_registerLoggers:az},Y4([cz,[qM,{imagebitmap:{premultiplyAlpha:"none"}}]])),i}const hz=uz();function Vw(i,e){if(!i)throw new Error(e||"shadertools: assertion failed.")}const kx={number:{type:"number",validate(i,e){return Number.isFinite(i)&&typeof e=="object"&&(e.max===void 0||i<=e.max)&&(e.min===void 0||i>=e.min)}},array:{type:"array",validate(i,e){return Array.isArray(i)||ArrayBuffer.isView(i)}}};function dz(i){const e={};for(const[t,r]of Object.entries(i))e[t]=fz(r);return e}function fz(i){let e=NS(i);if(e!=="object")return{value:i,...kx[e],type:e};if(typeof i=="object")return i?i.type!==void 0?{...i,...kx[i.type],type:i.type}:i.value===void 0?{type:"object",value:i}:(e=NS(i.value),{...i,...kx[e],type:e}):{type:"object",value:null};throw new Error("props")}function NS(i){return Array.isArray(i)||ArrayBuffer.isView(i)?"array":typeof i}const pz=`#ifdef MODULE_LOGDEPTH
  logdepth_adjustPosition(gl_Position);
#endif
`,mz=`#ifdef MODULE_MATERIAL
  fragColor = material_filterColor(fragColor);
#endif

#ifdef MODULE_LIGHTING
  fragColor = lighting_filterColor(fragColor);
#endif

#ifdef MODULE_FOG
  fragColor = fog_filterColor(fragColor);
#endif

#ifdef MODULE_PICKING
  fragColor = picking_filterHighlightColor(fragColor);
  fragColor = picking_filterPickingColor(fragColor);
#endif

#ifdef MODULE_LOGDEPTH
  logdepth_setFragDepth();
#endif
`,_z={vertex:pz,fragment:mz},zS=/void\s+main\s*\([^)]*\)\s*\{\n?/,US=/}\n?[^{}]*$/,Lx=[],$g="__LUMA_INJECT_DECLARATIONS__";function gz(i){const e={vertex:{},fragment:{}};for(const t in i){let r=i[t];const a=yz(t);typeof r=="string"&&(r={order:0,injection:r}),e[a][t]=r}return e}function yz(i){const e=i.slice(0,2);switch(e){case"vs":return"vertex";case"fs":return"fragment";default:throw new Error(e)}}function py(i,e,t,r=!1){const a=e==="vertex";for(const h in t){const y=t[h];y.sort((T,B)=>T.order-B.order),Lx.length=y.length;for(let T=0,B=y.length;T<B;++T)Lx[T]=y[T].injection;const s=`${Lx.join(`
`)}
`;switch(h){case"vs:#decl":a&&(i=i.replace($g,s));break;case"vs:#main-start":a&&(i=i.replace(zS,T=>T+s));break;case"vs:#main-end":a&&(i=i.replace(US,T=>s+T));break;case"fs:#decl":a||(i=i.replace($g,s));break;case"fs:#main-start":a||(i=i.replace(zS,T=>T+s));break;case"fs:#main-end":a||(i=i.replace(US,T=>s+T));break;default:i=i.replace(h,T=>T+s)}}return i=i.replace($g,""),r&&(i=i.replace(/\}\s*$/,h=>h+_z[e])),i}function my(i){i.map(e=>vz(e))}function vz(i){if(i.instance)return;my(i.dependencies||[]);const{propTypes:e={},deprecations:t=[],inject:r={}}=i,a={normalizedInjections:gz(r),parsedDeprecations:xz(t)};e&&(a.propValidators=dz(e)),i.instance=a;let h={};e&&(h=Object.entries(e).reduce((y,[s,T])=>{const B=T==null?void 0:T.value;return B&&(y[s]=B),y},{})),i.defaultUniforms={...i.defaultUniforms,...h}}function XM(i,e,t){var r;(r=i.deprecations)==null||r.forEach(a=>{var h;(h=a.regex)!=null&&h.test(e)&&(a.deprecated?t.deprecated(a.old,a.new)():t.removed(a.old,a.new)())})}function xz(i){return i.forEach(e=>{switch(e.type){case"function":e.regex=new RegExp(`\\b${e.old}\\(`);break;default:e.regex=new RegExp(`${e.type} ${e.old};`)}}),i}function jw(i){my(i);const e={},t={};ZM({modules:i,level:0,moduleMap:e,moduleDepth:t});const r=Object.keys(t).sort((a,h)=>t[h]-t[a]).map(a=>e[a]);return my(r),r}function ZM(i){const{modules:e,level:t,moduleMap:r,moduleDepth:a}=i;if(t>=5)throw new Error("Possible loop in shader dependency graph");for(const h of e)r[h.name]=h,(a[h.name]===void 0||a[h.name]<t)&&(a[h.name]=t);for(const h of e)h.dependencies&&ZM({modules:h.dependencies,level:t+1,moduleMap:r,moduleDepth:a})}function bz(i){switch(i==null?void 0:i.gpu.toLowerCase()){case"apple":return`#define APPLE_GPU
// Apple optimizes away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
// Intel GPU doesn't have full 32 bits precision in same cases, causes overflow
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`;case"nvidia":return`#define NVIDIA_GPU
// Nvidia optimizes away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
`;case"intel":return`#define INTEL_GPU
// Intel optimizes away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
// Intel's built-in 'tan' function doesn't have acceptable precision
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
// Intel GPU doesn't have full 32 bits precision in same cases, causes overflow
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`;case"amd":return`#define AMD_GPU
`;default:return`#define DEFAULT_GPU
// Prevent driver from optimizing away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
// Headless Chrome's software shader 'tan' function doesn't have acceptable precision
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
// If the GPU doesn't have full 32 bits precision, will causes overflow
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`}}function wz(i,e){var r;if(Number(((r=i.match(/^#version[ \t]+(\d+)/m))==null?void 0:r[1])||100)!==300)throw new Error("luma.gl v9 only supports GLSL 3.00 shader sources");switch(e){case"vertex":return i=VS(i,Az),i;case"fragment":return i=VS(i,Tz),i;default:throw new Error(e)}}const YM=[[/^(#version[ \t]+(100|300[ \t]+es))?[ \t]*\n/,`#version 300 es
`],[/\btexture(2D|2DProj|Cube)Lod(EXT)?\(/g,"textureLod("],[/\btexture(2D|2DProj|Cube)(EXT)?\(/g,"texture("]],Az=[...YM,[I1("attribute"),"in $1"],[I1("varying"),"out $1"]],Tz=[...YM,[I1("varying"),"in $1"]];function VS(i,e){for(const[t,r]of e)i=i.replace(t,r);return i}function I1(i){return new RegExp(`\\b${i}[ \\t]+(\\w+[ \\t]+\\w+(\\[\\w+\\])?;)`,"g")}function KM(i,e){let t="";for(const r in i){const a=i[r];if(t+=`void ${a.signature} {
`,a.header&&(t+=`  ${a.header}`),e[r]){const h=e[r];h.sort((y,s)=>y.order-s.order);for(const y of h)t+=`  ${y.injection}
`}a.footer&&(t+=`  ${a.footer}`),t+=`}
`}return t}function JM(i){const e={vertex:{},fragment:{}};for(const t of i){let r,a;typeof t!="string"?(r=t,a=r.hook):(r={},a=t),a=a.trim();const[h,y]=a.split(":"),s=a.replace(/\(.+/,""),T=Object.assign(r,{signature:y});switch(h){case"vs":e.vertex[s]=T;break;case"fs":e.fragment[s]=T;break;default:throw new Error(h)}}return e}function Ez(i,e){return{name:Sz(i,e),language:"glsl",version:Iz(i)}}function Sz(i,e="unnamed"){const r=/#define[^\S\r\n]*SHADER_NAME[^\S\r\n]*([A-Za-z0-9_-]+)\s*/.exec(i);return r?r[1]:e}function Iz(i){let e=100;const t=i.match(/[^\s]+/g);if(t&&t.length>=2&&t[0]==="#version"){const r=parseInt(t[1],10);Number.isFinite(r)&&(e=r)}if(e!==100&&e!==300)throw new Error(`Invalid GLSL version ${e}`);return e}const QM=`

${$g}
`,Cz=`precision highp float;
`;function Mz(i){const e=jw(i.modules||[]);return{source:Pz(i.platformInfo,{...i,source:i.source,stage:"vertex",modules:e}),getUniforms:eR(e)}}function Rz(i){const{vs:e,fs:t}=i,r=jw(i.modules||[]);return{vs:jS(i.platformInfo,{...i,source:e,stage:"vertex",modules:r}),fs:jS(i.platformInfo,{...i,source:t,stage:"fragment",modules:r}),getUniforms:eR(r)}}function Pz(i,e){var K;const{source:t,stage:r,modules:a,hookFunctions:h=[],inject:y={},log:s}=e;Vw(typeof t=="string","shader source must be a string");const T=t;let B="";const F=JM(h),V={},X={},se={};for(const ue in y){const _e=typeof y[ue]=="string"?{injection:y[ue],order:0}:y[ue],ke=/^(v|f)s:(#)?([\w-]+)$/.exec(ue);if(ke){const we=ke[2],ge=ke[3];we?ge==="decl"?X[ue]=[_e]:se[ue]=[_e]:V[ue]=[_e]}else se[ue]=[_e]}const ne=a;for(const ue of ne){s&&XM(ue,T,s);const _e=tR(ue,"wgsl");B+=_e;const ke=((K=ue.injections)==null?void 0:K[r])||{};for(const we in ke){const ge=/^(v|f)s:#([\w-]+)$/.exec(we);if(ge){const $e=ge[2]==="decl"?X:se;$e[we]=$e[we]||[],$e[we].push(ke[we])}else V[we]=V[we]||[],V[we].push(ke[we])}}return B+=QM,B=py(B,r,X),B+=KM(F[r],V),B+=T,B=py(B,r,se),B}function jS(i,e){var Ye;const{id:t,source:r,stage:a,language:h="glsl",modules:y,defines:s={},hookFunctions:T=[],inject:B={},prologue:F=!0,log:V}=e;Vw(typeof r=="string","shader source must be a string");const X=h==="glsl"?Ez(r).version:-1,se=i.shaderLanguageVersion,ne=X===100?"#version 100":"#version 300 es",ue=r.split(`
`).slice(1).join(`
`),_e={};y.forEach(St=>{Object.assign(_e,St.defines)}),Object.assign(_e,s);let ke="";switch(h){case"wgsl":break;case"glsl":ke=F?`${ne}

// ----- PROLOGUE -------------------------
${Bz({id:t,source:r,stage:a})}
${`#define SHADER_TYPE_${a.toUpperCase()}`}

${bz(i)}
${a==="fragment"?Cz:""}

// ----- APPLICATION DEFINES -------------------------

${Dz(_e)}

`:`${ne}
`;break}const we=JM(T),ge={},Le={},$e={};for(const St in B){const Pt=typeof B[St]=="string"?{injection:B[St],order:0}:B[St],vt=/^(v|f)s:(#)?([\w-]+)$/.exec(St);if(vt){const yt=vt[2],hi=vt[3];yt?hi==="decl"?Le[St]=[Pt]:$e[St]=[Pt]:ge[St]=[Pt]}else $e[St]=[Pt]}for(const St of y){V&&XM(St,ue,V);const Pt=tR(St,a);ke+=Pt;const vt=((Ye=St.instance)==null?void 0:Ye.normalizedInjections[a])||{};for(const yt in vt){const hi=/^(v|f)s:#([\w-]+)$/.exec(yt);if(hi){const Si=hi[2]==="decl"?Le:$e;Si[yt]=Si[yt]||[],Si[yt].push(vt[yt])}else ge[yt]=ge[yt]||[],ge[yt].push(vt[yt])}}return ke+="// ----- MAIN SHADER SOURCE -------------------------",ke+=QM,ke=py(ke,a,Le),ke+=KM(we[a],ge),ke+=ue,ke=py(ke,a,$e),h==="glsl"&&X!==se&&(ke=wz(ke,a)),ke.trim()}function eR(i){return function(t){var a;const r={};for(const h of i){const y=(a=h.getUniforms)==null?void 0:a.call(h,t,r);Object.assign(r,y)}return r}}function Bz(i){const{id:e,source:t,stage:r}=i;return e&&t.indexOf("SHADER_NAME")===-1?`
#define SHADER_NAME ${e}_${r}`:""}function Dz(i={}){let e="";for(const t in i){const r=i[t];(r||Number.isFinite(r))&&(e+=`#define ${t.toUpperCase()} ${i[t]}
`)}return e}function tR(i,e){let t;switch(e){case"vertex":t=i.vs||"";break;case"fragment":t=i.fs||"";break;case"wgsl":t=i.source||"";break;default:Vw(!1)}if(!i.name)throw new Error("Shader module must have a name");const r=i.name.toUpperCase().replace(/[^0-9a-z]/gi,"_");let a=`// ----- MODULE ${i.name} ---------------

`;return e!=="wgsl"&&(a+=`#define MODULE_${r}
`),a+=`${t}
`,a}const Oz=/^\s*\#\s*ifdef\s*([a-zA-Z_]+)\s*$/,Fz=/^\s*\#\s*endif\s*$/;function kz(i,e){var y;const t=i.split(`
`),r=[];let a=!0,h=null;for(const s of t){const T=s.match(Oz),B=s.match(Fz);T?(h=T[1],a=!!((y=e==null?void 0:e.defines)!=null&&y[h])):B?a=!0:a&&r.push(s)}return r.join(`
`)}const yu=class yu{constructor(){pe(this,"_hookFunctions",[]);pe(this,"_defaultModules",[])}static getDefaultShaderAssembler(){return yu.defaultShaderAssembler=yu.defaultShaderAssembler||new yu,yu.defaultShaderAssembler}addDefaultModule(e){this._defaultModules.find(t=>t.name===(typeof e=="string"?e:e.name))||this._defaultModules.push(e)}removeDefaultModule(e){const t=typeof e=="string"?e:e.name;this._defaultModules=this._defaultModules.filter(r=>r.name!==t)}addShaderHook(e,t){t&&(e=Object.assign(t,{hook:e})),this._hookFunctions.push(e)}assembleWGSLShader(e){const t=this._getModuleList(e.modules),r=this._hookFunctions,{source:a,getUniforms:h}=Mz({...e,source:e.source,modules:t,hookFunctions:r});return{source:e.platformInfo.shaderLanguage==="wgsl"?kz(a):a,getUniforms:h,modules:t}}assembleGLSLShaderPair(e){const t=this._getModuleList(e.modules),r=this._hookFunctions;return{...Rz({...e,vs:e.vs,fs:e.fs,modules:t,hookFunctions:r}),modules:t}}_getModuleList(e=[]){const t=new Array(this._defaultModules.length+e.length),r={};let a=0;for(let h=0,y=this._defaultModules.length;h<y;++h){const s=this._defaultModules[h],T=s.name;t[a++]=s,r[T]=!0}for(let h=0,y=e.length;h<y;++h){const s=e[h],T=s.name;r[T]||(t[a++]=s,r[T]=!0)}return t.length=a,my(t),t}};pe(yu,"defaultShaderAssembler");let _y=yu;const Lz=`out vec4 transform_output;
void main() {
  transform_output = vec4(0);
}`,Nz=`#version 300 es
${Lz}`;function zz(i){const{input:e,inputChannels:t,output:r}={};if(!e)return Nz;if(!t)throw new Error("inputChannels");const a=Uz(t),h=Vz(e,t);return`#version 300 es
in ${a} ${e};
out vec4 ${r};
void main() {
  ${r} = ${h};
}`}function Uz(i){switch(i){case 1:return"float";case 2:return"vec2";case 3:return"vec3";case 4:return"vec4";default:throw new Error(`invalid channels: ${i}`)}}function Vz(i,e){switch(e){case 1:return`vec4(${i}, 0.0, 0.0, 1.0)`;case 2:return`vec4(${i}, 0.0, 1.0)`;case 3:return`vec4(${i}, 1.0)`;case 4:return i;default:throw new Error(`invalid channels: ${e}`)}}class jz{constructor(){pe(this,"stats",new Map)}getStats(e){return this.get(e)}get(e){return this.stats.has(e)||this.stats.set(e,new p0({id:e})),this.stats.get(e)}}const iR=new jz,Gt=new Bm({id:"luma.gl"}),Nx={};function _0(i="id"){Nx[i]=Nx[i]||1;const e=Nx[i]++;return`${i}-${e}`}var a1;let Er=(a1=class{constructor(e,t,r){pe(this,"id");pe(this,"props");pe(this,"userData",{});pe(this,"_device");pe(this,"destroyed",!1);pe(this,"allocatedBytes",0);pe(this,"_attachedResources",new Set);if(!e)throw new Error("no device");this._device=e,this.props=Hz(t,r);const a=this.props.id!=="undefined"?this.props.id:_0(this[Symbol.toStringTag]);this.props.id=a,this.id=a,this.userData=this.props.userData||{},this.addStats()}toString(){return`${this[Symbol.toStringTag]||this.constructor.name}:"${this.id}"`}destroy(){this.destroyResource()}delete(){return this.destroy(),this}getProps(){return this.props}attachResource(e){this._attachedResources.add(e)}detachResource(e){this._attachedResources.delete(e)}destroyAttachedResource(e){this._attachedResources.delete(e)&&e.destroy()}destroyAttachedResources(){for(const e of Object.values(this._attachedResources))e.destroy();this._attachedResources=new Set}destroyResource(){this.destroyAttachedResources(),this.removeStats(),this.destroyed=!0}removeStats(){const e=this._device.statsManager.getStats("Resource Counts"),t=this[Symbol.toStringTag];e.get(`${t}s Active`).decrementCount()}trackAllocatedMemory(e,t=this[Symbol.toStringTag]){const r=this._device.statsManager.getStats("Resource Counts");r.get("GPU Memory").addCount(e),r.get(`${t} Memory`).addCount(e),this.allocatedBytes=e}trackDeallocatedMemory(e=this[Symbol.toStringTag]){const t=this._device.statsManager.getStats("Resource Counts");t.get("GPU Memory").subtractCount(this.allocatedBytes),t.get(`${e} Memory`).subtractCount(this.allocatedBytes),this.allocatedBytes=0}addStats(){const e=this._device.statsManager.getStats("Resource Counts"),t=this[Symbol.toStringTag];e.get("Resources Created").incrementCount(),e.get(`${t}s Created`).incrementCount(),e.get(`${t}s Active`).incrementCount()}},pe(a1,"defaultProps",{id:"undefined",handle:void 0,userData:void 0}),a1);function Hz(i,e){const t={...e};for(const r in i)i[r]!==void 0&&(t[r]=i[r]);return t}const Gn=class Gn extends Er{constructor(t,r){const a={...r};(r.usage||0)&Gn.INDEX&&!r.indexType&&(r.data instanceof Uint32Array?a.indexType="uint32":r.data instanceof Uint16Array&&(a.indexType="uint16")),delete a.data;super(t,a,Gn.defaultProps);pe(this,"usage");pe(this,"indexType");pe(this,"updateTimestamp");pe(this,"debugData",new ArrayBuffer(0));this.usage=a.usage||0,this.indexType=a.indexType,this.updateTimestamp=t.incrementTimestamp()}get[Symbol.toStringTag](){return"Buffer"}clone(t){return this.device.createBuffer({...this.props,...t})}readSyncWebGL(t,r){throw new Error("not implemented")}_setDebugData(t,r,a){const h=ArrayBuffer.isView(t)?t.buffer:t,y=Math.min(t?t.byteLength:a,Gn.DEBUG_DATA_MAX_LENGTH);h===null?this.debugData=new ArrayBuffer(y):r===0&&a===h.byteLength?this.debugData=h.slice(0,y):this.debugData=h.slice(r,r+y)}};pe(Gn,"defaultProps",{...Er.defaultProps,usage:0,byteLength:0,byteOffset:0,data:null,indexType:"uint16",mappedAtCreation:!1}),pe(Gn,"MAP_READ",1),pe(Gn,"MAP_WRITE",2),pe(Gn,"COPY_SRC",4),pe(Gn,"COPY_DST",8),pe(Gn,"INDEX",16),pe(Gn,"VERTEX",32),pe(Gn,"UNIFORM",64),pe(Gn,"STORAGE",128),pe(Gn,"INDIRECT",256),pe(Gn,"QUERY_RESOLVE",512),pe(Gn,"DEBUG_DATA_MAX_LENGTH",32);let Gr=Gn;function rR(i){const e=HS[i],t=Gz(e),r=i.includes("norm"),a=!r&&!i.startsWith("float"),h=i.startsWith("s");return{dataType:HS[i],byteLength:t,integer:a,signed:h,normalized:r}}function Gz(i){return $z[i]}const HS={uint8:"uint8",sint8:"sint8",unorm8:"uint8",snorm8:"sint8",uint16:"uint16",sint16:"sint16",unorm16:"uint16",snorm16:"sint16",float16:"float16",float32:"float32",uint32:"uint32",sint32:"sint32"},$z={uint8:1,sint8:1,uint16:2,sint16:2,float16:2,float32:4,uint32:4,sint32:4},rs="texture-compression-bc",Tr="texture-compression-astc",pa="texture-compression-etc2",Wz="texture-compression-etc1-webgl",wg="texture-compression-pvrtc-webgl",zx="texture-compression-atc-webgl",Ag="float32-renderable-webgl",Ux="float16-renderable-webgl",qz="rgb9e5ufloat-renderable-webgl",Vx="snorm8-renderable-webgl",Fp="norm16-renderable-webgl",jx="snorm16-renderable-webgl",Tg="float32-filterable",GS="float16-filterable-webgl";function nR(i){const e=Xz[i];if(!e)throw new Error(`Unsupported texture format ${i}`);return e}const Xz={r8unorm:{},r8snorm:{render:Vx},r8uint:{},r8sint:{},rg8unorm:{},rg8snorm:{render:Vx},rg8uint:{},rg8sint:{},r16uint:{},r16sint:{},r16float:{render:Ux,filter:"float16-filterable-webgl"},"r16unorm-webgl":{f:Fp},"r16snorm-webgl":{f:jx},"rgba4unorm-webgl":{channels:"rgba",bitsPerChannel:[4,4,4,4],packed:!0},"rgb565unorm-webgl":{channels:"rgb",bitsPerChannel:[5,6,5,0],packed:!0},"rgb5a1unorm-webgl":{channels:"rgba",bitsPerChannel:[5,5,5,1],packed:!0},"rgb8unorm-webgl":{},"rgb8snorm-webgl":{},rgba8unorm:{},"rgba8unorm-srgb":{},rgba8snorm:{render:Vx},rgba8uint:{},rgba8sint:{},bgra8unorm:{},"bgra8unorm-srgb":{},rg16uint:{},rg16sint:{},rg16float:{render:Ux,filter:GS},"rg16unorm-webgl":{render:Fp},"rg16snorm-webgl":{render:jx},r32uint:{},r32sint:{},r32float:{render:Ag,filter:Tg},rgb9e5ufloat:{channels:"rgb",packed:!0,render:qz},rg11b10ufloat:{channels:"rgb",bitsPerChannel:[11,11,10,0],packed:!0,p:1,render:Ag},rgb10a2unorm:{channels:"rgba",bitsPerChannel:[10,10,10,2],packed:!0,p:1},"rgb10a2uint-webgl":{channels:"rgba",bitsPerChannel:[10,10,10,2],packed:!0,p:1,wgpu:!1},"rgb16unorm-webgl":{f:Fp},"rgb16snorm-webgl":{f:Fp},rg32uint:{},rg32sint:{},rg32float:{render:!1,filter:Tg},rgba16uint:{},rgba16sint:{},rgba16float:{render:Ux,filter:GS},"rgba16unorm-webgl":{render:Fp},"rgba16snorm-webgl":{render:jx},"rgb32float-webgl":{render:Ag,filter:Tg},rgba32uint:{},rgba32sint:{},rgba32float:{render:Ag,filter:Tg},stencil8:{attachment:"stencil",bitsPerChannel:[8,0,0,0],dataType:"uint8"},depth16unorm:{attachment:"depth",bitsPerChannel:[16,0,0,0],dataType:"uint16"},depth24plus:{attachment:"depth",bitsPerChannel:[24,0,0,0],dataType:"uint32"},depth32float:{attachment:"depth",bitsPerChannel:[32,0,0,0],dataType:"float32"},"depth24plus-stencil8":{attachment:"depth-stencil",bitsPerChannel:[24,8,0,0],packed:!0},"depth32float-stencil8":{attachment:"depth-stencil",bitsPerChannel:[32,8,0,0],packed:!0},"bc1-rgb-unorm-webgl":{f:rs},"bc1-rgb-unorm-srgb-webgl":{f:rs},"bc1-rgba-unorm":{f:rs},"bc1-rgba-unorm-srgb":{f:rs},"bc2-rgba-unorm":{f:rs},"bc2-rgba-unorm-srgb":{f:rs},"bc3-rgba-unorm":{f:rs},"bc3-rgba-unorm-srgb":{f:rs},"bc4-r-unorm":{f:rs},"bc4-r-snorm":{f:rs},"bc5-rg-unorm":{f:rs},"bc5-rg-snorm":{f:rs},"bc6h-rgb-ufloat":{f:rs},"bc6h-rgb-float":{f:rs},"bc7-rgba-unorm":{f:rs},"bc7-rgba-unorm-srgb":{f:rs},"etc2-rgb8unorm":{f:pa},"etc2-rgb8unorm-srgb":{f:pa},"etc2-rgb8a1unorm":{f:pa},"etc2-rgb8a1unorm-srgb":{f:pa},"etc2-rgba8unorm":{f:pa},"etc2-rgba8unorm-srgb":{f:pa},"eac-r11unorm":{f:pa},"eac-r11snorm":{f:pa},"eac-rg11unorm":{f:pa},"eac-rg11snorm":{f:pa},"astc-4x4-unorm":{f:Tr},"astc-4x4-unorm-srgb":{f:Tr},"astc-5x4-unorm":{f:Tr},"astc-5x4-unorm-srgb":{f:Tr},"astc-5x5-unorm":{f:Tr},"astc-5x5-unorm-srgb":{f:Tr},"astc-6x5-unorm":{f:Tr},"astc-6x5-unorm-srgb":{f:Tr},"astc-6x6-unorm":{f:Tr},"astc-6x6-unorm-srgb":{f:Tr},"astc-8x5-unorm":{f:Tr},"astc-8x5-unorm-srgb":{f:Tr},"astc-8x6-unorm":{f:Tr},"astc-8x6-unorm-srgb":{f:Tr},"astc-8x8-unorm":{f:Tr},"astc-8x8-unorm-srgb":{f:Tr},"astc-10x5-unorm":{f:Tr},"astc-10x5-unorm-srgb":{f:Tr},"astc-10x6-unorm":{f:Tr},"astc-10x6-unorm-srgb":{f:Tr},"astc-10x8-unorm":{f:Tr},"astc-10x8-unorm-srgb":{f:Tr},"astc-10x10-unorm":{f:Tr},"astc-10x10-unorm-srgb":{f:Tr},"astc-12x10-unorm":{f:Tr},"astc-12x10-unorm-srgb":{f:Tr},"astc-12x12-unorm":{f:Tr},"astc-12x12-unorm-srgb":{f:Tr},"pvrtc-rgb4unorm-webgl":{f:wg},"pvrtc-rgba4unorm-webgl":{f:wg},"pvrtc-rbg2unorm-webgl":{f:wg},"pvrtc-rgba2unorm-webgl":{f:wg},"etc1-rbg-unorm-webgl":{f:Wz},"atc-rgb-unorm-webgl":{f:zx},"atc-rgba-unorm-webgl":{f:zx},"atc-rgbai-unorm-webgl":{f:zx}},Zz=["bc1","bc2","bc3","bc4","bc5","bc6","bc7","etc1","etc2","eac","atc","astc","pvrtc"],Yz=/^(r|rg|rgb|rgba|bgra)([0-9]*)([a-z]*)(-srgb)?(-webgl)?$/;function sR(i){return Zz.some(e=>i.startsWith(e))}function Hw(i){let e=Kz(i);if(sR(i)){e.channels="rgb",e.components=3,e.bytesPerPixel=1,e.srgb=!1,e.compressed=!0;const r=Jz(i);r&&(e.blockWidth=r.blockWidth,e.blockHeight=r.blockHeight)}const t=Yz.exec(i);if(t){const[,r,a,h,y,s]=t,T=`${h}${a}`,B=rR(T),F=B.byteLength*8,V=r.length,X=[F,V>=2?F:0,V>=3?F:0,V>=4?F:0];e={format:i,attachment:e.attachment,dataType:B.dataType,components:V,channels:r,integer:B.integer,signed:B.signed,normalized:B.normalized,bitsPerChannel:X,bytesPerPixel:B.byteLength*r.length,packed:e.packed,srgb:e.srgb},s==="-webgl"&&(e.webgl=!0),y==="-srgb"&&(e.srgb=!0)}return i.endsWith("-webgl")&&(e.webgl=!0),i.endsWith("-srgb")&&(e.srgb=!0),e}function Kz(i){var h;const e=nR(i),t=e.bytesPerPixel||1,r=e.bitsPerChannel||[8,8,8,8];return delete e.bitsPerChannel,delete e.bytesPerPixel,delete e.f,delete e.render,delete e.filter,delete e.blend,delete e.store,{...e,format:i,attachment:e.attachment||"color",channels:e.channels||"r",components:e.components||((h=e.channels)==null?void 0:h.length)||1,bytesPerPixel:t,bitsPerChannel:r,dataType:e.dataType||"uint8",srgb:e.srgb??!1,packed:e.packed??!1,webgl:e.webgl??!1,integer:e.integer??!1,signed:e.signed??!1,normalized:e.normalized??!1,compressed:e.compressed??!1}}function Jz(i){const t=/.*-(\d+)x(\d+)-.*/.exec(i);if(t){const[,r,a]=t;return{blockWidth:Number(r),blockHeight:Number(a)}}return null}function Qz(i){const e=nR(i),t={format:i,create:e.f??!0,render:e.render??!0,filter:e.filter??!0,blend:e.blend??!0,store:e.store??!0},r=Hw(i),a=i.startsWith("depth")||i.startsWith("stencil"),h=r==null?void 0:r.signed,y=r==null?void 0:r.integer,s=r==null?void 0:r.webgl;return t.render&&(t.render=!h),t.filter&&(t.filter=!a&&!h&&!y&&!s),t}class e5{}class t5{constructor(e=[],t){pe(this,"features");pe(this,"disabledFeatures");this.features=new Set(e),this.disabledFeatures=t||{}}*[Symbol.iterator](){yield*this.features}has(e){var t;return!((t=this.disabledFeatures)!=null&&t[e])&&this.features.has(e)}}const Hy=class Hy{constructor(e){pe(this,"id");pe(this,"props");pe(this,"userData",{});pe(this,"statsManager",iR);pe(this,"timestamp",0);pe(this,"_reused",!1);pe(this,"_lumaData",{});this.props={...Hy.defaultProps,...e},this.id=this.props.id||_0(this[Symbol.toStringTag].toLowerCase())}get[Symbol.toStringTag](){return"Device"}getTextureFormatCapabilities(e){const t=Qz(e),r=y=>(typeof y=="string"?this.features.has(y):y)??!0,a=r(t.create),h={format:e,create:a,render:a&&r(t.render),filter:a&&r(t.filter),blend:a&&r(t.blend),store:a&&r(t.store)};return this._getDeviceSpecificTextureFormatCapabilities(h)}isTextureFormatSupported(e,t){return this.getTextureFormatCapabilities(e).create}isTextureFormatFilterable(e){return this.getTextureFormatCapabilities(e).filter}isTextureFormatRenderable(e){return this.getTextureFormatCapabilities(e).render}isTextureFormatCompressed(e){return sR(e)}loseDevice(){return!1}reportError(e){this.props.onError(e)}getDefaultCanvasContext(){if(!this.canvasContext)throw new Error("Device has no default CanvasContext. See props.createCanvasContext");return this.canvasContext}createCommandEncoder(e={}){throw new Error("not implemented")}incrementTimestamp(){return this.timestamp++}onError(e){this.props.onError(e)}getCanvasContext(){return this.getDefaultCanvasContext()}readPixelsToArrayWebGL(e,t){throw new Error("not implemented")}readPixelsToBufferWebGL(e,t){throw new Error("not implemented")}setParametersWebGL(e){throw new Error("not implemented")}getParametersWebGL(e){throw new Error("not implemented")}withParametersWebGL(e,t){throw new Error("not implemented")}clearWebGL(e){throw new Error("not implemented")}resetWebGL(){throw new Error("not implemented")}static _getCanvasContextProps(e){return e.createCanvasContext===!0?{}:e.createCanvasContext}_normalizeBufferProps(e){(e instanceof ArrayBuffer||ArrayBuffer.isView(e))&&(e={data:e});const t={...e};return(e.usage||0)&Gr.INDEX&&!e.indexType&&(e.data instanceof Uint32Array?t.indexType="uint32":e.data instanceof Uint16Array?t.indexType="uint16":Gt.warn("indices buffer content must be of integer type")()),t}};pe(Hy,"defaultProps",{id:null,powerPreference:"high-performance",failIfMajorPerformanceCaveat:!1,createCanvasContext:void 0,onError:e=>Gt.error(e.message)(),_reuseDevices:!1,_requestMaxLimits:!0,_factoryDestroyPolicy:"unused",_initializeFeatures:!0,_disabledFeatures:{"compilation-status-async-webgl":!0},_resourceDefaults:{},webgl:{},debug:Gt.get("debug")||void 0,debugShaders:Gt.get("debug-shaders")||void 0,debugFramebuffers:!!Gt.get("debug-framebuffers"),debugWebGL:!!Gt.get("debug-webgl"),debugSpectorJS:void 0,debugSpectorJSUrl:void 0,_handle:void 0});let oc=Hy;const i5=Du()&&typeof document<"u",r5=()=>i5&&document.readyState==="complete",n5="set luma.log.level=1 (or higher) to trace rendering",$S="No matching device found. Ensure `@luma.gl/webgl` and/or `@luma.gl/webgpu` modules are imported.",Ql=class Ql{constructor(){pe(this,"stats",iR);pe(this,"log",Gt);pe(this,"VERSION","9.1.5");pe(this,"spector");pe(this,"preregisteredAdapters",new Map);if(globalThis.luma){if(globalThis.luma.VERSION!==this.VERSION)throw Gt.error(`Found luma.gl ${globalThis.luma.VERSION} while initialzing ${this.VERSION}`)(),Gt.error("'yarn why @luma.gl/core' can help identify the source of the conflict")(),new Error("luma.gl - multiple versions detected: see console log");Gt.error("This version of luma.gl has already been initialized")()}Gt.log(1,`${this.VERSION} - ${n5}`)(),globalThis.luma=this}registerAdapters(e){for(const t of e)this.preregisteredAdapters.set(t.type,t)}getSupportedAdapters(e=[]){const t=this.getAdapterMap(e);return Array.from(t).map(([,r])=>r).filter(r=>{var a;return(a=r.isSupported)==null?void 0:a.call(r)}).map(r=>r.type)}getBestAvailableAdapter(e=[]){var r,a,h,y;const t=this.getAdapterMap(e);return(a=(r=t.get("webgpu"))==null?void 0:r.isSupported)!=null&&a.call(r)?"webgpu":(y=(h=t.get("webgl"))==null?void 0:h.isSupported)!=null&&y.call(h)?"webgl":null}setDefaultDeviceProps(e){Object.assign(Ql.defaultProps,e)}async createDevice(e={}){var s;e={...Ql.defaultProps,...e},e.waitForPageLoad&&await Ql.pageLoaded;const t=this.getAdapterMap(e.adapters);let r=e.type||"";r==="best-available"&&(r=this.getBestAvailableAdapter(e.adapters)||r);const h=(this.getAdapterMap(e.adapters)||t).get(r),y=await((s=h==null?void 0:h.create)==null?void 0:s.call(h,e));if(y)return y;throw new Error($S)}async attachDevice(e){var y;const t=this.getAdapterMap(e.adapters);let r="";e.handle instanceof WebGL2RenderingContext&&(r="webgl"),e.createCanvasContext&&await Ql.pageLoaded,e.handle===null&&(r="unknown");const a=t.get(r),h=await((y=a==null?void 0:a.attach)==null?void 0:y.call(a,null));if(h)return h;throw new Error($S)}enforceWebGL2(e=!0,t=[]){var h;const a=this.getAdapterMap(t).get("webgl");a||Gt.warn("enforceWebGL2: webgl adapter not found")(),(h=a==null?void 0:a.enforceWebGL2)==null||h.call(a,e)}getAdapterMap(e=[]){const t=new Map(this.preregisteredAdapters);for(const r of e)t.set(r.type,r);return t}registerDevices(e){Gt.warn("luma.registerDevices() is deprecated, use luma.registerAdapters() instead");for(const t of e){const r=t.adapter;r&&this.preregisteredAdapters.set(r.type,r)}}};pe(Ql,"defaultProps",{...oc.defaultProps,type:"best-available",adapters:void 0,waitForPageLoad:!0}),pe(Ql,"pageLoaded",s5().then(()=>{Gt.probe(2,"DOM is loaded")()}));let C1=Ql;const M1=new C1;function s5(){return r5()||typeof window>"u"?Promise.resolve():new Promise(i=>{window.addEventListener("load",()=>i())})}class o5{}const Gy=class Gy{constructor(e){pe(this,"id");pe(this,"props");pe(this,"canvas");pe(this,"htmlCanvas");pe(this,"offscreenCanvas");pe(this,"type");pe(this,"width",1);pe(this,"height",1);pe(this,"resizeObserver");pe(this,"_canvasSizeInfo",{clientWidth:0,clientHeight:0,devicePixelRatio:1});if(this.props={...Gy.defaultProps,...e},e=this.props,!Du()){this.id="node-canvas-context",this.type="node",this.width=this.props.width,this.height=this.props.height,this.canvas=null;return}if(e.canvas)typeof e.canvas=="string"?this.canvas=l5(e.canvas):this.canvas=e.canvas;else{const t=c5(e),r=a5((e==null?void 0:e.container)||null);r.insertBefore(t,r.firstChild),this.canvas=t,e!=null&&e.visible||(this.canvas.style.visibility="hidden")}this.canvas instanceof HTMLCanvasElement?(this.id=this.canvas.id,this.type="html-canvas",this.htmlCanvas=this.canvas):(this.id="offscreen-canvas",this.type="offscreen-canvas",this.offscreenCanvas=this.canvas),this.canvas instanceof HTMLCanvasElement&&e.autoResize&&(this.resizeObserver=new ResizeObserver(t=>{for(const r of t)r.target===this.canvas&&this.update()}),this.resizeObserver.observe(this.canvas))}toString(){return`${this[Symbol.toStringTag]}(${this.id})`}getDevicePixelRatio(e){return typeof OffscreenCanvas<"u"&&this.canvas instanceof OffscreenCanvas||(e=e===void 0?this.props.useDevicePixels:e,!e||e<=0)?1:e===!0?typeof window<"u"&&window.devicePixelRatio||1:e}getPixelSize(){switch(this.type){case"node":return[this.width,this.height];case"offscreen-canvas":return[this.canvas.width,this.canvas.height];case"html-canvas":const e=this.getDevicePixelRatio(),t=this.canvas;return t.parentElement?[t.clientWidth*e,t.clientHeight*e]:[this.canvas.width,this.canvas.height];default:throw new Error(this.type)}}getAspect(){const[e,t]=this.getPixelSize();return e/t}cssToDeviceRatio(){var e;try{const[t]=this.getDrawingBufferSize(),r=this._canvasSizeInfo.clientWidth||((e=this.htmlCanvas)==null?void 0:e.clientWidth);return r?t/r:1}catch{return 1}}cssToDevicePixels(e,t=!0){const r=this.cssToDeviceRatio(),[a,h]=this.getDrawingBufferSize();return u5(e,r,a,h,t)}setDevicePixelRatio(e,t={}){if(!this.htmlCanvas)return;let r="width"in t?t.width:this.htmlCanvas.clientWidth,a="height"in t?t.height:this.htmlCanvas.clientHeight;(!r||!a)&&(Gt.log(1,"Canvas clientWidth/clientHeight is 0")(),e=1,r=this.htmlCanvas.width||1,a=this.htmlCanvas.height||1);const h=this._canvasSizeInfo;if(h.clientWidth!==r||h.clientHeight!==a||h.devicePixelRatio!==e){let y=e;const s=Math.floor(r*y),T=Math.floor(a*y);if(this.htmlCanvas.width=s,this.htmlCanvas.height=T,this.device.gl){const[F,V]=this.getDrawingBufferSize();(F!==s||V!==T)&&(y=Math.min(F/r,V/a),this.htmlCanvas.width=Math.floor(r*y),this.htmlCanvas.height=Math.floor(a*y),Gt.warn("Device pixel ratio clamped")()),this._canvasSizeInfo.clientWidth=r,this._canvasSizeInfo.clientHeight=a,this._canvasSizeInfo.devicePixelRatio=e}}}getDrawingBufferSize(){const e=this.device.gl;return e?[e.drawingBufferWidth,e.drawingBufferHeight]:this.getPixelSize()}_setAutoCreatedCanvasId(e){var t;((t=this.htmlCanvas)==null?void 0:t.id)==="lumagl-auto-created-canvas"&&(this.htmlCanvas.id=e)}};pe(Gy,"defaultProps",{canvas:null,width:800,height:600,useDevicePixels:!0,autoResize:!0,container:null,visible:!0,alphaMode:"opaque",colorSpace:"srgb"});let R1=Gy;function a5(i){if(typeof i=="string"){const e=document.getElementById(i);if(!e)throw new Error(`${i} is not an HTML element`);return e}else if(i)return i;return document.body}function l5(i){const e=document.getElementById(i);if(!(e instanceof HTMLCanvasElement))throw new Error("Object is not a canvas element");return e}function c5(i){const{width:e,height:t}=i,r=document.createElement("canvas");return r.id=_0("lumagl-auto-created-canvas"),r.width=e||1,r.height=t||1,r.style.width=Number.isFinite(e)?`${e}px`:"100%",r.style.height=Number.isFinite(t)?`${t}px`:"100%",r}function u5(i,e,t,r,a){const h=i,y=WS(h[0],e,t);let s=qS(h[1],e,r,a),T=WS(h[0]+1,e,t);const B=T===t-1?T:T-1;T=qS(h[1]+1,e,r,a);let F;return a?(T=T===0?T:T+1,F=s,s=T):F=T===r-1?T:T-1,{x:y,y:s,width:Math.max(B-y+1,1),height:Math.max(F-s+1,1)}}function WS(i,e,t){return Math.min(Math.round(i*e),t-1)}function qS(i,e,t,r){return r?Math.max(0,t-1-Math.round(i*e)):Math.min(Math.round(i*e),t-1)}const $n=class $n extends Er{constructor(t,r){r=$n.normalizeProps(t,r);super(t,r,$n.defaultProps);pe(this,"dimension");pe(this,"format");pe(this,"width");pe(this,"height");pe(this,"depth");pe(this,"mipLevels");pe(this,"updateTimestamp");if(this.dimension=this.props.dimension,this.format=this.props.format,this.width=this.props.width,this.height=this.props.height,this.depth=this.props.depth,this.props.width===void 0||this.props.height===void 0){const a=$n.getTextureDataSize(this.props.data);this.width=(a==null?void 0:a.width)||1,this.height=(a==null?void 0:a.height)||1}this.props.mipmaps&&this.props.mipLevels===void 0&&(this.props.mipLevels="pyramid"),this.mipLevels=this.props.mipLevels==="pyramid"?$n.getMipLevelCount(this.width,this.height):this.props.mipLevels||1,this.updateTimestamp=t.incrementTimestamp()}get[Symbol.toStringTag](){return"Texture"}toString(){return`Texture(${this.id},${this.format},${this.width}x${this.height})`}clone(t){return this.device.createTexture({...this.props,...t})}static isExternalImage(t){return typeof ImageData<"u"&&t instanceof ImageData||typeof ImageBitmap<"u"&&t instanceof ImageBitmap||typeof HTMLImageElement<"u"&&t instanceof HTMLImageElement||typeof HTMLVideoElement<"u"&&t instanceof HTMLVideoElement||typeof VideoFrame<"u"&&t instanceof VideoFrame||typeof HTMLCanvasElement<"u"&&t instanceof HTMLCanvasElement||typeof OffscreenCanvas<"u"&&t instanceof OffscreenCanvas}static getExternalImageSize(t){if(typeof ImageData<"u"&&t instanceof ImageData||typeof ImageBitmap<"u"&&t instanceof ImageBitmap||typeof HTMLCanvasElement<"u"&&t instanceof HTMLCanvasElement||typeof OffscreenCanvas<"u"&&t instanceof OffscreenCanvas)return{width:t.width,height:t.height};if(typeof HTMLImageElement<"u"&&t instanceof HTMLImageElement)return{width:t.naturalWidth,height:t.naturalHeight};if(typeof HTMLVideoElement<"u"&&t instanceof HTMLVideoElement)return{width:t.videoWidth,height:t.videoHeight};if(typeof VideoFrame<"u"&&t instanceof VideoFrame)return{width:t.displayWidth,height:t.displayHeight};throw new Error("Unknown image type")}static isTextureLevelData(t){const r=t==null?void 0:t.data;return ArrayBuffer.isView(r)}static getTextureDataSize(t){if(!t||ArrayBuffer.isView(t))return null;if(Array.isArray(t))return $n.getTextureDataSize(t[0]);if($n.isExternalImage(t))return $n.getExternalImageSize(t);if(t&&typeof t=="object"&&t.constructor===Object){const a=Object.values(t)[0];return{width:a.width,height:a.height}}throw new Error("texture size deduction failed")}static normalizeTextureData(t,r){let a;return ArrayBuffer.isView(t)?a=[{data:t,width:r.width,height:r.height}]:Array.isArray(t)?a=t:a=[t],a}static getMipLevelCount(t,r){return Math.floor(Math.log2(Math.max(t,r)))+1}static getCubeFaceDepth(t){switch(t){case"+X":return 0;case"-X":return 1;case"+Y":return 2;case"-Y":return 3;case"+Z":return 4;case"-Z":return 5;default:throw new Error(t)}}static normalizeProps(t,r){var T,B;const a={...r},h=((B=(T=t==null?void 0:t.props)==null?void 0:T._resourceDefaults)==null?void 0:B.texture)||{};Object.assign(a,h);const{width:y,height:s}=a;return typeof y=="number"&&(a.width=Math.max(1,Math.ceil(y))),typeof s=="number"&&(a.height=Math.max(1,Math.ceil(s))),a}};pe($n,"COPY_SRC",1),pe($n,"COPY_DST",2),pe($n,"TEXTURE",4),pe($n,"STORAGE",8),pe($n,"RENDER_ATTACHMENT",16),pe($n,"CubeFaces",["+X","-X","+Y","-Y","+Z","-Z"]),pe($n,"defaultProps",{...Er.defaultProps,data:null,dimension:"2d",format:"rgba8unorm",width:void 0,height:void 0,depth:1,mipmaps:!1,compressed:!1,usage:0,mipLevels:void 0,samples:void 0,sampler:{},view:void 0,flipY:void 0}),pe($n,"defaultCopyExternalImageOptions",{image:void 0,sourceX:0,sourceY:0,width:void 0,height:void 0,depth:1,mipLevel:0,x:0,y:0,z:0,aspect:"all",colorSpace:"srgb",premultipliedAlpha:!1,flipY:!1});let en=$n;const $y=class $y extends Er{get[Symbol.toStringTag](){return"TextureView"}constructor(e,t){super(e,t,$y.defaultProps)}};pe($y,"defaultProps",{...Er.defaultProps,format:void 0,dimension:void 0,aspect:"all",baseMipLevel:0,mipLevelCount:void 0,baseArrayLayer:0,arrayLayerCount:void 0});let gy=$y;function h5(i,e,t){let r="";const a=e.split(/\r?\n/),h=i.slice().sort((y,s)=>y.lineNum-s.lineNum);switch((t==null?void 0:t.showSourceCode)||"no"){case"all":let y=0;for(let s=1;s<=a.length;s++)for(r+=oR(a[s-1],s,t);h.length>y&&h[y].lineNum===s;){const T=h[y++];r+=XS(T,a,T.lineNum,{...t,inlineSource:!1})}return r;case"issues":case"no":for(const s of i)r+=XS(s,a,s.lineNum,{inlineSource:(t==null?void 0:t.showSourceCode)!=="no"});return r}}function XS(i,e,t,r){if(r!=null&&r.inlineSource){const h=d5(e,t),y=i.linePos>0?`${" ".repeat(i.linePos+5)}^^^
`:"";return`
${h}${y}${i.type.toUpperCase()}: ${i.message}

`}const a=i.type==="error"?"red":"#8B4000";return r!=null&&r.html?`<div class='luma-compiler-log-error' style="color:${a};"><b> ${i.type.toUpperCase()}: ${i.message}</b></div>`:`${i.type.toUpperCase()}: ${i.message}`}function d5(i,e,t){let r="";for(let a=e-2;a<=e;a++){const h=i[a-1];h!==void 0&&(r+=oR(h,e,t))}return r}function oR(i,e,t){const r=t!=null&&t.html?p5(i):i;return`${f5(String(e),4)}: ${r}${t!=null&&t.html?"<br/>":`
`}`}function f5(i,e){let t="";for(let r=i.length;r<e;++r)t+=" ";return t+i}function p5(i){return i.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}const Wy=class Wy extends Er{constructor(t,r){r={...r,debugShaders:r.debugShaders||t.props.debugShaders||"errors"};super(t,{id:m5(r),...r},Wy.defaultProps);pe(this,"stage");pe(this,"source");pe(this,"compilationStatus","pending");this.stage=this.props.stage,this.source=this.props.source}get[Symbol.toStringTag](){return"Shader"}getCompilationInfoSync(){return null}getTranslatedSource(){return null}async debugShader(){const t=this.props.debugShaders;switch(t){case"never":return;case"errors":if(this.compilationStatus==="success")return;break}const r=await this.getCompilationInfo();t==="warnings"&&(r==null?void 0:r.length)===0||this._displayShaderLog(r)}_displayShaderLog(t){var B;if(typeof document>"u"||!(document!=null&&document.createElement))return;const r=aR(this.source),a=`${this.stage} ${r}`;let h=h5(t,this.source,{showSourceCode:"all",html:!0});const y=this.getTranslatedSource();y&&(h+=`<br /><br /><h1>Translated Source</h1><br /><br /><code style="user-select:text;"><pre>${y}</pre></code>`);const s=document.createElement("Button");s.innerHTML=`
<h1>Shader Compilation Error in ${a}</h1><br /><br />
<code style="user-select:text;"><pre>
${h}
</pre></code>`,s.style.top="10px",s.style.left="10px",s.style.position="absolute",s.style.zIndex="9999",s.style.width="100%",s.style.textAlign="left",document.body.appendChild(s),(B=document.getElementsByClassName("luma-compiler-log-error")[0])==null||B.scrollIntoView(),s.onclick=()=>{const F=`data:text/plain,${encodeURIComponent(this.source)}`;navigator.clipboard.writeText(F)}}};pe(Wy,"defaultProps",{...Er.defaultProps,language:"auto",stage:void 0,source:"",sourceMap:null,entryPoint:"main",debugShaders:void 0});let yy=Wy;function m5(i){return aR(i.source)||i.id||_0(`unnamed ${i.stage}-shader`)}function aR(i,e="unnamed"){const r=/#define[\s*]SHADER_NAME[\s*]([A-Za-z0-9_-]+)[\s*]/.exec(i);return r?r[1]:e}const om=class om extends Er{get[Symbol.toStringTag](){return"Sampler"}constructor(e,t){t=om.normalizeProps(e,t),super(e,t,om.defaultProps)}static normalizeProps(e,t){var h,y;const r=((y=(h=e==null?void 0:e.props)==null?void 0:h._resourceDefaults)==null?void 0:y.sampler)||{};return{...t,...r}}};pe(om,"defaultProps",{...Er.defaultProps,type:"color-sampler",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge",addressModeW:"clamp-to-edge",magFilter:"nearest",minFilter:"nearest",mipmapFilter:"none",lodMinClamp:0,lodMaxClamp:32,compare:"less-equal",maxAnisotropy:1});let vy=om;const qy=class qy extends Er{constructor(t,r={}){super(t,r,qy.defaultProps);pe(this,"width");pe(this,"height");this.width=this.props.width,this.height=this.props.height}get[Symbol.toStringTag](){return"Framebuffer"}clone(t){const r=this.colorAttachments.map(h=>h.texture.clone(t)),a=this.depthStencilAttachment&&this.depthStencilAttachment.texture.clone(t);return this.device.createFramebuffer({...this.props,colorAttachments:r,depthStencilAttachment:a})}resize(t){let r=!t;if(t){const[a,h]=Array.isArray(t)?t:[t.width,t.height];r=r||h!==this.height||a!==this.width,this.width=a,this.height=h}r&&(Gt.log(2,`Resizing framebuffer ${this.id} to ${this.width}x${this.height}`)(),this.resizeAttachments(this.width,this.height))}autoCreateAttachmentTextures(){if(this.props.colorAttachments.length===0&&!this.props.depthStencilAttachment)throw new Error("Framebuffer has noattachments");this.colorAttachments=this.props.colorAttachments.map((r,a)=>{if(typeof r=="string"){const h=this.createColorTexture(r,a);return this.attachResource(h),h.view}return r instanceof en?r.view:r});const t=this.props.depthStencilAttachment;if(t)if(typeof t=="string"){const r=this.createDepthStencilTexture(t);this.attachResource(r),this.depthStencilAttachment=r.view}else t instanceof en?this.depthStencilAttachment=t.view:this.depthStencilAttachment=t}createColorTexture(t,r){return this.device.createTexture({id:`${this.id}-color-attachment-${r}`,usage:en.RENDER_ATTACHMENT,format:t,width:this.width,height:this.height,sampler:{magFilter:"linear",minFilter:"linear"}})}createDepthStencilTexture(t){return this.device.createTexture({id:`${this.id}-depth-stencil-attachment`,usage:en.RENDER_ATTACHMENT,format:t,width:this.width,height:this.height,mipmaps:!1})}resizeAttachments(t,r){for(let a=0;a<this.colorAttachments.length;++a)if(this.colorAttachments[a]){const h=this.colorAttachments[a].texture.clone({width:t,height:r});this.destroyAttachedResource(this.colorAttachments[a]),this.colorAttachments[a]=h.view,this.attachResource(h.view)}if(this.depthStencilAttachment){const a=this.depthStencilAttachment.texture.clone({width:t,height:r});this.destroyAttachedResource(this.depthStencilAttachment),this.depthStencilAttachment=a.view,this.attachResource(a)}this.updateAttachments()}};pe(qy,"defaultProps",{...Er.defaultProps,width:1,height:1,colorAttachments:[],depthStencilAttachment:null});let xy=qy;const Xy=class Xy extends Er{constructor(t,r){super(t,r,Xy.defaultProps);pe(this,"shaderLayout");pe(this,"bufferLayout");pe(this,"linkStatus","pending");pe(this,"hash","");this.shaderLayout=this.props.shaderLayout,this.bufferLayout=this.props.bufferLayout||[]}get[Symbol.toStringTag](){return"RenderPipeline"}setUniformsWebGL(t){throw new Error("Use uniform blocks")}};pe(Xy,"defaultProps",{...Er.defaultProps,vs:null,vertexEntryPoint:"vertexMain",vsConstants:{},fs:null,fragmentEntryPoint:"fragmentMain",fsConstants:{},shaderLayout:null,bufferLayout:[],topology:"triangle-list",parameters:{},bindings:{},uniforms:{}});let xd=Xy;const Go=class Go extends Er{get[Symbol.toStringTag](){return"RenderPass"}constructor(e,t){t=Go.normalizeProps(e,t),super(e,t,Go.defaultProps)}static normalizeProps(e,t){var h;return{...(h=e.props._resourceDefaults)==null?void 0:h.renderPass,...t}}};pe(Go,"defaultClearColor",[0,0,0,1]),pe(Go,"defaultClearDepth",1),pe(Go,"defaultClearStencil",0),pe(Go,"defaultProps",{...Er.defaultProps,framebuffer:null,parameters:void 0,clearColor:Go.defaultClearColor,clearColors:void 0,clearDepth:Go.defaultClearDepth,clearStencil:Go.defaultClearStencil,depthReadOnly:!1,stencilReadOnly:!1,discard:!1,occlusionQuerySet:void 0,timestampQuerySet:void 0,beginTimestampIndex:void 0,endTimestampIndex:void 0});let P1=Go;const Zy=class Zy extends Er{constructor(t,r){super(t,r,Zy.defaultProps);pe(this,"hash","");pe(this,"shaderLayout");this.shaderLayout=r.shaderLayout}get[Symbol.toStringTag](){return"ComputePipeline"}};pe(Zy,"defaultProps",{...Er.defaultProps,shader:void 0,entryPoint:void 0,constants:{},shaderLayout:void 0});let by=Zy;const Yy=class Yy extends Er{get[Symbol.toStringTag](){return"CommandEncoder"}constructor(e,t){super(e,t,Yy.defaultProps)}};pe(Yy,"defaultProps",{...Er.defaultProps,measureExecutionTime:void 0});let B1=Yy;const Ky=class Ky extends Er{get[Symbol.toStringTag](){return"CommandBuffer"}constructor(e,t){super(e,t,Ky.defaultProps)}};pe(Ky,"defaultProps",{...Er.defaultProps});let D1=Ky;function _5(i){const[e,t]=y5[i],r=e==="i32"||e==="u32",a=e!=="u32",h=v5[e]*t,y=g5(e,t);return{dataType:e,components:t,defaultVertexFormat:y,byteLength:h,integer:r,signed:a}}function g5(i,e){let t;switch(i){case"f32":t="float32";break;case"i32":t="sint32";break;case"u32":t="uint32";break;case"f16":return e<=2?"float16x2":"float16x4"}return e===1?t:`${t}x${e}`}const y5={f32:["f32",1],"vec2<f32>":["f32",2],"vec3<f32>":["f32",3],"vec4<f32>":["f32",4],f16:["f16",1],"vec2<f16>":["f16",2],"vec3<f16>":["f16",3],"vec4<f16>":["f16",4],i32:["i32",1],"vec2<i32>":["i32",2],"vec3<i32>":["i32",3],"vec4<i32>":["i32",4],u32:["u32",1],"vec2<u32>":["u32",2],"vec3<u32>":["u32",3],"vec4<u32>":["u32",4]},v5={f32:4,f16:2,i32:4,u32:4};function lR(i){let e;i.endsWith("-webgl")&&(i.replace("-webgl",""),e=!0);const[t,r]=i.split("x"),a=t,h=r?parseInt(r):1,y=rR(a),s={type:a,components:h,byteLength:y.byteLength*h,integer:y.integer,signed:y.signed,normalized:y.normalized};return e&&(s.webglOnly=!0),s}function cR(i,e){const t={};for(const r of i.attributes){const a=b5(i,e,r.name);a&&(t[r.name]=a)}return t}function x5(i,e,t=16){const r=cR(i,e),a=new Array(t).fill(null);for(const h of Object.values(r))a[h.location]=h;return a}function b5(i,e,t){const r=w5(i,t),a=A5(e,t);if(!r)return null;const h=_5(r.type),y=(a==null?void 0:a.vertexFormat)||h.defaultVertexFormat,s=lR(y);return{attributeName:(a==null?void 0:a.attributeName)||r.name,bufferName:(a==null?void 0:a.bufferName)||r.name,location:r.location,shaderType:r.type,shaderDataType:h.dataType,shaderComponents:h.components,vertexFormat:y,bufferDataType:s.type,bufferComponents:s.components,normalized:s.normalized,integer:h.integer,stepMode:(a==null?void 0:a.stepMode)||r.stepMode||"vertex",byteOffset:(a==null?void 0:a.byteOffset)||0,byteStride:(a==null?void 0:a.byteStride)||0}}function w5(i,e){const t=i.attributes.find(r=>r.name===e);return t||Gt.warn(`shader layout attribute "${e}" not present in shader`),t||null}function A5(i,e){T5(i);let t=E5(i,e);return t||(t=S5(i,e),t)?t:(Gt.warn(`layout for attribute "${e}" not present in buffer layout`),null)}function T5(i){for(const e of i)(e.attributes&&e.format||!e.attributes&&!e.format)&&Gt.warn(`BufferLayout ${name} must have either 'attributes' or 'format' field`)}function E5(i,e){for(const t of i)if(t.format&&t.name===e)return{attributeName:t.name,bufferName:e,stepMode:t.stepMode,vertexFormat:t.format,byteOffset:0,byteStride:t.byteStride||0};return null}function S5(i,e){var t;for(const r of i){let a=r.byteStride;if(typeof r.byteStride!="number")for(const y of r.attributes||[]){const s=lR(y.format);a+=s.byteLength}const h=(t=r.attributes)==null?void 0:t.find(y=>y.attribute===e);if(h)return{attributeName:h.attribute,bufferName:r.name,stepMode:r.stepMode,vertexFormat:h.format,byteOffset:h.byteOffset,byteStride:a}}return null}const Jy=class Jy extends Er{constructor(t,r){super(t,r,Jy.defaultProps);pe(this,"maxVertexAttributes");pe(this,"attributeInfos");pe(this,"indexBuffer",null);pe(this,"attributes");this.maxVertexAttributes=t.limits.maxVertexAttributes,this.attributes=new Array(this.maxVertexAttributes).fill(null);const{shaderLayout:a,bufferLayout:h}=r.renderPipeline||{};if(!a||!h)throw new Error("VertexArray");this.attributeInfos=x5(a,h,this.maxVertexAttributes)}get[Symbol.toStringTag](){return"VertexArray"}setConstantWebGL(t,r){this.device.reportError(new Error("constant attributes not supported"))}};pe(Jy,"defaultProps",{...Er.defaultProps,renderPipeline:null});let O1=Jy;const Qy=class Qy extends Er{get[Symbol.toStringTag](){return"TransformFeedback"}constructor(e,t){super(e,t,Qy.defaultProps)}};pe(Qy,"defaultProps",{...Er.defaultProps,layout:void 0,buffers:{}});let F1=Qy;const e0=class e0 extends Er{get[Symbol.toStringTag](){return"QuerySet"}constructor(e,t){super(e,t,e0.defaultProps)}};pe(e0,"defaultProps",{...Er.defaultProps,type:void 0,count:void 0});let k1=e0;const I5={f32:{type:"f32",components:1},i32:{type:"i32",components:1},u32:{type:"u32",components:1},"vec2<f32>":{type:"f32",components:2},"vec3<f32>":{type:"f32",components:3},"vec4<f32>":{type:"f32",components:4},"vec2<i32>":{type:"i32",components:2},"vec3<i32>":{type:"i32",components:3},"vec4<i32>":{type:"i32",components:4},"vec2<u32>":{type:"u32",components:2},"vec3<u32>":{type:"u32",components:3},"vec4<u32>":{type:"u32",components:4},"mat2x2<f32>":{type:"f32",components:4},"mat2x3<f32>":{type:"f32",components:6},"mat2x4<f32>":{type:"f32",components:8},"mat3x2<f32>":{type:"f32",components:6},"mat3x3<f32>":{type:"f32",components:9},"mat3x4<f32>":{type:"f32",components:12},"mat4x2<f32>":{type:"f32",components:8},"mat4x3<f32>":{type:"f32",components:12},"mat4x4<f32>":{type:"f32",components:16}};function C5(i){return I5[i]}function M5(i,e){switch(e){case 1:return i;case 2:return i+i%2;default:return i+(4-i%4)%4}}let Eg;function uR(i){return(!Eg||Eg.byteLength<i)&&(Eg=new ArrayBuffer(i)),Eg}function R5(i,e){const t=uR(i.BYTES_PER_ELEMENT*e);return new i(t,0,e)}function P5(i){return ArrayBuffer.isView(i)&&!(i instanceof DataView)}function wy(i){return Array.isArray(i)?i.length===0||typeof i[0]=="number":P5(i)}const ZS=1024;class B5{constructor(e){pe(this,"layout",{});pe(this,"byteLength");let t=0;for(const[a,h]of Object.entries(e)){const y=C5(h),{type:s,components:T}=y;t=M5(t,T);const B=t;t+=T,this.layout[a]={type:s,size:T,offset:B}}t+=(4-t%4)%4;const r=t*4;this.byteLength=Math.max(r,ZS)}getData(e){const t=Math.max(this.byteLength,ZS),r=uR(t),a={i32:new Int32Array(r),u32:new Uint32Array(r),f32:new Float32Array(r),f16:new Uint16Array(r)};for(const[h,y]of Object.entries(e)){const s=this.layout[h];if(!s){Gt.warn(`Supplied uniform value ${h} not present in uniform block layout`)();continue}const{type:T,size:B,offset:F}=s,V=a[T];if(B===1){if(typeof y!="number"&&typeof y!="boolean"){Gt.warn(`Supplied value for single component uniform ${h} is not a number: ${y}`)();continue}V[F]=Number(y)}else{if(!wy(y)){Gt.warn(`Supplied value for multi component / array uniform ${h} is not a numeric array: ${y}`)();continue}V.set(y,F)}}return new Uint8Array(r)}has(e){return!!this.layout[e]}get(e){return this.layout[e]}}function D5(i,e,t=16){if(i!==e)return!1;const r=i,a=e;if(!wy(r))return!1;if(wy(a)&&r.length===a.length){for(let h=0;h<r.length;++h)if(a[h]!==r[h])return!1}return!0}function O5(i){return wy(i)?i.slice():i}class F5{constructor(e){pe(this,"name");pe(this,"uniforms",{});pe(this,"modifiedUniforms",{});pe(this,"modified",!0);pe(this,"bindingLayout",{});pe(this,"needsRedraw","initialized");var t;if(this.name=(e==null?void 0:e.name)||"unnamed",e!=null&&e.name&&(e!=null&&e.shaderLayout)){const r=(t=e==null?void 0:e.shaderLayout.bindings)==null?void 0:t.find(h=>h.type==="uniform"&&h.name===(e==null?void 0:e.name));if(!r)throw new Error(e==null?void 0:e.name);const a=r;for(const h of a.uniforms||[])this.bindingLayout[h.name]=h}}setUniforms(e){for(const[t,r]of Object.entries(e))this._setUniform(t,r),this.needsRedraw||this.setNeedsRedraw(`${this.name}.${t}=${r}`)}setNeedsRedraw(e){this.needsRedraw=this.needsRedraw||e}getAllUniforms(){return this.modifiedUniforms={},this.needsRedraw=!1,this.uniforms||{}}_setUniform(e,t){D5(this.uniforms[e],t)||(this.uniforms[e]=O5(t),this.modifiedUniforms[e]=!0,this.modified=!0)}}class k5{constructor(e){pe(this,"uniformBlocks",new Map);pe(this,"uniformBufferLayouts",new Map);pe(this,"uniformBuffers",new Map);for(const[t,r]of Object.entries(e)){const a=t,h=new B5(r.uniformTypes||{});this.uniformBufferLayouts.set(a,h);const y=new F5({name:t});y.setUniforms(r.defaultUniforms||{}),this.uniformBlocks.set(a,y)}}destroy(){for(const e of this.uniformBuffers.values())e.destroy()}setUniforms(e){var t;for(const[r,a]of Object.entries(e))(t=this.uniformBlocks.get(r))==null||t.setUniforms(a);this.updateUniformBuffers()}getUniformBufferByteLength(e){var t;return((t=this.uniformBufferLayouts.get(e))==null?void 0:t.byteLength)||0}getUniformBufferData(e){var r,a;const t=((r=this.uniformBlocks.get(e))==null?void 0:r.getAllUniforms())||{};return(a=this.uniformBufferLayouts.get(e))==null?void 0:a.getData(t)}createUniformBuffer(e,t,r){r&&this.setUniforms(r);const a=this.getUniformBufferByteLength(t),h=e.createBuffer({usage:Gr.UNIFORM|Gr.COPY_DST,byteLength:a}),y=this.getUniformBufferData(t);return h.write(y),h}getManagedUniformBuffer(e,t){if(!this.uniformBuffers.get(t)){const r=this.getUniformBufferByteLength(t),a=e.createBuffer({usage:Gr.UNIFORM|Gr.COPY_DST,byteLength:r});this.uniformBuffers.set(t,a)}return this.uniformBuffers.get(t)}updateUniformBuffers(){let e=!1;for(const t of this.uniformBlocks.keys()){const r=this.updateUniformBuffer(t);e||(e=r)}return e&&Gt.log(3,`UniformStore.updateUniformBuffers(): ${e}`)(),e}updateUniformBuffer(e){var h;const t=this.uniformBlocks.get(e);let r=this.uniformBuffers.get(e),a=!1;if(r&&(t!=null&&t.needsRedraw)){a||(a=t.needsRedraw);const y=this.getUniformBufferData(e);r=this.uniformBuffers.get(e),r==null||r.write(y);const s=(h=this.uniformBlocks.get(e))==null?void 0:h.getAllUniforms();Gt.log(4,`Writing to uniform buffer ${String(e)}`,y,s)()}return a}}function hR(i){const e=ArrayBuffer.isView(i)?i.constructor:i;switch(e){case Float32Array:return"float32";case Uint16Array:return"uint16";case Uint32Array:return"uint32";case Uint8Array:case Uint8ClampedArray:return"uint8";case Int8Array:return"sint8";case Int16Array:return"sint16";case Int32Array:return"sint32";default:throw new Error(e.constructor.name)}}function dR(i){switch(i){case"float32":return Float32Array;case"uint32":return Uint32Array;case"sint32":return Int32Array;case"uint16":case"unorm16":return Uint16Array;case"sint16":case"snorm16":return Int16Array;case"uint8":case"unorm8":return Uint8Array;case"sint8":case"snorm8":return Int8Array;default:throw new Error(i)}}function L5(i,e,t){if(!e||e>4)throw new Error(`size ${e}`);const r=e;let a=hR(i);if(a==="uint8"&&t&&r===1)return"unorm8-webgl";if(a==="uint8"&&t&&r===3)return"unorm8x3-webgl";if(a==="uint8"||a==="sint8"){if(r===1||r===3)throw new Error(`size: ${e}`);return t&&(a=a.replace("int","norm")),`${a}x${r}`}if(a==="uint16"||a==="sint16"){if(r===1||r===3)throw new Error(`size: ${e}`);return t&&(a=a.replace("int","norm")),`${a}x${r}`}return r===1?a:`${a}x${r}`}class Hx{constructor(e){pe(this,"bufferLayouts");this.bufferLayouts=e}getBufferLayout(e){return this.bufferLayouts.find(t=>t.name===e)||null}getAttributeNamesForBuffer(e){var t;return e.attributes?(t=e.attributes)==null?void 0:t.map(r=>r.attribute):[e.name]}mergeBufferLayouts(e,t){const r=[...e];for(const a of t){const h=r.findIndex(y=>y.name===a.name);h<0?r.push(a):r[h]=a}return r}}let go=class{constructor(e,t){this.name=e,this.attributes=t,this.size=0}get isArray(){return!1}get isStruct(){return!1}get isTemplate(){return!1}getTypeName(){return this.name}};class YS{constructor(e,t,r){this.name=e,this.type=t,this.attributes=r,this.offset=0,this.size=0}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray||this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}}class rc extends go{constructor(e,t){super(e,t),this.members=[],this.align=0,this.startLine=-1,this.endLine=-1,this.inUse=!1}get isStruct(){return!0}}class ac extends go{constructor(e,t){super(e,t),this.count=0,this.stride=0}get isArray(){return!0}}class Iu extends go{constructor(e,t,r,a){super(e,r),this.format=t,this.access=a}get isTemplate(){return!0}getTypeName(){let e=this.name;if(this.format!==null){if(e==="vec2"||e==="vec3"||e==="vec4"||e==="mat2x2"||e==="mat2x3"||e==="mat2x4"||e==="mat3x2"||e==="mat3x3"||e==="mat3x4"||e==="mat4x2"||e==="mat4x3"||e==="mat4x4"){if(this.format.name==="f32")return e+="f",e;if(this.format.name==="i32")return e+="i",e;if(this.format.name==="u32")return e+="u",e;if(this.format.name==="bool")return e+="b",e;if(this.format.name==="f16")return e+="h",e}e+=`<${this.format.name}>`}else if(e==="vec2"||e==="vec3"||e==="vec4")return e;return e}}var Kl;(i=>{i[i.Uniform=0]="Uniform",i[i.Storage=1]="Storage",i[i.Texture=2]="Texture",i[i.Sampler=3]="Sampler",i[i.StorageTexture=4]="StorageTexture"})(Kl||(Kl={}));class Sg{constructor(e,t,r,a,h,y,s){this.name=e,this.type=t,this.group=r,this.binding=a,this.attributes=h,this.resourceType=y,this.access=s}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get size(){return this.type.size}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray||this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}}class N5{constructor(e,t){this.name=e,this.type=t}}class z5{constructor(e,t,r,a){this.name=e,this.type=t,this.locationType=r,this.location=a,this.interpolation=null}}class KS{constructor(e,t,r,a){this.name=e,this.type=t,this.locationType=r,this.location=a}}class U5{constructor(e,t,r,a){this.name=e,this.type=t,this.attributes=r,this.id=a}}class V5{constructor(e,t,r){this.name=e,this.type=t,this.attributes=r}}class j5{constructor(e,t=null,r){this.stage=null,this.inputs=[],this.outputs=[],this.arguments=[],this.returnType=null,this.resources=[],this.overrides=[],this.startLine=-1,this.endLine=-1,this.inUse=!1,this.calls=new Set,this.name=e,this.stage=t,this.attributes=r}}class H5{constructor(){this.vertex=[],this.fragment=[],this.compute=[]}}const fR=new Float32Array(1),G5=new Int32Array(fR.buffer),ns=new Uint16Array(1);function $5(i){fR[0]=i;const e=G5[0],t=e>>31&1;let r=e>>23&255,a=8388607&e;if(r===255)return ns[0]=t<<15|31744|(a!==0?512:0),ns[0];if(r===0){if(a===0)return ns[0]=t<<15,ns[0];a|=8388608;let h=113;for(;!(8388608&a);)a<<=1,h--;return r=127-h,a&=8388607,r>0?(a=(a>>126-r)+(a>>127-r&1),ns[0]=t<<15|r<<10|a>>13,ns[0]):(ns[0]=t<<15,ns[0])}return r=r-127+15,r>=31?(ns[0]=t<<15|31744,ns[0]):r<=0?r<-10?(ns[0]=t<<15,ns[0]):(a=(8388608|a)>>1-r,ns[0]=t<<15|a>>13,ns[0]):(a>>=13,ns[0]=t<<15|r<<10|a,ns[0])}const Gw=new Uint32Array(1),pR=new Float32Array(Gw.buffer,0,1);function JS(i){const e=112+(i>>6&31)<<23|(63&i)<<17;return Gw[0]=e,pR[0]}function W5(i,e,t,r,a,h,y,s,T){const B=r*(y>>=a)*(h>>=a)+t*y+e*s;switch(T){case"r8unorm":return[dr(i,B,"8unorm",1)[0]];case"r8snorm":return[dr(i,B,"8snorm",1)[0]];case"r8uint":return[dr(i,B,"8uint",1)[0]];case"r8sint":return[dr(i,B,"8sint",1)[0]];case"rg8unorm":{const F=dr(i,B,"8unorm",2);return[F[0],F[1]]}case"rg8snorm":{const F=dr(i,B,"8snorm",2);return[F[0],F[1]]}case"rg8uint":{const F=dr(i,B,"8uint",2);return[F[0],F[1]]}case"rg8sint":{const F=dr(i,B,"8sint",2);return[F[0],F[1]]}case"rgba8unorm-srgb":case"rgba8unorm":{const F=dr(i,B,"8unorm",4);return[F[0],F[1],F[2],F[3]]}case"rgba8snorm":{const F=dr(i,B,"8snorm",4);return[F[0],F[1],F[2],F[3]]}case"rgba8uint":{const F=dr(i,B,"8uint",4);return[F[0],F[1],F[2],F[3]]}case"rgba8sint":{const F=dr(i,B,"8sint",4);return[F[0],F[1],F[2],F[3]]}case"bgra8unorm-srgb":case"bgra8unorm":{const F=dr(i,B,"8unorm",4);return[F[2],F[1],F[0],F[3]]}case"r16uint":return[dr(i,B,"16uint",1)[0]];case"r16sint":return[dr(i,B,"16sint",1)[0]];case"r16float":return[dr(i,B,"16float",1)[0]];case"rg16uint":{const F=dr(i,B,"16uint",2);return[F[0],F[1]]}case"rg16sint":{const F=dr(i,B,"16sint",2);return[F[0],F[1]]}case"rg16float":{const F=dr(i,B,"16float",2);return[F[0],F[1]]}case"rgba16uint":{const F=dr(i,B,"16uint",4);return[F[0],F[1],F[2],F[3]]}case"rgba16sint":{const F=dr(i,B,"16sint",4);return[F[0],F[1],F[2],F[3]]}case"rgba16float":{const F=dr(i,B,"16float",4);return[F[0],F[1],F[2],F[3]]}case"r32uint":return[dr(i,B,"32uint",1)[0]];case"r32sint":return[dr(i,B,"32sint",1)[0]];case"depth16unorm":case"depth24plus":case"depth24plus-stencil8":case"depth32float":case"depth32float-stencil8":case"r32float":return[dr(i,B,"32float",1)[0]];case"rg32uint":{const F=dr(i,B,"32uint",2);return[F[0],F[1]]}case"rg32sint":{const F=dr(i,B,"32sint",2);return[F[0],F[1]]}case"rg32float":{const F=dr(i,B,"32float",2);return[F[0],F[1]]}case"rgba32uint":{const F=dr(i,B,"32uint",4);return[F[0],F[1],F[2],F[3]]}case"rgba32sint":{const F=dr(i,B,"32sint",4);return[F[0],F[1],F[2],F[3]]}case"rgba32float":{const F=dr(i,B,"32float",4);return[F[0],F[1],F[2],F[3]]}case"rg11b10ufloat":{const F=new Uint32Array(i.buffer,B,1)[0],V=(4192256&F)>>11,X=(4290772992&F)>>22;return[JS(2047&F),JS(V),function(se){const ne=112+(se>>5&31)<<23|(31&se)<<18;return Gw[0]=ne,pR[0]}(X),1]}}return null}function dr(i,e,t,r){const a=[0,0,0,0];for(let B=0;B<r;++B)switch(t){case"8unorm":a[B]=i[e]/255,e++;break;case"8snorm":a[B]=i[e]/255*2-1,e++;break;case"8uint":a[B]=i[e],e++;break;case"8sint":a[B]=i[e]-127,e++;break;case"16uint":a[B]=i[e]|i[e+1]<<8,e+=2;break;case"16sint":a[B]=(i[e]|i[e+1]<<8)-32768,e+=2;break;case"16float":a[B]=(h=i[e]|i[e+1]<<8,y=void 0,s=void 0,T=void 0,y=(32768&h)>>15,T=1023&h,(s=(31744&h)>>10)==0?(y?-1:1)*Math.pow(2,-14)*(T/Math.pow(2,10)):s==31?T?NaN:1/0*(y?-1:1):(y?-1:1)*Math.pow(2,s-15)*(1+T/Math.pow(2,10))),e+=2;break;case"32uint":case"32sint":a[B]=i[e]|i[e+1]<<8|i[e+2]<<16|i[e+3]<<24,e+=4;break;case"32float":a[B]=new Float32Array(i.buffer,e,1)[0],e+=4}var h,y,s,T;return a}function mr(i,e,t,r,a){for(let h=0;h<r;++h)switch(t){case"8unorm":i[e]=255*a[h],e++;break;case"8snorm":i[e]=.5*(a[h]+1)*255,e++;break;case"8uint":i[e]=a[h],e++;break;case"8sint":i[e]=a[h]+127,e++;break;case"16uint":new Uint16Array(i.buffer,e,1)[0]=a[h],e+=2;break;case"16sint":new Int16Array(i.buffer,e,1)[0]=a[h],e+=2;break;case"16float":{const y=$5(a[h]);new Uint16Array(i.buffer,e,1)[0]=y,e+=2;break}case"32uint":new Uint32Array(i.buffer,e,1)[0]=a[h],e+=4;break;case"32sint":new Int32Array(i.buffer,e,1)[0]=a[h],e+=4;break;case"32float":new Float32Array(i.buffer,e,1)[0]=a[h],e+=4}return a}const Gx={r8unorm:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r8snorm:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r8uint:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r8sint:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},rg8unorm:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg8snorm:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg8uint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg8sint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rgba8unorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},"rgba8unorm-srgb":{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba8snorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba8uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba8sint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},bgra8unorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},"bgra8unorm-srgb":{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},r16uint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r16sint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r16float:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},rg16uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg16sint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg16float:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rgba16uint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba16sint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba16float:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},r32uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r32sint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r32float:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},rg32uint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg32sint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg32float:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rgba32uint:{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba32sint:{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba32float:{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgb10a2uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgb10a2unorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rg11b10ufloat:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},stencil8:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!1,hasStencil:!0,channels:1},depth16unorm:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!1,channels:1},depth24plus:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!1,depthOnlyFormat:"depth32float",channels:1},"depth24plus-stencil8":{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!0,depthOnlyFormat:"depth32float",channels:1},depth32float:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!1,channels:1},"depth32float-stencil8":{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!0,stencilOnlyFormat:"depth32float",channels:1},rgb9e5ufloat:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},"bc1-rgba-unorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc1-rgba-unorm-srgb":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc2-rgba-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc2-rgba-unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc3-rgba-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc3-rgba-unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc4-r-unorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:1},"bc4-r-snorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:1},"bc5-rg-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:2},"bc5-rg-snorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:2},"bc6h-rgb-ufloat":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc6h-rgb-float":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc7-rgba-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc7-rgba-unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgb8unorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgb8unorm-srgb":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgb8a1unorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgb8a1unorm-srgb":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgba8unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgba8unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"eac-r11unorm":{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!0,channels:1},"eac-r11snorm":{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!0,channels:1},"eac-rg11unorm":{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!0,channels:2},"eac-rg11snorm":{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!0,channels:2},"astc-4x4-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"astc-4x4-unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"astc-5x4-unorm":{bytesPerBlock:16,blockWidth:5,blockHeight:4,isCompressed:!0,channels:4},"astc-5x4-unorm-srgb":{bytesPerBlock:16,blockWidth:5,blockHeight:4,isCompressed:!0,channels:4},"astc-5x5-unorm":{bytesPerBlock:16,blockWidth:5,blockHeight:5,isCompressed:!0,channels:4},"astc-5x5-unorm-srgb":{bytesPerBlock:16,blockWidth:5,blockHeight:5,isCompressed:!0,channels:4},"astc-6x5-unorm":{bytesPerBlock:16,blockWidth:6,blockHeight:5,isCompressed:!0,channels:4},"astc-6x5-unorm-srgb":{bytesPerBlock:16,blockWidth:6,blockHeight:5,isCompressed:!0,channels:4},"astc-6x6-unorm":{bytesPerBlock:16,blockWidth:6,blockHeight:6,isCompressed:!0,channels:4},"astc-6x6-unorm-srgb":{bytesPerBlock:16,blockWidth:6,blockHeight:6,isCompressed:!0,channels:4},"astc-8x5-unorm":{bytesPerBlock:16,blockWidth:8,blockHeight:5,isCompressed:!0,channels:4},"astc-8x5-unorm-srgb":{bytesPerBlock:16,blockWidth:8,blockHeight:5,isCompressed:!0,channels:4},"astc-8x6-unorm":{bytesPerBlock:16,blockWidth:8,blockHeight:6,isCompressed:!0,channels:4},"astc-8x6-unorm-srgb":{bytesPerBlock:16,blockWidth:8,blockHeight:6,isCompressed:!0,channels:4},"astc-8x8-unorm":{bytesPerBlock:16,blockWidth:8,blockHeight:8,isCompressed:!0,channels:4},"astc-8x8-unorm-srgb":{bytesPerBlock:16,blockWidth:8,blockHeight:8,isCompressed:!0,channels:4},"astc-10x5-unorm":{bytesPerBlock:16,blockWidth:10,blockHeight:5,isCompressed:!0,channels:4},"astc-10x5-unorm-srgb":{bytesPerBlock:16,blockWidth:10,blockHeight:5,isCompressed:!0,channels:4},"astc-10x6-unorm":{bytesPerBlock:16,blockWidth:10,blockHeight:6,isCompressed:!0,channels:4},"astc-10x6-unorm-srgb":{bytesPerBlock:16,blockWidth:10,blockHeight:6,isCompressed:!0,channels:4},"astc-10x8-unorm":{bytesPerBlock:16,blockWidth:10,blockHeight:8,isCompressed:!0,channels:4},"astc-10x8-unorm-srgb":{bytesPerBlock:16,blockWidth:10,blockHeight:8,isCompressed:!0,channels:4},"astc-10x10-unorm":{bytesPerBlock:16,blockWidth:10,blockHeight:10,isCompressed:!0,channels:4},"astc-10x10-unorm-srgb":{bytesPerBlock:16,blockWidth:10,blockHeight:10,isCompressed:!0,channels:4},"astc-12x10-unorm":{bytesPerBlock:16,blockWidth:12,blockHeight:10,isCompressed:!0,channels:4},"astc-12x10-unorm-srgb":{bytesPerBlock:16,blockWidth:12,blockHeight:10,isCompressed:!0,channels:4},"astc-12x12-unorm":{bytesPerBlock:16,blockWidth:12,blockHeight:12,isCompressed:!0,channels:4},"astc-12x12-unorm-srgb":{bytesPerBlock:16,blockWidth:12,blockHeight:12,isCompressed:!0,channels:4}};class xo{constructor(){this.id=xo._id++,this.line=0}get isAstNode(){return!0}get astNodeType(){return""}search(e){e(this)}searchBlock(e,t){if(e){t(Ay.instance);for(const r of e)r instanceof Array?this.searchBlock(r,t):r.search(t);t(Ty.instance)}}constEvaluate(e,t){throw new Error("Cannot evaluate node")}constEvaluateString(e){return this.constEvaluate(e).toString()}}xo._id=0;class Ay extends xo{}Ay.instance=new Ay;class Ty extends xo{}Ty.instance=new Ty;const mR=new Set(["all","all","any","select","arrayLength","abs","acos","acosh","asin","asinh","atan","atanh","atan2","ceil","clamp","cos","cosh","countLeadingZeros","countOneBits","countTrailingZeros","cross","degrees","determinant","distance","dot","dot4U8Packed","dot4I8Packed","exp","exp2","extractBits","faceForward","firstLeadingBit","firstTrailingBit","floor","fma","fract","frexp","insertBits","inverseSqrt","ldexp","length","log","log2","max","min","mix","modf","normalize","pow","quantizeToF16","radians","reflect","refract","reverseBits","round","saturate","sign","sin","sinh","smoothStep","sqrt","step","tan","tanh","transpose","trunc","dpdx","dpdxCoarse","dpdxFine","dpdy","dpdyCoarse","dpdyFine","fwidth","fwidthCoarse","fwidthFine","textureDimensions","textureGather","textureGatherCompare","textureLoad","textureNumLayers","textureNumLevels","textureNumSamples","textureSample","textureSampleBias","textureSampleCompare","textureSampleCompareLevel","textureSampleGrad","textureSampleLevel","textureSampleBaseClampToEdge","textureStore","atomicLoad","atomicStore","atomicAdd","atomicSub","atomicMax","atomicMin","atomicAnd","atomicOr","atomicXor","atomicExchange","atomicCompareExchangeWeak","pack4x8snorm","pack4x8unorm","pack4xI8","pack4xU8","pack4x8Clamp","pack4xU8Clamp","pack2x16snorm","pack2x16unorm","pack2x16float","unpack4x8snorm","unpack4x8unorm","unpack4xI8","unpack4xU8","unpack2x16snorm","unpack2x16unorm","unpack2x16float","storageBarrier","textureBarrier","workgroupBarrier","workgroupUniformLoad","subgroupAdd","subgroupExclusiveAdd","subgroupInclusiveAdd","subgroupAll","subgroupAnd","subgroupAny","subgroupBallot","subgroupBroadcast","subgroupBroadcastFirst","subgroupElect","subgroupMax","subgroupMin","subgroupMul","subgroupExclusiveMul","subgroupInclusiveMul","subgroupOr","subgroupShuffle","subgroupShuffleDown","subgroupShuffleUp","subgroupShuffleXor","subgroupXor","quadBroadcast","quadSwapDiagonal","quadSwapX","quadSwapY"]);class $r extends xo{constructor(){super()}}class mm extends $r{constructor(e,t,r,a,h,y){super(),this.calls=new Set,this.name=e,this.args=t,this.returnType=r,this.body=a,this.startLine=h,this.endLine=y}get astNodeType(){return"function"}search(e){if(this.attributes)for(const t of this.attributes)e(t);e(this);for(const t of this.args)e(t);this.searchBlock(this.body,e)}}class q5 extends $r{constructor(e){super(),this.expression=e}get astNodeType(){return"staticAssert"}search(e){this.expression.search(e)}}class _R extends $r{constructor(e,t){super(),this.condition=e,this.body=t}get astNodeType(){return"while"}search(e){this.condition.search(e),this.searchBlock(this.body,e)}}class L1 extends $r{constructor(e,t){super(),this.body=e,this.loopId=t}get astNodeType(){return"continuing"}search(e){this.searchBlock(this.body,e)}}class gR extends $r{constructor(e,t,r,a){super(),this.init=e,this.condition=t,this.increment=r,this.body=a}get astNodeType(){return"for"}search(e){var t,r,a;(t=this.init)===null||t===void 0||t.search(e),(r=this.condition)===null||r===void 0||r.search(e),(a=this.increment)===null||a===void 0||a.search(e),this.searchBlock(this.body,e)}}class Ja extends $r{constructor(e,t,r,a,h){super(),this.attributes=null,this.name=e,this.type=t,this.storage=r,this.access=a,this.value=h}get astNodeType(){return"var"}search(e){var t;e(this),(t=this.value)===null||t===void 0||t.search(e)}}class $w extends $r{constructor(e,t,r){super(),this.attributes=null,this.name=e,this.type=t,this.value=r}get astNodeType(){return"override"}search(e){var t;(t=this.value)===null||t===void 0||t.search(e)}}class Jp extends $r{constructor(e,t,r,a,h){super(),this.attributes=null,this.name=e,this.type=t,this.storage=r,this.access=a,this.value=h}get astNodeType(){return"let"}search(e){var t;e(this),(t=this.value)===null||t===void 0||t.search(e)}}class Wg extends $r{constructor(e,t,r,a,h){super(),this.attributes=null,this.name=e,this.type=t,this.storage=r,this.access=a,this.value=h}get astNodeType(){return"const"}constEvaluate(e,t){return this.value.constEvaluate(e,t)}search(e){var t;e(this),(t=this.value)===null||t===void 0||t.search(e)}}var od,Up,pt,ot;(i=>{i.increment="++",i.decrement="--"})(od||(od={})),(i=>{i.parse=function(e){const t=e;if(t=="parse")throw new Error("Invalid value for IncrementOperator");return i[t]}})(od||(od={}));class yR extends $r{constructor(e,t){super(),this.operator=e,this.variable=t}get astNodeType(){return"increment"}search(e){this.variable.search(e)}}(i=>{i.assign="=",i.addAssign="+=",i.subtractAssin="-=",i.multiplyAssign="*=",i.divideAssign="/=",i.moduloAssign="%=",i.andAssign="&=",i.orAssign="|=",i.xorAssign="^=",i.shiftLeftAssign="<<=",i.shiftRightAssign=">>="})(Up||(Up={})),(i=>{i.parse=function(e){const t=e;if(t=="parse")throw new Error("Invalid value for AssignOperator");return t}})(Up||(Up={}));class vR extends $r{constructor(e,t,r){super(),this.operator=e,this.variable=t,this.value=r}get astNodeType(){return"assign"}search(e){this.variable.search(e),this.value.search(e)}}class Ww extends $r{constructor(e,t){super(),this.name=e,this.args=t}get astNodeType(){return"call"}isBuiltin(){return mR.has(this.name)}search(e){for(const t of this.args)t.search(e);e(this)}}class xR extends $r{constructor(e,t){super(),this.body=e,this.continuing=t}get astNodeType(){return"loop"}}class bR extends $r{constructor(e,t){super(),this.condition=e,this.cases=t}get astNodeType(){return"switch"}}class wR extends $r{constructor(e,t,r,a){super(),this.condition=e,this.body=t,this.elseif=r,this.else=a}get astNodeType(){return"if"}search(e){this.condition.search(e),this.searchBlock(this.body,e),this.searchBlock(this.elseif,e),this.searchBlock(this.else,e)}}class AR extends $r{constructor(e){super(),this.value=e}get astNodeType(){return"return"}search(e){var t;(t=this.value)===null||t===void 0||t.search(e)}}class X5 extends $r{constructor(e){super(),this.name=e}get astNodeType(){return"enable"}}class Z5 extends $r{constructor(e){super(),this.extensions=e}get astNodeType(){return"requires"}}class TR extends $r{constructor(e,t){super(),this.severity=e,this.rule=t}get astNodeType(){return"diagnostic"}}class qw extends $r{constructor(e,t){super(),this.name=e,this.type=t}get astNodeType(){return"alias"}}class Y5 extends $r{constructor(){super()}get astNodeType(){return"discard"}}class ER extends $r{constructor(){super(),this.condition=null,this.loopId=-1}get astNodeType(){return"break"}}class SR extends $r{constructor(){super(),this.loopId=-1}get astNodeType(){return"continue"}}class kt extends $r{constructor(e){super(),this.attributes=null,this.name=e}get astNodeType(){return"type"}get isStruct(){return!1}get isArray(){return!1}static maxFormatType(e){let t=e[0];if(t.name==="f32")return t;for(let r=1;r<e.length;++r){const a=kt._priority.get(t.name);kt._priority.get(e[r].name)<a&&(t=e[r])}return t.name==="x32"?kt.i32:t}getTypeName(){return this.name}}kt.x32=new kt("x32"),kt.f32=new kt("f32"),kt.i32=new kt("i32"),kt.u32=new kt("u32"),kt.f16=new kt("f16"),kt.bool=new kt("bool"),kt.void=new kt("void"),kt._priority=new Map([["f32",0],["f16",1],["u32",2],["i32",3],["x32",3]]);class QS extends kt{constructor(e){super(e)}}class Ya extends kt{constructor(e,t,r,a){super(e),this.members=t,this.startLine=r,this.endLine=a}get astNodeType(){return"struct"}get isStruct(){return!0}getMemberIndex(e){for(let t=0;t<this.members.length;t++)if(this.members[t].name==e)return t;return-1}search(e){for(const t of this.members)e(t)}}class ht extends kt{constructor(e,t,r){super(e),this.format=t,this.access=r}get astNodeType(){return"template"}getTypeName(){let e=this.name;if(this.format!==null){if(e==="vec2"||e==="vec3"||e==="vec4"||e==="mat2x2"||e==="mat2x3"||e==="mat2x4"||e==="mat3x2"||e==="mat3x3"||e==="mat3x4"||e==="mat4x2"||e==="mat4x3"||e==="mat4x4"){if(this.format.name==="f32")return e+="f",e;if(this.format.name==="i32")return e+="i",e;if(this.format.name==="u32")return e+="u",e;if(this.format.name==="bool")return e+="b",e;if(this.format.name==="f16")return e+="h",e}e+=`<${this.format.name}>`}else if(e==="vec2"||e==="vec3"||e==="vec4")return e;return e}}ht.vec2f=new ht("vec2",kt.f32,null),ht.vec3f=new ht("vec3",kt.f32,null),ht.vec4f=new ht("vec4",kt.f32,null),ht.vec2i=new ht("vec2",kt.i32,null),ht.vec3i=new ht("vec3",kt.i32,null),ht.vec4i=new ht("vec4",kt.i32,null),ht.vec2u=new ht("vec2",kt.u32,null),ht.vec3u=new ht("vec3",kt.u32,null),ht.vec4u=new ht("vec4",kt.u32,null),ht.vec2h=new ht("vec2",kt.f16,null),ht.vec3h=new ht("vec3",kt.f16,null),ht.vec4h=new ht("vec4",kt.f16,null),ht.vec2b=new ht("vec2",kt.bool,null),ht.vec3b=new ht("vec3",kt.bool,null),ht.vec4b=new ht("vec4",kt.bool,null),ht.mat2x2f=new ht("mat2x2",kt.f32,null),ht.mat2x3f=new ht("mat2x3",kt.f32,null),ht.mat2x4f=new ht("mat2x4",kt.f32,null),ht.mat3x2f=new ht("mat3x2",kt.f32,null),ht.mat3x3f=new ht("mat3x3",kt.f32,null),ht.mat3x4f=new ht("mat3x4",kt.f32,null),ht.mat4x2f=new ht("mat4x2",kt.f32,null),ht.mat4x3f=new ht("mat4x3",kt.f32,null),ht.mat4x4f=new ht("mat4x4",kt.f32,null),ht.mat2x2h=new ht("mat2x2",kt.f16,null),ht.mat2x3h=new ht("mat2x3",kt.f16,null),ht.mat2x4h=new ht("mat2x4",kt.f16,null),ht.mat3x2h=new ht("mat3x2",kt.f16,null),ht.mat3x3h=new ht("mat3x3",kt.f16,null),ht.mat3x4h=new ht("mat3x4",kt.f16,null),ht.mat4x2h=new ht("mat4x2",kt.f16,null),ht.mat4x3h=new ht("mat4x3",kt.f16,null),ht.mat4x4h=new ht("mat4x4",kt.f16,null),ht.mat2x2i=new ht("mat2x2",kt.i32,null),ht.mat2x3i=new ht("mat2x3",kt.i32,null),ht.mat2x4i=new ht("mat2x4",kt.i32,null),ht.mat3x2i=new ht("mat3x2",kt.i32,null),ht.mat3x3i=new ht("mat3x3",kt.i32,null),ht.mat3x4i=new ht("mat3x4",kt.i32,null),ht.mat4x2i=new ht("mat4x2",kt.i32,null),ht.mat4x3i=new ht("mat4x3",kt.i32,null),ht.mat4x4i=new ht("mat4x4",kt.i32,null),ht.mat2x2u=new ht("mat2x2",kt.u32,null),ht.mat2x3u=new ht("mat2x3",kt.u32,null),ht.mat2x4u=new ht("mat2x4",kt.u32,null),ht.mat3x2u=new ht("mat3x2",kt.u32,null),ht.mat3x3u=new ht("mat3x3",kt.u32,null),ht.mat3x4u=new ht("mat3x4",kt.u32,null),ht.mat4x2u=new ht("mat4x2",kt.u32,null),ht.mat4x3u=new ht("mat4x3",kt.u32,null),ht.mat4x4u=new ht("mat4x4",kt.u32,null);class $x extends kt{constructor(e,t,r,a){super(e),this.storage=t,this.type=r,this.access=a}get astNodeType(){return"pointer"}}class Qp extends kt{constructor(e,t,r,a){super(e),this.attributes=t,this.format=r,this.count=a}get astNodeType(){return"array"}get isArray(){return!0}}class Vp extends kt{constructor(e,t,r){super(e),this.format=t,this.access=r}get astNodeType(){return"sampler"}}class wa extends xo{constructor(){super(),this.postfix=null}}class Cu extends wa{constructor(e){super(),this.value=e}get astNodeType(){return"stringExpr"}toString(){return this.value}constEvaluateString(){return this.value}}class ga extends wa{constructor(e,t){super(),this.type=e,this.args=t}get astNodeType(){return"createExpr"}search(e){if(e(this),this.args)for(const t of this.args)t.search(e)}constEvaluate(e,t){return t&&(t[0]=this.type),e.evalExpression(this,e.context)}}class Xw extends wa{constructor(e,t){super(),this.cachedReturnValue=null,this.name=e,this.args=t}get astNodeType(){return"callExpr"}setCachedReturnValue(e){this.cachedReturnValue=e}get isBuiltin(){return mR.has(this.name)}constEvaluate(e,t){return e.evalExpression(this,e.context)}search(e){for(const t of this.args)t.search(e);e(this)}}class js extends wa{constructor(e){super(),this.name=e}get astNodeType(){return"varExpr"}search(e){e(this),this.postfix&&this.postfix.search(e)}constEvaluate(e,t){return e.evalExpression(this,e.context)}}class IR extends wa{constructor(e,t){super(),this.name=e,this.initializer=t}get astNodeType(){return"constExpr"}constEvaluate(e,t){if(this.initializer){const r=e.evalExpression(this.initializer,e.context);return r!==null&&this.postfix?r.getSubData(e,this.postfix,e.context):r}return null}search(e){this.initializer.search(e)}}class En extends wa{constructor(e,t){super(),this.value=e,this.type=t}get astNodeType(){return"literalExpr"}constEvaluate(e,t){return t!==void 0&&(t[0]=this.type),this.value}get isScalar(){return this.value instanceof st}get isVector(){return this.value instanceof ze||this.value instanceof Bi}get scalarValue(){return this.value instanceof st?this.value.value:(console.error("Value is not scalar."),0)}get vectorValue(){return this.value instanceof ze||this.value instanceof Bi?this.value.data:(console.error("Value is not a vector or matrix."),new Float32Array(0))}}class CR extends wa{constructor(e,t){super(),this.type=e,this.value=t}get astNodeType(){return"bitcastExpr"}search(e){this.value.search(e)}}class bd extends wa{constructor(e){super(),this.index=e}search(e){this.index.search(e)}}class MR extends wa{constructor(){super()}}class fn extends MR{constructor(e,t){super(),this.operator=e,this.right=t}get astNodeType(){return"unaryOp"}constEvaluate(e,t){return e.evalExpression(this,e.context)}search(e){this.right.search(e)}}class Ho extends MR{constructor(e,t,r){super(),this.operator=e,this.left=t,this.right=r}get astNodeType(){return"binaryOp"}_getPromotedType(e,t){return e.name===t.name?e:e.name==="f32"||t.name==="f32"?kt.f32:e.name==="u32"||t.name==="u32"?kt.u32:kt.i32}constEvaluate(e,t){return e.evalExpression(this,e.context)}search(e){this.left.search(e),this.right.search(e)}}class RR extends xo{constructor(e){super(),this.body=e}}class qg extends wa{constructor(){super()}get astNodeType(){return"default"}}class PR extends RR{constructor(e,t){super(t),this.selectors=e}get astNodeType(){return"case"}search(e){this.searchBlock(this.body,e)}}class BR extends RR{constructor(e){super(e)}get astNodeType(){return"default"}search(e){this.searchBlock(this.body,e)}}class e3 extends xo{constructor(e,t,r){super(),this.name=e,this.type=t,this.attributes=r}get astNodeType(){return"argument"}}class K5 extends xo{constructor(e,t){super(),this.condition=e,this.body=t}get astNodeType(){return"elseif"}search(e){this.condition.search(e),this.searchBlock(this.body,e)}}class t3 extends xo{constructor(e,t,r){super(),this.name=e,this.type=t,this.attributes=r}get astNodeType(){return"member"}}class DR extends xo{constructor(e,t){super(),this.name=e,this.value=t}get astNodeType(){return"attribute"}}class vo{constructor(e,t){this.parent=null,this.typeInfo=e,this.parent=t,this.id=vo._id++}clone(){throw`Clone: Not implemented for ${this.constructor.name}`}setDataValue(e,t,r,a){console.error(`SetDataValue: Not implemented for ${this.constructor.name}`)}getSubData(e,t,r){return console.error(`GetDataValue: Not implemented for ${this.constructor.name}`),null}toString(){return`<${this.typeInfo.name}>`}}vo._id=0;class N1 extends vo{constructor(){super(new go("void",null),null)}toString(){return"void"}}N1.void=new N1;class ed extends vo{constructor(e){super(new go("pointer",null),null),this.reference=e}clone(){return this}setDataValue(e,t,r,a){this.reference.setDataValue(e,t,r,a)}getSubData(e,t,r){return t?this.reference.getSubData(e,t,r):this}}class st extends vo{constructor(e,t,r=null){super(t,r),e instanceof Int32Array||e instanceof Uint32Array||e instanceof Float32Array?this.data=e:this.typeInfo.name==="x32"?e-Math.floor(e)!=0?this.data=new Float32Array([e]):this.data=e>=0?new Uint32Array([e]):new Int32Array([e]):this.typeInfo.name==="i32"||this.typeInfo.name==="bool"?this.data=new Int32Array([e]):this.typeInfo.name==="u32"?this.data=new Uint32Array([e]):this.typeInfo.name==="f32"||this.typeInfo.name==="f16"?this.data=new Float32Array([e]):console.error("ScalarData2: Invalid type",t)}clone(){if(this.data instanceof Float32Array)return new st(new Float32Array(this.data),this.typeInfo,null);if(this.data instanceof Int32Array)return new st(new Int32Array(this.data),this.typeInfo,null);if(this.data instanceof Uint32Array)return new st(new Uint32Array(this.data),this.typeInfo,null);throw"ScalarData: Invalid data type"}get value(){return this.data[0]}set value(e){this.data[0]=e}setDataValue(e,t,r,a){if(r)return void console.error("SetDataValue: Scalar data does not support postfix",r);if(!(t instanceof st))return void console.error("SetDataValue: Invalid value",t);let h=t.data[0];this.typeInfo.name==="i32"||this.typeInfo.name==="u32"?h=Math.floor(h):this.typeInfo.name==="bool"&&(h=h?1:0),this.data[0]=h}getSubData(e,t,r){return t?(console.error("getSubData: Scalar data does not support postfix",t),null):this}toString(){return`${this.value}`}}function J5(i,e,t){const r=e.length;return r===2?t==="f32"?new ze(new Float32Array(e),i.getTypeInfo("vec2f")):t==="i32"||t==="bool"?new ze(new Int32Array(e),i.getTypeInfo("vec2i")):t==="u32"?new ze(new Uint32Array(e),i.getTypeInfo("vec2u")):t==="f16"?new ze(new Float32Array(e),i.getTypeInfo("vec2h")):(console.error(`getSubData: Unknown format ${t}`),null):r===3?t==="f32"?new ze(new Float32Array(e),i.getTypeInfo("vec3f")):t==="i32"||t==="bool"?new ze(new Int32Array(e),i.getTypeInfo("vec3i")):t==="u32"?new ze(new Uint32Array(e),i.getTypeInfo("vec3u")):t==="f16"?new ze(new Float32Array(e),i.getTypeInfo("vec3h")):(console.error(`getSubData: Unknown format ${t}`),null):r===4?t==="f32"?new ze(new Float32Array(e),i.getTypeInfo("vec4f")):t==="i32"||t==="bool"?new ze(new Int32Array(e),i.getTypeInfo("vec4i")):t==="u32"?new ze(new Uint32Array(e),i.getTypeInfo("vec4u")):t==="f16"?new ze(new Float32Array(e),i.getTypeInfo("vec4h")):(console.error(`getSubData: Unknown format ${t}`),null):(console.error(`getSubData: Invalid vector size ${e.length}`),null)}class ze extends vo{constructor(e,t,r=null){if(super(t,r),e instanceof Float32Array||e instanceof Uint32Array||e instanceof Int32Array)this.data=e;else{const a=this.typeInfo.name;a==="vec2f"||a==="vec3f"||a==="vec4f"?this.data=new Float32Array(e):a==="vec2i"||a==="vec3i"||a==="vec4i"?this.data=new Int32Array(e):a==="vec2u"||a==="vec3u"||a==="vec4u"?this.data=new Uint32Array(e):a==="vec2h"||a==="vec3h"||a==="vec4h"?this.data=new Float32Array(e):a==="vec2b"||a==="vec3b"||a==="vec4b"?this.data=new Int32Array(e):a==="vec2"||a==="vec3"||a==="vec4"?this.data=new Float32Array(e):console.error(`VectorData: Invalid type ${a}`)}}clone(){if(this.data instanceof Float32Array)return new ze(new Float32Array(this.data),this.typeInfo,null);if(this.data instanceof Int32Array)return new ze(new Int32Array(this.data),this.typeInfo,null);if(this.data instanceof Uint32Array)return new ze(new Uint32Array(this.data),this.typeInfo,null);throw"VectorData: Invalid data type"}setDataValue(e,t,r,a){r instanceof Cu?console.error("TODO: Set vector postfix"):t instanceof ze?this.data=t.data:console.error("SetDataValue: Invalid value",t)}getSubData(e,t,r){if(t===null)return this;let a=e.getTypeInfo("f32");if(this.typeInfo instanceof Iu)a=this.typeInfo.format||a;else{const y=this.typeInfo.name;y==="vec2f"||y==="vec3f"||y==="vec4f"?a=e.getTypeInfo("f32"):y==="vec2i"||y==="vec3i"||y==="vec4i"?a=e.getTypeInfo("i32"):y==="vec2b"||y==="vec3b"||y==="vec4b"?a=e.getTypeInfo("bool"):y==="vec2u"||y==="vec3u"||y==="vec4u"?a=e.getTypeInfo("u32"):y==="vec2h"||y==="vec3h"||y==="vec4h"?a=e.getTypeInfo("f16"):console.error(`GetSubData: Unknown type ${y}`)}let h=this;for(;t!==null&&h!==null;){if(t instanceof bd){const y=t.index;let s=-1;if(y instanceof En){if(!(y.value instanceof st))return console.error(`GetSubData: Invalid array index ${y.value}`),null;s=y.value.value}else{const T=e.evalExpression(y,r);if(!(T instanceof st))return console.error("GetSubData: Unknown index type",y),null;s=T.value}if(s<0||s>=h.data.length)return console.error("GetSubData: Index out of range",s),null;if(h.data instanceof Float32Array){const T=new Float32Array(h.data.buffer,h.data.byteOffset+4*s,1);return new st(T,a)}if(h.data instanceof Int32Array){const T=new Int32Array(h.data.buffer,h.data.byteOffset+4*s,1);return new st(T,a)}if(h.data instanceof Uint32Array){const T=new Uint32Array(h.data.buffer,h.data.byteOffset+4*s,1);return new st(T,a)}throw"GetSubData: Invalid data type"}if(!(t instanceof Cu))return console.error("GetSubData: Unknown postfix",t),null;{const y=t.value.toLowerCase();if(y.length===1){let T=0;if(y==="x"||y==="r")T=0;else if(y==="y"||y==="g")T=1;else if(y==="z"||y==="b")T=2;else{if(y!=="w"&&y!=="a")return console.error(`GetSubData: Unknown member ${y}`),null;T=3}if(this.data instanceof Float32Array){let B=new Float32Array(this.data.buffer,this.data.byteOffset+4*T,1);return new st(B,a,this)}if(this.data instanceof Int32Array){let B=new Int32Array(this.data.buffer,this.data.byteOffset+4*T,1);return new st(B,a,this)}if(this.data instanceof Uint32Array){let B=new Uint32Array(this.data.buffer,this.data.byteOffset+4*T,1);return new st(B,a,this)}}const s=[];for(const T of y)T==="x"||T==="r"?s.push(this.data[0]):T==="y"||T==="g"?s.push(this.data[1]):T==="z"||T==="b"?s.push(this.data[2]):T==="w"||T==="a"?s.push(this.data[3]):console.error(`GetDataValue: Unknown member ${T}`);h=J5(e,s,a.name)}t=t.postfix}return h}toString(){let e=`${this.data[0]}`;for(let t=1;t<this.data.length;++t)e+=`, ${this.data[t]}`;return e}}class Bi extends vo{constructor(e,t,r=null){super(t,r),e instanceof Float32Array?this.data=e:this.data=new Float32Array(e)}clone(){return new Bi(new Float32Array(this.data),this.typeInfo,null)}setDataValue(e,t,r,a){r instanceof Cu?console.error("TODO: Set matrix postfix"):t instanceof Bi?this.data=t.data:console.error("SetDataValue: Invalid value",t)}getSubData(e,t,r){if(t===null)return this;const a=this.typeInfo.name;if(e.getTypeInfo("f32"),this.typeInfo instanceof Iu)this.typeInfo.format;else if(a.endsWith("f"))e.getTypeInfo("f32");else if(a.endsWith("i"))e.getTypeInfo("i32");else if(a.endsWith("u"))e.getTypeInfo("u32");else{if(!a.endsWith("h"))return console.error(`GetDataValue: Unknown type ${a}`),null;e.getTypeInfo("f16")}if(t instanceof bd){const h=t.index;let y=-1;if(h instanceof En){if(!(h.value instanceof st))return console.error(`GetDataValue: Invalid array index ${h.value}`),null;y=h.value.value}else{const B=e.evalExpression(h,r);if(!(B instanceof st))return console.error("GetDataValue: Unknown index type",h),null;y=B.value}if(y<0||y>=this.data.length)return console.error("GetDataValue: Index out of range",y),null;const s=a.endsWith("h")?"h":"f";let T;if(a==="mat2x2"||a==="mat2x2f"||a==="mat2x2h"||a==="mat3x2"||a==="mat3x2f"||a==="mat3x2h"||a==="mat4x2"||a==="mat4x2f"||a==="mat4x2h")T=new ze(new Float32Array(this.data.buffer,this.data.byteOffset+2*y*4,2),e.getTypeInfo(`vec2${s}`));else if(a==="mat2x3"||a==="mat2x3f"||a==="mat2x3h"||a==="mat3x3"||a==="mat3x3f"||a==="mat3x3h"||a==="mat4x3"||a==="mat4x3f"||a==="mat4x3h")T=new ze(new Float32Array(this.data.buffer,this.data.byteOffset+3*y*4,3),e.getTypeInfo(`vec3${s}`));else{if(a!=="mat2x4"&&a!=="mat2x4f"&&a!=="mat2x4h"&&a!=="mat3x4"&&a!=="mat3x4f"&&a!=="mat3x4h"&&a!=="mat4x4"&&a!=="mat4x4f"&&a!=="mat4x4h")return console.error(`GetDataValue: Unknown type ${a}`),null;T=new ze(new Float32Array(this.data.buffer,this.data.byteOffset+4*y*4,4),e.getTypeInfo(`vec4${s}`))}return t.postfix?T.getSubData(e,t.postfix,r):T}return console.error("GetDataValue: Invalid postfix",t),null}toString(){let e=`${this.data[0]}`;for(let t=1;t<this.data.length;++t)e+=`, ${this.data[t]}`;return e}}class tn extends vo{constructor(e,t,r=0,a=null){super(t,a),this.buffer=e instanceof ArrayBuffer?e:e.buffer,this.offset=r}clone(){const e=new Uint8Array(new Uint8Array(this.buffer,this.offset,this.typeInfo.size));return new tn(e.buffer,this.typeInfo,0,null)}setDataValue(e,t,r,a){if(t===null)return void console.log("setDataValue: NULL data.");let h=this.offset,y=this.typeInfo;for(;r;){if(r instanceof bd)if(y instanceof ac){const s=r.index;if(s instanceof En){if(!(s.value instanceof st))return void console.error(`SetDataValue: Invalid index type ${s.value}`);h+=s.value.value*y.stride}else{const T=e.evalExpression(s,a);if(!(T instanceof st))return void console.error("SetDataValue: Unknown index type",s);h+=T.value*y.stride}y=y.format}else console.error(`SetDataValue: Type ${y.getTypeName()} is not an array`);else{if(!(r instanceof Cu))return void console.error("SetDataValue: Unknown postfix type",r);{const s=r.value;if(y instanceof rc){let T=!1;for(const B of y.members)if(B.name===s){h+=B.offset,y=B.type,T=!0;break}if(!T)return void console.error(`SetDataValue: Member ${s} not found`)}else if(y instanceof go){const T=y.getTypeName();let B=0;if(s==="x"||s==="r")B=0;else if(s==="y"||s==="g")B=1;else if(s==="z"||s==="b")B=2;else{if(s!=="w"&&s!=="a")return void console.error(`SetDataValue: Unknown member ${s}`);B=3}if(!(t instanceof st))return void console.error("SetDataValue: Invalid value",t);const F=t.value;return T==="vec2f"?void(new Float32Array(this.buffer,h,2)[B]=F):T==="vec3f"?void(new Float32Array(this.buffer,h,3)[B]=F):T==="vec4f"?void(new Float32Array(this.buffer,h,4)[B]=F):T==="vec2i"?void(new Int32Array(this.buffer,h,2)[B]=F):T==="vec3i"?void(new Int32Array(this.buffer,h,3)[B]=F):T==="vec4i"?void(new Int32Array(this.buffer,h,4)[B]=F):T==="vec2u"?void(new Uint32Array(this.buffer,h,2)[B]=F):T==="vec3u"?void(new Uint32Array(this.buffer,h,3)[B]=F):T==="vec4u"?void(new Uint32Array(this.buffer,h,4)[B]=F):void console.error(`SetDataValue: Type ${T} is not a struct`)}}}r=r.postfix}this.setData(e,t,y,h,a)}setData(e,t,r,a,h){const y=r.getTypeName();if(y!=="f32"&&y!=="f16")if(y!=="i32"&&y!=="atomic<i32>"&&y!=="x32")if(y!=="u32"&&y!=="atomic<u32>")if(y!=="bool")if(y!=="vec2f"&&y!=="vec2h")if(y!=="vec3f"&&y!=="vec3h")if(y!=="vec4f"&&y!=="vec4h")if(y!=="vec2i")if(y!=="vec3i")if(y!=="vec4i")if(y!=="vec2u")if(y!=="vec3u")if(y!=="vec4u")if(y!=="vec2b")if(y!=="vec3b")if(y!=="vec4b")if(y!=="mat2x2f"&&y!=="mat2x2h")if(y!=="mat2x3f"&&y!=="mat2x3h")if(y!=="mat2x4f"&&y!=="mat2x4h")if(y!=="mat3x2f"&&y!=="mat3x2h")if(y!=="mat3x3f"&&y!=="mat3x3h")if(y!=="mat3x4f"&&y!=="mat3x4h")if(y!=="mat4x2f"&&y!=="mat4x2h")if(y!=="mat4x3f"&&y!=="mat4x3h")if(y!=="mat4x4f"&&y!=="mat4x4h")if(t instanceof tn){if(r===t.typeInfo)return void new Uint8Array(this.buffer,a,t.buffer.byteLength).set(new Uint8Array(t.buffer));console.error("SetDataValue: Type mismatch",y,t.typeInfo.getTypeName())}else console.error(`SetData: Unknown type ${y}`);else{const s=new Float32Array(this.buffer,a,16);t instanceof Bi?(s[0]=t.data[0],s[1]=t.data[1],s[2]=t.data[2],s[3]=t.data[3],s[4]=t.data[4],s[5]=t.data[5],s[6]=t.data[6],s[7]=t.data[7],s[8]=t.data[8],s[9]=t.data[9],s[10]=t.data[10],s[11]=t.data[11],s[12]=t.data[12],s[13]=t.data[13],s[14]=t.data[14],s[15]=t.data[15]):(s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[3],s[4]=t[4],s[5]=t[5],s[6]=t[6],s[7]=t[7],s[8]=t[8],s[9]=t[9],s[10]=t[10],s[11]=t[11],s[12]=t[12],s[13]=t[13],s[14]=t[14],s[15]=t[15])}else{const s=new Float32Array(this.buffer,a,12);t instanceof Bi?(s[0]=t.data[0],s[1]=t.data[1],s[2]=t.data[2],s[3]=t.data[3],s[4]=t.data[4],s[5]=t.data[5],s[6]=t.data[6],s[7]=t.data[7],s[8]=t.data[8],s[9]=t.data[9],s[10]=t.data[10],s[11]=t.data[11]):(s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[3],s[4]=t[4],s[5]=t[5],s[6]=t[6],s[7]=t[7],s[8]=t[8],s[9]=t[9],s[10]=t[10],s[11]=t[11])}else{const s=new Float32Array(this.buffer,a,8);t instanceof Bi?(s[0]=t.data[0],s[1]=t.data[1],s[2]=t.data[2],s[3]=t.data[3],s[4]=t.data[4],s[5]=t.data[5],s[6]=t.data[6],s[7]=t.data[7]):(s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[3],s[4]=t[4],s[5]=t[5],s[6]=t[6],s[7]=t[7])}else{const s=new Float32Array(this.buffer,a,12);t instanceof Bi?(s[0]=t.data[0],s[1]=t.data[1],s[2]=t.data[2],s[3]=t.data[3],s[4]=t.data[4],s[5]=t.data[5],s[6]=t.data[6],s[7]=t.data[7],s[8]=t.data[8],s[9]=t.data[9],s[10]=t.data[10],s[11]=t.data[11]):(s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[3],s[4]=t[4],s[5]=t[5],s[6]=t[6],s[7]=t[7],s[8]=t[8],s[9]=t[9],s[10]=t[10],s[11]=t[11])}else{const s=new Float32Array(this.buffer,a,9);t instanceof Bi?(s[0]=t.data[0],s[1]=t.data[1],s[2]=t.data[2],s[3]=t.data[3],s[4]=t.data[4],s[5]=t.data[5],s[6]=t.data[6],s[7]=t.data[7],s[8]=t.data[8]):(s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[3],s[4]=t[4],s[5]=t[5],s[6]=t[6],s[7]=t[7],s[8]=t[8])}else{const s=new Float32Array(this.buffer,a,6);t instanceof Bi?(s[0]=t.data[0],s[1]=t.data[1],s[2]=t.data[2],s[3]=t.data[3],s[4]=t.data[4],s[5]=t.data[5]):(s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[3],s[4]=t[4],s[5]=t[5])}else{const s=new Float32Array(this.buffer,a,8);t instanceof Bi?(s[0]=t.data[0],s[1]=t.data[1],s[2]=t.data[2],s[3]=t.data[3],s[4]=t.data[4],s[5]=t.data[5],s[6]=t.data[6],s[7]=t.data[7]):(s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[3],s[4]=t[4],s[5]=t[5],s[6]=t[6],s[7]=t[7])}else{const s=new Float32Array(this.buffer,a,6);t instanceof Bi?(s[0]=t.data[0],s[1]=t.data[1],s[2]=t.data[2],s[3]=t.data[3],s[4]=t.data[4],s[5]=t.data[5]):(s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[3],s[4]=t[4],s[5]=t[5])}else{const s=new Float32Array(this.buffer,a,4);t instanceof Bi?(s[0]=t.data[0],s[1]=t.data[1],s[2]=t.data[2],s[3]=t.data[3]):(s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[3])}else{const s=new Uint32Array(this.buffer,a,4);t instanceof ze?(s[0]=t.data[0],s[1]=t.data[1],s[2]=t.data[2],s[3]=t.data[3]):(s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[3])}else{const s=new Uint32Array(this.buffer,a,3);t instanceof ze?(s[0]=t.data[0],s[1]=t.data[1],s[2]=t.data[2]):(s[0]=t[0],s[1]=t[1],s[2]=t[2])}else{const s=new Uint32Array(this.buffer,a,2);t instanceof ze?(s[0]=t.data[0],s[1]=t.data[1]):(s[0]=t[0],s[1]=t[1])}else{const s=new Uint32Array(this.buffer,a,4);t instanceof ze?(s[0]=t.data[0],s[1]=t.data[1],s[2]=t.data[2],s[3]=t.data[3]):(s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[3])}else{const s=new Uint32Array(this.buffer,a,3);t instanceof ze?(s[0]=t.data[0],s[1]=t.data[1],s[2]=t.data[2]):(s[0]=t[0],s[1]=t[1],s[2]=t[2])}else{const s=new Uint32Array(this.buffer,a,2);t instanceof ze?(s[0]=t.data[0],s[1]=t.data[1]):(s[0]=t[0],s[1]=t[1])}else{const s=new Int32Array(this.buffer,a,4);t instanceof ze?(s[0]=t.data[0],s[1]=t.data[1],s[2]=t.data[2],s[3]=t.data[3]):(s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[3])}else{const s=new Int32Array(this.buffer,a,3);t instanceof ze?(s[0]=t.data[0],s[1]=t.data[1],s[2]=t.data[2]):(s[0]=t[0],s[1]=t[1],s[2]=t[2])}else{const s=new Int32Array(this.buffer,a,2);t instanceof ze?(s[0]=t.data[0],s[1]=t.data[1]):(s[0]=t[0],s[1]=t[1])}else{const s=new Float32Array(this.buffer,a,4);t instanceof ze?(s[0]=t.data[0],s[1]=t.data[1],s[2]=t.data[2],s[3]=t.data[3]):(s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[3])}else{const s=new Float32Array(this.buffer,a,3);t instanceof ze?(s[0]=t.data[0],s[1]=t.data[1],s[2]=t.data[2]):(s[0]=t[0],s[1]=t[1],s[2]=t[2])}else{const s=new Float32Array(this.buffer,a,2);t instanceof ze?(s[0]=t.data[0],s[1]=t.data[1]):(s[0]=t[0],s[1]=t[1])}else t instanceof st&&(new Int32Array(this.buffer,a,1)[0]=t.value);else t instanceof st&&(new Uint32Array(this.buffer,a,1)[0]=t.value);else t instanceof st&&(new Int32Array(this.buffer,a,1)[0]=t.value);else t instanceof st&&(new Float32Array(this.buffer,a,1)[0]=t.value)}getSubData(e,t,r){var a,h,y;if(t===null)return this;let s=this.offset,T=this.typeInfo;for(;t;){if(t instanceof bd){const F=t.index,V=e.evalExpression(F,r);let X=0;if(V instanceof st?X=V.value:console.error("GetDataValue: Invalid index type",F),T instanceof ac)s+=X*T.stride,T=T.format;else{const se=T.getTypeName();se==="mat4x4"||se==="mat4x4f"||se==="mat4x4h"?(s+=16*X,T=e.getTypeInfo("vec4f")):console.error(`getDataValue: Type ${T.getTypeName()} is not an array`)}}else{if(!(t instanceof Cu))return console.error("GetDataValue: Unknown postfix type",t),null;{const F=t.value;if(T instanceof rc){let V=!1;for(const X of T.members)if(X.name===F){s+=X.offset,T=X.type,V=!0;break}if(!V)return console.error(`GetDataValue: Member ${F} not found`),null}else if(T instanceof go){const V=T.getTypeName();if(V==="vec2f"||V==="vec3f"||V==="vec4f"||V==="vec2i"||V==="vec3i"||V==="vec4i"||V==="vec2u"||V==="vec3u"||V==="vec4u"||V==="vec2b"||V==="vec3b"||V==="vec4b"||V==="vec2h"||V==="vec3h"||V==="vec4h"||V==="vec2"||V==="vec3"||V==="vec4"){if(F.length>0&&F.length<5){let X="f";const se=[];for(let ne=0;ne<F.length;++ne){const K=F[ne].toLowerCase();let ue=0;if(K==="x"||K==="r")ue=0;else if(K==="y"||K==="g")ue=1;else if(K==="z"||K==="b")ue=2;else{if(K!=="w"&&K!=="a")return console.error(`Unknown member ${F}`),null;ue=3}if(F.length===1){if(V.endsWith("f"))return this.buffer.byteLength<s+4*ue+4?(console.log("Insufficient buffer data"),null):new st(new Float32Array(this.buffer,s+4*ue,1),e.getTypeInfo("f32"),this);if(V.endsWith("h"))return new st(new Float32Array(this.buffer,s+4*ue,1),e.getTypeInfo("f16"),this);if(V.endsWith("i"))return new st(new Int32Array(this.buffer,s+4*ue,1),e.getTypeInfo("i32"),this);if(V.endsWith("b"))return new st(new Int32Array(this.buffer,s+4*ue,1),e.getTypeInfo("bool"),this);if(V.endsWith("u"))return new st(new Uint32Array(this.buffer,s+4*ue,1),e.getTypeInfo("i32"),this)}if(V==="vec2f")se.push(new Float32Array(this.buffer,s,2)[ue]);else if(V==="vec3f"){if(s+12>=this.buffer.byteLength)return console.log("Insufficient buffer data"),null;const _e=new Float32Array(this.buffer,s,3);se.push(_e[ue])}else if(V==="vec4f")se.push(new Float32Array(this.buffer,s,4)[ue]);else if(V==="vec2i")X="i",se.push(new Int32Array(this.buffer,s,2)[ue]);else if(V==="vec3i")X="i",se.push(new Int32Array(this.buffer,s,3)[ue]);else if(V==="vec4i")X="i",se.push(new Int32Array(this.buffer,s,4)[ue]);else if(V==="vec2u"){X="u";const _e=new Uint32Array(this.buffer,s,2);se.push(_e[ue])}else V==="vec3u"?(X="u",se.push(new Uint32Array(this.buffer,s,3)[ue])):V==="vec4u"&&(X="u",se.push(new Uint32Array(this.buffer,s,4)[ue]))}return se.length===2?T=e.getTypeInfo(`vec2${X}`):se.length===3?T=e.getTypeInfo(`vec3${X}`):se.length===4?T=e.getTypeInfo(`vec4${X}`):console.error(`GetDataValue: Invalid vector length ${se.length}`),new ze(se,T,null)}return console.error(`GetDataValue: Unknown member ${F}`),null}return console.error(`GetDataValue: Type ${V} is not a struct`),null}}}t=t.postfix}const B=T.getTypeName();return B==="f32"?new st(new Float32Array(this.buffer,s,1),T,this):B==="i32"?new st(new Int32Array(this.buffer,s,1),T,this):B==="u32"?new st(new Uint32Array(this.buffer,s,1),T,this):B==="vec2f"?new ze(new Float32Array(this.buffer,s,2),T,this):B==="vec3f"?new ze(new Float32Array(this.buffer,s,3),T,this):B==="vec4f"?new ze(new Float32Array(this.buffer,s,4),T,this):B==="vec2i"?new ze(new Int32Array(this.buffer,s,2),T,this):B==="vec3i"?new ze(new Int32Array(this.buffer,s,3),T,this):B==="vec4i"?new ze(new Int32Array(this.buffer,s,4),T,this):B==="vec2u"?new ze(new Uint32Array(this.buffer,s,2),T,this):B==="vec3u"?new ze(new Uint32Array(this.buffer,s,3),T,this):B==="vec4u"?new ze(new Uint32Array(this.buffer,s,4),T,this):T instanceof Iu&&T.name==="atomic"?((a=T.format)===null||a===void 0?void 0:a.name)==="u32"?new st(new Uint32Array(this.buffer,s,1)[0],T.format,this):((h=T.format)===null||h===void 0?void 0:h.name)==="i32"?new st(new Int32Array(this.buffer,s,1)[0],T.format,this):(console.error(`GetDataValue: Invalid atomic format ${(y=T.format)===null||y===void 0?void 0:y.name}`),null):new tn(this.buffer,T,s,this)}toString(){let e="";if(this.typeInfo instanceof ac)if(this.typeInfo.format.name==="f32"){const t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}`;for(let r=1;r<t.length;++r)e+=`, ${t[r]}`}else if(this.typeInfo.format.name==="i32"){const t=new Int32Array(this.buffer,this.offset);e=`[${t[0]}`;for(let r=1;r<t.length;++r)e+=`, ${t[r]}`}else if(this.typeInfo.format.name==="u32"){const t=new Uint32Array(this.buffer,this.offset);e=`[${t[0]}`;for(let r=1;r<t.length;++r)e+=`, ${t[r]}`}else if(this.typeInfo.format.name==="vec2f"){const t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}, ${t[1]}]`;for(let r=1;r<t.length/2;++r)e+=`, [${t[2*r]}, ${t[2*r+1]}]`}else if(this.typeInfo.format.name==="vec3f"){const t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}, ${t[1]}, ${t[2]}]`;for(let r=4;r<t.length;r+=4)e+=`, [${t[r]}, ${t[r+1]}, ${t[r+2]}]`}else if(this.typeInfo.format.name==="vec4f"){const t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}, ${t[1]}, ${t[2]}, ${t[3]}]`;for(let r=4;r<t.length;r+=4)e+=`, [${t[r]}, ${t[r+1]}, ${t[r+2]}, ${t[r+3]}]`}else e="[...]";else this.typeInfo instanceof rc?e+="{...}":e="[...]";return e}}class Ka extends vo{constructor(e,t,r,a){super(t,null),this.data=e,this.descriptor=r,this.view=a}clone(){return new Ka(this.data,this.typeInfo,this.descriptor,this.view)}get width(){var e,t;const r=this.descriptor.size;return r instanceof Array&&r.length>0?(e=r[0])!==null&&e!==void 0?e:0:r instanceof Object&&(t=r.width)!==null&&t!==void 0?t:0}get height(){var e,t;const r=this.descriptor.size;return r instanceof Array&&r.length>1?(e=r[1])!==null&&e!==void 0?e:0:r instanceof Object&&(t=r.height)!==null&&t!==void 0?t:0}get depthOrArrayLayers(){var e,t;const r=this.descriptor.size;return r instanceof Array&&r.length>2?(e=r[2])!==null&&e!==void 0?e:0:r instanceof Object&&(t=r.depthOrArrayLayers)!==null&&t!==void 0?t:0}get format(){var e;return this.descriptor&&(e=this.descriptor.format)!==null&&e!==void 0?e:"rgba8unorm"}get sampleCount(){var e;return this.descriptor&&(e=this.descriptor.sampleCount)!==null&&e!==void 0?e:1}get mipLevelCount(){var e;return this.descriptor&&(e=this.descriptor.mipLevelCount)!==null&&e!==void 0?e:1}get dimension(){var e;return this.descriptor&&(e=this.descriptor.dimension)!==null&&e!==void 0?e:"2d"}getMipLevelSize(e){if(e>=this.mipLevelCount)return[0,0,0];const t=[this.width,this.height,this.depthOrArrayLayers];for(let r=0;r<t.length;++r)t[r]=Math.max(1,t[r]>>e);return t}get texelByteSize(){const e=this.format,t=Gx[e];return t?t.isDepthStencil?4:t.bytesPerBlock:0}get bytesPerRow(){return this.width*this.texelByteSize}get isDepthStencil(){const e=this.format,t=Gx[e];return!!t&&t.isDepthStencil}getGpuSize(){const e=this.format,t=Gx[e],r=this.width;if(!e||r<=0||!t)return-1;const a=this.height,h=this.depthOrArrayLayers,y=this.dimension;return r/t.blockWidth*(y==="1d"?1:a/t.blockHeight)*t.bytesPerBlock*h}getPixel(e,t,r=0,a=0){const h=this.texelByteSize,y=this.bytesPerRow,s=this.height,T=this.data[a];return W5(new Uint8Array(T),e,t,r,a,s,y,h,this.format)}setPixel(e,t,r,a,h){const y=this.texelByteSize,s=this.bytesPerRow,T=this.height,B=this.data[a];(function(F,V,X,se,ne,K,ue,_e,ke,we){const ge=se*(ue>>=ne)*(K>>=ne)+X*ue+V*_e;switch(ke){case"r8unorm":return void mr(F,ge,"8unorm",1,we);case"r8snorm":return void mr(F,ge,"8snorm",1,we);case"r8uint":return void mr(F,ge,"8uint",1,we);case"r8sint":return void mr(F,ge,"8sint",1,we);case"rg8unorm":return void mr(F,ge,"8unorm",2,we);case"rg8snorm":return void mr(F,ge,"8snorm",2,we);case"rg8uint":return void mr(F,ge,"8uint",2,we);case"rg8sint":return void mr(F,ge,"8sint",2,we);case"rgba8unorm-srgb":case"rgba8unorm":case"bgra8unorm-srgb":case"bgra8unorm":return void mr(F,ge,"8unorm",4,we);case"rgba8snorm":return void mr(F,ge,"8snorm",4,we);case"rgba8uint":return void mr(F,ge,"8uint",4,we);case"rgba8sint":return void mr(F,ge,"8sint",4,we);case"r16uint":return void mr(F,ge,"16uint",1,we);case"r16sint":return void mr(F,ge,"16sint",1,we);case"r16float":return void mr(F,ge,"16float",1,we);case"rg16uint":return void mr(F,ge,"16uint",2,we);case"rg16sint":return void mr(F,ge,"16sint",2,we);case"rg16float":return void mr(F,ge,"16float",2,we);case"rgba16uint":return void mr(F,ge,"16uint",4,we);case"rgba16sint":return void mr(F,ge,"16sint",4,we);case"rgba16float":return void mr(F,ge,"16float",4,we);case"r32uint":return void mr(F,ge,"32uint",1,we);case"r32sint":return void mr(F,ge,"32sint",1,we);case"depth16unorm":case"depth24plus":case"depth24plus-stencil8":case"depth32float":case"depth32float-stencil8":case"r32float":return void mr(F,ge,"32float",1,we);case"rg32uint":return void mr(F,ge,"32uint",2,we);case"rg32sint":return void mr(F,ge,"32sint",2,we);case"rg32float":return void mr(F,ge,"32float",2,we);case"rgba32uint":return void mr(F,ge,"32uint",4,we);case"rgba32sint":return void mr(F,ge,"32sint",4,we);case"rgba32float":return void mr(F,ge,"32float",4,we);case"rg11b10ufloat":console.error("TODO: rg11b10ufloat not supported for writing")}})(new Uint8Array(B),e,t,r,a,T,s,y,this.format,h)}}(i=>{i[i.token=0]="token",i[i.keyword=1]="keyword",i[i.reserved=2]="reserved"})(ot||(ot={}));class lt{constructor(e,t,r){this.name=e,this.type=t,this.rule=r}toString(){return this.name}}class Ce{}pt=Ce,Ce.none=new lt("",ot.reserved,""),Ce.eof=new lt("EOF",ot.token,""),Ce.reserved={asm:new lt("asm",ot.reserved,"asm"),bf16:new lt("bf16",ot.reserved,"bf16"),do:new lt("do",ot.reserved,"do"),enum:new lt("enum",ot.reserved,"enum"),f16:new lt("f16",ot.reserved,"f16"),f64:new lt("f64",ot.reserved,"f64"),handle:new lt("handle",ot.reserved,"handle"),i8:new lt("i8",ot.reserved,"i8"),i16:new lt("i16",ot.reserved,"i16"),i64:new lt("i64",ot.reserved,"i64"),mat:new lt("mat",ot.reserved,"mat"),premerge:new lt("premerge",ot.reserved,"premerge"),regardless:new lt("regardless",ot.reserved,"regardless"),typedef:new lt("typedef",ot.reserved,"typedef"),u8:new lt("u8",ot.reserved,"u8"),u16:new lt("u16",ot.reserved,"u16"),u64:new lt("u64",ot.reserved,"u64"),unless:new lt("unless",ot.reserved,"unless"),using:new lt("using",ot.reserved,"using"),vec:new lt("vec",ot.reserved,"vec"),void:new lt("void",ot.reserved,"void")},Ce.keywords={array:new lt("array",ot.keyword,"array"),atomic:new lt("atomic",ot.keyword,"atomic"),bool:new lt("bool",ot.keyword,"bool"),f32:new lt("f32",ot.keyword,"f32"),i32:new lt("i32",ot.keyword,"i32"),mat2x2:new lt("mat2x2",ot.keyword,"mat2x2"),mat2x3:new lt("mat2x3",ot.keyword,"mat2x3"),mat2x4:new lt("mat2x4",ot.keyword,"mat2x4"),mat3x2:new lt("mat3x2",ot.keyword,"mat3x2"),mat3x3:new lt("mat3x3",ot.keyword,"mat3x3"),mat3x4:new lt("mat3x4",ot.keyword,"mat3x4"),mat4x2:new lt("mat4x2",ot.keyword,"mat4x2"),mat4x3:new lt("mat4x3",ot.keyword,"mat4x3"),mat4x4:new lt("mat4x4",ot.keyword,"mat4x4"),ptr:new lt("ptr",ot.keyword,"ptr"),sampler:new lt("sampler",ot.keyword,"sampler"),sampler_comparison:new lt("sampler_comparison",ot.keyword,"sampler_comparison"),struct:new lt("struct",ot.keyword,"struct"),texture_1d:new lt("texture_1d",ot.keyword,"texture_1d"),texture_2d:new lt("texture_2d",ot.keyword,"texture_2d"),texture_2d_array:new lt("texture_2d_array",ot.keyword,"texture_2d_array"),texture_3d:new lt("texture_3d",ot.keyword,"texture_3d"),texture_cube:new lt("texture_cube",ot.keyword,"texture_cube"),texture_cube_array:new lt("texture_cube_array",ot.keyword,"texture_cube_array"),texture_multisampled_2d:new lt("texture_multisampled_2d",ot.keyword,"texture_multisampled_2d"),texture_storage_1d:new lt("texture_storage_1d",ot.keyword,"texture_storage_1d"),texture_storage_2d:new lt("texture_storage_2d",ot.keyword,"texture_storage_2d"),texture_storage_2d_array:new lt("texture_storage_2d_array",ot.keyword,"texture_storage_2d_array"),texture_storage_3d:new lt("texture_storage_3d",ot.keyword,"texture_storage_3d"),texture_depth_2d:new lt("texture_depth_2d",ot.keyword,"texture_depth_2d"),texture_depth_2d_array:new lt("texture_depth_2d_array",ot.keyword,"texture_depth_2d_array"),texture_depth_cube:new lt("texture_depth_cube",ot.keyword,"texture_depth_cube"),texture_depth_cube_array:new lt("texture_depth_cube_array",ot.keyword,"texture_depth_cube_array"),texture_depth_multisampled_2d:new lt("texture_depth_multisampled_2d",ot.keyword,"texture_depth_multisampled_2d"),texture_external:new lt("texture_external",ot.keyword,"texture_external"),u32:new lt("u32",ot.keyword,"u32"),vec2:new lt("vec2",ot.keyword,"vec2"),vec3:new lt("vec3",ot.keyword,"vec3"),vec4:new lt("vec4",ot.keyword,"vec4"),bitcast:new lt("bitcast",ot.keyword,"bitcast"),block:new lt("block",ot.keyword,"block"),break:new lt("break",ot.keyword,"break"),case:new lt("case",ot.keyword,"case"),continue:new lt("continue",ot.keyword,"continue"),continuing:new lt("continuing",ot.keyword,"continuing"),default:new lt("default",ot.keyword,"default"),diagnostic:new lt("diagnostic",ot.keyword,"diagnostic"),discard:new lt("discard",ot.keyword,"discard"),else:new lt("else",ot.keyword,"else"),enable:new lt("enable",ot.keyword,"enable"),fallthrough:new lt("fallthrough",ot.keyword,"fallthrough"),false:new lt("false",ot.keyword,"false"),fn:new lt("fn",ot.keyword,"fn"),for:new lt("for",ot.keyword,"for"),function:new lt("function",ot.keyword,"function"),if:new lt("if",ot.keyword,"if"),let:new lt("let",ot.keyword,"let"),const:new lt("const",ot.keyword,"const"),loop:new lt("loop",ot.keyword,"loop"),while:new lt("while",ot.keyword,"while"),private:new lt("private",ot.keyword,"private"),read:new lt("read",ot.keyword,"read"),read_write:new lt("read_write",ot.keyword,"read_write"),return:new lt("return",ot.keyword,"return"),requires:new lt("requires",ot.keyword,"requires"),storage:new lt("storage",ot.keyword,"storage"),switch:new lt("switch",ot.keyword,"switch"),true:new lt("true",ot.keyword,"true"),alias:new lt("alias",ot.keyword,"alias"),type:new lt("type",ot.keyword,"type"),uniform:new lt("uniform",ot.keyword,"uniform"),var:new lt("var",ot.keyword,"var"),override:new lt("override",ot.keyword,"override"),workgroup:new lt("workgroup",ot.keyword,"workgroup"),write:new lt("write",ot.keyword,"write"),r8unorm:new lt("r8unorm",ot.keyword,"r8unorm"),r8snorm:new lt("r8snorm",ot.keyword,"r8snorm"),r8uint:new lt("r8uint",ot.keyword,"r8uint"),r8sint:new lt("r8sint",ot.keyword,"r8sint"),r16uint:new lt("r16uint",ot.keyword,"r16uint"),r16sint:new lt("r16sint",ot.keyword,"r16sint"),r16float:new lt("r16float",ot.keyword,"r16float"),rg8unorm:new lt("rg8unorm",ot.keyword,"rg8unorm"),rg8snorm:new lt("rg8snorm",ot.keyword,"rg8snorm"),rg8uint:new lt("rg8uint",ot.keyword,"rg8uint"),rg8sint:new lt("rg8sint",ot.keyword,"rg8sint"),r32uint:new lt("r32uint",ot.keyword,"r32uint"),r32sint:new lt("r32sint",ot.keyword,"r32sint"),r32float:new lt("r32float",ot.keyword,"r32float"),rg16uint:new lt("rg16uint",ot.keyword,"rg16uint"),rg16sint:new lt("rg16sint",ot.keyword,"rg16sint"),rg16float:new lt("rg16float",ot.keyword,"rg16float"),rgba8unorm:new lt("rgba8unorm",ot.keyword,"rgba8unorm"),rgba8unorm_srgb:new lt("rgba8unorm_srgb",ot.keyword,"rgba8unorm_srgb"),rgba8snorm:new lt("rgba8snorm",ot.keyword,"rgba8snorm"),rgba8uint:new lt("rgba8uint",ot.keyword,"rgba8uint"),rgba8sint:new lt("rgba8sint",ot.keyword,"rgba8sint"),bgra8unorm:new lt("bgra8unorm",ot.keyword,"bgra8unorm"),bgra8unorm_srgb:new lt("bgra8unorm_srgb",ot.keyword,"bgra8unorm_srgb"),rgb10a2unorm:new lt("rgb10a2unorm",ot.keyword,"rgb10a2unorm"),rg11b10float:new lt("rg11b10float",ot.keyword,"rg11b10float"),rg32uint:new lt("rg32uint",ot.keyword,"rg32uint"),rg32sint:new lt("rg32sint",ot.keyword,"rg32sint"),rg32float:new lt("rg32float",ot.keyword,"rg32float"),rgba16uint:new lt("rgba16uint",ot.keyword,"rgba16uint"),rgba16sint:new lt("rgba16sint",ot.keyword,"rgba16sint"),rgba16float:new lt("rgba16float",ot.keyword,"rgba16float"),rgba32uint:new lt("rgba32uint",ot.keyword,"rgba32uint"),rgba32sint:new lt("rgba32sint",ot.keyword,"rgba32sint"),rgba32float:new lt("rgba32float",ot.keyword,"rgba32float"),static_assert:new lt("static_assert",ot.keyword,"static_assert")},Ce.tokens={decimal_float_literal:new lt("decimal_float_literal",ot.token,/((-?[0-9]*\.[0-9]+|-?[0-9]+\.[0-9]*)((e|E)(\+|-)?[0-9]+)?[fh]?)|(-?[0-9]+(e|E)(\+|-)?[0-9]+[fh]?)|(-?[0-9]+[fh])/),hex_float_literal:new lt("hex_float_literal",ot.token,/-?0x((([0-9a-fA-F]*\.[0-9a-fA-F]+|[0-9a-fA-F]+\.[0-9a-fA-F]*)((p|P)(\+|-)?[0-9]+[fh]?)?)|([0-9a-fA-F]+(p|P)(\+|-)?[0-9]+[fh]?))/),int_literal:new lt("int_literal",ot.token,/-?0x[0-9a-fA-F]+|0i?|-?[1-9][0-9]*i?/),uint_literal:new lt("uint_literal",ot.token,/0x[0-9a-fA-F]+u|0u|[1-9][0-9]*u/),name:new lt("name",ot.token,/([_\p{XID_Start}][\p{XID_Continue}]+)|([\p{XID_Start}])/u),ident:new lt("ident",ot.token,/[_a-zA-Z][0-9a-zA-Z_]*/),and:new lt("and",ot.token,"&"),and_and:new lt("and_and",ot.token,"&&"),arrow:new lt("arrow ",ot.token,"->"),attr:new lt("attr",ot.token,"@"),forward_slash:new lt("forward_slash",ot.token,"/"),bang:new lt("bang",ot.token,"!"),bracket_left:new lt("bracket_left",ot.token,"["),bracket_right:new lt("bracket_right",ot.token,"]"),brace_left:new lt("brace_left",ot.token,"{"),brace_right:new lt("brace_right",ot.token,"}"),colon:new lt("colon",ot.token,":"),comma:new lt("comma",ot.token,","),equal:new lt("equal",ot.token,"="),equal_equal:new lt("equal_equal",ot.token,"=="),not_equal:new lt("not_equal",ot.token,"!="),greater_than:new lt("greater_than",ot.token,">"),greater_than_equal:new lt("greater_than_equal",ot.token,">="),shift_right:new lt("shift_right",ot.token,">>"),less_than:new lt("less_than",ot.token,"<"),less_than_equal:new lt("less_than_equal",ot.token,"<="),shift_left:new lt("shift_left",ot.token,"<<"),modulo:new lt("modulo",ot.token,"%"),minus:new lt("minus",ot.token,"-"),minus_minus:new lt("minus_minus",ot.token,"--"),period:new lt("period",ot.token,"."),plus:new lt("plus",ot.token,"+"),plus_plus:new lt("plus_plus",ot.token,"++"),or:new lt("or",ot.token,"|"),or_or:new lt("or_or",ot.token,"||"),paren_left:new lt("paren_left",ot.token,"("),paren_right:new lt("paren_right",ot.token,")"),semicolon:new lt("semicolon",ot.token,";"),star:new lt("star",ot.token,"*"),tilde:new lt("tilde",ot.token,"~"),underscore:new lt("underscore",ot.token,"_"),xor:new lt("xor",ot.token,"^"),plus_equal:new lt("plus_equal",ot.token,"+="),minus_equal:new lt("minus_equal",ot.token,"-="),times_equal:new lt("times_equal",ot.token,"*="),division_equal:new lt("division_equal",ot.token,"/="),modulo_equal:new lt("modulo_equal",ot.token,"%="),and_equal:new lt("and_equal",ot.token,"&="),or_equal:new lt("or_equal",ot.token,"|="),xor_equal:new lt("xor_equal",ot.token,"^="),shift_right_equal:new lt("shift_right_equal",ot.token,">>="),shift_left_equal:new lt("shift_left_equal",ot.token,"<<=")},Ce.simpleTokens={"@":pt.tokens.attr,"{":pt.tokens.brace_left,"}":pt.tokens.brace_right,":":pt.tokens.colon,",":pt.tokens.comma,"(":pt.tokens.paren_left,")":pt.tokens.paren_right,";":pt.tokens.semicolon},Ce.literalTokens={"&":pt.tokens.and,"&&":pt.tokens.and_and,"->":pt.tokens.arrow,"/":pt.tokens.forward_slash,"!":pt.tokens.bang,"[":pt.tokens.bracket_left,"]":pt.tokens.bracket_right,"=":pt.tokens.equal,"==":pt.tokens.equal_equal,"!=":pt.tokens.not_equal,">":pt.tokens.greater_than,">=":pt.tokens.greater_than_equal,">>":pt.tokens.shift_right,"<":pt.tokens.less_than,"<=":pt.tokens.less_than_equal,"<<":pt.tokens.shift_left,"%":pt.tokens.modulo,"-":pt.tokens.minus,"--":pt.tokens.minus_minus,".":pt.tokens.period,"+":pt.tokens.plus,"++":pt.tokens.plus_plus,"|":pt.tokens.or,"||":pt.tokens.or_or,"*":pt.tokens.star,"~":pt.tokens.tilde,_:pt.tokens.underscore,"^":pt.tokens.xor,"+=":pt.tokens.plus_equal,"-=":pt.tokens.minus_equal,"*=":pt.tokens.times_equal,"/=":pt.tokens.division_equal,"%=":pt.tokens.modulo_equal,"&=":pt.tokens.and_equal,"|=":pt.tokens.or_equal,"^=":pt.tokens.xor_equal,">>=":pt.tokens.shift_right_equal,"<<=":pt.tokens.shift_left_equal},Ce.regexTokens={decimal_float_literal:pt.tokens.decimal_float_literal,hex_float_literal:pt.tokens.hex_float_literal,int_literal:pt.tokens.int_literal,uint_literal:pt.tokens.uint_literal,ident:pt.tokens.ident},Ce.storage_class=[pt.keywords.function,pt.keywords.private,pt.keywords.workgroup,pt.keywords.uniform,pt.keywords.storage],Ce.access_mode=[pt.keywords.read,pt.keywords.write,pt.keywords.read_write],Ce.sampler_type=[pt.keywords.sampler,pt.keywords.sampler_comparison],Ce.sampled_texture_type=[pt.keywords.texture_1d,pt.keywords.texture_2d,pt.keywords.texture_2d_array,pt.keywords.texture_3d,pt.keywords.texture_cube,pt.keywords.texture_cube_array],Ce.multisampled_texture_type=[pt.keywords.texture_multisampled_2d],Ce.storage_texture_type=[pt.keywords.texture_storage_1d,pt.keywords.texture_storage_2d,pt.keywords.texture_storage_2d_array,pt.keywords.texture_storage_3d],Ce.depth_texture_type=[pt.keywords.texture_depth_2d,pt.keywords.texture_depth_2d_array,pt.keywords.texture_depth_cube,pt.keywords.texture_depth_cube_array,pt.keywords.texture_depth_multisampled_2d],Ce.texture_external_type=[pt.keywords.texture_external],Ce.any_texture_type=[...pt.sampled_texture_type,...pt.multisampled_texture_type,...pt.storage_texture_type,...pt.depth_texture_type,...pt.texture_external_type],Ce.texel_format=[pt.keywords.r8unorm,pt.keywords.r8snorm,pt.keywords.r8uint,pt.keywords.r8sint,pt.keywords.r16uint,pt.keywords.r16sint,pt.keywords.r16float,pt.keywords.rg8unorm,pt.keywords.rg8snorm,pt.keywords.rg8uint,pt.keywords.rg8sint,pt.keywords.r32uint,pt.keywords.r32sint,pt.keywords.r32float,pt.keywords.rg16uint,pt.keywords.rg16sint,pt.keywords.rg16float,pt.keywords.rgba8unorm,pt.keywords.rgba8unorm_srgb,pt.keywords.rgba8snorm,pt.keywords.rgba8uint,pt.keywords.rgba8sint,pt.keywords.bgra8unorm,pt.keywords.bgra8unorm_srgb,pt.keywords.rgb10a2unorm,pt.keywords.rg11b10float,pt.keywords.rg32uint,pt.keywords.rg32sint,pt.keywords.rg32float,pt.keywords.rgba16uint,pt.keywords.rgba16sint,pt.keywords.rgba16float,pt.keywords.rgba32uint,pt.keywords.rgba32sint,pt.keywords.rgba32float],Ce.const_literal=[pt.tokens.int_literal,pt.tokens.uint_literal,pt.tokens.decimal_float_literal,pt.tokens.hex_float_literal,pt.keywords.true,pt.keywords.false],Ce.literal_or_ident=[pt.tokens.ident,pt.tokens.int_literal,pt.tokens.uint_literal,pt.tokens.decimal_float_literal,pt.tokens.hex_float_literal,pt.tokens.name],Ce.element_count_expression=[pt.tokens.int_literal,pt.tokens.uint_literal,pt.tokens.ident],Ce.template_types=[pt.keywords.vec2,pt.keywords.vec3,pt.keywords.vec4,pt.keywords.mat2x2,pt.keywords.mat2x3,pt.keywords.mat2x4,pt.keywords.mat3x2,pt.keywords.mat3x3,pt.keywords.mat3x4,pt.keywords.mat4x2,pt.keywords.mat4x3,pt.keywords.mat4x4,pt.keywords.atomic,pt.keywords.bitcast,...pt.any_texture_type],Ce.attribute_name=[pt.tokens.ident,pt.keywords.block,pt.keywords.diagnostic],Ce.assignment_operators=[pt.tokens.equal,pt.tokens.plus_equal,pt.tokens.minus_equal,pt.tokens.times_equal,pt.tokens.division_equal,pt.tokens.modulo_equal,pt.tokens.and_equal,pt.tokens.or_equal,pt.tokens.xor_equal,pt.tokens.shift_right_equal,pt.tokens.shift_left_equal],Ce.increment_operators=[pt.tokens.plus_plus,pt.tokens.minus_minus];class i3{constructor(e,t,r,a,h){this.type=e,this.lexeme=t,this.line=r,this.start=a,this.end=h}toString(){return this.lexeme}isTemplateType(){return Ce.template_types.indexOf(this.type)!=-1}isArrayType(){return this.type==Ce.keywords.array}isArrayOrTemplateType(){return this.isArrayType()||this.isTemplateType()}}class Q5{constructor(e){this._tokens=[],this._start=0,this._current=0,this._line=1,this._source=e??""}scanTokens(){for(;!this._isAtEnd();)if(this._start=this._current,!this.scanToken())throw`Invalid syntax at line ${this._line}`;return this._tokens.push(new i3(Ce.eof,"",this._line,this._current,this._current)),this._tokens}scanToken(){let e=this._advance();if(e==`
`)return this._line++,!0;if(this._isWhitespace(e))return!0;if(e=="/"){if(this._peekAhead()=="/"){for(;e!=`
`;){if(this._isAtEnd())return!0;e=this._advance()}return this._line++,!0}if(this._peekAhead()=="*"){this._advance();let y=1;for(;y>0;){if(this._isAtEnd())return!0;if(e=this._advance(),e==`
`)this._line++;else if(e=="*"){if(this._peekAhead()=="/"&&(this._advance(),y--,y==0))return!0}else e=="/"&&this._peekAhead()=="*"&&(this._advance(),y++)}return!0}}const t=Ce.simpleTokens[e];if(t)return this._addToken(t),!0;let r=Ce.none;const a=this._isAlpha(e),h=e==="_";if(this._isAlphaNumeric(e)){let y=this._peekAhead();for(;this._isAlphaNumeric(y);)e+=this._advance(),y=this._peekAhead()}if(a){const y=Ce.keywords[e];if(y)return this._addToken(y),!0}if(a||h)return this._addToken(Ce.tokens.ident),!0;for(;;){let y=this._findType(e);const s=this._peekAhead();if(e=="-"&&this._tokens.length>0){if(s=="=")return this._current++,e+=s,this._addToken(Ce.tokens.minus_equal),!0;if(s=="-")return this._current++,e+=s,this._addToken(Ce.tokens.minus_minus),!0;const T=this._tokens.length-1;if((Ce.literal_or_ident.indexOf(this._tokens[T].type)!=-1||this._tokens[T].type==Ce.tokens.paren_right)&&s!=">")return this._addToken(y),!0}if(e==">"&&(s==">"||s=="=")){let T=!1,B=this._tokens.length-1;for(let F=0;F<5&&B>=0&&Ce.assignment_operators.indexOf(this._tokens[B].type)===-1;++F,--B)if(this._tokens[B].type===Ce.tokens.less_than){B>0&&this._tokens[B-1].isArrayOrTemplateType()&&(T=!0);break}if(T)return this._addToken(y),!0}if(y===Ce.none){let T=e,B=0;const F=2;for(let V=0;V<F;++V)if(T+=this._peekAhead(V),y=this._findType(T),y!==Ce.none){B=V;break}if(y===Ce.none)return r!==Ce.none&&(this._current--,this._addToken(r),!0);e=T,this._current+=B+1}if(r=y,this._isAtEnd())break;e+=this._advance()}return r!==Ce.none&&(this._addToken(r),!0)}_findType(e){for(const r in Ce.regexTokens){const a=Ce.regexTokens[r];if(this._match(e,a.rule))return a}return Ce.literalTokens[e]||Ce.none}_match(e,t){const r=t.exec(e);return r&&r.index==0&&r[0]==e}_isAtEnd(){return this._current>=this._source.length}_isAlpha(e){return!this._isNumeric(e)&&!this._isWhitespace(e)&&e!=="_"&&e!=="."&&e!=="("&&e!==")"&&e!=="["&&e!=="]"&&e!=="{"&&e!=="}"&&e!==","&&e!==";"&&e!==":"&&e!=="="&&e!=="!"&&e!=="<"&&e!==">"&&e!=="+"&&e!=="-"&&e!=="*"&&e!=="/"&&e!=="%"&&e!=="&"&&e!=="|"&&e!=="^"&&e!=="~"&&e!=="@"&&e!=="#"&&e!=="?"&&e!=="'"&&e!=="`"&&e!=='"'&&e!=="\\"&&e!==`
`&&e!=="\r"&&e!=="	"&&e!=="\0"}_isNumeric(e){return e>="0"&&e<="9"}_isAlphaNumeric(e){return this._isAlpha(e)||this._isNumeric(e)||e==="_"}_isWhitespace(e){return e==" "||e=="	"||e=="\r"}_advance(e=0){let t=this._source[this._current];return e=e||0,e++,this._current+=e,t}_peekAhead(e=0){return e=e||0,this._current+e>=this._source.length?"\0":this._source[this._current+e]}_addToken(e){const t=this._source.substring(this._start,this._current);this._tokens.push(new i3(e,t,this._line,this._start,this._current))}}function ri(i){return Array.isArray(i)||(i==null?void 0:i.buffer)instanceof ArrayBuffer}const Ey=new Float32Array(1),eU=new Uint32Array(Ey.buffer),tU=new Uint32Array(Ey.buffer),Sy=new Int32Array(1),iU=new Float32Array(Sy.buffer),rU=new Uint32Array(Sy.buffer),Iy=new Uint32Array(1),nU=new Float32Array(Iy.buffer),sU=new Int32Array(Iy.buffer);function r3(i,e,t){if(e===t)return i;if(e==="f32"){if(t==="i32"||t==="x32")return Ey[0]=i,eU[0];if(t==="u32")return Ey[0]=i,tU[0]}else if(e==="i32"||e==="x32"){if(t==="f32")return Sy[0]=i,iU[0];if(t==="u32")return Sy[0]=i,rU[0]}else if(e==="u32"){if(t==="f32")return Iy[0]=i,nU[0];if(t==="i32"||t==="x32")return Iy[0]=i,sU[0]}return console.error(`Unsupported cast from ${e} to ${t}`),i}class oU{constructor(e){this.resources=null,this.inUse=!1,this.info=null,this.node=e}}class Ig{constructor(e,t){this.align=e,this.size=t}}class xa{constructor(){this.uniforms=[],this.storage=[],this.textures=[],this.samplers=[],this.aliases=[],this.overrides=[],this.structs=[],this.entry=new H5,this.functions=[],this._types=new Map,this._functions=new Map}_isStorageTexture(e){return e.name=="texture_storage_1d"||e.name=="texture_storage_2d"||e.name=="texture_storage_2d_array"||e.name=="texture_storage_3d"}updateAST(e){for(const t of e)t instanceof mm&&this._functions.set(t.name,new oU(t));for(const t of e)if(t instanceof Ya){const r=this.getTypeInfo(t,null);r instanceof rc&&this.structs.push(r)}for(const t of e)if(t instanceof qw)this.aliases.push(this._getAliasInfo(t));else if(t instanceof $w){const r=t,a=this._getAttributeNum(r.attributes,"id",0),h=r.type!=null?this.getTypeInfo(r.type,r.attributes):null;this.overrides.push(new U5(r.name,h,r.attributes,a))}else if(this._isUniformVar(t)){const r=t,a=this._getAttributeNum(r.attributes,"group",0),h=this._getAttributeNum(r.attributes,"binding",0),y=this.getTypeInfo(r.type,r.attributes),s=new Sg(r.name,y,a,h,r.attributes,Kl.Uniform,r.access);s.access||(s.access="read"),this.uniforms.push(s)}else if(this._isStorageVar(t)){const r=t,a=this._getAttributeNum(r.attributes,"group",0),h=this._getAttributeNum(r.attributes,"binding",0),y=this.getTypeInfo(r.type,r.attributes),s=this._isStorageTexture(y),T=new Sg(r.name,y,a,h,r.attributes,s?Kl.StorageTexture:Kl.Storage,r.access);T.access||(T.access="read"),this.storage.push(T)}else if(this._isTextureVar(t)){const r=t,a=this._getAttributeNum(r.attributes,"group",0),h=this._getAttributeNum(r.attributes,"binding",0),y=this.getTypeInfo(r.type,r.attributes),s=this._isStorageTexture(y),T=new Sg(r.name,y,a,h,r.attributes,s?Kl.StorageTexture:Kl.Texture,r.access);T.access||(T.access="read"),s?this.storage.push(T):this.textures.push(T)}else if(this._isSamplerVar(t)){const r=t,a=this._getAttributeNum(r.attributes,"group",0),h=this._getAttributeNum(r.attributes,"binding",0),y=this.getTypeInfo(r.type,r.attributes),s=new Sg(r.name,y,a,h,r.attributes,Kl.Sampler,r.access);this.samplers.push(s)}else if(t instanceof mm){const r=this._getAttribute(t,"vertex"),a=this._getAttribute(t,"fragment"),h=this._getAttribute(t,"compute"),y=r||a||h,s=new j5(t.name,y==null?void 0:y.name,t.attributes);s.attributes=t.attributes,s.startLine=t.startLine,s.endLine=t.endLine,this.functions.push(s),this._functions.get(t.name).info=s,y&&(this._functions.get(t.name).inUse=!0,s.inUse=!0,s.resources=this._findResources(t,!!y),s.inputs=this._getInputs(t.args),s.outputs=this._getOutputs(t.returnType),this.entry[y.name].push(s)),s.arguments=t.args.map(T=>new V5(T.name,this.getTypeInfo(T.type,T.attributes),T.attributes)),s.returnType=t.returnType?this.getTypeInfo(t.returnType,t.attributes):null}for(const t of this._functions.values())t.info&&(t.info.inUse=t.inUse,this._addCalls(t.node,t.info.calls));for(const t of this._functions.values())t.node.search(r=>{var a,h,y;if(r instanceof DR){if(r.value)if(ri(r.value))for(const s of r.value)for(const T of this.overrides)s===T.name&&((a=t.info)===null||a===void 0||a.overrides.push(T));else for(const s of this.overrides)r.value===s.name&&((h=t.info)===null||h===void 0||h.overrides.push(s))}else if(r instanceof js)for(const s of this.overrides)r.name===s.name&&((y=t.info)===null||y===void 0||y.overrides.push(s))});for(const t of this.uniforms)this._markStructsInUse(t.type);for(const t of this.storage)this._markStructsInUse(t.type)}getStructInfo(e){for(const t of this.structs)if(t.name==e)return t;return null}getOverrideInfo(e){for(const t of this.overrides)if(t.name==e)return t;return null}_markStructsInUse(e){if(e)if(e.isStruct){if(e.inUse=!0,e.members)for(const t of e.members)this._markStructsInUse(t.type)}else if(e.isArray)this._markStructsInUse(e.format);else if(e.isTemplate)e.format&&this._markStructsInUse(e.format);else{const t=this._getAlias(e.name);t&&this._markStructsInUse(t)}}_addCalls(e,t){var r;for(const a of e.calls){const h=(r=this._functions.get(a.name))===null||r===void 0?void 0:r.info;h&&t.add(h)}}findResource(e,t,r){if(r){for(const a of this.entry.compute)if(a.name===r){for(const h of a.resources)if(h.group==e&&h.binding==t)return h}for(const a of this.entry.vertex)if(a.name===r){for(const h of a.resources)if(h.group==e&&h.binding==t)return h}for(const a of this.entry.fragment)if(a.name===r){for(const h of a.resources)if(h.group==e&&h.binding==t)return h}}for(const a of this.uniforms)if(a.group==e&&a.binding==t)return a;for(const a of this.storage)if(a.group==e&&a.binding==t)return a;for(const a of this.textures)if(a.group==e&&a.binding==t)return a;for(const a of this.samplers)if(a.group==e&&a.binding==t)return a;return null}_findResource(e){for(const t of this.uniforms)if(t.name==e)return t;for(const t of this.storage)if(t.name==e)return t;for(const t of this.textures)if(t.name==e)return t;for(const t of this.samplers)if(t.name==e)return t;return null}_markStructsFromAST(e){const t=this.getTypeInfo(e,null);this._markStructsInUse(t)}_findResources(e,t){const r=[],a=this,h=[];return e.search(y=>{if(y instanceof Ay)h.push({});else if(y instanceof Ty)h.pop();else if(y instanceof Ja){const s=y;t&&s.type!==null&&this._markStructsFromAST(s.type),h.length>0&&(h[h.length-1][s.name]=s)}else if(y instanceof ga){const s=y;t&&s.type!==null&&this._markStructsFromAST(s.type)}else if(y instanceof Jp){const s=y;t&&s.type!==null&&this._markStructsFromAST(s.type),h.length>0&&(h[h.length-1][s.name]=s)}else if(y instanceof js){const s=y;if(h.length>0&&h[h.length-1][s.name])return;const T=a._findResource(s.name);T&&r.push(T)}else if(y instanceof Xw){const s=y,T=a._functions.get(s.name);T&&(t&&(T.inUse=!0),e.calls.add(T.node),T.resources===null&&(T.resources=a._findResources(T.node,t)),r.push(...T.resources))}else if(y instanceof Ww){const s=y,T=a._functions.get(s.name);T&&(t&&(T.inUse=!0),e.calls.add(T.node),T.resources===null&&(T.resources=a._findResources(T.node,t)),r.push(...T.resources))}}),[...new Map(r.map(y=>[y.name,y])).values()]}getBindGroups(){const e=[];function t(r,a){r>=e.length&&(e.length=r+1),e[r]===void 0&&(e[r]=[]),a>=e[r].length&&(e[r].length=a+1)}for(const r of this.uniforms)t(r.group,r.binding),e[r.group][r.binding]=r;for(const r of this.storage)t(r.group,r.binding),e[r.group][r.binding]=r;for(const r of this.textures)t(r.group,r.binding),e[r.group][r.binding]=r;for(const r of this.samplers)t(r.group,r.binding),e[r.group][r.binding]=r;return e}_getOutputs(e,t=void 0){if(t===void 0&&(t=[]),e instanceof Ya)this._getStructOutputs(e,t);else{const r=this._getOutputInfo(e);r!==null&&t.push(r)}return t}_getStructOutputs(e,t){for(const r of e.members)if(r.type instanceof Ya)this._getStructOutputs(r.type,t);else{const a=this._getAttribute(r,"location")||this._getAttribute(r,"builtin");if(a!==null){const h=this.getTypeInfo(r.type,r.type.attributes),y=this._parseInt(a.value),s=new KS(r.name,h,a.name,y);t.push(s)}}}_getOutputInfo(e){const t=this._getAttribute(e,"location")||this._getAttribute(e,"builtin");if(t!==null){const r=this.getTypeInfo(e,e.attributes),a=this._parseInt(t.value);return new KS("",r,t.name,a)}return null}_getInputs(e,t=void 0){t===void 0&&(t=[]);for(const r of e)if(r.type instanceof Ya)this._getStructInputs(r.type,t);else{const a=this._getInputInfo(r);a!==null&&t.push(a)}return t}_getStructInputs(e,t){for(const r of e.members)if(r.type instanceof Ya)this._getStructInputs(r.type,t);else{const a=this._getInputInfo(r);a!==null&&t.push(a)}}_getInputInfo(e){const t=this._getAttribute(e,"location")||this._getAttribute(e,"builtin");if(t!==null){const r=this._getAttribute(e,"interpolation"),a=this.getTypeInfo(e.type,e.attributes),h=this._parseInt(t.value),y=new z5(e.name,a,t.name,h);return r!==null&&(y.interpolation=this._parseString(r.value)),y}return null}_parseString(e){return e instanceof Array&&(e=e[0]),e}_parseInt(e){e instanceof Array&&(e=e[0]);const t=parseInt(e);return isNaN(t)?e:t}_getAlias(e){for(const t of this.aliases)if(t.name==e)return t.type;return null}_getAliasInfo(e){return new N5(e.name,this.getTypeInfo(e.type,null))}getTypeInfoByName(e){for(const t of this.structs)if(t.name==e)return t;for(const t of this.aliases)if(t.name==e)return t.type;return null}getTypeInfo(e,t=null){if(this._types.has(e))return this._types.get(e);if(e instanceof Qp){const a=e,h=a.format?this.getTypeInfo(a.format,a.attributes):null,y=new ac(a.name,t);return y.format=h,y.count=a.count,this._types.set(e,y),this._updateTypeInfo(y),y}if(e instanceof Ya){const a=e,h=new rc(a.name,t);h.startLine=a.startLine,h.endLine=a.endLine;for(const y of a.members){const s=this.getTypeInfo(y.type,y.attributes);h.members.push(new YS(y.name,s,y.attributes))}return this._types.set(e,h),this._updateTypeInfo(h),h}if(e instanceof Vp){const a=e,h=a.format instanceof kt,y=a.format?h?this.getTypeInfo(a.format,null):new go(a.format,null):null,s=new Iu(a.name,y,t,a.access);return this._types.set(e,s),this._updateTypeInfo(s),s}if(e instanceof ht){const a=e,h=a.format?this.getTypeInfo(a.format,null):null,y=new Iu(a.name,h,t,a.access);return this._types.set(e,y),this._updateTypeInfo(y),y}const r=new go(e.name,t);return this._types.set(e,r),this._updateTypeInfo(r),r}_updateTypeInfo(e){var t,r,a;const h=this._getTypeSize(e);if(e.size=(t=h==null?void 0:h.size)!==null&&t!==void 0?t:0,e instanceof ac&&e.format){const y=this._getTypeSize(e.format);e.stride=Math.max((r=y==null?void 0:y.size)!==null&&r!==void 0?r:0,(a=y==null?void 0:y.align)!==null&&a!==void 0?a:0),this._updateTypeInfo(e.format)}e instanceof rc&&this._updateStructInfo(e)}_updateStructInfo(e){var t;let r=0,a=0,h=0,y=0;for(let s=0,T=e.members.length;s<T;++s){const B=e.members[s],F=this._getTypeSize(B);if(!F)continue;(t=this._getAlias(B.type.name))!==null&&t!==void 0||B.type;const V=F.align,X=F.size;r=this._roundUp(V,r+a),a=X,h=r,y=Math.max(y,V),B.offset=r,B.size=X,this._updateTypeInfo(B.type)}e.size=this._roundUp(y,h+a),e.align=y}_getTypeSize(e){var t,r;if(e==null)return null;const a=this._getAttributeNum(e.attributes,"size",0),h=this._getAttributeNum(e.attributes,"align",0);if(e instanceof YS&&(e=e.type),e instanceof go){const y=this._getAlias(e.name);y!==null&&(e=y)}{const y=xa._typeInfo[e.name];if(y!==void 0){const s=((t=e.format)===null||t===void 0?void 0:t.name)==="f16"?2:1;return new Ig(Math.max(h,y.align/s),Math.max(a,y.size/s))}}{const y=xa._typeInfo[e.name.substring(0,e.name.length-1)];if(y){const s=e.name[e.name.length-1]==="h"?2:1;return new Ig(Math.max(h,y.align/s),Math.max(a,y.size/s))}}if(e instanceof ac){let y=e,s=8,T=8;const B=this._getTypeSize(y.format);return B!==null&&(T=B.size,s=B.align),T=y.count*this._getAttributeNum((r=e==null?void 0:e.attributes)!==null&&r!==void 0?r:null,"stride",this._roundUp(s,T)),a&&(T=a),new Ig(Math.max(h,s),Math.max(a,T))}if(e instanceof rc){let y=0,s=0,T=0,B=0,F=0;for(const V of e.members){const X=this._getTypeSize(V.type);X!==null&&(y=Math.max(X.align,y),T=this._roundUp(X.align,T+B),B=X.size,F=T)}return s=this._roundUp(y,F+B),new Ig(Math.max(h,y),Math.max(a,s))}return null}_isUniformVar(e){return e instanceof Ja&&e.storage=="uniform"}_isStorageVar(e){return e instanceof Ja&&e.storage=="storage"}_isTextureVar(e){return e instanceof Ja&&e.type!==null&&xa._textureTypes.indexOf(e.type.name)!=-1}_isSamplerVar(e){return e instanceof Ja&&e.type!==null&&xa._samplerTypes.indexOf(e.type.name)!=-1}_getAttribute(e,t){const r=e;if(!r||!r.attributes)return null;const a=r.attributes;for(let h of a)if(h.name==t)return h;return null}_getAttributeNum(e,t,r){if(e===null)return r;for(let a of e)if(a.name==t){let h=a!==null&&a.value!==null?a.value:r;return h instanceof Array&&(h=h[0]),typeof h=="number"?h:typeof h=="string"?parseInt(h):r}return r}_roundUp(e,t){return Math.ceil(t/e)*e}}xa._typeInfo={f16:{align:2,size:2},i32:{align:4,size:4},u32:{align:4,size:4},f32:{align:4,size:4},atomic:{align:4,size:4},vec2:{align:8,size:8},vec3:{align:16,size:12},vec4:{align:16,size:16},mat2x2:{align:8,size:16},mat3x2:{align:8,size:24},mat4x2:{align:8,size:32},mat2x3:{align:16,size:32},mat3x3:{align:16,size:48},mat4x3:{align:16,size:64},mat2x4:{align:16,size:32},mat3x4:{align:16,size:48},mat4x4:{align:16,size:64}},xa._textureTypes=Ce.any_texture_type.map(i=>i.name),xa._samplerTypes=Ce.sampler_type.map(i=>i.name);class Zw{constructor(e,t,r){this.name=e,this.value=t,this.node=r}clone(){return new Zw(this.name,this.value,this.node)}}class Yw{constructor(e){this.name=e.name,this.node=e}clone(){return new Yw(this.node)}}class Kw{constructor(e){this.parent=null,this.variables=new Map,this.functions=new Map,this.currentFunctionName="",e&&(this.parent=e,this.currentFunctionName=e.currentFunctionName)}getVariable(e){var t;return this.variables.has(e)?(t=this.variables.get(e))!==null&&t!==void 0?t:null:this.parent?this.parent.getVariable(e):null}getFunction(e){var t;return this.functions.has(e)?(t=this.functions.get(e))!==null&&t!==void 0?t:null:this.parent?this.parent.getFunction(e):null}createVariable(e,t,r){this.variables.set(e,new Zw(e,t,r??null))}setVariable(e,t,r){const a=this.getVariable(e);a!==null?a.value=t:this.createVariable(e,t,r)}getVariableValue(e){var t;const r=this.getVariable(e);return(t=r==null?void 0:r.value)!==null&&t!==void 0?t:null}clone(){return new Kw(this)}}class aU{evalExpression(e,t){return null}getTypeInfo(e){return null}getVariableName(e,t){return""}}class lU{constructor(e){this.exec=e}getTypeInfo(e){return this.exec.getTypeInfo(e)}All(e,t){const r=this.exec.evalExpression(e.args[0],t);let a=!0;if(r instanceof ze)return r.data.forEach(h=>{h||(a=!1)}),new st(a?1:0,this.getTypeInfo("bool"));throw new Error(`All() expects a vector argument. Line ${e.line}`)}Any(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ze){const a=r.data.some(h=>h);return new st(a?1:0,this.getTypeInfo("bool"))}throw new Error(`Any() expects a vector argument. Line ${e.line}`)}Select(e,t){const r=this.exec.evalExpression(e.args[2],t);if(!(r instanceof st))throw new Error(`Select() expects a bool condition. Line ${e.line}`);return r.value?this.exec.evalExpression(e.args[1],t):this.exec.evalExpression(e.args[0],t)}ArrayLength(e,t){let r=e.args[0];r instanceof fn&&(r=r.right);const a=this.exec.evalExpression(r,t);if(a instanceof tn&&a.typeInfo.size===0){const h=a.typeInfo,y=a.buffer.byteLength/h.stride;return new st(y,this.getTypeInfo("u32"))}return new st(a.typeInfo.size,this.getTypeInfo("u32"))}Abs(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ze)return new ze(r.data.map(h=>Math.abs(h)),r.typeInfo);const a=r;return new st(Math.abs(a.value),a.typeInfo)}Acos(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ze)return new ze(r.data.map(h=>Math.acos(h)),r.typeInfo);const a=r;return new st(Math.acos(a.value),r.typeInfo)}Acosh(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ze)return new ze(r.data.map(h=>Math.acosh(h)),r.typeInfo);const a=r;return new st(Math.acosh(a.value),r.typeInfo)}Asin(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ze)return new ze(r.data.map(h=>Math.asin(h)),r.typeInfo);const a=r;return new st(Math.asin(a.value),r.typeInfo)}Asinh(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ze)return new ze(r.data.map(h=>Math.asinh(h)),r.typeInfo);const a=r;return new st(Math.asinh(a.value),r.typeInfo)}Atan(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ze)return new ze(r.data.map(h=>Math.atan(h)),r.typeInfo);const a=r;return new st(Math.atan(a.value),r.typeInfo)}Atanh(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ze)return new ze(r.data.map(h=>Math.atanh(h)),r.typeInfo);const a=r;return new st(Math.atanh(a.value),r.typeInfo)}Atan2(e,t){const r=this.exec.evalExpression(e.args[0],t),a=this.exec.evalExpression(e.args[1],t);if(r instanceof ze&&a instanceof ze)return new ze(r.data.map((s,T)=>Math.atan2(s,a.data[T])),r.typeInfo);const h=r,y=a;return new st(Math.atan2(h.value,y.value),r.typeInfo)}Ceil(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ze)return new ze(r.data.map(h=>Math.ceil(h)),r.typeInfo);const a=r;return new st(Math.ceil(a.value),r.typeInfo)}_clamp(e,t,r){return Math.min(Math.max(e,t),r)}Clamp(e,t){const r=this.exec.evalExpression(e.args[0],t),a=this.exec.evalExpression(e.args[1],t),h=this.exec.evalExpression(e.args[2],t);if(r instanceof ze&&a instanceof ze&&h instanceof ze)return new ze(r.data.map((B,F)=>this._clamp(B,a.data[F],h.data[F])),r.typeInfo);const y=r,s=a,T=h;return new st(this._clamp(y.value,s.value,T.value),r.typeInfo)}Cos(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ze)return new ze(r.data.map(h=>Math.cos(h)),r.typeInfo);const a=r;return new st(Math.cos(a.value),r.typeInfo)}Cosh(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ze)return new ze(r.data.map(h=>Math.cosh(h)),r.typeInfo);const a=r;return new st(Math.cos(a.value),r.typeInfo)}CountLeadingZeros(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ze)return new ze(r.data.map(h=>Math.clz32(h)),r.typeInfo);const a=r;return new st(Math.clz32(a.value),r.typeInfo)}_countOneBits(e){let t=0;for(;e!==0;)1&e&&t++,e>>=1;return t}CountOneBits(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ze)return new ze(r.data.map(h=>this._countOneBits(h)),r.typeInfo);const a=r;return new st(this._countOneBits(a.value),r.typeInfo)}_countTrailingZeros(e){if(e===0)return 32;let t=0;for(;!(1&e);)e>>=1,t++;return t}CountTrailingZeros(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ze)return new ze(r.data.map(h=>this._countTrailingZeros(h)),r.typeInfo);const a=r;return new st(this._countTrailingZeros(a.value),r.typeInfo)}Cross(e,t){const r=this.exec.evalExpression(e.args[0],t),a=this.exec.evalExpression(e.args[1],t);if(r instanceof ze&&a instanceof ze){if(r.data.length!==3||a.data.length!==3)return console.error(`Cross() expects 3D vectors. Line ${e.line}`),null;const h=r.data,y=a.data;return new ze([h[1]*y[2]-y[1]*h[2],h[2]*y[0]-y[2]*h[0],h[0]*y[1]-y[0]*h[1]],r.typeInfo)}return console.error(`Cross() expects vector arguments. Line ${e.line}`),null}Degrees(e,t){const r=this.exec.evalExpression(e.args[0],t),a=180/Math.PI;return r instanceof ze?new ze(r.data.map(h=>h*a),r.typeInfo):new st(r.value*a,this.getTypeInfo("f32"))}Determinant(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof Bi){const a=r.data,h=r.typeInfo.getTypeName(),y=h.endsWith("h")?this.getTypeInfo("f16"):this.getTypeInfo("f32");if(h==="mat2x2"||h==="mat2x2f"||h==="mat2x2h")return new st(a[0]*a[3]-a[1]*a[2],y);if(h==="mat2x3"||h==="mat2x3f"||h==="mat2x3h")return new st(a[0]*(a[4]*a[8]-a[5]*a[7])-a[1]*(a[3]*a[8]-a[5]*a[6])+a[2]*(a[3]*a[7]-a[4]*a[6]),y);if(h==="mat2x4"||h==="mat2x4f"||h==="mat2x4h")console.error(`TODO: Determinant for ${h}`);else if(h==="mat3x2"||h==="mat3x2f"||h==="mat3x2h")console.error(`TODO: Determinant for ${h}`);else{if(h==="mat3x3"||h==="mat3x3f"||h==="mat3x3h")return new st(a[0]*(a[4]*a[8]-a[5]*a[7])-a[1]*(a[3]*a[8]-a[5]*a[6])+a[2]*(a[3]*a[7]-a[4]*a[6]),y);h==="mat3x4"||h==="mat3x4f"||h==="mat3x4h"||h==="mat4x2"||h==="mat4x2f"||h==="mat4x2h"||h==="mat4x3"||h==="mat4x3f"||h==="mat4x3h"?console.error(`TODO: Determinant for ${h}`):h!=="mat4x4"&&h!=="mat4x4f"&&h!=="mat4x4h"||console.error(`TODO: Determinant for ${h}`)}}return console.error(`Determinant expects a matrix argument. Line ${e.line}`),null}Distance(e,t){const r=this.exec.evalExpression(e.args[0],t),a=this.exec.evalExpression(e.args[1],t);if(r instanceof ze&&a instanceof ze){let s=0;for(let T=0;T<r.data.length;++T)s+=(r.data[T]-a.data[T])*(r.data[T]-a.data[T]);return new st(Math.sqrt(s),this.getTypeInfo("f32"))}const h=r,y=a;return new st(Math.abs(h.value-y.value),r.typeInfo)}_dot(e,t){let r=0;for(let a=0;a<e.length;++a)r+=t[a]*e[a];return r}Dot(e,t){const r=this.exec.evalExpression(e.args[0],t),a=this.exec.evalExpression(e.args[1],t);return r instanceof ze&&a instanceof ze?new st(this._dot(r.data,a.data),this.getTypeInfo("f32")):(console.error(`Dot() expects vector arguments. Line ${e.line}`),null)}Dot4U8Packed(e,t){return console.error(`TODO: dot4U8Packed. Line ${e.line}`),null}Dot4I8Packed(e,t){return console.error(`TODO: dot4I8Packed. Line ${e.line}`),null}Exp(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ze)return new ze(r.data.map(h=>Math.exp(h)),r.typeInfo);const a=r;return new st(Math.exp(a.value),r.typeInfo)}Exp2(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ze)return new ze(r.data.map(h=>Math.pow(2,h)),r.typeInfo);const a=r;return new st(Math.pow(2,a.value),r.typeInfo)}ExtractBits(e,t){const r=this.exec.evalExpression(e.args[0],t),a=this.exec.evalExpression(e.args[1],t),h=this.exec.evalExpression(e.args[2],t);if(a.typeInfo.name!=="u32"&&a.typeInfo.name!=="x32")return console.error(`ExtractBits() expects an i32 offset argument. Line ${e.line}`),null;if(h.typeInfo.name!=="u32"&&h.typeInfo.name!=="x32")return console.error(`ExtractBits() expects an i32 count argument. Line ${e.line}`),null;const y=a.value,s=h.value;if(r instanceof ze)return new ze(r.data.map(B=>B>>y&(1<<s)-1),r.typeInfo);if(r.typeInfo.name!=="i32"&&r.typeInfo.name!=="x32")return console.error(`ExtractBits() expects an i32 argument. Line ${e.line}`),null;const T=r.value;return new st(T>>y&(1<<s)-1,this.getTypeInfo("i32"))}FaceForward(e,t){const r=this.exec.evalExpression(e.args[0],t),a=this.exec.evalExpression(e.args[1],t),h=this.exec.evalExpression(e.args[2],t);if(r instanceof ze&&a instanceof ze&&h instanceof ze){const y=this._dot(a.data,h.data);return new ze(y<0?Array.from(r.data):r.data.map(s=>-s),r.typeInfo)}return console.error(`FaceForward() expects vector arguments. Line ${e.line}`),null}_firstLeadingBit(e){return e===0?-1:31-Math.clz32(e)}FirstLeadingBit(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ze)return new ze(r.data.map(h=>this._firstLeadingBit(h)),r.typeInfo);const a=r;return new st(this._firstLeadingBit(a.value),r.typeInfo)}_firstTrailingBit(e){return e===0?-1:Math.log2(e&-e)}FirstTrailingBit(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ze)return new ze(r.data.map(h=>this._firstTrailingBit(h)),r.typeInfo);const a=r;return new st(this._firstTrailingBit(a.value),r.typeInfo)}Floor(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ze)return new ze(r.data.map(h=>Math.floor(h)),r.typeInfo);const a=r;return new st(Math.floor(a.value),r.typeInfo)}Fma(e,t){const r=this.exec.evalExpression(e.args[0],t),a=this.exec.evalExpression(e.args[1],t),h=this.exec.evalExpression(e.args[2],t);if(r instanceof ze&&a instanceof ze&&h instanceof ze)return r.data.length!==a.data.length||r.data.length!==h.data.length?(console.error(`Fma() expects vectors of the same length. Line ${e.line}`),null):new ze(r.data.map((B,F)=>B*a.data[F]+h.data[F]),r.typeInfo);const y=r,s=a,T=h;return new st(y.value*s.value+T.value,y.typeInfo)}Fract(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ze)return new ze(r.data.map(h=>h-Math.floor(h)),r.typeInfo);const a=r;return new st(a.value-Math.floor(a.value),r.typeInfo)}Frexp(e,t){return console.error(`TODO: frexp. Line ${e.line}`),null}InsertBits(e,t){const r=this.exec.evalExpression(e.args[0],t),a=this.exec.evalExpression(e.args[1],t),h=this.exec.evalExpression(e.args[2],t),y=this.exec.evalExpression(e.args[3],t);if(h.typeInfo.name!=="u32"&&h.typeInfo.name!=="x32")return console.error(`InsertBits() expects an i32 offset argument. Line ${e.line}`),null;const s=h.value,T=(1<<y.value)-1<<s,B=~T;if(r instanceof ze&&a instanceof ze)return new ze(r.data.map((X,se)=>X&B|a.data[se]<<s&T),r.typeInfo);const F=r.value,V=a.value;return new st(F&B|V<<s&T,r.typeInfo)}InverseSqrt(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ze)return new ze(r.data.map(h=>1/Math.sqrt(h)),r.typeInfo);const a=r;return new st(1/Math.sqrt(a.value),r.typeInfo)}Ldexp(e,t){return console.error(`TODO: ldexp. Line ${e.line}`),null}Length(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ze){let h=0;return r.data.forEach(y=>{h+=y*y}),new st(Math.sqrt(h),this.getTypeInfo("f32"))}const a=r;return new st(Math.abs(a.value),r.typeInfo)}Log(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ze)return new ze(r.data.map(h=>Math.log(h)),r.typeInfo);const a=r;return new st(Math.log(a.value),r.typeInfo)}Log2(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ze)return new ze(r.data.map(h=>Math.log2(h)),r.typeInfo);const a=r;return new st(Math.log2(a.value),r.typeInfo)}Max(e,t){const r=this.exec.evalExpression(e.args[0],t),a=this.exec.evalExpression(e.args[1],t);if(r instanceof ze&&a instanceof ze)return new ze(r.data.map((s,T)=>Math.max(s,a.data[T])),r.typeInfo);const h=r,y=a;return new st(Math.max(h.value,y.value),r.typeInfo)}Min(e,t){const r=this.exec.evalExpression(e.args[0],t),a=this.exec.evalExpression(e.args[1],t);if(r instanceof ze&&a instanceof ze)return new ze(r.data.map((s,T)=>Math.min(s,a.data[T])),r.typeInfo);const h=r,y=a;return new st(Math.min(h.value,y.value),r.typeInfo)}Mix(e,t){const r=this.exec.evalExpression(e.args[0],t),a=this.exec.evalExpression(e.args[1],t),h=this.exec.evalExpression(e.args[2],t);if(r instanceof ze&&a instanceof ze&&h instanceof ze)return new ze(r.data.map((T,B)=>r.data[B]*(1-h.data[B])+a.data[B]*h.data[B]),r.typeInfo);const y=a,s=h;return new st(r.value*(1-s.value)+y.value*s.value,r.typeInfo)}Modf(e,t){const r=this.exec.evalExpression(e.args[0],t),a=this.exec.evalExpression(e.args[1],t);if(r instanceof ze&&a instanceof ze)return new ze(r.data.map((y,s)=>y%a.data[s]),r.typeInfo);const h=a;return new st(r.value%h.value,r.typeInfo)}Normalize(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ze){const a=this.Length(e,t).value;return new ze(r.data.map(h=>h/a),r.typeInfo)}return console.error(`Normalize() expects a vector argument. Line ${e.line}`),null}Pow(e,t){const r=this.exec.evalExpression(e.args[0],t),a=this.exec.evalExpression(e.args[1],t);if(r instanceof ze&&a instanceof ze)return new ze(r.data.map((s,T)=>Math.pow(s,a.data[T])),r.typeInfo);const h=r,y=a;return new st(Math.pow(h.value,y.value),r.typeInfo)}QuantizeToF16(e,t){const r=this.exec.evalExpression(e.args[0],t);return r instanceof ze?new ze(r.data.map(a=>a),r.typeInfo):new st(r.value,r.typeInfo)}Radians(e,t){const r=this.exec.evalExpression(e.args[0],t);return r instanceof ze?new ze(r.data.map(a=>a*Math.PI/180),r.typeInfo):new st(r.value*Math.PI/180,this.getTypeInfo("f32"))}Reflect(e,t){let r=this.exec.evalExpression(e.args[0],t),a=this.exec.evalExpression(e.args[1],t);if(r instanceof ze&&a instanceof ze){const h=this._dot(r.data,a.data);return new ze(r.data.map((y,s)=>y-2*h*a.data[s]),r.typeInfo)}return console.error(`Reflect() expects vector arguments. Line ${e.line}`),null}Refract(e,t){let r=this.exec.evalExpression(e.args[0],t),a=this.exec.evalExpression(e.args[1],t),h=this.exec.evalExpression(e.args[2],t);if(r instanceof ze&&a instanceof ze&&h instanceof st){const y=this._dot(a.data,r.data);return new ze(r.data.map((s,T)=>{const B=1-h.value*h.value*(1-y*y);if(B<0)return 0;const F=Math.sqrt(B);return h.value*s-(h.value*y+F)*a.data[T]}),r.typeInfo)}return console.error(`Refract() expects vector arguments and a scalar argument. Line ${e.line}`),null}ReverseBits(e,t){return console.error(`TODO: reverseBits. Line ${e.line}`),null}Round(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ze)return new ze(r.data.map(h=>Math.round(h)),r.typeInfo);const a=r;return new st(Math.round(a.value),r.typeInfo)}Saturate(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ze)return new ze(r.data.map(h=>Math.min(Math.max(h,0),1)),r.typeInfo);const a=r;return new st(Math.min(Math.max(a.value,0),1),r.typeInfo)}Sign(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ze)return new ze(r.data.map(h=>Math.sign(h)),r.typeInfo);const a=r;return new st(Math.sign(a.value),r.typeInfo)}Sin(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ze)return new ze(r.data.map(h=>Math.sin(h)),r.typeInfo);const a=r;return new st(Math.sin(a.value),r.typeInfo)}Sinh(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ze)return new ze(r.data.map(h=>Math.sinh(h)),r.typeInfo);const a=r;return new st(Math.sinh(a.value),r.typeInfo)}_smoothstep(e,t,r){const a=Math.min(Math.max((r-e)/(t-e),0),1);return a*a*(3-2*a)}SmoothStep(e,t){const r=this.exec.evalExpression(e.args[0],t),a=this.exec.evalExpression(e.args[1],t),h=this.exec.evalExpression(e.args[2],t);if(h instanceof ze&&r instanceof ze&&a instanceof ze)return new ze(h.data.map((B,F)=>this._smoothstep(r.data[F],a.data[F],B)),h.typeInfo);const y=r,s=a,T=h;return new st(this._smoothstep(y.value,s.value,T.value),h.typeInfo)}Sqrt(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ze)return new ze(r.data.map(h=>Math.sqrt(h)),r.typeInfo);const a=r;return new st(Math.sqrt(a.value),r.typeInfo)}Step(e,t){const r=this.exec.evalExpression(e.args[0],t),a=this.exec.evalExpression(e.args[1],t);if(a instanceof ze&&r instanceof ze)return new ze(a.data.map((y,s)=>y<r.data[s]?0:1),a.typeInfo);const h=r;return new st(a.value<h.value?0:1,h.typeInfo)}Tan(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ze)return new ze(r.data.map(h=>Math.tan(h)),r.typeInfo);const a=r;return new st(Math.tan(a.value),r.typeInfo)}Tanh(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ze)return new ze(r.data.map(h=>Math.tanh(h)),r.typeInfo);const a=r;return new st(Math.tanh(a.value),r.typeInfo)}_getTransposeType(e){const t=e.getTypeName();return t==="mat2x2f"||t==="mat2x2h"?e:t==="mat2x3f"?this.getTypeInfo("mat3x2f"):t==="mat2x3h"?this.getTypeInfo("mat3x2h"):t==="mat2x4f"?this.getTypeInfo("mat4x2f"):t==="mat2x4h"?this.getTypeInfo("mat4x2h"):t==="mat3x2f"?this.getTypeInfo("mat2x3f"):t==="mat3x2h"?this.getTypeInfo("mat2x3h"):t==="mat3x3f"||t==="mat3x3h"?e:t==="mat3x4f"?this.getTypeInfo("mat4x3f"):t==="mat3x4h"?this.getTypeInfo("mat4x3h"):t==="mat4x2f"?this.getTypeInfo("mat2x4f"):t==="mat4x2h"?this.getTypeInfo("mat2x4h"):t==="mat4x3f"?this.getTypeInfo("mat3x4f"):t==="mat4x3h"?this.getTypeInfo("mat3x4h"):(t==="mat4x4f"||t==="mat4x4h"||console.error(`Invalid matrix type ${t}`),e)}Transpose(e,t){const r=this.exec.evalExpression(e.args[0],t);if(!(r instanceof Bi))return console.error(`Transpose() expects a matrix argument. Line ${e.line}`),null;const a=this._getTransposeType(r.typeInfo);if(r.typeInfo.name==="mat2x2"||r.typeInfo.name==="mat2x2f"||r.typeInfo.name==="mat2x2h"){const h=r.data;return new Bi([h[0],h[2],h[1],h[3]],a)}if(r.typeInfo.name==="mat2x3"||r.typeInfo.name==="mat2x3f"||r.typeInfo.name==="mat2x3h"){const h=r.data;return new Bi([h[0],h[3],h[6],h[1],h[4],h[7]],a)}if(r.typeInfo.name==="mat2x4"||r.typeInfo.name==="mat2x4f"||r.typeInfo.name==="mat2x4h"){const h=r.data;return new Bi([h[0],h[4],h[8],h[12],h[1],h[5],h[9],h[13]],a)}if(r.typeInfo.name==="mat3x2"||r.typeInfo.name==="mat3x2f"||r.typeInfo.name==="mat3x2h"){const h=r.data;return new Bi([h[0],h[3],h[1],h[4],h[2],h[5]],a)}if(r.typeInfo.name==="mat3x3"||r.typeInfo.name==="mat3x3f"||r.typeInfo.name==="mat3x3h"){const h=r.data;return new Bi([h[0],h[3],h[6],h[1],h[4],h[7],h[2],h[5],h[8]],a)}if(r.typeInfo.name==="mat3x4"||r.typeInfo.name==="mat3x4f"||r.typeInfo.name==="mat3x4h"){const h=r.data;return new Bi([h[0],h[4],h[8],h[12],h[1],h[5],h[9],h[13],h[2],h[6],h[10],h[14]],a)}if(r.typeInfo.name==="mat4x2"||r.typeInfo.name==="mat4x2f"||r.typeInfo.name==="mat4x2h"){const h=r.data;return new Bi([h[0],h[4],h[1],h[5],h[2],h[6]],a)}if(r.typeInfo.name==="mat4x3"||r.typeInfo.name==="mat4x3f"||r.typeInfo.name==="mat4x3h"){const h=r.data;return new Bi([h[0],h[4],h[8],h[1],h[5],h[9],h[2],h[6],h[10]],a)}if(r.typeInfo.name==="mat4x4"||r.typeInfo.name==="mat4x4f"||r.typeInfo.name==="mat4x4h"){const h=r.data;return new Bi([h[0],h[4],h[8],h[12],h[1],h[5],h[9],h[13],h[2],h[6],h[10],h[14],h[3],h[7],h[11],h[15]],a)}return console.error(`Invalid matrix type ${r.typeInfo.name}`),null}Trunc(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ze)return new ze(r.data.map(h=>Math.trunc(h)),r.typeInfo);const a=r;return new st(Math.trunc(a.value),r.typeInfo)}Dpdx(e,t){return console.error(`TODO: dpdx. Line ${e.line}`),null}DpdxCoarse(e,t){return console.error(`TODO: dpdxCoarse. Line ${e.line}`),null}DpdxFine(e,t){return console.error("TODO: dpdxFine"),null}Dpdy(e,t){return console.error("TODO: dpdy"),null}DpdyCoarse(e,t){return console.error("TODO: dpdyCoarse"),null}DpdyFine(e,t){return console.error("TODO: dpdyFine"),null}Fwidth(e,t){return console.error("TODO: fwidth"),null}FwidthCoarse(e,t){return console.error("TODO: fwidthCoarse"),null}FwidthFine(e,t){return console.error("TODO: fwidthFine"),null}TextureDimensions(e,t){const r=e.args[0],a=e.args.length>1?this.exec.evalExpression(e.args[1],t).value:0;if(r instanceof js){const h=r.name,y=t.getVariableValue(h);if(y instanceof Ka){if(a<0||a>=y.mipLevelCount)return console.error(`Invalid mip level for textureDimensions. Line ${e.line}`),null;const s=y.getMipLevelSize(a),T=y.dimension;return T==="1d"?new st(s[0],this.getTypeInfo("u32")):T==="3d"?new ze(s,this.getTypeInfo("vec3u")):T==="2d"?new ze(s.slice(0,2),this.getTypeInfo("vec2u")):(console.error(`Invalid texture dimension ${T} not found. Line ${e.line}`),null)}return console.error(`Texture ${h} not found. Line ${e.line}`),null}return console.error(`Invalid texture argument for textureDimensions. Line ${e.line}`),null}TextureGather(e,t){return console.error("TODO: textureGather"),null}TextureGatherCompare(e,t){return console.error("TODO: textureGatherCompare"),null}TextureLoad(e,t){const r=e.args[0],a=this.exec.evalExpression(e.args[1],t),h=e.args.length>2?this.exec.evalExpression(e.args[2],t).value:0;if(!(a instanceof ze)||a.data.length!==2)return console.error(`Invalid UV argument for textureLoad. Line ${e.line}`),null;if(r instanceof js){const y=r.name,s=t.getVariableValue(y);if(s instanceof Ka){const T=Math.floor(a.data[0]),B=Math.floor(a.data[1]);if(T<0||T>=s.width||B<0||B>=s.height)return console.error(`Texture ${y} out of bounds. Line ${e.line}`),null;const F=s.getPixel(T,B,0,h);return F===null?(console.error(`Invalid texture format for textureLoad. Line ${e.line}`),null):new ze(F,this.getTypeInfo("vec4f"))}return console.error(`Texture ${y} not found. Line ${e.line}`),null}return console.error(`Invalid texture argument for textureLoad. Line ${e.line}`),null}TextureNumLayers(e,t){const r=e.args[0];if(r instanceof js){const a=r.name,h=t.getVariableValue(a);return h instanceof Ka?new st(h.depthOrArrayLayers,this.getTypeInfo("u32")):(console.error(`Texture ${a} not found. Line ${e.line}`),null)}return console.error(`Invalid texture argument for textureNumLayers. Line ${e.line}`),null}TextureNumLevels(e,t){const r=e.args[0];if(r instanceof js){const a=r.name,h=t.getVariableValue(a);return h instanceof Ka?new st(h.mipLevelCount,this.getTypeInfo("u32")):(console.error(`Texture ${a} not found. Line ${e.line}`),null)}return console.error(`Invalid texture argument for textureNumLevels. Line ${e.line}`),null}TextureNumSamples(e,t){const r=e.args[0];if(r instanceof js){const a=r.name,h=t.getVariableValue(a);return h instanceof Ka?new st(h.sampleCount,this.getTypeInfo("u32")):(console.error(`Texture ${a} not found. Line ${e.line}`),null)}return console.error(`Invalid texture argument for textureNumSamples. Line ${e.line}`),null}TextureSample(e,t){return console.error("TODO: textureSample"),null}TextureSampleBias(e,t){return console.error("TODO: textureSampleBias"),null}TextureSampleCompare(e,t){return console.error("TODO: textureSampleCompare"),null}TextureSampleCompareLevel(e,t){return console.error("TODO: textureSampleCompareLevel"),null}TextureSampleGrad(e,t){return console.error("TODO: textureSampleGrad"),null}TextureSampleLevel(e,t){return console.error("TODO: textureSampleLevel"),null}TextureSampleBaseClampToEdge(e,t){return console.error("TODO: textureSampleBaseClampToEdge"),null}TextureStore(e,t){const r=e.args[0],a=this.exec.evalExpression(e.args[1],t),h=e.args.length===4?this.exec.evalExpression(e.args[2],t).value:0,y=e.args.length===4?this.exec.evalExpression(e.args[3],t).data:this.exec.evalExpression(e.args[2],t).data;if(y.length!==4)return console.error(`Invalid value argument for textureStore. Line ${e.line}`),null;if(!(a instanceof ze)||a.data.length!==2)return console.error(`Invalid UV argument for textureStore. Line ${e.line}`),null;if(r instanceof js){const s=r.name,T=t.getVariableValue(s);if(T instanceof Ka){const B=T.getMipLevelSize(0),F=Math.floor(a.data[0]),V=Math.floor(a.data[1]);return F<0||F>=B[0]||V<0||V>=B[1]?(console.error(`Texture ${s} out of bounds. Line ${e.line}`),null):(T.setPixel(F,V,0,h,Array.from(y)),null)}return console.error(`Texture ${s} not found. Line ${e.line}`),null}return console.error(`Invalid texture argument for textureStore. Line ${e.line}`),null}AtomicLoad(e,t){let r=e.args[0];r instanceof fn&&(r=r.right);const a=this.exec.getVariableName(r,t);return t.getVariable(a).value.getSubData(this.exec,r.postfix,t)}AtomicStore(e,t){let r=e.args[0];r instanceof fn&&(r=r.right);const a=this.exec.getVariableName(r,t),h=t.getVariable(a);let y=e.args[1];const s=this.exec.evalExpression(y,t),T=h.value.getSubData(this.exec,r.postfix,t);return T instanceof st&&s instanceof st&&(T.value=s.value),h.value instanceof tn&&h.value.setDataValue(this.exec,T,r.postfix,t),null}AtomicAdd(e,t){let r=e.args[0];r instanceof fn&&(r=r.right);const a=this.exec.getVariableName(r,t),h=t.getVariable(a);let y=e.args[1];const s=this.exec.evalExpression(y,t),T=h.value.getSubData(this.exec,r.postfix,t),B=new st(T.value,T.typeInfo);return T instanceof st&&s instanceof st&&(T.value+=s.value),h.value instanceof tn&&h.value.setDataValue(this.exec,T,r.postfix,t),B}AtomicSub(e,t){let r=e.args[0];r instanceof fn&&(r=r.right);const a=this.exec.getVariableName(r,t),h=t.getVariable(a);let y=e.args[1];const s=this.exec.evalExpression(y,t),T=h.value.getSubData(this.exec,r.postfix,t),B=new st(T.value,T.typeInfo);return T instanceof st&&s instanceof st&&(T.value-=s.value),h.value instanceof tn&&h.value.setDataValue(this.exec,T,r.postfix,t),B}AtomicMax(e,t){let r=e.args[0];r instanceof fn&&(r=r.right);const a=this.exec.getVariableName(r,t),h=t.getVariable(a);let y=e.args[1];const s=this.exec.evalExpression(y,t),T=h.value.getSubData(this.exec,r.postfix,t),B=new st(T.value,T.typeInfo);return T instanceof st&&s instanceof st&&(T.value=Math.max(T.value,s.value)),h.value instanceof tn&&h.value.setDataValue(this.exec,T,r.postfix,t),B}AtomicMin(e,t){let r=e.args[0];r instanceof fn&&(r=r.right);const a=this.exec.getVariableName(r,t),h=t.getVariable(a);let y=e.args[1];const s=this.exec.evalExpression(y,t),T=h.value.getSubData(this.exec,r.postfix,t),B=new st(T.value,T.typeInfo);return T instanceof st&&s instanceof st&&(T.value=Math.min(T.value,s.value)),h.value instanceof tn&&h.value.setDataValue(this.exec,T,r.postfix,t),B}AtomicAnd(e,t){let r=e.args[0];r instanceof fn&&(r=r.right);const a=this.exec.getVariableName(r,t),h=t.getVariable(a);let y=e.args[1];const s=this.exec.evalExpression(y,t),T=h.value.getSubData(this.exec,r.postfix,t),B=new st(T.value,T.typeInfo);return T instanceof st&&s instanceof st&&(T.value=T.value&s.value),h.value instanceof tn&&h.value.setDataValue(this.exec,T,r.postfix,t),B}AtomicOr(e,t){let r=e.args[0];r instanceof fn&&(r=r.right);const a=this.exec.getVariableName(r,t),h=t.getVariable(a);let y=e.args[1];const s=this.exec.evalExpression(y,t),T=h.value.getSubData(this.exec,r.postfix,t),B=new st(T.value,T.typeInfo);return T instanceof st&&s instanceof st&&(T.value=T.value|s.value),h.value instanceof tn&&h.value.setDataValue(this.exec,T,r.postfix,t),B}AtomicXor(e,t){let r=e.args[0];r instanceof fn&&(r=r.right);const a=this.exec.getVariableName(r,t),h=t.getVariable(a);let y=e.args[1];const s=this.exec.evalExpression(y,t),T=h.value.getSubData(this.exec,r.postfix,t),B=new st(T.value,T.typeInfo);return T instanceof st&&s instanceof st&&(T.value=T.value^s.value),h.value instanceof tn&&h.value.setDataValue(this.exec,T,r.postfix,t),B}AtomicExchange(e,t){let r=e.args[0];r instanceof fn&&(r=r.right);const a=this.exec.getVariableName(r,t),h=t.getVariable(a);let y=e.args[1];const s=this.exec.evalExpression(y,t),T=h.value.getSubData(this.exec,r.postfix,t),B=new st(T.value,T.typeInfo);return T instanceof st&&s instanceof st&&(T.value=s.value),h.value instanceof tn&&h.value.setDataValue(this.exec,T,r.postfix,t),B}AtomicCompareExchangeWeak(e,t){return console.error("TODO: atomicCompareExchangeWeak"),null}Pack4x8snorm(e,t){return console.error("TODO: pack4x8snorm"),null}Pack4x8unorm(e,t){return console.error("TODO: pack4x8unorm"),null}Pack4xI8(e,t){return console.error("TODO: pack4xI8"),null}Pack4xU8(e,t){return console.error("TODO: pack4xU8"),null}Pack4x8Clamp(e,t){return console.error("TODO: pack4x8Clamp"),null}Pack4xU8Clamp(e,t){return console.error("TODO: pack4xU8Clamp"),null}Pack2x16snorm(e,t){return console.error("TODO: pack2x16snorm"),null}Pack2x16unorm(e,t){return console.error("TODO: pack2x16unorm"),null}Pack2x16float(e,t){return console.error("TODO: pack2x16float"),null}Unpack4x8snorm(e,t){return console.error("TODO: unpack4x8snorm"),null}Unpack4x8unorm(e,t){return console.error("TODO: unpack4x8unorm"),null}Unpack4xI8(e,t){return console.error("TODO: unpack4xI8"),null}Unpack4xU8(e,t){return console.error("TODO: unpack4xU8"),null}Unpack2x16snorm(e,t){return console.error("TODO: unpack2x16snorm"),null}Unpack2x16unorm(e,t){return console.error("TODO: unpack2x16unorm"),null}Unpack2x16float(e,t){return console.error("TODO: unpack2x16float"),null}StorageBarrier(e,t){return null}TextureBarrier(e,t){return null}WorkgroupBarrier(e,t){return null}WorkgroupUniformLoad(e,t){return null}SubgroupAdd(e,t){return console.error("TODO: subgroupAdd"),null}SubgroupExclusiveAdd(e,t){return console.error("TODO: subgroupExclusiveAdd"),null}SubgroupInclusiveAdd(e,t){return console.error("TODO: subgroupInclusiveAdd"),null}SubgroupAll(e,t){return console.error("TODO: subgroupAll"),null}SubgroupAnd(e,t){return console.error("TODO: subgroupAnd"),null}SubgroupAny(e,t){return console.error("TODO: subgroupAny"),null}SubgroupBallot(e,t){return console.error("TODO: subgroupBallot"),null}SubgroupBroadcast(e,t){return console.error("TODO: subgroupBroadcast"),null}SubgroupBroadcastFirst(e,t){return console.error("TODO: subgroupBroadcastFirst"),null}SubgroupElect(e,t){return console.error("TODO: subgroupElect"),null}SubgroupMax(e,t){return console.error("TODO: subgroupMax"),null}SubgroupMin(e,t){return console.error("TODO: subgroupMin"),null}SubgroupMul(e,t){return console.error("TODO: subgroupMul"),null}SubgroupExclusiveMul(e,t){return console.error("TODO: subgroupExclusiveMul"),null}SubgroupInclusiveMul(e,t){return console.error("TODO: subgroupInclusiveMul"),null}SubgroupOr(e,t){return console.error("TODO: subgroupOr"),null}SubgroupShuffle(e,t){return console.error("TODO: subgroupShuffle"),null}SubgroupShuffleDown(e,t){return console.error("TODO: subgroupShuffleDown"),null}SubgroupShuffleUp(e,t){return console.error("TODO: subgroupShuffleUp"),null}SubgroupShuffleXor(e,t){return console.error("TODO: subgroupShuffleXor"),null}SubgroupXor(e,t){return console.error("TODO: subgroupXor"),null}QuadBroadcast(e,t){return console.error("TODO: quadBroadcast"),null}QuadSwapDiagonal(e,t){return console.error("TODO: quadSwapDiagonal"),null}QuadSwapX(e,t){return console.error("TODO: quadSwapX"),null}QuadSwapY(e,t){return console.error("TODO: quadSwapY"),null}}const Wx={vec2:2,vec2f:2,vec2i:2,vec2u:2,vec2b:2,vec2h:2,vec3:3,vec3f:3,vec3i:3,vec3u:3,vec3b:3,vec3h:3,vec4:4,vec4f:4,vec4i:4,vec4u:4,vec4b:4,vec4h:4},xs={mat2x2:[2,2,4],mat2x2f:[2,2,4],mat2x2h:[2,2,4],mat2x3:[2,3,6],mat2x3f:[2,3,6],mat2x3h:[2,3,6],mat2x4:[2,4,8],mat2x4f:[2,4,8],mat2x4h:[2,4,8],mat3x2:[3,2,6],mat3x2f:[3,2,6],mat3x2h:[3,2,6],mat3x3:[3,3,9],mat3x3f:[3,3,9],mat3x3h:[3,3,9],mat3x4:[3,4,12],mat3x4f:[3,4,12],mat3x4h:[3,4,12],mat4x2:[4,2,8],mat4x2f:[4,2,8],mat4x2h:[4,2,8],mat4x3:[4,3,12],mat4x3f:[4,3,12],mat4x3h:[4,3,12],mat4x4:[4,4,16],mat4x4f:[4,4,16],mat4x4h:[4,4,16]};class ss extends aU{constructor(e,t){var r;super(),this.ast=e??[],this.reflection=new xa,this.reflection.updateAST(this.ast),this.context=(r=t==null?void 0:t.clone())!==null&&r!==void 0?r:new Kw,this.builtins=new lU(this),this.typeInfo={bool:this.getTypeInfo(kt.bool),i32:this.getTypeInfo(kt.i32),u32:this.getTypeInfo(kt.u32),f32:this.getTypeInfo(kt.f32),f16:this.getTypeInfo(kt.f16),vec2f:this.getTypeInfo(ht.vec2f),vec2u:this.getTypeInfo(ht.vec2u),vec2i:this.getTypeInfo(ht.vec2i),vec2h:this.getTypeInfo(ht.vec2h),vec3f:this.getTypeInfo(ht.vec3f),vec3u:this.getTypeInfo(ht.vec3u),vec3i:this.getTypeInfo(ht.vec3i),vec3h:this.getTypeInfo(ht.vec3h),vec4f:this.getTypeInfo(ht.vec4f),vec4u:this.getTypeInfo(ht.vec4u),vec4i:this.getTypeInfo(ht.vec4i),vec4h:this.getTypeInfo(ht.vec4h),mat2x2f:this.getTypeInfo(ht.mat2x2f),mat2x3f:this.getTypeInfo(ht.mat2x3f),mat2x4f:this.getTypeInfo(ht.mat2x4f),mat3x2f:this.getTypeInfo(ht.mat3x2f),mat3x3f:this.getTypeInfo(ht.mat3x3f),mat3x4f:this.getTypeInfo(ht.mat3x4f),mat4x2f:this.getTypeInfo(ht.mat4x2f),mat4x3f:this.getTypeInfo(ht.mat4x3f),mat4x4f:this.getTypeInfo(ht.mat4x4f)}}getVariableValue(e){var t,r;const a=(r=(t=this.context.getVariable(e))===null||t===void 0?void 0:t.value)!==null&&r!==void 0?r:null;if(a===null)return null;if(a instanceof st)return a.value;if(a instanceof ze||a instanceof Bi)return Array.from(a.data);if(a instanceof tn&&a.typeInfo instanceof ac){if(a.typeInfo.format.name==="u32")return Array.from(new Uint32Array(a.buffer,a.offset,a.typeInfo.count));if(a.typeInfo.format.name==="i32")return Array.from(new Int32Array(a.buffer,a.offset,a.typeInfo.count));if(a.typeInfo.format.name==="f32")return Array.from(new Float32Array(a.buffer,a.offset,a.typeInfo.count))}return console.error(`Unsupported return variable type ${a.typeInfo.name}`),null}execute(e){(e=e??{}).constants&&this._setOverrides(e.constants,this.context),this._execStatements(this.ast,this.context)}dispatchWorkgroups(e,t,r,a){const h=this.context.clone();(a=a??{}).constants&&this._setOverrides(a.constants,h),this._execStatements(this.ast,h);const y=h.getFunction(e);if(!y)return void console.error(`Function ${e} not found`);if(typeof t=="number")t=[t,1,1];else{if(t.length===0)return void console.error("Invalid dispatch count");t.length===1?t=[t[0],1,1]:t.length===2?t=[t[0],t[1],1]:t.length>3&&(t=[t[0],t[1],t[2]])}const s=t[0],T=t[1],B=t[2],F=this.getTypeInfo("vec3u");h.setVariable("@num_workgroups",new ze(t,F));for(const V in r)for(const X in r[V]){const se=r[V][X];h.variables.forEach(ne=>{var K;const ue=ne.node;if(ue!=null&&ue.attributes){let _e=null,ke=null;for(const we of ue.attributes)we.name==="binding"?_e=we.value:we.name==="group"&&(ke=we.value);if(X==_e&&V==ke)if(se.texture!==void 0&&se.descriptor!==void 0){const we=new Ka(se.texture,this.getTypeInfo(ue.type),se.descriptor,(K=se.texture.view)!==null&&K!==void 0?K:null);ne.value=we}else se.uniform!==void 0?ne.value=new tn(se.uniform,this.getTypeInfo(ue.type)):ne.value=new tn(se,this.getTypeInfo(ue.type))}})}for(let V=0;V<B;++V)for(let X=0;X<T;++X)for(let se=0;se<s;++se)h.setVariable("@workgroup_id",new ze([se,X,V],this.getTypeInfo("vec3u"))),this._dispatchWorkgroup(y,[se,X,V],h)}execStatement(e,t){if(e instanceof AR)return this.evalExpression(e.value,t);if(e instanceof ER){if(e.condition){const r=this.evalExpression(e.condition,t);if(!(r instanceof st))throw new Error("Invalid break-if condition");if(!r.value)return null}return ss._breakObj}if(e instanceof SR)return ss._continueObj;if(e instanceof Jp)this._let(e,t);else if(e instanceof Ja)this._var(e,t);else if(e instanceof Wg)this._const(e,t);else if(e instanceof mm)this._function(e,t);else{if(e instanceof wR)return this._if(e,t);if(e instanceof bR)return this._switch(e,t);if(e instanceof gR)return this._for(e,t);if(e instanceof _R)return this._while(e,t);if(e instanceof xR)return this._loop(e,t);if(e instanceof L1){const r=t.clone();return r.currentFunctionName=t.currentFunctionName,this._execStatements(e.body,r)}if(e instanceof vR)this._assign(e,t);else if(e instanceof yR)this._increment(e,t);else{if(e instanceof Ya)return null;if(e instanceof $w){const r=e.name;t.getVariable(r)===null&&t.setVariable(r,new st(0,this.getTypeInfo("u32")))}else if(e instanceof Ww)this._call(e,t);else{if(e instanceof TR||e instanceof qw)return null;console.error("Invalid statement type.",e,`Line ${e.line}`)}}}return null}evalExpression(e,t){return e instanceof Ho?this._evalBinaryOp(e,t):e instanceof En?this._evalLiteral(e,t):e instanceof js?this._evalVariable(e,t):e instanceof Xw?this._evalCall(e,t):e instanceof ga?this._evalCreate(e,t):e instanceof IR?this._evalConst(e,t):e instanceof CR?this._evalBitcast(e,t):e instanceof fn?this._evalUnaryOp(e,t):(console.error("Invalid expression type",e,`Line ${e.line}`),null)}getTypeInfo(e){var t;if(e instanceof kt){const a=this.reflection.getTypeInfo(e);if(a!==null)return a}let r=(t=this.typeInfo[e])!==null&&t!==void 0?t:null;return r!==null||(r=this.reflection.getTypeInfoByName(e)),r}_setOverrides(e,t){for(const r in e){const a=e[r],h=this.reflection.getOverrideInfo(r);h!==null?(h.type===null&&(h.type=this.getTypeInfo("u32")),h.type.name==="u32"||h.type.name==="i32"||h.type.name==="f32"||h.type.name==="f16"?t.setVariable(r,new st(a,h.type)):h.type.name==="bool"?t.setVariable(r,new st(a?1:0,h.type)):h.type.name==="vec2"||h.type.name==="vec3"||h.type.name==="vec4"||h.type.name==="vec2f"||h.type.name==="vec3f"||h.type.name==="vec4f"||h.type.name==="vec2i"||h.type.name==="vec3i"||h.type.name==="vec4i"||h.type.name==="vec2u"||h.type.name==="vec3u"||h.type.name==="vec4u"||h.type.name==="vec2h"||h.type.name==="vec3h"||h.type.name==="vec4h"?t.setVariable(r,new ze(a,h.type)):console.error(`Invalid constant type for ${r}`)):console.error(`Override ${r} does not exist in the shader.`)}}_dispatchWorkgroup(e,t,r){const a=[1,1,1];for(const F of e.node.attributes)if(F.name==="workgroup_size"){if(F.value.length>0){const V=r.getVariableValue(F.value[0]);a[0]=V instanceof st?V.value:parseInt(F.value[0])}if(F.value.length>1){const V=r.getVariableValue(F.value[1]);a[1]=V instanceof st?V.value:parseInt(F.value[1])}if(F.value.length>2){const V=r.getVariableValue(F.value[2]);a[2]=V instanceof st?V.value:parseInt(F.value[2])}}const h=this.getTypeInfo("vec3u"),y=this.getTypeInfo("u32");r.setVariable("@workgroup_size",new ze(a,h));const s=a[0],T=a[1],B=a[2];for(let F=0,V=0;F<B;++F)for(let X=0;X<T;++X)for(let se=0;se<s;++se,++V){const ne=[se,X,F],K=[se+t[0]*a[0],X+t[1]*a[1],F+t[2]*a[2]];r.setVariable("@local_invocation_id",new ze(ne,h)),r.setVariable("@global_invocation_id",new ze(K,h)),r.setVariable("@local_invocation_index",new st(V,y)),this._dispatchExec(e,r)}}_dispatchExec(e,t){for(const r of e.node.args)for(const a of r.attributes)if(a.name==="builtin"){const h=`@${a.value}`,y=t.getVariable(h);y!==void 0&&t.variables.set(r.name,y)}this._execStatements(e.node.body,t)}getVariableName(e,t){for(;e instanceof fn;)e=e.right;return e instanceof js?e.name:(console.error("Unknown variable type",e,"Line",e.line),null)}_execStatements(e,t){for(const r of e){if(r instanceof Array){const h=t.clone(),y=this._execStatements(r,h);if(y)return y;continue}const a=this.execStatement(r,t);if(a)return a}return null}_call(e,t){const r=t.clone();r.currentFunctionName=e.name;const a=t.getFunction(e.name);if(a){for(let h=0;h<a.node.args.length;++h){const y=a.node.args[h],s=this.evalExpression(e.args[h],r);r.setVariable(y.name,s,y)}this._execStatements(a.node.body,r)}else e.isBuiltin?this._callBuiltinFunction(e,r):this.getTypeInfo(e.name)&&this._evalCreate(e,t)}_increment(e,t){const r=this.getVariableName(e.variable,t),a=t.getVariable(r);a?e.operator==="++"?a.value instanceof st?a.value.value++:console.error(`Variable ${r} is not a scalar. Line ${e.line}`):e.operator==="--"?a.value instanceof st?a.value.value--:console.error(`Variable ${r} is not a scalar. Line ${e.line}`):console.error(`Unknown increment operator ${e.operator}. Line ${e.line}`):console.error(`Variable ${r} not found. Line ${e.line}`)}_getVariableData(e,t){if(e instanceof js){const r=this.getVariableName(e,t),a=t.getVariable(r);return a===null?(console.error(`Variable ${r} not found. Line ${e.line}`),null):a.value.getSubData(this,e.postfix,t)}if(e instanceof fn){if(e.operator==="*"){const r=this._getVariableData(e.right,t);return r instanceof ed?r.reference.getSubData(this,e.postfix,t):(console.error(`Variable ${e.right} is not a pointer. Line ${e.line}`),null)}if(e.operator==="&"){const r=this._getVariableData(e.right,t);return new ed(r)}}return null}_assign(e,t){let r=null,a="<var>",h=null;if(e.variable instanceof fn){const T=this._getVariableData(e.variable,t),B=this.evalExpression(e.value,t),F=e.operator;if(F==="="){if(T instanceof st||T instanceof ze||T instanceof Bi){if(B instanceof st||B instanceof ze||B instanceof Bi&&T.data.length===B.data.length)return void T.data.set(B.data);console.error(`Invalid assignment. Line ${e.line}`)}else if(T instanceof tn&&B instanceof tn&&T.buffer.byteLength-T.offset>=B.buffer.byteLength-B.offset)return void(T.buffer.byteLength%4==0?new Uint32Array(T.buffer,T.offset,T.typeInfo.size/4).set(new Uint32Array(B.buffer,B.offset,B.typeInfo.size/4)):new Uint8Array(T.buffer,T.offset,T.typeInfo.size).set(new Uint8Array(B.buffer,B.offset,B.typeInfo.size)));return console.error(`Invalid assignment. Line ${e.line}`),null}if(F==="+=")return T instanceof st||T instanceof ze||T instanceof Bi?B instanceof st||B instanceof ze||B instanceof Bi?void T.data.set(B.data.map((V,X)=>T.data[X]+V)):void console.error(`Invalid assignment . Line ${e.line}`):void console.error(`Invalid assignment. Line ${e.line}`);if(F==="-=")return(T instanceof st||T instanceof ze||T instanceof Bi)&&(B instanceof st||B instanceof ze||B instanceof Bi)?void T.data.set(B.data.map((V,X)=>T.data[X]-V)):void console.error(`Invalid assignment. Line ${e.line}`)}if(e.variable instanceof fn){if(e.variable.operator==="*"){a=this.getVariableName(e.variable.right,t);const T=t.getVariable(a);if(!(T&&T.value instanceof ed))return void console.error(`Variable ${a} is not a pointer. Line ${e.line}`);r=T.value.reference;let B=e.variable.postfix;if(!B){let F=e.variable.right;for(;F instanceof fn;){if(F.postfix){B=F.postfix;break}F=F.right}}B&&(r=r.getSubData(this,B,t))}}else{h=e.variable.postfix,a=this.getVariableName(e.variable,t);const T=t.getVariable(a);if(T===null)return void console.error(`Variable ${a} not found. Line ${e.line}`);r=T.value}if(r instanceof ed&&(r=r.reference),r===null)return void console.error(`Variable ${a} not found. Line ${e.line}`);const y=this.evalExpression(e.value,t),s=e.operator;if(s==="=")if(r instanceof tn)r.setDataValue(this,y,h,t);else if(h){if(!(r instanceof ze||r instanceof Bi))return void console.error(`Variable ${a} is not a vector or matrix. Line ${e.line}`);if(h instanceof bd){const T=this.evalExpression(h.index,t).value;if(r instanceof ze){if(!(y instanceof st))return void console.error(`Invalid assignment to ${a}. Line ${e.line}`);r.data[T]=y.value}else{if(!(r instanceof Bi))return void console.error(`Invalid assignment to ${a}. Line ${e.line}`);{const B=this.evalExpression(h.index,t).value;if(B<0)return void console.error(`Invalid assignment to ${a}. Line ${e.line}`);if(!(y instanceof ze))return void console.error(`Invalid assignment to ${a}. Line ${e.line}`);{const F=r.typeInfo.getTypeName();if(F==="mat2x2"||F==="mat2x2f"||F==="mat2x2h"){if(!(B<2&&y.data.length===2))return void console.error(`Invalid assignment to ${a}. Line ${e.line}`);r.data[2*B]=y.data[0],r.data[2*B+1]=y.data[1]}else if(F==="mat2x3"||F==="mat2x3f"||F==="mat2x3h"){if(!(B<2&&y.data.length===3))return void console.error(`Invalid assignment to ${a}. Line ${e.line}`);r.data[3*B]=y.data[0],r.data[3*B+1]=y.data[1],r.data[3*B+2]=y.data[2]}else if(F==="mat2x4"||F==="mat2x4f"||F==="mat2x4h"){if(!(B<2&&y.data.length===4))return void console.error(`Invalid assignment to ${a}. Line ${e.line}`);r.data[4*B]=y.data[0],r.data[4*B+1]=y.data[1],r.data[4*B+2]=y.data[2],r.data[4*B+3]=y.data[3]}else if(F==="mat3x2"||F==="mat3x2f"||F==="mat3x2h"){if(!(B<3&&y.data.length===2))return void console.error(`Invalid assignment to ${a}. Line ${e.line}`);r.data[2*B]=y.data[0],r.data[2*B+1]=y.data[1]}else if(F==="mat3x3"||F==="mat3x3f"||F==="mat3x3h"){if(!(B<3&&y.data.length===3))return void console.error(`Invalid assignment to ${a}. Line ${e.line}`);r.data[3*B]=y.data[0],r.data[3*B+1]=y.data[1],r.data[3*B+2]=y.data[2]}else if(F==="mat3x4"||F==="mat3x4f"||F==="mat3x4h"){if(!(B<3&&y.data.length===4))return void console.error(`Invalid assignment to ${a}. Line ${e.line}`);r.data[4*B]=y.data[0],r.data[4*B+1]=y.data[1],r.data[4*B+2]=y.data[2],r.data[4*B+3]=y.data[3]}else if(F==="mat4x2"||F==="mat4x2f"||F==="mat4x2h"){if(!(B<4&&y.data.length===2))return void console.error(`Invalid assignment to ${a}. Line ${e.line}`);r.data[2*B]=y.data[0],r.data[2*B+1]=y.data[1]}else if(F==="mat4x3"||F==="mat4x3f"||F==="mat4x3h"){if(!(B<4&&y.data.length===3))return void console.error(`Invalid assignment to ${a}. Line ${e.line}`);r.data[3*B]=y.data[0],r.data[3*B+1]=y.data[1],r.data[3*B+2]=y.data[2]}else{if(F!=="mat4x4"&&F!=="mat4x4f"&&F!=="mat4x4h")return void console.error(`Invalid assignment to ${a}. Line ${e.line}`);if(!(B<4&&y.data.length===4))return void console.error(`Invalid assignment to ${a}. Line ${e.line}`);r.data[4*B]=y.data[0],r.data[4*B+1]=y.data[1],r.data[4*B+2]=y.data[2],r.data[4*B+3]=y.data[3]}}}}}else if(h instanceof Cu){const T=h.value;if(!(r instanceof ze))return void console.error(`Invalid assignment to ${T}. Variable ${a} is not a vector. Line ${e.line}`);if(y instanceof st){if(T.length>1)return void console.error(`Invalid assignment to ${T} for variable ${a}. Line ${e.line}`);if(T==="x")r.data[0]=y.value;else if(T==="y"){if(r.data.length<2)return void console.error(`Invalid assignment to ${T} for variable ${a}. Line ${e.line}`);r.data[1]=y.value}else if(T==="z"){if(r.data.length<3)return void console.error(`Invalid assignment to ${T} for variable ${a}. Line ${e.line}`);r.data[2]=y.value}else if(T==="w"){if(r.data.length<4)return void console.error(`Invalid assignment to ${T} for variable ${a}. Line ${e.line}`);r.data[3]=y.value}}else{if(!(y instanceof ze))return void console.error(`Invalid assignment to ${a}. Line ${e.line}`);if(T.length!==y.data.length)return void console.error(`Invalid assignment to ${T} for variable ${a}. Line ${e.line}`);for(let B=0;B<T.length;++B){const F=T[B];if(F==="x"||F==="r")r.data[0]=y.data[B];else if(F==="y"||F==="g"){if(y.data.length<2)return void console.error(`Invalid assignment to ${F} for variable ${a}. Line ${e.line}`);r.data[1]=y.data[B]}else if(F==="z"||F==="b"){if(y.data.length<3)return void console.error(`Invalid assignment to ${F} for variable ${a}. Line ${e.line}`);r.data[2]=y.data[B]}else{if(F!=="w"&&F!=="a")return void console.error(`Invalid assignment to ${F} for variable ${a}. Line ${e.line}`);if(y.data.length<4)return void console.error(`Invalid assignment to ${F} for variable ${a}. Line ${e.line}`);r.data[3]=y.data[B]}}}}}else r instanceof st&&y instanceof st?r.value=y.value:r instanceof ze&&y instanceof ze||r instanceof Bi&&y instanceof Bi?r.data.set(y.data):console.error(`Invalid assignment to ${a}. Line ${e.line}`);else{const T=r.getSubData(this,h,t);if(T instanceof ze&&y instanceof st){const B=T.data,F=y.value;if(s==="+=")for(let V=0;V<B.length;++V)B[V]+=F;else if(s==="-=")for(let V=0;V<B.length;++V)B[V]-=F;else if(s==="*=")for(let V=0;V<B.length;++V)B[V]*=F;else if(s==="/=")for(let V=0;V<B.length;++V)B[V]/=F;else if(s==="%=")for(let V=0;V<B.length;++V)B[V]%=F;else if(s==="&=")for(let V=0;V<B.length;++V)B[V]&=F;else if(s==="|=")for(let V=0;V<B.length;++V)B[V]|=F;else if(s==="^=")for(let V=0;V<B.length;++V)B[V]^=F;else if(s==="<<=")for(let V=0;V<B.length;++V)B[V]<<=F;else if(s===">>=")for(let V=0;V<B.length;++V)B[V]>>=F;else console.error(`Invalid operator ${s}. Line ${e.line}`)}else if(T instanceof ze&&y instanceof ze){const B=T.data,F=y.data;if(B.length!==F.length)return void console.error(`Vector length mismatch. Line ${e.line}`);if(s==="+=")for(let V=0;V<B.length;++V)B[V]+=F[V];else if(s==="-=")for(let V=0;V<B.length;++V)B[V]-=F[V];else if(s==="*=")for(let V=0;V<B.length;++V)B[V]*=F[V];else if(s==="/=")for(let V=0;V<B.length;++V)B[V]/=F[V];else if(s==="%=")for(let V=0;V<B.length;++V)B[V]%=F[V];else if(s==="&=")for(let V=0;V<B.length;++V)B[V]&=F[V];else if(s==="|=")for(let V=0;V<B.length;++V)B[V]|=F[V];else if(s==="^=")for(let V=0;V<B.length;++V)B[V]^=F[V];else if(s==="<<=")for(let V=0;V<B.length;++V)B[V]<<=F[V];else if(s===">>=")for(let V=0;V<B.length;++V)B[V]>>=F[V];else console.error(`Invalid operator ${s}. Line ${e.line}`)}else{if(!(T instanceof st&&y instanceof st))return void console.error(`Invalid type for ${e.operator} operator. Line ${e.line}`);s==="+="?T.value+=y.value:s==="-="?T.value-=y.value:s==="*="?T.value*=y.value:s==="/="?T.value/=y.value:s==="%="?T.value%=y.value:s==="&="?T.value&=y.value:s==="|="?T.value|=y.value:s==="^="?T.value^=y.value:s==="<<="?T.value<<=y.value:s===">>="?T.value>>=y.value:console.error(`Invalid operator ${s}. Line ${e.line}`)}r instanceof tn&&r.setDataValue(this,T,h,t)}}_function(e,t){const r=new Yw(e);t.functions.set(e.name,r)}_const(e,t){let r=null;e.value!==null&&(r=this.evalExpression(e.value,t)),t.createVariable(e.name,r,e)}_let(e,t){let r=null;if(e.value!==null){if(r=this.evalExpression(e.value,t),r===null)return void console.error(`Invalid value for variable ${e.name}. Line ${e.line}`);e.value instanceof fn||(r=r.clone())}else{const a=e.type.name;if(a==="f32"||a==="i32"||a==="u32"||a==="bool"||a==="f16"||a==="vec2"||a==="vec3"||a==="vec4"||a==="vec2f"||a==="vec3f"||a==="vec4f"||a==="vec2i"||a==="vec3i"||a==="vec4i"||a==="vec2u"||a==="vec3u"||a==="vec4u"||a==="vec2h"||a==="vec3h"||a==="vec4h"||a==="vec2b"||a==="vec3b"||a==="vec4b"||a==="mat2x2"||a==="mat2x3"||a==="mat2x4"||a==="mat3x2"||a==="mat3x3"||a==="mat3x4"||a==="mat4x2"||a==="mat4x3"||a==="mat4x4"||a==="mat2x2f"||a==="mat2x3f"||a==="mat2x4f"||a==="mat3x2f"||a==="mat3x3f"||a==="mat3x4f"||a==="mat4x2f"||a==="mat4x3f"||a==="mat4x4f"||a==="mat2x2h"||a==="mat2x3h"||a==="mat2x4h"||a==="mat3x2h"||a==="mat3x3h"||a==="mat3x4h"||a==="mat4x2h"||a==="mat4x3h"||a==="mat4x4h"||a==="array"){const h=new ga(e.type,[]);r=this._evalCreate(h,t)}}t.createVariable(e.name,r,e)}_var(e,t){let r=null;if(e.value!==null){if(r=this.evalExpression(e.value,t),r===null)return void console.error(`Invalid value for variable ${e.name}. Line ${e.line}`);e.value instanceof fn||(r=r.clone())}else{if(e.type===null)return void console.error(`Variable ${e.name} has no type. Line ${e.line}`);const a=e.type.name;if(a==="f32"||a==="i32"||a==="u32"||a==="bool"||a==="f16"||a==="vec2"||a==="vec3"||a==="vec4"||a==="vec2f"||a==="vec3f"||a==="vec4f"||a==="vec2i"||a==="vec3i"||a==="vec4i"||a==="vec2u"||a==="vec3u"||a==="vec4u"||a==="vec2h"||a==="vec3h"||a==="vec4h"||a==="vec2b"||a==="vec3b"||a==="vec4b"||a==="mat2x2"||a==="mat2x3"||a==="mat2x4"||a==="mat3x2"||a==="mat3x3"||a==="mat3x4"||a==="mat4x2"||a==="mat4x3"||a==="mat4x4"||a==="mat2x2f"||a==="mat2x3f"||a==="mat2x4f"||a==="mat3x2f"||a==="mat3x3f"||a==="mat3x4f"||a==="mat4x2f"||a==="mat4x3f"||a==="mat4x4f"||a==="mat2x2h"||a==="mat2x3h"||a==="mat2x4h"||a==="mat3x2h"||a==="mat3x3h"||a==="mat3x4h"||a==="mat4x2h"||a==="mat4x3h"||a==="mat4x4h"||e.type instanceof Qp||e.type instanceof Ya||e.type instanceof ht){const h=new ga(e.type,[]);r=this._evalCreate(h,t)}}t.createVariable(e.name,r,e)}_switch(e,t){t=t.clone();const r=this.evalExpression(e.condition,t);if(!(r instanceof st))return console.error(`Invalid if condition. Line ${e.line}`),null;let a=null;for(const h of e.cases)if(h instanceof PR)for(const y of h.selectors){if(y instanceof qg){a=h;continue}const s=this.evalExpression(y,t);if(!(s instanceof st))return console.error(`Invalid case selector. Line ${e.line}`),null;if(s.value===r.value)return this._execStatements(h.body,t)}else h instanceof BR&&(a=h);return a?this._execStatements(a.body,t):null}_if(e,t){t=t.clone();const r=this.evalExpression(e.condition,t);if(!(r instanceof st))return console.error(`Invalid if condition. Line ${e.line}`),null;if(r.value)return this._execStatements(e.body,t);for(const a of e.elseif){const h=this.evalExpression(a.condition,t);if(!(h instanceof st))return console.error(`Invalid if condition. Line ${e.line}`),null;if(h.value)return this._execStatements(a.body,t)}return e.else?this._execStatements(e.else,t):null}_getScalarValue(e){return e instanceof st?e.value:(console.error("Expected scalar value.",e),0)}_for(e,t){for(t=t.clone(),this.execStatement(e.init,t);this._getScalarValue(this.evalExpression(e.condition,t));){const r=this._execStatements(e.body,t);if(r===ss._breakObj)break;if(r!==null&&r!==ss._continueObj)return r;this.execStatement(e.increment,t)}return null}_loop(e,t){for(t=t.clone();;){const r=this._execStatements(e.body,t);if(r===ss._breakObj)break;if(r===ss._continueObj){if(e.continuing&&this._execStatements(e.continuing.body,t)===ss._breakObj)break}else if(r!==null)return r}return null}_while(e,t){for(t=t.clone();this._getScalarValue(this.evalExpression(e.condition,t));){const r=this._execStatements(e.body,t);if(r===ss._breakObj)break;if(r!==ss._continueObj&&r!==null)return r}return null}_evalBitcast(e,t){const r=this.evalExpression(e.value,t),a=e.type;if(r instanceof st){const h=r3(r.value,r.typeInfo.name,a.name);return new st(h,this.getTypeInfo(a))}if(r instanceof ze){const h=r.typeInfo.getTypeName();let y="";if(h.endsWith("f"))y="f32";else if(h.endsWith("i"))y="i32";else if(h.endsWith("u"))y="u32";else if(h.endsWith("b"))y="bool";else{if(!h.endsWith("h"))return console.error(`Unknown vector type ${h}. Line ${e.line}`),null;y="f16"}const s=a.getTypeName();let T="";if(s.endsWith("f"))T="f32";else if(s.endsWith("i"))T="i32";else if(s.endsWith("u"))T="u32";else if(s.endsWith("b"))T="bool";else{if(!s.endsWith("h"))return console.error(`Unknown vector type ${T}. Line ${e.line}`),null;T="f16"}const B=function(F,V,X){if(V===X)return F;const se=new Array(F.length);for(let ne=0;ne<F.length;ne++)se[ne]=r3(F[ne],V,X);return se}(Array.from(r.data),y,T);return new ze(B,this.getTypeInfo(a))}return console.error(`TODO: bitcast for ${r.typeInfo.name}. Line ${e.line}`),null}_evalConst(e,t){return t.getVariableValue(e.name).clone().getSubData(this,e.postfix,t)}_evalCreate(e,t){var r;if(e instanceof ga){if(e.type===null)return N1.void;switch(e.type.getTypeName()){case"bool":case"i32":case"u32":case"f32":case"f16":return this._callConstructorValue(e,t);case"vec2":case"vec3":case"vec4":case"vec2f":case"vec3f":case"vec4f":case"vec2h":case"vec3h":case"vec4h":case"vec2i":case"vec3i":case"vec4i":case"vec2u":case"vec3u":case"vec4u":case"vec2b":case"vec3b":case"vec4b":return this._callConstructorVec(e,t);case"mat2x2":case"mat2x2f":case"mat2x2h":case"mat2x3":case"mat2x3f":case"mat2x3h":case"mat2x4":case"mat2x4f":case"mat2x4h":case"mat3x2":case"mat3x2f":case"mat3x2h":case"mat3x3":case"mat3x3f":case"mat3x3h":case"mat3x4":case"mat3x4f":case"mat3x4h":case"mat4x2":case"mat4x2f":case"mat4x2h":case"mat4x3":case"mat4x3f":case"mat4x3h":case"mat4x4":case"mat4x4f":case"mat4x4h":return this._callConstructorMatrix(e,t)}}const a=e instanceof ga?e.type.name:e.name,h=e instanceof ga?this.getTypeInfo(e.type):this.getTypeInfo(e.name);if(h===null)return console.error(`Unknown type ${a}. Line ${e.line}`),null;if(h.size===0)return null;const y=new tn(new ArrayBuffer(h.size),h,0);if(h instanceof rc){if(e.args)for(let s=0;s<e.args.length;++s){const T=h.members[s],B=e.args[s],F=this.evalExpression(B,t);y.setData(this,F,T.type,T.offset,t)}}else if(h instanceof ac){let s=0;if(e.args)for(let T=0;T<e.args.length;++T){const B=e.args[T],F=this.evalExpression(B,t);h.format===null&&(((r=F.typeInfo)===null||r===void 0?void 0:r.name)==="x32"?h.format=this.getTypeInfo("i32"):h.format=F.typeInfo),y.setData(this,F,h.format,s,t),s+=h.stride}}else console.error(`Unknown type "${a}". Line ${e.line}`);return e instanceof ga?y.getSubData(this,e.postfix,t):y}_evalLiteral(e,t){const r=this.getTypeInfo(e.type),a=r.name;return a==="x32"||a==="u32"||a==="f32"||a==="f16"||a==="i32"||a==="bool"?new st(e.scalarValue,r):a==="vec2"||a==="vec3"||a==="vec4"||a==="vec2f"||a==="vec3f"||a==="vec4f"||a==="vec2h"||a==="vec3h"||a==="vec4h"||a==="vec2i"||a==="vec3i"||a==="vec4i"||a==="vec2u"||a==="vec3u"||a==="vec4u"?this._callConstructorVec(e,t):a==="mat2x2"||a==="mat2x3"||a==="mat2x4"||a==="mat3x2"||a==="mat3x3"||a==="mat3x4"||a==="mat4x2"||a==="mat4x3"||a==="mat4x4"||a==="mat2x2f"||a==="mat2x3f"||a==="mat2x4f"||a==="mat3x2f"||a==="mat3x3f"||a==="mat3x4f"||a==="mat4x2f"||a==="mat4x3f"||a==="mat4x4f"||a==="mat2x2h"||a==="mat2x3h"||a==="mat2x4h"||a==="mat3x2h"||a==="mat3x3h"||a==="mat3x4h"||a==="mat4x2h"||a==="mat4x3h"||a==="mat4x4h"?this._callConstructorMatrix(e,t):e.value}_evalVariable(e,t){const r=t.getVariableValue(e.name);return r===null?r:r.getSubData(this,e.postfix,t)}_maxFormatTypeInfo(e){let t=e[0];if(t.name==="f32")return t;for(let r=1;r<e.length;++r){const a=ss._priority.get(t.name);ss._priority.get(e[r].name)<a&&(t=e[r])}return t.name==="x32"?this.getTypeInfo("i32"):t}_evalUnaryOp(e,t){const r=this.evalExpression(e.right,t);if(e.operator==="&")return new ed(r);if(e.operator==="*")return r instanceof ed?r.reference.getSubData(this,e.postfix,t):(console.error(`Invalid dereference. Line ${e.line}`),null);const a=r instanceof st?r.value:r instanceof ze?Array.from(r.data):null;switch(e.operator){case"+":{if(ri(a)){const s=a.map((T,B)=>+T);return new ze(s,r.typeInfo)}const h=a,y=this._maxFormatTypeInfo([r.typeInfo,r.typeInfo]);return new st(+h,y)}case"-":{if(ri(a)){const s=a.map((T,B)=>-T);return new ze(s,r.typeInfo)}const h=a,y=this._maxFormatTypeInfo([r.typeInfo,r.typeInfo]);return new st(-h,y)}case"!":{if(ri(a)){const s=a.map((T,B)=>T?0:1);return new ze(s,r.typeInfo)}const h=a,y=this._maxFormatTypeInfo([r.typeInfo,r.typeInfo]);return new st(h?0:1,y)}case"~":{if(ri(a)){const s=a.map((T,B)=>~T);return new ze(s,r.typeInfo)}const h=a,y=this._maxFormatTypeInfo([r.typeInfo,r.typeInfo]);return new st(~h,y)}}return console.error(`Invalid unary operator ${e.operator}. Line ${e.line}`),null}_evalBinaryOp(e,t){const r=this.evalExpression(e.left,t),a=this.evalExpression(e.right,t),h=r instanceof st?r.value:r instanceof ze||r instanceof Bi?Array.from(r.data):null,y=a instanceof st?a.value:a instanceof ze||a instanceof Bi?Array.from(a.data):null;switch(e.operator){case"+":{if(ri(h)&&ri(y)){const F=h,V=y;if(F.length!==V.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const X=F.map((se,ne)=>se+V[ne]);return new ze(X,r.typeInfo)}if(ri(h)){const F=y,V=h.map((X,se)=>X+F);return new ze(V,r.typeInfo)}if(ri(y)){const F=h,V=y.map((X,se)=>F+X);return new ze(V,a.typeInfo)}const s=h,T=y,B=this._maxFormatTypeInfo([r.typeInfo,a.typeInfo]);return new st(s+T,B)}case"-":{if(ri(h)&&ri(y)){const F=h,V=y;if(F.length!==V.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const X=F.map((se,ne)=>se-V[ne]);return new ze(X,r.typeInfo)}if(ri(h)){const F=y,V=h.map((X,se)=>X-F);return new ze(V,r.typeInfo)}if(ri(y)){const F=h,V=y.map((X,se)=>F-X);return new ze(V,a.typeInfo)}const s=h,T=y,B=this._maxFormatTypeInfo([r.typeInfo,a.typeInfo]);return new st(s-T,B)}case"*":{if(ri(h)&&ri(y)){const F=h,V=y;if(r instanceof Bi&&a instanceof Bi){const X=function(ue,_e,ke,we){if(xs[_e.name]===void 0||xs[we.name]===void 0)return null;const ge=xs[_e.name][0],Le=xs[_e.name][1],$e=xs[we.name][0];if(ge!==xs[we.name][1])return null;const Ye=new Array($e*Le);for(let St=0;St<Le;St++)for(let Pt=0;Pt<$e;Pt++){let vt=0;for(let yt=0;yt<ge;yt++)vt+=ue[yt*Le+St]*ke[Pt*ge+yt];Ye[St*$e+Pt]=vt}return Ye}(F,r.typeInfo,V,a.typeInfo);if(X===null)return console.error(`Matrix multiplication failed. Line ${e.line}.`),null;const se=xs[a.typeInfo.name][0],ne=xs[r.typeInfo.name][1],K=this.getTypeInfo(`mat${se}x${ne}f`);return new Bi(X,K)}if(r instanceof Bi&&a instanceof ze){const X=function(se,ne,K,ue){if(xs[ne.name]===void 0||Wx[ue.name]===void 0)return null;const _e=xs[ne.name][0],ke=xs[ne.name][1];if(_e!==K.length)return null;const we=new Array(ke);for(let ge=0;ge<ke;ge++){let Le=0;for(let $e=0;$e<_e;$e++)Le+=se[$e*ke+ge]*K[$e];we[ge]=Le}return we}(F,r.typeInfo,V,a.typeInfo);return X===null?(console.error(`Matrix vector multiplication failed. Line ${e.line}.`),null):new ze(X,a.typeInfo)}if(r instanceof ze&&a instanceof Bi){const X=function(se,ne,K,ue){if(Wx[ne.name]===void 0||xs[ue.name]===void 0)return null;const _e=xs[ue.name][0],ke=xs[ue.name][1];if(ke!==se.length)return null;const we=[];for(let ge=0;ge<_e;ge++){let Le=0;for(let $e=0;$e<ke;$e++)Le+=se[$e]*K[$e*_e+ge];we[ge]=Le}return we}(F,r.typeInfo,V,a.typeInfo);return X===null?(console.error(`Matrix vector multiplication failed. Line ${e.line}.`),null):new ze(X,r.typeInfo)}{if(F.length!==V.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const X=F.map((se,ne)=>se*V[ne]);return new ze(X,r.typeInfo)}}if(ri(h)){const F=y,V=h.map((X,se)=>X*F);return r instanceof Bi?new Bi(V,r.typeInfo):new ze(V,r.typeInfo)}if(ri(y)){const F=h,V=y.map((X,se)=>F*X);return a instanceof Bi?new Bi(V,a.typeInfo):new ze(V,a.typeInfo)}const s=h,T=y,B=this._maxFormatTypeInfo([r.typeInfo,a.typeInfo]);return new st(s*T,B)}case"%":{if(ri(h)&&ri(y)){const F=h,V=y;if(F.length!==V.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const X=F.map((se,ne)=>se%V[ne]);return new ze(X,r.typeInfo)}if(ri(h)){const F=y,V=h.map((X,se)=>X%F);return new ze(V,r.typeInfo)}if(ri(y)){const F=h,V=y.map((X,se)=>F%X);return new ze(V,a.typeInfo)}const s=h,T=y,B=this._maxFormatTypeInfo([r.typeInfo,a.typeInfo]);return new st(s%T,B)}case"/":{if(ri(h)&&ri(y)){const F=h,V=y;if(F.length!==V.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const X=F.map((se,ne)=>se/V[ne]);return new ze(X,r.typeInfo)}if(ri(h)){const F=y,V=h.map((X,se)=>X/F);return new ze(V,r.typeInfo)}if(ri(y)){const F=h,V=y.map((X,se)=>F/X);return new ze(V,a.typeInfo)}const s=h,T=y,B=this._maxFormatTypeInfo([r.typeInfo,a.typeInfo]);return new st(s/T,B)}case"&":{if(ri(h)&&ri(y)){const F=h,V=y;if(F.length!==V.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const X=F.map((se,ne)=>se&V[ne]);return new ze(X,r.typeInfo)}if(ri(h)){const F=y,V=h.map((X,se)=>X&F);return new ze(V,r.typeInfo)}if(ri(y)){const F=h,V=y.map((X,se)=>F&X);return new ze(V,a.typeInfo)}const s=h,T=y,B=this._maxFormatTypeInfo([r.typeInfo,a.typeInfo]);return new st(s&T,B)}case"|":{if(ri(h)&&ri(y)){const F=h,V=y;if(F.length!==V.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const X=F.map((se,ne)=>se|V[ne]);return new ze(X,r.typeInfo)}if(ri(h)){const F=y,V=h.map((X,se)=>X|F);return new ze(V,r.typeInfo)}if(ri(y)){const F=h,V=y.map((X,se)=>F|X);return new ze(V,a.typeInfo)}const s=h,T=y,B=this._maxFormatTypeInfo([r.typeInfo,a.typeInfo]);return new st(s|T,B)}case"^":{if(ri(h)&&ri(y)){const F=h,V=y;if(F.length!==V.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const X=F.map((se,ne)=>se^V[ne]);return new ze(X,r.typeInfo)}if(ri(h)){const F=y,V=h.map((X,se)=>X^F);return new ze(V,r.typeInfo)}if(ri(y)){const F=h,V=y.map((X,se)=>F^X);return new ze(V,a.typeInfo)}const s=h,T=y,B=this._maxFormatTypeInfo([r.typeInfo,a.typeInfo]);return new st(s^T,B)}case"<<":{if(ri(h)&&ri(y)){const F=h,V=y;if(F.length!==V.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const X=F.map((se,ne)=>se<<V[ne]);return new ze(X,r.typeInfo)}if(ri(h)){const F=y,V=h.map((X,se)=>X<<F);return new ze(V,r.typeInfo)}if(ri(y)){const F=h,V=y.map((X,se)=>F<<X);return new ze(V,a.typeInfo)}const s=h,T=y,B=this._maxFormatTypeInfo([r.typeInfo,a.typeInfo]);return new st(s<<T,B)}case">>":{if(ri(h)&&ri(y)){const F=h,V=y;if(F.length!==V.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const X=F.map((se,ne)=>se>>V[ne]);return new ze(X,r.typeInfo)}if(ri(h)){const F=y,V=h.map((X,se)=>X>>F);return new ze(V,r.typeInfo)}if(ri(y)){const F=h,V=y.map((X,se)=>F>>X);return new ze(V,a.typeInfo)}const s=h,T=y,B=this._maxFormatTypeInfo([r.typeInfo,a.typeInfo]);return new st(s>>T,B)}case">":if(ri(h)&&ri(y)){const s=h,T=y;if(s.length!==T.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const B=s.map((F,V)=>F>T[V]?1:0);return new ze(B,r.typeInfo)}if(ri(h)){const s=y,T=h.map((B,F)=>B>s?1:0);return new ze(T,r.typeInfo)}if(ri(y)){const s=h,T=y.map((B,F)=>s>B?1:0);return new ze(T,a.typeInfo)}return new st(h>y?1:0,this.getTypeInfo("bool"));case"<":if(ri(h)&&ri(y)){const s=h,T=y;if(s.length!==T.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const B=s.map((F,V)=>F<T[V]?1:0);return new ze(B,r.typeInfo)}if(ri(h)){const s=y,T=h.map((B,F)=>B<s?1:0);return new ze(T,r.typeInfo)}if(ri(y)){const s=h,T=y.map((B,F)=>s<B?1:0);return new ze(T,a.typeInfo)}return new st(h<y?1:0,this.getTypeInfo("bool"));case"==":if(ri(h)&&ri(y)){const s=h,T=y;if(s.length!==T.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const B=s.map((F,V)=>F===T[V]?1:0);return new ze(B,r.typeInfo)}if(ri(h)){const s=y,T=h.map((B,F)=>B==s?1:0);return new ze(T,r.typeInfo)}if(ri(y)){const s=h,T=y.map((B,F)=>s==B?1:0);return new ze(T,a.typeInfo)}return new st(h===y?1:0,this.getTypeInfo("bool"));case"!=":if(ri(h)&&ri(y)){const s=h,T=y;if(s.length!==T.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const B=s.map((F,V)=>F!==T[V]?1:0);return new ze(B,r.typeInfo)}if(ri(h)){const s=y,T=h.map((B,F)=>B!==s?1:0);return new ze(T,r.typeInfo)}if(ri(y)){const s=h,T=y.map((B,F)=>s!==B?1:0);return new ze(T,a.typeInfo)}return new st(h!==y?1:0,this.getTypeInfo("bool"));case">=":if(ri(h)&&ri(y)){const s=h,T=y;if(s.length!==T.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const B=s.map((F,V)=>F>=T[V]?1:0);return new ze(B,r.typeInfo)}if(ri(h)){const s=y,T=h.map((B,F)=>B>=s?1:0);return new ze(T,r.typeInfo)}if(ri(y)){const s=h,T=y.map((B,F)=>s>=B?1:0);return new ze(T,a.typeInfo)}return new st(h>=y?1:0,this.getTypeInfo("bool"));case"<=":if(ri(h)&&ri(y)){const s=h,T=y;if(s.length!==T.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const B=s.map((F,V)=>F<=T[V]?1:0);return new ze(B,r.typeInfo)}if(ri(h)){const s=y,T=h.map((B,F)=>B<=s?1:0);return new ze(T,r.typeInfo)}if(ri(y)){const s=h,T=y.map((B,F)=>s<=B?1:0);return new ze(T,a.typeInfo)}return new st(h<=y?1:0,this.getTypeInfo("bool"));case"&&":if(ri(h)&&ri(y)){const s=h,T=y;if(s.length!==T.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const B=s.map((F,V)=>F&&T[V]?1:0);return new ze(B,r.typeInfo)}if(ri(h)){const s=y,T=h.map((B,F)=>B&&s?1:0);return new ze(T,r.typeInfo)}if(ri(y)){const s=h,T=y.map((B,F)=>s&&B?1:0);return new ze(T,a.typeInfo)}return new st(h&&y?1:0,this.getTypeInfo("bool"));case"||":if(ri(h)&&ri(y)){const s=h,T=y;if(s.length!==T.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const B=s.map((F,V)=>F||T[V]?1:0);return new ze(B,r.typeInfo)}if(ri(h)){const s=y,T=h.map((B,F)=>B||s?1:0);return new ze(T,r.typeInfo)}if(ri(y)){const s=h,T=y.map((B,F)=>s||B?1:0);return new ze(T,a.typeInfo)}return new st(h||y?1:0,this.getTypeInfo("bool"))}return console.error(`Unknown operator ${e.operator}. Line ${e.line}`),null}_evalCall(e,t){if(e.cachedReturnValue!==null)return e.cachedReturnValue;const r=t.clone();r.currentFunctionName=e.name;const a=t.getFunction(e.name);if(!a)return e.isBuiltin?this._callBuiltinFunction(e,r):this.getTypeInfo(e.name)?this._evalCreate(e,t):(console.error(`Unknown function "${e.name}". Line ${e.line}`),null);for(let h=0;h<a.node.args.length;++h){const y=a.node.args[h],s=this.evalExpression(e.args[h],r);r.createVariable(y.name,s,y)}return this._execStatements(a.node.body,r)}_callBuiltinFunction(e,t){switch(e.name){case"all":return this.builtins.All(e,t);case"any":return this.builtins.Any(e,t);case"select":return this.builtins.Select(e,t);case"arrayLength":return this.builtins.ArrayLength(e,t);case"abs":return this.builtins.Abs(e,t);case"acos":return this.builtins.Acos(e,t);case"acosh":return this.builtins.Acosh(e,t);case"asin":return this.builtins.Asin(e,t);case"asinh":return this.builtins.Asinh(e,t);case"atan":return this.builtins.Atan(e,t);case"atanh":return this.builtins.Atanh(e,t);case"atan2":return this.builtins.Atan2(e,t);case"ceil":return this.builtins.Ceil(e,t);case"clamp":return this.builtins.Clamp(e,t);case"cos":return this.builtins.Cos(e,t);case"cosh":return this.builtins.Cosh(e,t);case"countLeadingZeros":return this.builtins.CountLeadingZeros(e,t);case"countOneBits":return this.builtins.CountOneBits(e,t);case"countTrailingZeros":return this.builtins.CountTrailingZeros(e,t);case"cross":return this.builtins.Cross(e,t);case"degrees":return this.builtins.Degrees(e,t);case"determinant":return this.builtins.Determinant(e,t);case"distance":return this.builtins.Distance(e,t);case"dot":return this.builtins.Dot(e,t);case"dot4U8Packed":return this.builtins.Dot4U8Packed(e,t);case"dot4I8Packed":return this.builtins.Dot4I8Packed(e,t);case"exp":return this.builtins.Exp(e,t);case"exp2":return this.builtins.Exp2(e,t);case"extractBits":return this.builtins.ExtractBits(e,t);case"faceForward":return this.builtins.FaceForward(e,t);case"firstLeadingBit":return this.builtins.FirstLeadingBit(e,t);case"firstTrailingBit":return this.builtins.FirstTrailingBit(e,t);case"floor":return this.builtins.Floor(e,t);case"fma":return this.builtins.Fma(e,t);case"fract":return this.builtins.Fract(e,t);case"frexp":return this.builtins.Frexp(e,t);case"insertBits":return this.builtins.InsertBits(e,t);case"inverseSqrt":return this.builtins.InverseSqrt(e,t);case"ldexp":return this.builtins.Ldexp(e,t);case"length":return this.builtins.Length(e,t);case"log":return this.builtins.Log(e,t);case"log2":return this.builtins.Log2(e,t);case"max":return this.builtins.Max(e,t);case"min":return this.builtins.Min(e,t);case"mix":return this.builtins.Mix(e,t);case"modf":return this.builtins.Modf(e,t);case"normalize":return this.builtins.Normalize(e,t);case"pow":return this.builtins.Pow(e,t);case"quantizeToF16":return this.builtins.QuantizeToF16(e,t);case"radians":return this.builtins.Radians(e,t);case"reflect":return this.builtins.Reflect(e,t);case"refract":return this.builtins.Refract(e,t);case"reverseBits":return this.builtins.ReverseBits(e,t);case"round":return this.builtins.Round(e,t);case"saturate":return this.builtins.Saturate(e,t);case"sign":return this.builtins.Sign(e,t);case"sin":return this.builtins.Sin(e,t);case"sinh":return this.builtins.Sinh(e,t);case"smoothStep":return this.builtins.SmoothStep(e,t);case"sqrt":return this.builtins.Sqrt(e,t);case"step":return this.builtins.Step(e,t);case"tan":return this.builtins.Tan(e,t);case"tanh":return this.builtins.Tanh(e,t);case"transpose":return this.builtins.Transpose(e,t);case"trunc":return this.builtins.Trunc(e,t);case"dpdx":return this.builtins.Dpdx(e,t);case"dpdxCoarse":return this.builtins.DpdxCoarse(e,t);case"dpdxFine":return this.builtins.DpdxFine(e,t);case"dpdy":return this.builtins.Dpdy(e,t);case"dpdyCoarse":return this.builtins.DpdyCoarse(e,t);case"dpdyFine":return this.builtins.DpdyFine(e,t);case"fwidth":return this.builtins.Fwidth(e,t);case"fwidthCoarse":return this.builtins.FwidthCoarse(e,t);case"fwidthFine":return this.builtins.FwidthFine(e,t);case"textureDimensions":return this.builtins.TextureDimensions(e,t);case"textureGather":return this.builtins.TextureGather(e,t);case"textureGatherCompare":return this.builtins.TextureGatherCompare(e,t);case"textureLoad":return this.builtins.TextureLoad(e,t);case"textureNumLayers":return this.builtins.TextureNumLayers(e,t);case"textureNumLevels":return this.builtins.TextureNumLevels(e,t);case"textureNumSamples":return this.builtins.TextureNumSamples(e,t);case"textureSample":return this.builtins.TextureSample(e,t);case"textureSampleBias":return this.builtins.TextureSampleBias(e,t);case"textureSampleCompare":return this.builtins.TextureSampleCompare(e,t);case"textureSampleCompareLevel":return this.builtins.TextureSampleCompareLevel(e,t);case"textureSampleGrad":return this.builtins.TextureSampleGrad(e,t);case"textureSampleLevel":return this.builtins.TextureSampleLevel(e,t);case"textureSampleBaseClampToEdge":return this.builtins.TextureSampleBaseClampToEdge(e,t);case"textureStore":return this.builtins.TextureStore(e,t);case"atomicLoad":return this.builtins.AtomicLoad(e,t);case"atomicStore":return this.builtins.AtomicStore(e,t);case"atomicAdd":return this.builtins.AtomicAdd(e,t);case"atomicSub":return this.builtins.AtomicSub(e,t);case"atomicMax":return this.builtins.AtomicMax(e,t);case"atomicMin":return this.builtins.AtomicMin(e,t);case"atomicAnd":return this.builtins.AtomicAnd(e,t);case"atomicOr":return this.builtins.AtomicOr(e,t);case"atomicXor":return this.builtins.AtomicXor(e,t);case"atomicExchange":return this.builtins.AtomicExchange(e,t);case"atomicCompareExchangeWeak":return this.builtins.AtomicCompareExchangeWeak(e,t);case"pack4x8snorm":return this.builtins.Pack4x8snorm(e,t);case"pack4x8unorm":return this.builtins.Pack4x8unorm(e,t);case"pack4xI8":return this.builtins.Pack4xI8(e,t);case"pack4xU8":return this.builtins.Pack4xU8(e,t);case"pack4x8Clamp":return this.builtins.Pack4x8Clamp(e,t);case"pack4xU8Clamp":return this.builtins.Pack4xU8Clamp(e,t);case"pack2x16snorm":return this.builtins.Pack2x16snorm(e,t);case"pack2x16unorm":return this.builtins.Pack2x16unorm(e,t);case"pack2x16float":return this.builtins.Pack2x16float(e,t);case"unpack4x8snorm":return this.builtins.Unpack4x8snorm(e,t);case"unpack4x8unorm":return this.builtins.Unpack4x8unorm(e,t);case"unpack4xI8":return this.builtins.Unpack4xI8(e,t);case"unpack4xU8":return this.builtins.Unpack4xU8(e,t);case"unpack2x16snorm":return this.builtins.Unpack2x16snorm(e,t);case"unpack2x16unorm":return this.builtins.Unpack2x16unorm(e,t);case"unpack2x16float":return this.builtins.Unpack2x16float(e,t);case"storageBarrier":return this.builtins.StorageBarrier(e,t);case"textureBarrier":return this.builtins.TextureBarrier(e,t);case"workgroupBarrier":return this.builtins.WorkgroupBarrier(e,t);case"workgroupUniformLoad":return this.builtins.WorkgroupUniformLoad(e,t);case"subgroupAdd":return this.builtins.SubgroupAdd(e,t);case"subgroupExclusiveAdd":return this.builtins.SubgroupExclusiveAdd(e,t);case"subgroupInclusiveAdd":return this.builtins.SubgroupInclusiveAdd(e,t);case"subgroupAll":return this.builtins.SubgroupAll(e,t);case"subgroupAnd":return this.builtins.SubgroupAnd(e,t);case"subgroupAny":return this.builtins.SubgroupAny(e,t);case"subgroupBallot":return this.builtins.SubgroupBallot(e,t);case"subgroupBroadcast":return this.builtins.SubgroupBroadcast(e,t);case"subgroupBroadcastFirst":return this.builtins.SubgroupBroadcastFirst(e,t);case"subgroupElect":return this.builtins.SubgroupElect(e,t);case"subgroupMax":return this.builtins.SubgroupMax(e,t);case"subgroupMin":return this.builtins.SubgroupMin(e,t);case"subgroupMul":return this.builtins.SubgroupMul(e,t);case"subgroupExclusiveMul":return this.builtins.SubgroupExclusiveMul(e,t);case"subgroupInclusiveMul":return this.builtins.SubgroupInclusiveMul(e,t);case"subgroupOr":return this.builtins.SubgroupOr(e,t);case"subgroupShuffle":return this.builtins.SubgroupShuffle(e,t);case"subgroupShuffleDown":return this.builtins.SubgroupShuffleDown(e,t);case"subgroupShuffleUp":return this.builtins.SubgroupShuffleUp(e,t);case"subgroupShuffleXor":return this.builtins.SubgroupShuffleXor(e,t);case"subgroupXor":return this.builtins.SubgroupXor(e,t);case"quadBroadcast":return this.builtins.QuadBroadcast(e,t);case"quadSwapDiagonal":return this.builtins.QuadSwapDiagonal(e,t);case"quadSwapX":return this.builtins.QuadSwapX(e,t);case"quadSwapY":return this.builtins.QuadSwapY(e,t)}const r=t.getFunction(e.name);if(r){const a=t.clone();for(let h=0;h<r.node.args.length;++h){const y=r.node.args[h],s=this.evalExpression(e.args[h],a);a.setVariable(y.name,s,y)}return this._execStatements(r.node.body,a)}return null}_callConstructorValue(e,t){if(!e.args||e.args.length===0)return new st(0,this.getTypeInfo(e.type));const r=this.evalExpression(e.args[0],t);return r.typeInfo=this.getTypeInfo(e.type),r.getSubData(this,e.postfix,t).clone()}_callConstructorVec(e,t){const r=this.getTypeInfo(e.type),a=e.type.getTypeName(),h=Wx[a];if(h===void 0)return console.error(`Invalid vec constructor ${a}. Line ${e.line}`),null;const y=[];if(e instanceof En)if(e.isVector){const s=e.vectorValue;for(const T of s)y.push(T)}else y.push(e.scalarValue);else if(e.args)for(const s of e.args){const T=this.evalExpression(s,t);if(T instanceof ze){const B=T.data;for(let F=0;F<B.length;++F){let V=B[F];y.push(V)}}else if(T instanceof st){let B=T.value;y.push(B)}}if(e.type instanceof ht&&e.type.format===null&&(e.type.format=ht.f32),y.length===0){const s=new Array(h).fill(0);return new ze(s,r).getSubData(this,e.postfix,t)}if(y.length===1)for(;y.length<h;)y.push(y[0]);return y.length<h?(console.error(`Invalid vec constructor. Line ${e.line}`),null):new ze(y.length>h?y.slice(0,h):y,r).getSubData(this,e.postfix,t)}_callConstructorMatrix(e,t){const r=this.getTypeInfo(e.type),a=e.type.getTypeName(),h=xs[a];if(h===void 0)return console.error(`Invalid matrix constructor ${a}. Line ${e.line}`),null;const y=[];if(e instanceof En)if(e.isVector){const s=e.vectorValue;for(const T of s)y.push(T)}else y.push(e.scalarValue);else if(e.args)for(const s of e.args){const T=this.evalExpression(s,t);T instanceof ze?y.push(...T.data):T instanceof st?y.push(T.value):T instanceof Bi&&y.push(...T.data)}if(r instanceof Iu&&r.format===null&&(r.format=this.getTypeInfo("f32")),y.length===0){const s=new Array(h[2]).fill(0);return new Bi(s,r).getSubData(this,e.postfix,t)}return y.length!==h[2]?(console.error(`Invalid matrix constructor. Line ${e.line}`),null):new Bi(y,r).getSubData(this,e.postfix,t)}}ss._breakObj=new vo(new go("BREAK",null),null),ss._continueObj=new vo(new go("CONTINUE",null),null),ss._priority=new Map([["f32",0],["f16",1],["u32",2],["i32",3],["x32",3]]);class cU{constructor(){this.constants=new Map,this.aliases=new Map,this.structs=new Map}}class uU{constructor(){this._tokens=[],this._current=0,this._currentLine=1,this._deferArrayCountEval=[],this._currentLoop=[],this._context=new cU,this._exec=new ss,this._forwardTypeCount=0}parse(e){this._initialize(e),this._deferArrayCountEval.length=0;const t=[];for(;!this._isAtEnd();){const r=this._global_decl_or_directive();if(!r)break;t.push(r)}if(this._deferArrayCountEval.length>0){for(const r of this._deferArrayCountEval){const a=r.arrayType,h=r.countNode;if(h instanceof js){const y=h.name,s=this._context.constants.get(y);if(s)try{const T=s.constEvaluate(this._exec);a.count=T}catch{}}}this._deferArrayCountEval.length=0}if(this._forwardTypeCount>0)for(const r of t)r.search(a=>{a instanceof t3||a instanceof $x?a.type=this._forwardType(a.type):a instanceof Qp?a.format=this._forwardType(a.format):a instanceof Ja||a instanceof Jp||a instanceof Wg?a.type=this._forwardType(a.type):a instanceof mm?a.returnType=this._forwardType(a.returnType):a instanceof e3&&(a.type=this._forwardType(a.type))});return t}_forwardType(e){if(e instanceof QS){const t=this._getType(e.name);if(t)return t}else e instanceof $x?e.type=this._forwardType(e.type):e instanceof Qp&&(e.format=this._forwardType(e.format));return e}_initialize(e){if(e)if(typeof e=="string"){const t=new Q5(e);this._tokens=t.scanTokens()}else this._tokens=e;else this._tokens=[];this._current=0}_updateNode(e,t){return e.line=t??this._currentLine,e}_error(e,t){return{token:e,message:t,toString:()=>`${t}`}}_isAtEnd(){return this._current>=this._tokens.length||this._peek().type==Ce.eof}_match(e){if(e instanceof lt)return!!this._check(e)&&(this._advance(),!0);for(let t=0,r=e.length;t<r;++t){const a=e[t];if(this._check(a))return this._advance(),!0}return!1}_consume(e,t){if(this._check(e))return this._advance();throw this._error(this._peek(),`${t}. Line:${this._currentLine}`)}_check(e){if(this._isAtEnd())return!1;const t=this._peek();if(e instanceof Array){const r=t.type;let a=!1;for(const h of e){if(r===h)return!0;h===Ce.tokens.name&&(a=!0)}if(a){const h=Ce.tokens.name.rule.exec(t.lexeme);if(h&&h.index==0&&h[0]==t.lexeme)return!0}return!1}if(t.type===e)return!0;if(e===Ce.tokens.name){const r=Ce.tokens.name.rule.exec(t.lexeme);return r&&r.index==0&&r[0]==t.lexeme}return!1}_advance(){var e,t;return this._currentLine=(t=(e=this._peek())===null||e===void 0?void 0:e.line)!==null&&t!==void 0?t:-1,this._isAtEnd()||this._current++,this._previous()}_peek(){return this._tokens[this._current]}_previous(){return this._tokens[this._current-1]}_global_decl_or_directive(){for(;this._match(Ce.tokens.semicolon)&&!this._isAtEnd(););if(this._match(Ce.keywords.alias)){const t=this._type_alias();return this._consume(Ce.tokens.semicolon,"Expected ';'"),this._exec.reflection.updateAST([t]),t}if(this._match(Ce.keywords.diagnostic)){const t=this._diagnostic();return this._consume(Ce.tokens.semicolon,"Expected ';'"),this._exec.reflection.updateAST([t]),t}if(this._match(Ce.keywords.requires)){const t=this._requires_directive();return this._consume(Ce.tokens.semicolon,"Expected ';'"),this._exec.reflection.updateAST([t]),t}if(this._match(Ce.keywords.enable)){const t=this._enable_directive();return this._consume(Ce.tokens.semicolon,"Expected ';'"),this._exec.reflection.updateAST([t]),t}const e=this._attribute();if(this._check(Ce.keywords.var)){const t=this._global_variable_decl();return t!=null&&(t.attributes=e),this._consume(Ce.tokens.semicolon,"Expected ';'."),this._exec.reflection.updateAST([t]),t}if(this._check(Ce.keywords.override)){const t=this._override_variable_decl();return t!=null&&(t.attributes=e),this._consume(Ce.tokens.semicolon,"Expected ';'."),this._exec.reflection.updateAST([t]),t}if(this._check(Ce.keywords.let)){const t=this._global_let_decl();return t!=null&&(t.attributes=e),this._consume(Ce.tokens.semicolon,"Expected ';'."),this._exec.reflection.updateAST([t]),t}if(this._check(Ce.keywords.const)){const t=this._global_const_decl();return t!=null&&(t.attributes=e),this._consume(Ce.tokens.semicolon,"Expected ';'."),this._exec.reflection.updateAST([t]),t}if(this._check(Ce.keywords.struct)){const t=this._struct_decl();return t!=null&&(t.attributes=e),this._exec.reflection.updateAST([t]),t}if(this._check(Ce.keywords.fn)){const t=this._function_decl();return t!=null&&(t.attributes=e),this._exec.reflection.updateAST([t]),t}return null}_function_decl(){if(!this._match(Ce.keywords.fn))return null;const e=this._currentLine,t=this._consume(Ce.tokens.ident,"Expected function name.").toString();this._consume(Ce.tokens.paren_left,"Expected '(' for function arguments.");const r=[];if(!this._check(Ce.tokens.paren_right))do{if(this._check(Ce.tokens.paren_right))break;const s=this._attribute(),T=this._consume(Ce.tokens.name,"Expected argument name.").toString();this._consume(Ce.tokens.colon,"Expected ':' for argument type.");const B=this._attribute(),F=this._type_decl();F!=null&&(F.attributes=B,r.push(this._updateNode(new e3(T,F,s))))}while(this._match(Ce.tokens.comma));this._consume(Ce.tokens.paren_right,"Expected ')' after function arguments.");let a=null;if(this._match(Ce.tokens.arrow)){const s=this._attribute();a=this._type_decl(),a!=null&&(a.attributes=s)}const h=this._compound_statement(),y=this._currentLine;return this._updateNode(new mm(t,r,a,h,e,y),e)}_compound_statement(){const e=[];for(this._consume(Ce.tokens.brace_left,"Expected '{' for block.");!this._check(Ce.tokens.brace_right);){const t=this._statement();t!==null&&e.push(t)}return this._consume(Ce.tokens.brace_right,"Expected '}' for block."),e}_statement(){for(;this._match(Ce.tokens.semicolon)&&!this._isAtEnd(););if(this._check(Ce.tokens.attr)&&this._attribute(),this._check(Ce.keywords.if))return this._if_statement();if(this._check(Ce.keywords.switch))return this._switch_statement();if(this._check(Ce.keywords.loop))return this._loop_statement();if(this._check(Ce.keywords.for))return this._for_statement();if(this._check(Ce.keywords.while))return this._while_statement();if(this._check(Ce.keywords.continuing))return this._continuing_statement();if(this._check(Ce.keywords.static_assert))return this._static_assert_statement();if(this._check(Ce.tokens.brace_left))return this._compound_statement();let e=null;if(this._check(Ce.keywords.return))e=this._return_statement();else if(this._check([Ce.keywords.var,Ce.keywords.let,Ce.keywords.const]))e=this._variable_statement();else if(this._match(Ce.keywords.discard))e=this._updateNode(new Y5);else if(this._match(Ce.keywords.break)){const t=this._updateNode(new ER);if(this._currentLoop.length>0){const r=this._currentLoop[this._currentLoop.length-1];t.loopId=r.id}e=t,this._check(Ce.keywords.if)&&(this._advance(),t.condition=this._optional_paren_expression())}else if(this._match(Ce.keywords.continue)){const t=this._updateNode(new SR);if(!(this._currentLoop.length>0))throw this._error(this._peek(),`Continue statement must be inside a loop. Line: ${t.line}`);{const r=this._currentLoop[this._currentLoop.length-1];t.loopId=r.id}e=t}else e=this._increment_decrement_statement()||this._func_call_statement()||this._assignment_statement();return e!=null&&this._consume(Ce.tokens.semicolon,"Expected ';' after statement."),e}_static_assert_statement(){if(!this._match(Ce.keywords.static_assert))return null;const e=this._currentLine,t=this._optional_paren_expression();return this._updateNode(new q5(t),e)}_while_statement(){if(!this._match(Ce.keywords.while))return null;const e=this._updateNode(new _R(null,null));return this._currentLoop.push(e),e.condition=this._optional_paren_expression(),this._check(Ce.tokens.attr)&&this._attribute(),e.body=this._compound_statement(),this._currentLoop.pop(),e}_continuing_statement(){const e=this._currentLoop.length>0?this._currentLoop[this._currentLoop.length-1].id:-1;if(!this._match(Ce.keywords.continuing))return null;const t=this._currentLine,r=this._compound_statement();return this._updateNode(new L1(r,e),t)}_for_statement(){if(!this._match(Ce.keywords.for))return null;this._consume(Ce.tokens.paren_left,"Expected '('.");const e=this._updateNode(new gR(null,null,null,null));return this._currentLoop.push(e),e.init=this._check(Ce.tokens.semicolon)?null:this._for_init(),this._consume(Ce.tokens.semicolon,"Expected ';'."),e.condition=this._check(Ce.tokens.semicolon)?null:this._short_circuit_or_expression(),this._consume(Ce.tokens.semicolon,"Expected ';'."),e.increment=this._check(Ce.tokens.paren_right)?null:this._for_increment(),this._consume(Ce.tokens.paren_right,"Expected ')'."),this._check(Ce.tokens.attr)&&this._attribute(),e.body=this._compound_statement(),this._currentLoop.pop(),e}_for_init(){return this._variable_statement()||this._func_call_statement()||this._assignment_statement()}_for_increment(){return this._func_call_statement()||this._increment_decrement_statement()||this._assignment_statement()}_variable_statement(){if(this._check(Ce.keywords.var)){const e=this._variable_decl();if(e===null)throw this._error(this._peek(),"Variable declaration expected.");let t=null;return this._match(Ce.tokens.equal)&&(t=this._short_circuit_or_expression()),this._updateNode(new Ja(e.name,e.type,e.storage,e.access,t),e.line)}if(this._match(Ce.keywords.let)){const e=this._currentLine,t=this._consume(Ce.tokens.name,"Expected name for let.").toString();let r=null;if(this._match(Ce.tokens.colon)){const h=this._attribute();r=this._type_decl(),r!=null&&(r.attributes=h)}this._consume(Ce.tokens.equal,"Expected '=' for let.");const a=this._short_circuit_or_expression();return this._updateNode(new Jp(t,r,null,null,a),e)}if(this._match(Ce.keywords.const)){const e=this._currentLine,t=this._consume(Ce.tokens.name,"Expected name for const.").toString();let r=null;if(this._match(Ce.tokens.colon)){const h=this._attribute();r=this._type_decl(),r!=null&&(r.attributes=h)}this._consume(Ce.tokens.equal,"Expected '=' for const.");const a=this._short_circuit_or_expression();return r===null&&a instanceof En&&(r=a.type),this._updateNode(new Wg(t,r,null,null,a),e)}return null}_increment_decrement_statement(){const e=this._current,t=this._unary_expression();if(t==null)return null;if(!this._check(Ce.increment_operators))return this._current=e,null;const r=this._consume(Ce.increment_operators,"Expected increment operator");return this._updateNode(new yR(r.type===Ce.tokens.plus_plus?od.increment:od.decrement,t))}_assignment_statement(){let e=null;const t=this._currentLine;if(this._check(Ce.tokens.brace_right))return null;let r=this._match(Ce.tokens.underscore);if(r||(e=this._unary_expression()),!r&&e==null)return null;const a=this._consume(Ce.assignment_operators,"Expected assignment operator."),h=this._short_circuit_or_expression();return this._updateNode(new vR(Up.parse(a.lexeme),e,h),t)}_func_call_statement(){if(!this._check(Ce.tokens.ident))return null;const e=this._currentLine,t=this._current,r=this._consume(Ce.tokens.ident,"Expected function name."),a=this._argument_expression_list();return a===null?(this._current=t,null):this._updateNode(new Ww(r.lexeme,a),e)}_loop_statement(){if(!this._match(Ce.keywords.loop))return null;this._check(Ce.tokens.attr)&&this._attribute(),this._consume(Ce.tokens.brace_left,"Expected '{' for loop.");const e=this._updateNode(new xR([],null));this._currentLoop.push(e);let t=this._statement();for(;t!==null;){if(Array.isArray(t))for(let r of t)e.body.push(r);else e.body.push(t);if(t instanceof L1){e.continuing=t;break}t=this._statement()}return this._currentLoop.pop(),this._consume(Ce.tokens.brace_right,"Expected '}' for loop."),e}_switch_statement(){if(!this._match(Ce.keywords.switch))return null;const e=this._updateNode(new bR(null,[]));if(this._currentLoop.push(e),e.condition=this._optional_paren_expression(),this._check(Ce.tokens.attr)&&this._attribute(),this._consume(Ce.tokens.brace_left,"Expected '{' for switch."),e.cases=this._switch_body(),e.cases==null||e.cases.length==0)throw this._error(this._previous(),"Expected 'case' or 'default'.");return this._consume(Ce.tokens.brace_right,"Expected '}' for switch."),this._currentLoop.pop(),e}_switch_body(){const e=[];let t=!1;for(;this._check([Ce.keywords.default,Ce.keywords.case]);){if(this._match(Ce.keywords.case)){const r=this._case_selectors();for(const h of r)if(h instanceof qg){if(t)throw this._error(this._previous(),"Multiple default cases in switch statement.");t=!0;break}this._match(Ce.tokens.colon),this._check(Ce.tokens.attr)&&this._attribute(),this._consume(Ce.tokens.brace_left,"Exected '{' for switch case.");const a=this._case_body();this._consume(Ce.tokens.brace_right,"Exected '}' for switch case."),e.push(this._updateNode(new PR(r,a)))}if(this._match(Ce.keywords.default)){if(t)throw this._error(this._previous(),"Multiple default cases in switch statement.");this._match(Ce.tokens.colon),this._check(Ce.tokens.attr)&&this._attribute(),this._consume(Ce.tokens.brace_left,"Exected '{' for switch default.");const r=this._case_body();this._consume(Ce.tokens.brace_right,"Exected '}' for switch default."),e.push(this._updateNode(new BR(r)))}}return e}_case_selectors(){const e=[];for(this._match(Ce.keywords.default)?e.push(this._updateNode(new qg)):e.push(this._shift_expression());this._match(Ce.tokens.comma);)this._match(Ce.keywords.default)?e.push(this._updateNode(new qg)):e.push(this._shift_expression());return e}_case_body(){if(this._match(Ce.keywords.fallthrough))return this._consume(Ce.tokens.semicolon,"Expected ';'"),[];let e=this._statement();if(e==null)return[];e instanceof Array||(e=[e]);const t=this._case_body();return t.length==0?e:[...e,t[0]]}_if_statement(){if(!this._match(Ce.keywords.if))return null;const e=this._currentLine,t=this._optional_paren_expression();this._check(Ce.tokens.attr)&&this._attribute();const r=this._compound_statement();let a=[];this._match_elseif()&&(this._check(Ce.tokens.attr)&&this._attribute(),a=this._elseif_statement(a));let h=null;return this._match(Ce.keywords.else)&&(this._check(Ce.tokens.attr)&&this._attribute(),h=this._compound_statement()),this._updateNode(new wR(t,r,a,h),e)}_match_elseif(){return this._tokens[this._current].type===Ce.keywords.else&&this._tokens[this._current+1].type===Ce.keywords.if&&(this._advance(),this._advance(),!0)}_elseif_statement(e=[]){const t=this._optional_paren_expression(),r=this._compound_statement();return e.push(this._updateNode(new K5(t,r))),this._match_elseif()&&(this._check(Ce.tokens.attr)&&this._attribute(),this._elseif_statement(e)),e}_return_statement(){if(!this._match(Ce.keywords.return))return null;const e=this._short_circuit_or_expression();return this._updateNode(new AR(e))}_short_circuit_or_expression(){let e=this._short_circuit_and_expr();for(;this._match(Ce.tokens.or_or);)e=this._updateNode(new Ho(this._previous().toString(),e,this._short_circuit_and_expr()));return e}_short_circuit_and_expr(){let e=this._inclusive_or_expression();for(;this._match(Ce.tokens.and_and);)e=this._updateNode(new Ho(this._previous().toString(),e,this._inclusive_or_expression()));return e}_inclusive_or_expression(){let e=this._exclusive_or_expression();for(;this._match(Ce.tokens.or);)e=this._updateNode(new Ho(this._previous().toString(),e,this._exclusive_or_expression()));return e}_exclusive_or_expression(){let e=this._and_expression();for(;this._match(Ce.tokens.xor);)e=this._updateNode(new Ho(this._previous().toString(),e,this._and_expression()));return e}_and_expression(){let e=this._equality_expression();for(;this._match(Ce.tokens.and);)e=this._updateNode(new Ho(this._previous().toString(),e,this._equality_expression()));return e}_equality_expression(){const e=this._relational_expression();return this._match([Ce.tokens.equal_equal,Ce.tokens.not_equal])?this._updateNode(new Ho(this._previous().toString(),e,this._relational_expression())):e}_relational_expression(){let e=this._shift_expression();for(;this._match([Ce.tokens.less_than,Ce.tokens.greater_than,Ce.tokens.less_than_equal,Ce.tokens.greater_than_equal]);)e=this._updateNode(new Ho(this._previous().toString(),e,this._shift_expression()));return e}_shift_expression(){let e=this._additive_expression();for(;this._match([Ce.tokens.shift_left,Ce.tokens.shift_right]);)e=this._updateNode(new Ho(this._previous().toString(),e,this._additive_expression()));return e}_additive_expression(){let e=this._multiplicative_expression();for(;this._match([Ce.tokens.plus,Ce.tokens.minus]);)e=this._updateNode(new Ho(this._previous().toString(),e,this._multiplicative_expression()));return e}_multiplicative_expression(){let e=this._unary_expression();for(;this._match([Ce.tokens.star,Ce.tokens.forward_slash,Ce.tokens.modulo]);)e=this._updateNode(new Ho(this._previous().toString(),e,this._unary_expression()));return e}_unary_expression(){return this._match([Ce.tokens.minus,Ce.tokens.bang,Ce.tokens.tilde,Ce.tokens.star,Ce.tokens.and])?this._updateNode(new fn(this._previous().toString(),this._unary_expression())):this._singular_expression()}_singular_expression(){const e=this._primary_expression(),t=this._postfix_expression();return t&&(e.postfix=t),e}_postfix_expression(){if(this._match(Ce.tokens.bracket_left)){const e=this._short_circuit_or_expression();this._consume(Ce.tokens.bracket_right,"Expected ']'.");const t=this._updateNode(new bd(e)),r=this._postfix_expression();return r&&(t.postfix=r),t}if(this._match(Ce.tokens.period)){const e=this._consume(Ce.tokens.name,"Expected member name."),t=this._postfix_expression(),r=this._updateNode(new Cu(e.lexeme));return t&&(r.postfix=t),r}return null}_getStruct(e){return this._context.aliases.has(e)?this._context.aliases.get(e).type:this._context.structs.has(e)?this._context.structs.get(e):null}_getType(e){const t=this._getStruct(e);if(t!==null)return t;switch(e){case"void":return kt.void;case"bool":return kt.bool;case"i32":return kt.i32;case"u32":return kt.u32;case"f32":return kt.f32;case"f16":return kt.f16;case"vec2f":return ht.vec2f;case"vec3f":return ht.vec3f;case"vec4f":return ht.vec4f;case"vec2i":return ht.vec2i;case"vec3i":return ht.vec3i;case"vec4i":return ht.vec4i;case"vec2u":return ht.vec2u;case"vec3u":return ht.vec3u;case"vec4u":return ht.vec4u;case"vec2h":return ht.vec2h;case"vec3h":return ht.vec3h;case"vec4h":return ht.vec4h;case"mat2x2f":return ht.mat2x2f;case"mat2x3f":return ht.mat2x3f;case"mat2x4f":return ht.mat2x4f;case"mat3x2f":return ht.mat3x2f;case"mat3x3f":return ht.mat3x3f;case"mat3x4f":return ht.mat3x4f;case"mat4x2f":return ht.mat4x2f;case"mat4x3f":return ht.mat4x3f;case"mat4x4f":return ht.mat4x4f;case"mat2x2h":return ht.mat2x2h;case"mat2x3h":return ht.mat2x3h;case"mat2x4h":return ht.mat2x4h;case"mat3x2h":return ht.mat3x2h;case"mat3x3h":return ht.mat3x3h;case"mat3x4h":return ht.mat3x4h;case"mat4x2h":return ht.mat4x2h;case"mat4x3h":return ht.mat4x3h;case"mat4x4h":return ht.mat4x4h;case"mat2x2i":return ht.mat2x2i;case"mat2x3i":return ht.mat2x3i;case"mat2x4i":return ht.mat2x4i;case"mat3x2i":return ht.mat3x2i;case"mat3x3i":return ht.mat3x3i;case"mat3x4i":return ht.mat3x4i;case"mat4x2i":return ht.mat4x2i;case"mat4x3i":return ht.mat4x3i;case"mat4x4i":return ht.mat4x4i;case"mat2x2u":return ht.mat2x2u;case"mat2x3u":return ht.mat2x3u;case"mat2x4u":return ht.mat2x4u;case"mat3x2u":return ht.mat3x2u;case"mat3x3u":return ht.mat3x3u;case"mat3x4u":return ht.mat3x4u;case"mat4x2u":return ht.mat4x2u;case"mat4x3u":return ht.mat4x3u;case"mat4x4u":return ht.mat4x4u}return null}_validateTypeRange(e,t){if(t.name==="i32"){if(e<-2147483648||e>2147483647)throw this._error(this._previous(),`Value out of range for i32: ${e}. Line: ${this._currentLine}.`)}else if(t.name==="u32"&&(e<0||e>4294967295))throw this._error(this._previous(),`Value out of range for u32: ${e}. Line: ${this._currentLine}.`)}_primary_expression(){if(this._match(Ce.tokens.ident)){const r=this._previous().toString();if(this._check(Ce.tokens.paren_left)){const a=this._argument_expression_list(),h=this._getType(r);return h!==null?this._updateNode(new ga(h,a)):this._updateNode(new Xw(r,a))}if(this._context.constants.has(r)){const a=this._context.constants.get(r);return this._updateNode(new IR(r,a.value))}return this._updateNode(new js(r))}if(this._match(Ce.tokens.int_literal)){const r=this._previous().toString();let a=r.endsWith("i")||r.endsWith("i")?kt.i32:r.endsWith("u")||r.endsWith("U")?kt.u32:kt.x32;const h=parseInt(r);return this._validateTypeRange(h,a),this._updateNode(new En(new st(h,this._exec.getTypeInfo(a)),a))}if(this._match(Ce.tokens.uint_literal)){const r=parseInt(this._previous().toString());return this._validateTypeRange(r,kt.u32),this._updateNode(new En(new st(r,this._exec.getTypeInfo(kt.u32)),kt.u32))}if(this._match([Ce.tokens.decimal_float_literal,Ce.tokens.hex_float_literal])){let r=this._previous().toString(),a=r.endsWith("h");a&&(r=r.substring(0,r.length-1));const h=parseFloat(r);this._validateTypeRange(h,a?kt.f16:kt.f32);const y=a?kt.f16:kt.f32;return this._updateNode(new En(new st(h,this._exec.getTypeInfo(y)),y))}if(this._match([Ce.keywords.true,Ce.keywords.false])){let r=this._previous().toString()===Ce.keywords.true.rule;return this._updateNode(new En(new st(r?1:0,this._exec.getTypeInfo(kt.bool)),kt.bool))}if(this._check(Ce.tokens.paren_left))return this._paren_expression();if(this._match(Ce.keywords.bitcast)){this._consume(Ce.tokens.less_than,"Expected '<'.");const r=this._type_decl();this._consume(Ce.tokens.greater_than,"Expected '>'.");const a=this._paren_expression();return this._updateNode(new CR(r,a))}const e=this._type_decl(),t=this._argument_expression_list();return this._updateNode(new ga(e,t))}_argument_expression_list(){if(!this._match(Ce.tokens.paren_left))return null;const e=[];do{if(this._check(Ce.tokens.paren_right))break;const t=this._short_circuit_or_expression();e.push(t)}while(this._match(Ce.tokens.comma));return this._consume(Ce.tokens.paren_right,"Expected ')' for agument list"),e}_optional_paren_expression(){this._match(Ce.tokens.paren_left);const e=this._short_circuit_or_expression();return this._match(Ce.tokens.paren_right),e}_paren_expression(){this._consume(Ce.tokens.paren_left,"Expected '('.");const e=this._short_circuit_or_expression();return this._consume(Ce.tokens.paren_right,"Expected ')'."),e}_struct_decl(){if(!this._match(Ce.keywords.struct))return null;const e=this._currentLine,t=this._consume(Ce.tokens.ident,"Expected name for struct.").toString();this._consume(Ce.tokens.brace_left,"Expected '{' for struct body.");const r=[];for(;!this._check(Ce.tokens.brace_right);){const y=this._attribute(),s=this._consume(Ce.tokens.name,"Expected variable name.").toString();this._consume(Ce.tokens.colon,"Expected ':' for struct member type.");const T=this._attribute(),B=this._type_decl();B!=null&&(B.attributes=T),this._check(Ce.tokens.brace_right)?this._match(Ce.tokens.comma):this._consume(Ce.tokens.comma,"Expected ',' for struct member."),r.push(this._updateNode(new t3(s,B,y)))}this._consume(Ce.tokens.brace_right,"Expected '}' after struct body.");const a=this._currentLine,h=this._updateNode(new Ya(t,r,e,a),e);return this._context.structs.set(t,h),h}_global_variable_decl(){const e=this._variable_decl();if(!e)return null;if(this._match(Ce.tokens.equal)){const t=this._const_expression();e.value=t}if(e.type!==null&&e.value instanceof En){if(e.value.type.name!=="x32"&&e.type.getTypeName()!==e.value.type.getTypeName())throw this._error(this._peek(),`Invalid cast from ${e.value.type.name} to ${e.type.name}. Line:${this._currentLine}`);e.value.isScalar&&this._validateTypeRange(e.value.scalarValue,e.type),e.value.type=e.type}else e.type===null&&e.value instanceof En&&(e.type=e.value.type.name==="x32"?kt.i32:e.value.type,e.value.isScalar&&this._validateTypeRange(e.value.scalarValue,e.type));return e}_override_variable_decl(){const e=this._override_decl();return e&&this._match(Ce.tokens.equal)&&(e.value=this._const_expression()),e}_global_const_decl(){var e;if(!this._match(Ce.keywords.const))return null;const t=this._consume(Ce.tokens.name,"Expected variable name"),r=this._currentLine;let a=null;if(this._match(Ce.tokens.colon)){const T=this._attribute();a=this._type_decl(),a!=null&&(a.attributes=T)}let h=null;this._consume(Ce.tokens.equal,"const declarations require an assignment");const y=this._short_circuit_or_expression();try{let T=[kt.f32],B=y.constEvaluate(this._exec,T);B instanceof st&&this._validateTypeRange(B.value,T[0]),T[0]instanceof ht&&T[0].format===null&&B.typeInfo instanceof Iu&&B.typeInfo.format!==null&&(B.typeInfo.format.name==="f16"?T[0].format=kt.f16:B.typeInfo.format.name==="f32"?T[0].format=kt.f32:B.typeInfo.format.name==="i32"?T[0].format=kt.i32:B.typeInfo.format.name==="u32"?T[0].format=kt.u32:B.typeInfo.format.name==="bool"?T[0].format=kt.bool:console.error(`TODO: impelement template format type ${B.typeInfo.format.name}`)),h=this._updateNode(new En(B,T[0])),this._exec.context.setVariable(t.toString(),B)}catch{h=y}if(a!==null&&h instanceof En){if(h.type.name!=="x32"&&a.getTypeName()!==h.type.getTypeName())throw this._error(this._peek(),`Invalid cast from ${h.type.name} to ${a.name}. Line:${this._currentLine}`);h.type=a,h.isScalar&&this._validateTypeRange(h.scalarValue,h.type)}else a===null&&h instanceof En&&(a=(e=h==null?void 0:h.type)!==null&&e!==void 0?e:kt.f32,a===kt.x32&&(a=kt.i32));const s=this._updateNode(new Wg(t.toString(),a,"","",h),r);return this._context.constants.set(s.name,s),s}_global_let_decl(){if(!this._match(Ce.keywords.let))return null;const e=this._currentLine,t=this._consume(Ce.tokens.name,"Expected variable name");let r=null;if(this._match(Ce.tokens.colon)){const h=this._attribute();r=this._type_decl(),r!=null&&(r.attributes=h)}let a=null;if(this._match(Ce.tokens.equal)&&(a=this._const_expression()),r!==null&&a instanceof En){if(a.type.name!=="x32"&&r.getTypeName()!==a.type.getTypeName())throw this._error(this._peek(),`Invalid cast from ${a.type.name} to ${r.name}. Line:${this._currentLine}`);a.type=r}else r===null&&a instanceof En&&(r=a.type.name==="x32"?kt.i32:a.type);return a instanceof En&&a.isScalar&&this._validateTypeRange(a.scalarValue,r),this._updateNode(new Jp(t.toString(),r,"","",a),e)}_const_expression(){return this._short_circuit_or_expression()}_variable_decl(){if(!this._match(Ce.keywords.var))return null;const e=this._currentLine;let t="",r="";this._match(Ce.tokens.less_than)&&(t=this._consume(Ce.storage_class,"Expected storage_class.").toString(),this._match(Ce.tokens.comma)&&(r=this._consume(Ce.access_mode,"Expected access_mode.").toString()),this._consume(Ce.tokens.greater_than,"Expected '>'."));const a=this._consume(Ce.tokens.name,"Expected variable name");let h=null;if(this._match(Ce.tokens.colon)){const y=this._attribute();h=this._type_decl(),h!=null&&(h.attributes=y)}return this._updateNode(new Ja(a.toString(),h,t,r,null),e)}_override_decl(){if(!this._match(Ce.keywords.override))return null;const e=this._consume(Ce.tokens.name,"Expected variable name");let t=null;if(this._match(Ce.tokens.colon)){const r=this._attribute();t=this._type_decl(),t!=null&&(t.attributes=r)}return this._updateNode(new $w(e.toString(),t,null))}_diagnostic(){this._consume(Ce.tokens.paren_left,"Expected '('");const e=this._consume(Ce.tokens.ident,"Expected severity control name.");this._consume(Ce.tokens.comma,"Expected ','");let t=this._consume(Ce.tokens.ident,"Expected diagnostic rule name.").toString();return this._match(Ce.tokens.period)&&(t+=`.${this._consume(Ce.tokens.ident,"Expected diagnostic message.").toString()}`),this._consume(Ce.tokens.paren_right,"Expected ')'"),this._updateNode(new TR(e.toString(),t))}_enable_directive(){const e=this._consume(Ce.tokens.ident,"identity expected.");return this._updateNode(new X5(e.toString()))}_requires_directive(){const e=[this._consume(Ce.tokens.ident,"identity expected.").toString()];for(;this._match(Ce.tokens.comma);){const t=this._consume(Ce.tokens.ident,"identity expected.");e.push(t.toString())}return this._updateNode(new Z5(e))}_type_alias(){const e=this._consume(Ce.tokens.ident,"identity expected.");this._consume(Ce.tokens.equal,"Expected '=' for type alias.");let t=this._type_decl();if(t===null)throw this._error(this._peek(),"Expected Type for Alias.");this._context.aliases.has(t.name)&&(t=this._context.aliases.get(t.name).type);const r=this._updateNode(new qw(e.toString(),t));return this._context.aliases.set(r.name,r),r}_type_decl(){if(this._check([Ce.tokens.ident,...Ce.texel_format,Ce.keywords.bool,Ce.keywords.f32,Ce.keywords.i32,Ce.keywords.u32])){const r=this._advance().toString();if(this._context.structs.has(r))return this._context.structs.get(r);if(this._context.aliases.has(r))return this._context.aliases.get(r).type;if(!this._getType(r)){const a=this._updateNode(new QS(r));return this._forwardTypeCount++,a}return this._updateNode(new kt(r))}let e=this._texture_sampler_types();if(e)return e;if(this._check(Ce.template_types)){let r=this._advance().toString(),a=null,h=null;return this._match(Ce.tokens.less_than)&&(a=this._type_decl(),h=null,this._match(Ce.tokens.comma)&&(h=this._consume(Ce.access_mode,"Expected access_mode for pointer").toString()),this._consume(Ce.tokens.greater_than,"Expected '>' for type.")),this._updateNode(new ht(r,a,h))}if(this._match(Ce.keywords.ptr)){let r=this._previous().toString();this._consume(Ce.tokens.less_than,"Expected '<' for pointer.");const a=this._consume(Ce.storage_class,"Expected storage_class for pointer");this._consume(Ce.tokens.comma,"Expected ',' for pointer.");const h=this._type_decl();let y=null;return this._match(Ce.tokens.comma)&&(y=this._consume(Ce.access_mode,"Expected access_mode for pointer").toString()),this._consume(Ce.tokens.greater_than,"Expected '>' for pointer."),this._updateNode(new $x(r,a.toString(),h,y))}const t=this._attribute();if(this._match(Ce.keywords.array)){let r=null,a=-1;const h=this._previous();let y=null;if(this._match(Ce.tokens.less_than)){r=this._type_decl(),this._context.aliases.has(r.name)&&(r=this._context.aliases.get(r.name).type);let T="";if(this._match(Ce.tokens.comma)){y=this._shift_expression();try{T=y.constEvaluate(this._exec).toString(),y=null}catch{T="1"}}this._consume(Ce.tokens.greater_than,"Expected '>' for array."),a=T?parseInt(T):0}const s=this._updateNode(new Qp(h.toString(),t,r,a));return y&&this._deferArrayCountEval.push({arrayType:s,countNode:y}),s}return null}_texture_sampler_types(){if(this._match(Ce.sampler_type))return this._updateNode(new Vp(this._previous().toString(),null,null));if(this._match(Ce.depth_texture_type))return this._updateNode(new Vp(this._previous().toString(),null,null));if(this._match(Ce.sampled_texture_type)||this._match(Ce.multisampled_texture_type)){const e=this._previous();this._consume(Ce.tokens.less_than,"Expected '<' for sampler type.");const t=this._type_decl();return this._consume(Ce.tokens.greater_than,"Expected '>' for sampler type."),this._updateNode(new Vp(e.toString(),t,null))}if(this._match(Ce.storage_texture_type)){const e=this._previous();this._consume(Ce.tokens.less_than,"Expected '<' for sampler type.");const t=this._consume(Ce.texel_format,"Invalid texel format.").toString();this._consume(Ce.tokens.comma,"Expected ',' after texel format.");const r=this._consume(Ce.access_mode,"Expected access mode for storage texture type.").toString();return this._consume(Ce.tokens.greater_than,"Expected '>' for sampler type."),this._updateNode(new Vp(e.toString(),t,r))}return null}_attribute(){let e=[];for(;this._match(Ce.tokens.attr);){const t=this._consume(Ce.attribute_name,"Expected attribute name"),r=this._updateNode(new DR(t.toString(),null));if(this._match(Ce.tokens.paren_left)){if(r.value=this._consume(Ce.literal_or_ident,"Expected attribute value").toString(),this._check(Ce.tokens.comma)){this._advance();do{const a=this._consume(Ce.literal_or_ident,"Expected attribute value").toString();r.value instanceof Array||(r.value=[r.value]),r.value.push(a)}while(this._match(Ce.tokens.comma))}this._consume(Ce.tokens.paren_right,"Expected ')'")}e.push(r)}return e.length==0?null:e}}class hU extends xa{constructor(e){super(),e&&this.update(e)}update(e){const t=new uU().parse(e);this.updateAST(t)}}function dU(i){var h;const e={attributes:[],bindings:[]};let t;try{t=fU(i)}catch(y){return Gt.error(y.message)(),e}for(const y of t.uniforms){const s=[];for(const T of((h=y.type)==null?void 0:h.members)||[])s.push({name:T.name,type:n3(T.type)});e.bindings.push({type:"uniform",name:y.name,group:y.group,location:y.binding,members:s})}for(const y of t.textures)e.bindings.push({type:"texture",name:y.name,group:y.group,location:y.binding});for(const y of t.samplers)e.bindings.push({type:"sampler",name:y.name,group:y.group,location:y.binding});const r=t.entry.vertex[0],a=(r==null?void 0:r.inputs.length)||0;for(let y=0;y<a;y++){const s=r.inputs[y];if(s.locationType==="location"){const T=n3(s.type);e.attributes.push({name:s.name,location:Number(s.location),type:T})}}return e}function n3(i){return i.format?`${i.name}<${i.format.name}>`:i.name}function fU(i){try{return new hU(i)}catch(e){if(e instanceof Error)throw e;let t="WGSL parse error";throw typeof e=="object"&&(e!=null&&e.message)&&(t+=`: ${e.message} `),typeof e=="object"&&(e!=null&&e.token)&&(t+=e.token.line||""),new Error(t,{cause:e})}}const pU={EPSILON:1e-12,debug:!1,precision:4,printTypes:!1,printDegrees:!1,printRowMajor:!0,_cartographicRadians:!1};globalThis.mathgl=globalThis.mathgl||{config:{...pU}};const Rs=globalThis.mathgl.config;function mU(i,{precision:e=Rs.precision}={}){return i=_U(i),`${parseFloat(i.toPrecision(e))}`}function Mu(i){return Array.isArray(i)||ArrayBuffer.isView(i)&&!(i instanceof DataView)}function ba(i,e,t){return yU(i,r=>Math.max(e,Math.min(t,r)))}function Cy(i,e,t){return Mu(i)?i.map((r,a)=>Cy(r,e[a],t)):t*e+(1-t)*i}function _m(i,e,t){const r=Rs.EPSILON;try{if(i===e)return!0;if(Mu(i)&&Mu(e)){if(i.length!==e.length)return!1;for(let a=0;a<i.length;++a)if(!_m(i[a],e[a]))return!1;return!0}return i&&i.equals?i.equals(e):e&&e.equals?e.equals(i):typeof i=="number"&&typeof e=="number"?Math.abs(i-e)<=Rs.EPSILON*Math.max(1,Math.abs(i),Math.abs(e)):!1}finally{Rs.EPSILON=r}}function _U(i){return Math.round(i/Rs.EPSILON)*Rs.EPSILON}function gU(i){return i.clone?i.clone():new Array(i.length)}function yU(i,e,t){if(Mu(i)){const r=i;t=t||gU(r);for(let a=0;a<t.length&&a<r.length;++a){const h=typeof i=="number"?i:i[a];t[a]=e(h,a,t)}return t}return e(i)}class Jw extends Array{clone(){return new this.constructor().copy(this)}fromArray(e,t=0){for(let r=0;r<this.ELEMENTS;++r)this[r]=e[r+t];return this.check()}toArray(e=[],t=0){for(let r=0;r<this.ELEMENTS;++r)e[t+r]=this[r];return e}toObject(e){return e}from(e){return Array.isArray(e)?this.copy(e):this.fromObject(e)}to(e){return e===this?this:Mu(e)?this.toArray(e):this.toObject(e)}toTarget(e){return e?this.to(e):this}toFloat32Array(){return new Float32Array(this)}toString(){return this.formatString(Rs)}formatString(e){let t="";for(let r=0;r<this.ELEMENTS;++r)t+=(r>0?", ":"")+mU(this[r],e);return`${e.printTypes?this.constructor.name:""}[${t}]`}equals(e){if(!e||this.length!==e.length)return!1;for(let t=0;t<this.ELEMENTS;++t)if(!_m(this[t],e[t]))return!1;return!0}exactEquals(e){if(!e||this.length!==e.length)return!1;for(let t=0;t<this.ELEMENTS;++t)if(this[t]!==e[t])return!1;return!0}negate(){for(let e=0;e<this.ELEMENTS;++e)this[e]=-this[e];return this.check()}lerp(e,t,r){if(r===void 0)return this.lerp(this,e,t);for(let a=0;a<this.ELEMENTS;++a){const h=e[a],y=typeof t=="number"?t:t[a];this[a]=h+r*(y-h)}return this.check()}min(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=Math.min(e[t],this[t]);return this.check()}max(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=Math.max(e[t],this[t]);return this.check()}clamp(e,t){for(let r=0;r<this.ELEMENTS;++r)this[r]=Math.min(Math.max(this[r],e[r]),t[r]);return this.check()}add(...e){for(const t of e)for(let r=0;r<this.ELEMENTS;++r)this[r]+=t[r];return this.check()}subtract(...e){for(const t of e)for(let r=0;r<this.ELEMENTS;++r)this[r]-=t[r];return this.check()}scale(e){if(typeof e=="number")for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;else for(let t=0;t<this.ELEMENTS&&t<e.length;++t)this[t]*=e[t];return this.check()}multiplyByScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;return this.check()}check(){if(Rs.debug&&!this.validate())throw new Error(`math.gl: ${this.constructor.name} some fields set to invalid numbers'`);return this}validate(){let e=this.length===this.ELEMENTS;for(let t=0;t<this.ELEMENTS;++t)e=e&&Number.isFinite(this[t]);return e}sub(e){return this.subtract(e)}setScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=e;return this.check()}addScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]+=e;return this.check()}subScalar(e){return this.addScalar(-e)}multiplyScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;return this.check()}divideScalar(e){return this.multiplyByScalar(1/e)}clampScalar(e,t){for(let r=0;r<this.ELEMENTS;++r)this[r]=Math.min(Math.max(this[r],e),t);return this.check()}get elements(){return this}}function vU(i,e){if(i.length!==e)return!1;for(let t=0;t<i.length;++t)if(!Number.isFinite(i[t]))return!1;return!0}function Pr(i){if(!Number.isFinite(i))throw new Error(`Invalid number ${JSON.stringify(i)}`);return i}function em(i,e,t=""){if(Rs.debug&&!vU(i,e))throw new Error(`math.gl: ${t} some fields set to invalid numbers'`);return i}function s3(i,e){if(!i)throw new Error(`math.gl assertion ${e}`)}class OR extends Jw{get x(){return this[0]}set x(e){this[0]=Pr(e)}get y(){return this[1]}set y(e){this[1]=Pr(e)}len(){return Math.sqrt(this.lengthSquared())}magnitude(){return this.len()}lengthSquared(){let e=0;for(let t=0;t<this.ELEMENTS;++t)e+=this[t]*this[t];return e}magnitudeSquared(){return this.lengthSquared()}distance(e){return Math.sqrt(this.distanceSquared(e))}distanceSquared(e){let t=0;for(let r=0;r<this.ELEMENTS;++r){const a=this[r]-e[r];t+=a*a}return Pr(t)}dot(e){let t=0;for(let r=0;r<this.ELEMENTS;++r)t+=this[r]*e[r];return Pr(t)}normalize(){const e=this.magnitude();if(e!==0)for(let t=0;t<this.ELEMENTS;++t)this[t]/=e;return this.check()}multiply(...e){for(const t of e)for(let r=0;r<this.ELEMENTS;++r)this[r]*=t[r];return this.check()}divide(...e){for(const t of e)for(let r=0;r<this.ELEMENTS;++r)this[r]/=t[r];return this.check()}lengthSq(){return this.lengthSquared()}distanceTo(e){return this.distance(e)}distanceToSquared(e){return this.distanceSquared(e)}getComponent(e){return s3(e>=0&&e<this.ELEMENTS,"index is out of range"),Pr(this[e])}setComponent(e,t){return s3(e>=0&&e<this.ELEMENTS,"index is out of range"),this[e]=t,this.check()}addVectors(e,t){return this.copy(e).add(t)}subVectors(e,t){return this.copy(e).subtract(t)}multiplyVectors(e,t){return this.copy(e).multiply(t)}addScaledVector(e,t){return this.add(new this.constructor(e).multiplyScalar(t))}}const tm=1e-6;let Ko=typeof Float32Array<"u"?Float32Array:Array;function xU(){const i=new Ko(2);return Ko!=Float32Array&&(i[0]=0,i[1]=0),i}function o3(i,e,t){return i[0]=e[0]+t[0],i[1]=e[1]+t[1],i}function bU(i,e){return i[0]=-e[0],i[1]=-e[1],i}function FR(i,e,t,r){const a=e[0],h=e[1];return i[0]=a+r*(t[0]-a),i[1]=h+r*(t[1]-h),i}function wU(i,e,t){const r=e[0],a=e[1];return i[0]=t[0]*r+t[3]*a+t[6],i[1]=t[1]*r+t[4]*a+t[7],i}function AU(i,e,t){const r=e[0],a=e[1];return i[0]=t[0]*r+t[4]*a+t[12],i[1]=t[1]*r+t[5]*a+t[13],i}(function(){const i=xU();return function(e,t,r,a,h,y){let s,T;for(t||(t=2),r||(r=0),a?T=Math.min(a*t+r,e.length):T=e.length,s=r;s<T;s+=t)i[0]=e[s],i[1]=e[s+1],h(i,i,y),e[s]=i[0],e[s+1]=i[1];return e}})();function TU(i,e,t){const r=e[0],a=e[1],h=t[3]*r+t[7]*a||1;return i[0]=(t[0]*r+t[4]*a)/h,i[1]=(t[1]*r+t[5]*a)/h,i}function kR(i,e,t){const r=e[0],a=e[1],h=e[2],y=t[3]*r+t[7]*a+t[11]*h||1;return i[0]=(t[0]*r+t[4]*a+t[8]*h)/y,i[1]=(t[1]*r+t[5]*a+t[9]*h)/y,i[2]=(t[2]*r+t[6]*a+t[10]*h)/y,i}function EU(i,e,t){const r=e[0],a=e[1];return i[0]=t[0]*r+t[2]*a,i[1]=t[1]*r+t[3]*a,i[2]=e[2],i}function SU(i,e,t){const r=e[0],a=e[1];return i[0]=t[0]*r+t[2]*a,i[1]=t[1]*r+t[3]*a,i[2]=e[2],i[3]=e[3],i}function LR(i,e,t){const r=e[0],a=e[1],h=e[2];return i[0]=t[0]*r+t[3]*a+t[6]*h,i[1]=t[1]*r+t[4]*a+t[7]*h,i[2]=t[2]*r+t[5]*a+t[8]*h,i[3]=e[3],i}function NR(){const i=new Ko(3);return Ko!=Float32Array&&(i[0]=0,i[1]=0,i[2]=0),i}function IU(i){const e=i[0],t=i[1],r=i[2];return Math.sqrt(e*e+t*t+r*r)}function a3(i,e,t){const r=new Ko(3);return r[0]=i,r[1]=e,r[2]=t,r}function CU(i,e,t){return i[0]=e[0]-t[0],i[1]=e[1]-t[1],i[2]=e[2]-t[2],i}function MU(i){const e=i[0],t=i[1],r=i[2];return e*e+t*t+r*r}function RU(i,e){return i[0]=-e[0],i[1]=-e[1],i[2]=-e[2],i}function PU(i,e){const t=e[0],r=e[1],a=e[2];let h=t*t+r*r+a*a;return h>0&&(h=1/Math.sqrt(h)),i[0]=e[0]*h,i[1]=e[1]*h,i[2]=e[2]*h,i}function zR(i,e){return i[0]*e[0]+i[1]*e[1]+i[2]*e[2]}function Xg(i,e,t){const r=e[0],a=e[1],h=e[2],y=t[0],s=t[1],T=t[2];return i[0]=a*T-h*s,i[1]=h*y-r*T,i[2]=r*s-a*y,i}function BU(i,e,t,r){const a=e[0],h=e[1],y=e[2];return i[0]=a+r*(t[0]-a),i[1]=h+r*(t[1]-h),i[2]=y+r*(t[2]-y),i}function Qw(i,e,t){const r=e[0],a=e[1],h=e[2];let y=t[3]*r+t[7]*a+t[11]*h+t[15];return y=y||1,i[0]=(t[0]*r+t[4]*a+t[8]*h+t[12])/y,i[1]=(t[1]*r+t[5]*a+t[9]*h+t[13])/y,i[2]=(t[2]*r+t[6]*a+t[10]*h+t[14])/y,i}function UR(i,e,t){const r=e[0],a=e[1],h=e[2];return i[0]=r*t[0]+a*t[3]+h*t[6],i[1]=r*t[1]+a*t[4]+h*t[7],i[2]=r*t[2]+a*t[5]+h*t[8],i}function VR(i,e,t){const r=t[0],a=t[1],h=t[2],y=t[3],s=e[0],T=e[1],B=e[2];let F=a*B-h*T,V=h*s-r*B,X=r*T-a*s,se=a*X-h*V,ne=h*F-r*X,K=r*V-a*F;const ue=y*2;return F*=ue,V*=ue,X*=ue,se*=2,ne*=2,K*=2,i[0]=s+F+se,i[1]=T+V+ne,i[2]=B+X+K,i}function DU(i,e,t,r){const a=[],h=[];return a[0]=e[0]-t[0],a[1]=e[1]-t[1],a[2]=e[2]-t[2],h[0]=a[0],h[1]=a[1]*Math.cos(r)-a[2]*Math.sin(r),h[2]=a[1]*Math.sin(r)+a[2]*Math.cos(r),i[0]=h[0]+t[0],i[1]=h[1]+t[1],i[2]=h[2]+t[2],i}function OU(i,e,t,r){const a=[],h=[];return a[0]=e[0]-t[0],a[1]=e[1]-t[1],a[2]=e[2]-t[2],h[0]=a[2]*Math.sin(r)+a[0]*Math.cos(r),h[1]=a[1],h[2]=a[2]*Math.cos(r)-a[0]*Math.sin(r),i[0]=h[0]+t[0],i[1]=h[1]+t[1],i[2]=h[2]+t[2],i}function FU(i,e,t,r){const a=[],h=[];return a[0]=e[0]-t[0],a[1]=e[1]-t[1],a[2]=e[2]-t[2],h[0]=a[0]*Math.cos(r)-a[1]*Math.sin(r),h[1]=a[0]*Math.sin(r)+a[1]*Math.cos(r),h[2]=a[2],i[0]=h[0]+t[0],i[1]=h[1]+t[1],i[2]=h[2]+t[2],i}function kU(i,e){const t=i[0],r=i[1],a=i[2],h=e[0],y=e[1],s=e[2],T=Math.sqrt((t*t+r*r+a*a)*(h*h+y*y+s*s)),B=T&&zR(i,e)/T;return Math.acos(Math.min(Math.max(B,-1),1))}const jR=CU,HR=IU,qx=MU;(function(){const i=NR();return function(e,t,r,a,h,y){let s,T;for(t||(t=3),r||(r=0),a?T=Math.min(a*t+r,e.length):T=e.length,s=r;s<T;s+=t)i[0]=e[s],i[1]=e[s+1],i[2]=e[s+2],h(i,i,y),e[s]=i[0],e[s+1]=i[1],e[s+2]=i[2];return e}})();const Xx=[0,0,0];let Cg;class Wn extends OR{static get ZERO(){return Cg||(Cg=new Wn(0,0,0),Object.freeze(Cg)),Cg}constructor(e=0,t=0,r=0){super(-0,-0,-0),arguments.length===1&&Mu(e)?this.copy(e):(Rs.debug&&(Pr(e),Pr(t),Pr(r)),this[0]=e,this[1]=t,this[2]=r)}set(e,t,r){return this[0]=e,this[1]=t,this[2]=r,this.check()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this.check()}fromObject(e){return Rs.debug&&(Pr(e.x),Pr(e.y),Pr(e.z)),this[0]=e.x,this[1]=e.y,this[2]=e.z,this.check()}toObject(e){return e.x=this[0],e.y=this[1],e.z=this[2],e}get ELEMENTS(){return 3}get z(){return this[2]}set z(e){this[2]=Pr(e)}angle(e){return kU(this,e)}cross(e){return Xg(this,this,e),this.check()}rotateX({radians:e,origin:t=Xx}){return DU(this,this,t,e),this.check()}rotateY({radians:e,origin:t=Xx}){return OU(this,this,t,e),this.check()}rotateZ({radians:e,origin:t=Xx}){return FU(this,this,t,e),this.check()}transform(e){return this.transformAsPoint(e)}transformAsPoint(e){return Qw(this,this,e),this.check()}transformAsVector(e){return kR(this,this,e),this.check()}transformByMatrix3(e){return UR(this,this,e),this.check()}transformByMatrix2(e){return EU(this,this,e),this.check()}transformByQuaternion(e){return VR(this,this,e),this.check()}}let Mg;class eA extends OR{static get ZERO(){return Mg||(Mg=new eA(0,0,0,0),Object.freeze(Mg)),Mg}constructor(e=0,t=0,r=0,a=0){super(-0,-0,-0,-0),Mu(e)&&arguments.length===1?this.copy(e):(Rs.debug&&(Pr(e),Pr(t),Pr(r),Pr(a)),this[0]=e,this[1]=t,this[2]=r,this[3]=a)}set(e,t,r,a){return this[0]=e,this[1]=t,this[2]=r,this[3]=a,this.check()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this.check()}fromObject(e){return Rs.debug&&(Pr(e.x),Pr(e.y),Pr(e.z),Pr(e.w)),this[0]=e.x,this[1]=e.y,this[2]=e.z,this[3]=e.w,this}toObject(e){return e.x=this[0],e.y=this[1],e.z=this[2],e.w=this[3],e}get ELEMENTS(){return 4}get z(){return this[2]}set z(e){this[2]=Pr(e)}get w(){return this[3]}set w(e){this[3]=Pr(e)}transform(e){return Qw(this,this,e),this.check()}transformByMatrix3(e){return LR(this,this,e),this.check()}transformByMatrix2(e){return SU(this,this,e),this.check()}transformByQuaternion(e){return VR(this,this,e),this.check()}applyMatrix4(e){return e.transform(this,this),this}}class GR extends Jw{toString(){let e="[";if(Rs.printRowMajor){e+="row-major:";for(let t=0;t<this.RANK;++t)for(let r=0;r<this.RANK;++r)e+=` ${this[r*this.RANK+t]}`}else{e+="column-major:";for(let t=0;t<this.ELEMENTS;++t)e+=` ${this[t]}`}return e+="]",e}getElementIndex(e,t){return t*this.RANK+e}getElement(e,t){return this[t*this.RANK+e]}setElement(e,t,r){return this[t*this.RANK+e]=Pr(r),this}getColumn(e,t=new Array(this.RANK).fill(-0)){const r=e*this.RANK;for(let a=0;a<this.RANK;++a)t[a]=this[r+a];return t}setColumn(e,t){const r=e*this.RANK;for(let a=0;a<this.RANK;++a)this[r+a]=t[a];return this}}function LU(){const i=new Ko(9);return Ko!=Float32Array&&(i[1]=0,i[2]=0,i[3]=0,i[5]=0,i[6]=0,i[7]=0),i[0]=1,i[4]=1,i[8]=1,i}function NU(i,e){if(i===e){const t=e[1],r=e[2],a=e[5];i[1]=e[3],i[2]=e[6],i[3]=t,i[5]=e[7],i[6]=r,i[7]=a}else i[0]=e[0],i[1]=e[3],i[2]=e[6],i[3]=e[1],i[4]=e[4],i[5]=e[7],i[6]=e[2],i[7]=e[5],i[8]=e[8];return i}function zU(i,e){const t=e[0],r=e[1],a=e[2],h=e[3],y=e[4],s=e[5],T=e[6],B=e[7],F=e[8],V=F*y-s*B,X=-F*h+s*T,se=B*h-y*T;let ne=t*V+r*X+a*se;return ne?(ne=1/ne,i[0]=V*ne,i[1]=(-F*r+a*B)*ne,i[2]=(s*r-a*y)*ne,i[3]=X*ne,i[4]=(F*t-a*T)*ne,i[5]=(-s*t+a*h)*ne,i[6]=se*ne,i[7]=(-B*t+r*T)*ne,i[8]=(y*t-r*h)*ne,i):null}function UU(i){const e=i[0],t=i[1],r=i[2],a=i[3],h=i[4],y=i[5],s=i[6],T=i[7],B=i[8];return e*(B*h-y*T)+t*(-B*a+y*s)+r*(T*a-h*s)}function l3(i,e,t){const r=e[0],a=e[1],h=e[2],y=e[3],s=e[4],T=e[5],B=e[6],F=e[7],V=e[8],X=t[0],se=t[1],ne=t[2],K=t[3],ue=t[4],_e=t[5],ke=t[6],we=t[7],ge=t[8];return i[0]=X*r+se*y+ne*B,i[1]=X*a+se*s+ne*F,i[2]=X*h+se*T+ne*V,i[3]=K*r+ue*y+_e*B,i[4]=K*a+ue*s+_e*F,i[5]=K*h+ue*T+_e*V,i[6]=ke*r+we*y+ge*B,i[7]=ke*a+we*s+ge*F,i[8]=ke*h+we*T+ge*V,i}function VU(i,e,t){const r=e[0],a=e[1],h=e[2],y=e[3],s=e[4],T=e[5],B=e[6],F=e[7],V=e[8],X=t[0],se=t[1];return i[0]=r,i[1]=a,i[2]=h,i[3]=y,i[4]=s,i[5]=T,i[6]=X*r+se*y+B,i[7]=X*a+se*s+F,i[8]=X*h+se*T+V,i}function jU(i,e,t){const r=e[0],a=e[1],h=e[2],y=e[3],s=e[4],T=e[5],B=e[6],F=e[7],V=e[8],X=Math.sin(t),se=Math.cos(t);return i[0]=se*r+X*y,i[1]=se*a+X*s,i[2]=se*h+X*T,i[3]=se*y-X*r,i[4]=se*s-X*a,i[5]=se*T-X*h,i[6]=B,i[7]=F,i[8]=V,i}function c3(i,e,t){const r=t[0],a=t[1];return i[0]=r*e[0],i[1]=r*e[1],i[2]=r*e[2],i[3]=a*e[3],i[4]=a*e[4],i[5]=a*e[5],i[6]=e[6],i[7]=e[7],i[8]=e[8],i}function HU(i,e){const t=e[0],r=e[1],a=e[2],h=e[3],y=t+t,s=r+r,T=a+a,B=t*y,F=r*y,V=r*s,X=a*y,se=a*s,ne=a*T,K=h*y,ue=h*s,_e=h*T;return i[0]=1-V-ne,i[3]=F-_e,i[6]=X+ue,i[1]=F+_e,i[4]=1-B-ne,i[7]=se-K,i[2]=X-ue,i[5]=se+K,i[8]=1-B-V,i}var z1;(function(i){i[i.COL0ROW0=0]="COL0ROW0",i[i.COL0ROW1=1]="COL0ROW1",i[i.COL0ROW2=2]="COL0ROW2",i[i.COL1ROW0=3]="COL1ROW0",i[i.COL1ROW1=4]="COL1ROW1",i[i.COL1ROW2=5]="COL1ROW2",i[i.COL2ROW0=6]="COL2ROW0",i[i.COL2ROW1=7]="COL2ROW1",i[i.COL2ROW2=8]="COL2ROW2"})(z1||(z1={}));const GU=Object.freeze([1,0,0,0,1,0,0,0,1]);class km extends GR{static get IDENTITY(){return WU()}static get ZERO(){return $U()}get ELEMENTS(){return 9}get RANK(){return 3}get INDICES(){return z1}constructor(e,...t){super(-0,-0,-0,-0,-0,-0,-0,-0,-0),arguments.length===1&&Array.isArray(e)?this.copy(e):t.length>0?this.copy([e,...t]):this.identity()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this[4]=e[4],this[5]=e[5],this[6]=e[6],this[7]=e[7],this[8]=e[8],this.check()}identity(){return this.copy(GU)}fromObject(e){return this.check()}fromQuaternion(e){return HU(this,e),this.check()}set(e,t,r,a,h,y,s,T,B){return this[0]=e,this[1]=t,this[2]=r,this[3]=a,this[4]=h,this[5]=y,this[6]=s,this[7]=T,this[8]=B,this.check()}setRowMajor(e,t,r,a,h,y,s,T,B){return this[0]=e,this[1]=a,this[2]=s,this[3]=t,this[4]=h,this[5]=T,this[6]=r,this[7]=y,this[8]=B,this.check()}determinant(){return UU(this)}transpose(){return NU(this,this),this.check()}invert(){return zU(this,this),this.check()}multiplyLeft(e){return l3(this,e,this),this.check()}multiplyRight(e){return l3(this,this,e),this.check()}rotate(e){return jU(this,this,e),this.check()}scale(e){return Array.isArray(e)?c3(this,this,e):c3(this,this,[e,e]),this.check()}translate(e){return VU(this,this,e),this.check()}transform(e,t){let r;switch(e.length){case 2:r=wU(t||[-0,-0],e,this);break;case 3:r=UR(t||[-0,-0,-0],e,this);break;case 4:r=LR(t||[-0,-0,-0,-0],e,this);break;default:throw new Error("Illegal vector")}return em(r,e.length),r}transformVector(e,t){return this.transform(e,t)}transformVector2(e,t){return this.transform(e,t)}transformVector3(e,t){return this.transform(e,t)}}let Rg,Pg=null;function $U(){return Rg||(Rg=new km([0,0,0,0,0,0,0,0,0]),Object.freeze(Rg)),Rg}function WU(){return Pg||(Pg=new km,Object.freeze(Pg)),Pg}function qU(i){return i[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=1,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i}function XU(i,e){if(i===e){const t=e[1],r=e[2],a=e[3],h=e[6],y=e[7],s=e[11];i[1]=e[4],i[2]=e[8],i[3]=e[12],i[4]=t,i[6]=e[9],i[7]=e[13],i[8]=r,i[9]=h,i[11]=e[14],i[12]=a,i[13]=y,i[14]=s}else i[0]=e[0],i[1]=e[4],i[2]=e[8],i[3]=e[12],i[4]=e[1],i[5]=e[5],i[6]=e[9],i[7]=e[13],i[8]=e[2],i[9]=e[6],i[10]=e[10],i[11]=e[14],i[12]=e[3],i[13]=e[7],i[14]=e[11],i[15]=e[15];return i}function U1(i,e){const t=e[0],r=e[1],a=e[2],h=e[3],y=e[4],s=e[5],T=e[6],B=e[7],F=e[8],V=e[9],X=e[10],se=e[11],ne=e[12],K=e[13],ue=e[14],_e=e[15],ke=t*s-r*y,we=t*T-a*y,ge=t*B-h*y,Le=r*T-a*s,$e=r*B-h*s,Ye=a*B-h*T,St=F*K-V*ne,Pt=F*ue-X*ne,vt=F*_e-se*ne,yt=V*ue-X*K,hi=V*_e-se*K,Pi=X*_e-se*ue;let Si=ke*Pi-we*hi+ge*yt+Le*vt-$e*Pt+Ye*St;return Si?(Si=1/Si,i[0]=(s*Pi-T*hi+B*yt)*Si,i[1]=(a*hi-r*Pi-h*yt)*Si,i[2]=(K*Ye-ue*$e+_e*Le)*Si,i[3]=(X*$e-V*Ye-se*Le)*Si,i[4]=(T*vt-y*Pi-B*Pt)*Si,i[5]=(t*Pi-a*vt+h*Pt)*Si,i[6]=(ue*ge-ne*Ye-_e*we)*Si,i[7]=(F*Ye-X*ge+se*we)*Si,i[8]=(y*hi-s*vt+B*St)*Si,i[9]=(r*vt-t*hi-h*St)*Si,i[10]=(ne*$e-K*ge+_e*ke)*Si,i[11]=(V*ge-F*$e-se*ke)*Si,i[12]=(s*Pt-y*yt-T*St)*Si,i[13]=(t*yt-r*Pt+a*St)*Si,i[14]=(K*we-ne*Le-ue*ke)*Si,i[15]=(F*Le-V*we+X*ke)*Si,i):null}function ZU(i){const e=i[0],t=i[1],r=i[2],a=i[3],h=i[4],y=i[5],s=i[6],T=i[7],B=i[8],F=i[9],V=i[10],X=i[11],se=i[12],ne=i[13],K=i[14],ue=i[15],_e=e*y-t*h,ke=e*s-r*h,we=t*s-r*y,ge=B*ne-F*se,Le=B*K-V*se,$e=F*K-V*ne,Ye=e*$e-t*Le+r*ge,St=h*$e-y*Le+s*ge,Pt=B*we-F*ke+V*_e,vt=se*we-ne*ke+K*_e;return T*Ye-a*St+ue*Pt-X*vt}function wu(i,e,t){const r=e[0],a=e[1],h=e[2],y=e[3],s=e[4],T=e[5],B=e[6],F=e[7],V=e[8],X=e[9],se=e[10],ne=e[11],K=e[12],ue=e[13],_e=e[14],ke=e[15];let we=t[0],ge=t[1],Le=t[2],$e=t[3];return i[0]=we*r+ge*s+Le*V+$e*K,i[1]=we*a+ge*T+Le*X+$e*ue,i[2]=we*h+ge*B+Le*se+$e*_e,i[3]=we*y+ge*F+Le*ne+$e*ke,we=t[4],ge=t[5],Le=t[6],$e=t[7],i[4]=we*r+ge*s+Le*V+$e*K,i[5]=we*a+ge*T+Le*X+$e*ue,i[6]=we*h+ge*B+Le*se+$e*_e,i[7]=we*y+ge*F+Le*ne+$e*ke,we=t[8],ge=t[9],Le=t[10],$e=t[11],i[8]=we*r+ge*s+Le*V+$e*K,i[9]=we*a+ge*T+Le*X+$e*ue,i[10]=we*h+ge*B+Le*se+$e*_e,i[11]=we*y+ge*F+Le*ne+$e*ke,we=t[12],ge=t[13],Le=t[14],$e=t[15],i[12]=we*r+ge*s+Le*V+$e*K,i[13]=we*a+ge*T+Le*X+$e*ue,i[14]=we*h+ge*B+Le*se+$e*_e,i[15]=we*y+ge*F+Le*ne+$e*ke,i}function My(i,e,t){const r=t[0],a=t[1],h=t[2];let y,s,T,B,F,V,X,se,ne,K,ue,_e;return e===i?(i[12]=e[0]*r+e[4]*a+e[8]*h+e[12],i[13]=e[1]*r+e[5]*a+e[9]*h+e[13],i[14]=e[2]*r+e[6]*a+e[10]*h+e[14],i[15]=e[3]*r+e[7]*a+e[11]*h+e[15]):(y=e[0],s=e[1],T=e[2],B=e[3],F=e[4],V=e[5],X=e[6],se=e[7],ne=e[8],K=e[9],ue=e[10],_e=e[11],i[0]=y,i[1]=s,i[2]=T,i[3]=B,i[4]=F,i[5]=V,i[6]=X,i[7]=se,i[8]=ne,i[9]=K,i[10]=ue,i[11]=_e,i[12]=y*r+F*a+ne*h+e[12],i[13]=s*r+V*a+K*h+e[13],i[14]=T*r+X*a+ue*h+e[14],i[15]=B*r+se*a+_e*h+e[15]),i}function tA(i,e,t){const r=t[0],a=t[1],h=t[2];return i[0]=e[0]*r,i[1]=e[1]*r,i[2]=e[2]*r,i[3]=e[3]*r,i[4]=e[4]*a,i[5]=e[5]*a,i[6]=e[6]*a,i[7]=e[7]*a,i[8]=e[8]*h,i[9]=e[9]*h,i[10]=e[10]*h,i[11]=e[11]*h,i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15],i}function YU(i,e,t,r){let a=r[0],h=r[1],y=r[2],s=Math.sqrt(a*a+h*h+y*y),T,B,F,V,X,se,ne,K,ue,_e,ke,we,ge,Le,$e,Ye,St,Pt,vt,yt,hi,Pi,Si,qt;return s<tm?null:(s=1/s,a*=s,h*=s,y*=s,B=Math.sin(t),T=Math.cos(t),F=1-T,V=e[0],X=e[1],se=e[2],ne=e[3],K=e[4],ue=e[5],_e=e[6],ke=e[7],we=e[8],ge=e[9],Le=e[10],$e=e[11],Ye=a*a*F+T,St=h*a*F+y*B,Pt=y*a*F-h*B,vt=a*h*F-y*B,yt=h*h*F+T,hi=y*h*F+a*B,Pi=a*y*F+h*B,Si=h*y*F-a*B,qt=y*y*F+T,i[0]=V*Ye+K*St+we*Pt,i[1]=X*Ye+ue*St+ge*Pt,i[2]=se*Ye+_e*St+Le*Pt,i[3]=ne*Ye+ke*St+$e*Pt,i[4]=V*vt+K*yt+we*hi,i[5]=X*vt+ue*yt+ge*hi,i[6]=se*vt+_e*yt+Le*hi,i[7]=ne*vt+ke*yt+$e*hi,i[8]=V*Pi+K*Si+we*qt,i[9]=X*Pi+ue*Si+ge*qt,i[10]=se*Pi+_e*Si+Le*qt,i[11]=ne*Pi+ke*Si+$e*qt,e!==i&&(i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15]),i)}function $R(i,e,t){const r=Math.sin(t),a=Math.cos(t),h=e[4],y=e[5],s=e[6],T=e[7],B=e[8],F=e[9],V=e[10],X=e[11];return e!==i&&(i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3],i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15]),i[4]=h*a+B*r,i[5]=y*a+F*r,i[6]=s*a+V*r,i[7]=T*a+X*r,i[8]=B*a-h*r,i[9]=F*a-y*r,i[10]=V*a-s*r,i[11]=X*a-T*r,i}function KU(i,e,t){const r=Math.sin(t),a=Math.cos(t),h=e[0],y=e[1],s=e[2],T=e[3],B=e[8],F=e[9],V=e[10],X=e[11];return e!==i&&(i[4]=e[4],i[5]=e[5],i[6]=e[6],i[7]=e[7],i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15]),i[0]=h*a-B*r,i[1]=y*a-F*r,i[2]=s*a-V*r,i[3]=T*a-X*r,i[8]=h*r+B*a,i[9]=y*r+F*a,i[10]=s*r+V*a,i[11]=T*r+X*a,i}function WR(i,e,t){const r=Math.sin(t),a=Math.cos(t),h=e[0],y=e[1],s=e[2],T=e[3],B=e[4],F=e[5],V=e[6],X=e[7];return e!==i&&(i[8]=e[8],i[9]=e[9],i[10]=e[10],i[11]=e[11],i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15]),i[0]=h*a+B*r,i[1]=y*a+F*r,i[2]=s*a+V*r,i[3]=T*a+X*r,i[4]=B*a-h*r,i[5]=F*a-y*r,i[6]=V*a-s*r,i[7]=X*a-T*r,i}function JU(i,e){const t=e[0],r=e[1],a=e[2],h=e[3],y=t+t,s=r+r,T=a+a,B=t*y,F=r*y,V=r*s,X=a*y,se=a*s,ne=a*T,K=h*y,ue=h*s,_e=h*T;return i[0]=1-V-ne,i[1]=F+_e,i[2]=X-ue,i[3]=0,i[4]=F-_e,i[5]=1-B-ne,i[6]=se+K,i[7]=0,i[8]=X+ue,i[9]=se-K,i[10]=1-B-V,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i}function QU(i,e,t,r,a,h,y){const s=1/(t-e),T=1/(a-r),B=1/(h-y);return i[0]=h*2*s,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=h*2*T,i[6]=0,i[7]=0,i[8]=(t+e)*s,i[9]=(a+r)*T,i[10]=(y+h)*B,i[11]=-1,i[12]=0,i[13]=0,i[14]=y*h*2*B,i[15]=0,i}function e6(i,e,t,r,a){const h=1/Math.tan(e/2);if(i[0]=h/t,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=h,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[11]=-1,i[12]=0,i[13]=0,i[15]=0,a!=null&&a!==1/0){const y=1/(r-a);i[10]=(a+r)*y,i[14]=2*a*r*y}else i[10]=-1,i[14]=-2*r;return i}const t6=e6;function i6(i,e,t,r,a,h,y){const s=1/(e-t),T=1/(r-a),B=1/(h-y);return i[0]=-2*s,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=-2*T,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=2*B,i[11]=0,i[12]=(e+t)*s,i[13]=(a+r)*T,i[14]=(y+h)*B,i[15]=1,i}const r6=i6;function n6(i,e,t,r){let a,h,y,s,T,B,F,V,X,se;const ne=e[0],K=e[1],ue=e[2],_e=r[0],ke=r[1],we=r[2],ge=t[0],Le=t[1],$e=t[2];return Math.abs(ne-ge)<tm&&Math.abs(K-Le)<tm&&Math.abs(ue-$e)<tm?qU(i):(V=ne-ge,X=K-Le,se=ue-$e,a=1/Math.sqrt(V*V+X*X+se*se),V*=a,X*=a,se*=a,h=ke*se-we*X,y=we*V-_e*se,s=_e*X-ke*V,a=Math.sqrt(h*h+y*y+s*s),a?(a=1/a,h*=a,y*=a,s*=a):(h=0,y=0,s=0),T=X*s-se*y,B=se*h-V*s,F=V*y-X*h,a=Math.sqrt(T*T+B*B+F*F),a?(a=1/a,T*=a,B*=a,F*=a):(T=0,B=0,F=0),i[0]=h,i[1]=T,i[2]=V,i[3]=0,i[4]=y,i[5]=B,i[6]=X,i[7]=0,i[8]=s,i[9]=F,i[10]=se,i[11]=0,i[12]=-(h*ne+y*K+s*ue),i[13]=-(T*ne+B*K+F*ue),i[14]=-(V*ne+X*K+se*ue),i[15]=1,i)}function s6(){const i=new Ko(4);return Ko!=Float32Array&&(i[0]=0,i[1]=0,i[2]=0,i[3]=0),i}function o6(i,e,t){return i[0]=e[0]+t[0],i[1]=e[1]+t[1],i[2]=e[2]+t[2],i[3]=e[3]+t[3],i}function iA(i,e,t){return i[0]=e[0]*t,i[1]=e[1]*t,i[2]=e[2]*t,i[3]=e[3]*t,i}function a6(i){const e=i[0],t=i[1],r=i[2],a=i[3];return Math.sqrt(e*e+t*t+r*r+a*a)}function l6(i){const e=i[0],t=i[1],r=i[2],a=i[3];return e*e+t*t+r*r+a*a}function c6(i,e){const t=e[0],r=e[1],a=e[2],h=e[3];let y=t*t+r*r+a*a+h*h;return y>0&&(y=1/Math.sqrt(y)),i[0]=t*y,i[1]=r*y,i[2]=a*y,i[3]=h*y,i}function u6(i,e){return i[0]*e[0]+i[1]*e[1]+i[2]*e[2]+i[3]*e[3]}function h6(i,e,t,r){const a=e[0],h=e[1],y=e[2],s=e[3];return i[0]=a+r*(t[0]-a),i[1]=h+r*(t[1]-h),i[2]=y+r*(t[2]-y),i[3]=s+r*(t[3]-s),i}function Cd(i,e,t){const r=e[0],a=e[1],h=e[2],y=e[3];return i[0]=t[0]*r+t[4]*a+t[8]*h+t[12]*y,i[1]=t[1]*r+t[5]*a+t[9]*h+t[13]*y,i[2]=t[2]*r+t[6]*a+t[10]*h+t[14]*y,i[3]=t[3]*r+t[7]*a+t[11]*h+t[15]*y,i}function d6(i,e,t){const r=e[0],a=e[1],h=e[2],y=t[0],s=t[1],T=t[2],B=t[3],F=B*r+s*h-T*a,V=B*a+T*r-y*h,X=B*h+y*a-s*r,se=-y*r-s*a-T*h;return i[0]=F*B+se*-y+V*-T-X*-s,i[1]=V*B+se*-s+X*-y-F*-T,i[2]=X*B+se*-T+F*-s-V*-y,i[3]=e[3],i}(function(){const i=s6();return function(e,t,r,a,h,y){let s,T;for(t||(t=4),r||(r=0),a?T=Math.min(a*t+r,e.length):T=e.length,s=r;s<T;s+=t)i[0]=e[s],i[1]=e[s+1],i[2]=e[s+2],i[3]=e[s+3],h(i,i,y),e[s]=i[0],e[s+1]=i[1],e[s+2]=i[2],e[s+3]=i[3];return e}})();var V1;(function(i){i[i.COL0ROW0=0]="COL0ROW0",i[i.COL0ROW1=1]="COL0ROW1",i[i.COL0ROW2=2]="COL0ROW2",i[i.COL0ROW3=3]="COL0ROW3",i[i.COL1ROW0=4]="COL1ROW0",i[i.COL1ROW1=5]="COL1ROW1",i[i.COL1ROW2=6]="COL1ROW2",i[i.COL1ROW3=7]="COL1ROW3",i[i.COL2ROW0=8]="COL2ROW0",i[i.COL2ROW1=9]="COL2ROW1",i[i.COL2ROW2=10]="COL2ROW2",i[i.COL2ROW3=11]="COL2ROW3",i[i.COL3ROW0=12]="COL3ROW0",i[i.COL3ROW1=13]="COL3ROW1",i[i.COL3ROW2=14]="COL3ROW2",i[i.COL3ROW3=15]="COL3ROW3"})(V1||(V1={}));const f6=45*Math.PI/180,p6=1,Zx=.1,Yx=500,m6=Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);class qn extends GR{static get IDENTITY(){return g6()}static get ZERO(){return _6()}get ELEMENTS(){return 16}get RANK(){return 4}get INDICES(){return V1}constructor(e){super(-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0),arguments.length===1&&Array.isArray(e)?this.copy(e):this.identity()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this[4]=e[4],this[5]=e[5],this[6]=e[6],this[7]=e[7],this[8]=e[8],this[9]=e[9],this[10]=e[10],this[11]=e[11],this[12]=e[12],this[13]=e[13],this[14]=e[14],this[15]=e[15],this.check()}set(e,t,r,a,h,y,s,T,B,F,V,X,se,ne,K,ue){return this[0]=e,this[1]=t,this[2]=r,this[3]=a,this[4]=h,this[5]=y,this[6]=s,this[7]=T,this[8]=B,this[9]=F,this[10]=V,this[11]=X,this[12]=se,this[13]=ne,this[14]=K,this[15]=ue,this.check()}setRowMajor(e,t,r,a,h,y,s,T,B,F,V,X,se,ne,K,ue){return this[0]=e,this[1]=h,this[2]=B,this[3]=se,this[4]=t,this[5]=y,this[6]=F,this[7]=ne,this[8]=r,this[9]=s,this[10]=V,this[11]=K,this[12]=a,this[13]=T,this[14]=X,this[15]=ue,this.check()}toRowMajor(e){return e[0]=this[0],e[1]=this[4],e[2]=this[8],e[3]=this[12],e[4]=this[1],e[5]=this[5],e[6]=this[9],e[7]=this[13],e[8]=this[2],e[9]=this[6],e[10]=this[10],e[11]=this[14],e[12]=this[3],e[13]=this[7],e[14]=this[11],e[15]=this[15],e}identity(){return this.copy(m6)}fromObject(e){return this.check()}fromQuaternion(e){return JU(this,e),this.check()}frustum(e){const{left:t,right:r,bottom:a,top:h,near:y=Zx,far:s=Yx}=e;return s===1/0?y6(this,t,r,a,h,y):QU(this,t,r,a,h,y,s),this.check()}lookAt(e){const{eye:t,center:r=[0,0,0],up:a=[0,1,0]}=e;return n6(this,t,r,a),this.check()}ortho(e){const{left:t,right:r,bottom:a,top:h,near:y=Zx,far:s=Yx}=e;return r6(this,t,r,a,h,y,s),this.check()}orthographic(e){const{fovy:t=f6,aspect:r=p6,focalDistance:a=1,near:h=Zx,far:y=Yx}=e;u3(t);const s=t/2,T=a*Math.tan(s),B=T*r;return this.ortho({left:-B,right:B,bottom:-T,top:T,near:h,far:y})}perspective(e){const{fovy:t=45*Math.PI/180,aspect:r=1,near:a=.1,far:h=500}=e;return u3(t),t6(this,t,r,a,h),this.check()}determinant(){return ZU(this)}getScale(e=[-0,-0,-0]){return e[0]=Math.sqrt(this[0]*this[0]+this[1]*this[1]+this[2]*this[2]),e[1]=Math.sqrt(this[4]*this[4]+this[5]*this[5]+this[6]*this[6]),e[2]=Math.sqrt(this[8]*this[8]+this[9]*this[9]+this[10]*this[10]),e}getTranslation(e=[-0,-0,-0]){return e[0]=this[12],e[1]=this[13],e[2]=this[14],e}getRotation(e,t){e=e||[-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0],t=t||[-0,-0,-0];const r=this.getScale(t),a=1/r[0],h=1/r[1],y=1/r[2];return e[0]=this[0]*a,e[1]=this[1]*h,e[2]=this[2]*y,e[3]=0,e[4]=this[4]*a,e[5]=this[5]*h,e[6]=this[6]*y,e[7]=0,e[8]=this[8]*a,e[9]=this[9]*h,e[10]=this[10]*y,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}getRotationMatrix3(e,t){e=e||[-0,-0,-0,-0,-0,-0,-0,-0,-0],t=t||[-0,-0,-0];const r=this.getScale(t),a=1/r[0],h=1/r[1],y=1/r[2];return e[0]=this[0]*a,e[1]=this[1]*h,e[2]=this[2]*y,e[3]=this[4]*a,e[4]=this[5]*h,e[5]=this[6]*y,e[6]=this[8]*a,e[7]=this[9]*h,e[8]=this[10]*y,e}transpose(){return XU(this,this),this.check()}invert(){return U1(this,this),this.check()}multiplyLeft(e){return wu(this,e,this),this.check()}multiplyRight(e){return wu(this,this,e),this.check()}rotateX(e){return $R(this,this,e),this.check()}rotateY(e){return KU(this,this,e),this.check()}rotateZ(e){return WR(this,this,e),this.check()}rotateXYZ(e){return this.rotateX(e[0]).rotateY(e[1]).rotateZ(e[2])}rotateAxis(e,t){return YU(this,this,e,t),this.check()}scale(e){return tA(this,this,Array.isArray(e)?e:[e,e,e]),this.check()}translate(e){return My(this,this,e),this.check()}transform(e,t){return e.length===4?(t=Cd(t||[-0,-0,-0,-0],e,this),em(t,4),t):this.transformAsPoint(e,t)}transformAsPoint(e,t){const{length:r}=e;let a;switch(r){case 2:a=AU(t||[-0,-0],e,this);break;case 3:a=Qw(t||[-0,-0,-0],e,this);break;default:throw new Error("Illegal vector")}return em(a,e.length),a}transformAsVector(e,t){let r;switch(e.length){case 2:r=TU(t||[-0,-0],e,this);break;case 3:r=kR(t||[-0,-0,-0],e,this);break;default:throw new Error("Illegal vector")}return em(r,e.length),r}transformPoint(e,t){return this.transformAsPoint(e,t)}transformVector(e,t){return this.transformAsPoint(e,t)}transformDirection(e,t){return this.transformAsVector(e,t)}makeRotationX(e){return this.identity().rotateX(e)}makeTranslation(e,t,r){return this.identity().translate([e,t,r])}}let Bg,Dg;function _6(){return Bg||(Bg=new qn([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),Object.freeze(Bg)),Bg}function g6(){return Dg||(Dg=new qn,Object.freeze(Dg)),Dg}function u3(i){if(i>Math.PI*2)throw Error("expected radians")}function y6(i,e,t,r,a,h){const y=2*h/(t-e),s=2*h/(a-r),T=(t+e)/(t-e),B=(a+r)/(a-r),F=-1,V=-1,X=-2*h;return i[0]=y,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=s,i[6]=0,i[7]=0,i[8]=T,i[9]=B,i[10]=F,i[11]=V,i[12]=0,i[13]=0,i[14]=X,i[15]=0,i}function h3(){const i=new Ko(4);return Ko!=Float32Array&&(i[0]=0,i[1]=0,i[2]=0),i[3]=1,i}function v6(i){return i[0]=0,i[1]=0,i[2]=0,i[3]=1,i}function qR(i,e,t){t=t*.5;const r=Math.sin(t);return i[0]=r*e[0],i[1]=r*e[1],i[2]=r*e[2],i[3]=Math.cos(t),i}function d3(i,e,t){const r=e[0],a=e[1],h=e[2],y=e[3],s=t[0],T=t[1],B=t[2],F=t[3];return i[0]=r*F+y*s+a*B-h*T,i[1]=a*F+y*T+h*s-r*B,i[2]=h*F+y*B+r*T-a*s,i[3]=y*F-r*s-a*T-h*B,i}function x6(i,e,t){t*=.5;const r=e[0],a=e[1],h=e[2],y=e[3],s=Math.sin(t),T=Math.cos(t);return i[0]=r*T+y*s,i[1]=a*T+h*s,i[2]=h*T-a*s,i[3]=y*T-r*s,i}function b6(i,e,t){t*=.5;const r=e[0],a=e[1],h=e[2],y=e[3],s=Math.sin(t),T=Math.cos(t);return i[0]=r*T-h*s,i[1]=a*T+y*s,i[2]=h*T+r*s,i[3]=y*T-a*s,i}function w6(i,e,t){t*=.5;const r=e[0],a=e[1],h=e[2],y=e[3],s=Math.sin(t),T=Math.cos(t);return i[0]=r*T+a*s,i[1]=a*T-r*s,i[2]=h*T+y*s,i[3]=y*T-h*s,i}function A6(i,e){const t=e[0],r=e[1],a=e[2];return i[0]=t,i[1]=r,i[2]=a,i[3]=Math.sqrt(Math.abs(1-t*t-r*r-a*a)),i}function Zg(i,e,t,r){const a=e[0],h=e[1],y=e[2],s=e[3];let T=t[0],B=t[1],F=t[2],V=t[3],X,se,ne,K,ue;return X=a*T+h*B+y*F+s*V,X<0&&(X=-X,T=-T,B=-B,F=-F,V=-V),1-X>tm?(se=Math.acos(X),ue=Math.sin(se),ne=Math.sin((1-r)*se)/ue,K=Math.sin(r*se)/ue):(ne=1-r,K=r),i[0]=ne*a+K*T,i[1]=ne*h+K*B,i[2]=ne*y+K*F,i[3]=ne*s+K*V,i}function T6(i,e){const t=e[0],r=e[1],a=e[2],h=e[3],y=t*t+r*r+a*a+h*h,s=y?1/y:0;return i[0]=-t*s,i[1]=-r*s,i[2]=-a*s,i[3]=h*s,i}function E6(i,e){return i[0]=-e[0],i[1]=-e[1],i[2]=-e[2],i[3]=e[3],i}function XR(i,e){const t=e[0]+e[4]+e[8];let r;if(t>0)r=Math.sqrt(t+1),i[3]=.5*r,r=.5/r,i[0]=(e[5]-e[7])*r,i[1]=(e[6]-e[2])*r,i[2]=(e[1]-e[3])*r;else{let a=0;e[4]>e[0]&&(a=1),e[8]>e[a*3+a]&&(a=2);const h=(a+1)%3,y=(a+2)%3;r=Math.sqrt(e[a*3+a]-e[h*3+h]-e[y*3+y]+1),i[a]=.5*r,r=.5/r,i[3]=(e[h*3+y]-e[y*3+h])*r,i[h]=(e[h*3+a]+e[a*3+h])*r,i[y]=(e[y*3+a]+e[a*3+y])*r}return i}const S6=o6,I6=iA,C6=u6,M6=h6,R6=a6,P6=l6,ZR=c6,B6=function(){const i=NR(),e=a3(1,0,0),t=a3(0,1,0);return function(r,a,h){const y=zR(a,h);return y<-.999999?(Xg(i,e,a),HR(i)<1e-6&&Xg(i,t,a),PU(i,i),qR(r,i,Math.PI),r):y>.999999?(r[0]=0,r[1]=0,r[2]=0,r[3]=1,r):(Xg(i,a,h),r[0]=i[0],r[1]=i[1],r[2]=i[2],r[3]=1+y,ZR(r,r))}}();(function(){const i=h3(),e=h3();return function(t,r,a,h,y,s){return Zg(i,r,y,s),Zg(e,a,h,s),Zg(t,i,e,2*s*(1-s)),t}})();(function(){const i=LU();return function(e,t,r,a){return i[0]=r[0],i[3]=r[1],i[6]=r[2],i[1]=a[0],i[4]=a[1],i[7]=a[2],i[2]=-t[0],i[5]=-t[1],i[8]=-t[2],ZR(e,XR(e,i))}})();const D6=[0,0,0,1];class O6 extends Jw{constructor(e=0,t=0,r=0,a=1){super(-0,-0,-0,-0),Array.isArray(e)&&arguments.length===1?this.copy(e):this.set(e,t,r,a)}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this.check()}set(e,t,r,a){return this[0]=e,this[1]=t,this[2]=r,this[3]=a,this.check()}fromObject(e){return this[0]=e.x,this[1]=e.y,this[2]=e.z,this[3]=e.w,this.check()}fromMatrix3(e){return XR(this,e),this.check()}fromAxisRotation(e,t){return qR(this,e,t),this.check()}identity(){return v6(this),this.check()}setAxisAngle(e,t){return this.fromAxisRotation(e,t)}get ELEMENTS(){return 4}get x(){return this[0]}set x(e){this[0]=Pr(e)}get y(){return this[1]}set y(e){this[1]=Pr(e)}get z(){return this[2]}set z(e){this[2]=Pr(e)}get w(){return this[3]}set w(e){this[3]=Pr(e)}len(){return R6(this)}lengthSquared(){return P6(this)}dot(e){return C6(this,e)}rotationTo(e,t){return B6(this,e,t),this.check()}add(e){return S6(this,this,e),this.check()}calculateW(){return A6(this,this),this.check()}conjugate(){return E6(this,this),this.check()}invert(){return T6(this,this),this.check()}lerp(e,t,r){return r===void 0?this.lerp(this,e,t):(M6(this,e,t,r),this.check())}multiplyRight(e){return d3(this,this,e),this.check()}multiplyLeft(e){return d3(this,e,this),this.check()}normalize(){const e=this.len(),t=e>0?1/e:0;return this[0]=this[0]*t,this[1]=this[1]*t,this[2]=this[2]*t,this[3]=this[3]*t,e===0&&(this[3]=1),this.check()}rotateX(e){return x6(this,this,e),this.check()}rotateY(e){return b6(this,this,e),this.check()}rotateZ(e){return w6(this,this,e),this.check()}scale(e){return I6(this,this,e),this.check()}slerp(e,t,r){let a,h,y;switch(arguments.length){case 1:({start:a=D6,target:h,ratio:y}=e);break;case 2:a=this,h=e,y=t;break;default:a=e,h=t,y=r}return Zg(this,a,h,y),this.check()}transformVector4(e,t=new eA){return d6(t,e,this),em(t,4)}lengthSq(){return this.lengthSquared()}setFromAxisAngle(e,t){return this.setAxisAngle(e,t)}premultiply(e){return this.multiplyLeft(e)}multiply(e){return this.multiplyRight(e)}}function YR(i,e=[],t=0){const r=Math.fround(i),a=i-r;return e[t]=r,e[t+1]=a,e}function F6(i){return i-Math.fround(i)}function k6(i){const e=new Float32Array(32);for(let t=0;t<4;++t)for(let r=0;r<4;++r){const a=t*4+r;YR(i[r*4+t],e,a*2)}return e}const L6=`#ifdef LUMA_FP32_TAN_PRECISION_WORKAROUND

// All these functions are for substituting tan() function from Intel GPU only
const float TWO_PI = 6.2831854820251465;
const float PI_2 = 1.5707963705062866;
const float PI_16 = 0.1963495463132858;

const float SIN_TABLE_0 = 0.19509032368659973;
const float SIN_TABLE_1 = 0.3826834261417389;
const float SIN_TABLE_2 = 0.5555702447891235;
const float SIN_TABLE_3 = 0.7071067690849304;

const float COS_TABLE_0 = 0.9807852506637573;
const float COS_TABLE_1 = 0.9238795042037964;
const float COS_TABLE_2 = 0.8314695954322815;
const float COS_TABLE_3 = 0.7071067690849304;

const float INVERSE_FACTORIAL_3 = 1.666666716337204e-01; // 1/3!
const float INVERSE_FACTORIAL_5 = 8.333333767950535e-03; // 1/5!
const float INVERSE_FACTORIAL_7 = 1.9841270113829523e-04; // 1/7!
const float INVERSE_FACTORIAL_9 = 2.75573188446287533e-06; // 1/9!

float sin_taylor_fp32(float a) {
  float r, s, t, x;

  if (a == 0.0) {
    return 0.0;
  }

  x = -a * a;
  s = a;
  r = a;

  r = r * x;
  t = r * INVERSE_FACTORIAL_3;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_5;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_7;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_9;
  s = s + t;

  return s;
}

void sincos_taylor_fp32(float a, out float sin_t, out float cos_t) {
  if (a == 0.0) {
    sin_t = 0.0;
    cos_t = 1.0;
  }
  sin_t = sin_taylor_fp32(a);
  cos_t = sqrt(1.0 - sin_t * sin_t);
}

float tan_taylor_fp32(float a) {
    float sin_a;
    float cos_a;

    if (a == 0.0) {
        return 0.0;
    }

    // 2pi range reduction
    float z = floor(a / TWO_PI);
    float r = a - TWO_PI * z;

    float t;
    float q = floor(r / PI_2 + 0.5);
    int j = int(q);

    if (j < -2 || j > 2) {
        return 1.0 / 0.0;
    }

    t = r - PI_2 * q;

    q = floor(t / PI_16 + 0.5);
    int k = int(q);
    int abs_k = int(abs(float(k)));

    if (abs_k > 4) {
        return 1.0 / 0.0;
    } else {
        t = t - PI_16 * q;
    }

    float u = 0.0;
    float v = 0.0;

    float sin_t, cos_t;
    float s, c;
    sincos_taylor_fp32(t, sin_t, cos_t);

    if (k == 0) {
        s = sin_t;
        c = cos_t;
    } else {
        if (abs(float(abs_k) - 1.0) < 0.5) {
            u = COS_TABLE_0;
            v = SIN_TABLE_0;
        } else if (abs(float(abs_k) - 2.0) < 0.5) {
            u = COS_TABLE_1;
            v = SIN_TABLE_1;
        } else if (abs(float(abs_k) - 3.0) < 0.5) {
            u = COS_TABLE_2;
            v = SIN_TABLE_2;
        } else if (abs(float(abs_k) - 4.0) < 0.5) {
            u = COS_TABLE_3;
            v = SIN_TABLE_3;
        }
        if (k > 0) {
            s = u * sin_t + v * cos_t;
            c = u * cos_t - v * sin_t;
        } else {
            s = u * sin_t - v * cos_t;
            c = u * cos_t + v * sin_t;
        }
    }

    if (j == 0) {
        sin_a = s;
        cos_a = c;
    } else if (j == 1) {
        sin_a = c;
        cos_a = -s;
    } else if (j == -1) {
        sin_a = -c;
        cos_a = s;
    } else {
        sin_a = -s;
        cos_a = -c;
    }
    return sin_a / cos_a;
}
#endif

float tan_fp32(float a) {
#ifdef LUMA_FP32_TAN_PRECISION_WORKAROUND
  return tan_taylor_fp32(a);
#else
  return tan(a);
#endif
}
`,N6={name:"fp32",vs:L6},z6=`
uniform fp64arithmeticUniforms {
  uniform float ONE;
} fp64;

/*
About LUMA_FP64_CODE_ELIMINATION_WORKAROUND

The purpose of this workaround is to prevent shader compilers from
optimizing away necessary arithmetic operations by swapping their sequences
or transform the equation to some 'equivalent' form.

The method is to multiply an artifical variable, ONE, which will be known to
the compiler to be 1 only at runtime. The whole expression is then represented
as a polynomial with respective to ONE. In the coefficients of all terms, only one a
and one b should appear

err = (a + b) * ONE^6 - a * ONE^5 - (a + b) * ONE^4 + a * ONE^3 - b - (a + b) * ONE^2 + a * ONE
*/

// Divide float number to high and low floats to extend fraction bits
vec2 split(float a) {
  const float SPLIT = 4097.0;
  float t = a * SPLIT;
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float a_hi = t * fp64.ONE - (t - a);
  float a_lo = a * fp64.ONE - a_hi;
#else
  float a_hi = t - (t - a);
  float a_lo = a - a_hi;
#endif
  return vec2(a_hi, a_lo);
}

// Divide float number again when high float uses too many fraction bits
vec2 split2(vec2 a) {
  vec2 b = split(a.x);
  b.y += a.y;
  return b;
}

// Special sum operation when a > b
vec2 quickTwoSum(float a, float b) {
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float sum = (a + b) * fp64.ONE;
  float err = b - (sum - a) * fp64.ONE;
#else
  float sum = a + b;
  float err = b - (sum - a);
#endif
  return vec2(sum, err);
}

// General sum operation
vec2 twoSum(float a, float b) {
  float s = (a + b);
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float v = (s * fp64.ONE - a) * fp64.ONE;
  float err = (a - (s - v) * fp64.ONE) * fp64.ONE * fp64.ONE * fp64.ONE + (b - v);
#else
  float v = s - a;
  float err = (a - (s - v)) + (b - v);
#endif
  return vec2(s, err);
}

vec2 twoSub(float a, float b) {
  float s = (a - b);
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float v = (s * fp64.ONE - a) * fp64.ONE;
  float err = (a - (s - v) * fp64.ONE) * fp64.ONE * fp64.ONE * fp64.ONE - (b + v);
#else
  float v = s - a;
  float err = (a - (s - v)) - (b + v);
#endif
  return vec2(s, err);
}

vec2 twoSqr(float a) {
  float prod = a * a;
  vec2 a_fp64 = split(a);
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float err = ((a_fp64.x * a_fp64.x - prod) * fp64.ONE + 2.0 * a_fp64.x *
    a_fp64.y * fp64.ONE * fp64.ONE) + a_fp64.y * a_fp64.y * fp64.ONE * fp64.ONE * fp64.ONE;
#else
  float err = ((a_fp64.x * a_fp64.x - prod) + 2.0 * a_fp64.x * a_fp64.y) + a_fp64.y * a_fp64.y;
#endif
  return vec2(prod, err);
}

vec2 twoProd(float a, float b) {
  float prod = a * b;
  vec2 a_fp64 = split(a);
  vec2 b_fp64 = split(b);
  float err = ((a_fp64.x * b_fp64.x - prod) + a_fp64.x * b_fp64.y +
    a_fp64.y * b_fp64.x) + a_fp64.y * b_fp64.y;
  return vec2(prod, err);
}

vec2 sum_fp64(vec2 a, vec2 b) {
  vec2 s, t;
  s = twoSum(a.x, b.x);
  t = twoSum(a.y, b.y);
  s.y += t.x;
  s = quickTwoSum(s.x, s.y);
  s.y += t.y;
  s = quickTwoSum(s.x, s.y);
  return s;
}

vec2 sub_fp64(vec2 a, vec2 b) {
  vec2 s, t;
  s = twoSub(a.x, b.x);
  t = twoSub(a.y, b.y);
  s.y += t.x;
  s = quickTwoSum(s.x, s.y);
  s.y += t.y;
  s = quickTwoSum(s.x, s.y);
  return s;
}

vec2 mul_fp64(vec2 a, vec2 b) {
  vec2 prod = twoProd(a.x, b.x);
  // y component is for the error
  prod.y += a.x * b.y;
#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)
  prod = split2(prod);
#endif
  prod = quickTwoSum(prod.x, prod.y);
  prod.y += a.y * b.x;
#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)
  prod = split2(prod);
#endif
  prod = quickTwoSum(prod.x, prod.y);
  return prod;
}

vec2 div_fp64(vec2 a, vec2 b) {
  float xn = 1.0 / b.x;
#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)
  vec2 yn = mul_fp64(a, vec2(xn, 0));
#else
  vec2 yn = a * xn;
#endif
  float diff = (sub_fp64(a, mul_fp64(b, yn))).x;
  vec2 prod = twoProd(xn, diff);
  return sum_fp64(yn, prod);
}

vec2 sqrt_fp64(vec2 a) {
  if (a.x == 0.0 && a.y == 0.0) return vec2(0.0, 0.0);
  if (a.x < 0.0) return vec2(0.0 / 0.0, 0.0 / 0.0);

  float x = 1.0 / sqrt(a.x);
  float yn = a.x * x;
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  vec2 yn_sqr = twoSqr(yn) * fp64.ONE;
#else
  vec2 yn_sqr = twoSqr(yn);
#endif
  float diff = sub_fp64(a, yn_sqr).x;
  vec2 prod = twoProd(x * 0.5, diff);
#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)
  return sum_fp64(split(yn), prod);
#else
  return sum_fp64(vec2(yn, 0.0), prod);
#endif
}
`,U6={ONE:1},V6={name:"fp64arithmetic",vs:z6,defaultUniforms:U6,uniformTypes:{ONE:"f32"},fp64ify:YR,fp64LowPart:F6,fp64ifyMatrix4:k6},j6=[0,1,1,1],H6=`uniform pickingUniforms {
  float isActive;
  float isAttribute;
  float isHighlightActive;
  float useFloatColors;
  vec3 highlightedObjectColor;
  vec4 highlightColor;
} picking;

out vec4 picking_vRGBcolor_Avalid;

// Normalize unsigned byte color to 0-1 range
vec3 picking_normalizeColor(vec3 color) {
  return picking.useFloatColors > 0.5 ? color : color / 255.0;
}

// Normalize unsigned byte color to 0-1 range
vec4 picking_normalizeColor(vec4 color) {
  return picking.useFloatColors > 0.5 ? color : color / 255.0;
}

bool picking_isColorZero(vec3 color) {
  return dot(color, vec3(1.0)) < 0.00001;
}

bool picking_isColorValid(vec3 color) {
  return dot(color, vec3(1.0)) > 0.00001;
}

// Check if this vertex is highlighted 
bool isVertexHighlighted(vec3 vertexColor) {
  vec3 highlightedObjectColor = picking_normalizeColor(picking.highlightedObjectColor);
  return
    bool(picking.isHighlightActive) && picking_isColorZero(abs(vertexColor - highlightedObjectColor));
}

// Set the current picking color
void picking_setPickingColor(vec3 pickingColor) {
  pickingColor = picking_normalizeColor(pickingColor);

  if (bool(picking.isActive)) {
    // Use alpha as the validity flag. If pickingColor is [0, 0, 0] fragment is non-pickable
    picking_vRGBcolor_Avalid.a = float(picking_isColorValid(pickingColor));

    if (!bool(picking.isAttribute)) {
      // Stores the picking color so that the fragment shader can render it during picking
      picking_vRGBcolor_Avalid.rgb = pickingColor;
    }
  } else {
    // Do the comparison with selected item color in vertex shader as it should mean fewer compares
    picking_vRGBcolor_Avalid.a = float(isVertexHighlighted(pickingColor));
  }
}

void picking_setPickingAttribute(float value) {
  if (bool(picking.isAttribute)) {
    picking_vRGBcolor_Avalid.r = value;
  }
}

void picking_setPickingAttribute(vec2 value) {
  if (bool(picking.isAttribute)) {
    picking_vRGBcolor_Avalid.rg = value;
  }
}

void picking_setPickingAttribute(vec3 value) {
  if (bool(picking.isAttribute)) {
    picking_vRGBcolor_Avalid.rgb = value;
  }
}
`,G6=`uniform pickingUniforms {
  float isActive;
  float isAttribute;
  float isHighlightActive;
  float useFloatColors;
  vec3 highlightedObjectColor;
  vec4 highlightColor;
} picking;

in vec4 picking_vRGBcolor_Avalid;

/*
 * Returns highlight color if this item is selected.
 */
vec4 picking_filterHighlightColor(vec4 color) {
  // If we are still picking, we don't highlight
  if (picking.isActive > 0.5) {
    return color;
  }

  bool selected = bool(picking_vRGBcolor_Avalid.a);

  if (selected) {
    // Blend in highlight color based on its alpha value
    float highLightAlpha = picking.highlightColor.a;
    float blendedAlpha = highLightAlpha + color.a * (1.0 - highLightAlpha);
    float highLightRatio = highLightAlpha / blendedAlpha;

    vec3 blendedRGB = mix(color.rgb, picking.highlightColor.rgb, highLightRatio);
    return vec4(blendedRGB, blendedAlpha);
  } else {
    return color;
  }
}

/*
 * Returns picking color if picking enabled else unmodified argument.
 */
vec4 picking_filterPickingColor(vec4 color) {
  if (bool(picking.isActive)) {
    if (picking_vRGBcolor_Avalid.a == 0.0) {
      discard;
    }
    return picking_vRGBcolor_Avalid;
  }
  return color;
}

/*
 * Returns picking color if picking is enabled if not
 * highlight color if this item is selected, otherwise unmodified argument.
 */
vec4 picking_filterColor(vec4 color) {
  vec4 highlightColor = picking_filterHighlightColor(color);
  return picking_filterPickingColor(highlightColor);
}
`,f3={props:{},uniforms:{},name:"picking",uniformTypes:{isActive:"f32",isAttribute:"f32",isHighlightActive:"f32",useFloatColors:"f32",highlightedObjectColor:"vec3<f32>",highlightColor:"vec4<f32>"},defaultUniforms:{isActive:!1,isAttribute:!1,isHighlightActive:!1,useFloatColors:!0,highlightedObjectColor:[0,0,0],highlightColor:j6},vs:H6,fs:G6,getUniforms:$6};function $6(i={},e){const t={};if(i.highlightedObjectColor!==void 0)if(i.highlightedObjectColor===null)t.isHighlightActive=!1;else{t.isHighlightActive=!0;const r=i.highlightedObjectColor.slice(0,3);t.highlightedObjectColor=r}if(i.highlightColor){const r=Array.from(i.highlightColor,a=>a/255);Number.isFinite(r[3])||(r[3]=1),t.highlightColor=r}return i.isActive!==void 0&&(t.isActive=!!i.isActive,t.isAttribute=!!i.isAttribute),i.useFloatColors!==void 0&&(t.useFloatColors=!!i.useFloatColors),t}const p3=`precision highp int;

// #if (defined(SHADER_TYPE_FRAGMENT) && defined(LIGHTING_FRAGMENT)) || (defined(SHADER_TYPE_VERTEX) && defined(LIGHTING_VERTEX))
struct AmbientLight {
  vec3 color;
};

struct PointLight {
  vec3 color;
  vec3 position;
  vec3 attenuation; // 2nd order x:Constant-y:Linear-z:Exponential
};

struct DirectionalLight {
  vec3 color;
  vec3 direction;
};

uniform lightingUniforms {
  int enabled;
  int lightType;

  int directionalLightCount;
  int pointLightCount;

  vec3 ambientColor;

  vec3 lightColor0;
  vec3 lightPosition0;
  vec3 lightDirection0;
  vec3 lightAttenuation0;

  vec3 lightColor1;
  vec3 lightPosition1;
  vec3 lightDirection1;
  vec3 lightAttenuation1;

  vec3 lightColor2;
  vec3 lightPosition2;
  vec3 lightDirection2;
  vec3 lightAttenuation2;
} lighting;

PointLight lighting_getPointLight(int index) {
  switch (index) {
    case 0:
      return PointLight(lighting.lightColor0, lighting.lightPosition0, lighting.lightAttenuation0);
    case 1:
      return PointLight(lighting.lightColor1, lighting.lightPosition1, lighting.lightAttenuation1);
    case 2:
    default:  
      return PointLight(lighting.lightColor2, lighting.lightPosition2, lighting.lightAttenuation2);
  }
}

DirectionalLight lighting_getDirectionalLight(int index) {
  switch (index) {
    case 0:
      return DirectionalLight(lighting.lightColor0, lighting.lightDirection0);
    case 1:
      return DirectionalLight(lighting.lightColor1, lighting.lightDirection1);
    case 2:
    default:   
      return DirectionalLight(lighting.lightColor2, lighting.lightDirection2);
  }
} 

float getPointLightAttenuation(PointLight pointLight, float distance) {
  return pointLight.attenuation.x
       + pointLight.attenuation.y * distance
       + pointLight.attenuation.z * distance * distance;
}

// #endif
`,W6=`// #if (defined(SHADER_TYPE_FRAGMENT) && defined(LIGHTING_FRAGMENT)) || (defined(SHADER_TYPE_VERTEX) && defined(LIGHTING_VERTEX))
struct AmbientLight {
  color: vec3<f32>,
};

struct PointLight {
  color: vec3<f32>,
  position: vec3<f32>,
  attenuation: vec3<f32>, // 2nd order x:Constant-y:Linear-z:Exponential
};

struct DirectionalLight {
  color: vec3<f32>,
  direction: vec3<f32>,
};

struct lightingUniforms {
  enabled: i32,
  poightCount: i32,
  directionalLightCount: i32,

  ambientColor: vec3<f32>,

  // TODO - support multiple lights by uncommenting arrays below
  lightType: i32,
  lightColor: vec3<f32>,
  lightDirection: vec3<f32>,
  lightPosition: vec3<f32>,
  lightAttenuation: vec3<f32>,

  // AmbientLight ambientLight;
  // PointLight pointLight[MAX_LIGHTS];
  // DirectionalLight directionalLight[MAX_LIGHTS];
};

// Binding 0:1 is reserved for lighting (Note: could go into separate bind group as it is stable across draw calls)
@binding(1) @group(0) var<uniform> lighting : lightingUniforms;

fn lighting_getPointLight(index: i32) -> PointLight {
  return PointLight(lighting.lightColor, lighting.lightPosition, lighting.lightAttenuation);
}

fn lighting_getDirectionalLight(index: i32) -> DirectionalLight {
  return DirectionalLight(lighting.lightColor, lighting.lightDirection);
} 

fn getPointLightAttenuation(pointLight: PointLight, distance: f32) -> f32 {
  return pointLight.attenuation.x
       + pointLight.attenuation.y * distance
       + pointLight.attenuation.z * distance * distance;
}
`,KR=3,q6=255;var gm;(function(i){i[i.POINT=0]="POINT",i[i.DIRECTIONAL=1]="DIRECTIONAL"})(gm||(gm={}));const Yg={props:{},uniforms:{},name:"lighting",defines:{MAX_LIGHTS:KR},uniformTypes:{enabled:"i32",lightType:"i32",directionalLightCount:"i32",pointLightCount:"i32",ambientLightColor:"vec3<f32>",lightColor0:"vec3<f32>",lightPosition0:"vec3<f32>",lightDirection0:"vec3<f32>",lightAttenuation0:"vec3<f32>",lightColor1:"vec3<f32>",lightPosition1:"vec3<f32>",lightDirection1:"vec3<f32>",lightAttenuation1:"vec3<f32>",lightColor2:"vec3<f32>",lightPosition2:"vec3<f32>",lightDirection2:"vec3<f32>",lightAttenuation2:"vec3<f32>"},defaultUniforms:{enabled:1,lightType:gm.POINT,directionalLightCount:0,pointLightCount:0,ambientLightColor:[.1,.1,.1],lightColor0:[1,1,1],lightPosition0:[1,1,2],lightDirection0:[1,1,1],lightAttenuation0:[1,0,0],lightColor1:[1,1,1],lightPosition1:[1,1,2],lightDirection1:[1,1,1],lightAttenuation1:[1,0,0],lightColor2:[1,1,1],lightPosition2:[1,1,2],lightDirection2:[1,1,1],lightAttenuation2:[1,0,0]},source:W6,vs:p3,fs:p3,getUniforms:X6};function X6(i,e={}){if(i=i&&{...i},!i)return{...Yg.defaultUniforms};i.lights&&(i={...i,...Y6(i.lights),lights:void 0});const{ambientLight:t,pointLights:r,directionalLights:a}=i||{};if(!(t||r&&r.length>0||a&&a.length>0))return{...Yg.defaultUniforms,enabled:0};const y={...Yg.defaultUniforms,...e,...Z6({ambientLight:t,pointLights:r,directionalLights:a})};return i.enabled!==void 0&&(y.enabled=i.enabled?1:0),y}function Z6({ambientLight:i,pointLights:e=[],directionalLights:t=[]}){const r={};r.ambientLightColor=Kx(i);let a=0;for(const h of e){r.lightType=gm.POINT;const y=a;r[`lightColor${y}`]=Kx(h),r[`lightPosition${y}`]=h.position,r[`lightAttenuation${y}`]=h.attenuation||[1,0,0],a++}for(const h of t){r.lightType=gm.DIRECTIONAL;const y=a;r[`lightColor${y}`]=Kx(h),r[`lightDirection${y}`]=h.direction,a++}return a>KR&&Gt.warn("MAX_LIGHTS exceeded")(),r.directionalLightCount=t.length,r.pointLightCount=e.length,r}function Y6(i){var t,r;const e={pointLights:[],directionalLights:[]};for(const a of i||[])switch(a.type){case"ambient":e.ambientLight=a;break;case"directional":(t=e.directionalLights)==null||t.push(a);break;case"point":(r=e.pointLights)==null||r.push(a);break}return e}function Kx(i={}){const{color:e=[0,0,0],intensity:t=1}=i;return e.map(r=>r*t/q6)}const K6=`out vec3 pbr_vPosition;
out vec2 pbr_vUV;

#ifdef HAS_NORMALS
# ifdef HAS_TANGENTS
out mat3 pbr_vTBN;
# else
out vec3 pbr_vNormal;
# endif
#endif

void pbr_setPositionNormalTangentUV(vec4 position, vec4 normal, vec4 tangent, vec2 uv)
{
  vec4 pos = pbrProjection.modelMatrix * position;
  pbr_vPosition = vec3(pos.xyz) / pos.w;

#ifdef HAS_NORMALS
#ifdef HAS_TANGENTS
  vec3 normalW = normalize(vec3(pbrProjection.normalMatrix * vec4(normal.xyz, 0.0)));
  vec3 tangentW = normalize(vec3(pbrProjection.modelMatrix * vec4(tangent.xyz, 0.0)));
  vec3 bitangentW = cross(normalW, tangentW) * tangent.w;
  pbr_vTBN = mat3(tangentW, bitangentW, normalW);
#else // HAS_TANGENTS != 1
  pbr_vNormal = normalize(vec3(pbrProjection.modelMatrix * vec4(normal.xyz, 0.0)));
#endif
#endif

#ifdef HAS_UV
  pbr_vUV = uv;
#else
  pbr_vUV = vec2(0.,0.);
#endif
}
`,J6=`precision highp float;

uniform pbrMaterialUniforms {
  // Material is unlit
  bool unlit;

  // Base color map
  bool baseColorMapEnabled;
  vec4 baseColorFactor;

  bool normalMapEnabled;  
  float normalScale; // #ifdef HAS_NORMALMAP

  bool emissiveMapEnabled;
  vec3 emissiveFactor; // #ifdef HAS_EMISSIVEMAP

  vec2 metallicRoughnessValues;
  bool metallicRoughnessMapEnabled;

  bool occlusionMapEnabled;
  float occlusionStrength; // #ifdef HAS_OCCLUSIONMAP
  
  bool alphaCutoffEnabled;
  float alphaCutoff; // #ifdef ALPHA_CUTOFF
  
  // IBL
  bool IBLenabled;
  vec2 scaleIBLAmbient; // #ifdef USE_IBL
  
  // debugging flags used for shader output of intermediate PBR variables
  // #ifdef PBR_DEBUG
  vec4 scaleDiffBaseMR;
  vec4 scaleFGDSpec;
  // #endif
} pbrMaterial;

// Samplers
#ifdef HAS_BASECOLORMAP
uniform sampler2D pbr_baseColorSampler;
#endif
#ifdef HAS_NORMALMAP
uniform sampler2D pbr_normalSampler;
#endif
#ifdef HAS_EMISSIVEMAP
uniform sampler2D pbr_emissiveSampler;
#endif
#ifdef HAS_METALROUGHNESSMAP
uniform sampler2D pbr_metallicRoughnessSampler;
#endif
#ifdef HAS_OCCLUSIONMAP
uniform sampler2D pbr_occlusionSampler;
#endif
#ifdef USE_IBL
uniform samplerCube pbr_diffuseEnvSampler;
uniform samplerCube pbr_specularEnvSampler;
uniform sampler2D pbr_brdfLUT;
#endif

// Inputs from vertex shader

in vec3 pbr_vPosition;
in vec2 pbr_vUV;

#ifdef HAS_NORMALS
#ifdef HAS_TANGENTS
in mat3 pbr_vTBN;
#else
in vec3 pbr_vNormal;
#endif
#endif

// Encapsulate the various inputs used by the various functions in the shading equation
// We store values in this struct to simplify the integration of alternative implementations
// of the shading terms, outlined in the Readme.MD Appendix.
struct PBRInfo {
  float NdotL;                  // cos angle between normal and light direction
  float NdotV;                  // cos angle between normal and view direction
  float NdotH;                  // cos angle between normal and half vector
  float LdotH;                  // cos angle between light direction and half vector
  float VdotH;                  // cos angle between view direction and half vector
  float perceptualRoughness;    // roughness value, as authored by the model creator (input to shader)
  float metalness;              // metallic value at the surface
  vec3 reflectance0;            // full reflectance color (normal incidence angle)
  vec3 reflectance90;           // reflectance color at grazing angle
  float alphaRoughness;         // roughness mapped to a more linear change in the roughness (proposed by [2])
  vec3 diffuseColor;            // color contribution from diffuse lighting
  vec3 specularColor;           // color contribution from specular lighting
  vec3 n;                       // normal at surface point
  vec3 v;                       // vector from surface point to camera
};

const float M_PI = 3.141592653589793;
const float c_MinRoughness = 0.04;

vec4 SRGBtoLINEAR(vec4 srgbIn)
{
#ifdef MANUAL_SRGB
#ifdef SRGB_FAST_APPROXIMATION
  vec3 linOut = pow(srgbIn.xyz,vec3(2.2));
#else // SRGB_FAST_APPROXIMATION
  vec3 bLess = step(vec3(0.04045),srgbIn.xyz);
  vec3 linOut = mix( srgbIn.xyz/vec3(12.92), pow((srgbIn.xyz+vec3(0.055))/vec3(1.055),vec3(2.4)), bLess );
#endif //SRGB_FAST_APPROXIMATION
  return vec4(linOut,srgbIn.w);;
#else //MANUAL_SRGB
  return srgbIn;
#endif //MANUAL_SRGB
}

// Find the normal for this fragment, pulling either from a predefined normal map
// or from the interpolated mesh normal and tangent attributes.
vec3 getNormal()
{
  // Retrieve the tangent space matrix
#ifndef HAS_TANGENTS
  vec3 pos_dx = dFdx(pbr_vPosition);
  vec3 pos_dy = dFdy(pbr_vPosition);
  vec3 tex_dx = dFdx(vec3(pbr_vUV, 0.0));
  vec3 tex_dy = dFdy(vec3(pbr_vUV, 0.0));
  vec3 t = (tex_dy.t * pos_dx - tex_dx.t * pos_dy) / (tex_dx.s * tex_dy.t - tex_dy.s * tex_dx.t);

#ifdef HAS_NORMALS
  vec3 ng = normalize(pbr_vNormal);
#else
  vec3 ng = cross(pos_dx, pos_dy);
#endif

  t = normalize(t - ng * dot(ng, t));
  vec3 b = normalize(cross(ng, t));
  mat3 tbn = mat3(t, b, ng);
#else // HAS_TANGENTS
  mat3 tbn = pbr_vTBN;
#endif

#ifdef HAS_NORMALMAP
  vec3 n = texture(pbr_normalSampler, pbr_vUV).rgb;
  n = normalize(tbn * ((2.0 * n - 1.0) * vec3(pbrMaterial.normalScale, pbrMaterial.normalScale, 1.0)));
#else
  // The tbn matrix is linearly interpolated, so we need to re-normalize
  vec3 n = normalize(tbn[2].xyz);
#endif

  return n;
}

// Calculation of the lighting contribution from an optional Image Based Light source.
// Precomputed Environment Maps are required uniform inputs and are computed as outlined in [1].
// See our README.md on Environment Maps [3] for additional discussion.
#ifdef USE_IBL
vec3 getIBLContribution(PBRInfo pbrInfo, vec3 n, vec3 reflection)
{
  float mipCount = 9.0; // resolution of 512x512
  float lod = (pbrInfo.perceptualRoughness * mipCount);
  // retrieve a scale and bias to F0. See [1], Figure 3
  vec3 brdf = SRGBtoLINEAR(texture(pbr_brdfLUT,
    vec2(pbrInfo.NdotV, 1.0 - pbrInfo.perceptualRoughness))).rgb;
  vec3 diffuseLight = SRGBtoLINEAR(texture(pbr_diffuseEnvSampler, n)).rgb;

#ifdef USE_TEX_LOD
  vec3 specularLight = SRGBtoLINEAR(texture(pbr_specularEnvSampler, reflection, lod)).rgb;
#else
  vec3 specularLight = SRGBtoLINEAR(texture(pbr_specularEnvSampler, reflection)).rgb;
#endif

  vec3 diffuse = diffuseLight * pbrInfo.diffuseColor;
  vec3 specular = specularLight * (pbrInfo.specularColor * brdf.x + brdf.y);

  // For presentation, this allows us to disable IBL terms
  diffuse *= pbrMaterial.scaleIBLAmbient.x;
  specular *= pbrMaterial.scaleIBLAmbient.y;

  return diffuse + specular;
}
#endif

// Basic Lambertian diffuse
// Implementation from Lambert's Photometria https://archive.org/details/lambertsphotome00lambgoog
// See also [1], Equation 1
vec3 diffuse(PBRInfo pbrInfo)
{
  return pbrInfo.diffuseColor / M_PI;
}

// The following equation models the Fresnel reflectance term of the spec equation (aka F())
// Implementation of fresnel from [4], Equation 15
vec3 specularReflection(PBRInfo pbrInfo)
{
  return pbrInfo.reflectance0 +
    (pbrInfo.reflectance90 - pbrInfo.reflectance0) *
    pow(clamp(1.0 - pbrInfo.VdotH, 0.0, 1.0), 5.0);
}

// This calculates the specular geometric attenuation (aka G()),
// where rougher material will reflect less light back to the viewer.
// This implementation is based on [1] Equation 4, and we adopt their modifications to
// alphaRoughness as input as originally proposed in [2].
float geometricOcclusion(PBRInfo pbrInfo)
{
  float NdotL = pbrInfo.NdotL;
  float NdotV = pbrInfo.NdotV;
  float r = pbrInfo.alphaRoughness;

  float attenuationL = 2.0 * NdotL / (NdotL + sqrt(r * r + (1.0 - r * r) * (NdotL * NdotL)));
  float attenuationV = 2.0 * NdotV / (NdotV + sqrt(r * r + (1.0 - r * r) * (NdotV * NdotV)));
  return attenuationL * attenuationV;
}

// The following equation(s) model the distribution of microfacet normals across
// the area being drawn (aka D())
// Implementation from "Average Irregularity Representation of a Roughened Surface
// for Ray Reflection" by T. S. Trowbridge, and K. P. Reitz
// Follows the distribution function recommended in the SIGGRAPH 2013 course notes
// from EPIC Games [1], Equation 3.
float microfacetDistribution(PBRInfo pbrInfo)
{
  float roughnessSq = pbrInfo.alphaRoughness * pbrInfo.alphaRoughness;
  float f = (pbrInfo.NdotH * roughnessSq - pbrInfo.NdotH) * pbrInfo.NdotH + 1.0;
  return roughnessSq / (M_PI * f * f);
}

void PBRInfo_setAmbientLight(inout PBRInfo pbrInfo) {
  pbrInfo.NdotL = 1.0;
  pbrInfo.NdotH = 0.0;
  pbrInfo.LdotH = 0.0;
  pbrInfo.VdotH = 1.0;
}

void PBRInfo_setDirectionalLight(inout PBRInfo pbrInfo, vec3 lightDirection) {
  vec3 n = pbrInfo.n;
  vec3 v = pbrInfo.v;
  vec3 l = normalize(lightDirection);             // Vector from surface point to light
  vec3 h = normalize(l+v);                        // Half vector between both l and v

  pbrInfo.NdotL = clamp(dot(n, l), 0.001, 1.0);
  pbrInfo.NdotH = clamp(dot(n, h), 0.0, 1.0);
  pbrInfo.LdotH = clamp(dot(l, h), 0.0, 1.0);
  pbrInfo.VdotH = clamp(dot(v, h), 0.0, 1.0);
}

void PBRInfo_setPointLight(inout PBRInfo pbrInfo, PointLight pointLight) {
  vec3 light_direction = normalize(pointLight.position - pbr_vPosition);
  PBRInfo_setDirectionalLight(pbrInfo, light_direction);
}

vec3 calculateFinalColor(PBRInfo pbrInfo, vec3 lightColor) {
  // Calculate the shading terms for the microfacet specular shading model
  vec3 F = specularReflection(pbrInfo);
  float G = geometricOcclusion(pbrInfo);
  float D = microfacetDistribution(pbrInfo);

  // Calculation of analytical lighting contribution
  vec3 diffuseContrib = (1.0 - F) * diffuse(pbrInfo);
  vec3 specContrib = F * G * D / (4.0 * pbrInfo.NdotL * pbrInfo.NdotV);
  // Obtain final intensity as reflectance (BRDF) scaled by the energy of the light (cosine law)
  return pbrInfo.NdotL * lightColor * (diffuseContrib + specContrib);
}

vec4 pbr_filterColor(vec4 colorUnused)
{
  // The albedo may be defined from a base texture or a flat color
#ifdef HAS_BASECOLORMAP
  vec4 baseColor = SRGBtoLINEAR(texture(pbr_baseColorSampler, pbr_vUV)) * pbrMaterial.baseColorFactor;
#else
  vec4 baseColor = pbrMaterial.baseColorFactor;
#endif

#ifdef ALPHA_CUTOFF
  if (baseColor.a < pbrMaterial.alphaCutoff) {
    discard;
  }
#endif

  vec3 color = vec3(0, 0, 0);

  if(pbrMaterial.unlit){
    color.rgb = baseColor.rgb;
  }
  else{
    // Metallic and Roughness material properties are packed together
    // In glTF, these factors can be specified by fixed scalar values
    // or from a metallic-roughness map
    float perceptualRoughness = pbrMaterial.metallicRoughnessValues.y;
    float metallic = pbrMaterial.metallicRoughnessValues.x;
#ifdef HAS_METALROUGHNESSMAP
    // Roughness is stored in the 'g' channel, metallic is stored in the 'b' channel.
    // This layout intentionally reserves the 'r' channel for (optional) occlusion map data
    vec4 mrSample = texture(pbr_metallicRoughnessSampler, pbr_vUV);
    perceptualRoughness = mrSample.g * perceptualRoughness;
    metallic = mrSample.b * metallic;
#endif
    perceptualRoughness = clamp(perceptualRoughness, c_MinRoughness, 1.0);
    metallic = clamp(metallic, 0.0, 1.0);
    // Roughness is authored as perceptual roughness; as is convention,
    // convert to material roughness by squaring the perceptual roughness [2].
    float alphaRoughness = perceptualRoughness * perceptualRoughness;

    vec3 f0 = vec3(0.04);
    vec3 diffuseColor = baseColor.rgb * (vec3(1.0) - f0);
    diffuseColor *= 1.0 - metallic;
    vec3 specularColor = mix(f0, baseColor.rgb, metallic);

    // Compute reflectance.
    float reflectance = max(max(specularColor.r, specularColor.g), specularColor.b);

    // For typical incident reflectance range (between 4% to 100%) set the grazing
    // reflectance to 100% for typical fresnel effect.
    // For very low reflectance range on highly diffuse objects (below 4%),
    // incrementally reduce grazing reflecance to 0%.
    float reflectance90 = clamp(reflectance * 25.0, 0.0, 1.0);
    vec3 specularEnvironmentR0 = specularColor.rgb;
    vec3 specularEnvironmentR90 = vec3(1.0, 1.0, 1.0) * reflectance90;

    vec3 n = getNormal();                          // normal at surface point
    vec3 v = normalize(pbrProjection.camera - pbr_vPosition);  // Vector from surface point to camera

    float NdotV = clamp(abs(dot(n, v)), 0.001, 1.0);
    vec3 reflection = -normalize(reflect(v, n));

    PBRInfo pbrInfo = PBRInfo(
      0.0, // NdotL
      NdotV,
      0.0, // NdotH
      0.0, // LdotH
      0.0, // VdotH
      perceptualRoughness,
      metallic,
      specularEnvironmentR0,
      specularEnvironmentR90,
      alphaRoughness,
      diffuseColor,
      specularColor,
      n,
      v
    );


#ifdef USE_LIGHTS
    // Apply ambient light
    PBRInfo_setAmbientLight(pbrInfo);
    color += calculateFinalColor(pbrInfo, lighting.ambientColor);

    // Apply directional light
    for(int i = 0; i < lighting.directionalLightCount; i++) {
      if (i < lighting.directionalLightCount) {
        PBRInfo_setDirectionalLight(pbrInfo, lighting_getDirectionalLight(i).direction);
        color += calculateFinalColor(pbrInfo, lighting_getDirectionalLight(i).color);
      }
    }

    // Apply point light
    for(int i = 0; i < lighting.pointLightCount; i++) {
      if (i < lighting.pointLightCount) {
        PBRInfo_setPointLight(pbrInfo, lighting_getPointLight(i));
        float attenuation = getPointLightAttenuation(lighting_getPointLight(i), distance(lighting_getPointLight(i).position, pbr_vPosition));
        color += calculateFinalColor(pbrInfo, lighting_getPointLight(i).color / attenuation);
      }
    }
#endif

    // Calculate lighting contribution from image based lighting source (IBL)
#ifdef USE_IBL
    if (pbrMaterial.IBLenabled) {
      color += getIBLContribution(pbrInfo, n, reflection);
    }
#endif

 // Apply optional PBR terms for additional (optional) shading
#ifdef HAS_OCCLUSIONMAP
    if (pbrMaterial.occlusionMapEnabled) {
      float ao = texture(pbr_occlusionSampler, pbr_vUV).r;
      color = mix(color, color * ao, pbrMaterial.occlusionStrength);
    }
#endif

#ifdef HAS_EMISSIVEMAP
    if (pbrMaterial.emissiveMapEnabled) {
      vec3 emissive = SRGBtoLINEAR(texture(pbr_emissiveSampler, pbr_vUV)).rgb * pbrMaterial.emissiveFactor;
      color += emissive;
    }
#endif

    // This section uses mix to override final color for reference app visualization
    // of various parameters in the lighting equation.
#ifdef PBR_DEBUG
    // TODO: Figure out how to debug multiple lights

    // color = mix(color, F, pbr_scaleFGDSpec.x);
    // color = mix(color, vec3(G), pbr_scaleFGDSpec.y);
    // color = mix(color, vec3(D), pbr_scaleFGDSpec.z);
    // color = mix(color, specContrib, pbr_scaleFGDSpec.w);

    // color = mix(color, diffuseContrib, pbr_scaleDiffBaseMR.x);
    color = mix(color, baseColor.rgb, pbrMaterial.scaleDiffBaseMR.y);
    color = mix(color, vec3(metallic), pbrMaterial.scaleDiffBaseMR.z);
    color = mix(color, vec3(perceptualRoughness), pbrMaterial.scaleDiffBaseMR.w);
#endif

  }

  return vec4(pow(color,vec3(1.0/2.2)), baseColor.a);
}
`,m3=`uniform pbrProjectionUniforms {
  mat4 modelViewProjectionMatrix;
  mat4 modelMatrix;
  mat4 normalMatrix;
  vec3 camera;
} pbrProjection;
`,Q6={name:"pbrProjection",vs:m3,fs:m3,getUniforms:i=>i,uniformTypes:{modelViewProjectionMatrix:"mat4x4<f32>",modelMatrix:"mat4x4<f32>",normalMatrix:"mat4x4<f32>",camera:"vec3<i32>"}},JR={props:{},uniforms:{},name:"pbrMaterial",dependencies:[Yg,Q6],vs:K6,fs:J6,defines:{LIGHTING_FRAGMENT:1},getUniforms:i=>i,uniformTypes:{unlit:"i32",baseColorMapEnabled:"i32",baseColorFactor:"vec4<f32>",normalMapEnabled:"i32",normalScale:"f32",emissiveMapEnabled:"i32",emissiveFactor:"vec3<f32>",metallicRoughnessValues:"vec2<f32>",metallicRoughnessMapEnabled:"i32",occlusionMapEnabled:"i32",occlusionStrength:"f32",alphaCutoffEnabled:"i32",alphaCutoff:"f32",IBLenabled:"i32",scaleIBLAmbient:"vec2<f32>",scaleDiffBaseMR:"vec4<f32>",scaleFGDSpec:"vec4<f32>"}},_3=`uniform layerUniforms {
  uniform float opacity;
} layer;
`,eV={name:"layer",vs:_3,fs:_3,getUniforms:i=>({opacity:Math.pow(i.opacity,1/2.2)}),uniformTypes:{opacity:"f32"}},tV=`const SMOOTH_EDGE_RADIUS: f32 = 0.5;

struct VertexGeometry {
  position: vec4<f32>,
  worldPosition: vec3<f32>,
  worldPositionAlt: vec3<f32>,
  normal: vec3<f32>,
  uv: vec2<f32>,
  pickingColor: vec3<f32>,
};

var<private> geometry_: VertexGeometry = VertexGeometry(
  vec4<f32>(0.0, 0.0, 1.0, 0.0),
  vec3<f32>(0.0, 0.0, 0.0),
  vec3<f32>(0.0, 0.0, 0.0),
  vec3<f32>(0.0, 0.0, 0.0),
  vec2<f32>(0.0, 0.0),
  vec3<f32>(0.0, 0.0, 0.0)
);

struct FragmentGeometry {
  uv: vec2<f32>,
};

var<private> fragmentGeometry: FragmentGeometry;

fn smoothedge(edge: f32, x: f32) -> f32 {
  return smoothstep(edge - SMOOTH_EDGE_RADIUS, edge + SMOOTH_EDGE_RADIUS, x);
}
`,QR="#define SMOOTH_EDGE_RADIUS 0.5",iV=`${QR}

struct VertexGeometry {
  vec4 position;
  vec3 worldPosition;
  vec3 worldPositionAlt;
  vec3 normal;
  vec2 uv;
  vec3 pickingColor;
} geometry = VertexGeometry(
  vec4(0.0, 0.0, 1.0, 0.0),
  vec3(0.0),
  vec3(0.0),
  vec3(0.0),
  vec2(0.0),
  vec3(0.0)
);
`,rV=`${QR}

struct FragmentGeometry {
  vec2 uv;
} geometry;

float smoothedge(float edge, float x) {
  return smoothstep(edge - SMOOTH_EDGE_RADIUS, edge + SMOOTH_EDGE_RADIUS, x);
}
`,eP={name:"geometry",source:tV,vs:iV,fs:rV},nV=25;var pn;(function(i){i[i.Start=1]="Start",i[i.Move=2]="Move",i[i.End=4]="End",i[i.Cancel=8]="Cancel"})(pn||(pn={}));var Sn;(function(i){i[i.None=0]="None",i[i.Left=1]="Left",i[i.Right=2]="Right",i[i.Up=4]="Up",i[i.Down=8]="Down",i[i.Horizontal=3]="Horizontal",i[i.Vertical=12]="Vertical",i[i.All=15]="All"})(Sn||(Sn={}));var qi;(function(i){i[i.Possible=1]="Possible",i[i.Began=2]="Began",i[i.Changed=4]="Changed",i[i.Ended=8]="Ended",i[i.Recognized=8]="Recognized",i[i.Cancelled=16]="Cancelled",i[i.Failed=32]="Failed"})(qi||(qi={}));const sV="compute",oV="auto",j1="manipulation",Kg="none",H1="pan-x",G1="pan-y";function aV(i){if(i.includes(Kg))return Kg;const e=i.includes(H1),t=i.includes(G1);return e&&t?Kg:e||t?e?H1:G1:i.includes(j1)?j1:oV}class lV{constructor(e,t){this.actions="",this.manager=e,this.set(t)}set(e){e===sV&&(e=this.compute()),this.manager.element&&(this.manager.element.style.touchAction=e,this.actions=e)}update(){this.set(this.manager.options.touchAction)}compute(){let e=[];for(const t of this.manager.recognizers)t.options.enable&&(e=e.concat(t.getTouchAction()));return aV(e.join(" "))}}function Ry(i){return i.trim().split(/\s+/g)}function Jx(i,e,t){if(i)for(const r of Ry(e))i.addEventListener(r,t,!1)}function Qx(i,e,t){if(i)for(const r of Ry(e))i.removeEventListener(r,t,!1)}function g3(i){return(i.ownerDocument||i).defaultView}function cV(i,e){let t=i;for(;t;){if(t===e)return!0;t=t.parentNode}return!1}function tP(i){const e=i.length;if(e===1)return{x:Math.round(i[0].clientX),y:Math.round(i[0].clientY)};let t=0,r=0,a=0;for(;a<e;)t+=i[a].clientX,r+=i[a].clientY,a++;return{x:Math.round(t/e),y:Math.round(r/e)}}function y3(i){const e=[];let t=0;for(;t<i.pointers.length;)e[t]={clientX:Math.round(i.pointers[t].clientX),clientY:Math.round(i.pointers[t].clientY)},t++;return{timeStamp:Date.now(),pointers:e,center:tP(e),deltaX:i.deltaX,deltaY:i.deltaY}}function iP(i,e){const t=e.x-i.x,r=e.y-i.y;return Math.sqrt(t*t+r*r)}function v3(i,e){const t=e.clientX-i.clientX,r=e.clientY-i.clientY;return Math.sqrt(t*t+r*r)}function uV(i,e){const t=e.x-i.x,r=e.y-i.y;return Math.atan2(r,t)*180/Math.PI}function x3(i,e){const t=e.clientX-i.clientX,r=e.clientY-i.clientY;return Math.atan2(r,t)*180/Math.PI}function rP(i,e){return i===e?Sn.None:Math.abs(i)>=Math.abs(e)?i<0?Sn.Left:Sn.Right:e<0?Sn.Up:Sn.Down}function hV(i,e){const t=e.center;let r=i.offsetDelta,a=i.prevDelta;const h=i.prevInput;return(e.eventType===pn.Start||(h==null?void 0:h.eventType)===pn.End)&&(a=i.prevDelta={x:(h==null?void 0:h.deltaX)||0,y:(h==null?void 0:h.deltaY)||0},r=i.offsetDelta={x:t.x,y:t.y}),{deltaX:a.x+(t.x-r.x),deltaY:a.y+(t.y-r.y)}}function nP(i,e,t){return{x:e/i||0,y:t/i||0}}function dV(i,e){return v3(e[0],e[1])/v3(i[0],i[1])}function fV(i,e){return x3(e[1],e[0])-x3(i[1],i[0])}function pV(i,e){const t=i.lastInterval||e,r=e.timeStamp-t.timeStamp;let a,h,y,s;if(e.eventType!==pn.Cancel&&(r>nV||t.velocity===void 0)){const T=e.deltaX-t.deltaX,B=e.deltaY-t.deltaY,F=nP(r,T,B);h=F.x,y=F.y,a=Math.abs(F.x)>Math.abs(F.y)?F.x:F.y,s=rP(T,B),i.lastInterval=e}else a=t.velocity,h=t.velocityX,y=t.velocityY,s=t.direction;e.velocity=a,e.velocityX=h,e.velocityY=y,e.direction=s}function mV(i,e){const{session:t}=i,{pointers:r}=e,{length:a}=r;t.firstInput||(t.firstInput=y3(e)),a>1&&!t.firstMultiple?t.firstMultiple=y3(e):a===1&&(t.firstMultiple=!1);const{firstInput:h,firstMultiple:y}=t,s=y?y.center:h.center,T=e.center=tP(r);e.timeStamp=Date.now(),e.deltaTime=e.timeStamp-h.timeStamp,e.angle=uV(s,T),e.distance=iP(s,T);const{deltaX:B,deltaY:F}=hV(t,e);e.deltaX=B,e.deltaY=F,e.offsetDirection=rP(e.deltaX,e.deltaY);const V=nP(e.deltaTime,e.deltaX,e.deltaY);e.overallVelocityX=V.x,e.overallVelocityY=V.y,e.overallVelocity=Math.abs(V.x)>Math.abs(V.y)?V.x:V.y,e.scale=y?dV(y.pointers,r):1,e.rotation=y?fV(y.pointers,r):0,e.maxPointers=t.prevInput?e.pointers.length>t.prevInput.maxPointers?e.pointers.length:t.prevInput.maxPointers:e.pointers.length;let X=i.element;return cV(e.srcEvent.target,X)&&(X=e.srcEvent.target),e.target=X,pV(t,e),e}function _V(i,e,t){const r=t.pointers.length,a=t.changedPointers.length,h=e&pn.Start&&r-a===0,y=e&(pn.End|pn.Cancel)&&r-a===0;t.isFirst=!!h,t.isFinal=!!y,h&&(i.session={}),t.eventType=e;const s=mV(i,t);i.emit("hammer.input",s),i.recognize(s),i.session.prevInput=s}let gV=class{constructor(e){this.evEl="",this.evWin="",this.evTarget="",this.domHandler=t=>{this.manager.options.enable&&this.handler(t)},this.manager=e,this.element=e.element,this.target=e.options.inputTarget||e.element}callback(e,t){_V(this.manager,e,t)}init(){Jx(this.element,this.evEl,this.domHandler),Jx(this.target,this.evTarget,this.domHandler),Jx(g3(this.element),this.evWin,this.domHandler)}destroy(){Qx(this.element,this.evEl,this.domHandler),Qx(this.target,this.evTarget,this.domHandler),Qx(g3(this.element),this.evWin,this.domHandler)}};const yV={pointerdown:pn.Start,pointermove:pn.Move,pointerup:pn.End,pointercancel:pn.Cancel,pointerout:pn.Cancel},vV="pointerdown",xV="pointermove pointerup pointercancel";class bV extends gV{constructor(e){super(e),this.evEl=vV,this.evWin=xV,this.store=this.manager.session.pointerEvents=[],this.init()}handler(e){const{store:t}=this;let r=!1;const a=yV[e.type],h=e.pointerType,y=h==="touch";let s=t.findIndex(T=>T.pointerId===e.pointerId);a&pn.Start&&(e.buttons||y)?s<0&&(t.push(e),s=t.length-1):a&(pn.End|pn.Cancel)&&(r=!0),!(s<0)&&(t[s]=e,this.callback(a,{pointers:t,changedPointers:[e],eventType:a,pointerType:h,srcEvent:e}),r&&t.splice(s,1))}}const wV=["","webkit","Moz","MS","ms","o"];function AV(i,e){const t=e[0].toUpperCase()+e.slice(1);for(const r of wV){const a=r?r+t:e;if(a in i)return a}}const TV=1,b3=2,w3={touchAction:"compute",enable:!0,inputTarget:null,cssProps:{userSelect:"none",userDrag:"none",touchCallout:"none",tapHighlightColor:"rgba(0,0,0,0)"}};class EV{constructor(e,t){this.options={...w3,...t,cssProps:{...w3.cssProps,...t.cssProps},inputTarget:t.inputTarget||e},this.handlers={},this.session={},this.recognizers=[],this.oldCssProps={},this.element=e,this.input=new bV(this),this.touchAction=new lV(this,this.options.touchAction),this.toggleCssProps(!0)}set(e){return Object.assign(this.options,e),e.touchAction&&this.touchAction.update(),e.inputTarget&&(this.input.destroy(),this.input.target=e.inputTarget,this.input.init()),this}stop(e){this.session.stopped=e?b3:TV}recognize(e){const{session:t}=this;if(t.stopped)return;this.session.prevented&&e.srcEvent.preventDefault();let r;const{recognizers:a}=this;let{curRecognizer:h}=t;(!h||h&&h.state&qi.Recognized)&&(h=t.curRecognizer=null);let y=0;for(;y<a.length;)r=a[y],t.stopped!==b3&&(!h||r===h||r.canRecognizeWith(h))?r.recognize(e):r.reset(),!h&&r.state&(qi.Began|qi.Changed|qi.Ended)&&(h=t.curRecognizer=r),y++}get(e){const{recognizers:t}=this;for(let r=0;r<t.length;r++)if(t[r].options.event===e)return t[r];return null}add(e){if(Array.isArray(e)){for(const r of e)this.add(r);return this}const t=this.get(e.options.event);return t&&this.remove(t),this.recognizers.push(e),e.manager=this,this.touchAction.update(),e}remove(e){if(Array.isArray(e)){for(const r of e)this.remove(r);return this}const t=typeof e=="string"?this.get(e):e;if(t){const{recognizers:r}=this,a=r.indexOf(t);a!==-1&&(r.splice(a,1),this.touchAction.update())}return this}on(e,t){if(!e||!t)return;const{handlers:r}=this;for(const a of Ry(e))r[a]=r[a]||[],r[a].push(t)}off(e,t){if(!e)return;const{handlers:r}=this;for(const a of Ry(e))t?r[a]&&r[a].splice(r[a].indexOf(t),1):delete r[a]}emit(e,t){const r=this.handlers[e]&&this.handlers[e].slice();if(!r||!r.length)return;const a=t;a.type=e,a.preventDefault=function(){t.srcEvent.preventDefault()};let h=0;for(;h<r.length;)r[h](a),h++}destroy(){this.toggleCssProps(!1),this.handlers={},this.session={},this.input.destroy(),this.element=null}toggleCssProps(e){const{element:t}=this;if(t){for(const[r,a]of Object.entries(this.options.cssProps)){const h=AV(t.style,r);e?(this.oldCssProps[h]=t.style[h],t.style[h]=a):t.style[h]=this.oldCssProps[h]||""}e||(this.oldCssProps={})}}}let SV=1;function IV(){return SV++}function A3(i){return i&qi.Cancelled?"cancel":i&qi.Ended?"end":i&qi.Changed?"move":i&qi.Began?"start":""}class sP{constructor(e){this.options=e,this.id=IV(),this.state=qi.Possible,this.simultaneous={},this.requireFail=[]}set(e){return Object.assign(this.options,e),this.manager.touchAction.update(),this}recognizeWith(e){if(Array.isArray(e)){for(const a of e)this.recognizeWith(a);return this}let t;if(typeof e=="string"){if(t=this.manager.get(e),!t)throw new Error(`Cannot find recognizer ${e}`)}else t=e;const{simultaneous:r}=this;return r[t.id]||(r[t.id]=t,t.recognizeWith(this)),this}dropRecognizeWith(e){if(Array.isArray(e)){for(const r of e)this.dropRecognizeWith(r);return this}let t;return typeof e=="string"?t=this.manager.get(e):t=e,t&&delete this.simultaneous[t.id],this}requireFailure(e){if(Array.isArray(e)){for(const a of e)this.requireFailure(a);return this}let t;if(typeof e=="string"){if(t=this.manager.get(e),!t)throw new Error(`Cannot find recognizer ${e}`)}else t=e;const{requireFail:r}=this;return r.indexOf(t)===-1&&(r.push(t),t.requireFailure(this)),this}dropRequireFailure(e){if(Array.isArray(e)){for(const r of e)this.dropRequireFailure(r);return this}let t;if(typeof e=="string"?t=this.manager.get(e):t=e,t){const r=this.requireFail.indexOf(t);r>-1&&this.requireFail.splice(r,1)}return this}hasRequireFailures(){return!!this.requireFail.find(e=>e.options.enable)}canRecognizeWith(e){return!!this.simultaneous[e.id]}emit(e){if(!e)return;const{state:t}=this;t<qi.Ended&&this.manager.emit(this.options.event+A3(t),e),this.manager.emit(this.options.event,e),e.additionalEvent&&this.manager.emit(e.additionalEvent,e),t>=qi.Ended&&this.manager.emit(this.options.event+A3(t),e)}tryEmit(e){this.canEmit()?this.emit(e):this.state=qi.Failed}canEmit(){let e=0;for(;e<this.requireFail.length;){if(!(this.requireFail[e].state&(qi.Failed|qi.Possible)))return!1;e++}return!0}recognize(e){const t={...e};if(!this.options.enable){this.reset(),this.state=qi.Failed;return}this.state&(qi.Recognized|qi.Cancelled|qi.Failed)&&(this.state=qi.Possible),this.state=this.process(t),this.state&(qi.Began|qi.Changed|qi.Ended|qi.Cancelled)&&this.tryEmit(t)}getEventNames(){return[this.options.event]}reset(){}}class oP extends sP{attrTest(e){const t=this.options.pointers;return t===0||e.pointers.length===t}process(e){const{state:t}=this,{eventType:r}=e,a=t&(qi.Began|qi.Changed),h=this.attrTest(e);return a&&(r&pn.Cancel||!h)?t|qi.Cancelled:a||h?r&pn.End?t|qi.Ended:t&qi.Began?t|qi.Changed:qi.Began:qi.Failed}}class T3 extends sP{constructor(e={}){super({enable:!0,event:"tap",pointers:1,taps:1,interval:300,time:250,threshold:9,posThreshold:10,...e}),this.pTime=null,this.pCenter=null,this._timer=null,this._input=null,this.count=0}getTouchAction(){return[j1]}process(e){const{options:t}=this,r=e.pointers.length===t.pointers,a=e.distance<t.threshold,h=e.deltaTime<t.time;if(this.reset(),e.eventType&pn.Start&&this.count===0)return this.failTimeout();if(a&&h&&r){if(e.eventType!==pn.End)return this.failTimeout();const y=this.pTime?e.timeStamp-this.pTime<t.interval:!0,s=!this.pCenter||iP(this.pCenter,e.center)<t.posThreshold;if(this.pTime=e.timeStamp,this.pCenter=e.center,!s||!y?this.count=1:this.count+=1,this._input=e,this.count%t.taps===0)return this.hasRequireFailures()?(this._timer=setTimeout(()=>{this.state=qi.Recognized,this.tryEmit(this._input)},t.interval),qi.Began):qi.Recognized}return qi.Failed}failTimeout(){return this._timer=setTimeout(()=>{this.state=qi.Failed},this.options.interval),qi.Failed}reset(){clearTimeout(this._timer)}emit(e){this.state===qi.Recognized&&(e.tapCount=this.count,this.manager.emit(this.options.event,e))}}const CV=["","start","move","end","cancel","up","down","left","right"];class E3 extends oP{constructor(e={}){super({enable:!0,pointers:1,event:"pan",threshold:10,direction:Sn.All,...e}),this.pX=null,this.pY=null}getTouchAction(){const{options:{direction:e}}=this,t=[];return e&Sn.Horizontal&&t.push(G1),e&Sn.Vertical&&t.push(H1),t}getEventNames(){return CV.map(e=>this.options.event+e)}directionTest(e){const{options:t}=this;let r=!0,{distance:a}=e,{direction:h}=e;const y=e.deltaX,s=e.deltaY;return h&t.direction||(t.direction&Sn.Horizontal?(h=y===0?Sn.None:y<0?Sn.Left:Sn.Right,r=y!==this.pX,a=Math.abs(e.deltaX)):(h=s===0?Sn.None:s<0?Sn.Up:Sn.Down,r=s!==this.pY,a=Math.abs(e.deltaY))),e.direction=h,r&&a>t.threshold&&!!(h&t.direction)}attrTest(e){return super.attrTest(e)&&(!!(this.state&qi.Began)||!(this.state&qi.Began)&&this.directionTest(e))}emit(e){this.pX=e.deltaX,this.pY=e.deltaY;const t=Sn[e.direction].toLowerCase();t&&(e.additionalEvent=this.options.event+t),super.emit(e)}}const MV=["","start","move","end","cancel","in","out"];class RV extends oP{constructor(e={}){super({enable:!0,event:"pinch",threshold:0,pointers:2,...e})}getTouchAction(){return[Kg]}getEventNames(){return MV.map(e=>this.options.event+e)}attrTest(e){return super.attrTest(e)&&(Math.abs(e.scale-1)>this.options.threshold||!!(this.state&qi.Began))}emit(e){if(e.scale!==1){const t=e.scale<1?"in":"out";e.additionalEvent=this.options.event+t}super.emit(e)}}class g0{constructor(e,t,r){this.element=e,this.callback=t,this.options=r}}const PV=typeof navigator<"u"&&navigator.userAgent?navigator.userAgent.toLowerCase():"",BV=PV.indexOf("firefox")!==-1,S3=4.000244140625,DV=40,OV=.25;class FV extends g0{constructor(e,t,r){super(e,t,{enable:!0,...r}),this.handleEvent=a=>{if(!this.options.enable)return;let h=a.deltaY;globalThis.WheelEvent&&(BV&&a.deltaMode===globalThis.WheelEvent.DOM_DELTA_PIXEL&&(h/=globalThis.devicePixelRatio),a.deltaMode===globalThis.WheelEvent.DOM_DELTA_LINE&&(h*=DV)),h!==0&&h%S3===0&&(h=Math.floor(h/S3)),a.shiftKey&&h&&(h=h*OV),this.callback({type:"wheel",center:{x:a.clientX,y:a.clientY},delta:-h,srcEvent:a,pointerType:"mouse",target:a.target})},e.addEventListener("wheel",this.handleEvent,{passive:!1})}destroy(){this.element.removeEventListener("wheel",this.handleEvent)}enableEventType(e,t){e==="wheel"&&(this.options.enable=t)}}const I3=["mousedown","mousemove","mouseup","mouseover","mouseout","mouseleave"];class kV extends g0{constructor(e,t,r){super(e,t,{enable:!0,...r}),this.handleEvent=h=>{this.handleOverEvent(h),this.handleOutEvent(h),this.handleEnterEvent(h),this.handleLeaveEvent(h),this.handleMoveEvent(h)},this.pressed=!1;const{enable:a}=this.options;this.enableMoveEvent=a,this.enableLeaveEvent=a,this.enableEnterEvent=a,this.enableOutEvent=a,this.enableOverEvent=a,I3.forEach(h=>e.addEventListener(h,this.handleEvent))}destroy(){I3.forEach(e=>this.element.removeEventListener(e,this.handleEvent))}enableEventType(e,t){switch(e){case"pointermove":this.enableMoveEvent=t;break;case"pointerover":this.enableOverEvent=t;break;case"pointerout":this.enableOutEvent=t;break;case"pointerenter":this.enableEnterEvent=t;break;case"pointerleave":this.enableLeaveEvent=t;break}}handleOverEvent(e){this.enableOverEvent&&e.type==="mouseover"&&this._emit("pointerover",e)}handleOutEvent(e){this.enableOutEvent&&e.type==="mouseout"&&this._emit("pointerout",e)}handleEnterEvent(e){this.enableEnterEvent&&e.type==="mouseenter"&&this._emit("pointerenter",e)}handleLeaveEvent(e){this.enableLeaveEvent&&e.type==="mouseleave"&&this._emit("pointerleave",e)}handleMoveEvent(e){if(this.enableMoveEvent)switch(e.type){case"mousedown":e.button>=0&&(this.pressed=!0);break;case"mousemove":e.buttons===0&&(this.pressed=!1),this.pressed||this._emit("pointermove",e);break;case"mouseup":this.pressed=!1;break}}_emit(e,t){this.callback({type:e,center:{x:t.clientX,y:t.clientY},srcEvent:t,pointerType:"mouse",target:t.target})}}const C3=["keydown","keyup"];class LV extends g0{constructor(e,t,r){super(e,t,{enable:!0,tabIndex:0,...r}),this.handleEvent=a=>{const h=a.target||a.srcElement;h.tagName==="INPUT"&&h.type==="text"||h.tagName==="TEXTAREA"||(this.enableDownEvent&&a.type==="keydown"&&this.callback({type:"keydown",srcEvent:a,key:a.key,target:a.target}),this.enableUpEvent&&a.type==="keyup"&&this.callback({type:"keyup",srcEvent:a,key:a.key,target:a.target}))},this.enableDownEvent=this.options.enable,this.enableUpEvent=this.options.enable,e.tabIndex=this.options.tabIndex,e.style.outline="none",C3.forEach(a=>e.addEventListener(a,this.handleEvent))}destroy(){C3.forEach(e=>this.element.removeEventListener(e,this.handleEvent))}enableEventType(e,t){e==="keydown"&&(this.enableDownEvent=t),e==="keyup"&&(this.enableUpEvent=t)}}class NV extends g0{constructor(e,t,r){super(e,t,r),this.handleEvent=a=>{this.options.enable&&this.callback({type:"contextmenu",center:{x:a.clientX,y:a.clientY},srcEvent:a,pointerType:"mouse",target:a.target})},e.addEventListener("contextmenu",this.handleEvent)}destroy(){this.element.removeEventListener("contextmenu",this.handleEvent)}enableEventType(e,t){e==="contextmenu"&&(this.options.enable=t)}}const M3=1,$1=2,R3=4,zV={pointerdown:M3,pointermove:$1,pointerup:R3,mousedown:M3,mousemove:$1,mouseup:R3},UV=0,VV=1,jV=2,HV=1,GV=2,$V=4;function WV(i){const e=zV[i.srcEvent.type];if(!e)return null;const{buttons:t,button:r}=i.srcEvent;let a=!1,h=!1,y=!1;return e===$1?(a=!!(t&HV),h=!!(t&$V),y=!!(t&GV)):(a=r===UV,h=r===VV,y=r===jV),{leftButton:a,middleButton:h,rightButton:y}}function qV(i,e){const t=i.center;if(!t)return null;const r=e.getBoundingClientRect(),a=r.width/e.offsetWidth||1,h=r.height/e.offsetHeight||1,y={x:(t.x-r.left-e.clientLeft)/a,y:(t.y-r.top-e.clientTop)/h};return{center:t,offsetCenter:y}}const XV={srcElement:"root",priority:0};class ZV{constructor(e,t){this.handleEvent=r=>{if(this.isEmpty())return;const a=this._normalizeEvent(r);let h=r.srcEvent.target;for(;h&&h!==a.rootElement;){if(this._emit(a,h),a.handled)return;h=h.parentNode}this._emit(a,"root")},this.eventManager=e,this.recognizerName=t,this.handlers=[],this.handlersByElement=new Map,this._active=!1}isEmpty(){return!this._active}add(e,t,r,a=!1,h=!1){const{handlers:y,handlersByElement:s}=this,T={...XV,...r};let B=s.get(T.srcElement);B||(B=[],s.set(T.srcElement,B));const F={type:e,handler:t,srcElement:T.srcElement,priority:T.priority};a&&(F.once=!0),h&&(F.passive=!0),y.push(F),this._active=this._active||!F.passive;let V=B.length-1;for(;V>=0&&!(B[V].priority>=F.priority);)V--;B.splice(V+1,0,F)}remove(e,t){const{handlers:r,handlersByElement:a}=this;for(let h=r.length-1;h>=0;h--){const y=r[h];if(y.type===e&&y.handler===t){r.splice(h,1);const s=a.get(y.srcElement);s.splice(s.indexOf(y),1),s.length===0&&a.delete(y.srcElement)}}this._active=r.some(h=>!h.passive)}_emit(e,t){const r=this.handlersByElement.get(t);if(r){let a=!1;const h=()=>{e.handled=!0},y=()=>{e.handled=!0,a=!0},s=[];for(let T=0;T<r.length;T++){const{type:B,handler:F,once:V}=r[T];if(F({...e,type:B,stopPropagation:h,stopImmediatePropagation:y}),V&&s.push(r[T]),a)break}for(let T=0;T<s.length;T++){const{type:B,handler:F}=s[T];this.remove(B,F)}}}_normalizeEvent(e){const t=this.eventManager.getElement();return{...e,...WV(e),...qV(e,t),preventDefault:()=>{e.srcEvent.preventDefault()},stopImmediatePropagation:null,stopPropagation:null,handled:!1,rootElement:t}}}function YV(i){if("recognizer"in i)return i;let e;const t=Array.isArray(i)?[...i]:[i];if(typeof t[0]=="function"){const r=t.shift(),a=t.shift()||{};e=new r(a)}else e=t.shift();return{recognizer:e,recognizeWith:typeof t[0]=="string"?[t[0]]:t[0],requireFailure:typeof t[1]=="string"?[t[1]]:t[1]}}class KV{constructor(e=null,t={}){if(this._onBasicInput=r=>{this.manager.emit(r.srcEvent.type,r)},this._onOtherEvent=r=>{this.manager.emit(r.type,r)},this.options={recognizers:[],events:{},touchAction:"compute",tabIndex:0,cssProps:{},...t},this.events=new Map,this.element=e,!!e){this.manager=new EV(e,this.options);for(const r of this.options.recognizers){const{recognizer:a,recognizeWith:h,requireFailure:y}=YV(r);this.manager.add(a),h&&a.recognizeWith(h),y&&a.requireFailure(y)}this.manager.on("hammer.input",this._onBasicInput),this.wheelInput=new FV(e,this._onOtherEvent,{enable:!1}),this.moveInput=new kV(e,this._onOtherEvent,{enable:!1}),this.keyInput=new LV(e,this._onOtherEvent,{enable:!1,tabIndex:t.tabIndex}),this.contextmenuInput=new NV(e,this._onOtherEvent,{enable:!1}),this.on(this.options.events)}}getElement(){return this.element}destroy(){this.element&&(this.wheelInput.destroy(),this.moveInput.destroy(),this.keyInput.destroy(),this.contextmenuInput.destroy(),this.manager.destroy())}on(e,t,r){this._addEventHandler(e,t,r,!1)}once(e,t,r){this._addEventHandler(e,t,r,!0)}watch(e,t,r){this._addEventHandler(e,t,r,!1,!0)}off(e,t){this._removeEventHandler(e,t)}_toggleRecognizer(e,t){var h,y,s,T;const{manager:r}=this;if(!r)return;const a=r.get(e);a&&(a.set({enable:t}),r.touchAction.update()),(h=this.wheelInput)==null||h.enableEventType(e,t),(y=this.moveInput)==null||y.enableEventType(e,t),(s=this.keyInput)==null||s.enableEventType(e,t),(T=this.contextmenuInput)==null||T.enableEventType(e,t)}_addEventHandler(e,t,r,a,h){if(typeof e!="string"){r=t;for(const[B,F]of Object.entries(e))this._addEventHandler(B,F,r,a,h);return}const{manager:y,events:s}=this;if(!y)return;let T=s.get(e);if(!T){const B=this._getRecognizerName(e)||e;T=new ZV(this,B),s.set(e,T),y&&y.on(e,T.handleEvent)}T.add(e,t,r,a,h),T.isEmpty()||this._toggleRecognizer(T.recognizerName,!0)}_removeEventHandler(e,t){if(typeof e!="string"){for(const[h,y]of Object.entries(e))this._removeEventHandler(h,y);return}const{events:r}=this,a=r.get(e);if(a&&(a.remove(e,t),a.isEmpty())){const{recognizerName:h}=a;let y=!1;for(const s of r.values())if(s.recognizerName===h&&!s.isEmpty()){y=!0;break}y||this._toggleRecognizer(h,!1)}}_getRecognizerName(e){var t;return(t=this.manager.recognizers.find(r=>r.getEventNames().includes(e)))==null?void 0:t.options.event}}const lr={DEFAULT:-1,LNGLAT:1,METER_OFFSETS:2,LNGLAT_OFFSETS:3,CARTESIAN:0};Object.defineProperty(lr,"IDENTITY",{get:()=>(gr.deprecated("COORDINATE_SYSTEM.IDENTITY","COORDINATE_SYSTEM.CARTESIAN")(),0)});const Hs={WEB_MERCATOR:1,GLOBE:2,WEB_MERCATOR_AUTO_OFFSET:4,IDENTITY:0},Py={common:0,meters:1,pixels:2},W1={click:"onClick",panstart:"onDragStart",panmove:"onDrag",panend:"onDragEnd"},P3={multipan:[E3,{threshold:10,direction:Sn.Vertical,pointers:2}],pinch:[RV,{},null,["multipan"]],pan:[E3,{threshold:1},["pinch"],["multipan"]],dblclick:[T3,{event:"dblclick",taps:2}],click:[T3,{event:"click"},null,["dblclick"]]};function JV(i,e){if(i===e)return!0;if(Array.isArray(i)){const t=i.length;if(!e||e.length!==t)return!1;for(let r=0;r<t;r++)if(i[r]!==e[r])return!1;return!0}return!1}function Lm(i){let e={},t;return r=>{for(const a in r)if(!JV(r[a],e[a])){t=i(r),e=r;break}return t}}const B3=[0,0,0,0],QV=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0],aP=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],e8=[0,0,0],lP=[0,0,0],t8=Lm(n8);function cP(i,e,t=lP){t.length<3&&(t=[t[0],t[1],0]);let r=t,a,h=!0;switch(e===lr.LNGLAT_OFFSETS||e===lr.METER_OFFSETS?a=t:a=i.isGeospatial?[Math.fround(i.longitude),Math.fround(i.latitude),0]:null,i.projectionMode){case Hs.WEB_MERCATOR:(e===lr.LNGLAT||e===lr.CARTESIAN)&&(a=[0,0,0],h=!1);break;case Hs.WEB_MERCATOR_AUTO_OFFSET:e===lr.LNGLAT?r=a:e===lr.CARTESIAN&&(r=[Math.fround(i.center[0]),Math.fround(i.center[1]),0],a=i.unprojectPosition(r),r[0]-=t[0],r[1]-=t[1],r[2]-=t[2]);break;case Hs.IDENTITY:r=i.position.map(Math.fround),r[2]=r[2]||0;break;case Hs.GLOBE:h=!1,a=null;break;default:h=!1}return{geospatialOrigin:a,shaderCoordinateOrigin:r,offsetMode:h}}function i8(i,e,t){const{viewMatrixUncentered:r,projectionMatrix:a}=i;let{viewMatrix:h,viewProjectionMatrix:y}=i,s=B3,T=B3,B=i.cameraPosition;const{geospatialOrigin:F,shaderCoordinateOrigin:V,offsetMode:X}=cP(i,e,t);return X&&(T=i.projectPosition(F||V),B=[B[0]-T[0],B[1]-T[1],B[2]-T[2]],T[3]=1,s=Cd([],T,y),h=r||h,y=wu([],a,h),y=wu([],y,QV)),{viewMatrix:h,viewProjectionMatrix:y,projectionCenter:s,originCommon:T,cameraPosCommon:B,shaderCoordinateOrigin:V,geospatialOrigin:F}}function r8({viewport:i,devicePixelRatio:e=1,modelMatrix:t=null,coordinateSystem:r=lr.DEFAULT,coordinateOrigin:a=lP,autoWrapLongitude:h=!1}){r===lr.DEFAULT&&(r=i.isGeospatial?lr.LNGLAT:lr.CARTESIAN);const y=t8({viewport:i,devicePixelRatio:e,coordinateSystem:r,coordinateOrigin:a});return y.wrapLongitude=h,y.modelMatrix=t||aP,y}function n8({viewport:i,devicePixelRatio:e,coordinateSystem:t,coordinateOrigin:r}){const{projectionCenter:a,viewProjectionMatrix:h,originCommon:y,cameraPosCommon:s,shaderCoordinateOrigin:T,geospatialOrigin:B}=i8(i,t,r),F=i.getDistanceScales(),V=[i.width*e,i.height*e],X=Cd([],[0,0,-i.focalDistance,1],i.projectionMatrix)[3]||1,se={coordinateSystem:t,projectionMode:i.projectionMode,coordinateOrigin:T,commonOrigin:y.slice(0,3),center:a,pseudoMeters:!!i._pseudoMeters,viewportSize:V,devicePixelRatio:e,focalDistance:X,commonUnitsPerMeter:F.unitsPerMeter,commonUnitsPerWorldUnit:F.unitsPerMeter,commonUnitsPerWorldUnit2:e8,scale:i.scale,wrapLongitude:!1,viewProjectionMatrix:h,modelMatrix:aP,cameraPosition:s};if(B){const ne=i.getDistanceScales(B);switch(t){case lr.METER_OFFSETS:se.commonUnitsPerWorldUnit=ne.unitsPerMeter,se.commonUnitsPerWorldUnit2=ne.unitsPerMeter2;break;case lr.LNGLAT:case lr.LNGLAT_OFFSETS:i._pseudoMeters||(se.commonUnitsPerMeter=ne.unitsPerMeter),se.commonUnitsPerWorldUnit=ne.unitsPerDegree,se.commonUnitsPerWorldUnit2=ne.unitsPerDegree2;break;case lr.CARTESIAN:se.commonUnitsPerWorldUnit=[1,1,ne.unitsPerMeter[2]],se.commonUnitsPerWorldUnit2=[0,0,ne.unitsPerMeter2[2]];break}}return se}const s8=Object.keys(lr).map(i=>`const COORDINATE_SYSTEM_${i}: i32 = ${lr[i]};`).join(""),o8=Object.keys(Hs).map(i=>`const PROJECTION_MODE_${i}: i32 = ${Hs[i]};`).join(""),a8=Object.keys(Py).map(i=>`const UNIT_${i.toUpperCase()}: i32 = ${Py[i]};`).join(""),l8=`${s8}
${o8}
${a8}

const TILE_SIZE: f32 = 512.0;
const PI: f32 = 3.1415926536;
const WORLD_SCALE: f32 = TILE_SIZE / (PI * 2.0);
const ZERO_64_LOW: vec3<f32> = vec3<f32>(0.0, 0.0, 0.0);
const EARTH_RADIUS: f32 = 6370972.0; // meters
const GLOBE_RADIUS: f32 = 256.0;

// -----------------------------------------------------------------------------
// Uniform block (converted from GLSL uniform block)
// -----------------------------------------------------------------------------
struct ProjectUniforms {
  wrapLongitude: i32,
  coordinateSystem: i32,
  commonUnitsPerMeter: vec3<f32>,
  projectionMode: i32,
  scale: f32,
  commonUnitsPerWorldUnit: vec3<f32>,
  commonUnitsPerWorldUnit2: vec3<f32>,
  center: vec4<f32>,
  modelMatrix: mat4x4<f32>,
  viewProjectionMatrix: mat4x4<f32>,
  viewportSize: vec2<f32>,
  devicePixelRatio: f32,
  focalDistance: f32,
  cameraPosition: vec3<f32>,
  coordinateOrigin: vec3<f32>,
  commonOrigin: vec3<f32>,
  pseudoMeters: i32,
};

@group(0) @binding(0)
var<uniform> project: ProjectUniforms;

// -----------------------------------------------------------------------------
// Geometry data
// (In your GLSL code, "geometry" was assumed to be available globally. In WGSL,
// you might supply this via vertex attributes or a uniform. Here we define a
// uniform struct for demonstration.)
// -----------------------------------------------------------------------------

// Structure to carry additional geometry data used by deck.gl filters.
struct Geometry {
  worldPosition: vec3<f32>,
  worldPositionAlt: vec3<f32>,
  position: vec4<f32>,
  uv: vec2<f32>,
  pickingColor: vec3<f32>,
};

// @group(0) @binding(1)
var<private> geometry: Geometry;
`,c8=`${l8}

// -----------------------------------------------------------------------------
// Functions
// -----------------------------------------------------------------------------

// Returns an adjustment factor for commonUnitsPerMeter
fn _project_size_at_latitude(lat: f32) -> f32 {
  let y = clamp(lat, -89.9, 89.9);
  return 1.0 / cos(radians(y));
}

// Overloaded version: scales a value in meters at a given latitude.
fn _project_size_at_latitude_m(meters: f32, lat: f32) -> f32 {
  return meters * project.commonUnitsPerMeter.z * _project_size_at_latitude(lat);
}

// Computes a non-linear scale factor based on geometry.
// (Note: This function relies on "geometry" being provided.)
fn project_size() -> f32 {
  if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR &&
      project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT &&
      project.pseudoMeters == 0) {
    if (geometry.position.w == 0.0) {
      return _project_size_at_latitude(geometry.worldPosition.y);
    }
    let y: f32 = geometry.position.y / TILE_SIZE * 2.0 - 1.0;
    let y2 = y * y;
    let y4 = y2 * y2;
    let y6 = y4 * y2;
    return 1.0 + 4.9348 * y2 + 4.0587 * y4 + 1.5642 * y6;
  }
  return 1.0;
}

// Overloads to scale offsets (meters to world units)
fn project_size_float(meters: f32) -> f32 {
  return meters * project.commonUnitsPerMeter.z * project_size();
}

fn project_size_vec2(meters: vec2<f32>) -> vec2<f32> {
  return meters * project.commonUnitsPerMeter.xy * project_size();
}

fn project_size_vec3(meters: vec3<f32>) -> vec3<f32> {
  return meters * project.commonUnitsPerMeter * project_size();
}

fn project_size_vec4(meters: vec4<f32>) -> vec4<f32> {
  return vec4<f32>(meters.xyz * project.commonUnitsPerMeter, meters.w);
}

// Returns a rotation matrix aligning the zaxis with the given up vector.
fn project_get_orientation_matrix(up: vec3<f32>) -> mat3x3<f32> {
  let uz = normalize(up);
  let ux = select(
    vec3<f32>(1.0, 0.0, 0.0),
    normalize(vec3<f32>(uz.y, -uz.x, 0.0)),
    abs(uz.z) == 1.0
  );
  let uy = cross(uz, ux);
  return mat3x3<f32>(ux, uy, uz);
}

// Since WGSL does not support "out" parameters, we return a struct.
struct RotationResult {
  needsRotation: bool,
  transform: mat3x3<f32>,
};

fn project_needs_rotation(commonPosition: vec3<f32>) -> RotationResult {
  if (project.projectionMode == PROJECTION_MODE_GLOBE) {
    return RotationResult(true, project_get_orientation_matrix(commonPosition));
  } else {
    return RotationResult(false, mat3x3<f32>());  // identity alternative if needed
  };
}

// Projects a normal vector from the current coordinate system to world space.
fn project_normal(vector: vec3<f32>) -> vec3<f32> {
  let normal_modelspace = project.modelMatrix * vec4<f32>(vector, 0.0);
  var n = normalize(normal_modelspace.xyz * project.commonUnitsPerMeter);
  let rotResult = project_needs_rotation(geometry.position.xyz);
  if (rotResult.needsRotation) {
    n = rotResult.transform * n;
  }
  return n;
}

// Applies a scale offset based on y-offset (dy)
fn project_offset_(offset: vec4<f32>) -> vec4<f32> {
  let dy: f32 = offset.y;
  let commonUnitsPerWorldUnit = project.commonUnitsPerWorldUnit + project.commonUnitsPerWorldUnit2 * dy;
  return vec4<f32>(offset.xyz * commonUnitsPerWorldUnit, offset.w);
}

// Projects lng/lat coordinates to a unit tile [0,1]
fn project_mercator_(lnglat: vec2<f32>) -> vec2<f32> {
  var x = lnglat.x;
  if (project.wrapLongitude != 0) {
    x = ((x + 180.0) % 360.0) - 180.0;
  }
  let y = clamp(lnglat.y, -89.9, 89.9);
  return vec2<f32>(
    radians(x) + PI,
    PI + log(tan(PI * 0.25 + radians(y) * 0.5))
  ) * WORLD_SCALE;
}

// Projects lng/lat/z coordinates for a globe projection.
fn project_globe_(lnglatz: vec3<f32>) -> vec3<f32> {
  let lambda = radians(lnglatz.x);
  let phi = radians(lnglatz.y);
  let cosPhi = cos(phi);
  let D = (lnglatz.z / EARTH_RADIUS + 1.0) * GLOBE_RADIUS;
  return vec3<f32>(
    sin(lambda) * cosPhi,
    -cos(lambda) * cosPhi,
    sin(phi)
  ) * D;
}

// Projects positions (with an optional 64-bit low part) from the input
// coordinate system to the common space.
fn project_position_vec4_f64(position: vec4<f32>, position64Low: vec3<f32>) -> vec4<f32> {
  var position_world = project.modelMatrix * position;

  // Work around for a Mac+NVIDIA bug:
  if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR) {
    if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      return vec4<f32>(
        project_mercator_(position_world.xy),
        _project_size_at_latitude_m(position_world.z, position_world.y),
        position_world.w
      );
    }
    if (project.coordinateSystem == COORDINATE_SYSTEM_CARTESIAN) {
      position_world = vec4f(position_world.xyz + project.coordinateOrigin, position_world.w);
    }
  }
  if (project.projectionMode == PROJECTION_MODE_GLOBE) {
    if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      return vec4<f32>(
        project_globe_(position_world.xyz),
        position_world.w
      );
    }
  }
  if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET) {
    if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      if (abs(position_world.y - project.coordinateOrigin.y) > 0.25) {
        return vec4<f32>(
          project_mercator_(position_world.xy) - project.commonOrigin.xy,
          project_size_float(position_world.z),
          position_world.w
        );
      }
    }
  }
  if (project.projectionMode == PROJECTION_MODE_IDENTITY ||
      (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET &&
       (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT ||
        project.coordinateSystem == COORDINATE_SYSTEM_CARTESIAN))) {
    position_world = vec4f(position_world.xyz - project.coordinateOrigin, position_world.w);
  }

  return project_offset_(position_world) +
         project_offset_(project.modelMatrix * vec4<f32>(position64Low, 0.0));
}

// Overloaded versions for different input types.
fn project_position_vec4_f32(position: vec4<f32>) -> vec4<f32> {
  return project_position_vec4_f64(position, ZERO_64_LOW);
}

fn project_position_vec3_f64(position: vec3<f32>, position64Low: vec3<f32>) -> vec3<f32> {
  let projected_position = project_position_vec4_f64(vec4<f32>(position, 1.0), position64Low);
  return projected_position.xyz;
}

fn project_position_vec3_f32(position: vec3<f32>) -> vec3<f32> {
  let projected_position = project_position_vec4_f64(vec4<f32>(position, 1.0), ZERO_64_LOW);
  return projected_position.xyz;
}

fn project_position_vec2_f32(position: vec2<f32>) -> vec2<f32> {
  let projected_position = project_position_vec4_f64(vec4<f32>(position, 0.0, 1.0), ZERO_64_LOW);
  return projected_position.xy;
}

// Transforms a common space position to clip space.
fn project_common_position_to_clipspace_with_projection(position: vec4<f32>, viewProjectionMatrix: mat4x4<f32>, center: vec4<f32>) -> vec4<f32> {
  return viewProjectionMatrix * position + center;
}

// Uses the project viewProjectionMatrix and center.
fn project_common_position_to_clipspace(position: vec4<f32>) -> vec4<f32> {
  return project_common_position_to_clipspace_with_projection(position, project.viewProjectionMatrix, project.center);
}

// Returns a clip space offset corresponding to a given number of screen pixels.
fn project_pixel_size_to_clipspace(pixels: vec2<f32>) -> vec2<f32> {
  let offset = pixels / project.viewportSize * project.devicePixelRatio * 2.0;
  return offset * project.focalDistance;
}

fn project_meter_size_to_pixel(meters: f32) -> f32 {
  return project_size_float(meters) * project.scale;
}

fn project_unit_size_to_pixel(size: f32, unit: i32) -> f32 {
  if (unit == UNIT_METERS) {
    return project_meter_size_to_pixel(size);
  } else if (unit == UNIT_COMMON) {
    return size * project.scale;
  }
  // UNIT_PIXELS: no scaling applied.
  return size;
}

fn project_pixel_size_float(pixels: f32) -> f32 {
  return pixels / project.scale;
}

fn project_pixel_size_vec2(pixels: vec2<f32>) -> vec2<f32> {
  return pixels / project.scale;
}
`,u8=Object.keys(lr).map(i=>`const int COORDINATE_SYSTEM_${i} = ${lr[i]};`).join(""),h8=Object.keys(Hs).map(i=>`const int PROJECTION_MODE_${i} = ${Hs[i]};`).join(""),d8=Object.keys(Py).map(i=>`const int UNIT_${i.toUpperCase()} = ${Py[i]};`).join(""),f8=`${u8}
${h8}
${d8}
uniform projectUniforms {
bool wrapLongitude;
int coordinateSystem;
vec3 commonUnitsPerMeter;
int projectionMode;
float scale;
vec3 commonUnitsPerWorldUnit;
vec3 commonUnitsPerWorldUnit2;
vec4 center;
mat4 modelMatrix;
mat4 viewProjectionMatrix;
vec2 viewportSize;
float devicePixelRatio;
float focalDistance;
vec3 cameraPosition;
vec3 coordinateOrigin;
vec3 commonOrigin;
bool pseudoMeters;
} project;
const float TILE_SIZE = 512.0;
const float PI = 3.1415926536;
const float WORLD_SCALE = TILE_SIZE / (PI * 2.0);
const vec3 ZERO_64_LOW = vec3(0.0);
const float EARTH_RADIUS = 6370972.0;
const float GLOBE_RADIUS = 256.0;
float project_size_at_latitude(float lat) {
float y = clamp(lat, -89.9, 89.9);
return 1.0 / cos(radians(y));
}
float project_size() {
if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR &&
project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT &&
project.pseudoMeters == false) {
if (geometry.position.w == 0.0) {
return project_size_at_latitude(geometry.worldPosition.y);
}
float y = geometry.position.y / TILE_SIZE * 2.0 - 1.0;
float y2 = y * y;
float y4 = y2 * y2;
float y6 = y4 * y2;
return 1.0 + 4.9348 * y2 + 4.0587 * y4 + 1.5642 * y6;
}
return 1.0;
}
float project_size_at_latitude(float meters, float lat) {
return meters * project.commonUnitsPerMeter.z * project_size_at_latitude(lat);
}
float project_size(float meters) {
return meters * project.commonUnitsPerMeter.z * project_size();
}
vec2 project_size(vec2 meters) {
return meters * project.commonUnitsPerMeter.xy * project_size();
}
vec3 project_size(vec3 meters) {
return meters * project.commonUnitsPerMeter * project_size();
}
vec4 project_size(vec4 meters) {
return vec4(meters.xyz * project.commonUnitsPerMeter, meters.w);
}
mat3 project_get_orientation_matrix(vec3 up) {
vec3 uz = normalize(up);
vec3 ux = abs(uz.z) == 1.0 ? vec3(1.0, 0.0, 0.0) : normalize(vec3(uz.y, -uz.x, 0));
vec3 uy = cross(uz, ux);
return mat3(ux, uy, uz);
}
bool project_needs_rotation(vec3 commonPosition, out mat3 transform) {
if (project.projectionMode == PROJECTION_MODE_GLOBE) {
transform = project_get_orientation_matrix(commonPosition);
return true;
}
return false;
}
vec3 project_normal(vec3 vector) {
vec4 normal_modelspace = project.modelMatrix * vec4(vector, 0.0);
vec3 n = normalize(normal_modelspace.xyz * project.commonUnitsPerMeter);
mat3 rotation;
if (project_needs_rotation(geometry.position.xyz, rotation)) {
n = rotation * n;
}
return n;
}
vec4 project_offset_(vec4 offset) {
float dy = offset.y;
vec3 commonUnitsPerWorldUnit = project.commonUnitsPerWorldUnit + project.commonUnitsPerWorldUnit2 * dy;
return vec4(offset.xyz * commonUnitsPerWorldUnit, offset.w);
}
vec2 project_mercator_(vec2 lnglat) {
float x = lnglat.x;
if (project.wrapLongitude) {
x = mod(x + 180., 360.0) - 180.;
}
float y = clamp(lnglat.y, -89.9, 89.9);
return vec2(
radians(x) + PI,
PI + log(tan_fp32(PI * 0.25 + radians(y) * 0.5))
) * WORLD_SCALE;
}
vec3 project_globe_(vec3 lnglatz) {
float lambda = radians(lnglatz.x);
float phi = radians(lnglatz.y);
float cosPhi = cos(phi);
float D = (lnglatz.z / EARTH_RADIUS + 1.0) * GLOBE_RADIUS;
return vec3(
sin(lambda) * cosPhi,
-cos(lambda) * cosPhi,
sin(phi)
) * D;
}
vec4 project_position(vec4 position, vec3 position64Low) {
vec4 position_world = project.modelMatrix * position;
if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR) {
if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
return vec4(
project_mercator_(position_world.xy),
project_size_at_latitude(position_world.z, position_world.y),
position_world.w
);
}
if (project.coordinateSystem == COORDINATE_SYSTEM_CARTESIAN) {
position_world.xyz += project.coordinateOrigin;
}
}
if (project.projectionMode == PROJECTION_MODE_GLOBE) {
if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
return vec4(
project_globe_(position_world.xyz),
position_world.w
);
}
}
if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET) {
if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
if (abs(position_world.y - project.coordinateOrigin.y) > 0.25) {
return vec4(
project_mercator_(position_world.xy) - project.commonOrigin.xy,
project_size(position_world.z),
position_world.w
);
}
}
}
if (project.projectionMode == PROJECTION_MODE_IDENTITY ||
(project.projectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET &&
(project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT ||
project.coordinateSystem == COORDINATE_SYSTEM_CARTESIAN))) {
position_world.xyz -= project.coordinateOrigin;
}
return project_offset_(position_world) + project_offset_(project.modelMatrix * vec4(position64Low, 0.0));
}
vec4 project_position(vec4 position) {
return project_position(position, ZERO_64_LOW);
}
vec3 project_position(vec3 position, vec3 position64Low) {
vec4 projected_position = project_position(vec4(position, 1.0), position64Low);
return projected_position.xyz;
}
vec3 project_position(vec3 position) {
vec4 projected_position = project_position(vec4(position, 1.0), ZERO_64_LOW);
return projected_position.xyz;
}
vec2 project_position(vec2 position) {
vec4 projected_position = project_position(vec4(position, 0.0, 1.0), ZERO_64_LOW);
return projected_position.xy;
}
vec4 project_common_position_to_clipspace(vec4 position, mat4 viewProjectionMatrix, vec4 center) {
return viewProjectionMatrix * position + center;
}
vec4 project_common_position_to_clipspace(vec4 position) {
return project_common_position_to_clipspace(position, project.viewProjectionMatrix, project.center);
}
vec2 project_pixel_size_to_clipspace(vec2 pixels) {
vec2 offset = pixels / project.viewportSize * project.devicePixelRatio * 2.0;
return offset * project.focalDistance;
}
float project_size_to_pixel(float meters) {
return project_size(meters) * project.scale;
}
float project_size_to_pixel(float size, int unit) {
if (unit == UNIT_METERS) return project_size_to_pixel(size);
if (unit == UNIT_COMMON) return size * project.scale;
return size;
}
float project_pixel_size(float pixels) {
return pixels / project.scale;
}
vec2 project_pixel_size(vec2 pixels) {
return pixels / project.scale;
}
`,p8={};function m8(i=p8){return"viewport"in i?r8(i):{}}const rA={name:"project",dependencies:[N6,eP],source:c8,vs:f8,getUniforms:m8,uniformTypes:{wrapLongitude:"f32",coordinateSystem:"i32",commonUnitsPerMeter:"vec3<f32>",projectionMode:"i32",scale:"f32",commonUnitsPerWorldUnit:"vec3<f32>",commonUnitsPerWorldUnit2:"vec3<f32>",center:"vec4<f32>",modelMatrix:"mat4x4<f32>",viewProjectionMatrix:"mat4x4<f32>",viewportSize:"vec2<f32>",devicePixelRatio:"f32",focalDistance:"f32",cameraPosition:"vec3<f32>",coordinateOrigin:"vec3<f32>",commonOrigin:"vec3<f32>",pseudoMeters:"f32"}},_8=`// Define a structure to hold both the clip-space position and the common position.
struct ProjectResult {
  clipPosition: vec4<f32>,
  commonPosition: vec4<f32>,
};

// This function mimics the GLSL version with the 'out' parameter by returning both values.
fn project_position_to_clipspace_and_commonspace(
    position: vec3<f32>,
    position64Low: vec3<f32>,
    offset: vec3<f32>
) -> ProjectResult {
  // Compute the projected position.
  let projectedPosition: vec3<f32> = project_position_vec3_f64(position, position64Low);

  // Start with the provided offset.
  var finalOffset: vec3<f32> = offset;

  // Get whether a rotation is needed and the rotation matrix.
  let rotationResult = project_needs_rotation(projectedPosition);

  // If rotation is needed, update the offset.
  if (rotationResult.needsRotation) {
    finalOffset = rotationResult.transform * offset;
  }

  // Compute the common position.
  let commonPosition: vec4<f32> = vec4<f32>(projectedPosition + finalOffset, 1.0);

  // Convert to clip-space.
  let clipPosition: vec4<f32> = project_common_position_to_clipspace(commonPosition);

  return ProjectResult(clipPosition, commonPosition);
}

// A convenience overload that returns only the clip-space position.
fn project_position_to_clipspace(
    position: vec3<f32>,
    position64Low: vec3<f32>,
    offset: vec3<f32>
) -> vec4<f32> {
  return project_position_to_clipspace_and_commonspace(position, position64Low, offset).clipPosition;
}
`,g8=`vec4 project_position_to_clipspace(
  vec3 position, vec3 position64Low, vec3 offset, out vec4 commonPosition
) {
  vec3 projectedPosition = project_position(position, position64Low);
  mat3 rotation;
  if (project_needs_rotation(projectedPosition, rotation)) {
    // offset is specified as ENU
    // when in globe projection, rotate offset so that the ground alighs with the surface of the globe
    offset = rotation * offset;
  }
  commonPosition = vec4(projectedPosition + offset, 1.0);
  return project_common_position_to_clipspace(commonPosition);
}

vec4 project_position_to_clipspace(
  vec3 position, vec3 position64Low, vec3 offset
) {
  vec4 commonPosition;
  return project_position_to_clipspace(position, position64Low, offset, commonPosition);
}
`,y8={name:"project32",dependencies:[rA],source:_8,vs:g8};function v8(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function md(i,e){const t=Cd([],e,i);return iA(t,t,1/t[3]),t}function D3(i,e){const t=i%e;return t<0?e+t:t}function q1(i,e,t){return i<e?e:i>t?t:i}function x8(i){return Math.log(i)*Math.LOG2E}const nA=Math.log2||x8;function rl(i,e){if(!i)throw new Error(e||"@math.gl/web-mercator: assertion failed.")}const Xo=Math.PI,uP=Xo/4,yo=Xo/180,X1=180/Xo,wd=512,By=4003e4,Dy=85.051129,b8=1.5;function w8(i){return nA(i)}function ym(i){const[e,t]=i;rl(Number.isFinite(e)),rl(Number.isFinite(t)&&t>=-90&&t<=90,"invalid latitude");const r=e*yo,a=t*yo,h=wd*(r+Xo)/(2*Xo),y=wd*(Xo+Math.log(Math.tan(uP+a*.5)))/(2*Xo);return[h,y]}function Ad(i){const[e,t]=i,r=e/wd*(2*Xo)-Xo,a=2*(Math.atan(Math.exp(t/wd*(2*Xo)-Xo))-uP);return[r*X1,a*X1]}function A8(i){const{latitude:e}=i;rl(Number.isFinite(e));const t=Math.cos(e*yo);return w8(By*t)-9}function Jg(i){const e=Math.cos(i*yo);return wd/By/e}function Z1(i){const{latitude:e,longitude:t,highPrecision:r=!1}=i;rl(Number.isFinite(e)&&Number.isFinite(t));const a=wd,h=Math.cos(e*yo),y=a/360,s=y/h,T=a/By/h,B={unitsPerMeter:[T,T,T],metersPerUnit:[1/T,1/T,1/T],unitsPerDegree:[y,s,T],degreesPerUnit:[1/y,1/s,1/T]};if(r){const F=yo*Math.tan(e*yo)/h,V=y*F/2,X=a/By*F,se=X/s*T;B.unitsPerDegree2=[0,V,X],B.unitsPerMeter2=[se,0,se]}return B}function hP(i,e){const[t,r,a]=i,[h,y,s]=e,{unitsPerMeter:T,unitsPerMeter2:B}=Z1({longitude:t,latitude:r,highPrecision:!0}),F=ym(i);F[0]+=h*(T[0]+B[0]*y),F[1]+=y*(T[1]+B[1]*y);const V=Ad(F),X=(a||0)+(s||0);return Number.isFinite(a)||Number.isFinite(s)?[V[0],V[1],X]:V}function T8(i){const{height:e,pitch:t,bearing:r,altitude:a,scale:h,center:y}=i,s=v8();My(s,s,[0,0,-a]),$R(s,s,-t*yo),WR(s,s,r*yo);const T=h/e;return tA(s,s,[T,T,T]),y&&My(s,s,RU([],y)),s}function E8(i){const{width:e,height:t,altitude:r,pitch:a=0,offset:h,center:y,scale:s,nearZMultiplier:T=1,farZMultiplier:B=1}=i;let{fovy:F=vm(b8)}=i;r!==void 0&&(F=vm(r));const V=F*yo,X=a*yo,se=sA(F);let ne=se;y&&(ne+=y[2]*s/Math.cos(X)/t);const K=V*(.5+(h?h[1]:0)/t),ue=Math.sin(K)*ne/Math.sin(q1(Math.PI/2-X-K,.01,Math.PI-.01)),_e=Math.sin(X)*ue+ne,ke=ne*10,we=Math.min(_e*B,ke);return{fov:V,aspect:e/t,focalDistance:se,near:T,far:we}}function vm(i){return 2*Math.atan(.5/i)*X1}function sA(i){return .5/Math.tan(.5*i*yo)}function dP(i,e){const[t,r,a=0]=i;return rl(Number.isFinite(t)&&Number.isFinite(r)&&Number.isFinite(a)),md(e,[t,r,a,1])}function oA(i,e,t=0){const[r,a,h]=i;if(rl(Number.isFinite(r)&&Number.isFinite(a),"invalid pixel coordinate"),Number.isFinite(h))return md(e,[r,a,h,1]);const y=md(e,[r,a,0,1]),s=md(e,[r,a,1,1]),T=y[2],B=s[2],F=T===B?0:((t||0)-T)/(B-T);return FR([],y,s,F)}function S8(i){const{width:e,height:t,bounds:r,minExtent:a=0,maxZoom:h=24,offset:y=[0,0]}=i,[[s,T],[B,F]]=r,V=I8(i.padding),X=ym([s,q1(F,-85.051129,Dy)]),se=ym([B,q1(T,-85.051129,Dy)]),ne=[Math.max(Math.abs(se[0]-X[0]),a),Math.max(Math.abs(se[1]-X[1]),a)],K=[e-V.left-V.right-Math.abs(y[0])*2,t-V.top-V.bottom-Math.abs(y[1])*2];rl(K[0]>0&&K[1]>0);const ue=K[0]/ne[0],_e=K[1]/ne[1],ke=(V.right-V.left)/2/ue,we=(V.top-V.bottom)/2/_e,ge=[(se[0]+X[0])/2+ke,(se[1]+X[1])/2+we],Le=Ad(ge),$e=Math.min(h,nA(Math.abs(Math.min(ue,_e))));return rl(Number.isFinite($e)),{longitude:Le[0],latitude:Le[1],zoom:$e}}function I8(i=0){return typeof i=="number"?{top:i,bottom:i,left:i,right:i}:(rl(Number.isFinite(i.top)&&Number.isFinite(i.bottom)&&Number.isFinite(i.left)&&Number.isFinite(i.right)),i)}const O3=Math.PI/180;function C8(i,e=0){const{width:t,height:r,unproject:a}=i,h={targetZ:e},y=a([0,r],h),s=a([t,r],h);let T,B;const F=i.fovy?.5*i.fovy*O3:Math.atan(.5/i.altitude),V=(90-i.pitch)*O3;return F>V-.01?(T=F3(i,0,e),B=F3(i,t,e)):(T=a([0,0],h),B=a([t,0],h)),[y,s,B,T]}function F3(i,e,t){const{pixelUnprojectionMatrix:r}=i,a=md(r,[e,0,1,1]),h=md(r,[e,i.height,1,1]),s=(t*i.distanceScales.unitsPerMeter[2]-a[2])/(h[2]-a[2]),T=FR([],a,h,s),B=Ad(T);return B.push(t),B}const k3=512;function M8(i){const{width:e,height:t,pitch:r=0}=i;let{longitude:a,latitude:h,zoom:y,bearing:s=0}=i;(a<-180||a>180)&&(a=D3(a+180,360)-180),(s<-180||s>180)&&(s=D3(s+180,360)-180);const T=nA(t/k3);if(y<=T)y=T,h=0;else{const B=t/2/Math.pow(2,y),F=Ad([0,B])[1];if(h<F)h=F;else{const V=Ad([0,k3-B])[1];h>V&&(h=V)}}return{width:e,height:t,longitude:a,latitude:h,zoom:y,pitch:r,bearing:s}}const fP=`
uniform shadowUniforms {
  bool drawShadowMap;
  bool useShadowMap;
  vec4 color;
  highp int lightId;
  float lightCount;
  mat4 viewProjectionMatrix0;
  mat4 viewProjectionMatrix1;
  vec4 projectCenter0;
  vec4 projectCenter1;
} shadow;
`,R8=`
const int max_lights = 2;

out vec3 shadow_vPosition[max_lights];

vec4 shadow_setVertexPosition(vec4 position_commonspace) {
  mat4 viewProjectionMatrices[max_lights];
  viewProjectionMatrices[0] = shadow.viewProjectionMatrix0;
  viewProjectionMatrices[1] = shadow.viewProjectionMatrix1;
  vec4 projectCenters[max_lights];
  projectCenters[0] = shadow.projectCenter0;
  projectCenters[1] = shadow.projectCenter1;

  if (shadow.drawShadowMap) {
    return project_common_position_to_clipspace(position_commonspace, viewProjectionMatrices[shadow.lightId], projectCenters[shadow.lightId]);
  }
  if (shadow.useShadowMap) {
    for (int i = 0; i < max_lights; i++) {
      if(i < int(shadow.lightCount)) {
        vec4 shadowMap_position = project_common_position_to_clipspace(position_commonspace, viewProjectionMatrices[i], projectCenters[i]);
        shadow_vPosition[i] = (shadowMap_position.xyz / shadowMap_position.w + 1.0) / 2.0;
      }
    }
  }
  return gl_Position;
}
`,P8=`
${fP}
${R8}
`,B8=`
const int max_lights = 2;
uniform sampler2D shadow_uShadowMap0;
uniform sampler2D shadow_uShadowMap1;

in vec3 shadow_vPosition[max_lights];

const vec4 bitPackShift = vec4(1.0, 255.0, 65025.0, 16581375.0);
const vec4 bitUnpackShift = 1.0 / bitPackShift;
const vec4 bitMask = vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0,  0.0);

float shadow_getShadowWeight(vec3 position, sampler2D shadowMap) {
  vec4 rgbaDepth = texture(shadowMap, position.xy);

  float z = dot(rgbaDepth, bitUnpackShift);
  return smoothstep(0.001, 0.01, position.z - z);
}

vec4 shadow_filterShadowColor(vec4 color) {
  if (shadow.drawShadowMap) {
    vec4 rgbaDepth = fract(gl_FragCoord.z * bitPackShift);
    rgbaDepth -= rgbaDepth.gbaa * bitMask;
    return rgbaDepth;
  }
  if (shadow.useShadowMap) {
    float shadowAlpha = 0.0;
    shadowAlpha += shadow_getShadowWeight(shadow_vPosition[0], shadow_uShadowMap0);
    if(shadow.lightCount > 1.0) {
      shadowAlpha += shadow_getShadowWeight(shadow_vPosition[1], shadow_uShadowMap1);
    }
    shadowAlpha *= shadow.color.a / shadow.lightCount;
    float blendedAlpha = shadowAlpha + color.a * (1.0 - shadowAlpha);

    return vec4(
      mix(color.rgb, shadow.color.rgb, shadowAlpha / blendedAlpha),
      blendedAlpha
    );
  }
  return color;
}
`,D8=`
${fP}
${B8}
`,O8=Lm(z8),F8=Lm(U8),k8=[0,0,0,1],L8=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0];function N8(i,e){const[t,r,a]=i,h=oA([t,r,a],e);return Number.isFinite(a)?h:[h[0],h[1],0]}function z8({viewport:i,center:e}){return new qn(i.viewProjectionMatrix).invert().transform(e)}function U8({viewport:i,shadowMatrices:e}){const t=[],r=i.pixelUnprojectionMatrix,a=i.isGeospatial?void 0:1,h=[[0,0,a],[i.width,0,a],[0,i.height,a],[i.width,i.height,a],[0,0,-1],[i.width,0,-1],[0,i.height,-1],[i.width,i.height,-1]].map(y=>N8(y,r));for(const y of e){const s=y.clone().translate(new Wn(i.center).negate()),T=h.map(F=>s.transform(F)),B=new qn().ortho({left:Math.min(...T.map(F=>F[0])),right:Math.max(...T.map(F=>F[0])),bottom:Math.min(...T.map(F=>F[1])),top:Math.max(...T.map(F=>F[1])),near:Math.min(...T.map(F=>-F[2])),far:Math.max(...T.map(F=>-F[2]))});t.push(B.multiplyRight(y))}return t}function V8(i){const{shadowEnabled:e=!0,project:t}=i;if(!e||!t||!i.shadowMatrices||!i.shadowMatrices.length)return{drawShadowMap:!1,useShadowMap:!1,shadow_uShadowMap0:i.dummyShadowMap,shadow_uShadowMap1:i.dummyShadowMap};const r=rA.getUniforms(t),a=O8({viewport:t.viewport,center:r.center}),h=[],y=F8({shadowMatrices:i.shadowMatrices,viewport:t.viewport}).slice();for(let T=0;T<i.shadowMatrices.length;T++){const B=y[T],F=B.clone().translate(new Wn(t.viewport.center).negate());r.coordinateSystem===lr.LNGLAT&&r.projectionMode===Hs.WEB_MERCATOR?(y[T]=F,h[T]=a):(y[T]=B.clone().multiplyRight(L8),h[T]=F.transform(a))}const s={drawShadowMap:!!i.drawToShadowMap,useShadowMap:i.shadowMaps?i.shadowMaps.length>0:!1,color:i.shadowColor||k8,lightId:i.shadowLightId||0,lightCount:i.shadowMatrices.length,shadow_uShadowMap0:i.dummyShadowMap,shadow_uShadowMap1:i.dummyShadowMap};for(let T=0;T<y.length;T++)s[`viewProjectionMatrix${T}`]=y[T],s[`projectCenter${T}`]=h[T];for(let T=0;T<2;T++)s[`shadow_uShadowMap${T}`]=i.shadowMaps&&i.shadowMaps[T]||i.dummyShadowMap;return s}const L3={name:"shadow",dependencies:[rA],vs:P8,fs:D8,inject:{"vs:DECKGL_FILTER_GL_POSITION":`
    position = shadow_setVertexPosition(geometry.position);
    `,"fs:DECKGL_FILTER_COLOR":`
    color = shadow_filterShadowColor(color);
    `},getUniforms:V8,uniformTypes:{drawShadowMap:"f32",useShadowMap:"f32",color:"vec4<f32>",lightId:"i32",lightCount:"f32",viewProjectionMatrix0:"mat4x4<f32>",viewProjectionMatrix1:"mat4x4<f32>",projectCenter0:"vec4<f32>",projectCenter1:"vec4<f32>"}},j8={...f3,defaultUniforms:{...f3.defaultUniforms,useFloatColors:!1},inject:{"vs:DECKGL_FILTER_GL_POSITION":`
    // for picking depth values
    picking_setPickingAttribute(position.z / position.w);
  `,"vs:DECKGL_FILTER_COLOR":`
  picking_setPickingColor(geometry.pickingColor);
  `,"fs:DECKGL_FILTER_COLOR":{order:99,injection:`
  // use highlight color if this fragment belongs to the selected object.
  color = picking_filterHighlightColor(color);

  // use picking color if rendering to picking FBO.
  color = picking_filterPickingColor(color);
    `}}},H8=[eP],G8=["vs:DECKGL_FILTER_SIZE(inout vec3 size, VertexGeometry geometry)","vs:DECKGL_FILTER_GL_POSITION(inout vec4 position, VertexGeometry geometry)","vs:DECKGL_FILTER_COLOR(inout vec4 color, VertexGeometry geometry)","fs:DECKGL_FILTER_COLOR(inout vec4 color, FragmentGeometry geometry)"],$8=[];function W8(i){const e=_y.getDefaultShaderAssembler();for(const r of H8)e.addDefaultModule(r);const t=i==="glsl"?G8:$8;for(const r of t)e.addShaderHook(r);return e}const q8=[255,255,255],X8=1;let Z8=0;class pP{constructor(e={}){this.type="ambient";const{color:t=q8}=e,{intensity:r=X8}=e;this.id=e.id||`ambient-${Z8++}`,this.color=t,this.intensity=r}}const Y8=[255,255,255],K8=1,J8=[0,0,-1];let Q8=0;class Y1{constructor(e={}){this.type="directional";const{color:t=Y8}=e,{intensity:r=K8}=e,{direction:a=J8}=e,{_shadow:h=!1}=e;this.id=e.id||`directional-${Q8++}`,this.color=t,this.intensity=r,this.type="directional",this.direction=new Wn(a).normalize().toArray(),this.shadow=h}getProjectedLight(e){return this}}class ej{constructor(e,t={id:"pass"}){const{id:r}=t;this.id=r,this.device=e,this.props={...t}}setProps(e){Object.assign(this.props,e)}render(e){}cleanup(){}}class aA extends ej{constructor(){super(...arguments),this._lastRenderIndex=-1}render(e){const[t,r]=this.device.canvasContext.getDrawingBufferSize(),a=e.clearCanvas??!0,h=e.clearColor??(a?[0,0,0,0]:!1),y=a?1:!1,s=a?0:!1,T=e.colorMask??15,B={viewport:[0,0,t,r]};e.colorMask&&(B.colorMask=T),e.scissorRect&&(B.scissorRect=e.scissorRect);const F=this.device.beginRenderPass({framebuffer:e.target,parameters:B,clearColor:h,clearDepth:y,clearStencil:s});try{return this._drawLayers(F,e)}finally{F.end(),this.device.submit()}}_drawLayers(e,t){const{target:r,shaderModuleProps:a,viewports:h,views:y,onViewportActive:s,clearStack:T=!0}=t;t.pass=t.pass||"unknown",T&&(this._lastRenderIndex=-1);const B=[];for(const F of h){const V=y&&y[F.id];s==null||s(F);const X=this._getDrawLayerParams(F,t),se=F.subViewports||[F];for(const ne of se){const K=this._drawLayersInViewport(e,{target:r,shaderModuleProps:a,viewport:ne,view:V,pass:t.pass,layers:t.layers},X);B.push(K)}}return B}_getDrawLayerParams(e,{layers:t,pass:r,isPicking:a=!1,layerFilter:h,cullRect:y,effects:s,shaderModuleProps:T},B=!1){var ne;const F=[],V=mP(this._lastRenderIndex+1),X={layer:t[0],viewport:e,isPicking:a,renderPass:r,cullRect:y},se={};for(let K=0;K<t.length;K++){const ue=t[K],_e=this._shouldDrawLayer(ue,X,h,se),ke={shouldDrawLayer:_e};_e&&!B&&(ke.shouldDrawLayer=!0,ke.layerRenderIndex=V(ue,_e),ke.shaderModuleProps=this._getShaderModuleProps(ue,s,r,T),ke.layerParameters={...(ne=ue.context.deck)==null?void 0:ne.props.parameters,...this.getLayerParameters(ue,K,e)}),F[K]=ke}return F}_drawLayersInViewport(e,{layers:t,shaderModuleProps:r,pass:a,target:h,viewport:y,view:s},T){const B=tj(this.device,{shaderModuleProps:r,target:h,viewport:y});if(s&&s.props.clear){const V=s.props.clear===!0?{color:!0,depth:!0}:s.props.clear;this.device.beginRenderPass({framebuffer:h,parameters:{viewport:B,scissorRect:B},clearColor:V.color?[0,0,0,0]:!1,clearDepth:V.depth?1:!1}).end()}const F={totalCount:t.length,visibleCount:0,compositeCount:0,pickableCount:0};e.setParameters({viewport:B});for(let V=0;V<t.length;V++){const X=t[V],se=T[V],{shouldDrawLayer:ne}=se;if(ne&&X.props.pickable&&F.pickableCount++,X.isComposite&&F.compositeCount++,X.isDrawable&&se.shouldDrawLayer){const{layerRenderIndex:K,shaderModuleProps:ue,layerParameters:_e}=se;F.visibleCount++,this._lastRenderIndex=Math.max(this._lastRenderIndex,K),ue.project&&(ue.project.viewport=y),X.context.renderPass=e;try{X._drawLayer({renderPass:e,shaderModuleProps:ue,uniforms:{layerIndex:K},parameters:_e})}catch(ke){X.raiseError(ke,`drawing ${X} to ${a}`)}}}return F}shouldDrawLayer(e){return!0}getShaderModuleProps(e,t,r){return null}getLayerParameters(e,t,r){return e.props.parameters}_shouldDrawLayer(e,t,r,a){if(!(e.props.visible&&this.shouldDrawLayer(e)))return!1;t.layer=e;let y=e.parent;for(;y;){if(!y.props.visible||!y.filterSubLayer(t))return!1;t.layer=y,y=y.parent}if(r){const s=t.layer.id;if(s in a||(a[s]=r(t)),!a[s])return!1}return e.activateViewport(t.viewport),!0}_getShaderModuleProps(e,t,r,a){var T,B;const h=this.device.canvasContext.cssToDeviceRatio(),y=((T=e.internalState)==null?void 0:T.propsInTransition)||e.props,s={layer:y,picking:{isActive:!1},project:{viewport:e.context.viewport,devicePixelRatio:h,modelMatrix:y.modelMatrix,coordinateSystem:y.coordinateSystem,coordinateOrigin:y.coordinateOrigin,autoWrapLongitude:e.wrapLongitude}};if(t)for(const F of t)N3(s,(B=F.getShaderModuleProps)==null?void 0:B.call(F,e,s));return N3(s,this.getShaderModuleProps(e,t,s),a)}}function mP(i=0,e={}){const t={},r=(a,h)=>{const y=a.props._offset,s=a.id,T=a.parent&&a.parent.id;let B;if(T&&!(T in e)&&r(a.parent,!1),T in t){const F=t[T]=t[T]||mP(e[T],e);B=F(a,h),t[s]=F}else Number.isFinite(y)?(B=y+(e[T]||0),t[s]=null):B=i;return h&&B>=i&&(i=B+1),e[s]=B,B};return r}function tj(i,{shaderModuleProps:e,target:t,viewport:r}){var T;const a=((T=e==null?void 0:e.project)==null?void 0:T.devicePixelRatio)??i.canvasContext.cssToDeviceRatio(),[,h]=i.canvasContext.getDrawingBufferSize(),y=t?t.height:h,s=r;return[s.x*a,y-(s.y+s.height)*a,s.width*a,s.height*a]}function N3(i,...e){for(const t of e)if(t)for(const r in t)i[r]?Object.assign(i[r],t[r]):i[r]=t[r];return i}class ij extends aA{constructor(e,t){super(e,t);const r=e.createTexture({format:"rgba8unorm",width:1,height:1,sampler:{minFilter:"linear",magFilter:"linear",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"},mipmaps:!0}),a=e.createTexture({format:"depth16unorm",width:1,height:1,mipmaps:!1});this.fbo=e.createFramebuffer({id:"shadowmap",width:1,height:1,colorAttachments:[r],depthStencilAttachment:a})}delete(){this.fbo&&(this.fbo.destroy(),this.fbo=null)}getShadowMap(){return this.fbo.colorAttachments[0].texture}render(e){const t=this.fbo,r=this.device.canvasContext.cssToDeviceRatio(),a=e.viewports[0],h=a.width*r,y=a.height*r,s=[1,1,1,1];(h!==t.width||y!==t.height)&&t.resize({width:h,height:y}),super.render({...e,clearColor:s,target:t,pass:"shadow"})}getLayerParameters(e,t,r){return{...e.props.parameters,blend:!1,depthWriteEnabled:!0,depthCompare:"less-equal"}}shouldDrawLayer(e){return e.props.shadowEnabled!==!1}getShaderModuleProps(e,t,r){return{shadow:{project:r.project,drawToShadowMap:!0}}}}const rj={color:[255,255,255],intensity:1},z3=[{color:[255,255,255],intensity:1,direction:[-1,3,-1]},{color:[255,255,255],intensity:.9,direction:[1,-8,-2.5]}],nj=[0,0,0,200/255];class lA{constructor(e={}){this.id="lighting-effect",this.shadowColor=nj,this.shadow=!1,this.directionalLights=[],this.pointLights=[],this.shadowPasses=[],this.dummyShadowMap=null,this.setProps(e)}setup(e){this.context=e;const{device:t,deck:r}=e;this.shadow&&!this.dummyShadowMap&&(this._createShadowPasses(t),r._addDefaultShaderModule(L3),this.dummyShadowMap=t.createTexture({width:1,height:1}))}setProps(e){this.ambientLight=void 0,this.directionalLights=[],this.pointLights=[];for(const t in e){const r=e[t];switch(r.type){case"ambient":this.ambientLight=r;break;case"directional":this.directionalLights.push(r);break;case"point":this.pointLights.push(r);break}}this._applyDefaultLights(),this.shadow=this.directionalLights.some(t=>t.shadow),this.context&&this.setup(this.context),this.props=e}preRender({layers:e,layerFilter:t,viewports:r,onViewportActive:a,views:h}){if(this.shadow){this.shadowMatrices=this._calculateMatrices();for(let y=0;y<this.shadowPasses.length;y++)this.shadowPasses[y].render({layers:e,layerFilter:t,viewports:r,onViewportActive:a,views:h,shaderModuleProps:{shadow:{shadowLightId:y,dummyShadowMap:this.dummyShadowMap,shadowMatrices:this.shadowMatrices}}})}}getShaderModuleProps(e,t){const r=this.shadow?{project:t.project,shadowMaps:this.shadowPasses.map(y=>y.getShadowMap()),dummyShadowMap:this.dummyShadowMap,shadowColor:this.shadowColor,shadowMatrices:this.shadowMatrices}:{},a={enabled:!0,ambientLight:this.ambientLight,directionalLights:this.directionalLights.map(y=>y.getProjectedLight({layer:e})),pointLights:this.pointLights.map(y=>y.getProjectedLight({layer:e}))},h=e.props.material;return{shadow:r,lighting:a,phongMaterial:h,gouraudMaterial:h}}cleanup(e){for(const t of this.shadowPasses)t.delete();this.shadowPasses.length=0,this.dummyShadowMap&&(this.dummyShadowMap.destroy(),this.dummyShadowMap=null,e.deck._removeDefaultShaderModule(L3))}_calculateMatrices(){const e=[];for(const t of this.directionalLights){const r=new qn().lookAt({eye:new Wn(t.direction).negate()});e.push(r)}return e}_createShadowPasses(e){for(let t=0;t<this.directionalLights.length;t++){const r=new ij(e);this.shadowPasses[t]=r}}_applyDefaultLights(){const{ambientLight:e,pointLights:t,directionalLights:r}=this;!e&&t.length===0&&r.length===0&&(this.ambientLight=new pP(rj),this.directionalLights.push(new Y1(z3[0]),new Y1(z3[1])))}}class sj{constructor(e={}){this._pool=[],this.opts={overAlloc:2,poolSize:100},this.setOptions(e)}setOptions(e){Object.assign(this.opts,e)}allocate(e,t,{size:r=1,type:a,padding:h=0,copy:y=!1,initialize:s=!1,maxCount:T}){const B=a||e&&e.constructor||Float32Array,F=t*r+h;if(ArrayBuffer.isView(e)){if(F<=e.length)return e;if(F*e.BYTES_PER_ELEMENT<=e.buffer.byteLength)return new B(e.buffer,0,F)}let V=1/0;T&&(V=T*r+h);const X=this._allocate(B,F,s,V);return e&&y?X.set(e):s||X.fill(0,0,4),this._release(e),X}release(e){this._release(e)}_allocate(e,t,r,a){let h=Math.max(Math.ceil(t*this.opts.overAlloc),1);h>a&&(h=a);const y=this._pool,s=e.BYTES_PER_ELEMENT*h,T=y.findIndex(B=>B.byteLength>=s);if(T>=0){const B=new e(y.splice(T,1)[0],0,h);return r&&B.fill(0),B}return new e(h)}_release(e){if(!ArrayBuffer.isView(e))return;const t=this._pool,{buffer:r}=e,{byteLength:a}=r,h=t.findIndex(y=>y.byteLength>=a);h<0?t.push(r):(h>0||t.length<this.opts.poolSize)&&t.splice(h,0,r),t.length>this.opts.poolSize&&t.shift()}}const xm=new sj;function jp(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function oj(i,e){const t=i%e;return t<0?e+t:t}function aj(i){return[i[12],i[13],i[14]]}function lj(i){return{left:td(i[3]+i[0],i[7]+i[4],i[11]+i[8],i[15]+i[12]),right:td(i[3]-i[0],i[7]-i[4],i[11]-i[8],i[15]-i[12]),bottom:td(i[3]+i[1],i[7]+i[5],i[11]+i[9],i[15]+i[13]),top:td(i[3]-i[1],i[7]-i[5],i[11]-i[9],i[15]-i[13]),near:td(i[3]+i[2],i[7]+i[6],i[11]+i[10],i[15]+i[14]),far:td(i[3]-i[2],i[7]-i[6],i[11]-i[10],i[15]-i[14])}}const U3=new Wn;function td(i,e,t,r){U3.set(i,e,t);const a=U3.len();return{distance:r/a,normal:new Wn(-i/a,-e/a,-t/a)}}function cj(i){return i-Math.fround(i)}let kp;function eb(i,e){const{size:t=1,startIndex:r=0}=e,a=e.endIndex!==void 0?e.endIndex:i.length,h=(a-r)/t;kp=xm.allocate(kp,h,{type:Float32Array,size:t*2});let y=r,s=0;for(;y<a;){for(let T=0;T<t;T++){const B=i[y++];kp[s+T]=B,kp[s+T+t]=cj(B)}s+=t*2}return kp.subarray(0,h*t*2)}function uj(i){let e=null,t=!1;for(const r of i)r&&(e?(t||(e=[[e[0][0],e[0][1]],[e[1][0],e[1][1]]],t=!0),e[0][0]=Math.min(e[0][0],r[0][0]),e[0][1]=Math.min(e[0][1],r[0][1]),e[1][0]=Math.max(e[1][0],r[1][0]),e[1][1]=Math.max(e[1][1],r[1][1])):e=r);return e}const hj=Math.PI/180,dj=jp(),V3=[0,0,0],fj={unitsPerMeter:[1,1,1],metersPerUnit:[1,1,1]};function pj({width:i,height:e,orthographic:t,fovyRadians:r,focalDistance:a,padding:h,near:y,far:s}){const T=i/e,B=t?new qn().orthographic({fovy:r,aspect:T,focalDistance:a,near:y,far:s}):new qn().perspective({fovy:r,aspect:T,near:y,far:s});if(h){const{left:F=0,right:V=0,top:X=0,bottom:se=0}=h,ne=ba((F+i-V)/2,0,i)-i/2,K=ba((X+e-se)/2,0,e)-e/2;B[8]-=ne*2/i,B[9]+=K*2/e}return B}class Md{constructor(e={}){this._frustumPlanes={},this.id=e.id||this.constructor.displayName||"viewport",this.x=e.x||0,this.y=e.y||0,this.width=e.width||1,this.height=e.height||1,this.zoom=e.zoom||0,this.padding=e.padding,this.distanceScales=e.distanceScales||fj,this.focalDistance=e.focalDistance||1,this.position=e.position||V3,this.modelMatrix=e.modelMatrix||null;const{longitude:t,latitude:r}=e;this.isGeospatial=Number.isFinite(r)&&Number.isFinite(t),this._initProps(e),this._initMatrices(e),this.equals=this.equals.bind(this),this.project=this.project.bind(this),this.unproject=this.unproject.bind(this),this.projectPosition=this.projectPosition.bind(this),this.unprojectPosition=this.unprojectPosition.bind(this),this.projectFlat=this.projectFlat.bind(this),this.unprojectFlat=this.unprojectFlat.bind(this)}get subViewports(){return null}get metersPerPixel(){return this.distanceScales.metersPerUnit[2]/this.scale}get projectionMode(){return this.isGeospatial?this.zoom<12?Hs.WEB_MERCATOR:Hs.WEB_MERCATOR_AUTO_OFFSET:Hs.IDENTITY}equals(e){return e instanceof Md?this===e?!0:e.width===this.width&&e.height===this.height&&e.scale===this.scale&&_m(e.projectionMatrix,this.projectionMatrix)&&_m(e.viewMatrix,this.viewMatrix):!1}project(e,{topLeft:t=!0}={}){const r=this.projectPosition(e),a=dP(r,this.pixelProjectionMatrix),[h,y]=a,s=t?y:this.height-y;return e.length===2?[h,s]:[h,s,a[2]]}unproject(e,{topLeft:t=!0,targetZ:r}={}){const[a,h,y]=e,s=t?h:this.height-h,T=r&&r*this.distanceScales.unitsPerMeter[2],B=oA([a,s,y],this.pixelUnprojectionMatrix,T),[F,V,X]=this.unprojectPosition(B);return Number.isFinite(y)?[F,V,X]:Number.isFinite(r)?[F,V,r]:[F,V]}projectPosition(e){const[t,r]=this.projectFlat(e),a=(e[2]||0)*this.distanceScales.unitsPerMeter[2];return[t,r,a]}unprojectPosition(e){const[t,r]=this.unprojectFlat(e),a=(e[2]||0)*this.distanceScales.metersPerUnit[2];return[t,r,a]}projectFlat(e){if(this.isGeospatial){const t=ym(e);return t[1]=ba(t[1],-318,830),t}return e}unprojectFlat(e){return this.isGeospatial?Ad(e):e}getBounds(e={}){const t={targetZ:e.z||0},r=this.unproject([0,0],t),a=this.unproject([this.width,0],t),h=this.unproject([0,this.height],t),y=this.unproject([this.width,this.height],t);return[Math.min(r[0],a[0],h[0],y[0]),Math.min(r[1],a[1],h[1],y[1]),Math.max(r[0],a[0],h[0],y[0]),Math.max(r[1],a[1],h[1],y[1])]}getDistanceScales(e){return e&&this.isGeospatial?Z1({longitude:e[0],latitude:e[1],highPrecision:!0}):this.distanceScales}containsPixel({x:e,y:t,width:r=1,height:a=1}){return e<this.x+this.width&&this.x<e+r&&t<this.y+this.height&&this.y<t+a}getFrustumPlanes(){return this._frustumPlanes.near?this._frustumPlanes:(Object.assign(this._frustumPlanes,lj(this.viewProjectionMatrix)),this._frustumPlanes)}panByPosition(e,t){return null}_initProps(e){const t=e.longitude,r=e.latitude;this.isGeospatial&&(Number.isFinite(e.zoom)||(this.zoom=A8({latitude:r})+Math.log2(this.focalDistance)),this.distanceScales=e.distanceScales||Z1({latitude:r,longitude:t}));const a=Math.pow(2,this.zoom);this.scale=a;const{position:h,modelMatrix:y}=e;let s=V3;if(h&&(s=y?new qn(y).transformAsVector(h,[]):h),this.isGeospatial){const T=this.projectPosition([t,r,0]);this.center=new Wn(s).scale(this.distanceScales.unitsPerMeter).add(T)}else this.center=this.projectPosition(s)}_initMatrices(e){const{viewMatrix:t=dj,projectionMatrix:r=null,orthographic:a=!1,fovyRadians:h,fovy:y=75,near:s=.1,far:T=1e3,padding:B=null,focalDistance:F=1}=e;this.viewMatrixUncentered=t,this.viewMatrix=new qn().multiplyRight(t).translate(new Wn(this.center).negate()),this.projectionMatrix=r||pj({width:this.width,height:this.height,orthographic:a,fovyRadians:h||y*hj,focalDistance:F,padding:B,near:s,far:T});const V=jp();wu(V,V,this.projectionMatrix),wu(V,V,this.viewMatrix),this.viewProjectionMatrix=V,this.viewMatrixInverse=U1([],this.viewMatrix)||this.viewMatrix,this.cameraPosition=aj(this.viewMatrixInverse);const X=jp(),se=jp();tA(X,X,[this.width/2,-this.height/2,1]),My(X,X,[1,-1,0]),wu(se,X,this.viewProjectionMatrix),this.pixelProjectionMatrix=se,this.pixelUnprojectionMatrix=U1(jp(),this.pixelProjectionMatrix),this.pixelUnprojectionMatrix||gr.warn("Pixel project matrix not invertible")()}}Md.displayName="Viewport";class Ru extends Md{constructor(e={}){const{latitude:t=0,longitude:r=0,zoom:a=0,pitch:h=0,bearing:y=0,nearZMultiplier:s=.1,farZMultiplier:T=1.01,nearZ:B,farZ:F,orthographic:V=!1,projectionMatrix:X,repeat:se=!1,worldOffset:ne=0,position:K,padding:ue,legacyMeterSizes:_e=!1}=e;let{width:ke,height:we,altitude:ge=1.5}=e;const Le=Math.pow(2,a);ke=ke||1,we=we||1;let $e,Ye=null;if(X)ge=X[5]/2,$e=vm(ge);else{e.fovy?($e=e.fovy,ge=sA($e)):$e=vm(ge);let Pt;if(ue){const{top:vt=0,bottom:yt=0}=ue;Pt=[0,ba((vt+we-yt)/2,0,we)-we/2]}Ye=E8({width:ke,height:we,scale:Le,center:K&&[0,0,K[2]*Jg(t)],offset:Pt,pitch:h,fovy:$e,nearZMultiplier:s,farZMultiplier:T}),Number.isFinite(B)&&(Ye.near=B),Number.isFinite(F)&&(Ye.far=F)}let St=T8({height:we,pitch:h,bearing:y,scale:Le,altitude:ge});ne&&(St=new qn().translate([512*ne,0,0]).multiplyLeft(St)),super({...e,width:ke,height:we,viewMatrix:St,longitude:r,latitude:t,zoom:a,...Ye,fovy:$e,focalDistance:ge}),this.latitude=t,this.longitude=r,this.zoom=a,this.pitch=h,this.bearing=y,this.altitude=ge,this.fovy=$e,this.orthographic=V,this._subViewports=se?[]:null,this._pseudoMeters=_e,Object.freeze(this)}get subViewports(){if(this._subViewports&&!this._subViewports.length){const e=this.getBounds(),t=Math.floor((e[0]+180)/360),r=Math.ceil((e[2]-180)/360);for(let a=t;a<=r;a++){const h=a?new Ru({...this,worldOffset:a}):this;this._subViewports.push(h)}}return this._subViewports}projectPosition(e){if(this._pseudoMeters)return super.projectPosition(e);const[t,r]=this.projectFlat(e),a=(e[2]||0)*Jg(e[1]);return[t,r,a]}unprojectPosition(e){if(this._pseudoMeters)return super.unprojectPosition(e);const[t,r]=this.unprojectFlat(e),a=(e[2]||0)/Jg(r);return[t,r,a]}addMetersToLngLat(e,t){return hP(e,t)}panByPosition(e,t){const r=oA(t,this.pixelUnprojectionMatrix),a=this.projectFlat(e),h=o3([],a,bU([],r)),y=o3([],this.center,h),[s,T]=this.unprojectFlat(y);return{longitude:s,latitude:T}}getBounds(e={}){const t=C8(this,e.z||0);return[Math.min(t[0][0],t[1][0],t[2][0],t[3][0]),Math.min(t[0][1],t[1][1],t[2][1],t[3][1]),Math.max(t[0][0],t[1][0],t[2][0],t[3][0]),Math.max(t[0][1],t[1][1],t[2][1],t[3][1])]}fitBounds(e,t={}){const{width:r,height:a}=this,{longitude:h,latitude:y,zoom:s}=S8({width:r,height:a,bounds:e,...t});return new Ru({width:r,height:a,longitude:h,latitude:y,zoom:s})}}Ru.displayName="WebMercatorViewport";const j3=[0,0,0];function tb(i,e,t=!1){const r=e.projectPosition(i);if(t&&e instanceof Ru){const[a,h,y=0]=i,s=e.getDistanceScales([a,h]);r[2]=y*s.unitsPerMeter[2]}return r}function mj(i){const{viewport:e,modelMatrix:t,coordinateOrigin:r}=i;let{coordinateSystem:a,fromCoordinateSystem:h,fromCoordinateOrigin:y}=i;return a===lr.DEFAULT&&(a=e.isGeospatial?lr.LNGLAT:lr.CARTESIAN),h===void 0&&(h=a),y===void 0&&(y=r),{viewport:e,coordinateSystem:a,coordinateOrigin:r,modelMatrix:t,fromCoordinateSystem:h,fromCoordinateOrigin:y}}function _P(i,{viewport:e,modelMatrix:t,coordinateSystem:r,coordinateOrigin:a,offsetMode:h}){let[y,s,T=0]=i;switch(t&&([y,s,T]=Cd([],[y,s,T,1],t)),r){case lr.LNGLAT:return tb([y,s,T],e,h);case lr.LNGLAT_OFFSETS:return tb([y+a[0],s+a[1],T+(a[2]||0)],e,h);case lr.METER_OFFSETS:return tb(hP(a,[y,s,T]),e,h);case lr.CARTESIAN:default:return e.isGeospatial?[y+a[0],s+a[1],T+a[2]]:e.projectPosition([y,s,T])}}function _j(i,e){const{viewport:t,coordinateSystem:r,coordinateOrigin:a,modelMatrix:h,fromCoordinateSystem:y,fromCoordinateOrigin:s}=mj(e),{autoOffset:T=!0}=e,{geospatialOrigin:B=j3,shaderCoordinateOrigin:F=j3,offsetMode:V=!1}=T?cP(t,r,a):{},X=_P(i,{viewport:t,modelMatrix:h,coordinateSystem:y,coordinateOrigin:s,offsetMode:V});if(V){const se=t.projectPosition(B||F);jR(X,X,se)}return X}const Pu=Math.PI/180,gj=1e3*60*60*24,yj=2440588,vj=2451545,Oy=Pu*23.4397,xj=357.5291,bj=.98560028,wj=280.147,Aj=360.9856235;function Tj(i,e,t){const r=Pu*-t,a=Pu*e,h=Sj(i),y=Oj(h),s=Pj(h,r)-y.rightAscension;return{azimuth:Mj(s,a,y.declination),altitude:Rj(s,a,y.declination)}}function H3(i,e,t){const{azimuth:r,altitude:a}=Tj(i,e,t);return[Math.sin(r)*Math.cos(a),Math.cos(r)*Math.cos(a),-Math.sin(a)]}function Ej(i){return(typeof i=="number"?i:i.getTime())/gj-.5+yj}function Sj(i){return Ej(i)-vj}function Ij(i,e){const t=i;return Math.atan2(Math.sin(t)*Math.cos(Oy)-Math.tan(e)*Math.sin(Oy),Math.cos(t))}function Cj(i,e){const t=i;return Math.asin(Math.sin(e)*Math.cos(Oy)+Math.cos(e)*Math.sin(Oy)*Math.sin(t))}function Mj(i,e,t){const r=i,a=e,h=t;return Math.atan2(Math.sin(r),Math.cos(r)*Math.sin(a)-Math.tan(h)*Math.cos(a))}function Rj(i,e,t){const r=i,a=e,h=t;return Math.asin(Math.sin(a)*Math.sin(h)+Math.cos(a)*Math.cos(h)*Math.cos(r))}function Pj(i,e){return Pu*(wj+Aj*i)-e}function Bj(i){return Pu*(xj+bj*i)}function Dj(i){const e=i,t=Pu*(1.9148*Math.sin(e)+.02*Math.sin(2*e)+3e-4*Math.sin(3*e)),r=Pu*102.9372;return e+t+r+Math.PI}function Oj(i){const e=Bj(i),t=Dj(e);return{declination:Cj(t,0),rightAscension:Ij(t,0)}}class Fj extends Y1{constructor(e){super(e),this.timestamp=e.timestamp}getProjectedLight({layer:e}){const{viewport:t}=e.context;if(t.resolution&&t.resolution>0){const[a,h,y]=H3(this.timestamp,0,0);this.direction=[a,-y,h]}else{const{latitude:a,longitude:h}=t;this.direction=H3(this.timestamp,a,h)}return this}}let kj=1,Lj=1;class gP{constructor(){pe(this,"time",0);pe(this,"channels",new Map);pe(this,"animations",new Map);pe(this,"playing",!1);pe(this,"lastEngineTime",-1)}addChannel(e){const{delay:t=0,duration:r=Number.POSITIVE_INFINITY,rate:a=1,repeat:h=1}=e,y=kj++,s={time:0,delay:t,duration:r,rate:a,repeat:h};return this._setChannelTime(s,this.time),this.channels.set(y,s),y}removeChannel(e){this.channels.delete(e);for(const[t,r]of this.animations)r.channel===e&&this.detachAnimation(t)}isFinished(e){const t=this.channels.get(e);return t===void 0?!1:this.time>=t.delay+t.duration*t.repeat}getTime(e){if(e===void 0)return this.time;const t=this.channels.get(e);return t===void 0?-1:t.time}setTime(e){this.time=Math.max(0,e);const t=this.channels.values();for(const a of t)this._setChannelTime(a,this.time);const r=this.animations.values();for(const a of r){const{animation:h,channel:y}=a;h.setTime(this.getTime(y))}}play(){this.playing=!0}pause(){this.playing=!1,this.lastEngineTime=-1}reset(){this.setTime(0)}attachAnimation(e,t){const r=Lj++;return this.animations.set(r,{animation:e,channel:t}),e.setTime(this.getTime(t)),r}detachAnimation(e){this.animations.delete(e)}update(e){this.playing&&(this.lastEngineTime===-1&&(this.lastEngineTime=e),this.setTime(this.time+(e-this.lastEngineTime)),this.lastEngineTime=e)}_setChannelTime(e,t){const r=t-e.delay,a=e.duration*e.repeat;r>=a?e.time=e.duration*e.rate:(e.time=Math.max(0,r)%e.duration,e.time*=e.rate)}}function Nj(i){return typeof window<"u"&&window.requestAnimationFrame?window.requestAnimationFrame(i):setTimeout(i,1e3/60)}function zj(i){return typeof window<"u"&&window.cancelAnimationFrame?window.cancelAnimationFrame(i):clearTimeout(i)}let Uj=0;const Vj={device:null,onAddHTML:()=>"",onInitialize:async()=>null,onRender:()=>{},onFinalize:()=>{},onError:i=>console.error(i),stats:M1.stats.get(`animation-loop-${Uj++}`),useDevicePixels:!0,autoResizeViewport:!1,autoResizeDrawingBuffer:!1};class jj{constructor(e){pe(this,"device",null);pe(this,"canvas",null);pe(this,"props");pe(this,"animationProps",null);pe(this,"timeline",null);pe(this,"stats");pe(this,"cpuTime");pe(this,"gpuTime");pe(this,"frameRate");pe(this,"display");pe(this,"needsRedraw","initialized");pe(this,"_initialized",!1);pe(this,"_running",!1);pe(this,"_animationFrameId",null);pe(this,"_nextFramePromise",null);pe(this,"_resolveNextFrame",null);pe(this,"_cpuStartTime",0);pe(this,"_error",null);if(this.props={...Vj,...e},e=this.props,!e.device)throw new Error("No device provided");const{useDevicePixels:t=!0}=this.props;this.stats=e.stats||new p0({id:"animation-loop-stats"}),this.cpuTime=this.stats.get("CPU Time"),this.gpuTime=this.stats.get("GPU Time"),this.frameRate=this.stats.get("Frame Rate"),this.setProps({autoResizeViewport:e.autoResizeViewport,autoResizeDrawingBuffer:e.autoResizeDrawingBuffer,useDevicePixels:t}),this.start=this.start.bind(this),this.stop=this.stop.bind(this),this._onMousemove=this._onMousemove.bind(this),this._onMouseleave=this._onMouseleave.bind(this)}destroy(){this.stop(),this._setDisplay(null)}delete(){this.destroy()}setError(e){var r,a;if(this.props.onError(e),this._error=Error(),((a=(r=this.device)==null?void 0:r.canvasContext)==null?void 0:a.canvas)instanceof HTMLCanvasElement){const h=document.createElement("h1");h.innerHTML=e.message,h.style.position="absolute",h.style.top="20%",h.style.left="10px",h.style.color="black",h.style.backgroundColor="red",document.body.appendChild(h)}}setNeedsRedraw(e){return this.needsRedraw=this.needsRedraw||e,this}setProps(e){return"autoResizeViewport"in e&&(this.props.autoResizeViewport=e.autoResizeViewport||!1),"autoResizeDrawingBuffer"in e&&(this.props.autoResizeDrawingBuffer=e.autoResizeDrawingBuffer||!1),"useDevicePixels"in e&&(this.props.useDevicePixels=e.useDevicePixels||!1),this}async start(){if(this._running)return this;this._running=!0;try{let e;return this._initialized||(this._initialized=!0,await this._initDevice(),this._initialize(),await this.props.onInitialize(this._getAnimationProps())),this._running?(e!==!1&&(this._cancelAnimationFrame(),this._requestAnimationFrame()),this):null}catch(e){const t=e instanceof Error?e:new Error("Unknown error");throw this.props.onError(t),t}}stop(){return this._running&&(this.animationProps&&!this._error&&this.props.onFinalize(this.animationProps),this._cancelAnimationFrame(),this._nextFramePromise=null,this._resolveNextFrame=null,this._running=!1),this}redraw(){var e;return(e=this.device)!=null&&e.isLost||this._error?this:(this._beginFrameTimers(),this._setupFrame(),this._updateAnimationProps(),this._renderFrame(this._getAnimationProps()),this._clearNeedsRedraw(),this._resolveNextFrame&&(this._resolveNextFrame(this),this._nextFramePromise=null,this._resolveNextFrame=null),this._endFrameTimers(),this)}attachTimeline(e){return this.timeline=e,this.timeline}detachTimeline(){this.timeline=null}waitForRender(){return this.setNeedsRedraw("waitForRender"),this._nextFramePromise||(this._nextFramePromise=new Promise(e=>{this._resolveNextFrame=e})),this._nextFramePromise}async toDataURL(){if(this.setNeedsRedraw("toDataURL"),await this.waitForRender(),this.canvas instanceof HTMLCanvasElement)return this.canvas.toDataURL();throw new Error("OffscreenCanvas")}_initialize(){this._startEventHandling(),this._initializeAnimationProps(),this._updateAnimationProps(),this._resizeCanvasDrawingBuffer(),this._resizeViewport()}_setDisplay(e){this.display&&(this.display.destroy(),this.display.animationLoop=null),e&&(e.animationLoop=this),this.display=e}_requestAnimationFrame(){this._running&&(this._animationFrameId=Nj(this._animationFrame.bind(this)))}_cancelAnimationFrame(){this._animationFrameId!==null&&(zj(this._animationFrameId),this._animationFrameId=null)}_animationFrame(){this._running&&(this.redraw(),this._requestAnimationFrame())}_renderFrame(e){var t;if(this.display){this.display._renderFrame(e);return}this.props.onRender(this._getAnimationProps()),(t=this.device)==null||t.submit()}_clearNeedsRedraw(){this.needsRedraw=!1}_setupFrame(){this._resizeCanvasDrawingBuffer(),this._resizeViewport()}_initializeAnimationProps(){var t,r;const e=(r=(t=this.device)==null?void 0:t.canvasContext)==null?void 0:r.canvas;if(!this.device||!e)throw new Error("loop");this.animationProps={animationLoop:this,device:this.device,canvas:e,timeline:this.timeline,useDevicePixels:this.props.useDevicePixels,needsRedraw:!1,width:1,height:1,aspect:1,time:0,startTime:Date.now(),engineTime:0,tick:0,tock:0,_mousePosition:null}}_getAnimationProps(){if(!this.animationProps)throw new Error("animationProps");return this.animationProps}_updateAnimationProps(){if(!this.animationProps)return;const{width:e,height:t,aspect:r}=this._getSizeAndAspect();(e!==this.animationProps.width||t!==this.animationProps.height)&&this.setNeedsRedraw("drawing buffer resized"),r!==this.animationProps.aspect&&this.setNeedsRedraw("drawing buffer aspect changed"),this.animationProps.width=e,this.animationProps.height=t,this.animationProps.aspect=r,this.animationProps.needsRedraw=this.needsRedraw,this.animationProps.engineTime=Date.now()-this.animationProps.startTime,this.timeline&&this.timeline.update(this.animationProps.engineTime),this.animationProps.tick=Math.floor(this.animationProps.time/1e3*60),this.animationProps.tock++,this.animationProps.time=this.timeline?this.timeline.getTime():this.animationProps.engineTime}async _initDevice(){var e;if(this.device=await this.props.device,!this.device)throw new Error("No device provided");this.canvas=((e=this.device.canvasContext)==null?void 0:e.canvas)||null}_createInfoDiv(){if(this.canvas&&this.props.onAddHTML){const e=document.createElement("div");document.body.appendChild(e),e.style.position="relative";const t=document.createElement("div");t.style.position="absolute",t.style.left="10px",t.style.bottom="10px",t.style.width="300px",t.style.background="white",this.canvas instanceof HTMLCanvasElement&&e.appendChild(this.canvas),e.appendChild(t);const r=this.props.onAddHTML(t);r&&(t.innerHTML=r)}}_getSizeAndAspect(){var h,y,s,T;if(!this.device)return{width:1,height:1,aspect:1};const[e,t]=((y=(h=this.device)==null?void 0:h.canvasContext)==null?void 0:y.getPixelSize())||[1,1];let r=1;const a=(T=(s=this.device)==null?void 0:s.canvasContext)==null?void 0:T.canvas;return a&&a.clientHeight?r=a.clientWidth/a.clientHeight:e>0&&t>0&&(r=e/t),{width:e,height:t,aspect:r}}_resizeViewport(){this.props.autoResizeViewport&&this.device.gl&&this.device.gl.viewport(0,0,this.device.gl.drawingBufferWidth,this.device.gl.drawingBufferHeight)}_resizeCanvasDrawingBuffer(){var e,t;this.props.autoResizeDrawingBuffer&&((t=(e=this.device)==null?void 0:e.canvasContext)==null||t.resize({useDevicePixels:this.props.useDevicePixels}))}_beginFrameTimers(){this.frameRate.timeEnd(),this.frameRate.timeStart(),this.cpuTime.timeStart()}_endFrameTimers(){this.cpuTime.timeEnd()}_startEventHandling(){this.canvas&&(this.canvas.addEventListener("mousemove",this._onMousemove.bind(this)),this.canvas.addEventListener("mouseleave",this._onMouseleave.bind(this)))}_onMousemove(e){e instanceof MouseEvent&&(this._getAnimationProps()._mousePosition=[e.offsetX,e.offsetY])}_onMouseleave(e){this._getAnimationProps()._mousePosition=null}}const ib={};function Nm(i="id"){ib[i]=ib[i]||1;const e=ib[i]++;return`${i}-${e}`}class G3{constructor(e){pe(this,"id");pe(this,"userData",{});pe(this,"topology");pe(this,"bufferLayout",[]);pe(this,"vertexCount");pe(this,"indices");pe(this,"attributes");if(this.id=e.id||Nm("geometry"),this.topology=e.topology,this.indices=e.indices||null,this.attributes=e.attributes,this.vertexCount=e.vertexCount,this.bufferLayout=e.bufferLayout||[],this.indices&&!(this.indices.usage&Gr.INDEX))throw new Error("Index buffer must have INDEX usage")}destroy(){var e;(e=this.indices)==null||e.destroy();for(const t of Object.values(this.attributes))t.destroy()}getVertexCount(){return this.vertexCount}getAttributes(){return this.attributes}getIndexes(){return this.indices||null}_calculateVertexCount(e){return e.byteLength/12}}function Hj(i,e){if(e instanceof G3)return e;const t=Gj(i,e),{attributes:r,bufferLayout:a}=$j(i,e);return new G3({topology:e.topology||"triangle-list",bufferLayout:a,vertexCount:e.vertexCount,indices:t,attributes:r})}function Gj(i,e){if(!e.indices)return;const t=e.indices.value;return i.createBuffer({usage:Gr.INDEX,data:t})}function $j(i,e){const t=[],r={};for(const[h,y]of Object.entries(e.attributes)){let s=h;switch(h){case"POSITION":s="positions";break;case"NORMAL":s="normals";break;case"TEXCOORD_0":s="texCoords";break;case"COLOR_0":s="colors";break}if(y){r[s]=i.createBuffer({data:y.value,id:`${h}-buffer`});const{value:T,size:B,normalized:F}=y;t.push({name:s,format:L5(T,B,F)})}}const a=e._calculateVertexCount(e.attributes,e.indices);return{attributes:r,bufferLayout:t,vertexCount:a}}const t0=class t0{constructor(e){pe(this,"device");pe(this,"destroyPolicy");pe(this,"_hashCounter",0);pe(this,"_hashes",{});pe(this,"_renderPipelineCache",{});pe(this,"_computePipelineCache",{});this.device=e,this.destroyPolicy=e.props._factoryDestroyPolicy}static getDefaultPipelineFactory(e){return e._lumaData.defaultPipelineFactory=e._lumaData.defaultPipelineFactory||new t0(e),e._lumaData.defaultPipelineFactory}createRenderPipeline(e){const t={...xd.defaultProps,...e},r=this._hashRenderPipeline(t);if(!this._renderPipelineCache[r]){const a=this.device.createRenderPipeline({...t,id:t.id?`${t.id}-cached`:void 0});a.hash=r,this._renderPipelineCache[r]={pipeline:a,useCount:0}}return this._renderPipelineCache[r].useCount++,this._renderPipelineCache[r].pipeline}createComputePipeline(e){const t={...by.defaultProps,...e},r=this._hashComputePipeline(t);if(!this._computePipelineCache[r]){const a=this.device.createComputePipeline({...t,id:t.id?`${t.id}-cached`:void 0});a.hash=r,this._computePipelineCache[r]={pipeline:a,useCount:0}}return this._computePipelineCache[r].useCount++,this._computePipelineCache[r].pipeline}release(e){const t=e.hash,r=e instanceof by?this._computePipelineCache:this._renderPipelineCache;r[t].useCount--,r[t].useCount===0&&this.destroyPolicy==="unused"&&(r[t].pipeline.destroy(),delete r[t])}_hashComputePipeline(e){return`${this._getHash(e.shader.source)}`}_hashRenderPipeline(e){const t=e.vs?this._getHash(e.vs.source):0,r=e.fs?this._getHash(e.fs.source):0,a="-",h=this._getHash(JSON.stringify(e.bufferLayout));switch(this.device.type){case"webgl":return`${t}/${r}V${a}BL${h}`;default:const y=this._getHash(JSON.stringify(e.parameters));return`${t}/${r}V${a}T${e.topology}P${y}BL${h}`}}_getHash(e){return this._hashes[e]===void 0&&(this._hashes[e]=this._hashCounter++),this._hashes[e]}};pe(t0,"defaultProps",{...xd.defaultProps});let K1=t0;const i0=class i0{constructor(e){pe(this,"device");pe(this,"destroyPolicy");pe(this,"_cache",{});this.device=e,this.destroyPolicy=e.props._factoryDestroyPolicy}static getDefaultShaderFactory(e){var t;return(t=e._lumaData).defaultShaderFactory||(t.defaultShaderFactory=new i0(e)),e._lumaData.defaultShaderFactory}createShader(e){const t=this._hashShader(e);let r=this._cache[t];if(!r){const a=this.device.createShader({...e,id:e.id?`${e.id}-cached`:void 0});this._cache[t]=r={shader:a,useCount:0}}return r.useCount++,r.shader}release(e){const t=this._hashShader(e),r=this._cache[t];r&&(r.useCount--,r.useCount===0&&this.destroyPolicy==="unused"&&(delete this._cache[t],r.shader.destroy()))}_hashShader(e){return`${e.stage}:${e.source}`}};pe(i0,"defaultProps",{...yy.defaultProps});let J1=i0;function Wj(i,e){var a;const t={},r="Values";if(i.attributes.length===0&&!((a=i.varyings)!=null&&a.length))return{"No attributes or varyings":{[r]:"N/A"}};for(const h of i.attributes)if(h){const y=`${h.location} ${h.name}: ${h.type}`;t[`in ${y}`]={[r]:h.stepMode||"vertex"}}for(const h of i.varyings||[]){const y=`${h.location} ${h.name}`;t[`out ${y}`]={[r]:JSON.stringify(h)}}return t}let On=null,fu=null;function qj(i,{id:e,minimap:t,opaque:r,top:a="0",left:h="0",rgbaScale:y=1}){On||(On=document.createElement("canvas"),On.id=e,On.title=e,On.style.zIndex="100",On.style.position="absolute",On.style.top=a,On.style.left=h,On.style.border="blue 5px solid",On.style.transform="scaleY(-1)",document.body.appendChild(On),fu=On.getContext("2d")),(On.width!==i.width||On.height!==i.height)&&(On.width=i.width/2,On.height=i.height/2,On.style.width="400px",On.style.height="400px");const s=i.device.readPixelsToArrayWebGL(i),T=fu==null?void 0:fu.createImageData(i.width,i.height);if(T){for(let F=0;F<s.length;F+=4)T.data[0+F+0]=s[F+0]*y,T.data[0+F+1]=s[F+1]*y,T.data[0+F+2]=s[F+2]*y,T.data[0+F+3]=r?255:s[F+3]*y;fu==null||fu.putImageData(T,0,0)}}function Q1(i,e,t){if(i===e)return!0;if(!t||!i||!e)return!1;if(Array.isArray(i)){if(!Array.isArray(e)||i.length!==e.length)return!1;for(let r=0;r<i.length;r++)if(!Q1(i[r],e[r],t-1))return!1;return!0}if(Array.isArray(e))return!1;if(typeof i=="object"&&typeof e=="object"){const r=Object.keys(i),a=Object.keys(e);if(r.length!==a.length)return!1;for(const h of r)if(!e.hasOwnProperty(h)||!Q1(i[h],e[h],t-1))return!1;return!0}return!1}function Xj(i){return ArrayBuffer.isView(i)&&!(i instanceof DataView)}function Zj(i){return Array.isArray(i)?i.length===0||typeof i[0]=="number":!1}function yP(i){return Xj(i)||Zj(i)}function Yj(i){return yP(i)||typeof i=="number"||typeof i=="boolean"}function vP(i){const e={bindings:{},uniforms:{}};return Object.keys(i).forEach(t=>{const r=i[t];Yj(r)?e.uniforms[t]=r:e.bindings[t]=r}),e}class Kj{constructor(e,t){pe(this,"options",{disableWarnings:!1});pe(this,"modules");pe(this,"moduleUniforms");pe(this,"moduleBindings");Object.assign(this.options,t);const r=jw(Object.values(e).filter(a=>a.dependencies));for(const a of r)e[a.name]=a;Gt.log(1,"Creating ShaderInputs with modules",Object.keys(e))(),this.modules=e,this.moduleUniforms={},this.moduleBindings={};for(const[a,h]of Object.entries(e))this._addModule(h),h.name&&a!==h.name&&!this.options.disableWarnings&&Gt.warn(`Module name: ${a} vs ${h.name}`)()}destroy(){}setProps(e){var t;for(const r of Object.keys(e)){const a=r,h=e[a]||{},y=this.modules[a];if(!y){this.options.disableWarnings||Gt.warn(`Module ${r} not found`)();continue}const s=this.moduleUniforms[a],T=this.moduleBindings[a],B=((t=y.getUniforms)==null?void 0:t.call(y,h,s))||h,{uniforms:F,bindings:V}=vP(B);this.moduleUniforms[a]={...s,...F},this.moduleBindings[a]={...T,...V}}}getModules(){return Object.values(this.modules)}getUniformValues(){return this.moduleUniforms}getBindingValues(){const e={};for(const t of Object.values(this.moduleBindings))Object.assign(e,t);return e}getDebugTable(){var t;const e={};for(const[r,a]of Object.entries(this.moduleUniforms))for(const[h,y]of Object.entries(a))e[`${r}.${h}`]={type:(t=this.modules[r].uniformTypes)==null?void 0:t[h],value:String(y)};return e}_addModule(e){const t=e.name;this.moduleUniforms[t]=e.defaultUniforms||{},this.moduleBindings[t]={}}}let Jj="";async function Qj(i,e){const t=new Image;return t.crossOrigin="anonymous",t.src=i.startsWith("http")?i:Jj+i,await t.decode(),e?await createImageBitmap(t,e):await createImageBitmap(t)}class rb{constructor(e,t){pe(this,"device");pe(this,"id");pe(this,"texture");pe(this,"sampler");pe(this,"view");pe(this,"ready");pe(this,"isReady",!1);pe(this,"destroyed",!1);pe(this,"resolveReady",()=>{});pe(this,"rejectReady",()=>{});this.device=e,this.id=t.id||Nm("async-texture"),typeof(t==null?void 0:t.data)=="string"&&t.dimension==="2d"&&(t={...t,data:Qj(t.data)}),this.ready=new Promise((r,a)=>{this.resolveReady=()=>{this.isReady=!0,r()},this.rejectReady=a}),this.initAsync(t)}get[Symbol.toStringTag](){return"AsyncTexture"}toString(){return`AsyncTexture:"${this.id}"(${this.isReady?"ready":"loading"})`}async initAsync(e){let t,r;const a=e.data,h=await xP(a).then(t,r);if(this.destroyed)return;const y={...e,data:h};this.texture=this.device.createTexture(y),this.sampler=this.texture.sampler,this.view=this.texture.view,this.isReady=!0}destroy(){this.texture&&(this.texture.destroy(),this.texture=null),this.destroyed=!0}resize(e){if(!this.isReady)throw new Error("Cannot resize texture before it is ready");if(e.width===this.texture.width&&e.height===this.texture.height)return!1;if(this.texture){const t=this.texture;this.texture=t.clone(e),t.destroy()}return!0}}async function xP(i){if(i=await i,Array.isArray(i))return await Promise.all(i.map(xP));if(i&&typeof i=="object"&&i.constructor===Object){const e=i,t=await Promise.all(Object.values(e)),r=Object.keys(e),a={};for(let h=0;h<r.length;h++)a[r[h]]=t[h];return a}return i}const pu=2,e9=1e4,r0=class r0{constructor(e,t){pe(this,"device");pe(this,"id");pe(this,"source");pe(this,"vs");pe(this,"fs");pe(this,"pipelineFactory");pe(this,"shaderFactory");pe(this,"userData",{});pe(this,"parameters");pe(this,"topology");pe(this,"bufferLayout");pe(this,"isInstanced");pe(this,"instanceCount",0);pe(this,"vertexCount");pe(this,"indexBuffer",null);pe(this,"bufferAttributes",{});pe(this,"constantAttributes",{});pe(this,"bindings",{});pe(this,"uniforms",{});pe(this,"vertexArray");pe(this,"transformFeedback",null);pe(this,"pipeline");pe(this,"shaderInputs");pe(this,"_uniformStore");pe(this,"_attributeInfos",{});pe(this,"_gpuGeometry",null);pe(this,"_getModuleUniforms");pe(this,"props");pe(this,"_pipelineNeedsUpdate","newly created");pe(this,"_needsRedraw","initializing");pe(this,"_destroyed",!1);pe(this,"_lastDrawTimestamp",-1);pe(this,"_lastLogTime",0);pe(this,"_logOpen",!1);pe(this,"_drawCount",0);var T,B,F,V;this.props={...r0.defaultProps,...t},t=this.props,this.id=t.id||Nm("model"),this.device=e,Object.assign(this.userData,t.userData);const r=Object.fromEntries(((T=this.props.modules)==null?void 0:T.map(X=>[X.name,X]))||[]),a=t.shaderInputs||new Kj(r,{disableWarnings:this.props.disableWarnings});this.setShaderInputs(a);const h=i9(e),y=(((B=this.props.modules)==null?void 0:B.length)>0?this.props.modules:(F=this.shaderInputs)==null?void 0:F.getModules())||[];if(this.device.type==="webgpu"&&this.props.source){const{source:X,getUniforms:se}=this.props.shaderAssembler.assembleWGSLShader({platformInfo:h,...this.props,modules:y});this.source=X,this._getModuleUniforms=se,(V=this.props).shaderLayout||(V.shaderLayout=dU(this.source))}else{const{vs:X,fs:se,getUniforms:ne}=this.props.shaderAssembler.assembleGLSLShaderPair({platformInfo:h,...this.props,modules:y});this.vs=X,this.fs=se,this._getModuleUniforms=ne}this.vertexCount=this.props.vertexCount,this.instanceCount=this.props.instanceCount,this.topology=this.props.topology,this.bufferLayout=this.props.bufferLayout,this.parameters=this.props.parameters,t.geometry&&this.setGeometry(t.geometry),this.pipelineFactory=t.pipelineFactory||K1.getDefaultPipelineFactory(this.device),this.shaderFactory=t.shaderFactory||J1.getDefaultShaderFactory(this.device),this.pipeline=this._updatePipeline(),this.vertexArray=e.createVertexArray({renderPipeline:this.pipeline}),this._gpuGeometry&&this._setGeometryAttributes(this._gpuGeometry),"isInstanced"in t&&(this.isInstanced=t.isInstanced),t.instanceCount&&this.setInstanceCount(t.instanceCount),t.vertexCount&&this.setVertexCount(t.vertexCount),t.indexBuffer&&this.setIndexBuffer(t.indexBuffer),t.attributes&&this.setAttributes(t.attributes),t.constantAttributes&&this.setConstantAttributes(t.constantAttributes),t.bindings&&this.setBindings(t.bindings),t.uniforms&&this.setUniformsWebGL(t.uniforms),t.moduleSettings&&this.updateModuleSettingsWebGL(t.moduleSettings),t.transformFeedback&&(this.transformFeedback=t.transformFeedback),Object.seal(this)}get[Symbol.toStringTag](){return"Model"}toString(){return`Model(${this.id})`}destroy(){var e;this._destroyed||(this.pipelineFactory.release(this.pipeline),this.shaderFactory.release(this.pipeline.vs),this.pipeline.fs&&this.shaderFactory.release(this.pipeline.fs),this._uniformStore.destroy(),(e=this._gpuGeometry)==null||e.destroy(),this._destroyed=!0)}needsRedraw(){this._getBindingsUpdateTimestamp()>this._lastDrawTimestamp&&this.setNeedsRedraw("contents of bound textures or buffers updated");const e=this._needsRedraw;return this._needsRedraw=!1,e}setNeedsRedraw(e){this._needsRedraw||(this._needsRedraw=e)}predraw(){this.updateShaderInputs(),this.pipeline=this._updatePipeline()}draw(e){const t=this._areBindingsLoading();if(t)return Gt.info(pu,`>>> DRAWING ABORTED ${this.id}: ${t} not loaded`)(),!1;try{e.pushDebugGroup(`${this}.predraw(${e})`),this.predraw()}finally{e.popDebugGroup()}let r;try{e.pushDebugGroup(`${this}.draw(${e})`),this._logDrawCallStart(),this.pipeline=this._updatePipeline();const a=this._getBindings();this.pipeline.setBindings(a,{disableWarnings:this.props.disableWarnings}),ew(this.uniforms)||this.pipeline.setUniformsWebGL(this.uniforms);const{indexBuffer:h}=this.vertexArray,y=h?h.byteLength/(h.indexType==="uint32"?4:2):void 0;r=this.pipeline.draw({renderPass:e,vertexArray:this.vertexArray,isInstanced:this.isInstanced,vertexCount:this.vertexCount,instanceCount:this.instanceCount,indexCount:y,transformFeedback:this.transformFeedback||void 0,parameters:this.parameters,topology:this.topology})}finally{e.popDebugGroup(),this._logDrawCallEnd()}return this._logFramebuffer(e),r?(this._lastDrawTimestamp=this.device.timestamp,this._needsRedraw=!1):this._needsRedraw="waiting for resource initialization",r}setGeometry(e){var r;(r=this._gpuGeometry)==null||r.destroy();const t=e&&Hj(this.device,e);if(t){this.setTopology(t.topology||"triangle-list");const a=new Hx(this.bufferLayout);this.bufferLayout=a.mergeBufferLayouts(t.bufferLayout,this.bufferLayout),this.vertexArray&&this._setGeometryAttributes(t)}this._gpuGeometry=t}setTopology(e){e!==this.topology&&(this.topology=e,this._setPipelineNeedsUpdate("topology"))}setBufferLayout(e){const t=new Hx(this.bufferLayout);this.bufferLayout=this._gpuGeometry?t.mergeBufferLayouts(e,this._gpuGeometry.bufferLayout):e,this._setPipelineNeedsUpdate("bufferLayout"),this.pipeline=this._updatePipeline(),this.vertexArray=this.device.createVertexArray({renderPipeline:this.pipeline}),this._gpuGeometry&&this._setGeometryAttributes(this._gpuGeometry)}setParameters(e){Q1(e,this.parameters,2)||(this.parameters=e,this._setPipelineNeedsUpdate("parameters"))}setInstanceCount(e){this.instanceCount=e,this.isInstanced===void 0&&e>0&&(this.isInstanced=!0),this.setNeedsRedraw("instanceCount")}setVertexCount(e){this.vertexCount=e,this.setNeedsRedraw("vertexCount")}setShaderInputs(e){this.shaderInputs=e,this._uniformStore=new k5(this.shaderInputs.modules);for(const[t,r]of Object.entries(this.shaderInputs.modules))if(t9(r)){const a=this._uniformStore.getManagedUniformBuffer(this.device,t);this.bindings[`${t}Uniforms`]=a}this.setNeedsRedraw("shaderInputs")}updateShaderInputs(){this._uniformStore.setUniforms(this.shaderInputs.getUniformValues()),this.setBindings(this.shaderInputs.getBindingValues()),this.setNeedsRedraw("shaderInputs")}setBindings(e){Object.assign(this.bindings,e),this.setNeedsRedraw("bindings")}setTransformFeedback(e){this.transformFeedback=e,this.setNeedsRedraw("transformFeedback")}setIndexBuffer(e){this.vertexArray.setIndexBuffer(e),this.setNeedsRedraw("indexBuffer")}setAttributes(e,t){const r=(t==null?void 0:t.disableWarnings)??this.props.disableWarnings;e.indices&&Gt.warn(`Model:${this.id} setAttributes() - indexBuffer should be set using setIndexBuffer()`)();const a=new Hx(this.bufferLayout);for(const[h,y]of Object.entries(e)){const s=a.getBufferLayout(h);if(!s){r||Gt.warn(`Model(${this.id}): Missing layout for buffer "${h}".`)();continue}const T=a.getAttributeNamesForBuffer(s);let B=!1;for(const F of T){const V=this._attributeInfos[F];V&&(this.vertexArray.setBuffer(V.location,y),B=!0)}!B&&!r&&Gt.warn(`Model(${this.id}): Ignoring buffer "${y.id}" for unknown attribute "${h}"`)()}this.setNeedsRedraw("attributes")}setConstantAttributes(e,t){for(const[r,a]of Object.entries(e)){const h=this._attributeInfos[r];h?this.vertexArray.setConstantWebGL(h.location,a):((t==null?void 0:t.disableWarnings)??this.props.disableWarnings)||Gt.warn(`Model "${this.id}: Ignoring constant supplied for unknown attribute "${r}"`)()}this.setNeedsRedraw("constants")}setUniforms(e){this.setUniformsWebGL(e)}setUniformsWebGL(e){ew(e)||(this.pipeline.setUniformsWebGL(e),Object.assign(this.uniforms,e)),this.setNeedsRedraw("uniforms")}updateModuleSettingsWebGL(e){const{bindings:t,uniforms:r}=vP(this._getModuleUniforms(e));Object.assign(this.bindings,t),Object.assign(this.uniforms,r),this.setNeedsRedraw("moduleSettings")}_areBindingsLoading(){for(const e of Object.values(this.bindings))if(e instanceof rb&&!e.isReady)return e.id;return!1}_getBindings(){const e={};for(const[t,r]of Object.entries(this.bindings))r instanceof rb?r.isReady&&(e[t]=r.texture):e[t]=r;return e}_getBindingsUpdateTimestamp(){let e=0;for(const t of Object.values(this.bindings))t instanceof gy?e=Math.max(e,t.texture.updateTimestamp):t instanceof Gr||t instanceof en?e=Math.max(e,t.updateTimestamp):t instanceof rb?e=t.texture?Math.max(e,t.texture.updateTimestamp):1/0:t instanceof vy||(e=Math.max(e,t.buffer.updateTimestamp));return e}_setGeometryAttributes(e){const t={...e.attributes};for(const[r]of Object.entries(t))!this.pipeline.shaderLayout.attributes.find(a=>a.name===r)&&r!=="positions"&&delete t[r];this.vertexCount=e.vertexCount,this.setIndexBuffer(e.indices||null),this.setAttributes(e.attributes,{disableWarnings:!0}),this.setAttributes(t,{disableWarnings:this.props.disableWarnings}),this.setNeedsRedraw("geometry attributes")}_setPipelineNeedsUpdate(e){this._pipelineNeedsUpdate||(this._pipelineNeedsUpdate=e),this.setNeedsRedraw(e)}_updatePipeline(){if(this._pipelineNeedsUpdate){let e=null,t=null;this.pipeline&&(Gt.log(1,`Model ${this.id}: Recreating pipeline because "${this._pipelineNeedsUpdate}".`)(),e=this.pipeline.vs,t=this.pipeline.fs),this._pipelineNeedsUpdate=!1;const r=this.shaderFactory.createShader({id:`${this.id}-vertex`,stage:"vertex",source:this.source||this.vs,debugShaders:this.props.debugShaders});let a=null;this.source?a=r:this.fs&&(a=this.shaderFactory.createShader({id:`${this.id}-fragment`,stage:"fragment",source:this.source||this.fs,debugShaders:this.props.debugShaders})),this.pipeline=this.pipelineFactory.createRenderPipeline({...this.props,bufferLayout:this.bufferLayout,topology:this.topology,parameters:this.parameters,bindings:this._getBindings(),vs:r,fs:a}),this._attributeInfos=cR(this.pipeline.shaderLayout,this.bufferLayout),e&&this.shaderFactory.release(e),t&&this.shaderFactory.release(t)}return this.pipeline}_logDrawCallStart(){const e=Gt.level>3?0:e9;Gt.level<2||Date.now()-this._lastLogTime<e||(this._lastLogTime=Date.now(),this._logOpen=!0,Gt.group(pu,`>>> DRAWING MODEL ${this.id}`,{collapsed:Gt.level<=2})())}_logDrawCallEnd(){if(this._logOpen){const e=Wj(this.pipeline.shaderLayout,this.id);Gt.table(pu,e)();const t=this.shaderInputs.getDebugTable();for(const[a,h]of Object.entries(this.uniforms))t[a]={value:h};Gt.table(pu,t)();const r=this._getAttributeDebugTable();Gt.table(pu,this._attributeInfos)(),Gt.table(pu,r)(),Gt.groupEnd(pu)(),this._logOpen=!1}}_logFramebuffer(e){const t=this.device.props.debugFramebuffers;if(this._drawCount++,!t)return;const r=e.props.framebuffer;r&&qj(r,{id:r.id,minimap:!0})}_getAttributeDebugTable(){const e={};for(const[t,r]of Object.entries(this._attributeInfos)){const a=this.vertexArray.attributes[r.location];e[r.location]={name:t,type:r.shaderType,values:a?this._getBufferOrConstantValues(a,r.bufferDataType):"null"}}if(this.vertexArray.indexBuffer){const{indexBuffer:t}=this.vertexArray,r=t.indexType==="uint32"?new Uint32Array(t.debugData):new Uint16Array(t.debugData);e.indices={name:"indices",type:t.indexType,values:r.toString()}}return e}_getBufferOrConstantValues(e,t){const r=dR(t);return(e instanceof Gr?new r(e.debugData):e).toString()}};pe(r0,"defaultProps",{...xd.defaultProps,source:void 0,vs:null,fs:null,id:"unnamed",handle:void 0,userData:{},defines:{},modules:[],moduleSettings:void 0,geometry:null,indexBuffer:null,attributes:{},constantAttributes:{},varyings:[],isInstanced:void 0,instanceCount:0,vertexCount:0,shaderInputs:void 0,pipelineFactory:void 0,shaderFactory:void 0,transformFeedback:void 0,shaderAssembler:_y.getDefaultShaderAssembler(),debugShaders:void 0,disableWarnings:void 0});let bm=r0;function t9(i){return!!(i.uniformTypes&&!ew(i.uniformTypes))}function i9(i){return{type:i.type,shaderLanguage:i.info.shadingLanguage,shaderLanguageVersion:i.info.shadingLanguageVersion,gpu:i.info.gpu,features:i.features}}function ew(i){for(const e in i)return!1;return!0}const am=class am{constructor(e,t=am.defaultProps){pe(this,"device");pe(this,"model");pe(this,"transformFeedback");if(!am.isSupported(e))throw new Error("BufferTransform not yet implemented on WebGPU");this.device=e,this.model=new bm(this.device,{id:t.id||"buffer-transform-model",fs:t.fs||zz(),topology:t.topology||"point-list",varyings:t.outputs||t.varyings,...t}),this.transformFeedback=this.device.createTransformFeedback({layout:this.model.pipeline.shaderLayout,buffers:t.feedbackBuffers}),this.model.setTransformFeedback(this.transformFeedback),Object.seal(this)}static isSupported(e){var t;return((t=e==null?void 0:e.info)==null?void 0:t.type)==="webgl"}destroy(){this.model&&this.model.destroy()}delete(){this.destroy()}run(e){e!=null&&e.inputBuffers&&this.model.setAttributes(e.inputBuffers),e!=null&&e.outputBuffers&&this.transformFeedback.setBuffers(e.outputBuffers);const t=this.device.beginRenderPass(e);this.model.draw(t),t.end()}getBuffer(e){return this.transformFeedback.getBuffer(e)}readAsync(e){const t=this.getBuffer(e);if(!t)throw new Error("BufferTransform#getBuffer");if(t instanceof Gr)return t.readAsync();const{buffer:r,byteOffset:a=0,byteLength:h=r.byteLength}=t;return r.readAsync(a,h)}};pe(am,"defaultProps",{...bm.defaultProps,outputs:void 0,feedbackBuffers:void 0});let wm=am;class r9{constructor(e){pe(this,"id");pe(this,"topology");pe(this,"vertexCount");pe(this,"indices");pe(this,"attributes");pe(this,"userData",{});const{attributes:t={},indices:r=null,vertexCount:a=null}=e;this.id=e.id||Nm("geometry"),this.topology=e.topology,r&&(this.indices=ArrayBuffer.isView(r)?{value:r,size:1}:r),this.attributes={};for(const[h,y]of Object.entries(t)){const s=ArrayBuffer.isView(y)?{value:y}:y;if(!ArrayBuffer.isView(s.value))throw new Error(`${this._print(h)}: must be typed array or object with value as typed array`);if((h==="POSITION"||h==="positions")&&!s.size&&(s.size=3),h==="indices"){if(this.indices)throw new Error("Multiple indices detected");this.indices=s}else this.attributes[h]=s}this.indices&&this.indices.isIndexed!==void 0&&(this.indices=Object.assign({},this.indices),delete this.indices.isIndexed),this.vertexCount=a||this._calculateVertexCount(this.attributes,this.indices)}getVertexCount(){return this.vertexCount}getAttributes(){return this.indices?{indices:this.indices,...this.attributes}:this.attributes}_print(e){return`Geometry ${this.id} attribute ${e}`}_setAttributes(e,t){return this}_calculateVertexCount(e,t){if(t)return t.value.length;let r=1/0;for(const a of Object.values(e)){const{value:h,size:y,constant:s}=a;!s&&h&&y!==void 0&&y>=1&&(r=Math.min(r,h.length/y))}return r}}class Fy{constructor(e={}){pe(this,"id");pe(this,"matrix",new qn);pe(this,"display",!0);pe(this,"position",new Wn);pe(this,"rotation",new Wn);pe(this,"scale",new Wn(1,1,1));pe(this,"userData",{});pe(this,"props",{});const{id:t}=e;this.id=t||Nm(this.constructor.name),this._setScenegraphNodeProps(e)}getBounds(){return null}destroy(){}delete(){this.destroy()}setProps(e){return this._setScenegraphNodeProps(e),this}toString(){return`{type: ScenegraphNode, id: ${this.id})}`}setPosition(e){return this.position=e,this}setRotation(e){return this.rotation=e,this}setScale(e){return this.scale=e,this}setMatrix(e,t=!0){t?this.matrix.copy(e):this.matrix=e}setMatrixComponents(e){const{position:t,rotation:r,scale:a,update:h=!0}=e;return t&&this.setPosition(t),r&&this.setRotation(r),a&&this.setScale(a),h&&this.updateMatrix(),this}updateMatrix(){const e=this.position,t=this.rotation,r=this.scale;return this.matrix.identity(),this.matrix.translate(e),this.matrix.rotateXYZ(t),this.matrix.scale(r),this}update(e={}){const{position:t,rotation:r,scale:a}=e;return t&&this.setPosition(t),r&&this.setRotation(r),a&&this.setScale(a),this.updateMatrix(),this}getCoordinateUniforms(e,t){t=t||this.matrix;const r=new qn(e).multiplyRight(t),a=r.invert(),h=a.transpose();return{viewMatrix:e,modelMatrix:t,objectMatrix:t,worldMatrix:r,worldInverseMatrix:a,worldInverseTransposeMatrix:h}}_setScenegraphNodeProps(e){"position"in e&&this.setPosition(e.position),"rotation"in e&&this.setRotation(e.rotation),"scale"in e&&this.setScale(e.scale),"matrix"in e&&this.setMatrix(e.matrix),Object.assign(this.props,e)}}class _d extends Fy{constructor(t={}){t=Array.isArray(t)?{children:t}:t;const{children:r=[]}=t;Gt.assert(r.every(a=>a instanceof Fy),"every child must an instance of ScenegraphNode");super(t);pe(this,"children");this.children=r}getBounds(){const t=[[1/0,1/0,1/0],[-1/0,-1/0,-1/0]];return this.traverse((r,{worldMatrix:a})=>{const h=r.getBounds();if(!h)return;const[y,s]=h,T=new Wn(y).add(s).divide([2,2,2]);a.transformAsPoint(T,T);const B=new Wn(s).subtract(y).divide([2,2,2]);a.transformAsVector(B,B);for(let F=0;F<8;F++){const V=new Wn(F&1?-1:1,F&2?-1:1,F&4?-1:1).multiply(B).add(T);for(let X=0;X<3;X++)t[0][X]=Math.min(t[0][X],V[X]),t[1][X]=Math.max(t[1][X],V[X])}}),Number.isFinite(t[0][0])?t:null}destroy(){this.children.forEach(t=>t.destroy()),this.removeAll(),super.destroy()}add(...t){for(const r of t)Array.isArray(r)?this.add(...r):this.children.push(r);return this}remove(t){const r=this.children,a=r.indexOf(t);return a>-1&&r.splice(a,1),this}removeAll(){return this.children=[],this}traverse(t,{worldMatrix:r=new qn}={}){const a=new qn(r).multiplyRight(this.matrix);for(const h of this.children)h instanceof _d?h.traverse(t,{worldMatrix:a}):t(h,{worldMatrix:a})}}class tw extends Fy{constructor(t){super(t);pe(this,"model");pe(this,"bounds",null);pe(this,"managedResources");this.model=t.model,this.managedResources=t.managedResources||[],this.bounds=t.bounds||null,this.setProps(t)}destroy(){this.model&&(this.model.destroy(),this.model=null),this.managedResources.forEach(t=>t.destroy()),this.managedResources=[]}getBounds(){return this.bounds}draw(t){return this.model.draw(t)}}const n9={blendColorOperation:"add",blendColorSrcFactor:"one",blendColorDstFactor:"zero",blendAlphaOperation:"add",blendAlphaSrcFactor:"constant-alpha",blendAlphaDstFactor:"zero"};class bP extends aA{constructor(){super(...arguments),this._colorEncoderState=null}render(e){return"pickingFBO"in e?this._drawPickingBuffer(e):super.render(e)}_drawPickingBuffer({layers:e,layerFilter:t,views:r,viewports:a,onViewportActive:h,pickingFBO:y,deviceRect:{x:s,y:T,width:B,height:F},cullRect:V,effects:X,pass:se="picking",pickZ:ne,shaderModuleProps:K}){this.pickZ=ne;const ue=this._resetColorEncoder(ne),_e=[s,T,B,F],ke=super.render({target:y,layers:e,layerFilter:t,views:r,viewports:a,onViewportActive:h,cullRect:V,effects:X==null?void 0:X.filter(ge=>ge.useInPicking),pass:se,isPicking:!0,shaderModuleProps:K,clearColor:[0,0,0,0],colorMask:15,scissorRect:_e});return this._colorEncoderState=null,{decodePickingColor:ue&&o9.bind(null,ue),stats:ke}}shouldDrawLayer(e){const{pickable:t,operation:r}=e.props;return t&&r.includes("draw")||r.includes("terrain")||r.includes("mask")}getShaderModuleProps(e,t,r){return{picking:{isActive:1,isAttribute:this.pickZ},lighting:{enabled:!1}}}getLayerParameters(e,t,r){const a={...e.props.parameters},{pickable:h,operation:y}=e.props;return!this._colorEncoderState||y.includes("terrain")?a.blend=!1:h&&y.includes("draw")&&(Object.assign(a,n9),a.blend=!0,a.blendColor=s9(this._colorEncoderState,e,r)),a}_resetColorEncoder(e){return this._colorEncoderState=e?null:{byLayer:new Map,byAlpha:[]},this._colorEncoderState}}function s9(i,e,t){const{byLayer:r,byAlpha:a}=i;let h,y=r.get(e);return y?(y.viewports.push(t),h=y.a):(h=r.size+1,h<=255?(y={a:h,layer:e,viewports:[t]},r.set(e,y),a[h]=y):(gr.warn("Too many pickable layers, only picking the first 255")(),h=0)),[0,0,0,h/255]}function o9(i,e){const t=i.byAlpha[e[3]];return t&&{pickedLayer:t.layer,pickedViewports:t.viewports,pickedObjectIndex:t.layer.decodePickingColor(e)}}const nd={NO_STATE:"Awaiting state",MATCHED:"Matched. State transferred from previous layer",INITIALIZED:"Initialized",AWAITING_GC:"Discarded. Awaiting garbage collection",AWAITING_FINALIZATION:"No longer matched. Awaiting garbage collection",FINALIZED:"Finalized! Awaiting garbage collection"},ky=Symbol.for("component"),Au=Symbol.for("propTypes"),nb=Symbol.for("deprecatedProps"),gd=Symbol.for("asyncPropDefaults"),Bu=Symbol.for("asyncPropOriginal"),nc=Symbol.for("asyncPropResolved");function Am(i,e=()=>!0){return Array.isArray(i)?wP(i,e,[]):e(i)?[i]:[]}function wP(i,e,t){let r=-1;for(;++r<i.length;){const a=i[r];Array.isArray(a)?wP(a,e,t):e(a)&&t.push(a)}return t}function a9({target:i,source:e,start:t=0,count:r=1}){const a=e.length,h=r*a;let y=0;for(let s=t;y<a;y++)i[s++]=e[y];for(;y<h;)y<h-y?(i.copyWithin(t+y,t,t+y),y*=2):(i.copyWithin(t+y,t,t+h-y),y=h);return i}class l9{constructor(e,t,r){this._loadCount=0,this._subscribers=new Set,this.id=e,this.context=r,this.setData(t)}subscribe(e){this._subscribers.add(e)}unsubscribe(e){this._subscribers.delete(e)}inUse(){return this._subscribers.size>0}delete(){}getData(){return this.isLoaded?this._error?Promise.reject(this._error):this._content:this._loader.then(()=>this.getData())}setData(e,t){if(e===this._data&&!t)return;this._data=e;const r=++this._loadCount;let a=e;typeof e=="string"&&(a=w1(e)),a instanceof Promise?(this.isLoaded=!1,this._loader=a.then(h=>{this._loadCount===r&&(this.isLoaded=!0,this._error=void 0,this._content=h)}).catch(h=>{this._loadCount===r&&(this.isLoaded=!0,this._error=h||!0)})):(this.isLoaded=!0,this._error=void 0,this._content=e);for(const h of this._subscribers)h.onChange(this.getData())}}class c9{constructor(e){var t;this.protocol=e.protocol||"resource://",this._context={device:e.device,gl:(t=e.device)==null?void 0:t.gl,resourceManager:this},this._resources={},this._consumers={},this._pruneRequest=null}contains(e){return e.startsWith(this.protocol)?!0:e in this._resources}add({resourceId:e,data:t,forceUpdate:r=!1,persistent:a=!0}){let h=this._resources[e];h?h.setData(t,r):(h=new l9(e,t,this._context),this._resources[e]=h),h.persistent=a}remove(e){const t=this._resources[e];t&&(t.delete(),delete this._resources[e])}unsubscribe({consumerId:e}){const t=this._consumers[e];if(t){for(const r in t){const a=t[r],h=this._resources[a.resourceId];h&&h.unsubscribe(a)}delete this._consumers[e],this.prune()}}subscribe({resourceId:e,onChange:t,consumerId:r,requestId:a="default"}){const{_resources:h,protocol:y}=this;e.startsWith(y)&&(e=e.replace(y,""),h[e]||this.add({resourceId:e,data:null,persistent:!1}));const s=h[e];if(this._track(r,a,s,t),s)return s.getData()}prune(){this._pruneRequest||(this._pruneRequest=setTimeout(()=>this._prune(),0))}finalize(){for(const e in this._resources)this._resources[e].delete()}_track(e,t,r,a){const h=this._consumers,y=h[e]=h[e]||{};let s=y[t];const T=s&&s.resourceId&&this._resources[s.resourceId];T&&(T.unsubscribe(s),this.prune()),r&&(s?(s.onChange=a,s.resourceId=r.id):s={onChange:a,resourceId:r.id},y[t]=s,r.subscribe(s))}_prune(){this._pruneRequest=null;for(const e of Object.keys(this._resources)){const t=this._resources[e];!t.persistent&&!t.inUse()&&(t.delete(),delete this._resources[e])}}}const u9="layerManager.setLayers",h9="layerManager.activateViewport";class d9{constructor(e,t){var s;this._lastRenderedLayers=[],this._needsRedraw=!1,this._needsUpdate=!1,this._nextLayers=null,this._debug=!1,this._defaultShaderModulesChanged=!1,this.activateViewport=T=>{bs(h9,this,T),T&&(this.context.viewport=T)};const{deck:r,stats:a,viewport:h,timeline:y}=t||{};this.layers=[],this.resourceManager=new c9({device:e,protocol:"deck://"}),this.context={mousePosition:null,userData:{},layerManager:this,device:e,gl:e==null?void 0:e.gl,deck:r,shaderAssembler:W8(((s=e==null?void 0:e.info)==null?void 0:s.shadingLanguage)||"glsl"),defaultShaderModules:[eV],renderPass:void 0,stats:a||new p0({id:"deck.gl"}),viewport:h||new Md({id:"DEFAULT-INITIAL-VIEWPORT"}),timeline:y||new gP,resourceManager:this.resourceManager,onError:void 0},Object.seal(this)}finalize(){this.resourceManager.finalize();for(const e of this.layers)this._finalizeLayer(e)}needsRedraw(e={clearRedrawFlags:!1}){let t=this._needsRedraw;e.clearRedrawFlags&&(this._needsRedraw=!1);for(const r of this.layers){const a=r.getNeedsRedraw(e);t=t||a}return t}needsUpdate(){return this._nextLayers&&this._nextLayers!==this._lastRenderedLayers?"layers changed":this._defaultShaderModulesChanged?"shader modules changed":this._needsUpdate}setNeedsRedraw(e){this._needsRedraw=this._needsRedraw||e}setNeedsUpdate(e){this._needsUpdate=this._needsUpdate||e}getLayers({layerIds:e}={}){return e?this.layers.filter(t=>e.find(r=>t.id.indexOf(r)===0)):this.layers}setProps(e){"debug"in e&&(this._debug=e.debug),"userData"in e&&(this.context.userData=e.userData),"layers"in e&&(this._nextLayers=e.layers),"onError"in e&&(this.context.onError=e.onError)}setLayers(e,t){bs(u9,this,t,e),this._lastRenderedLayers=e;const r=Am(e,Boolean);for(const a of r)a.context=this.context;this._updateLayers(this.layers,r)}updateLayers(){const e=this.needsUpdate();e&&(this.setNeedsRedraw(`updating layers: ${e}`),this.setLayers(this._nextLayers||this._lastRenderedLayers,e)),this._nextLayers=null}addDefaultShaderModule(e){const{defaultShaderModules:t}=this.context;t.find(r=>r.name===e.name)||(t.push(e),this._defaultShaderModulesChanged=!0)}removeDefaultShaderModule(e){const{defaultShaderModules:t}=this.context,r=t.findIndex(a=>a.name===e.name);r>=0&&(t.splice(r,1),this._defaultShaderModulesChanged=!0)}_handleError(e,t,r){r.raiseError(t,`${e} of ${r}`)}_updateLayers(e,t){const r={};for(const y of e)r[y.id]?gr.warn(`Multiple old layers with same id ${y.id}`)():r[y.id]=y;if(this._defaultShaderModulesChanged){for(const y of e)y.setNeedsUpdate(),y.setChangeFlags({extensionsChanged:!0});this._defaultShaderModulesChanged=!1}const a=[];this._updateSublayersRecursively(t,r,a),this._finalizeOldLayers(r);let h=!1;for(const y of a)if(y.hasUniformTransition()){h=`Uniform transition in ${y}`;break}this._needsUpdate=h,this.layers=a}_updateSublayersRecursively(e,t,r){for(const a of e){a.context=this.context;const h=t[a.id];h===null&&gr.warn(`Multiple new layers with same id ${a.id}`)(),t[a.id]=null;let y=null;try{this._debug&&h!==a&&a.validateProps(),h?(this._transferLayerState(h,a),this._updateLayer(a)):this._initializeLayer(a),r.push(a),y=a.isComposite?a.getSubLayers():null}catch(s){this._handleError("matching",s,a)}y&&this._updateSublayersRecursively(y,t,r)}}_finalizeOldLayers(e){for(const t in e){const r=e[t];r&&this._finalizeLayer(r)}}_initializeLayer(e){try{e._initialize(),e.lifecycle=nd.INITIALIZED}catch(t){this._handleError("initialization",t,e)}}_transferLayerState(e,t){t._transferState(e),t.lifecycle=nd.MATCHED,t!==e&&(e.lifecycle=nd.AWAITING_GC)}_updateLayer(e){try{e._update()}catch(t){this._handleError("update",t,e)}}_finalizeLayer(e){this._needsRedraw=this._needsRedraw||`finalized ${e}`,e.lifecycle=nd.AWAITING_FINALIZATION;try{e._finalize(),e.lifecycle=nd.FINALIZED}catch(t){this._handleError("finalization",t,e)}}}function Zo(i,e,t){if(i===e)return!0;if(!t||!i||!e)return!1;if(Array.isArray(i)){if(!Array.isArray(e)||i.length!==e.length)return!1;for(let r=0;r<i.length;r++)if(!Zo(i[r],e[r],t-1))return!1;return!0}if(Array.isArray(e))return!1;if(typeof i=="object"&&typeof e=="object"){const r=Object.keys(i),a=Object.keys(e);if(r.length!==a.length)return!1;for(const h of r)if(!e.hasOwnProperty(h)||!Zo(i[h],e[h],t-1))return!1;return!0}return!1}class f9{constructor(e){this.views=[],this.width=100,this.height=100,this.viewState={},this.controllers={},this.timeline=e.timeline,this._viewports=[],this._viewportMap={},this._isUpdating=!1,this._needsRedraw="First render",this._needsUpdate="Initialize",this._eventManager=e.eventManager,this._eventCallbacks={onViewStateChange:e.onViewStateChange,onInteractionStateChange:e.onInteractionStateChange},Object.seal(this),this.setProps(e)}finalize(){for(const e in this.controllers){const t=this.controllers[e];t&&t.finalize()}this.controllers={}}needsRedraw(e={clearRedrawFlags:!1}){const t=this._needsRedraw;return e.clearRedrawFlags&&(this._needsRedraw=!1),t}setNeedsUpdate(e){this._needsUpdate=this._needsUpdate||e,this._needsRedraw=this._needsRedraw||e}updateViewStates(){for(const e in this.controllers){const t=this.controllers[e];t&&t.updateTransition()}}getViewports(e){return e?this._viewports.filter(t=>t.containsPixel(e)):this._viewports}getViews(){const e={};return this.views.forEach(t=>{e[t.id]=t}),e}getView(e){return this.views.find(t=>t.id===e)}getViewState(e){const t=typeof e=="string"?this.getView(e):e,r=t&&this.viewState[t.getViewStateId()]||this.viewState;return t?t.filterViewState(r):r}getViewport(e){return this._viewportMap[e]}unproject(e,t){const r=this.getViewports(),a={x:e[0],y:e[1]};for(let h=r.length-1;h>=0;--h){const y=r[h];if(y.containsPixel(a)){const s=e.slice();return s[0]-=y.x,s[1]-=y.y,y.unproject(s,t)}}return null}setProps(e){e.views&&this._setViews(e.views),e.viewState&&this._setViewState(e.viewState),("width"in e||"height"in e)&&this._setSize(e.width,e.height),this._isUpdating||this._update()}_update(){this._isUpdating=!0,this._needsUpdate&&(this._needsUpdate=!1,this._rebuildViewports()),this._needsUpdate&&(this._needsUpdate=!1,this._rebuildViewports()),this._isUpdating=!1}_setSize(e,t){(e!==this.width||t!==this.height)&&(this.width=e,this.height=t,this.setNeedsUpdate("Size changed"))}_setViews(e){e=Am(e,Boolean),this._diffViews(e,this.views)&&this.setNeedsUpdate("views changed"),this.views=e}_setViewState(e){e?(!Zo(e,this.viewState,3)&&this.setNeedsUpdate("viewState changed"),this.viewState=e):gr.warn("missing `viewState` or `initialViewState`")()}_createController(e,t){const r=t.type;return new r({timeline:this.timeline,eventManager:this._eventManager,onViewStateChange:this._eventCallbacks.onViewStateChange,onStateChange:this._eventCallbacks.onInteractionStateChange,makeViewport:h=>{var y;return(y=this.getView(e.id))==null?void 0:y.makeViewport({viewState:h,width:this.width,height:this.height})}})}_updateController(e,t,r,a){const h=e.controller;if(h&&r){const y={...t,...h,id:e.id,x:r.x,y:r.y,width:r.width,height:r.height};return(!a||a.constructor!==h.type)&&(a=this._createController(e,y)),a&&a.setProps(y),a}return null}_rebuildViewports(){const{views:e}=this,t=this.controllers;this._viewports=[],this.controllers={};let r=!1;for(let a=e.length;a--;){const h=e[a],y=this.getViewState(h),s=h.makeViewport({viewState:y,width:this.width,height:this.height});let T=t[h.id];const B=!!h.controller;B&&!T&&(r=!0),(r||!B)&&T&&(T.finalize(),T=null),this.controllers[h.id]=this._updateController(h,y,s,T),s&&this._viewports.unshift(s)}for(const a in t){const h=t[a];h&&!this.controllers[a]&&h.finalize()}this._buildViewportMap()}_buildViewportMap(){this._viewportMap={},this._viewports.forEach(e=>{e.id&&(this._viewportMap[e.id]=this._viewportMap[e.id]||e)})}_diffViews(e,t){return e.length!==t.length?!0:e.some((r,a)=>!e[a].equals(t[a]))}}const p9=/([0-9]+\.?[0-9]*)(%|px)/;function ql(i){switch(typeof i){case"number":return{position:i,relative:!1};case"string":const e=p9.exec(i);if(e&&e.length>=3){const t=e[2]==="%",r=parseFloat(e[1]);return{position:t?r/100:r,relative:t}}default:throw new Error(`Could not parse position string ${i}`)}}function Xl(i,e){return i.relative?Math.round(i.position*e):i.position}class AP{constructor(e){const{id:t,x:r=0,y:a=0,width:h="100%",height:y="100%",padding:s=null}=e;this.id=t||this.constructor.displayName||"view",this.props={...e,id:this.id},this._x=ql(r),this._y=ql(a),this._width=ql(h),this._height=ql(y),this._padding=s&&{left:ql(s.left||0),right:ql(s.right||0),top:ql(s.top||0),bottom:ql(s.bottom||0)},this.equals=this.equals.bind(this),Object.seal(this)}equals(e){return this===e?!0:this.constructor===e.constructor&&Zo(this.props,e.props,2)}makeViewport({width:e,height:t,viewState:r}){r=this.filterViewState(r);const a=this.getDimensions({width:e,height:t});if(!a.height||!a.width)return null;const h=this.getViewportType(r);return new h({...r,...this.props,...a})}getViewStateId(){const{viewState:e}=this.props;return typeof e=="string"?e:(e==null?void 0:e.id)||this.id}filterViewState(e){if(this.props.viewState&&typeof this.props.viewState=="object"){if(!this.props.viewState.id)return this.props.viewState;const t={...e};for(const r in this.props.viewState)r!=="id"&&(t[r]=this.props.viewState[r]);return t}return e}getDimensions({width:e,height:t}){const r={x:Xl(this._x,e),y:Xl(this._y,t),width:Xl(this._width,e),height:Xl(this._height,t)};return this._padding&&(r.padding={left:Xl(this._padding.left,e),top:Xl(this._padding.top,t),right:Xl(this._padding.right,e),bottom:Xl(this._padding.bottom,t)}),r}get controller(){const e=this.props.controller;return e?e===!0?{type:this.ControllerType}:typeof e=="function"?{type:e}:{type:this.ControllerType,...e}:null}}class y0{constructor(e){this._inProgress=!1,this._handle=null,this.time=0,this.settings={duration:0},this._timeline=e}get inProgress(){return this._inProgress}start(e){var t,r;this.cancel(),this.settings=e,this._inProgress=!0,(r=(t=this.settings).onStart)==null||r.call(t,this)}end(){var e,t;this._inProgress&&(this._timeline.removeChannel(this._handle),this._handle=null,this._inProgress=!1,(t=(e=this.settings).onEnd)==null||t.call(e,this))}cancel(){var e,t;this._inProgress&&((t=(e=this.settings).onInterrupt)==null||t.call(e,this),this._timeline.removeChannel(this._handle),this._handle=null,this._inProgress=!1)}update(){var e,t;if(!this._inProgress)return!1;if(this._handle===null){const{_timeline:r,settings:a}=this;this._handle=r.addChannel({delay:r.getTime(),duration:a.duration})}return this.time=this._timeline.getTime(this._handle),this._onUpdate(),(t=(e=this.settings).onUpdate)==null||t.call(e,this),this._timeline.isFinished(this._handle)&&this.end(),!0}_onUpdate(){}}const $3=()=>{},iw={BREAK:1,SNAP_TO_END:2,IGNORE:3},m9=i=>i,_9=iw.BREAK;class g9{constructor(e){this._onTransitionUpdate=t=>{const{time:r,settings:{interpolator:a,startProps:h,endProps:y,duration:s,easing:T}}=t,B=T(r/s),F=a.interpolateProps(h,y,B);this.propsInTransition=this.getControllerState({...this.props,...F}).getViewportProps(),this.onViewStateChange({viewState:this.propsInTransition,oldViewState:this.props})},this.getControllerState=e.getControllerState,this.propsInTransition=null,this.transition=new y0(e.timeline),this.onViewStateChange=e.onViewStateChange||$3,this.onStateChange=e.onStateChange||$3}finalize(){this.transition.cancel()}getViewportInTransition(){return this.propsInTransition}processViewStateChange(e){let t=!1;const r=this.props;if(this.props=e,!r||this._shouldIgnoreViewportChange(r,e))return!1;if(this._isTransitionEnabled(e)){let a=r;if(this.transition.inProgress){const{interruption:h,endProps:y}=this.transition.settings;a={...r,...h===iw.SNAP_TO_END?y:this.propsInTransition||r}}this._triggerTransition(a,e),t=!0}else this.transition.cancel();return t}updateTransition(){this.transition.update()}_isTransitionEnabled(e){const{transitionDuration:t,transitionInterpolator:r}=e;return(t>0||t==="auto")&&!!r}_isUpdateDueToCurrentTransition(e){return this.transition.inProgress&&this.propsInTransition?this.transition.settings.interpolator.arePropsEqual(e,this.propsInTransition):!1}_shouldIgnoreViewportChange(e,t){return this.transition.inProgress?this.transition.settings.interruption===iw.IGNORE||this._isUpdateDueToCurrentTransition(t):this._isTransitionEnabled(t)?t.transitionInterpolator.arePropsEqual(e,t):!0}_triggerTransition(e,t){const r=this.getControllerState(e),a=this.getControllerState(t).shortestPathFrom(r),h=t.transitionInterpolator,y=h.getDuration?h.getDuration(e,t):t.transitionDuration;if(y===0)return;const s=h.initializeProps(e,a);this.propsInTransition={};const T={duration:y,easing:t.transitionEasing||m9,interpolator:h,interruption:t.transitionInterruption||_9,startProps:s.start,endProps:s.end,onStart:t.onTransitionStart,onUpdate:this._onTransitionUpdate,onInterrupt:this._onTransitionEnd(t.onTransitionInterrupt),onEnd:this._onTransitionEnd(t.onTransitionEnd)};this.transition.start(T),this.onStateChange({inTransition:!0}),this.updateTransition()}_onTransitionEnd(e){return t=>{this.propsInTransition=null,this.onStateChange({inTransition:!1,isZooming:!1,isPanning:!1,isRotating:!1}),e==null||e(t)}}}function In(i,e){if(!i)throw new Error(e||"deck.gl: assertion failed.")}class y9{constructor(e){const{compare:t,extract:r,required:a}=e;this._propsToCompare=t,this._propsToExtract=r||t,this._requiredProps=a}arePropsEqual(e,t){for(const r of this._propsToCompare)if(!(r in e)||!(r in t)||!_m(e[r],t[r]))return!1;return!0}initializeProps(e,t){const r={},a={};for(const h of this._propsToExtract)(h in e||h in t)&&(r[h]=e[h],a[h]=t[h]);return this._checkRequiredProps(r),this._checkRequiredProps(a),{start:r,end:a}}getDuration(e,t){return t.transitionDuration}_checkRequiredProps(e){this._requiredProps&&this._requiredProps.forEach(t=>{const r=e[t];In(Number.isFinite(r)||Array.isArray(r),`${t} is required for transition`)})}}const v9=["longitude","latitude","zoom","bearing","pitch"],x9=["longitude","latitude","zoom"];class cA extends y9{constructor(e={}){const t=Array.isArray(e)?e:e.transitionProps,r=Array.isArray(e)?{}:e;r.transitionProps=Array.isArray(t)?{compare:t,required:t}:t||{compare:v9,required:x9},super(r.transitionProps),this.opts=r}initializeProps(e,t){const r=super.initializeProps(e,t),{makeViewport:a,around:h}=this.opts;if(a&&h){const y=a(e),s=a(t),T=y.unproject(h);r.start.around=h,Object.assign(r.end,{around:s.project(T),aroundPosition:T,width:t.width,height:t.height})}return r}interpolateProps(e,t,r){const a={};for(const h of this._propsToExtract)a[h]=Cy(e[h]||0,t[h]||0,r);if(t.aroundPosition&&this.opts.makeViewport){const h=this.opts.makeViewport({...t,...a});Object.assign(a,h.panByPosition(t.aroundPosition,Cy(e.around,t.around,r)))}return a}}const Zl={transitionDuration:0},b9=300,Og=i=>1-(1-i)*(1-i),id={WHEEL:["wheel"],PAN:["panstart","panmove","panend"],PINCH:["pinchstart","pinchmove","pinchend"],MULTI_PAN:["multipanstart","multipanmove","multipanend"],DOUBLE_CLICK:["dblclick"],KEYBOARD:["keydown"]},mu={};class TP{constructor(e){this.state={},this._events={},this._interactionState={isDragging:!1},this._customEvents=[],this._eventStartBlocked=null,this._panMove=!1,this.invertPan=!1,this.dragMode="rotate",this.inertia=0,this.scrollZoom=!0,this.dragPan=!0,this.dragRotate=!0,this.doubleClickZoom=!0,this.touchZoom=!0,this.touchRotate=!1,this.keyboard=!0,this.transitionManager=new g9({...e,getControllerState:t=>new this.ControllerState(t),onViewStateChange:this._onTransition.bind(this),onStateChange:this._setInteractionState.bind(this)}),this.handleEvent=this.handleEvent.bind(this),this.eventManager=e.eventManager,this.onViewStateChange=e.onViewStateChange||(()=>{}),this.onStateChange=e.onStateChange||(()=>{}),this.makeViewport=e.makeViewport}set events(e){this.toggleEvents(this._customEvents,!1),this.toggleEvents(e,!0),this._customEvents=e,this.props&&this.setProps(this.props)}finalize(){var e;for(const t in this._events)this._events[t]&&((e=this.eventManager)==null||e.off(t,this.handleEvent));this.transitionManager.finalize()}handleEvent(e){this._controllerState=void 0;const t=this._eventStartBlocked;switch(e.type){case"panstart":return t?!1:this._onPanStart(e);case"panmove":return this._onPan(e);case"panend":return this._onPanEnd(e);case"pinchstart":return t?!1:this._onPinchStart(e);case"pinchmove":return this._onPinch(e);case"pinchend":return this._onPinchEnd(e);case"multipanstart":return t?!1:this._onMultiPanStart(e);case"multipanmove":return this._onMultiPan(e);case"multipanend":return this._onMultiPanEnd(e);case"dblclick":return this._onDoubleClick(e);case"wheel":return this._onWheel(e);case"keydown":return this._onKeyDown(e);default:return!1}}get controllerState(){return this._controllerState=this._controllerState||new this.ControllerState({makeViewport:this.makeViewport,...this.props,...this.state}),this._controllerState}getCenter(e){const{x:t,y:r}=this.props,{offsetCenter:a}=e;return[a.x-t,a.y-r]}isPointInBounds(e,t){const{width:r,height:a}=this.props;if(t&&t.handled)return!1;const h=e[0]>=0&&e[0]<=r&&e[1]>=0&&e[1]<=a;return h&&t&&t.stopPropagation(),h}isFunctionKeyPressed(e){const{srcEvent:t}=e;return!!(t.metaKey||t.altKey||t.ctrlKey||t.shiftKey)}isDragging(){return this._interactionState.isDragging||!1}blockEvents(e){const t=setTimeout(()=>{this._eventStartBlocked===t&&(this._eventStartBlocked=null)},e);this._eventStartBlocked=t}setProps(e){e.dragMode&&(this.dragMode=e.dragMode),this.props=e,"transitionInterpolator"in e||(e.transitionInterpolator=this._getTransitionProps().transitionInterpolator),this.transitionManager.processViewStateChange(e);const{inertia:t}=e;this.inertia=Number.isFinite(t)?t:t===!0?b9:0;const{scrollZoom:r=!0,dragPan:a=!0,dragRotate:h=!0,doubleClickZoom:y=!0,touchZoom:s=!0,touchRotate:T=!1,keyboard:B=!0}=e,F=!!this.onViewStateChange;this.toggleEvents(id.WHEEL,F&&r),this.toggleEvents(id.PAN,F),this.toggleEvents(id.PINCH,F&&(s||T)),this.toggleEvents(id.MULTI_PAN,F&&T),this.toggleEvents(id.DOUBLE_CLICK,F&&y),this.toggleEvents(id.KEYBOARD,F&&B),this.scrollZoom=r,this.dragPan=a,this.dragRotate=h,this.doubleClickZoom=y,this.touchZoom=s,this.touchRotate=T,this.keyboard=B}updateTransition(){this.transitionManager.updateTransition()}toggleEvents(e,t){this.eventManager&&e.forEach(r=>{this._events[r]!==t&&(this._events[r]=t,t?this.eventManager.on(r,this.handleEvent):this.eventManager.off(r,this.handleEvent))})}updateViewport(e,t=null,r={}){const a={...e.getViewportProps(),...t},h=this.controllerState!==e;if(this.state=e.getState(),this._setInteractionState(r),h){const y=this.controllerState&&this.controllerState.getViewportProps();this.onViewStateChange&&this.onViewStateChange({viewState:a,interactionState:this._interactionState,oldViewState:y,viewId:this.props.id})}}_onTransition(e){this.onViewStateChange({...e,interactionState:this._interactionState,viewId:this.props.id})}_setInteractionState(e){Object.assign(this._interactionState,e),this.onStateChange(this._interactionState)}_onPanStart(e){const t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;let r=this.isFunctionKeyPressed(e)||e.rightButton||!1;(this.invertPan||this.dragMode==="pan")&&(r=!r);const a=this.controllerState[r?"panStart":"rotateStart"]({pos:t});return this._panMove=r,this.updateViewport(a,Zl,{isDragging:!0}),!0}_onPan(e){return this.isDragging()?this._panMove?this._onPanMove(e):this._onPanRotate(e):!1}_onPanEnd(e){return this.isDragging()?this._panMove?this._onPanMoveEnd(e):this._onPanRotateEnd(e):!1}_onPanMove(e){if(!this.dragPan)return!1;const t=this.getCenter(e),r=this.controllerState.pan({pos:t});return this.updateViewport(r,Zl,{isDragging:!0,isPanning:!0}),!0}_onPanMoveEnd(e){const{inertia:t}=this;if(this.dragPan&&t&&e.velocity){const r=this.getCenter(e),a=[r[0]+e.velocityX*t/2,r[1]+e.velocityY*t/2],h=this.controllerState.pan({pos:a}).panEnd();this.updateViewport(h,{...this._getTransitionProps(),transitionDuration:t,transitionEasing:Og},{isDragging:!1,isPanning:!0})}else{const r=this.controllerState.panEnd();this.updateViewport(r,null,{isDragging:!1,isPanning:!1})}return!0}_onPanRotate(e){if(!this.dragRotate)return!1;const t=this.getCenter(e),r=this.controllerState.rotate({pos:t});return this.updateViewport(r,Zl,{isDragging:!0,isRotating:!0}),!0}_onPanRotateEnd(e){const{inertia:t}=this;if(this.dragRotate&&t&&e.velocity){const r=this.getCenter(e),a=[r[0]+e.velocityX*t/2,r[1]+e.velocityY*t/2],h=this.controllerState.rotate({pos:a}).rotateEnd();this.updateViewport(h,{...this._getTransitionProps(),transitionDuration:t,transitionEasing:Og},{isDragging:!1,isRotating:!0})}else{const r=this.controllerState.rotateEnd();this.updateViewport(r,null,{isDragging:!1,isRotating:!1})}return!0}_onWheel(e){if(!this.scrollZoom)return!1;const t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;e.srcEvent.preventDefault();const{speed:r=.01,smooth:a=!1}=this.scrollZoom===!0?{}:this.scrollZoom,{delta:h}=e;let y=2/(1+Math.exp(-Math.abs(h*r)));h<0&&y!==0&&(y=1/y);const s=this.controllerState.zoom({pos:t,scale:y});return this.updateViewport(s,{...this._getTransitionProps({around:t}),transitionDuration:a?250:1},{isZooming:!0,isPanning:!0}),!0}_onMultiPanStart(e){const t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;const r=this.controllerState.rotateStart({pos:t});return this.updateViewport(r,Zl,{isDragging:!0}),!0}_onMultiPan(e){if(!this.touchRotate||!this.isDragging())return!1;const t=this.getCenter(e);t[0]-=e.deltaX;const r=this.controllerState.rotate({pos:t});return this.updateViewport(r,Zl,{isDragging:!0,isRotating:!0}),!0}_onMultiPanEnd(e){if(!this.isDragging())return!1;const{inertia:t}=this;if(this.touchRotate&&t&&e.velocityY){const r=this.getCenter(e),a=[r[0],r[1]+=e.velocityY*t/2],h=this.controllerState.rotate({pos:a});this.updateViewport(h,{...this._getTransitionProps(),transitionDuration:t,transitionEasing:Og},{isDragging:!1,isRotating:!0}),this.blockEvents(t)}else{const r=this.controllerState.rotateEnd();this.updateViewport(r,null,{isDragging:!1,isRotating:!1})}return!0}_onPinchStart(e){const t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;const r=this.controllerState.zoomStart({pos:t}).rotateStart({pos:t});return mu._startPinchRotation=e.rotation,mu._lastPinchEvent=e,this.updateViewport(r,Zl,{isDragging:!0}),!0}_onPinch(e){if(!this.touchZoom&&!this.touchRotate||!this.isDragging())return!1;let t=this.controllerState;if(this.touchZoom){const{scale:r}=e,a=this.getCenter(e);t=t.zoom({pos:a,scale:r})}if(this.touchRotate){const{rotation:r}=e;t=t.rotate({deltaAngleX:mu._startPinchRotation-r})}return this.updateViewport(t,Zl,{isDragging:!0,isPanning:this.touchZoom,isZooming:this.touchZoom,isRotating:this.touchRotate}),mu._lastPinchEvent=e,!0}_onPinchEnd(e){if(!this.isDragging())return!1;const{inertia:t}=this,{_lastPinchEvent:r}=mu;if(this.touchZoom&&t&&r&&e.scale!==r.scale){const a=this.getCenter(e);let h=this.controllerState.rotateEnd();const y=Math.log2(e.scale),s=(y-Math.log2(r.scale))/(e.deltaTime-r.deltaTime),T=Math.pow(2,y+s*t/2);h=h.zoom({pos:a,scale:T}).zoomEnd(),this.updateViewport(h,{...this._getTransitionProps({around:a}),transitionDuration:t,transitionEasing:Og},{isDragging:!1,isPanning:this.touchZoom,isZooming:this.touchZoom,isRotating:!1}),this.blockEvents(t)}else{const a=this.controllerState.zoomEnd().rotateEnd();this.updateViewport(a,null,{isDragging:!1,isPanning:!1,isZooming:!1,isRotating:!1})}return mu._startPinchRotation=null,mu._lastPinchEvent=null,!0}_onDoubleClick(e){if(!this.doubleClickZoom)return!1;const t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;const r=this.isFunctionKeyPressed(e),a=this.controllerState.zoom({pos:t,scale:r?.5:2});return this.updateViewport(a,this._getTransitionProps({around:t}),{isZooming:!0,isPanning:!0}),this.blockEvents(100),!0}_onKeyDown(e){if(!this.keyboard)return!1;const t=this.isFunctionKeyPressed(e),{zoomSpeed:r,moveSpeed:a,rotateSpeedX:h,rotateSpeedY:y}=this.keyboard===!0?{}:this.keyboard,{controllerState:s}=this;let T;const B={};switch(e.srcEvent.code){case"Minus":T=t?s.zoomOut(r).zoomOut(r):s.zoomOut(r),B.isZooming=!0;break;case"Equal":T=t?s.zoomIn(r).zoomIn(r):s.zoomIn(r),B.isZooming=!0;break;case"ArrowLeft":t?(T=s.rotateLeft(h),B.isRotating=!0):(T=s.moveLeft(a),B.isPanning=!0);break;case"ArrowRight":t?(T=s.rotateRight(h),B.isRotating=!0):(T=s.moveRight(a),B.isPanning=!0);break;case"ArrowUp":t?(T=s.rotateUp(y),B.isRotating=!0):(T=s.moveUp(a),B.isPanning=!0);break;case"ArrowDown":t?(T=s.rotateDown(y),B.isRotating=!0):(T=s.moveDown(a),B.isPanning=!0);break;default:return!1}return this.updateViewport(T,this._getTransitionProps(),B),!0}_getTransitionProps(e){const{transition:t}=this;return!t||!t.transitionInterpolator?Zl:e?{...t,transitionInterpolator:new cA({...e,...t.transitionInterpolator.opts,makeViewport:this.controllerState.makeViewport})}:t}}class w9{constructor(e,t){this._viewportProps=this.applyConstraints(e),this._state=t}getViewportProps(){return this._viewportProps}getState(){return this._state}}const W3=5,A9=1.2;class EP extends w9{constructor(e){const{width:t,height:r,latitude:a,longitude:h,zoom:y,bearing:s=0,pitch:T=0,altitude:B=1.5,position:F=[0,0,0],maxZoom:V=20,minZoom:X=0,maxPitch:se=60,minPitch:ne=0,startPanLngLat:K,startZoomLngLat:ue,startRotatePos:_e,startBearing:ke,startPitch:we,startZoom:ge,normalize:Le=!0}=e;In(Number.isFinite(h)),In(Number.isFinite(a)),In(Number.isFinite(y)),super({width:t,height:r,latitude:a,longitude:h,zoom:y,bearing:s,pitch:T,altitude:B,maxZoom:V,minZoom:X,maxPitch:se,minPitch:ne,normalize:Le,position:F},{startPanLngLat:K,startZoomLngLat:ue,startRotatePos:_e,startBearing:ke,startPitch:we,startZoom:ge}),this.makeViewport=e.makeViewport}panStart({pos:e}){return this._getUpdatedState({startPanLngLat:this._unproject(e)})}pan({pos:e,startPos:t}){const r=this.getState().startPanLngLat||this._unproject(t);if(!r)return this;const h=this.makeViewport(this.getViewportProps()).panByPosition(r,e);return this._getUpdatedState(h)}panEnd(){return this._getUpdatedState({startPanLngLat:null})}rotateStart({pos:e}){return this._getUpdatedState({startRotatePos:e,startBearing:this.getViewportProps().bearing,startPitch:this.getViewportProps().pitch})}rotate({pos:e,deltaAngleX:t=0,deltaAngleY:r=0}){const{startRotatePos:a,startBearing:h,startPitch:y}=this.getState();if(!a||h===void 0||y===void 0)return this;let s;return e?s=this._getNewRotation(e,a,y,h):s={bearing:h+t,pitch:y+r},this._getUpdatedState(s)}rotateEnd(){return this._getUpdatedState({startBearing:null,startPitch:null})}zoomStart({pos:e}){return this._getUpdatedState({startZoomLngLat:this._unproject(e),startZoom:this.getViewportProps().zoom})}zoom({pos:e,startPos:t,scale:r}){let{startZoom:a,startZoomLngLat:h}=this.getState();if(h||(a=this.getViewportProps().zoom,h=this._unproject(t)||this._unproject(e)),!h)return this;const{maxZoom:y,minZoom:s}=this.getViewportProps();let T=a+Math.log2(r);T=ba(T,s,y);const B=this.makeViewport({...this.getViewportProps(),zoom:T});return this._getUpdatedState({zoom:T,...B.panByPosition(h,e)})}zoomEnd(){return this._getUpdatedState({startZoomLngLat:null,startZoom:null})}zoomIn(e=2){return this._zoomFromCenter(e)}zoomOut(e=2){return this._zoomFromCenter(1/e)}moveLeft(e=100){return this._panFromCenter([e,0])}moveRight(e=100){return this._panFromCenter([-e,0])}moveUp(e=100){return this._panFromCenter([0,e])}moveDown(e=100){return this._panFromCenter([0,-e])}rotateLeft(e=15){return this._getUpdatedState({bearing:this.getViewportProps().bearing-e})}rotateRight(e=15){return this._getUpdatedState({bearing:this.getViewportProps().bearing+e})}rotateUp(e=10){return this._getUpdatedState({pitch:this.getViewportProps().pitch+e})}rotateDown(e=10){return this._getUpdatedState({pitch:this.getViewportProps().pitch-e})}shortestPathFrom(e){const t=e.getViewportProps(),r={...this.getViewportProps()},{bearing:a,longitude:h}=r;return Math.abs(a-t.bearing)>180&&(r.bearing=a<0?a+360:a-360),Math.abs(h-t.longitude)>180&&(r.longitude=h<0?h+360:h-360),r}applyConstraints(e){const{maxZoom:t,minZoom:r,zoom:a}=e;e.zoom=ba(a,r,t);const{maxPitch:h,minPitch:y,pitch:s}=e;e.pitch=ba(s,y,h);const{normalize:T=!0}=e;return T&&Object.assign(e,M8(e)),e}_zoomFromCenter(e){const{width:t,height:r}=this.getViewportProps();return this.zoom({pos:[t/2,r/2],scale:e})}_panFromCenter(e){const{width:t,height:r}=this.getViewportProps();return this.pan({startPos:[t/2,r/2],pos:[t/2+e[0],r/2+e[1]]})}_getUpdatedState(e){return new this.constructor({makeViewport:this.makeViewport,...this.getViewportProps(),...this.getState(),...e})}_unproject(e){const t=this.makeViewport(this.getViewportProps());return e&&t.unproject(e)}_getNewRotation(e,t,r,a){const h=e[0]-t[0],y=e[1]-t[1],s=e[1],T=t[1],{width:B,height:F}=this.getViewportProps(),V=h/B;let X=0;y>0?Math.abs(F-T)>W3&&(X=y/(T-F)*A9):y<0&&T>W3&&(X=1-s/T),X=ba(X,-1,1);const{minPitch:se,maxPitch:ne}=this.getViewportProps(),K=a+180*V;let ue=r;return X>0?ue=r+X*(ne-r):X<0&&(ue=r-X*(se-r)),{pitch:ue,bearing:K}}}class T9 extends TP{constructor(){super(...arguments),this.ControllerState=EP,this.transition={transitionDuration:300,transitionInterpolator:new cA({transitionProps:{compare:["longitude","latitude","zoom","bearing","pitch","position"],required:["longitude","latitude","zoom"]}})},this.dragMode="pan"}setProps(e){e.position=e.position||[0,0,0];const t=this.props;super.setProps(e),(!t||t.height!==e.height)&&this.updateViewport(new this.ControllerState({makeViewport:this.makeViewport,...e,...this.state}))}}class uA extends AP{constructor(e={}){super(e)}getViewportType(){return Ru}get ControllerType(){return T9}}uA.displayName="MapView";const E9=new lA;function S9(i,e){const t=i.order??1/0,r=e.order??1/0;return t-r}class I9{constructor(e){this._resolvedEffects=[],this._defaultEffects=[],this.effects=[],this._context=e,this._needsRedraw="Initial render",this._setEffects([])}addDefaultEffect(e){const t=this._defaultEffects;if(!t.find(r=>r.id===e.id)){const r=t.findIndex(a=>S9(a,e)>0);r<0?t.push(e):t.splice(r,0,e),e.setup(this._context),this._setEffects(this.effects)}}setProps(e){"effects"in e&&(Zo(e.effects,this.effects,1)||this._setEffects(e.effects))}needsRedraw(e={clearRedrawFlags:!1}){const t=this._needsRedraw;return e.clearRedrawFlags&&(this._needsRedraw=!1),t}getEffects(){return this._resolvedEffects}_setEffects(e){const t={};for(const a of this.effects)t[a.id]=a;const r=[];for(const a of e){const h=t[a.id];let y=a;h&&h!==a?h.setProps?(h.setProps(a.props),y=h):h.cleanup(this._context):h||a.setup(this._context),r.push(y),delete t[a.id]}for(const a in t)t[a].cleanup(this._context);this.effects=r,this._resolvedEffects=r.concat(this._defaultEffects),e.some(a=>a instanceof lA)||this._resolvedEffects.push(E9),this._needsRedraw="effects changed"}finalize(){for(const e of this._resolvedEffects)e.cleanup(this._context);this.effects.length=0,this._resolvedEffects.length=0,this._defaultEffects.length=0}}class C9 extends aA{shouldDrawLayer(e){const{operation:t}=e.props;return t.includes("draw")||t.includes("terrain")}}const M9="deckRenderer.renderLayers";class R9{constructor(e){this.device=e,this.layerFilter=null,this.drawPickingColors=!1,this.drawLayersPass=new C9(e),this.pickLayersPass=new bP(e),this.renderCount=0,this._needsRedraw="Initial render",this.renderBuffers=[],this.lastPostProcessEffect=null}setProps(e){this.layerFilter!==e.layerFilter&&(this.layerFilter=e.layerFilter,this._needsRedraw="layerFilter changed"),this.drawPickingColors!==e.drawPickingColors&&(this.drawPickingColors=e.drawPickingColors,this._needsRedraw="drawPickingColors changed")}renderLayers(e){if(!e.viewports.length)return;const t=this.drawPickingColors?this.pickLayersPass:this.drawLayersPass,r={layerFilter:this.layerFilter,isPicking:this.drawPickingColors,...e};r.effects&&this._preRender(r.effects,r);const a=this.lastPostProcessEffect?this.renderBuffers[0]:r.target;this.lastPostProcessEffect&&(r.clearColor=[0,0,0,0],r.clearCanvas=!0);const h=t.render({...r,target:a});r.effects&&this._postRender(r.effects,r),this.renderCount++,bs(M9,this,h,e)}needsRedraw(e={clearRedrawFlags:!1}){const t=this._needsRedraw;return e.clearRedrawFlags&&(this._needsRedraw=!1),t}finalize(){const{renderBuffers:e}=this;for(const t of e)t.delete();e.length=0}_preRender(e,t){this.lastPostProcessEffect=null,t.preRenderStats=t.preRenderStats||{};for(const r of e)t.preRenderStats[r.id]=r.preRender(t),r.postRender&&(this.lastPostProcessEffect=r.id);this.lastPostProcessEffect&&this._resizeRenderBuffers()}_resizeRenderBuffers(){const{renderBuffers:e}=this,t=this.device.canvasContext.getDrawingBufferSize();e.length===0&&[0,1].map(r=>{const a=this.device.createTexture({sampler:{minFilter:"linear",magFilter:"linear"}});e.push(this.device.createFramebuffer({id:`deck-renderbuffer-${r}`,colorAttachments:[a]}))});for(const r of e)r.resize(t)}_postRender(e,t){const{renderBuffers:r}=this,a={...t,inputBuffer:r[0],swapBuffer:r[1]};for(const h of e)if(h.postRender){a.target=h.id===this.lastPostProcessEffect?t.target:void 0;const y=h.postRender(a);a.inputBuffer=y,a.swapBuffer=y===r[0]?r[1]:r[0]}}}const P9={pickedColor:null,pickedObjectIndex:-1};function B9({pickedColors:i,decodePickingColor:e,deviceX:t,deviceY:r,deviceRadius:a,deviceRect:h}){const{x:y,y:s,width:T,height:B}=h;let F=a*a,V=-1,X=0;for(let se=0;se<B;se++){const ne=se+s-r,K=ne*ne;if(K>F)X+=4*T;else for(let ue=0;ue<T;ue++){if(i[X+3]-1>=0){const ke=ue+y-t,we=ke*ke+K;we<=F&&(F=we,V=X)}X+=4}}if(V>=0){const se=i.slice(V,V+4),ne=e(se);if(ne){const K=Math.floor(V/4/T),ue=V/4-K*T;return{...ne,pickedColor:se,pickedX:y+ue,pickedY:s+K}}gr.error("Picked non-existent layer. Is picking buffer corrupt?")()}return P9}function D9({pickedColors:i,decodePickingColor:e}){const t=new Map;if(i){for(let r=0;r<i.length;r+=4)if(i[r+3]-1>=0){const h=i.slice(r,r+4),y=h.join(",");if(!t.has(y)){const s=e(h);s?t.set(y,{...s,color:h}):gr.error("Picked non-existent layer. Is picking buffer corrupt?")()}}}return Array.from(t.values())}function SP({pickInfo:i,viewports:e,pixelRatio:t,x:r,y:a,z:h}){let y=e[0];e.length>1&&(y=F9((i==null?void 0:i.pickedViewports)||e,{x:r,y:a}));let s;if(y){const T=[r-y.x,a-y.y];h!==void 0&&(T[2]=h),s=y.unproject(T)}return{color:null,layer:null,viewport:y,index:-1,picked:!1,x:r,y:a,pixel:[r,a],coordinate:s,devicePixel:i&&"pickedX"in i?[i.pickedX,i.pickedY]:void 0,pixelRatio:t}}function O9(i){const{pickInfo:e,lastPickedInfo:t,mode:r,layers:a}=i,{pickedColor:h,pickedLayer:y,pickedObjectIndex:s}=e,T=y?[y]:[];if(r==="hover"){const V=t.index,X=t.layerId,se=y?y.props.id:null;if(se!==X||s!==V){if(se!==X){const ne=a.find(K=>K.props.id===X);ne&&T.unshift(ne)}t.layerId=se,t.index=s,t.info=null}}const B=SP(i),F=new Map;return F.set(null,B),T.forEach(V=>{let X={...B};V===y&&(X.color=h,X.index=s,X.picked=!0),X=IP({layer:V,info:X,mode:r});const se=X.layer;V===y&&r==="hover"&&(t.info=X),F.set(se.id,X),r==="hover"&&se.updateAutoHighlight(X)}),F}function IP({layer:i,info:e,mode:t}){for(;i&&e;){const r=e.layer||null;e.sourceLayer=r,e.layer=i,e=i.getPickingInfo({info:e,mode:t,sourceLayer:r}),i=i.parent}return e}function F9(i,e){for(let t=i.length-1;t>=0;t--){const r=i[t];if(r.containsPixel(e))return r}return i[0]}class k9{constructor(e){this._pickable=!0,this.device=e,this.pickLayersPass=new bP(e),this.lastPickedInfo={index:-1,layerId:null,info:null}}setProps(e){"layerFilter"in e&&(this.layerFilter=e.layerFilter),"_pickable"in e&&(this._pickable=e._pickable)}finalize(){this.pickingFBO&&this.pickingFBO.destroy(),this.depthFBO&&this.depthFBO.destroy()}pickObject(e){return this._pickClosestObject(e)}pickObjects(e){return this._pickVisibleObjects(e)}getLastPickedObject({x:e,y:t,layers:r,viewports:a},h=this.lastPickedInfo.info){const y=h&&h.layer&&h.layer.id,s=h&&h.viewport&&h.viewport.id,T=y?r.find(X=>X.id===y):null,B=s&&a.find(X=>X.id===s)||a[0],F=B&&B.unproject([e-B.x,t-B.y]);return{...h,...{x:e,y:t,viewport:B,coordinate:F,layer:T}}}_resizeBuffer(){var t,r;if(!this.pickingFBO&&(this.pickingFBO=this.device.createFramebuffer({colorAttachments:["rgba8unorm"],depthStencilAttachment:"depth16unorm"}),this.device.isTextureFormatRenderable("rgba32float"))){const a=this.device.createFramebuffer({colorAttachments:["rgba32float"],depthStencilAttachment:"depth16unorm"});this.depthFBO=a}const{canvas:e}=this.device.getDefaultCanvasContext();(t=this.pickingFBO)==null||t.resize({width:e.width,height:e.height}),(r=this.depthFBO)==null||r.resize({width:e.width,height:e.height})}_getPickable(e){if(this._pickable===!1)return null;const t=e.filter(r=>this.pickLayersPass.shouldDrawLayer(r)&&!r.isComposite);return t.length?t:null}_pickClosestObject({layers:e,views:t,viewports:r,x:a,y:h,radius:y=0,depth:s=1,mode:T="query",unproject3D:B,onViewportActive:F,effects:V}){const X=this.device.canvasContext.cssToDeviceRatio(),se=this._getPickable(e);if(!se||r.length===0)return{result:[],emptyInfo:SP({viewports:r,x:a,y:h,pixelRatio:X})};this._resizeBuffer();const ne=this.device.canvasContext.cssToDevicePixels([a,h],!0),K=[ne.x+Math.floor(ne.width/2),ne.y+Math.floor(ne.height/2)],ue=Math.round(y*X),{width:_e,height:ke}=this.pickingFBO,we=this._getPickingRect({deviceX:K[0],deviceY:K[1],deviceRadius:ue,deviceWidth:_e,deviceHeight:ke}),ge={x:a-y,y:h-y,width:y*2+1,height:y*2+1};let Le;const $e=[],Ye=new Set;for(let St=0;St<s;St++){let Pt;if(we){const yt=this._drawAndSample({layers:se,views:t,viewports:r,onViewportActive:F,deviceRect:we,cullRect:ge,effects:V,pass:`picking:${T}`});Pt=B9({...yt,deviceX:K[0],deviceY:K[1],deviceRadius:ue,deviceRect:we})}else Pt={pickedColor:null,pickedObjectIndex:-1};let vt;if(Pt.pickedLayer&&B&&this.depthFBO){const{pickedColors:yt}=this._drawAndSample({layers:[Pt.pickedLayer],views:t,viewports:r,onViewportActive:F,deviceRect:{x:Pt.pickedX,y:Pt.pickedY,width:1,height:1},cullRect:ge,effects:V,pass:`picking:${T}:z`},!0);yt[3]&&(vt=yt[0])}Pt.pickedLayer&&St+1<s&&(Ye.add(Pt.pickedLayer),Pt.pickedLayer.disablePickingIndex(Pt.pickedObjectIndex)),Le=O9({pickInfo:Pt,lastPickedInfo:this.lastPickedInfo,mode:T,layers:se,viewports:r,x:a,y:h,z:vt,pixelRatio:X});for(const yt of Le.values())yt.layer&&$e.push(yt);if(!Pt.pickedColor)break}for(const St of Ye)St.restorePickingColors();return{result:$e,emptyInfo:Le.get(null)}}_pickVisibleObjects({layers:e,views:t,viewports:r,x:a,y:h,width:y=1,height:s=1,mode:T="query",maxObjects:B=null,onViewportActive:F,effects:V}){const X=this._getPickable(e);if(!X||r.length===0)return[];this._resizeBuffer();const se=this.device.canvasContext.cssToDeviceRatio(),ne=this.device.canvasContext.cssToDevicePixels([a,h],!0),K=ne.x,ue=ne.y+ne.height,_e=this.device.canvasContext.cssToDevicePixels([a+y,h+s],!0),ke=_e.x+_e.width,we=_e.y,ge={x:K,y:we,width:ke-K,height:ue-we},Le=this._drawAndSample({layers:X,views:t,viewports:r,onViewportActive:F,deviceRect:ge,cullRect:{x:a,y:h,width:y,height:s},effects:V,pass:`picking:${T}`}),$e=D9(Le),Ye=new Map,St=[],Pt=Number.isFinite(B);for(let vt=0;vt<$e.length&&!(Pt&&St.length>=B);vt++){const yt=$e[vt];let hi={color:yt.pickedColor,layer:null,index:yt.pickedObjectIndex,picked:!0,x:a,y:h,pixelRatio:se};hi=IP({layer:yt.pickedLayer,info:hi,mode:T});const Pi=hi.layer.id;Ye.has(Pi)||Ye.set(Pi,new Set);const Si=Ye.get(Pi),qt=hi.object??hi.index;Si.has(qt)||(Si.add(qt),St.push(hi))}return St}_drawAndSample({layers:e,views:t,viewports:r,onViewportActive:a,deviceRect:h,cullRect:y,effects:s,pass:T},B=!1){const F=B?this.depthFBO:this.pickingFBO,V={layers:e,layerFilter:this.layerFilter,views:t,viewports:r,onViewportActive:a,pickingFBO:F,deviceRect:h,cullRect:y,effects:s,pass:T,pickZ:B,preRenderStats:{},isPicking:!0};for(const ke of s)ke.useInPicking&&(V.preRenderStats[ke.id]=ke.preRender(V));const{decodePickingColor:X}=this.pickLayersPass.render(V),{x:se,y:ne,width:K,height:ue}=h,_e=new(B?Float32Array:Uint8Array)(K*ue*4);return this.device.readPixelsToArrayWebGL(F,{sourceX:se,sourceY:ne,sourceWidth:K,sourceHeight:ue,target:_e}),{pickedColors:_e,decodePickingColor:X}}_getPickingRect({deviceX:e,deviceY:t,deviceRadius:r,deviceWidth:a,deviceHeight:h}){const y=Math.max(0,e-r),s=Math.max(0,t-r),T=Math.min(a,e+r+1)-y,B=Math.min(h,t+r+1)-s;return T<=0||B<=0?null:{x:y,y:s,width:T,height:B}}}const L9={"top-left":{top:0,left:0},"top-right":{top:0,right:0},"bottom-left":{bottom:0,left:0},"bottom-right":{bottom:0,right:0},fill:{top:0,left:0,bottom:0,right:0}},N9="top-left",q3="__root";class z9{constructor({deck:e,parentElement:t}){this.defaultWidgets=[],this.widgets=[],this.resolvedWidgets=[],this.containers={},this.lastViewports={},this.deck=e,this.parentElement=t}getWidgets(){return this.resolvedWidgets}setProps(e){e.widgets&&!Zo(e.widgets,this.widgets,1)&&this._setWidgets(e.widgets)}finalize(){for(const e of this.getWidgets())this._remove(e);this.defaultWidgets.length=0,this.resolvedWidgets.length=0;for(const e in this.containers)this.containers[e].remove()}addDefault(e){this.defaultWidgets.find(t=>t.id===e.id)||(this._add(e),this.defaultWidgets.push(e),this._setWidgets(this.widgets))}_setWidgets(e){const t={};for(const r of this.resolvedWidgets)t[r.id]=r;this.resolvedWidgets.length=0;for(const r of this.defaultWidgets)t[r.id]=null,this.resolvedWidgets.push(r);for(let r of e){const a=t[r.id];a?a.viewId!==r.viewId||a.placement!==r.placement?(this._remove(a),this._add(r)):r!==a&&(a.setProps(r.props),r=a):this._add(r),t[r.id]=null,this.resolvedWidgets.push(r)}for(const r in t){const a=t[r];a&&this._remove(a)}this.widgets=e}_add(e){const{viewId:t=null,placement:r=N9}=e,a=e.onAdd({deck:this.deck,viewId:t});a&&this._getContainer(t,r).append(a),e._element=a}_remove(e){var t;(t=e.onRemove)==null||t.call(e),e._element&&e._element.remove(),e._element=void 0}_getContainer(e,t){var y;const r=e||q3;let a=this.containers[r];a||(a=document.createElement("div"),a.style.pointerEvents="none",a.style.position="absolute",a.style.overflow="hidden",(y=this.parentElement)==null||y.append(a),this.containers[r]=a);let h=a.querySelector(`.${t}`);return h||(h=document.createElement("div"),h.className=t,h.style.position="absolute",h.style.zIndex="2",Object.assign(h.style,L9[t]),a.append(h)),h}_updateContainers(){const e=this.deck.width,t=this.deck.height;for(const r in this.containers){const a=this.lastViewports[r]||null,h=r===q3||a,y=this.containers[r];h?(y.style.display="block",y.style.left=`${a?a.x:0}px`,y.style.top=`${a?a.y:0}px`,y.style.width=`${a?a.width:e}px`,y.style.height=`${a?a.height:t}px`):y.style.display="none"}}onRedraw({viewports:e,layers:t}){var a,h;const r=e.reduce((y,s)=>(y[s.id]=s,y),{});for(const y of this.getWidgets()){const{viewId:s}=y;if(s){const T=r[s];T&&(y.onViewportChange&&y.onViewportChange(T),(a=y.onRedraw)==null||a.call(y,{viewports:[T],layers:t}))}else{if(y.onViewportChange)for(const T of e)y.onViewportChange(T);(h=y.onRedraw)==null||h.call(y,{viewports:e,layers:t})}}this.lastViewports=r,this._updateContainers()}onHover(e,t){var r,a;for(const h of this.getWidgets()){const{viewId:y}=h;(!y||y===((r=e.viewport)==null?void 0:r.id))&&((a=h.onHover)==null||a.call(h,e,t))}}onEvent(e,t){var a,h;const r=W1[t.type];if(r)for(const y of this.getWidgets()){const{viewId:s}=y;(!s||s===((a=e.viewport)==null?void 0:a.id))&&((h=y[r])==null||h.call(y,e,t))}}}const U9={zIndex:"1",position:"absolute",pointerEvents:"none",color:"#a0a7b4",backgroundColor:"#29323c",padding:"10px",top:"0",left:"0",display:"none"};class V9{constructor(){this.id="default-tooltip",this.placement="fill",this.props={},this.isVisible=!1}onAdd({deck:e}){const t=document.createElement("div");return t.className="deck-tooltip",Object.assign(t.style,U9),this.deck=e,this.element=t,t}onRemove(){this.deck=void 0,this.element=void 0}setProps(){}onViewportChange(e){var t;this.isVisible&&e.id===((t=this.lastViewport)==null?void 0:t.id)&&e!==this.lastViewport&&this.setTooltip(null)}onHover(e){const{deck:t}=this,r=t&&t.props.getTooltip;if(!r)return;const a=r(e);this.lastViewport=e.viewport,this.setTooltip(a,e.x,e.y)}setTooltip(e,t,r){const a=this.element;if(a){if(typeof e=="string")a.innerText=e;else if(e)e.text&&(a.innerText=e.text),e.html&&(a.innerHTML=e.html),e.className&&(a.className=e.className);else{this.isVisible=!1,a.style.display="none";return}this.isVisible=!0,a.style.display="block",a.style.transform=`translate(${t}px, ${r}px)`,e&&typeof e=="object"&&"style"in e&&Object.assign(a.style,e.style)}}}var ad;(function(i){i[i.DEPTH_BUFFER_BIT=256]="DEPTH_BUFFER_BIT",i[i.STENCIL_BUFFER_BIT=1024]="STENCIL_BUFFER_BIT",i[i.COLOR_BUFFER_BIT=16384]="COLOR_BUFFER_BIT",i[i.POINTS=0]="POINTS",i[i.LINES=1]="LINES",i[i.LINE_LOOP=2]="LINE_LOOP",i[i.LINE_STRIP=3]="LINE_STRIP",i[i.TRIANGLES=4]="TRIANGLES",i[i.TRIANGLE_STRIP=5]="TRIANGLE_STRIP",i[i.TRIANGLE_FAN=6]="TRIANGLE_FAN",i[i.ZERO=0]="ZERO",i[i.ONE=1]="ONE",i[i.SRC_COLOR=768]="SRC_COLOR",i[i.ONE_MINUS_SRC_COLOR=769]="ONE_MINUS_SRC_COLOR",i[i.SRC_ALPHA=770]="SRC_ALPHA",i[i.ONE_MINUS_SRC_ALPHA=771]="ONE_MINUS_SRC_ALPHA",i[i.DST_ALPHA=772]="DST_ALPHA",i[i.ONE_MINUS_DST_ALPHA=773]="ONE_MINUS_DST_ALPHA",i[i.DST_COLOR=774]="DST_COLOR",i[i.ONE_MINUS_DST_COLOR=775]="ONE_MINUS_DST_COLOR",i[i.SRC_ALPHA_SATURATE=776]="SRC_ALPHA_SATURATE",i[i.CONSTANT_COLOR=32769]="CONSTANT_COLOR",i[i.ONE_MINUS_CONSTANT_COLOR=32770]="ONE_MINUS_CONSTANT_COLOR",i[i.CONSTANT_ALPHA=32771]="CONSTANT_ALPHA",i[i.ONE_MINUS_CONSTANT_ALPHA=32772]="ONE_MINUS_CONSTANT_ALPHA",i[i.FUNC_ADD=32774]="FUNC_ADD",i[i.FUNC_SUBTRACT=32778]="FUNC_SUBTRACT",i[i.FUNC_REVERSE_SUBTRACT=32779]="FUNC_REVERSE_SUBTRACT",i[i.BLEND_EQUATION=32777]="BLEND_EQUATION",i[i.BLEND_EQUATION_RGB=32777]="BLEND_EQUATION_RGB",i[i.BLEND_EQUATION_ALPHA=34877]="BLEND_EQUATION_ALPHA",i[i.BLEND_DST_RGB=32968]="BLEND_DST_RGB",i[i.BLEND_SRC_RGB=32969]="BLEND_SRC_RGB",i[i.BLEND_DST_ALPHA=32970]="BLEND_DST_ALPHA",i[i.BLEND_SRC_ALPHA=32971]="BLEND_SRC_ALPHA",i[i.BLEND_COLOR=32773]="BLEND_COLOR",i[i.ARRAY_BUFFER_BINDING=34964]="ARRAY_BUFFER_BINDING",i[i.ELEMENT_ARRAY_BUFFER_BINDING=34965]="ELEMENT_ARRAY_BUFFER_BINDING",i[i.LINE_WIDTH=2849]="LINE_WIDTH",i[i.ALIASED_POINT_SIZE_RANGE=33901]="ALIASED_POINT_SIZE_RANGE",i[i.ALIASED_LINE_WIDTH_RANGE=33902]="ALIASED_LINE_WIDTH_RANGE",i[i.CULL_FACE_MODE=2885]="CULL_FACE_MODE",i[i.FRONT_FACE=2886]="FRONT_FACE",i[i.DEPTH_RANGE=2928]="DEPTH_RANGE",i[i.DEPTH_WRITEMASK=2930]="DEPTH_WRITEMASK",i[i.DEPTH_CLEAR_VALUE=2931]="DEPTH_CLEAR_VALUE",i[i.DEPTH_FUNC=2932]="DEPTH_FUNC",i[i.STENCIL_CLEAR_VALUE=2961]="STENCIL_CLEAR_VALUE",i[i.STENCIL_FUNC=2962]="STENCIL_FUNC",i[i.STENCIL_FAIL=2964]="STENCIL_FAIL",i[i.STENCIL_PASS_DEPTH_FAIL=2965]="STENCIL_PASS_DEPTH_FAIL",i[i.STENCIL_PASS_DEPTH_PASS=2966]="STENCIL_PASS_DEPTH_PASS",i[i.STENCIL_REF=2967]="STENCIL_REF",i[i.STENCIL_VALUE_MASK=2963]="STENCIL_VALUE_MASK",i[i.STENCIL_WRITEMASK=2968]="STENCIL_WRITEMASK",i[i.STENCIL_BACK_FUNC=34816]="STENCIL_BACK_FUNC",i[i.STENCIL_BACK_FAIL=34817]="STENCIL_BACK_FAIL",i[i.STENCIL_BACK_PASS_DEPTH_FAIL=34818]="STENCIL_BACK_PASS_DEPTH_FAIL",i[i.STENCIL_BACK_PASS_DEPTH_PASS=34819]="STENCIL_BACK_PASS_DEPTH_PASS",i[i.STENCIL_BACK_REF=36003]="STENCIL_BACK_REF",i[i.STENCIL_BACK_VALUE_MASK=36004]="STENCIL_BACK_VALUE_MASK",i[i.STENCIL_BACK_WRITEMASK=36005]="STENCIL_BACK_WRITEMASK",i[i.VIEWPORT=2978]="VIEWPORT",i[i.SCISSOR_BOX=3088]="SCISSOR_BOX",i[i.COLOR_CLEAR_VALUE=3106]="COLOR_CLEAR_VALUE",i[i.COLOR_WRITEMASK=3107]="COLOR_WRITEMASK",i[i.UNPACK_ALIGNMENT=3317]="UNPACK_ALIGNMENT",i[i.PACK_ALIGNMENT=3333]="PACK_ALIGNMENT",i[i.MAX_TEXTURE_SIZE=3379]="MAX_TEXTURE_SIZE",i[i.MAX_VIEWPORT_DIMS=3386]="MAX_VIEWPORT_DIMS",i[i.SUBPIXEL_BITS=3408]="SUBPIXEL_BITS",i[i.RED_BITS=3410]="RED_BITS",i[i.GREEN_BITS=3411]="GREEN_BITS",i[i.BLUE_BITS=3412]="BLUE_BITS",i[i.ALPHA_BITS=3413]="ALPHA_BITS",i[i.DEPTH_BITS=3414]="DEPTH_BITS",i[i.STENCIL_BITS=3415]="STENCIL_BITS",i[i.POLYGON_OFFSET_UNITS=10752]="POLYGON_OFFSET_UNITS",i[i.POLYGON_OFFSET_FACTOR=32824]="POLYGON_OFFSET_FACTOR",i[i.TEXTURE_BINDING_2D=32873]="TEXTURE_BINDING_2D",i[i.SAMPLE_BUFFERS=32936]="SAMPLE_BUFFERS",i[i.SAMPLES=32937]="SAMPLES",i[i.SAMPLE_COVERAGE_VALUE=32938]="SAMPLE_COVERAGE_VALUE",i[i.SAMPLE_COVERAGE_INVERT=32939]="SAMPLE_COVERAGE_INVERT",i[i.COMPRESSED_TEXTURE_FORMATS=34467]="COMPRESSED_TEXTURE_FORMATS",i[i.VENDOR=7936]="VENDOR",i[i.RENDERER=7937]="RENDERER",i[i.VERSION=7938]="VERSION",i[i.IMPLEMENTATION_COLOR_READ_TYPE=35738]="IMPLEMENTATION_COLOR_READ_TYPE",i[i.IMPLEMENTATION_COLOR_READ_FORMAT=35739]="IMPLEMENTATION_COLOR_READ_FORMAT",i[i.BROWSER_DEFAULT_WEBGL=37444]="BROWSER_DEFAULT_WEBGL",i[i.STATIC_DRAW=35044]="STATIC_DRAW",i[i.STREAM_DRAW=35040]="STREAM_DRAW",i[i.DYNAMIC_DRAW=35048]="DYNAMIC_DRAW",i[i.ARRAY_BUFFER=34962]="ARRAY_BUFFER",i[i.ELEMENT_ARRAY_BUFFER=34963]="ELEMENT_ARRAY_BUFFER",i[i.BUFFER_SIZE=34660]="BUFFER_SIZE",i[i.BUFFER_USAGE=34661]="BUFFER_USAGE",i[i.CURRENT_VERTEX_ATTRIB=34342]="CURRENT_VERTEX_ATTRIB",i[i.VERTEX_ATTRIB_ARRAY_ENABLED=34338]="VERTEX_ATTRIB_ARRAY_ENABLED",i[i.VERTEX_ATTRIB_ARRAY_SIZE=34339]="VERTEX_ATTRIB_ARRAY_SIZE",i[i.VERTEX_ATTRIB_ARRAY_STRIDE=34340]="VERTEX_ATTRIB_ARRAY_STRIDE",i[i.VERTEX_ATTRIB_ARRAY_TYPE=34341]="VERTEX_ATTRIB_ARRAY_TYPE",i[i.VERTEX_ATTRIB_ARRAY_NORMALIZED=34922]="VERTEX_ATTRIB_ARRAY_NORMALIZED",i[i.VERTEX_ATTRIB_ARRAY_POINTER=34373]="VERTEX_ATTRIB_ARRAY_POINTER",i[i.VERTEX_ATTRIB_ARRAY_BUFFER_BINDING=34975]="VERTEX_ATTRIB_ARRAY_BUFFER_BINDING",i[i.CULL_FACE=2884]="CULL_FACE",i[i.FRONT=1028]="FRONT",i[i.BACK=1029]="BACK",i[i.FRONT_AND_BACK=1032]="FRONT_AND_BACK",i[i.BLEND=3042]="BLEND",i[i.DEPTH_TEST=2929]="DEPTH_TEST",i[i.DITHER=3024]="DITHER",i[i.POLYGON_OFFSET_FILL=32823]="POLYGON_OFFSET_FILL",i[i.SAMPLE_ALPHA_TO_COVERAGE=32926]="SAMPLE_ALPHA_TO_COVERAGE",i[i.SAMPLE_COVERAGE=32928]="SAMPLE_COVERAGE",i[i.SCISSOR_TEST=3089]="SCISSOR_TEST",i[i.STENCIL_TEST=2960]="STENCIL_TEST",i[i.NO_ERROR=0]="NO_ERROR",i[i.INVALID_ENUM=1280]="INVALID_ENUM",i[i.INVALID_VALUE=1281]="INVALID_VALUE",i[i.INVALID_OPERATION=1282]="INVALID_OPERATION",i[i.OUT_OF_MEMORY=1285]="OUT_OF_MEMORY",i[i.CONTEXT_LOST_WEBGL=37442]="CONTEXT_LOST_WEBGL",i[i.CW=2304]="CW",i[i.CCW=2305]="CCW",i[i.DONT_CARE=4352]="DONT_CARE",i[i.FASTEST=4353]="FASTEST",i[i.NICEST=4354]="NICEST",i[i.GENERATE_MIPMAP_HINT=33170]="GENERATE_MIPMAP_HINT",i[i.BYTE=5120]="BYTE",i[i.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",i[i.SHORT=5122]="SHORT",i[i.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",i[i.INT=5124]="INT",i[i.UNSIGNED_INT=5125]="UNSIGNED_INT",i[i.FLOAT=5126]="FLOAT",i[i.DOUBLE=5130]="DOUBLE",i[i.DEPTH_COMPONENT=6402]="DEPTH_COMPONENT",i[i.ALPHA=6406]="ALPHA",i[i.RGB=6407]="RGB",i[i.RGBA=6408]="RGBA",i[i.LUMINANCE=6409]="LUMINANCE",i[i.LUMINANCE_ALPHA=6410]="LUMINANCE_ALPHA",i[i.UNSIGNED_SHORT_4_4_4_4=32819]="UNSIGNED_SHORT_4_4_4_4",i[i.UNSIGNED_SHORT_5_5_5_1=32820]="UNSIGNED_SHORT_5_5_5_1",i[i.UNSIGNED_SHORT_5_6_5=33635]="UNSIGNED_SHORT_5_6_5",i[i.FRAGMENT_SHADER=35632]="FRAGMENT_SHADER",i[i.VERTEX_SHADER=35633]="VERTEX_SHADER",i[i.COMPILE_STATUS=35713]="COMPILE_STATUS",i[i.DELETE_STATUS=35712]="DELETE_STATUS",i[i.LINK_STATUS=35714]="LINK_STATUS",i[i.VALIDATE_STATUS=35715]="VALIDATE_STATUS",i[i.ATTACHED_SHADERS=35717]="ATTACHED_SHADERS",i[i.ACTIVE_ATTRIBUTES=35721]="ACTIVE_ATTRIBUTES",i[i.ACTIVE_UNIFORMS=35718]="ACTIVE_UNIFORMS",i[i.MAX_VERTEX_ATTRIBS=34921]="MAX_VERTEX_ATTRIBS",i[i.MAX_VERTEX_UNIFORM_VECTORS=36347]="MAX_VERTEX_UNIFORM_VECTORS",i[i.MAX_VARYING_VECTORS=36348]="MAX_VARYING_VECTORS",i[i.MAX_COMBINED_TEXTURE_IMAGE_UNITS=35661]="MAX_COMBINED_TEXTURE_IMAGE_UNITS",i[i.MAX_VERTEX_TEXTURE_IMAGE_UNITS=35660]="MAX_VERTEX_TEXTURE_IMAGE_UNITS",i[i.MAX_TEXTURE_IMAGE_UNITS=34930]="MAX_TEXTURE_IMAGE_UNITS",i[i.MAX_FRAGMENT_UNIFORM_VECTORS=36349]="MAX_FRAGMENT_UNIFORM_VECTORS",i[i.SHADER_TYPE=35663]="SHADER_TYPE",i[i.SHADING_LANGUAGE_VERSION=35724]="SHADING_LANGUAGE_VERSION",i[i.CURRENT_PROGRAM=35725]="CURRENT_PROGRAM",i[i.NEVER=512]="NEVER",i[i.LESS=513]="LESS",i[i.EQUAL=514]="EQUAL",i[i.LEQUAL=515]="LEQUAL",i[i.GREATER=516]="GREATER",i[i.NOTEQUAL=517]="NOTEQUAL",i[i.GEQUAL=518]="GEQUAL",i[i.ALWAYS=519]="ALWAYS",i[i.KEEP=7680]="KEEP",i[i.REPLACE=7681]="REPLACE",i[i.INCR=7682]="INCR",i[i.DECR=7683]="DECR",i[i.INVERT=5386]="INVERT",i[i.INCR_WRAP=34055]="INCR_WRAP",i[i.DECR_WRAP=34056]="DECR_WRAP",i[i.NEAREST=9728]="NEAREST",i[i.LINEAR=9729]="LINEAR",i[i.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",i[i.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",i[i.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",i[i.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR",i[i.TEXTURE_MAG_FILTER=10240]="TEXTURE_MAG_FILTER",i[i.TEXTURE_MIN_FILTER=10241]="TEXTURE_MIN_FILTER",i[i.TEXTURE_WRAP_S=10242]="TEXTURE_WRAP_S",i[i.TEXTURE_WRAP_T=10243]="TEXTURE_WRAP_T",i[i.TEXTURE_2D=3553]="TEXTURE_2D",i[i.TEXTURE=5890]="TEXTURE",i[i.TEXTURE_CUBE_MAP=34067]="TEXTURE_CUBE_MAP",i[i.TEXTURE_BINDING_CUBE_MAP=34068]="TEXTURE_BINDING_CUBE_MAP",i[i.TEXTURE_CUBE_MAP_POSITIVE_X=34069]="TEXTURE_CUBE_MAP_POSITIVE_X",i[i.TEXTURE_CUBE_MAP_NEGATIVE_X=34070]="TEXTURE_CUBE_MAP_NEGATIVE_X",i[i.TEXTURE_CUBE_MAP_POSITIVE_Y=34071]="TEXTURE_CUBE_MAP_POSITIVE_Y",i[i.TEXTURE_CUBE_MAP_NEGATIVE_Y=34072]="TEXTURE_CUBE_MAP_NEGATIVE_Y",i[i.TEXTURE_CUBE_MAP_POSITIVE_Z=34073]="TEXTURE_CUBE_MAP_POSITIVE_Z",i[i.TEXTURE_CUBE_MAP_NEGATIVE_Z=34074]="TEXTURE_CUBE_MAP_NEGATIVE_Z",i[i.MAX_CUBE_MAP_TEXTURE_SIZE=34076]="MAX_CUBE_MAP_TEXTURE_SIZE",i[i.TEXTURE0=33984]="TEXTURE0",i[i.ACTIVE_TEXTURE=34016]="ACTIVE_TEXTURE",i[i.REPEAT=10497]="REPEAT",i[i.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",i[i.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT",i[i.TEXTURE_WIDTH=4096]="TEXTURE_WIDTH",i[i.TEXTURE_HEIGHT=4097]="TEXTURE_HEIGHT",i[i.FLOAT_VEC2=35664]="FLOAT_VEC2",i[i.FLOAT_VEC3=35665]="FLOAT_VEC3",i[i.FLOAT_VEC4=35666]="FLOAT_VEC4",i[i.INT_VEC2=35667]="INT_VEC2",i[i.INT_VEC3=35668]="INT_VEC3",i[i.INT_VEC4=35669]="INT_VEC4",i[i.BOOL=35670]="BOOL",i[i.BOOL_VEC2=35671]="BOOL_VEC2",i[i.BOOL_VEC3=35672]="BOOL_VEC3",i[i.BOOL_VEC4=35673]="BOOL_VEC4",i[i.FLOAT_MAT2=35674]="FLOAT_MAT2",i[i.FLOAT_MAT3=35675]="FLOAT_MAT3",i[i.FLOAT_MAT4=35676]="FLOAT_MAT4",i[i.SAMPLER_2D=35678]="SAMPLER_2D",i[i.SAMPLER_CUBE=35680]="SAMPLER_CUBE",i[i.LOW_FLOAT=36336]="LOW_FLOAT",i[i.MEDIUM_FLOAT=36337]="MEDIUM_FLOAT",i[i.HIGH_FLOAT=36338]="HIGH_FLOAT",i[i.LOW_INT=36339]="LOW_INT",i[i.MEDIUM_INT=36340]="MEDIUM_INT",i[i.HIGH_INT=36341]="HIGH_INT",i[i.FRAMEBUFFER=36160]="FRAMEBUFFER",i[i.RENDERBUFFER=36161]="RENDERBUFFER",i[i.RGBA4=32854]="RGBA4",i[i.RGB5_A1=32855]="RGB5_A1",i[i.RGB565=36194]="RGB565",i[i.DEPTH_COMPONENT16=33189]="DEPTH_COMPONENT16",i[i.STENCIL_INDEX=6401]="STENCIL_INDEX",i[i.STENCIL_INDEX8=36168]="STENCIL_INDEX8",i[i.DEPTH_STENCIL=34041]="DEPTH_STENCIL",i[i.RENDERBUFFER_WIDTH=36162]="RENDERBUFFER_WIDTH",i[i.RENDERBUFFER_HEIGHT=36163]="RENDERBUFFER_HEIGHT",i[i.RENDERBUFFER_INTERNAL_FORMAT=36164]="RENDERBUFFER_INTERNAL_FORMAT",i[i.RENDERBUFFER_RED_SIZE=36176]="RENDERBUFFER_RED_SIZE",i[i.RENDERBUFFER_GREEN_SIZE=36177]="RENDERBUFFER_GREEN_SIZE",i[i.RENDERBUFFER_BLUE_SIZE=36178]="RENDERBUFFER_BLUE_SIZE",i[i.RENDERBUFFER_ALPHA_SIZE=36179]="RENDERBUFFER_ALPHA_SIZE",i[i.RENDERBUFFER_DEPTH_SIZE=36180]="RENDERBUFFER_DEPTH_SIZE",i[i.RENDERBUFFER_STENCIL_SIZE=36181]="RENDERBUFFER_STENCIL_SIZE",i[i.FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE=36048]="FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE",i[i.FRAMEBUFFER_ATTACHMENT_OBJECT_NAME=36049]="FRAMEBUFFER_ATTACHMENT_OBJECT_NAME",i[i.FRAMEBUFFER_ATTACHMENT_TEXTURE_LEVEL=36050]="FRAMEBUFFER_ATTACHMENT_TEXTURE_LEVEL",i[i.FRAMEBUFFER_ATTACHMENT_TEXTURE_CUBE_MAP_FACE=36051]="FRAMEBUFFER_ATTACHMENT_TEXTURE_CUBE_MAP_FACE",i[i.COLOR_ATTACHMENT0=36064]="COLOR_ATTACHMENT0",i[i.DEPTH_ATTACHMENT=36096]="DEPTH_ATTACHMENT",i[i.STENCIL_ATTACHMENT=36128]="STENCIL_ATTACHMENT",i[i.DEPTH_STENCIL_ATTACHMENT=33306]="DEPTH_STENCIL_ATTACHMENT",i[i.NONE=0]="NONE",i[i.FRAMEBUFFER_COMPLETE=36053]="FRAMEBUFFER_COMPLETE",i[i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT=36054]="FRAMEBUFFER_INCOMPLETE_ATTACHMENT",i[i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT=36055]="FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT",i[i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS=36057]="FRAMEBUFFER_INCOMPLETE_DIMENSIONS",i[i.FRAMEBUFFER_UNSUPPORTED=36061]="FRAMEBUFFER_UNSUPPORTED",i[i.FRAMEBUFFER_BINDING=36006]="FRAMEBUFFER_BINDING",i[i.RENDERBUFFER_BINDING=36007]="RENDERBUFFER_BINDING",i[i.READ_FRAMEBUFFER=36008]="READ_FRAMEBUFFER",i[i.DRAW_FRAMEBUFFER=36009]="DRAW_FRAMEBUFFER",i[i.MAX_RENDERBUFFER_SIZE=34024]="MAX_RENDERBUFFER_SIZE",i[i.INVALID_FRAMEBUFFER_OPERATION=1286]="INVALID_FRAMEBUFFER_OPERATION",i[i.UNPACK_FLIP_Y_WEBGL=37440]="UNPACK_FLIP_Y_WEBGL",i[i.UNPACK_PREMULTIPLY_ALPHA_WEBGL=37441]="UNPACK_PREMULTIPLY_ALPHA_WEBGL",i[i.UNPACK_COLORSPACE_CONVERSION_WEBGL=37443]="UNPACK_COLORSPACE_CONVERSION_WEBGL",i[i.READ_BUFFER=3074]="READ_BUFFER",i[i.UNPACK_ROW_LENGTH=3314]="UNPACK_ROW_LENGTH",i[i.UNPACK_SKIP_ROWS=3315]="UNPACK_SKIP_ROWS",i[i.UNPACK_SKIP_PIXELS=3316]="UNPACK_SKIP_PIXELS",i[i.PACK_ROW_LENGTH=3330]="PACK_ROW_LENGTH",i[i.PACK_SKIP_ROWS=3331]="PACK_SKIP_ROWS",i[i.PACK_SKIP_PIXELS=3332]="PACK_SKIP_PIXELS",i[i.TEXTURE_BINDING_3D=32874]="TEXTURE_BINDING_3D",i[i.UNPACK_SKIP_IMAGES=32877]="UNPACK_SKIP_IMAGES",i[i.UNPACK_IMAGE_HEIGHT=32878]="UNPACK_IMAGE_HEIGHT",i[i.MAX_3D_TEXTURE_SIZE=32883]="MAX_3D_TEXTURE_SIZE",i[i.MAX_ELEMENTS_VERTICES=33e3]="MAX_ELEMENTS_VERTICES",i[i.MAX_ELEMENTS_INDICES=33001]="MAX_ELEMENTS_INDICES",i[i.MAX_TEXTURE_LOD_BIAS=34045]="MAX_TEXTURE_LOD_BIAS",i[i.MAX_FRAGMENT_UNIFORM_COMPONENTS=35657]="MAX_FRAGMENT_UNIFORM_COMPONENTS",i[i.MAX_VERTEX_UNIFORM_COMPONENTS=35658]="MAX_VERTEX_UNIFORM_COMPONENTS",i[i.MAX_ARRAY_TEXTURE_LAYERS=35071]="MAX_ARRAY_TEXTURE_LAYERS",i[i.MIN_PROGRAM_TEXEL_OFFSET=35076]="MIN_PROGRAM_TEXEL_OFFSET",i[i.MAX_PROGRAM_TEXEL_OFFSET=35077]="MAX_PROGRAM_TEXEL_OFFSET",i[i.MAX_VARYING_COMPONENTS=35659]="MAX_VARYING_COMPONENTS",i[i.FRAGMENT_SHADER_DERIVATIVE_HINT=35723]="FRAGMENT_SHADER_DERIVATIVE_HINT",i[i.RASTERIZER_DISCARD=35977]="RASTERIZER_DISCARD",i[i.VERTEX_ARRAY_BINDING=34229]="VERTEX_ARRAY_BINDING",i[i.MAX_VERTEX_OUTPUT_COMPONENTS=37154]="MAX_VERTEX_OUTPUT_COMPONENTS",i[i.MAX_FRAGMENT_INPUT_COMPONENTS=37157]="MAX_FRAGMENT_INPUT_COMPONENTS",i[i.MAX_SERVER_WAIT_TIMEOUT=37137]="MAX_SERVER_WAIT_TIMEOUT",i[i.MAX_ELEMENT_INDEX=36203]="MAX_ELEMENT_INDEX",i[i.RED=6403]="RED",i[i.RGB8=32849]="RGB8",i[i.RGBA8=32856]="RGBA8",i[i.RGB10_A2=32857]="RGB10_A2",i[i.TEXTURE_3D=32879]="TEXTURE_3D",i[i.TEXTURE_WRAP_R=32882]="TEXTURE_WRAP_R",i[i.TEXTURE_MIN_LOD=33082]="TEXTURE_MIN_LOD",i[i.TEXTURE_MAX_LOD=33083]="TEXTURE_MAX_LOD",i[i.TEXTURE_BASE_LEVEL=33084]="TEXTURE_BASE_LEVEL",i[i.TEXTURE_MAX_LEVEL=33085]="TEXTURE_MAX_LEVEL",i[i.TEXTURE_COMPARE_MODE=34892]="TEXTURE_COMPARE_MODE",i[i.TEXTURE_COMPARE_FUNC=34893]="TEXTURE_COMPARE_FUNC",i[i.SRGB=35904]="SRGB",i[i.SRGB8=35905]="SRGB8",i[i.SRGB8_ALPHA8=35907]="SRGB8_ALPHA8",i[i.COMPARE_REF_TO_TEXTURE=34894]="COMPARE_REF_TO_TEXTURE",i[i.RGBA32F=34836]="RGBA32F",i[i.RGB32F=34837]="RGB32F",i[i.RGBA16F=34842]="RGBA16F",i[i.RGB16F=34843]="RGB16F",i[i.TEXTURE_2D_ARRAY=35866]="TEXTURE_2D_ARRAY",i[i.TEXTURE_BINDING_2D_ARRAY=35869]="TEXTURE_BINDING_2D_ARRAY",i[i.R11F_G11F_B10F=35898]="R11F_G11F_B10F",i[i.RGB9_E5=35901]="RGB9_E5",i[i.RGBA32UI=36208]="RGBA32UI",i[i.RGB32UI=36209]="RGB32UI",i[i.RGBA16UI=36214]="RGBA16UI",i[i.RGB16UI=36215]="RGB16UI",i[i.RGBA8UI=36220]="RGBA8UI",i[i.RGB8UI=36221]="RGB8UI",i[i.RGBA32I=36226]="RGBA32I",i[i.RGB32I=36227]="RGB32I",i[i.RGBA16I=36232]="RGBA16I",i[i.RGB16I=36233]="RGB16I",i[i.RGBA8I=36238]="RGBA8I",i[i.RGB8I=36239]="RGB8I",i[i.RED_INTEGER=36244]="RED_INTEGER",i[i.RGB_INTEGER=36248]="RGB_INTEGER",i[i.RGBA_INTEGER=36249]="RGBA_INTEGER",i[i.R8=33321]="R8",i[i.RG8=33323]="RG8",i[i.R16F=33325]="R16F",i[i.R32F=33326]="R32F",i[i.RG16F=33327]="RG16F",i[i.RG32F=33328]="RG32F",i[i.R8I=33329]="R8I",i[i.R8UI=33330]="R8UI",i[i.R16I=33331]="R16I",i[i.R16UI=33332]="R16UI",i[i.R32I=33333]="R32I",i[i.R32UI=33334]="R32UI",i[i.RG8I=33335]="RG8I",i[i.RG8UI=33336]="RG8UI",i[i.RG16I=33337]="RG16I",i[i.RG16UI=33338]="RG16UI",i[i.RG32I=33339]="RG32I",i[i.RG32UI=33340]="RG32UI",i[i.R8_SNORM=36756]="R8_SNORM",i[i.RG8_SNORM=36757]="RG8_SNORM",i[i.RGB8_SNORM=36758]="RGB8_SNORM",i[i.RGBA8_SNORM=36759]="RGBA8_SNORM",i[i.RGB10_A2UI=36975]="RGB10_A2UI",i[i.TEXTURE_IMMUTABLE_FORMAT=37167]="TEXTURE_IMMUTABLE_FORMAT",i[i.TEXTURE_IMMUTABLE_LEVELS=33503]="TEXTURE_IMMUTABLE_LEVELS",i[i.UNSIGNED_INT_2_10_10_10_REV=33640]="UNSIGNED_INT_2_10_10_10_REV",i[i.UNSIGNED_INT_10F_11F_11F_REV=35899]="UNSIGNED_INT_10F_11F_11F_REV",i[i.UNSIGNED_INT_5_9_9_9_REV=35902]="UNSIGNED_INT_5_9_9_9_REV",i[i.FLOAT_32_UNSIGNED_INT_24_8_REV=36269]="FLOAT_32_UNSIGNED_INT_24_8_REV",i[i.UNSIGNED_INT_24_8=34042]="UNSIGNED_INT_24_8",i[i.HALF_FLOAT=5131]="HALF_FLOAT",i[i.RG=33319]="RG",i[i.RG_INTEGER=33320]="RG_INTEGER",i[i.INT_2_10_10_10_REV=36255]="INT_2_10_10_10_REV",i[i.CURRENT_QUERY=34917]="CURRENT_QUERY",i[i.QUERY_RESULT=34918]="QUERY_RESULT",i[i.QUERY_RESULT_AVAILABLE=34919]="QUERY_RESULT_AVAILABLE",i[i.ANY_SAMPLES_PASSED=35887]="ANY_SAMPLES_PASSED",i[i.ANY_SAMPLES_PASSED_CONSERVATIVE=36202]="ANY_SAMPLES_PASSED_CONSERVATIVE",i[i.MAX_DRAW_BUFFERS=34852]="MAX_DRAW_BUFFERS",i[i.DRAW_BUFFER0=34853]="DRAW_BUFFER0",i[i.DRAW_BUFFER1=34854]="DRAW_BUFFER1",i[i.DRAW_BUFFER2=34855]="DRAW_BUFFER2",i[i.DRAW_BUFFER3=34856]="DRAW_BUFFER3",i[i.DRAW_BUFFER4=34857]="DRAW_BUFFER4",i[i.DRAW_BUFFER5=34858]="DRAW_BUFFER5",i[i.DRAW_BUFFER6=34859]="DRAW_BUFFER6",i[i.DRAW_BUFFER7=34860]="DRAW_BUFFER7",i[i.DRAW_BUFFER8=34861]="DRAW_BUFFER8",i[i.DRAW_BUFFER9=34862]="DRAW_BUFFER9",i[i.DRAW_BUFFER10=34863]="DRAW_BUFFER10",i[i.DRAW_BUFFER11=34864]="DRAW_BUFFER11",i[i.DRAW_BUFFER12=34865]="DRAW_BUFFER12",i[i.DRAW_BUFFER13=34866]="DRAW_BUFFER13",i[i.DRAW_BUFFER14=34867]="DRAW_BUFFER14",i[i.DRAW_BUFFER15=34868]="DRAW_BUFFER15",i[i.MAX_COLOR_ATTACHMENTS=36063]="MAX_COLOR_ATTACHMENTS",i[i.COLOR_ATTACHMENT1=36065]="COLOR_ATTACHMENT1",i[i.COLOR_ATTACHMENT2=36066]="COLOR_ATTACHMENT2",i[i.COLOR_ATTACHMENT3=36067]="COLOR_ATTACHMENT3",i[i.COLOR_ATTACHMENT4=36068]="COLOR_ATTACHMENT4",i[i.COLOR_ATTACHMENT5=36069]="COLOR_ATTACHMENT5",i[i.COLOR_ATTACHMENT6=36070]="COLOR_ATTACHMENT6",i[i.COLOR_ATTACHMENT7=36071]="COLOR_ATTACHMENT7",i[i.COLOR_ATTACHMENT8=36072]="COLOR_ATTACHMENT8",i[i.COLOR_ATTACHMENT9=36073]="COLOR_ATTACHMENT9",i[i.COLOR_ATTACHMENT10=36074]="COLOR_ATTACHMENT10",i[i.COLOR_ATTACHMENT11=36075]="COLOR_ATTACHMENT11",i[i.COLOR_ATTACHMENT12=36076]="COLOR_ATTACHMENT12",i[i.COLOR_ATTACHMENT13=36077]="COLOR_ATTACHMENT13",i[i.COLOR_ATTACHMENT14=36078]="COLOR_ATTACHMENT14",i[i.COLOR_ATTACHMENT15=36079]="COLOR_ATTACHMENT15",i[i.SAMPLER_3D=35679]="SAMPLER_3D",i[i.SAMPLER_2D_SHADOW=35682]="SAMPLER_2D_SHADOW",i[i.SAMPLER_2D_ARRAY=36289]="SAMPLER_2D_ARRAY",i[i.SAMPLER_2D_ARRAY_SHADOW=36292]="SAMPLER_2D_ARRAY_SHADOW",i[i.SAMPLER_CUBE_SHADOW=36293]="SAMPLER_CUBE_SHADOW",i[i.INT_SAMPLER_2D=36298]="INT_SAMPLER_2D",i[i.INT_SAMPLER_3D=36299]="INT_SAMPLER_3D",i[i.INT_SAMPLER_CUBE=36300]="INT_SAMPLER_CUBE",i[i.INT_SAMPLER_2D_ARRAY=36303]="INT_SAMPLER_2D_ARRAY",i[i.UNSIGNED_INT_SAMPLER_2D=36306]="UNSIGNED_INT_SAMPLER_2D",i[i.UNSIGNED_INT_SAMPLER_3D=36307]="UNSIGNED_INT_SAMPLER_3D",i[i.UNSIGNED_INT_SAMPLER_CUBE=36308]="UNSIGNED_INT_SAMPLER_CUBE",i[i.UNSIGNED_INT_SAMPLER_2D_ARRAY=36311]="UNSIGNED_INT_SAMPLER_2D_ARRAY",i[i.MAX_SAMPLES=36183]="MAX_SAMPLES",i[i.SAMPLER_BINDING=35097]="SAMPLER_BINDING",i[i.PIXEL_PACK_BUFFER=35051]="PIXEL_PACK_BUFFER",i[i.PIXEL_UNPACK_BUFFER=35052]="PIXEL_UNPACK_BUFFER",i[i.PIXEL_PACK_BUFFER_BINDING=35053]="PIXEL_PACK_BUFFER_BINDING",i[i.PIXEL_UNPACK_BUFFER_BINDING=35055]="PIXEL_UNPACK_BUFFER_BINDING",i[i.COPY_READ_BUFFER=36662]="COPY_READ_BUFFER",i[i.COPY_WRITE_BUFFER=36663]="COPY_WRITE_BUFFER",i[i.COPY_READ_BUFFER_BINDING=36662]="COPY_READ_BUFFER_BINDING",i[i.COPY_WRITE_BUFFER_BINDING=36663]="COPY_WRITE_BUFFER_BINDING",i[i.FLOAT_MAT2x3=35685]="FLOAT_MAT2x3",i[i.FLOAT_MAT2x4=35686]="FLOAT_MAT2x4",i[i.FLOAT_MAT3x2=35687]="FLOAT_MAT3x2",i[i.FLOAT_MAT3x4=35688]="FLOAT_MAT3x4",i[i.FLOAT_MAT4x2=35689]="FLOAT_MAT4x2",i[i.FLOAT_MAT4x3=35690]="FLOAT_MAT4x3",i[i.UNSIGNED_INT_VEC2=36294]="UNSIGNED_INT_VEC2",i[i.UNSIGNED_INT_VEC3=36295]="UNSIGNED_INT_VEC3",i[i.UNSIGNED_INT_VEC4=36296]="UNSIGNED_INT_VEC4",i[i.UNSIGNED_NORMALIZED=35863]="UNSIGNED_NORMALIZED",i[i.SIGNED_NORMALIZED=36764]="SIGNED_NORMALIZED",i[i.VERTEX_ATTRIB_ARRAY_INTEGER=35069]="VERTEX_ATTRIB_ARRAY_INTEGER",i[i.VERTEX_ATTRIB_ARRAY_DIVISOR=35070]="VERTEX_ATTRIB_ARRAY_DIVISOR",i[i.TRANSFORM_FEEDBACK_BUFFER_MODE=35967]="TRANSFORM_FEEDBACK_BUFFER_MODE",i[i.MAX_TRANSFORM_FEEDBACK_SEPARATE_COMPONENTS=35968]="MAX_TRANSFORM_FEEDBACK_SEPARATE_COMPONENTS",i[i.TRANSFORM_FEEDBACK_VARYINGS=35971]="TRANSFORM_FEEDBACK_VARYINGS",i[i.TRANSFORM_FEEDBACK_BUFFER_START=35972]="TRANSFORM_FEEDBACK_BUFFER_START",i[i.TRANSFORM_FEEDBACK_BUFFER_SIZE=35973]="TRANSFORM_FEEDBACK_BUFFER_SIZE",i[i.TRANSFORM_FEEDBACK_PRIMITIVES_WRITTEN=35976]="TRANSFORM_FEEDBACK_PRIMITIVES_WRITTEN",i[i.MAX_TRANSFORM_FEEDBACK_INTERLEAVED_COMPONENTS=35978]="MAX_TRANSFORM_FEEDBACK_INTERLEAVED_COMPONENTS",i[i.MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS=35979]="MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS",i[i.INTERLEAVED_ATTRIBS=35980]="INTERLEAVED_ATTRIBS",i[i.SEPARATE_ATTRIBS=35981]="SEPARATE_ATTRIBS",i[i.TRANSFORM_FEEDBACK_BUFFER=35982]="TRANSFORM_FEEDBACK_BUFFER",i[i.TRANSFORM_FEEDBACK_BUFFER_BINDING=35983]="TRANSFORM_FEEDBACK_BUFFER_BINDING",i[i.TRANSFORM_FEEDBACK=36386]="TRANSFORM_FEEDBACK",i[i.TRANSFORM_FEEDBACK_PAUSED=36387]="TRANSFORM_FEEDBACK_PAUSED",i[i.TRANSFORM_FEEDBACK_ACTIVE=36388]="TRANSFORM_FEEDBACK_ACTIVE",i[i.TRANSFORM_FEEDBACK_BINDING=36389]="TRANSFORM_FEEDBACK_BINDING",i[i.FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING=33296]="FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING",i[i.FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE=33297]="FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE",i[i.FRAMEBUFFER_ATTACHMENT_RED_SIZE=33298]="FRAMEBUFFER_ATTACHMENT_RED_SIZE",i[i.FRAMEBUFFER_ATTACHMENT_GREEN_SIZE=33299]="FRAMEBUFFER_ATTACHMENT_GREEN_SIZE",i[i.FRAMEBUFFER_ATTACHMENT_BLUE_SIZE=33300]="FRAMEBUFFER_ATTACHMENT_BLUE_SIZE",i[i.FRAMEBUFFER_ATTACHMENT_ALPHA_SIZE=33301]="FRAMEBUFFER_ATTACHMENT_ALPHA_SIZE",i[i.FRAMEBUFFER_ATTACHMENT_DEPTH_SIZE=33302]="FRAMEBUFFER_ATTACHMENT_DEPTH_SIZE",i[i.FRAMEBUFFER_ATTACHMENT_STENCIL_SIZE=33303]="FRAMEBUFFER_ATTACHMENT_STENCIL_SIZE",i[i.FRAMEBUFFER_DEFAULT=33304]="FRAMEBUFFER_DEFAULT",i[i.DEPTH24_STENCIL8=35056]="DEPTH24_STENCIL8",i[i.DRAW_FRAMEBUFFER_BINDING=36006]="DRAW_FRAMEBUFFER_BINDING",i[i.READ_FRAMEBUFFER_BINDING=36010]="READ_FRAMEBUFFER_BINDING",i[i.RENDERBUFFER_SAMPLES=36011]="RENDERBUFFER_SAMPLES",i[i.FRAMEBUFFER_ATTACHMENT_TEXTURE_LAYER=36052]="FRAMEBUFFER_ATTACHMENT_TEXTURE_LAYER",i[i.FRAMEBUFFER_INCOMPLETE_MULTISAMPLE=36182]="FRAMEBUFFER_INCOMPLETE_MULTISAMPLE",i[i.UNIFORM_BUFFER=35345]="UNIFORM_BUFFER",i[i.UNIFORM_BUFFER_BINDING=35368]="UNIFORM_BUFFER_BINDING",i[i.UNIFORM_BUFFER_START=35369]="UNIFORM_BUFFER_START",i[i.UNIFORM_BUFFER_SIZE=35370]="UNIFORM_BUFFER_SIZE",i[i.MAX_VERTEX_UNIFORM_BLOCKS=35371]="MAX_VERTEX_UNIFORM_BLOCKS",i[i.MAX_FRAGMENT_UNIFORM_BLOCKS=35373]="MAX_FRAGMENT_UNIFORM_BLOCKS",i[i.MAX_COMBINED_UNIFORM_BLOCKS=35374]="MAX_COMBINED_UNIFORM_BLOCKS",i[i.MAX_UNIFORM_BUFFER_BINDINGS=35375]="MAX_UNIFORM_BUFFER_BINDINGS",i[i.MAX_UNIFORM_BLOCK_SIZE=35376]="MAX_UNIFORM_BLOCK_SIZE",i[i.MAX_COMBINED_VERTEX_UNIFORM_COMPONENTS=35377]="MAX_COMBINED_VERTEX_UNIFORM_COMPONENTS",i[i.MAX_COMBINED_FRAGMENT_UNIFORM_COMPONENTS=35379]="MAX_COMBINED_FRAGMENT_UNIFORM_COMPONENTS",i[i.UNIFORM_BUFFER_OFFSET_ALIGNMENT=35380]="UNIFORM_BUFFER_OFFSET_ALIGNMENT",i[i.ACTIVE_UNIFORM_BLOCKS=35382]="ACTIVE_UNIFORM_BLOCKS",i[i.UNIFORM_TYPE=35383]="UNIFORM_TYPE",i[i.UNIFORM_SIZE=35384]="UNIFORM_SIZE",i[i.UNIFORM_BLOCK_INDEX=35386]="UNIFORM_BLOCK_INDEX",i[i.UNIFORM_OFFSET=35387]="UNIFORM_OFFSET",i[i.UNIFORM_ARRAY_STRIDE=35388]="UNIFORM_ARRAY_STRIDE",i[i.UNIFORM_MATRIX_STRIDE=35389]="UNIFORM_MATRIX_STRIDE",i[i.UNIFORM_IS_ROW_MAJOR=35390]="UNIFORM_IS_ROW_MAJOR",i[i.UNIFORM_BLOCK_BINDING=35391]="UNIFORM_BLOCK_BINDING",i[i.UNIFORM_BLOCK_DATA_SIZE=35392]="UNIFORM_BLOCK_DATA_SIZE",i[i.UNIFORM_BLOCK_ACTIVE_UNIFORMS=35394]="UNIFORM_BLOCK_ACTIVE_UNIFORMS",i[i.UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES=35395]="UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES",i[i.UNIFORM_BLOCK_REFERENCED_BY_VERTEX_SHADER=35396]="UNIFORM_BLOCK_REFERENCED_BY_VERTEX_SHADER",i[i.UNIFORM_BLOCK_REFERENCED_BY_FRAGMENT_SHADER=35398]="UNIFORM_BLOCK_REFERENCED_BY_FRAGMENT_SHADER",i[i.OBJECT_TYPE=37138]="OBJECT_TYPE",i[i.SYNC_CONDITION=37139]="SYNC_CONDITION",i[i.SYNC_STATUS=37140]="SYNC_STATUS",i[i.SYNC_FLAGS=37141]="SYNC_FLAGS",i[i.SYNC_FENCE=37142]="SYNC_FENCE",i[i.SYNC_GPU_COMMANDS_COMPLETE=37143]="SYNC_GPU_COMMANDS_COMPLETE",i[i.UNSIGNALED=37144]="UNSIGNALED",i[i.SIGNALED=37145]="SIGNALED",i[i.ALREADY_SIGNALED=37146]="ALREADY_SIGNALED",i[i.TIMEOUT_EXPIRED=37147]="TIMEOUT_EXPIRED",i[i.CONDITION_SATISFIED=37148]="CONDITION_SATISFIED",i[i.WAIT_FAILED=37149]="WAIT_FAILED",i[i.SYNC_FLUSH_COMMANDS_BIT=1]="SYNC_FLUSH_COMMANDS_BIT",i[i.COLOR=6144]="COLOR",i[i.DEPTH=6145]="DEPTH",i[i.STENCIL=6146]="STENCIL",i[i.MIN=32775]="MIN",i[i.MAX=32776]="MAX",i[i.DEPTH_COMPONENT24=33190]="DEPTH_COMPONENT24",i[i.STREAM_READ=35041]="STREAM_READ",i[i.STREAM_COPY=35042]="STREAM_COPY",i[i.STATIC_READ=35045]="STATIC_READ",i[i.STATIC_COPY=35046]="STATIC_COPY",i[i.DYNAMIC_READ=35049]="DYNAMIC_READ",i[i.DYNAMIC_COPY=35050]="DYNAMIC_COPY",i[i.DEPTH_COMPONENT32F=36012]="DEPTH_COMPONENT32F",i[i.DEPTH32F_STENCIL8=36013]="DEPTH32F_STENCIL8",i[i.INVALID_INDEX=4294967295]="INVALID_INDEX",i[i.TIMEOUT_IGNORED=-1]="TIMEOUT_IGNORED",i[i.MAX_CLIENT_WAIT_TIMEOUT_WEBGL=37447]="MAX_CLIENT_WAIT_TIMEOUT_WEBGL",i[i.UNMASKED_VENDOR_WEBGL=37445]="UNMASKED_VENDOR_WEBGL",i[i.UNMASKED_RENDERER_WEBGL=37446]="UNMASKED_RENDERER_WEBGL",i[i.MAX_TEXTURE_MAX_ANISOTROPY_EXT=34047]="MAX_TEXTURE_MAX_ANISOTROPY_EXT",i[i.TEXTURE_MAX_ANISOTROPY_EXT=34046]="TEXTURE_MAX_ANISOTROPY_EXT",i[i.R16_EXT=33322]="R16_EXT",i[i.RG16_EXT=33324]="RG16_EXT",i[i.RGB16_EXT=32852]="RGB16_EXT",i[i.RGBA16_EXT=32859]="RGBA16_EXT",i[i.R16_SNORM_EXT=36760]="R16_SNORM_EXT",i[i.RG16_SNORM_EXT=36761]="RG16_SNORM_EXT",i[i.RGB16_SNORM_EXT=36762]="RGB16_SNORM_EXT",i[i.RGBA16_SNORM_EXT=36763]="RGBA16_SNORM_EXT",i[i.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",i[i.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",i[i.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",i[i.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",i[i.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",i[i.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",i[i.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",i[i.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",i[i.COMPRESSED_RED_RGTC1_EXT=36283]="COMPRESSED_RED_RGTC1_EXT",i[i.COMPRESSED_SIGNED_RED_RGTC1_EXT=36284]="COMPRESSED_SIGNED_RED_RGTC1_EXT",i[i.COMPRESSED_RED_GREEN_RGTC2_EXT=36285]="COMPRESSED_RED_GREEN_RGTC2_EXT",i[i.COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT=36286]="COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT",i[i.COMPRESSED_RGBA_BPTC_UNORM_EXT=36492]="COMPRESSED_RGBA_BPTC_UNORM_EXT",i[i.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT=36493]="COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT",i[i.COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT=36494]="COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT",i[i.COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT=36495]="COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT",i[i.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",i[i.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",i[i.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",i[i.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",i[i.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",i[i.COMPRESSED_RGBA8_ETC2_EAC=37493]="COMPRESSED_RGBA8_ETC2_EAC",i[i.COMPRESSED_SRGB8_ETC2=37494]="COMPRESSED_SRGB8_ETC2",i[i.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37495]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",i[i.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37496]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",i[i.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37497]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",i[i.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",i[i.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",i[i.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",i[i.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",i[i.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",i[i.COMPRESSED_RGB_ATC_WEBGL=35986]="COMPRESSED_RGB_ATC_WEBGL",i[i.COMPRESSED_RGBA_ATC_EXPLICIT_ALPHA_WEBGL=35986]="COMPRESSED_RGBA_ATC_EXPLICIT_ALPHA_WEBGL",i[i.COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL=34798]="COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL",i[i.COMPRESSED_RGBA_ASTC_4x4_KHR=37808]="COMPRESSED_RGBA_ASTC_4x4_KHR",i[i.COMPRESSED_RGBA_ASTC_5x4_KHR=37809]="COMPRESSED_RGBA_ASTC_5x4_KHR",i[i.COMPRESSED_RGBA_ASTC_5x5_KHR=37810]="COMPRESSED_RGBA_ASTC_5x5_KHR",i[i.COMPRESSED_RGBA_ASTC_6x5_KHR=37811]="COMPRESSED_RGBA_ASTC_6x5_KHR",i[i.COMPRESSED_RGBA_ASTC_6x6_KHR=37812]="COMPRESSED_RGBA_ASTC_6x6_KHR",i[i.COMPRESSED_RGBA_ASTC_8x5_KHR=37813]="COMPRESSED_RGBA_ASTC_8x5_KHR",i[i.COMPRESSED_RGBA_ASTC_8x6_KHR=37814]="COMPRESSED_RGBA_ASTC_8x6_KHR",i[i.COMPRESSED_RGBA_ASTC_8x8_KHR=37815]="COMPRESSED_RGBA_ASTC_8x8_KHR",i[i.COMPRESSED_RGBA_ASTC_10x5_KHR=37816]="COMPRESSED_RGBA_ASTC_10x5_KHR",i[i.COMPRESSED_RGBA_ASTC_10x6_KHR=37817]="COMPRESSED_RGBA_ASTC_10x6_KHR",i[i.COMPRESSED_RGBA_ASTC_10x8_KHR=37818]="COMPRESSED_RGBA_ASTC_10x8_KHR",i[i.COMPRESSED_RGBA_ASTC_10x10_KHR=37819]="COMPRESSED_RGBA_ASTC_10x10_KHR",i[i.COMPRESSED_RGBA_ASTC_12x10_KHR=37820]="COMPRESSED_RGBA_ASTC_12x10_KHR",i[i.COMPRESSED_RGBA_ASTC_12x12_KHR=37821]="COMPRESSED_RGBA_ASTC_12x12_KHR",i[i.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840]="COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR",i[i.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR=37841]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR",i[i.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR=37842]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR",i[i.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR=37843]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR",i[i.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR=37844]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR",i[i.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR=37845]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR",i[i.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR=37846]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR",i[i.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR=37847]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR",i[i.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR=37848]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR",i[i.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR=37849]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR",i[i.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR=37850]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR",i[i.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR=37851]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR",i[i.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR=37852]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR",i[i.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR=37853]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR",i[i.QUERY_COUNTER_BITS_EXT=34916]="QUERY_COUNTER_BITS_EXT",i[i.CURRENT_QUERY_EXT=34917]="CURRENT_QUERY_EXT",i[i.QUERY_RESULT_EXT=34918]="QUERY_RESULT_EXT",i[i.QUERY_RESULT_AVAILABLE_EXT=34919]="QUERY_RESULT_AVAILABLE_EXT",i[i.TIME_ELAPSED_EXT=35007]="TIME_ELAPSED_EXT",i[i.TIMESTAMP_EXT=36392]="TIMESTAMP_EXT",i[i.GPU_DISJOINT_EXT=36795]="GPU_DISJOINT_EXT",i[i.COMPLETION_STATUS_KHR=37297]="COMPLETION_STATUS_KHR",i[i.DEPTH_CLAMP_EXT=34383]="DEPTH_CLAMP_EXT",i[i.FIRST_VERTEX_CONVENTION_WEBGL=36429]="FIRST_VERTEX_CONVENTION_WEBGL",i[i.LAST_VERTEX_CONVENTION_WEBGL=36430]="LAST_VERTEX_CONVENTION_WEBGL",i[i.PROVOKING_VERTEX_WEBL=36431]="PROVOKING_VERTEX_WEBL",i[i.POLYGON_MODE_WEBGL=2880]="POLYGON_MODE_WEBGL",i[i.POLYGON_OFFSET_LINE_WEBGL=10754]="POLYGON_OFFSET_LINE_WEBGL",i[i.LINE_WEBGL=6913]="LINE_WEBGL",i[i.FILL_WEBGL=6914]="FILL_WEBGL",i[i.MAX_CLIP_DISTANCES_WEBGL=3378]="MAX_CLIP_DISTANCES_WEBGL",i[i.MAX_CULL_DISTANCES_WEBGL=33529]="MAX_CULL_DISTANCES_WEBGL",i[i.MAX_COMBINED_CLIP_AND_CULL_DISTANCES_WEBGL=33530]="MAX_COMBINED_CLIP_AND_CULL_DISTANCES_WEBGL",i[i.CLIP_DISTANCE0_WEBGL=12288]="CLIP_DISTANCE0_WEBGL",i[i.CLIP_DISTANCE1_WEBGL=12289]="CLIP_DISTANCE1_WEBGL",i[i.CLIP_DISTANCE2_WEBGL=12290]="CLIP_DISTANCE2_WEBGL",i[i.CLIP_DISTANCE3_WEBGL=12291]="CLIP_DISTANCE3_WEBGL",i[i.CLIP_DISTANCE4_WEBGL=12292]="CLIP_DISTANCE4_WEBGL",i[i.CLIP_DISTANCE5_WEBGL=12293]="CLIP_DISTANCE5_WEBGL",i[i.CLIP_DISTANCE6_WEBGL=12294]="CLIP_DISTANCE6_WEBGL",i[i.CLIP_DISTANCE7_WEBGL=12295]="CLIP_DISTANCE7_WEBGL",i[i.POLYGON_OFFSET_CLAMP_EXT=36379]="POLYGON_OFFSET_CLAMP_EXT",i[i.LOWER_LEFT_EXT=36001]="LOWER_LEFT_EXT",i[i.UPPER_LEFT_EXT=36002]="UPPER_LEFT_EXT",i[i.NEGATIVE_ONE_TO_ONE_EXT=37726]="NEGATIVE_ONE_TO_ONE_EXT",i[i.ZERO_TO_ONE_EXT=37727]="ZERO_TO_ONE_EXT",i[i.CLIP_ORIGIN_EXT=37724]="CLIP_ORIGIN_EXT",i[i.CLIP_DEPTH_MODE_EXT=37725]="CLIP_DEPTH_MODE_EXT",i[i.SRC1_COLOR_WEBGL=35065]="SRC1_COLOR_WEBGL",i[i.SRC1_ALPHA_WEBGL=34185]="SRC1_ALPHA_WEBGL",i[i.ONE_MINUS_SRC1_COLOR_WEBGL=35066]="ONE_MINUS_SRC1_COLOR_WEBGL",i[i.ONE_MINUS_SRC1_ALPHA_WEBGL=35067]="ONE_MINUS_SRC1_ALPHA_WEBGL",i[i.MAX_DUAL_SOURCE_DRAW_BUFFERS_WEBGL=35068]="MAX_DUAL_SOURCE_DRAW_BUFFERS_WEBGL",i[i.MIRROR_CLAMP_TO_EDGE_EXT=34627]="MIRROR_CLAMP_TO_EDGE_EXT"})(ad||(ad={}));const hA={3042:!1,32773:new Float32Array([0,0,0,0]),32777:32774,34877:32774,32969:1,32968:0,32971:1,32970:0,3106:new Float32Array([0,0,0,0]),3107:[!0,!0,!0,!0],2884:!1,2885:1029,2929:!1,2931:1,2932:513,2928:new Float32Array([0,1]),2930:!0,3024:!0,35725:null,36006:null,36007:null,34229:null,34964:null,2886:2305,33170:4352,2849:1,32823:!1,32824:0,10752:0,32926:!1,32928:!1,32938:1,32939:!1,3089:!1,3088:new Int32Array([0,0,1024,1024]),2960:!1,2961:0,2968:4294967295,36005:4294967295,2962:519,2967:0,2963:4294967295,34816:519,36003:0,36004:4294967295,2964:7680,2965:7680,2966:7680,34817:7680,34818:7680,34819:7680,2978:[0,0,1024,1024],36389:null,36662:null,36663:null,35053:null,35055:null,35723:4352,36010:null,35977:!1,3333:4,3317:4,37440:!1,37441:!1,37443:37444,3330:0,3332:0,3331:0,3314:0,32878:0,3316:0,3315:0,32877:0},dn=(i,e,t)=>e?i.enable(t):i.disable(t),X3=(i,e,t)=>i.hint(t,e),Us=(i,e,t)=>i.pixelStorei(t,e),Z3=(i,e,t)=>{const r=t===36006?36009:36008;return i.bindFramebuffer(r,e)},Lp=(i,e,t)=>{const a={34964:34962,36662:36662,36663:36663,35053:35051,35055:35052}[t];i.bindBuffer(a,e)};function sb(i){return Array.isArray(i)||ArrayBuffer.isView(i)&&!(i instanceof DataView)}const j9={3042:dn,32773:(i,e)=>i.blendColor(...e),32777:"blendEquation",34877:"blendEquation",32969:"blendFunc",32968:"blendFunc",32971:"blendFunc",32970:"blendFunc",3106:(i,e)=>i.clearColor(...e),3107:(i,e)=>i.colorMask(...e),2884:dn,2885:(i,e)=>i.cullFace(e),2929:dn,2931:(i,e)=>i.clearDepth(e),2932:(i,e)=>i.depthFunc(e),2928:(i,e)=>i.depthRange(...e),2930:(i,e)=>i.depthMask(e),3024:dn,35723:X3,35725:(i,e)=>i.useProgram(e),36007:(i,e)=>i.bindRenderbuffer(36161,e),36389:(i,e)=>{var t;return(t=i.bindTransformFeedback)==null?void 0:t.call(i,36386,e)},34229:(i,e)=>i.bindVertexArray(e),36006:Z3,36010:Z3,34964:Lp,36662:Lp,36663:Lp,35053:Lp,35055:Lp,2886:(i,e)=>i.frontFace(e),33170:X3,2849:(i,e)=>i.lineWidth(e),32823:dn,32824:"polygonOffset",10752:"polygonOffset",35977:dn,32926:dn,32928:dn,32938:"sampleCoverage",32939:"sampleCoverage",3089:dn,3088:(i,e)=>i.scissor(...e),2960:dn,2961:(i,e)=>i.clearStencil(e),2968:(i,e)=>i.stencilMaskSeparate(1028,e),36005:(i,e)=>i.stencilMaskSeparate(1029,e),2962:"stencilFuncFront",2967:"stencilFuncFront",2963:"stencilFuncFront",34816:"stencilFuncBack",36003:"stencilFuncBack",36004:"stencilFuncBack",2964:"stencilOpFront",2965:"stencilOpFront",2966:"stencilOpFront",34817:"stencilOpBack",34818:"stencilOpBack",34819:"stencilOpBack",2978:(i,e)=>i.viewport(...e),34383:dn,10754:dn,12288:dn,12289:dn,12290:dn,12291:dn,12292:dn,12293:dn,12294:dn,12295:dn,3333:Us,3317:Us,37440:Us,37441:Us,37443:Us,3330:Us,3332:Us,3331:Us,3314:Us,32878:Us,3316:Us,3315:Us,32877:Us,framebuffer:(i,e)=>{const t=e&&"handle"in e?e.handle:e;return i.bindFramebuffer(36160,t)},blend:(i,e)=>e?i.enable(3042):i.disable(3042),blendColor:(i,e)=>i.blendColor(...e),blendEquation:(i,e)=>{const t=typeof e=="number"?[e,e]:e;i.blendEquationSeparate(...t)},blendFunc:(i,e)=>{const t=(e==null?void 0:e.length)===2?[...e,...e]:e;i.blendFuncSeparate(...t)},clearColor:(i,e)=>i.clearColor(...e),clearDepth:(i,e)=>i.clearDepth(e),clearStencil:(i,e)=>i.clearStencil(e),colorMask:(i,e)=>i.colorMask(...e),cull:(i,e)=>e?i.enable(2884):i.disable(2884),cullFace:(i,e)=>i.cullFace(e),depthTest:(i,e)=>e?i.enable(2929):i.disable(2929),depthFunc:(i,e)=>i.depthFunc(e),depthMask:(i,e)=>i.depthMask(e),depthRange:(i,e)=>i.depthRange(...e),dither:(i,e)=>e?i.enable(3024):i.disable(3024),derivativeHint:(i,e)=>{i.hint(35723,e)},frontFace:(i,e)=>i.frontFace(e),mipmapHint:(i,e)=>i.hint(33170,e),lineWidth:(i,e)=>i.lineWidth(e),polygonOffsetFill:(i,e)=>e?i.enable(32823):i.disable(32823),polygonOffset:(i,e)=>i.polygonOffset(...e),sampleCoverage:(i,e)=>i.sampleCoverage(e[0],e[1]||!1),scissorTest:(i,e)=>e?i.enable(3089):i.disable(3089),scissor:(i,e)=>i.scissor(...e),stencilTest:(i,e)=>e?i.enable(2960):i.disable(2960),stencilMask:(i,e)=>{e=sb(e)?e:[e,e];const[t,r]=e;i.stencilMaskSeparate(1028,t),i.stencilMaskSeparate(1029,r)},stencilFunc:(i,e)=>{e=sb(e)&&e.length===3?[...e,...e]:e;const[t,r,a,h,y,s]=e;i.stencilFuncSeparate(1028,t,r,a),i.stencilFuncSeparate(1029,h,y,s)},stencilOp:(i,e)=>{e=sb(e)&&e.length===3?[...e,...e]:e;const[t,r,a,h,y,s]=e;i.stencilOpSeparate(1028,t,r,a),i.stencilOpSeparate(1029,h,y,s)},viewport:(i,e)=>i.viewport(...e)};function Qr(i,e,t){return e[i]!==void 0?e[i]:t[i]}const H9={blendEquation:(i,e,t)=>i.blendEquationSeparate(Qr(32777,e,t),Qr(34877,e,t)),blendFunc:(i,e,t)=>i.blendFuncSeparate(Qr(32969,e,t),Qr(32968,e,t),Qr(32971,e,t),Qr(32970,e,t)),polygonOffset:(i,e,t)=>i.polygonOffset(Qr(32824,e,t),Qr(10752,e,t)),sampleCoverage:(i,e,t)=>i.sampleCoverage(Qr(32938,e,t),Qr(32939,e,t)),stencilFuncFront:(i,e,t)=>i.stencilFuncSeparate(1028,Qr(2962,e,t),Qr(2967,e,t),Qr(2963,e,t)),stencilFuncBack:(i,e,t)=>i.stencilFuncSeparate(1029,Qr(34816,e,t),Qr(36003,e,t),Qr(36004,e,t)),stencilOpFront:(i,e,t)=>i.stencilOpSeparate(1028,Qr(2964,e,t),Qr(2965,e,t),Qr(2966,e,t)),stencilOpBack:(i,e,t)=>i.stencilOpSeparate(1029,Qr(34817,e,t),Qr(34818,e,t),Qr(34819,e,t))},Y3={enable:(i,e)=>i({[e]:!0}),disable:(i,e)=>i({[e]:!1}),pixelStorei:(i,e,t)=>i({[e]:t}),hint:(i,e,t)=>i({[e]:t}),useProgram:(i,e)=>i({35725:e}),bindRenderbuffer:(i,e,t)=>i({36007:t}),bindTransformFeedback:(i,e,t)=>i({36389:t}),bindVertexArray:(i,e)=>i({34229:e}),bindFramebuffer:(i,e,t)=>{switch(e){case 36160:return i({36006:t,36010:t});case 36009:return i({36006:t});case 36008:return i({36010:t});default:return null}},bindBuffer:(i,e,t)=>{const r={34962:[34964],36662:[36662],36663:[36663],35051:[35053],35052:[35055]}[e];return r?i({[r]:t}):{valueChanged:!0}},blendColor:(i,e,t,r,a)=>i({32773:new Float32Array([e,t,r,a])}),blendEquation:(i,e)=>i({32777:e,34877:e}),blendEquationSeparate:(i,e,t)=>i({32777:e,34877:t}),blendFunc:(i,e,t)=>i({32969:e,32968:t,32971:e,32970:t}),blendFuncSeparate:(i,e,t,r,a)=>i({32969:e,32968:t,32971:r,32970:a}),clearColor:(i,e,t,r,a)=>i({3106:new Float32Array([e,t,r,a])}),clearDepth:(i,e)=>i({2931:e}),clearStencil:(i,e)=>i({2961:e}),colorMask:(i,e,t,r,a)=>i({3107:[e,t,r,a]}),cullFace:(i,e)=>i({2885:e}),depthFunc:(i,e)=>i({2932:e}),depthRange:(i,e,t)=>i({2928:new Float32Array([e,t])}),depthMask:(i,e)=>i({2930:e}),frontFace:(i,e)=>i({2886:e}),lineWidth:(i,e)=>i({2849:e}),polygonOffset:(i,e,t)=>i({32824:e,10752:t}),sampleCoverage:(i,e,t)=>i({32938:e,32939:t}),scissor:(i,e,t,r,a)=>i({3088:new Int32Array([e,t,r,a])}),stencilMask:(i,e)=>i({2968:e,36005:e}),stencilMaskSeparate:(i,e,t)=>i({[e===1028?2968:36005]:t}),stencilFunc:(i,e,t,r)=>i({2962:e,2967:t,2963:r,34816:e,36003:t,36004:r}),stencilFuncSeparate:(i,e,t,r,a)=>i({[e===1028?2962:34816]:t,[e===1028?2967:36003]:r,[e===1028?2963:36004]:a}),stencilOp:(i,e,t,r)=>i({2964:e,2965:t,2966:r,34817:e,34818:t,34819:r}),stencilOpSeparate:(i,e,t,r,a)=>i({[e===1028?2964:34817]:t,[e===1028?2965:34818]:r,[e===1028?2966:34819]:a}),viewport:(i,e,t,r,a)=>i({2978:[e,t,r,a]})},ma=(i,e)=>i.isEnabled(e),K3={3042:ma,2884:ma,2929:ma,3024:ma,32823:ma,32926:ma,32928:ma,3089:ma,2960:ma,35977:ma},G9=new Set([34016,36388,36387,35983,35368,34965,35739,35738,3074,34853,34854,34855,34856,34857,34858,34859,34860,34861,34862,34863,34864,34865,34866,34867,34868,35097,32873,35869,32874,34068]);function Rd(i,e){if(W9(e))return;const t={};for(const a in e){const h=Number(a),y=j9[a];y&&(typeof y=="string"?t[y]=!0:y(i,e[a],h))}const r=i.state&&i.state.cache;if(r)for(const a in t){const h=H9[a];h(i,e,r)}}function CP(i,e=hA){if(typeof e=="number"){const a=e,h=K3[a];return h?h(i,a):i.getParameter(a)}const t=Array.isArray(e)?e:Object.keys(e),r={};for(const a of t){const h=K3[a];r[a]=h?h(i,Number(a)):i.getParameter(Number(a))}return r}function $9(i){Rd(i,hA)}function W9(i){for(const e in i)return!1;return!0}function q9(i,e){if(i===e)return!0;const t=Array.isArray(i)||ArrayBuffer.isView(i),r=Array.isArray(e)||ArrayBuffer.isView(e);if(t&&r&&i.length===e.length){for(let a=0;a<i.length;++a)if(i[a]!==e[a])return!1;return!0}return!1}class Tu{constructor(e,t){pe(this,"gl");pe(this,"program",null);pe(this,"stateStack",[]);pe(this,"enable",!0);pe(this,"cache",null);pe(this,"log");pe(this,"initialized",!1);this.gl=e,this.log=(t==null?void 0:t.log)||(()=>{}),this._updateCache=this._updateCache.bind(this),Object.seal(this)}static get(e){return e.state}push(e={}){this.stateStack.push({})}pop(){const e=this.stateStack[this.stateStack.length-1];Rd(this.gl,e),this.stateStack.pop()}trackState(e,t){if(this.cache=t.copyState?CP(e):Object.assign({},hA),this.initialized)throw new Error("WebGLStateTracker");this.initialized=!0,this.gl.state=this,Z9(e);for(const r in Y3){const a=Y3[r];X9(e,r,a)}J3(e,"getParameter"),J3(e,"isEnabled")}_updateCache(e){let t=!1,r;const a=this.stateStack.length>0?this.stateStack[this.stateStack.length-1]:null;for(const h in e){const y=e[h],s=this.cache[h];q9(y,s)||(t=!0,r=s,a&&!(h in a)&&(a[h]=s),this.cache[h]=y)}return{valueChanged:t,oldValue:r}}}function J3(i,e){const t=i[e].bind(i);i[e]=function(a){if(a===void 0||G9.has(a))return t(a);const h=Tu.get(i);return a in h.cache||(h.cache[a]=t(a)),h.enable?h.cache[a]:t(a)},Object.defineProperty(i[e],"name",{value:`${e}-from-cache`,configurable:!1})}function X9(i,e,t){if(!i[e])return;const r=i[e].bind(i);i[e]=function(...h){const y=Tu.get(i),{valueChanged:s,oldValue:T}=t(y._updateCache,...h);return s&&r(...h),T},Object.defineProperty(i[e],"name",{value:`${e}-to-cache`,configurable:!1})}function Z9(i){const e=i.useProgram.bind(i);i.useProgram=function(r){const a=Tu.get(i);a.program!==r&&(e(r),a.program=r)}}function Y9(i,e,t){let r="";const a={preserveDrawingBuffer:!0,...t};let h=null;if(h||(h=i.getContext("webgl2",a)),a.failIfMajorPerformanceCaveat&&(r||(r="Only software GPU is available. Set `failIfMajorPerformanceCaveat: false` to allow.")),!h&&!t.failIfMajorPerformanceCaveat&&(a.failIfMajorPerformanceCaveat=!1,h=i.getContext("webgl2",a),h.luma||(h.luma={}),h.luma.softwareRenderer=!0),h||(h=i.getContext("webgl",{}),h&&(h=null,r||(r="Your browser only supports WebGL1"))),!h)throw r||(r="Your browser does not support WebGL"),new Error(`Failed to create WebGL context: ${r}`);const{onContextLost:y,onContextRestored:s}=e;return i.addEventListener("webglcontextlost",T=>y(T),!1),i.addEventListener("webglcontextrestored",T=>s(T),!1),h.luma||(h.luma={}),h}function Td(i,e,t){return t[e]===void 0&&(t[e]=i.getExtension(e)||null),t[e]}function K9(i,e){const t=i.getParameter(7936),r=i.getParameter(7937);Td(i,"WEBGL_debug_renderer_info",e);const a=e.WEBGL_debug_renderer_info,h=i.getParameter(a?a.UNMASKED_VENDOR_WEBGL:7936),y=i.getParameter(a?a.UNMASKED_RENDERER_WEBGL:7937),s=h||t,T=y||r,B=i.getParameter(7938),F=MP(s,T),V=J9(s,T),X=Q9(s,T);return{type:"webgl",gpu:F,gpuType:X,gpuBackend:V,vendor:s,renderer:T,version:B,shadingLanguage:"glsl",shadingLanguageVersion:300}}function MP(i,e){return/NVIDIA/i.exec(i)||/NVIDIA/i.exec(e)?"nvidia":/INTEL/i.exec(i)||/INTEL/i.exec(e)?"intel":/Apple/i.exec(i)||/Apple/i.exec(e)?"apple":/AMD/i.exec(i)||/AMD/i.exec(e)||/ATI/i.exec(i)||/ATI/i.exec(e)?"amd":/SwiftShader/i.exec(i)||/SwiftShader/i.exec(e)?"software":"unknown"}function J9(i,e){return/Metal/i.exec(i)||/Metal/i.exec(e)?"metal":/ANGLE/i.exec(i)||/ANGLE/i.exec(e)?"opengl":"unknown"}function Q9(i,e){if(/SwiftShader/i.exec(i)||/SwiftShader/i.exec(e))return"cpu";switch(MP(i,e)){case"intel":return"integrated";case"software":return"cpu";case"unknown":return"unknown";default:return"discrete"}}function RP(i){switch(i){case"uint8":return 5121;case"sint8":return 5120;case"unorm8":return 5121;case"snorm8":return 5120;case"uint16":return 5123;case"sint16":return 5122;case"unorm16":return 5123;case"snorm16":return 5122;case"uint32":return 5125;case"sint32":return 5124;case"float16":return 5131;case"float32":return 5126}throw new Error(String(i))}const Hp="WEBGL_compressed_texture_s3tc",Gp="WEBGL_compressed_texture_s3tc_srgb",ld="EXT_texture_compression_rgtc",cd="EXT_texture_compression_bptc",eH="WEBGL_compressed_texture_etc",tH="WEBGL_compressed_texture_astc",iH="WEBGL_compressed_texture_etc1",rH="WEBGL_compressed_texture_pvrtc",nH="WEBGL_compressed_texture_atc",Q3="EXT_texture_norm16",eI="EXT_render_snorm",sH="EXT_color_buffer_float",dA={"float32-renderable-webgl":["EXT_color_buffer_float"],"float16-renderable-webgl":["EXT_color_buffer_half_float"],"rgb9e5ufloat-renderable-webgl":["WEBGL_render_shared_exponent"],"snorm8-renderable-webgl":[eI],"norm16-renderable-webgl":[Q3],"snorm16-renderable-webgl":[Q3,eI],"float32-filterable":["OES_texture_float_linear"],"float16-filterable-webgl":["OES_texture_half_float_linear"],"texture-filterable-anisotropic-webgl":["EXT_texture_filter_anisotropic"],"texture-blend-float-webgl":["EXT_float_blend"],"texture-compression-bc":[Hp,Gp,ld,cd],"texture-compression-bc5-webgl":[ld],"texture-compression-bc7-webgl":[cd],"texture-compression-etc2":[eH],"texture-compression-astc":[tH],"texture-compression-etc1-webgl":[iH],"texture-compression-pvrtc-webgl":[rH],"texture-compression-atc-webgl":[nH]};function oH(i){return i in dA}function aH(i,e,t){return(dA[e]||[]).every(a=>Td(i,a,t))}const fA={r8unorm:{gl:33321,rb:!0},r8snorm:{gl:36756},r8uint:{gl:33330,rb:!0},r8sint:{gl:33329,rb:!0},rg8unorm:{gl:33323,rb:!0},rg8snorm:{gl:36757},rg8uint:{gl:33336,rb:!0},rg8sint:{gl:33335,rb:!0},r16uint:{gl:33332,rb:!0},r16sint:{gl:33331,rb:!0},r16float:{gl:33325,rb:!0},"r16unorm-webgl":{gl:33322,rb:!0},"r16snorm-webgl":{gl:36760},"rgba4unorm-webgl":{gl:32854,rb:!0},"rgb565unorm-webgl":{gl:36194,rb:!0},"rgb5a1unorm-webgl":{gl:32855,rb:!0},"rgb8unorm-webgl":{gl:32849},"rgb8snorm-webgl":{gl:36758},rgba8unorm:{gl:32856},"rgba8unorm-srgb":{gl:35907},rgba8snorm:{gl:36759},rgba8uint:{gl:36220},rgba8sint:{gl:36238},bgra8unorm:{},"bgra8unorm-srgb":{},rg16uint:{gl:33338},rg16sint:{gl:33337},rg16float:{gl:33327,rb:!0},"rg16unorm-webgl":{gl:33324},"rg16snorm-webgl":{gl:36761},r32uint:{gl:33334,rb:!0},r32sint:{gl:33333,rb:!0},r32float:{gl:33326},rgb9e5ufloat:{gl:35901},rg11b10ufloat:{gl:35898,rb:!0},rgb10a2unorm:{gl:32857,rb:!0},"rgb10a2uint-webgl":{gl:36975,rb:!0},"rgb16unorm-webgl":{gl:32852},"rgb16snorm-webgl":{gl:36762},rg32uint:{gl:33340,rb:!0},rg32sint:{gl:33339,rb:!0},rg32float:{gl:33328,rb:!0},rgba16uint:{gl:36214,rb:!0},rgba16sint:{gl:36232,rb:!0},rgba16float:{gl:34842},"rgba16unorm-webgl":{gl:32859,rb:!0},"rgba16snorm-webgl":{gl:36763},"rgb32float-webgl":{gl:34837,x:sH,dataFormat:6407,types:[5126]},rgba32uint:{gl:36208,rb:!0},rgba32sint:{gl:36226,rb:!0},rgba32float:{gl:34836,rb:!0},stencil8:{gl:36168,rb:!0},depth16unorm:{gl:33189,dataFormat:6402,types:[5123],rb:!0},depth24plus:{gl:33190,dataFormat:6402,types:[5125]},depth32float:{gl:36012,dataFormat:6402,types:[5126],rb:!0},"depth24plus-stencil8":{gl:35056,rb:!0,depthTexture:!0,dataFormat:34041,types:[34042]},"depth32float-stencil8":{gl:36013,dataFormat:34041,types:[36269],rb:!0},"bc1-rgb-unorm-webgl":{gl:33776,x:Hp},"bc1-rgb-unorm-srgb-webgl":{gl:35916,x:Gp},"bc1-rgba-unorm":{gl:33777,x:Hp},"bc1-rgba-unorm-srgb":{gl:35916,x:Gp},"bc2-rgba-unorm":{gl:33778,x:Hp},"bc2-rgba-unorm-srgb":{gl:35918,x:Gp},"bc3-rgba-unorm":{gl:33779,x:Hp},"bc3-rgba-unorm-srgb":{gl:35919,x:Gp},"bc4-r-unorm":{gl:36283,x:ld},"bc4-r-snorm":{gl:36284,x:ld},"bc5-rg-unorm":{gl:36285,x:ld},"bc5-rg-snorm":{gl:36286,x:ld},"bc6h-rgb-ufloat":{gl:36495,x:cd},"bc6h-rgb-float":{gl:36494,x:cd},"bc7-rgba-unorm":{gl:36492,x:cd},"bc7-rgba-unorm-srgb":{gl:36493,x:cd},"etc2-rgb8unorm":{gl:37492},"etc2-rgb8unorm-srgb":{gl:37494},"etc2-rgb8a1unorm":{gl:37496},"etc2-rgb8a1unorm-srgb":{gl:37497},"etc2-rgba8unorm":{gl:37493},"etc2-rgba8unorm-srgb":{gl:37495},"eac-r11unorm":{gl:37488},"eac-r11snorm":{gl:37489},"eac-rg11unorm":{gl:37490},"eac-rg11snorm":{gl:37491},"astc-4x4-unorm":{gl:37808},"astc-4x4-unorm-srgb":{gl:37840},"astc-5x4-unorm":{gl:37809},"astc-5x4-unorm-srgb":{gl:37841},"astc-5x5-unorm":{gl:37810},"astc-5x5-unorm-srgb":{gl:37842},"astc-6x5-unorm":{gl:37811},"astc-6x5-unorm-srgb":{gl:37843},"astc-6x6-unorm":{gl:37812},"astc-6x6-unorm-srgb":{gl:37844},"astc-8x5-unorm":{gl:37813},"astc-8x5-unorm-srgb":{gl:37845},"astc-8x6-unorm":{gl:37814},"astc-8x6-unorm-srgb":{gl:37846},"astc-8x8-unorm":{gl:37815},"astc-8x8-unorm-srgb":{gl:37847},"astc-10x5-unorm":{gl:37819},"astc-10x5-unorm-srgb":{gl:37851},"astc-10x6-unorm":{gl:37817},"astc-10x6-unorm-srgb":{gl:37849},"astc-10x8-unorm":{gl:37818},"astc-10x8-unorm-srgb":{gl:37850},"astc-10x10-unorm":{gl:37819},"astc-10x10-unorm-srgb":{gl:37851},"astc-12x10-unorm":{gl:37820},"astc-12x10-unorm-srgb":{gl:37852},"astc-12x12-unorm":{gl:37821},"astc-12x12-unorm-srgb":{gl:37853},"pvrtc-rgb4unorm-webgl":{gl:35840},"pvrtc-rgba4unorm-webgl":{gl:35842},"pvrtc-rbg2unorm-webgl":{gl:35841},"pvrtc-rgba2unorm-webgl":{gl:35843},"etc1-rbg-unorm-webgl":{gl:36196},"atc-rgb-unorm-webgl":{gl:35986},"atc-rgba-unorm-webgl":{gl:35986},"atc-rgbai-unorm-webgl":{gl:34798}};function lH(i,e,t){let r=e.create;const a=fA[e.format];return(a==null?void 0:a.gl)===void 0&&(r=!1),a!=null&&a.x&&(r=r&&!!Td(i,a.x,t)),{format:e.format,create:r&&e.create,render:r&&e.render,filter:r&&e.filter,blend:r&&e.blend,store:r&&e.store}}function PP(i){var a;const e=fA[i],t=hH(i),r=Hw(i);return{internalFormat:t,format:(e==null?void 0:e.dataFormat)||uH(r.channels,r.integer,r.normalized,t),type:r.dataType?RP(r.dataType):((a=e==null?void 0:e.types)==null?void 0:a[0])||5121,compressed:r.compressed||!1}}function cH(i){switch(Hw(i).attachment){case"depth":return 36096;case"stencil":return 36128;case"depth-stencil":return 33306;default:throw new Error(`Not a depth stencil format: ${i}`)}}function uH(i,e,t,r){if(r===6408||r===6407)return r;switch(i){case"r":return e&&!t?36244:6403;case"rg":return e&&!t?33320:33319;case"rgb":return e&&!t?36248:6407;case"rgba":return e&&!t?36249:6408;case"bgra":throw new Error("bgra pixels not supported by WebGL");default:return 6408}}function hH(i){const e=fA[i],t=e==null?void 0:e.gl;if(t===void 0)throw new Error(`Unsupported texture format ${i}`);return t}const tI={"depth-clip-control":"EXT_depth_clamp","timer-query-webgl":"EXT_disjoint_timer_query_webgl2","compilation-status-async-webgl":"KHR_parallel_shader_compile","polygon-mode-webgl":"WEBGL_polygon_mode","provoking-vertex-webgl":"WEBGL_provoking_vertex","shader-clip-cull-distance-webgl":"WEBGL_clip_cull_distance","shader-noperspective-interpolation-webgl":"NV_shader_noperspective_interpolation","shader-conservative-depth-webgl":"EXT_conservative_depth"};class dH extends t5{constructor(t,r,a){super([],a);pe(this,"gl");pe(this,"extensions");pe(this,"testedFeatures",new Set);this.gl=t,this.extensions=r,Td(t,"EXT_color_buffer_float",r)}*[Symbol.iterator](){const t=this.getFeatures();for(const r of t)this.has(r)&&(yield r);return[]}has(t){var r;return(r=this.disabledFeatures)!=null&&r[t]?!1:(this.testedFeatures.has(t)||(this.testedFeatures.add(t),oH(t)&&aH(this.gl,t,this.extensions)&&this.features.add(t),this.getWebGLFeature(t)&&this.features.add(t)),this.features.has(t))}initializeFeatures(){const t=this.getFeatures().filter(r=>r!=="polygon-mode-webgl");for(const r of t)this.has(r)}getFeatures(){return[...Object.keys(tI),...Object.keys(dA)]}getWebGLFeature(t){const r=tI[t];return typeof r=="string"?!!Td(this.gl,r,this.extensions):!!r}}class fH extends e5{constructor(t){super();pe(this,"gl");pe(this,"limits",{});this.gl=t}get maxTextureDimension1D(){return 0}get maxTextureDimension2D(){return this.getParameter(3379)}get maxTextureDimension3D(){return this.getParameter(32883)}get maxTextureArrayLayers(){return this.getParameter(35071)}get maxBindGroups(){return 0}get maxDynamicUniformBuffersPerPipelineLayout(){return 0}get maxDynamicStorageBuffersPerPipelineLayout(){return 0}get maxSampledTexturesPerShaderStage(){return this.getParameter(35660)}get maxSamplersPerShaderStage(){return this.getParameter(35661)}get maxStorageBuffersPerShaderStage(){return 0}get maxStorageTexturesPerShaderStage(){return 0}get maxUniformBuffersPerShaderStage(){return this.getParameter(35375)}get maxUniformBufferBindingSize(){return this.getParameter(35376)}get maxStorageBufferBindingSize(){return 0}get minUniformBufferOffsetAlignment(){return this.getParameter(35380)}get minStorageBufferOffsetAlignment(){return 0}get maxVertexBuffers(){return 16}get maxVertexAttributes(){return this.getParameter(34921)}get maxVertexBufferArrayStride(){return 2048}get maxInterStageShaderComponents(){return this.getParameter(35659)}get maxComputeWorkgroupStorageSize(){return 0}get maxComputeInvocationsPerWorkgroup(){return 0}get maxComputeWorkgroupSizeX(){return 0}get maxComputeWorkgroupSizeY(){return 0}get maxComputeWorkgroupSizeZ(){return 0}get maxComputeWorkgroupsPerDimension(){return 0}getParameter(t){return this.limits[t]===void 0&&(this.limits[t]=this.gl.getParameter(t)),this.limits[t]||0}}class im extends xy{constructor(t,r){super(t,r);pe(this,"device");pe(this,"gl");pe(this,"handle");pe(this,"colorAttachments",[]);pe(this,"depthStencilAttachment",null);const a=r.handle===null;this.device=t,this.gl=t.gl,this.handle=this.props.handle||a?this.props.handle:this.gl.createFramebuffer(),a||(t.setSpectorMetadata(this.handle,{id:this.props.id,props:this.props}),this.autoCreateAttachmentTextures(),this.updateAttachments())}destroy(){super.destroy(),!this.destroyed&&this.handle!==null&&this.gl.deleteFramebuffer(this.handle)}updateAttachments(){const t=this.gl.bindFramebuffer(36160,this.handle);for(let r=0;r<this.colorAttachments.length;++r){const a=this.colorAttachments[r];if(a){const h=36064+r;this._attachTextureView(h,a)}}if(this.depthStencilAttachment){const r=cH(this.depthStencilAttachment.props.format);this._attachTextureView(r,this.depthStencilAttachment)}if(this.device.props.debug){const r=this.gl.checkFramebufferStatus(36160);if(r!==36053)throw new Error(`Framebuffer ${mH(r)}`)}this.gl.bindFramebuffer(36160,t)}_attachTextureView(t,r){const{gl:a}=this.device,{texture:h}=r,y=r.props.baseMipLevel,s=r.props.baseArrayLayer;switch(a.bindTexture(h.glTarget,h.handle),h.glTarget){case 35866:case 32879:a.framebufferTextureLayer(36160,t,h.handle,y,s);break;case 34067:const T=pH(s);a.framebufferTexture2D(36160,t,T,h.handle,y);break;case 3553:a.framebufferTexture2D(36160,t,3553,h.handle,y);break;default:throw new Error("Illegal texture type")}a.bindTexture(h.glTarget,null)}}function pH(i){return i<34069?i+34069:i}function mH(i){switch(i){case 36053:return"success";case 36054:return"Mismatched attachments";case 36055:return"No attachments";case 36057:return"Height/width mismatch";case 36061:return"Unsupported or split attachments";case 36182:return"Samples mismatch";default:return`${i}`}}class _H extends R1{constructor(t,r){super(r);pe(this,"device");pe(this,"format","rgba8unorm");pe(this,"depthStencilFormat","depth24plus");pe(this,"presentationSize");pe(this,"_framebuffer",null);this.device=t,this.presentationSize=[-1,-1],this._setAutoCreatedCanvasId(`${this.device.id}-canvas`),this.update()}get[Symbol.toStringTag](){return"WebGLCanvasContext"}getCurrentFramebuffer(){return this.update(),this._framebuffer=this._framebuffer||new im(this.device,{handle:null}),this._framebuffer}update(){const t=this.getPixelSize();(t[0]!==this.presentationSize[0]||t[1]!==this.presentationSize[1])&&(this.presentationSize=t,this.resize())}resize(t){if(this.device.gl&&this.canvas){const r=this.getDevicePixelRatio(t==null?void 0:t.useDevicePixels);this.setDevicePixelRatio(r,t);return}}commit(){}}async function BP(i,e){const t=document.getElementsByTagName("head")[0];if(!t)throw new Error("loadScript");const r=document.createElement("script");return r.setAttribute("type","text/javascript"),r.setAttribute("src",i),new Promise((a,h)=>{r.onload=a,r.onerror=y=>h(new Error(`Unable to load script '${i}': ${y}`)),t.appendChild(r)})}const gH=1;let Rr=null,iI=!1;const pA={debugSpectorJS:Gt.get("debug-spectorjs"),debugSpectorJSUrl:"https://cdn.jsdelivr.net/npm/spectorjs@0.9.30/dist/spector.bundle.js",gl:void 0};async function yH(i){if(!globalThis.SPECTOR)try{await BP(i.debugSpectorJSUrl||pA.debugSpectorJSUrl)}catch(e){Gt.warn(String(e))}}function vH(i){var e;if(i={...pA,...i},!i.debugSpectorJS)return null;if(!Rr&&globalThis.SPECTOR&&!((e=globalThis.luma)!=null&&e.spector)){Gt.probe(gH,"SPECTOR found and initialized. Start with `luma.spector.displayUI()`")();const{Spector:t}=globalThis.SPECTOR;Rr=new t,globalThis.luma&&(globalThis.luma.spector=Rr)}if(!Rr)return null;if(iI||(iI=!0,Rr.spyCanvases(),Rr==null||Rr.onCaptureStarted.add(t=>Gt.info("Spector capture started:",t)()),Rr==null||Rr.onCapture.add(t=>{Gt.info("Spector capture complete:",t)(),Rr==null||Rr.getResultUI(),Rr==null||Rr.resultView.display(),Rr==null||Rr.resultView.addCapture(t)})),i.gl){const t=i.gl,r=t.device;Rr==null||Rr.startCapture(i.gl,500),t.device=r,new Promise(a=>setTimeout(a,2e3)).then(a=>{Gt.info("Spector capture stopped after 2 seconds")(),Rr==null||Rr.stopCapture()})}return Rr}const xH="https://unpkg.com/webgl-debug@2.0.1/index.js";function DP(i){return i.luma=i.luma||{},i.luma}async function bH(){Du()&&!globalThis.WebGLDebugUtils&&(globalThis.global=globalThis.global||globalThis,globalThis.global.module={},await BP(xH))}function wH(i,e={}){return e.debugWebGL||e.traceWebGL?TH(i,e):AH(i)}function AH(i){const e=DP(i);return e.realContext?e.realContext:i}function TH(i,e){if(!globalThis.WebGLDebugUtils)return Gt.warn("webgl-debug not loaded")(),i;const t=DP(i);if(t.debugContext)return t.debugContext;globalThis.WebGLDebugUtils.init({...ad,...i});const r=globalThis.WebGLDebugUtils.makeDebugContext(i,EH.bind(null,e),SH.bind(null,e));for(const y in ad)!(y in r)&&typeof ad[y]=="number"&&(r[y]=ad[y]);class a{}Object.setPrototypeOf(r,Object.getPrototypeOf(i)),Object.setPrototypeOf(a,r);const h=Object.create(a);return t.realContext=i,t.debugContext=h,h.debug=!0,h}function rI(i,e){e=Array.from(e).map(r=>r===void 0?"undefined":r);let t=globalThis.WebGLDebugUtils.glFunctionArgsToString(i,e);return t=`${t.slice(0,100)}${t.length>100?"...":""}`,`gl.${i}(${t})`}function EH(i,e,t,r){r=Array.from(r).map(s=>s===void 0?"undefined":s);const a=globalThis.WebGLDebugUtils.glEnumToString(e),h=globalThis.WebGLDebugUtils.glFunctionArgsToString(t,r),y=`${a} in gl.${t}(${h})`;Gt.error(y)();debugger}function SH(i,e,t){let r="";Gt.level>=1&&(r=rI(e,t),i.traceWebGL&&Gt.log(1,r)());for(const a of t)if(a===void 0){r=r||rI(e,t);debugger}}const ob={};function IH(i="id"){ob[i]=ob[i]||1;const e=ob[i]++;return`${i}-${e}`}class rm extends Gr{constructor(t,r={}){super(t,r);pe(this,"device");pe(this,"gl");pe(this,"handle");pe(this,"glTarget");pe(this,"glUsage");pe(this,"glIndexType",5123);pe(this,"byteLength");pe(this,"bytesUsed");this.device=t,this.gl=this.device.gl;const a=typeof r=="object"?r.handle:void 0;this.handle=a||this.gl.createBuffer(),t.setSpectorMetadata(this.handle,{...this.props,data:typeof this.props.data}),this.glTarget=CH(this.props.usage),this.glUsage=MH(this.props.usage),this.glIndexType=this.props.indexType==="uint32"?5125:5123,r.data?this._initWithData(r.data,r.byteOffset,r.byteLength):this._initWithByteLength(r.byteLength||0)}_initWithData(t,r=0,a=t.byteLength+r){const h=this.glTarget;this.gl.bindBuffer(h,this.handle),this.gl.bufferData(h,a,this.glUsage),this.gl.bufferSubData(h,r,t),this.gl.bindBuffer(h,null),this.bytesUsed=a,this.byteLength=a,this._setDebugData(t,r,a),this.trackAllocatedMemory(a)}_initWithByteLength(t){let r=t;t===0&&(r=new Float32Array(0));const a=this.glTarget;return this.gl.bindBuffer(a,this.handle),this.gl.bufferData(a,r,this.glUsage),this.gl.bindBuffer(a,null),this.bytesUsed=t,this.byteLength=t,this._setDebugData(null,0,t),this.trackAllocatedMemory(t),this}destroy(){!this.destroyed&&this.handle&&(this.removeStats(),this.trackDeallocatedMemory(),this.gl.deleteBuffer(this.handle),this.destroyed=!0,this.handle=null)}write(t,r=0){this.gl.bindBuffer(36663,this.handle),this.gl.bufferSubData(36663,r,t),this.gl.bindBuffer(36663,null),this._setDebugData(t,r,t.byteLength)}async readAsync(t=0,r){return this.readSyncWebGL(t,r)}readSyncWebGL(t=0,r){r=r??this.byteLength-t;const a=new Uint8Array(r),h=0;return this.gl.bindBuffer(36662,this.handle),this.gl.getBufferSubData(36662,t,a,h,r),this.gl.bindBuffer(36662,null),this._setDebugData(a,t,r),a}}function CH(i){return i&Gr.INDEX?34963:i&Gr.VERTEX?34962:i&Gr.UNIFORM?35345:34962}function MH(i){return i&Gr.INDEX||i&Gr.VERTEX?35044:i&Gr.UNIFORM?35048:35044}function RH(i){const e=i.split(/\r?\n/),t=[];for(const r of e){if(r.length<=1)continue;const a=r.split(":");if(a.length===2){const[V,X]=a;t.push({message:X.trim(),type:nI(V),lineNum:0,linePos:0});continue}const[h,y,s,...T]=a;let B=parseInt(s,10);isNaN(B)&&(B=0);let F=parseInt(y,10);isNaN(F)&&(F=0),t.push({message:T.join(":").trim(),type:nI(h),lineNum:B,linePos:F})}return t}function nI(i){const e=["warning","error","info"],t=i.toLowerCase();return e.includes(t)?t:"info"}class PH extends yy{constructor(t,r){super(t,r);pe(this,"device");pe(this,"handle");switch(this.device=t,this.props.stage){case"vertex":this.handle=this.props.handle||this.device.gl.createShader(35633);break;case"fragment":this.handle=this.props.handle||this.device.gl.createShader(35632);break;default:throw new Error(this.props.stage)}this._compile(this.source)}destroy(){this.handle&&(this.removeStats(),this.device.gl.deleteShader(this.handle),this.destroyed=!0)}get asyncCompilationStatus(){return this._waitForCompilationComplete().then(()=>this.compilationStatus)}async getCompilationInfo(){return await this._waitForCompilationComplete(),this.getCompilationInfoSync()}getCompilationInfoSync(){const t=this.device.gl.getShaderInfoLog(this.handle);return t?RH(t):[]}getTranslatedSource(){const r=this.device.getExtension("WEBGL_debug_shaders").WEBGL_debug_shaders;return(r==null?void 0:r.getTranslatedShaderSource(this.handle))||null}async _compile(t){t=t.startsWith("#version ")?t:`#version 300 es
${t}`;const{gl:r}=this.device;if(r.shaderSource(this.handle,t),r.compileShader(this.handle),!this.device.props.debug){this.compilationStatus="pending";return}if(!this.device.features.has("compilation-status-async-webgl")){if(this._getCompilationStatus(),this.debugShader(),this.compilationStatus==="error")throw new Error(`GLSL compilation errors in ${this.props.stage} shader ${this.props.id}`);return}Gt.once(1,"Shader compilation is asynchronous")(),await this._waitForCompilationComplete(),Gt.info(2,`Shader ${this.id} - async compilation complete: ${this.compilationStatus}`)(),this._getCompilationStatus(),this.debugShader()}async _waitForCompilationComplete(){const t=async h=>await new Promise(y=>setTimeout(y,h));if(!this.device.features.has("compilation-status-async-webgl")){await t(10);return}const{gl:a}=this.device;for(;;){if(a.getShaderParameter(this.handle,37297))return;await t(10)}}_getCompilationStatus(){this.compilationStatus=this.device.gl.getShaderParameter(this.handle,35713)?"success":"error"}}function BH(i,e,t,r){if(kH(e))return r(i);const a=i;a.pushState();try{return DH(i,e),Rd(a.gl,t),r(i)}finally{a.popState()}}function DH(i,e){const t=i,{gl:r}=t;if(e.cullMode)switch(e.cullMode){case"none":r.disable(2884);break;case"front":r.enable(2884),r.cullFace(1028);break;case"back":r.enable(2884),r.cullFace(1029);break}if(e.frontFace&&r.frontFace(Eu("frontFace",e.frontFace,{ccw:2305,cw:2304})),e.unclippedDepth&&i.features.has("depth-clip-control")&&r.enable(34383),e.depthBias!==void 0&&(r.enable(32823),r.polygonOffset(e.depthBias,e.depthBiasSlopeScale||0)),e.provokingVertex&&i.features.has("provoking-vertex-webgl")){const h=t.getExtension("WEBGL_provoking_vertex").WEBGL_provoking_vertex,y=Eu("provokingVertex",e.provokingVertex,{first:36429,last:36430});h==null||h.provokingVertexWEBGL(y)}if((e.polygonMode||e.polygonOffsetLine)&&i.features.has("polygon-mode-webgl")){if(e.polygonMode){const h=t.getExtension("WEBGL_polygon_mode").WEBGL_polygon_mode,y=Eu("polygonMode",e.polygonMode,{fill:6914,line:6913});h==null||h.polygonModeWEBGL(1028,y),h==null||h.polygonModeWEBGL(1029,y)}e.polygonOffsetLine&&r.enable(10754)}if(i.features.has("shader-clip-cull-distance-webgl")&&(e.clipDistance0&&r.enable(12288),e.clipDistance1&&r.enable(12289),e.clipDistance2&&r.enable(12290),e.clipDistance3&&r.enable(12291),e.clipDistance4&&r.enable(12292),e.clipDistance5&&r.enable(12293),e.clipDistance6&&r.enable(12294),e.clipDistance7&&r.enable(12295)),e.depthWriteEnabled!==void 0&&r.depthMask(FH("depthWriteEnabled",e.depthWriteEnabled)),e.depthCompare&&(e.depthCompare!=="always"?r.enable(2929):r.disable(2929),r.depthFunc(rw("depthCompare",e.depthCompare))),e.stencilWriteMask){const a=e.stencilWriteMask;r.stencilMaskSeparate(1028,a),r.stencilMaskSeparate(1029,a)}if(e.stencilReadMask&&Gt.warn("stencilReadMask not supported under WebGL"),e.stencilCompare){const a=e.stencilReadMask||4294967295,h=rw("depthCompare",e.stencilCompare);e.stencilCompare!=="always"?r.enable(2960):r.disable(2960),r.stencilFuncSeparate(1028,h,0,a),r.stencilFuncSeparate(1029,h,0,a)}if(e.stencilPassOperation&&e.stencilFailOperation&&e.stencilDepthFailOperation){const a=ab("stencilPassOperation",e.stencilPassOperation),h=ab("stencilFailOperation",e.stencilFailOperation),y=ab("stencilDepthFailOperation",e.stencilDepthFailOperation);r.stencilOpSeparate(1028,h,y,a),r.stencilOpSeparate(1029,h,y,a)}switch(e.blend){case!0:r.enable(3042);break;case!1:r.disable(3042);break}if(e.blendColorOperation||e.blendAlphaOperation){const a=sI("blendColorOperation",e.blendColorOperation||"add"),h=sI("blendAlphaOperation",e.blendAlphaOperation||"add");r.blendEquationSeparate(a,h);const y=Fg("blendColorSrcFactor",e.blendColorSrcFactor||"one"),s=Fg("blendColorDstFactor",e.blendColorDstFactor||"zero"),T=Fg("blendAlphaSrcFactor",e.blendAlphaSrcFactor||"one"),B=Fg("blendAlphaDstFactor",e.blendAlphaDstFactor||"zero");r.blendFuncSeparate(y,s,T,B)}}function rw(i,e){return Eu(i,e,{never:512,less:513,equal:514,"less-equal":515,greater:516,"not-equal":517,"greater-equal":518,always:519})}function ab(i,e){return Eu(i,e,{keep:7680,zero:0,replace:7681,invert:5386,"increment-clamp":7682,"decrement-clamp":7683,"increment-wrap":34055,"decrement-wrap":34056})}function sI(i,e){return Eu(i,e,{add:32774,subtract:32778,"reverse-subtract":32779,min:32775,max:32776})}function Fg(i,e){return Eu(i,e,{one:1,zero:0,"src-color":768,"one-minus-src-color":769,"dst-color":774,"one-minus-dst-color":775,"src-alpha":770,"one-minus-src-alpha":771,"dst-alpha":772,"one-minus-dst-alpha":773,"src-alpha-saturated":776,"constant-color":32769,"one-minus-constant-color":32770,"constant-alpha":32771,"one-minus-constant-alpha":32772})}function OH(i,e){return`Illegal parameter ${e} for ${i}`}function Eu(i,e,t){if(!(e in t))throw new Error(OH(i,e));return t[e]}function FH(i,e){return e}function kH(i){let e=!0;for(const t in i){e=!1;break}return e}function OP(i){const e={};return i.addressModeU&&(e[10242]=lb(i.addressModeU)),i.addressModeV&&(e[10243]=lb(i.addressModeV)),i.addressModeW&&(e[32882]=lb(i.addressModeW)),i.magFilter&&(e[10240]=nw(i.magFilter)),(i.minFilter||i.mipmapFilter)&&(e[10241]=LH(i.minFilter||"linear",i.mipmapFilter)),i.lodMinClamp!==void 0&&(e[33082]=i.lodMinClamp),i.lodMaxClamp!==void 0&&(e[33083]=i.lodMaxClamp),i.type==="comparison-sampler"&&(e[34892]=34894),i.compare&&(e[34893]=rw("compare",i.compare)),i.maxAnisotropy&&(e[34046]=i.maxAnisotropy),e}function lb(i){switch(i){case"clamp-to-edge":return 33071;case"repeat":return 10497;case"mirror-repeat":return 33648}}function nw(i){switch(i){case"nearest":return 9728;case"linear":return 9729}}function LH(i,e="none"){if(!e)return nw(i);switch(e){case"none":return nw(i);case"nearest":return i==="nearest"?9984:9986;case"linear":return i==="nearest"?9985:9987}}class sw extends vy{constructor(t,r){super(t,r);pe(this,"device");pe(this,"handle");pe(this,"parameters");this.device=t,this.parameters=OP(r),this.handle=this.handle||this.device.gl.createSampler(),this._setSamplerParameters(this.parameters)}destroy(){this.handle&&(this.device.gl.deleteSampler(this.handle),this.handle=void 0)}toString(){return`Sampler(${this.id},${JSON.stringify(this.props)})`}_setSamplerParameters(t){for(const[r,a]of Object.entries(t)){const h=Number(r);switch(h){case 33082:case 33083:this.device.gl.samplerParameterf(this.handle,h,a);break;default:this.device.gl.samplerParameteri(this.handle,h,a);break}}}}class ud extends gy{constructor(t,r){super(t,{...en.defaultProps,...r});pe(this,"device");pe(this,"gl");pe(this,"handle");pe(this,"texture");this.device=t,this.gl=this.device.gl,this.handle=null,this.texture=r.texture}}const NH="Failed to deduce GL constant from typed array";function zH(i){switch(ArrayBuffer.isView(i)?i.constructor:i){case Float32Array:return 5126;case Uint16Array:return 5123;case Uint32Array:return 5125;case Uint8Array:return 5121;case Uint8ClampedArray:return 5121;case Int8Array:return 5120;case Int16Array:return 5122;case Int32Array:return 5124;default:throw new Error(NH)}}function UH(i,e){const{clamped:t=!0}=e||{};switch(i){case 5126:return Float32Array;case 5123:case 33635:case 32819:case 32820:return Uint16Array;case 5125:return Uint32Array;case 5121:return t?Uint8ClampedArray:Uint8Array;case 5120:return Int8Array;case 5122:return Int16Array;case 5124:return Int32Array;default:throw new Error("Failed to deduce typed array type from GL constant")}}function FP(i){switch(i){case 6406:case 33326:case 6403:case 36244:return 1;case 33339:case 33340:case 33328:case 33320:case 33319:return 2;case 6407:case 36248:case 34837:return 3;case 6408:case 36249:case 34836:return 4;default:return 0}}function VH(i){switch(i){case 5121:return 1;case 33635:case 32819:case 32820:return 2;case 5126:return 4;default:return 0}}function Ly(i,e,t){if(jH(e))return t(i);const{nocatch:r=!0}=e,a=Tu.get(i);a.push(),Rd(i,e);let h;if(r)h=t(i),a.pop();else try{h=t(i)}finally{a.pop()}return h}function jH(i){for(const e in i)return!1;return!0}function HH(i,e,t){const{dimension:r,width:a,height:h,depth:y=0}=t,{glInternalFormat:s}=t,T=t.glTarget;switch(r){case"2d-array":case"3d":i.texStorage3D(T,e,s,a,h,y);break;default:i.texStorage2D(T,e,s,a,h)}}function oI(i,e,t,r){const{width:a,height:h}=r,{dimension:y,depth:s=0,mipLevel:T=0}=r,{x:B=0,y:F=0,z:V=0}=r,{glFormat:X,glType:se}=r,ne=kP(r.glTarget,y,s),K=r.flipY?{37440:!0}:{};Ly(i,K,()=>{switch(y){case"2d-array":case"3d":i.bindTexture(ne,e),i.texSubImage3D(ne,T,B,F,V,a,h,s,X,se,t),i.bindTexture(ne,null);break;case"2d":case"cube":i.bindTexture(ne,e),i.texSubImage2D(ne,T,B,F,a,h,X,se,t),i.bindTexture(ne,null);break;default:throw new Error(y)}})}function aI(i,e,t){const{dimension:r,width:a,height:h,depth:y=0,mipLevel:s=0,byteOffset:T=0}=t,{x:B=0,y:F=0,z:V=0}=t,{glFormat:X,glType:se,compressed:ne}=t,K=kP(t.glTarget,r,y);switch(r){case"2d-array":case"3d":ne?i.compressedTexSubImage3D(K,s,B,F,V,a,h,y,X,e,T):i.texSubImage3D(K,s,B,F,V,a,h,y,X,se,e,T);break;case"2d":case"cube":ne?i.compressedTexSubImage2D(K,s,B,F,a,h,X,e,T):i.texSubImage2D(K,s,B,F,a,h,X,se,e,T);break;default:throw new Error(r)}}function GH(i){switch(i){case"1d":break;case"2d":return 3553;case"3d":return 32879;case"cube":return 34067;case"2d-array":return 35866}throw new Error(i)}function kP(i,e,t){return e==="cube"?34069+t:i}function $H(i,e){var _e;const{sourceX:t=0,sourceY:r=0,sourceAttachment:a=0}=e||{};let{target:h=null,sourceWidth:y,sourceHeight:s,sourceDepth:T,sourceFormat:B,sourceType:F}=e||{};const{framebuffer:V,deleteFramebuffer:X}=LP(i),{gl:se,handle:ne}=V;y||(y=V.width),s||(s=V.height);const K=(_e=V.colorAttachments[a])==null?void 0:_e.texture;if(!K)throw new Error(`Invalid framebuffer attachment ${a}`);T=(K==null?void 0:K.depth)||1,B||(B=(K==null?void 0:K.glFormat)||6408),F||(F=(K==null?void 0:K.glType)||5121),h=XH(h,F,B,y,s),F=F||zH(h);const ue=se.bindFramebuffer(36160,ne);return se.readBuffer(36064+a),se.readPixels(t,r,y,s,B,F,h),se.readBuffer(36064),se.bindFramebuffer(36160,ue||null),X&&V.destroy(),h}function WH(i,e){const{target:t,sourceX:r=0,sourceY:a=0,sourceFormat:h=6408,targetByteOffset:y=0}=e||{};let{sourceWidth:s,sourceHeight:T,sourceType:B}=e||{};const{framebuffer:F,deleteFramebuffer:V}=LP(i);s=s||F.width,T=T||F.height;const X=F;B=B||5121;let se=t;if(!se){const K=FP(h),ue=VH(B),_e=y+s*T*K*ue;se=X.device.createBuffer({byteLength:_e})}const ne=i.device.createCommandEncoder();return ne.copyTextureToBuffer({sourceTexture:i,width:s,height:T,origin:[r,a],destinationBuffer:se,byteOffset:y}),ne.destroy(),V&&F.destroy(),se}function LP(i){return i instanceof xy?{framebuffer:i,deleteFramebuffer:!1}:{framebuffer:qH(i),deleteFramebuffer:!0}}function qH(i,e){const{device:t,width:r,height:a,id:h}=i;return t.createFramebuffer({...e,id:`framebuffer-for-${h}`,width:r,height:a,colorAttachments:[i]})}function XH(i,e,t,r,a,h){if(i)return i;e||(e=5121);const y=UH(e,{clamped:!1}),s=FP(t);return new y(r*a*s)}class nm extends en{constructor(t,r){super(t,r);pe(this,"device");pe(this,"gl");pe(this,"handle");pe(this,"sampler");pe(this,"view");pe(this,"mipmaps");pe(this,"compressed");pe(this,"glTarget");pe(this,"glFormat");pe(this,"glType");pe(this,"glInternalFormat");pe(this,"textureUnit",0);const a={...this.props};a.data=r.data,this.device=t,this.gl=this.device.gl,this.glTarget=GH(this.props.dimension);const h=PP(this.props.format);this.glInternalFormat=h.internalFormat,this.glFormat=h.format,this.glType=h.type,this.compressed=h.compressed,this.mipmaps=!!this.props.mipmaps,this._initialize(a),Object.seal(this)}_initialize(t){this.handle=this.props.handle||this.gl.createTexture(),this.device.setSpectorMetadata(this.handle,{...this.props,data:t.data});let{width:r,height:a}=t;if(!r||!a){const h=en.getTextureDataSize(t.data);r=(h==null?void 0:h.width)||1,a=(h==null?void 0:h.height)||1}if(this.width=r,this.height=a,this.depth=t.depth,this.setSampler(t.sampler),this.view=new ud(this.device,{...this.props,texture:this}),this.bind(),HH(this.gl,this.mipLevels,this),t.data)switch(t.dimension){case"1d":this.setTexture1DData(t.data);break;case"2d":this.setTexture2DData(t.data);break;case"3d":this.setTexture3DData(t.data);break;case"cube":this.setTextureCubeData(t.data);break;case"2d-array":this.setTextureArrayData(t.data);break;case"cube-array":this.setTextureCubeArrayData(t.data);break;default:throw new Error(t.dimension)}this.mipmaps&&this.generateMipmap()}destroy(){this.handle&&(this.gl.deleteTexture(this.handle),this.removeStats(),this.trackDeallocatedMemory("Texture"),this.destroyed=!0)}createView(t){return new ud(this.device,{...t,texture:this})}setSampler(t={}){let r;t instanceof sw?(this.sampler=t,r=t.props):(this.sampler=new sw(this.device,t),r=t);const a=OP(r);this._setSamplerParameters(a)}generateMipmap(t){if(!(!(this.device.isTextureFormatRenderable(this.props.format)&&this.device.isTextureFormatFilterable(this.props.format))&&(Gt.warn(`${this} is not renderable or filterable, may not be able to generate mipmaps`)(),!(t!=null&&t.force))))try{this.gl.bindTexture(this.glTarget,this.handle),this.gl.generateMipmap(this.glTarget)}catch(a){Gt.warn(`Error generating mipmap for ${this}: ${a.message}`)()}finally{this.gl.bindTexture(this.glTarget,null)}}copyExternalImage(t){const r=en.getExternalImageSize(t.image),a={...en.defaultCopyExternalImageOptions,...r,...t},{image:h,depth:y,mipLevel:s,x:T,y:B,z:F,flipY:V}=a;let{width:X,height:se}=a;const{dimension:ne,glTarget:K,glFormat:ue,glInternalFormat:_e,glType:ke}=this;if(X=Math.min(X,this.width-T),se=Math.min(se,this.height-B),t.sourceX||t.sourceY)throw new Error("WebGL does not support sourceX/sourceY)");return oI(this.device.gl,this.handle,h,{dimension:ne,mipLevel:s,x:T,y:B,z:F,width:X,height:se,depth:y,glFormat:ue,glType:ke,glTarget:K,flipY:V}),{width:a.width,height:a.height}}setTexture1DData(t){throw new Error("setTexture1DData not supported in WebGL.")}setTexture2DData(t,r=0){this.bind();const a=en.normalizeTextureData(t,this);a.length>1&&this.props.mipmaps!==!1&&Gt.warn(`Texture ${this.id} mipmap and multiple LODs.`)();for(let h=0;h<a.length;h++){const y=a[h];this._setMipLevel(r,h,y)}this.unbind()}setTexture3DData(t){if(this.props.dimension!=="3d")throw new Error(this.id);ArrayBuffer.isView(t)&&(this.bind(),aI(this.device.gl,t,this),this.unbind())}setTextureCubeData(t,r=0){if(this.props.dimension!=="cube")throw new Error(this.id);for(const a of en.CubeFaces)this.setTextureCubeFaceData(t[a],a)}setTextureArrayData(t){throw this.props.dimension!=="2d-array"?new Error(this.id):new Error("setTextureArrayData not implemented.")}setTextureCubeArrayData(t){throw new Error("setTextureCubeArrayData not supported in WebGL2.")}setTextureCubeFaceData(t,r,a=0){Array.isArray(t)&&t.length>1&&this.props.mipmaps!==!1&&Gt.warn(`${this.id} has mipmap and multiple LODs.`)();const h=en.CubeFaces.indexOf(r);this.setTexture2DData(t,h)}update(){throw new Error("Texture.update() not implemented. Use ExternalTexture")}setImageDataForFace(t){const{face:r,width:a,height:h,pixels:y,data:s,format:T=6408,type:B=5121}=t,{gl:F}=this,V=y||s;this.bind(),V instanceof Promise?V.then(X=>this.setImageDataForFace(Object.assign({},t,{face:r,data:X,pixels:X}))):this.width||this.height?F.texImage2D(r,0,T,a,h,0,T,B,V):F.texImage2D(r,0,T,T,B,V)}_getImageDataMap(t){for(let r=0;r<en.CubeFaces.length;++r){const a=en.CubeFaces[r];t[a]&&(t[34069+r]=t[a],delete t[a])}return t}_setSamplerParameters(t){Gt.log(1,`${this.id} sampler parameters`,this.device.getGLKeys(t))(),this.gl.bindTexture(this.glTarget,this.handle);for(const[r,a]of Object.entries(t)){const h=Number(r),y=a;switch(h){case 33082:case 33083:this.gl.texParameterf(this.glTarget,h,y);break;case 10241:this.gl.texParameteri(this.glTarget,h,y);break;case 10242:case 10243:this.gl.texParameteri(this.glTarget,h,y);break;case 34046:this.device.features.has("texture-filterable-anisotropic-webgl")&&this.gl.texParameteri(this.glTarget,h,y);break;default:this.gl.texParameteri(this.glTarget,h,y);break}}this.gl.bindTexture(this.glTarget,null)}_setMipLevel(t,r,a,h=this.glTarget){if(en.isExternalImage(a)){oI(this.device.gl,this.handle,a,{...this,depth:t,mipLevel:r,glTarget:h,flipY:this.props.flipY});return}if(en.isTextureLevelData(a)){aI(this.device.gl,a.data,{...this,depth:t,mipLevel:r,glTarget:h});return}throw new Error("Texture: invalid image data")}getActiveUnit(){return this.gl.getParameter(34016)-33984}bind(t){const{gl:r}=this;return t!==void 0&&(this.textureUnit=t,r.activeTexture(33984+t)),r.bindTexture(this.glTarget,this.handle),t}unbind(t){const{gl:r}=this;return t!==void 0&&(this.textureUnit=t,r.activeTexture(33984+t)),r.bindTexture(this.glTarget,null),t}}const ZH=[1,2,4,8];class YH extends P1{constructor(t,r){var y;super(t,r);pe(this,"device");pe(this,"glParameters");this.device=t;let a;if(!((y=r==null?void 0:r.parameters)!=null&&y.viewport))if(r!=null&&r.framebuffer){const{width:s,height:T}=r.framebuffer;a=[0,0,s,T]}else{const[s,T]=t.getCanvasContext().getDrawingBufferSize();a=[0,0,s,T]}this.device.pushState(),this.setParameters({viewport:a,...this.props.parameters});const h=this.props.framebuffer;if(h!=null&&h.handle)if(this.props.framebuffer){const s=this.props.framebuffer.colorAttachments.map((T,B)=>36064+B);this.device.gl.drawBuffers(s)}else this.device.gl.drawBuffers([1029]);this.clear()}end(){this.device.popState()}pushDebugGroup(t){}popDebugGroup(){}insertDebugMarker(t){}setParameters(t={}){const r={...this.glParameters};r.framebuffer=this.props.framebuffer||null,this.props.depthReadOnly&&(r.depthMask=!this.props.depthReadOnly),r.stencilMask=this.props.stencilReadOnly?0:1,r[35977]=this.props.discard,t.viewport&&(t.viewport.length>=6?(r.viewport=t.viewport.slice(0,4),r.depthRange=[t.viewport[4],t.viewport[5]]):r.viewport=t.viewport),t.scissorRect&&(r.scissorTest=!0,r.scissor=t.scissorRect),t.blendConstant&&(r.blendColor=t.blendConstant),t.stencilReference&&(console.warn("RenderPassParameters.stencilReference not yet implemented in WebGL"),t[2967]=t.stencilReference),t.colorMask&&(r.colorMask=ZH.map(a=>!!(a&t.colorMask))),this.glParameters=r,Rd(this.device.gl,r)}beginOcclusionQuery(t){const r=this.props.occlusionQuerySet;r==null||r.beginOcclusionQuery()}endOcclusionQuery(){const t=this.props.occlusionQuerySet;t==null||t.endOcclusionQuery()}clear(){const t={...this.glParameters};let r=0;this.props.clearColors&&this.props.clearColors.forEach((a,h)=>{a&&this.clearColorBuffer(h,a)}),this.props.clearColor!==!1&&this.props.clearColors===void 0&&(r|=16384,t.clearColor=this.props.clearColor),this.props.clearDepth!==!1&&(r|=256,t.clearDepth=this.props.clearDepth),this.props.clearStencil!==!1&&(r|=1024,t.clearStencil=this.props.clearStencil),r!==0&&Ly(this.device.gl,t,()=>{this.device.gl.clear(r)})}clearColorBuffer(t=0,r=[0,0,0,0]){Ly(this.device.gl,{framebuffer:this.props.framebuffer},()=>{switch(r.constructor){case Int8Array:case Int16Array:case Int32Array:this.device.gl.clearBufferiv(6144,t,r);break;case Uint8Array:case Uint8ClampedArray:case Uint16Array:case Uint32Array:this.device.gl.clearBufferuiv(6144,t,r);break;case Float32Array:this.device.gl.clearBufferfv(6144,t,r);break;default:throw new Error("clearColorBuffer: color must be typed array")}})}}function KH(i){return JH.includes(i)}const JH=[35678,35680,35679,35682,36289,36292,36293,36298,36299,36300,36303,36306,36307,36308,36311],NP={5126:[5126,1,"float","f32","float32"],35664:[5126,2,"vec2","vec2<f32>","float32x2"],35665:[5126,3,"vec3","vec3<f32>","float32x3"],35666:[5126,4,"vec4","vec4<f32>","float32x4"],5124:[5124,1,"int","i32","sint32"],35667:[5124,2,"ivec2","vec2<i32>","sint32x2"],35668:[5124,3,"ivec3","vec3<i32>","sint32x3"],35669:[5124,4,"ivec4","vec4<i32>","sint32x4"],5125:[5125,1,"uint","u32","uint32"],36294:[5125,2,"uvec2","vec2<u32>","uint32x2"],36295:[5125,3,"uvec3","vec3<u32>","uint32x3"],36296:[5125,4,"uvec4","vec4<u32>","uint32x4"],35670:[5126,1,"bool","f32","float32"],35671:[5126,2,"bvec2","vec2<f32>","float32x2"],35672:[5126,3,"bvec3","vec3<f32>","float32x3"],35673:[5126,4,"bvec4","vec4<f32>","float32x4"],35674:[5126,8,"mat2","mat2x2<f32>"],35685:[5126,8,"mat2x3","mat2x3<f32>"],35686:[5126,8,"mat2x4","mat2x4<f32>"],35687:[5126,12,"mat3x2","mat3x2<f32>"],35675:[5126,12,"mat3","mat3x3<f32>"],35688:[5126,12,"mat3x4","mat3x4<f32>"],35689:[5126,16,"mat4x2","mat4x2<f32>"],35690:[5126,16,"mat4x3","mat4x3<f32>"],35676:[5126,16,"mat4","mat4x4<f32>"]};function zP(i){const e=NP[i];if(!e)throw new Error("uniform");const[t,r,,a]=e;return{format:a,components:r,glType:t}}function QH(i){const e=NP[i];if(!e)throw new Error("attribute");const[,t,,r,a]=e;return{attributeType:r,vertexFormat:a,components:t}}function eG(i,e){const t={attributes:[],bindings:[]};t.attributes=tG(i,e);const r=nG(i,e);for(const s of r){const T=s.uniforms.map(B=>({name:B.name,format:B.format,byteOffset:B.byteOffset,byteStride:B.byteStride,arrayLength:B.arrayLength}));t.bindings.push({type:"uniform",name:s.name,group:0,location:s.location,visibility:(s.vertex?1:0)&(s.fragment?2:0),minBindingSize:s.byteLength,uniforms:T})}const a=rG(i,e);let h=0;for(const s of a)if(KH(s.type)){const{viewDimension:T,sampleType:B}=oG(s.type);t.bindings.push({type:"texture",name:s.name,group:0,location:h,viewDimension:T,sampleType:B}),s.textureUnit=h,h+=1}a.length&&(t.uniforms=a);const y=iG(i,e);return y!=null&&y.length&&(t.varyings=y),t}function tG(i,e){const t=[],r=i.getProgramParameter(e,35721);for(let a=0;a<r;a++){const h=i.getActiveAttrib(e,a);if(!h)throw new Error("activeInfo");const{name:y,type:s}=h,T=i.getAttribLocation(e,y);if(T>=0){const{attributeType:B}=QH(s),F=/instance/i.test(y)?"instance":"vertex";t.push({name:y,location:T,stepMode:F,type:B})}}return t.sort((a,h)=>a.location-h.location),t}function iG(i,e){const t=[],r=i.getProgramParameter(e,35971);for(let a=0;a<r;a++){const h=i.getTransformFeedbackVarying(e,a);if(!h)throw new Error("activeInfo");const{name:y,type:s,size:T}=h,{glType:B,components:F}=zP(s),V={location:a,name:y,type:B,size:T*F};t.push(V)}return t.sort((a,h)=>a.location-h.location),t}function rG(i,e){const t=[],r=i.getProgramParameter(e,35718);for(let a=0;a<r;a++){const h=i.getActiveUniform(e,a);if(!h)throw new Error("activeInfo");const{name:y,size:s,type:T}=h,{name:B,isArray:F}=aG(y);let V=i.getUniformLocation(e,B);const X={location:V,name:B,size:s,type:T,isArray:F};if(t.push(X),X.size>1)for(let se=0;se<X.size;se++){const ne=`${B}[${se}]`;V=i.getUniformLocation(e,ne);const K={...X,name:ne,location:V};t.push(K)}}return t}function nG(i,e){const t=(h,y)=>i.getActiveUniformBlockParameter(e,h,y),r=[],a=i.getProgramParameter(e,35382);for(let h=0;h<a;h++){const y={name:i.getActiveUniformBlockName(e,h)||"",location:t(h,35391),byteLength:t(h,35392),vertex:t(h,35396),fragment:t(h,35398),uniformCount:t(h,35394),uniforms:[]},s=t(h,35395)||[],T=i.getActiveUniforms(e,s,35383),B=i.getActiveUniforms(e,s,35384),F=i.getActiveUniforms(e,s,35387),V=i.getActiveUniforms(e,s,35388);for(let X=0;X<y.uniformCount;++X){const se=i.getActiveUniform(e,s[X]);if(!se)throw new Error("activeInfo");y.uniforms.push({name:se.name,format:zP(T[X]).format,type:T[X],arrayLength:B[X],byteOffset:F[X],byteStride:V[X]})}r.push(y)}return r.sort((h,y)=>h.location-y.location),r}const sG={35678:["2d","float"],35680:["cube","float"],35679:["3d","float"],35682:["3d","depth"],36289:["2d-array","float"],36292:["2d-array","depth"],36293:["cube","float"],36298:["2d","sint"],36299:["3d","sint"],36300:["cube","sint"],36303:["2d-array","uint"],36306:["2d","uint"],36307:["3d","uint"],36308:["cube","uint"],36311:["2d-array","uint"]};function oG(i){const e=sG[i];if(!e)throw new Error("sampler");const[t,r]=e;return{viewDimension:t,sampleType:r}}function aG(i){if(i[i.length-1]!=="]")return{name:i,length:1,isArray:!1};const t=/([^[]*)(\[[0-9]+\])?/.exec(i);if(!t||t.length<2)throw new Error(`Failed to parse GLSL uniform name ${i}`);return{name:t[1],length:t[2]?1:0,isArray:!!t[2]}}function lG(i,e,t,r){const a=i;let h=r;h===!0&&(h=1),h===!1&&(h=0);const y=typeof h=="number"?[h]:h;switch(t){case 35678:case 35680:case 35679:case 35682:case 36289:case 36292:case 36293:case 36298:case 36299:case 36300:case 36303:case 36306:case 36307:case 36308:case 36311:if(typeof r!="number")throw new Error("samplers must be set to integers");return i.uniform1i(e,r);case 5126:return i.uniform1fv(e,y);case 35664:return i.uniform2fv(e,y);case 35665:return i.uniform3fv(e,y);case 35666:return i.uniform4fv(e,y);case 5124:return i.uniform1iv(e,y);case 35667:return i.uniform2iv(e,y);case 35668:return i.uniform3iv(e,y);case 35669:return i.uniform4iv(e,y);case 35670:return i.uniform1iv(e,y);case 35671:return i.uniform2iv(e,y);case 35672:return i.uniform3iv(e,y);case 35673:return i.uniform4iv(e,y);case 5125:return a.uniform1uiv(e,y,1);case 36294:return a.uniform2uiv(e,y,2);case 36295:return a.uniform3uiv(e,y,3);case 36296:return a.uniform4uiv(e,y,4);case 35674:return i.uniformMatrix2fv(e,!1,y);case 35675:return i.uniformMatrix3fv(e,!1,y);case 35676:return i.uniformMatrix4fv(e,!1,y);case 35685:return a.uniformMatrix2x3fv(e,!1,y);case 35686:return a.uniformMatrix2x4fv(e,!1,y);case 35687:return a.uniformMatrix3x2fv(e,!1,y);case 35688:return a.uniformMatrix3x4fv(e,!1,y);case 35689:return a.uniformMatrix4x2fv(e,!1,y);case 35690:return a.uniformMatrix4x3fv(e,!1,y)}throw new Error("Illegal uniform")}function cG(i){return yP(i)!==null||typeof i=="number"||typeof i=="boolean"}function uG(i){const e={bindings:{},uniforms:{}};return Object.keys(i).forEach(t=>{const r=i[t];cG(r)?e.uniforms[t]=r:e.bindings[t]=r}),e}function hG(i){switch(i){case"point-list":return 0;case"line-list":return 1;case"line-strip":return 3;case"triangle-list":return 4;case"triangle-strip":return 5;default:throw new Error(i)}}function dG(i){switch(i){case"point-list":return 0;case"line-list":return 1;case"line-strip":return 1;case"triangle-list":return 4;case"triangle-strip":return 4;default:throw new Error(i)}}const lI=4;class fG extends xd{constructor(t,r){super(t,r);pe(this,"device");pe(this,"handle");pe(this,"vs");pe(this,"fs");pe(this,"introspectedLayout");pe(this,"uniforms",{});pe(this,"bindings",{});pe(this,"varyings",null);pe(this,"_uniformCount",0);pe(this,"_uniformSetters",{});this.device=t,this.handle=this.props.handle||this.device.gl.createProgram(),this.device.setSpectorMetadata(this.handle,{id:this.props.id}),this.vs=r.vs,this.fs=r.fs;const{varyings:a,bufferMode:h=35981}=r;a&&a.length>0&&(this.varyings=a,this.device.gl.transformFeedbackVaryings(this.handle,a,h)),this._linkShaders(),Gt.time(1,`RenderPipeline ${this.id} - shaderLayout introspection`)(),this.introspectedLayout=eG(this.device.gl,this.handle),Gt.timeEnd(1,`RenderPipeline ${this.id} - shaderLayout introspection`)(),this.shaderLayout=pG(this.introspectedLayout,r.shaderLayout)}destroy(){this.handle&&(this.device.gl.deleteProgram(this.handle),this.destroyed=!0)}setBindings(t,r){for(const[a,h]of Object.entries(t)){const y=this.shaderLayout.bindings.find(s=>s.name===a)||this.shaderLayout.bindings.find(s=>s.name===`${a}Uniforms`);if(!y){const s=this.shaderLayout.bindings.map(T=>`"${T.name}"`).join(", ");r!=null&&r.disableWarnings||Gt.warn(`No binding "${a}" in render pipeline "${this.id}", expected one of ${s}`,h)();continue}switch(h||Gt.warn(`Unsetting binding "${a}" in render pipeline "${this.id}"`)(),y.type){case"uniform":if(!(h instanceof rm)&&!(h.buffer instanceof rm))throw new Error("buffer value");break;case"texture":if(!(h instanceof ud||h instanceof nm||h instanceof im))throw new Error("texture value");break;case"sampler":Gt.warn(`Ignoring sampler ${a}`)();break;default:throw new Error(y.type)}this.bindings[a]=h}}draw(t){var ue;const{renderPass:r,parameters:a=this.props.parameters,topology:h=this.props.topology,vertexArray:y,vertexCount:s,instanceCount:T,isInstanced:B=!1,firstVertex:F=0,transformFeedback:V}=t,X=hG(h),se=!!y.indexBuffer,ne=(ue=y.indexBuffer)==null?void 0:ue.glIndexType;if(this.linkStatus!=="success")return Gt.info(2,`RenderPipeline:${this.id}.draw() aborted - waiting for shader linking`)(),!1;if(!this._areTexturesRenderable())return Gt.info(2,`RenderPipeline:${this.id}.draw() aborted - textures not yet loaded`)(),!1;this.device.gl.useProgram(this.handle),y.bindBeforeRender(r),V&&V.begin(this.props.topology),this._applyBindings(),this._applyUniforms();const K=r;return BH(this.device,a,K.glParameters,()=>{se&&B?this.device.gl.drawElementsInstanced(X,s||0,ne,F,T||0):se?this.device.gl.drawElements(X,s||0,ne,F):B?this.device.gl.drawArraysInstanced(X,F,s||0,T||0):this.device.gl.drawArrays(X,F,s||0),V&&V.end()}),y.unbindAfterRender(r),!0}setUniformsWebGL(t){const{bindings:r}=uG(t);Object.keys(r).forEach(a=>{Gt.warn(`Unsupported value "${JSON.stringify(r[a])}" used in setUniforms() for key ${a}. Use setBindings() instead?`)()}),Object.assign(this.uniforms,t)}async _linkShaders(){const{gl:t}=this.device;if(t.attachShader(this.handle,this.vs.handle),t.attachShader(this.handle,this.fs.handle),Gt.time(lI,`linkProgram for ${this.id}`)(),t.linkProgram(this.handle),Gt.timeEnd(lI,`linkProgram for ${this.id}`)(),Gt.level,!this.device.features.has("compilation-status-async-webgl")){const a=this._getLinkStatus();this._reportLinkStatus(a);return}Gt.once(1,"RenderPipeline linking is asynchronous")(),await this._waitForLinkComplete(),Gt.info(2,`RenderPipeline ${this.id} - async linking complete: ${this.linkStatus}`)();const r=this._getLinkStatus();this._reportLinkStatus(r)}async _reportLinkStatus(t){var r;switch(t){case"success":return;default:switch(this.vs.compilationStatus){case"error":throw this.vs.debugShader(),new Error(`Error during compilation of shader ${this.vs.id}`);case"pending":this.vs.asyncCompilationStatus.then(()=>this.vs.debugShader());break}switch((r=this.fs)==null?void 0:r.compilationStatus){case"error":throw this.fs.debugShader(),new Error(`Error during compilation of shader ${this.fs.id}`);case"pending":this.fs.asyncCompilationStatus.then(()=>this.fs.debugShader());break}const a=this.device.gl.getProgramInfoLog(this.handle);throw new Error(`Error during ${t}: ${a}`)}}_getLinkStatus(){const{gl:t}=this.device;return t.getProgramParameter(this.handle,35714)?(t.validateProgram(this.handle),t.getProgramParameter(this.handle,35715)?(this.linkStatus="success","success"):(this.linkStatus="error","validation")):(this.linkStatus="error","linking")}async _waitForLinkComplete(){const t=async h=>await new Promise(y=>setTimeout(y,h));if(!this.device.features.has("compilation-status-async-webgl")){await t(10);return}const{gl:a}=this.device;for(;;){if(a.getProgramParameter(this.handle,37297))return;await t(10)}}_areTexturesRenderable(){let t=!0;for(const r of this.shaderLayout.bindings)!this.bindings[r.name]&&!this.bindings[r.name.replace(/Uniforms$/,"")]&&(Gt.warn(`Binding ${r.name} not found in ${this.id}`)(),t=!1);return t}_applyBindings(){if(this.linkStatus!=="success")return;const{gl:t}=this.device;t.useProgram(this.handle);let r=0,a=0;for(const h of this.shaderLayout.bindings){const y=this.bindings[h.name]||this.bindings[h.name.replace(/Uniforms$/,"")];if(!y)throw new Error(`No value for binding ${h.name} in ${this.id}`);switch(h.type){case"uniform":const{name:s}=h,T=t.getUniformBlockIndex(this.handle,s);if(T===4294967295)throw new Error(`Invalid uniform block name ${s}`);t.uniformBlockBinding(this.handle,a,T),y instanceof rm?t.bindBufferBase(35345,a,y.handle):t.bindBufferRange(35345,a,y.buffer.handle,y.offset||0,y.size||y.buffer.byteLength-y.offset),a+=1;break;case"texture":if(!(y instanceof ud||y instanceof nm||y instanceof im))throw new Error("texture");let B;if(y instanceof ud)B=y.texture;else if(y instanceof nm)B=y;else if(y instanceof im&&y.colorAttachments[0]instanceof ud)Gt.warn("Passing framebuffer in texture binding may be deprecated. Use fbo.colorAttachments[0] instead")(),B=y.colorAttachments[0].texture;else throw new Error("No texture");t.activeTexture(33984+r),t.bindTexture(B.glTarget,B.handle),r+=1;break;case"sampler":break;case"storage":case"read-only-storage":throw new Error(`binding type '${h.type}' not supported in WebGL`)}}}_applyUniforms(){for(const t of this.shaderLayout.uniforms||[]){const{name:r,location:a,type:h,textureUnit:y}=t,s=this.uniforms[r]??y;s!==void 0&&lG(this.device.gl,a,h,s)}}}function pG(i,e){const t={...i,attributes:i.attributes.map(r=>({...r}))};for(const r of(e==null?void 0:e.attributes)||[]){const a=t.attributes.find(h=>h.name===r.name);a?(a.type=r.type||a.type,a.stepMode=r.stepMode||a.stepMode):Gt.warn(`shader layout attribute ${r.name} not present in shader`)}return t}class mG extends D1{constructor(t){super(t,{});pe(this,"device");pe(this,"commands",[]);this.device=t}submitCommands(t=this.commands){for(const r of t)switch(r.name){case"copy-buffer-to-buffer":_G(this.device,r.options);break;case"copy-buffer-to-texture":gG(this.device,r.options);break;case"copy-texture-to-buffer":yG(this.device,r.options);break;case"copy-texture-to-texture":vG(this.device,r.options);break;default:throw new Error(r.name)}}}function _G(i,e){const t=e.sourceBuffer,r=e.destinationBuffer;i.gl.bindBuffer(36662,t.handle),i.gl.bindBuffer(36663,r.handle),i.gl.copyBufferSubData(36662,36663,e.sourceOffset??0,e.destinationOffset??0,e.size),i.gl.bindBuffer(36662,null),i.gl.bindBuffer(36663,null)}function gG(i,e){throw new Error("Not implemented")}function yG(i,e){const{sourceTexture:t,mipLevel:r=0,aspect:a="all",width:h=e.sourceTexture.width,height:y=e.sourceTexture.height,depthOrArrayLayers:s=0,origin:T=[0,0],destinationBuffer:B,byteOffset:F=0,bytesPerRow:V,rowsPerImage:X}=e;if(a!=="all")throw new Error("aspect not supported in WebGL");if(r!==0||s!==0||V||X)throw new Error("not implemented");const{framebuffer:se,destroyFramebuffer:ne}=UP(t);let K;try{const ue=B,_e=h||se.width,ke=y||se.height,we=PP(se.colorAttachments[0].texture.props.format),ge=we.format,Le=we.type;i.gl.bindBuffer(35051,ue.handle),K=i.gl.bindFramebuffer(36160,se.handle),i.gl.readPixels(T[0],T[1],_e,ke,ge,Le,F)}finally{i.gl.bindBuffer(35051,null),K!==void 0&&i.gl.bindFramebuffer(36160,K),ne&&se.destroy()}}function vG(i,e){const{sourceTexture:t,destinationMipLevel:r=0,origin:a=[0,0],destinationOrigin:h=[0,0],destinationTexture:y}=e;let{width:s=e.destinationTexture.width,height:T=e.destinationTexture.height}=e;const{framebuffer:B,destroyFramebuffer:F}=UP(t),[V,X]=a,[se,ne,K]=h,ue=i.gl.bindFramebuffer(36160,B.handle);let _e=null,ke;if(y instanceof nm)_e=y,s=Number.isFinite(s)?s:_e.width,T=Number.isFinite(T)?T:_e.height,_e.bind(0),ke=_e.glTarget;else throw new Error("invalid destination");switch(ke){case 3553:case 34067:i.gl.copyTexSubImage2D(ke,r,se,ne,V,X,s,T);break;case 35866:case 32879:i.gl.copyTexSubImage3D(ke,r,se,ne,K,V,X,s,T);break}_e&&_e.unbind(),i.gl.bindFramebuffer(36160,ue),F&&B.destroy()}function UP(i){if(i instanceof en){const{width:e,height:t,id:r}=i;return{framebuffer:i.device.createFramebuffer({id:`framebuffer-for-${r}`,width:e,height:t,colorAttachments:[i]}),destroyFramebuffer:!0}}return{framebuffer:i,destroyFramebuffer:!1}}class xG extends B1{constructor(t,r){super(t,r);pe(this,"device");pe(this,"commandBuffer");this.device=t,this.commandBuffer=new mG(t)}destroy(){}finish(){this.commandBuffer.submitCommands()}copyBufferToBuffer(t){this.commandBuffer.commands.push({name:"copy-buffer-to-buffer",options:t})}copyBufferToTexture(t){this.commandBuffer.commands.push({name:"copy-buffer-to-texture",options:t})}copyTextureToBuffer(t){this.commandBuffer.commands.push({name:"copy-texture-to-buffer",options:t})}copyTextureToTexture(t){this.commandBuffer.commands.push({name:"copy-texture-to-texture",options:t})}pushDebugGroup(t){}popDebugGroup(){}insertDebugMarker(t){}resolveQuerySet(t,r,a){}}function bG(i){const{target:e,source:t,start:r=0,count:a=1}=i,h=t.length,y=a*h;let s=0;for(let T=r;s<h;s++)e[T++]=t[s];for(;s<y;)s<y-s?(e.copyWithin(r+s,r,r+s),s*=2):(e.copyWithin(r+s,r,r+y-s),s=y);return i.target}class mA extends O1{constructor(t,r){super(t,r);pe(this,"device");pe(this,"handle");pe(this,"buffer",null);pe(this,"bufferValue",null);this.device=t,this.handle=this.device.gl.createVertexArray()}get[Symbol.toStringTag](){return"VertexArray"}static isConstantAttributeZeroSupported(t){return ML()==="Chrome"}destroy(){var t;super.destroy(),this.buffer&&((t=this.buffer)==null||t.destroy()),this.handle&&(this.device.gl.deleteVertexArray(this.handle),this.handle=void 0)}setIndexBuffer(t){const r=t;if(r&&r.glTarget!==34963)throw new Error("Use .setBuffer()");this.device.gl.bindVertexArray(this.handle),this.device.gl.bindBuffer(34963,r?r.handle:null),this.indexBuffer=r,this.device.gl.bindVertexArray(null)}setBuffer(t,r){const a=r;if(a.glTarget===34963)throw new Error("Use .setIndexBuffer()");const{size:h,type:y,stride:s,offset:T,normalized:B,integer:F,divisor:V}=this._getAccessor(t);this.device.gl.bindVertexArray(this.handle),this.device.gl.bindBuffer(34962,a.handle),F?this.device.gl.vertexAttribIPointer(t,h,y,s,T):this.device.gl.vertexAttribPointer(t,h,y,B,s,T),this.device.gl.bindBuffer(34962,null),this.device.gl.enableVertexAttribArray(t),this.device.gl.vertexAttribDivisor(t,V||0),this.attributes[t]=a,this.device.gl.bindVertexArray(null)}setConstantWebGL(t,r){this._enable(t,!1),this.attributes[t]=r}bindBeforeRender(){this.device.gl.bindVertexArray(this.handle),this._applyConstantAttributes()}unbindAfterRender(){this.device.gl.bindVertexArray(null)}_applyConstantAttributes(){for(let t=0;t<this.maxVertexAttributes;++t){const r=this.attributes[t];ArrayBuffer.isView(r)&&this.device.setConstantAttributeWebGL(t,r)}}_getAccessor(t){const r=this.attributeInfos[t];if(!r)throw new Error(`Unknown attribute location ${t}`);const a=RP(r.bufferDataType);return{size:r.bufferComponents,type:a,stride:r.byteStride,offset:r.byteOffset,normalized:r.normalized,integer:r.integer,divisor:r.stepMode==="instance"?1:0}}_enable(t,r=!0){const h=mA.isConstantAttributeZeroSupported(this.device)||t!==0;(r||h)&&(t=Number(t),this.device.gl.bindVertexArray(this.handle),r?this.device.gl.enableVertexAttribArray(t):this.device.gl.disableVertexAttribArray(t),this.device.gl.bindVertexArray(null))}getConstantBuffer(t,r){const a=wG(r),h=a.byteLength*t,y=a.length*t;if(this.buffer&&h!==this.buffer.byteLength)throw new Error(`Buffer size is immutable, byte length ${h} !== ${this.buffer.byteLength}.`);let s=!this.buffer;if(this.buffer=this.buffer||this.device.createBuffer({byteLength:h}),s=s||!AG(a,this.bufferValue),s){const T=R5(r.constructor,y);bG({target:T,source:a,start:0,count:y}),this.buffer.write(T),this.bufferValue=r}return this.buffer}}function wG(i){return Array.isArray(i)?new Float32Array(i):i}function AG(i,e){if(!i||!e||i.length!==e.length||i.constructor!==e.constructor)return!1;for(let t=0;t<i.length;++t)if(i[t]!==e[t])return!1;return!0}class TG extends F1{constructor(t,r){super(t,r);pe(this,"device");pe(this,"gl");pe(this,"handle");pe(this,"layout");pe(this,"buffers",{});pe(this,"unusedBuffers",{});pe(this,"bindOnUse",!0);pe(this,"_bound",!1);this.device=t,this.gl=t.gl,this.handle=this.props.handle||this.gl.createTransformFeedback(),this.layout=this.props.layout,r.buffers&&this.setBuffers(r.buffers),Object.seal(this)}destroy(){this.gl.deleteTransformFeedback(this.handle),super.destroy()}begin(t="point-list"){this.gl.bindTransformFeedback(36386,this.handle),this.bindOnUse&&this._bindBuffers(),this.gl.beginTransformFeedback(dG(t))}end(){this.gl.endTransformFeedback(),this.bindOnUse&&this._unbindBuffers(),this.gl.bindTransformFeedback(36386,null)}setBuffers(t){this.buffers={},this.unusedBuffers={},this.bind(()=>{for(const r in t)this.setBuffer(r,t[r])})}setBuffer(t,r){const a=this._getVaryingIndex(t),{buffer:h,byteLength:y,byteOffset:s}=this._getBufferRange(r);if(a<0){this.unusedBuffers[t]=h,Gt.warn(`${this.id} unusedBuffers varying buffer ${t}`)();return}this.buffers[a]={buffer:h,byteLength:y,byteOffset:s},this.bindOnUse||this._bindBuffer(a,h,s,y)}getBuffer(t){if(cI(t))return this.buffers[t]||null;const r=this._getVaryingIndex(t);return r>=0?this.buffers[r]:null}bind(t=this.handle){if(typeof t!="function")return this.gl.bindTransformFeedback(36386,t),this;let r;return this._bound?r=t():(this.gl.bindTransformFeedback(36386,this.handle),this._bound=!0,r=t(),this._bound=!1,this.gl.bindTransformFeedback(36386,null)),r}unbind(){this.bind(null)}_getBufferRange(t){if(t instanceof rm)return{buffer:t,byteOffset:0,byteLength:t.byteLength};const{buffer:r,byteOffset:a=0,byteLength:h=t.buffer.byteLength}=t;return{buffer:r,byteOffset:a,byteLength:h}}_getVaryingIndex(t){if(cI(t))return Number(t);for(const r of this.layout.varyings)if(t===r.name)return r.location;return-1}_bindBuffers(){for(const t in this.buffers){const{buffer:r,byteLength:a,byteOffset:h}=this._getBufferRange(this.buffers[t]);this._bindBuffer(Number(t),r,h,a)}}_unbindBuffers(){for(const t in this.buffers)this.gl.bindBufferBase(35982,Number(t),null)}_bindBuffer(t,r,a=0,h){const y=r&&r.handle;!y||h===void 0?this.gl.bindBufferBase(35982,t,y):this.gl.bindBufferRange(35982,t,y,a,h)}}function cI(i){return typeof i=="number"?Number.isInteger(i):/^\d+$/.test(i)}class EG extends k1{constructor(t,r){super(t,r);pe(this,"device");pe(this,"handle");pe(this,"target",null);pe(this,"_queryPending",!1);pe(this,"_pollingPromise",null);if(this.device=t,r.count>1)throw new Error("WebGL QuerySet can only have one value");this.handle=this.device.gl.createQuery(),Object.seal(this)}get[Symbol.toStringTag](){return"Query"}destroy(){this.device.gl.deleteQuery(this.handle)}beginTimestampQuery(){return this._begin(35007)}endTimestampQuery(){this._end()}beginOcclusionQuery(t){return this._begin(t!=null&&t.conservative?36202:35887)}endOcclusionQuery(){this._end()}beginTransformFeedbackQuery(){return this._begin(35976)}endTransformFeedbackQuery(){this._end()}async resolveQuery(){return[await this.pollQuery()]}_begin(t){this._queryPending||(this.target=t,this.device.gl.beginQuery(this.target,this.handle))}_end(){this._queryPending||this.target&&(this.device.gl.endQuery(this.target),this.target=null,this._queryPending=!0)}isResultAvailable(){if(!this._queryPending)return!1;const t=this.device.gl.getQueryParameter(this.handle,34919);return t&&(this._queryPending=!1),t}isTimerDisjoint(){return this.device.gl.getParameter(36795)}getResult(){return this.device.gl.getQueryParameter(this.handle,34918)}getTimerMilliseconds(){return this.getResult()/1e6}pollQuery(t=Number.POSITIVE_INFINITY){if(this._pollingPromise)return this._pollingPromise;let r=0;return this._pollingPromise=new Promise((a,h)=>{const y=()=>{this.isResultAvailable()?(a(this.getResult()),this._pollingPromise=null):r++>t?(h("Timed out"),this._pollingPromise=null):requestAnimationFrame(y)};requestAnimationFrame(y)}),this._pollingPromise}}class hd extends oc{constructor(t){var V,X;super({...t,id:t.id||IH("webgl-device")});pe(this,"type","webgl");pe(this,"handle");pe(this,"features");pe(this,"limits");pe(this,"info");pe(this,"canvasContext");pe(this,"lost");pe(this,"_resolveContextLost");pe(this,"gl");pe(this,"debug",!1);pe(this,"_canvasSizeInfo",{clientWidth:0,clientHeight:0,devicePixelRatio:1});pe(this,"_extensions",{});pe(this,"_polyfilled",!1);pe(this,"spectorJS");pe(this,"renderPass",null);pe(this,"_constants");const r=oc._getCanvasContextProps(t);if(!r)throw new Error("WebGLDevice requires props.createCanvasContext to be set");let a=(X=(V=r.canvas)==null?void 0:V.gl)==null?void 0:X.device;if(a)throw new Error(`WebGL context already attached to device ${a.id}`);this.canvasContext=new _H(this,r),this.lost=new Promise(se=>{this._resolveContextLost=se});const h={...t.webgl};r.alphaMode==="premultiplied"&&(h.premultipliedAlpha=!0),t.powerPreference!==void 0&&(h.powerPreference=t.powerPreference);const s=this.props._handle||Y9(this.canvasContext.canvas,{onContextLost:se=>{var ne;return(ne=this._resolveContextLost)==null?void 0:ne.call(this,{reason:"destroyed",message:"Entered sleep mode, or too many apps or browser tabs are using the GPU."})},onContextRestored:se=>console.log("WebGL context restored")},h);if(!s)throw new Error("WebGL context creation failed");if(a=s.device,a){if(t._reuseDevices)return Gt.log(1,`Not creating a new Device, instead returning a reference to Device ${a.id} already attached to WebGL context`,a)(),a._reused=!0,a;throw new Error(`WebGL context already attached to device ${a.id}`)}this.handle=s,this.gl=s,this.spectorJS=vH({...this.props,gl:this.handle}),this.gl.device=this,this.gl._version=2,this.info=K9(this.gl,this._extensions),this.limits=new fH(this.gl),this.features=new dH(this.gl,this._extensions,this.props._disabledFeatures),this.props._initializeFeatures&&this.features.initializeFeatures(),r.autoResize!==!1&&this.canvasContext.resize(),new Tu(this.gl,{log:(...se)=>Gt.log(1,...se)()}).trackState(this.gl,{copyState:!1});const B=t.debugWebGL||t.debug,F=t.debugWebGL;B&&(this.gl=wH(this.gl,{debugWebGL:B,traceWebGL:F}),Gt.warn("WebGL debug mode activated. Performance reduced.")(),t.debugWebGL&&(Gt.level=Math.max(Gt.level,1)))}destroy(){!this.props._reuseDevices&&!this._reused&&delete this.gl.device}get isLost(){return this.gl.isContextLost()}createCanvasContext(t){throw new Error("WebGL only supports a single canvas")}createBuffer(t){const r=this._normalizeBufferProps(t);return new rm(this,r)}createTexture(t){return new nm(this,t)}createExternalTexture(t){throw new Error("createExternalTexture() not implemented")}createSampler(t){return new sw(this,t)}createShader(t){return new PH(this,t)}createFramebuffer(t){return new im(this,t)}createVertexArray(t){return new mA(this,t)}createTransformFeedback(t){return new TG(this,t)}createQuerySet(t){return new EG(this,t)}createRenderPipeline(t){return new fG(this,t)}beginRenderPass(t){return new YH(this,t)}createComputePipeline(t){throw new Error("ComputePipeline not supported in WebGL")}beginComputePass(t){throw new Error("ComputePass not supported in WebGL")}createCommandEncoder(t={}){return new xG(this,t)}submit(){var t;(t=this.renderPass)==null||t.end(),this.renderPass=null}readPixelsToArrayWebGL(t,r){return $H(t,r)}readPixelsToBufferWebGL(t,r){return WH(t,r)}setParametersWebGL(t){Rd(this.gl,t)}getParametersWebGL(t){return CP(this.gl,t)}withParametersWebGL(t,r){return Ly(this.gl,t,r)}resetWebGL(){Gt.warn("WebGLDevice.resetWebGL is deprecated, use only for debugging")(),$9(this.gl)}_getDeviceSpecificTextureFormatCapabilities(t){return lH(this.gl,t,this._extensions)}loseDevice(){var h;let t=!1;const a=this.getExtension("WEBGL_lose_context").WEBGL_lose_context;return a&&(t=!0,a.loseContext()),(h=this._resolveContextLost)==null||h.call(this,{reason:"destroyed",message:"Application triggered context loss"}),t}pushState(){Tu.get(this.gl).push()}popState(){Tu.get(this.gl).pop()}setSpectorMetadata(t,r){t.__SPECTOR_Metadata=r}getGLKey(t,r){const a=Number(t);for(const h in this.gl)if(this.gl[h]===a)return`GL.${h}`;return r!=null&&r.emptyIfUnknown?"":String(t)}getGLKeys(t){const r={emptyIfUnknown:!0};return Object.entries(t).reduce((a,[h,y])=>(a[`${h}:${this.getGLKey(h,r)}`]=`${y}:${this.getGLKey(y,r)}`,a),{})}setConstantAttributeWebGL(t,r){const a=this.limits.maxVertexAttributes;this._constants=this._constants||new Array(a).fill(null);const h=this._constants[t];switch(h&&MG(h,r)&&Gt.info(1,`setConstantAttributeWebGL(${t}) could have been skipped, value unchanged`)(),this._constants[t]=r,r.constructor){case Float32Array:SG(this,t,r);break;case Int32Array:IG(this,t,r);break;case Uint32Array:CG(this,t,r);break;default:throw new Error("constant")}}getExtension(t){return Td(this.gl,t,this._extensions),this._extensions}}function SG(i,e,t){switch(t.length){case 1:i.gl.vertexAttrib1fv(e,t);break;case 2:i.gl.vertexAttrib2fv(e,t);break;case 3:i.gl.vertexAttrib3fv(e,t);break;case 4:i.gl.vertexAttrib4fv(e,t);break}}function IG(i,e,t){i.gl.vertexAttribI4iv(e,t)}function CG(i,e,t){i.gl.vertexAttribI4uiv(e,t)}function MG(i,e){if(!i||!e||i.length!==e.length||i.constructor!==e.constructor)return!1;for(let t=0;t<i.length;++t)if(i[t]!==e[t])return!1;return!0}const RG={WEBGL_depth_texture:{UNSIGNED_INT_24_8_WEBGL:34042},OES_element_index_uint:{},OES_texture_float:{},OES_texture_half_float:{HALF_FLOAT_OES:5131},EXT_color_buffer_float:{},OES_standard_derivatives:{FRAGMENT_SHADER_DERIVATIVE_HINT_OES:35723},EXT_frag_depth:{},EXT_blend_minmax:{MIN_EXT:32775,MAX_EXT:32776},EXT_shader_texture_lod:{}},PG=i=>({drawBuffersWEBGL(e){return i.drawBuffers(e)},COLOR_ATTACHMENT0_WEBGL:36064,COLOR_ATTACHMENT1_WEBGL:36065,COLOR_ATTACHMENT2_WEBGL:36066,COLOR_ATTACHMENT3_WEBGL:36067}),BG=i=>({VERTEX_ARRAY_BINDING_OES:34229,createVertexArrayOES(){return i.createVertexArray()},deleteVertexArrayOES(e){return i.deleteVertexArray(e)},isVertexArrayOES(e){return i.isVertexArray(e)},bindVertexArrayOES(e){return i.bindVertexArray(e)}}),DG=i=>({VERTEX_ATTRIB_ARRAY_DIVISOR_ANGLE:35070,drawArraysInstancedANGLE(...e){return i.drawArraysInstanced(...e)},drawElementsInstancedANGLE(...e){return i.drawElementsInstanced(...e)},vertexAttribDivisorANGLE(...e){return i.vertexAttribDivisor(...e)}});function OG(i=!0){const e=HTMLCanvasElement.prototype;if(!i&&e.originalGetContext){e.getContext=e.originalGetContext,e.originalGetContext=void 0;return}e.originalGetContext=e.getContext,e.getContext=function(t,r){if(t==="webgl"||t==="experimental-webgl"){const a=this.originalGetContext("webgl2",r);return a instanceof HTMLElement&&FG(a),a}return this.originalGetContext(t,r)}}function FG(i){i.getExtension("EXT_color_buffer_float");const e={...RG,WEBGL_disjoint_timer_query:i.getExtension("EXT_disjoint_timer_query_webgl2"),WEBGL_draw_buffers:PG(i),OES_vertex_array_object:BG(i),ANGLE_instanced_arrays:DG(i)},t=i.getExtension;i.getExtension=function(a){const h=t.call(i,a);return h||(a in e?e[a]:null)};const r=i.getSupportedExtensions;i.getSupportedExtensions=function(){const a=r.apply(i)||[];return a==null?void 0:a.concat(Object.keys(e))}}const kg=1;class kG extends o5{constructor(){super();pe(this,"type","webgl");oc.defaultProps={...oc.defaultProps,...pA},hd.adapter=this}isSupported(){return typeof WebGL2RenderingContext<"u"}enforceWebGL2(t){OG(t)}async attach(t){if(t instanceof hd)return t;if((t==null?void 0:t.device)instanceof oc)return t.device;if(!LG(t))throw new Error("Invalid WebGL2RenderingContext");return new hd({_handle:t,createCanvasContext:{canvas:t.canvas,autoResize:!1}})}async create(t={}){Gt.groupCollapsed(kg,"WebGLDevice created")();const r=[];(t.debugWebGL||t.debug)&&r.push(bH()),t.debugSpectorJS&&r.push(yH(t));const a=await Promise.allSettled(r);for(const s of a)s.status==="rejected"&&Gt.error(`Failed to initialize debug libraries ${s.reason}`)();const h=new hd(t),y=`${h._reused?"Reusing":"Created"} device with WebGL2 ${h.debug?"debug ":""}context: ${h.info.vendor}, ${h.info.renderer} for canvas: ${h.canvasContext.id}`;return Gt.probe(kg,y)(),Gt.table(kg,h.info)(),Gt.groupEnd(kg)(),h}}function LG(i){return typeof WebGL2RenderingContext<"u"&&i instanceof WebGL2RenderingContext?!0:!!(i&&Number.isFinite(i._version))}const uI=new kG;function Yl(){}const NG=({isDragging:i})=>i?"grabbing":"grab",VP={id:"",width:"100%",height:"100%",style:null,viewState:null,initialViewState:null,pickingRadius:0,layerFilter:null,parameters:{},parent:null,device:null,deviceProps:{},gl:null,canvas:null,layers:[],effects:[],views:null,controller:null,useDevicePixels:!0,touchAction:"none",eventRecognizerOptions:{},_framebuffer:null,_animate:!1,_pickable:!0,_typedArrayManagerProps:{},_customRender:null,widgets:[],onDeviceInitialized:Yl,onWebGLInitialized:Yl,onResize:Yl,onViewStateChange:Yl,onInteractionStateChange:Yl,onBeforeRender:Yl,onAfterRender:Yl,onLoad:Yl,onError:i=>gr.error(i.message,i.cause)(),onHover:null,onClick:null,onDragStart:null,onDrag:null,onDragEnd:null,_onMetrics:null,getCursor:NG,getTooltip:null,debug:!1,drawPickingColors:!1};class Tm{constructor(e){this.width=0,this.height=0,this.userData={},this.device=null,this.canvas=null,this.viewManager=null,this.layerManager=null,this.effectManager=null,this.deckRenderer=null,this.deckPicker=null,this.eventManager=null,this.widgetManager=null,this.tooltip=null,this.animationLoop=null,this.cursorState={isHovering:!1,isDragging:!1},this.stats=new p0({id:"deck.gl"}),this.metrics={fps:0,setPropsTime:0,updateAttributesTime:0,framesRedrawn:0,pickTime:0,pickCount:0,gpuTime:0,gpuTimePerFrame:0,cpuTime:0,cpuTimePerFrame:0,bufferMemory:0,textureMemory:0,renderbufferMemory:0,gpuMemory:0},this._metricsCounter=0,this._needsRedraw="Initial render",this._pickRequest={mode:"hover",x:-1,y:-1,radius:0,event:null},this._lastPointerDownInfo=null,this._onPointerMove=r=>{const{_pickRequest:a}=this;if(r.type==="pointerleave")a.x=-1,a.y=-1,a.radius=0;else{if(r.leftButton||r.rightButton)return;{const h=r.offsetCenter;if(!h)return;a.x=h.x,a.y=h.y,a.radius=this.props.pickingRadius}}this.layerManager&&(this.layerManager.context.mousePosition={x:a.x,y:a.y}),a.event=r},this._onEvent=r=>{const a=W1[r.type],h=r.offsetCenter;if(!a||!h||!this.layerManager)return;const y=this.layerManager.getLayers(),s=this.deckPicker.getLastPickedObject({x:h.x,y:h.y,layers:y,viewports:this.getViewports(h)},this._lastPointerDownInfo),{layer:T}=s,B=T&&(T[a]||T.props[a]),F=this.props[a];let V=!1;B&&(V=B.call(T,s,r)),V||(F==null||F(s,r),this.widgetManager.onEvent(s,r))},this._onPointerDown=r=>{var y;if(((y=this.device)==null?void 0:y.type)==="webgpu")return;const a=r.offsetCenter,h=this._pick("pickObject","pickObject Time",{x:a.x,y:a.y,radius:this.props.pickingRadius});this._lastPointerDownInfo=h.result[0]||h.emptyInfo},this.props={...VP,...e},e=this.props,e.viewState&&e.initialViewState&&gr.warn("View state tracking is disabled. Use either `initialViewState` for auto update or `viewState` for manual update.")(),this.viewState=this.props.initialViewState,e.device&&(this.device=e.device);let t=this.device;!t&&e.gl&&(e.gl instanceof WebGLRenderingContext&&gr.error("WebGL1 context not supported.")(),t=uI.attach(e.gl)),t||(t=M1.createDevice({type:"best-available",_reuseDevices:!0,adapters:[uI],...e.deviceProps,createCanvasContext:{canvas:this._createCanvas(e),useDevicePixels:this.props.useDevicePixels,autoResize:!1}})),this.animationLoop=this._createAnimationLoop(t,e),this.setProps(e),e._typedArrayManagerProps&&xm.setOptions(e._typedArrayManagerProps),this.animationLoop.start()}finalize(){var e,t,r,a,h,y,s,T,B,F;(e=this.animationLoop)==null||e.stop(),(t=this.animationLoop)==null||t.destroy(),this.animationLoop=null,this._lastPointerDownInfo=null,(r=this.layerManager)==null||r.finalize(),this.layerManager=null,(a=this.viewManager)==null||a.finalize(),this.viewManager=null,(h=this.effectManager)==null||h.finalize(),this.effectManager=null,(y=this.deckRenderer)==null||y.finalize(),this.deckRenderer=null,(s=this.deckPicker)==null||s.finalize(),this.deckPicker=null,(T=this.eventManager)==null||T.destroy(),this.eventManager=null,(B=this.widgetManager)==null||B.finalize(),this.widgetManager=null,!this.props.canvas&&!this.props.device&&!this.props.gl&&this.canvas&&((F=this.canvas.parentElement)==null||F.removeChild(this.canvas),this.canvas=null)}setProps(e){var r;this.stats.get("setProps Time").timeStart(),"onLayerHover"in e&&gr.removed("onLayerHover","onHover")(),"onLayerClick"in e&&gr.removed("onLayerClick","onClick")(),e.initialViewState&&!Zo(this.props.initialViewState,e.initialViewState,3)&&(this.viewState=e.initialViewState),Object.assign(this.props,e),this._setCanvasSize(this.props);const t=Object.create(this.props);Object.assign(t,{views:this._getViews(),width:this.width,height:this.height,viewState:this._getViewState()}),(r=this.animationLoop)==null||r.setProps(t),this.layerManager&&(this.viewManager.setProps(t),this.layerManager.activateViewport(this.getViewports()[0]),this.layerManager.setProps(t),this.effectManager.setProps(t),this.deckRenderer.setProps(t),this.deckPicker.setProps(t),this.widgetManager.setProps(t)),this.stats.get("setProps Time").timeEnd()}needsRedraw(e={clearRedrawFlags:!1}){if(!this.layerManager)return!1;if(this.props._animate)return"Deck._animate";let t=this._needsRedraw;e.clearRedrawFlags&&(this._needsRedraw=!1);const r=this.viewManager.needsRedraw(e),a=this.layerManager.needsRedraw(e),h=this.effectManager.needsRedraw(e),y=this.deckRenderer.needsRedraw(e);return t=t||r||a||h||y,t}redraw(e){if(!this.layerManager)return;let t=this.needsRedraw({clearRedrawFlags:!0});t=e||t,t&&(this.stats.get("Redraw Count").incrementCount(),this.props._customRender?this.props._customRender(t):this._drawLayers(t))}get isInitialized(){return this.viewManager!==null}getViews(){return In(this.viewManager),this.viewManager.views}getViewports(e){return In(this.viewManager),this.viewManager.getViewports(e)}getCanvas(){return this.canvas}pickObject(e){const t=this._pick("pickObject","pickObject Time",e).result;return t.length?t[0]:null}pickMultipleObjects(e){return e.depth=e.depth||10,this._pick("pickObject","pickMultipleObjects Time",e).result}pickObjects(e){return this._pick("pickObjects","pickObjects Time",e)}_addResources(e,t=!1){for(const r in e)this.layerManager.resourceManager.add({resourceId:r,data:e[r],forceUpdate:t})}_removeResources(e){for(const t of e)this.layerManager.resourceManager.remove(t)}_addDefaultEffect(e){this.effectManager.addDefaultEffect(e)}_addDefaultShaderModule(e){this.layerManager.addDefaultShaderModule(e)}_removeDefaultShaderModule(e){var t;(t=this.layerManager)==null||t.removeDefaultShaderModule(e)}_pick(e,t,r){In(this.deckPicker);const{stats:a}=this;a.get("Pick Count").incrementCount(),a.get(t).timeStart();const h=this.deckPicker[e]({layers:this.layerManager.getLayers(r),views:this.viewManager.getViews(),viewports:this.getViewports(r),onViewportActive:this.layerManager.activateViewport,effects:this.effectManager.getEffects(),...r});return a.get(t).timeEnd(),h}_createCanvas(e){let t=e.canvas;return typeof t=="string"&&(t=document.getElementById(t),In(t)),t||(t=document.createElement("canvas"),t.id=e.id||"deckgl-overlay",(e.parent||document.body).appendChild(t)),Object.assign(t.style,e.style),t}_setCanvasSize(e){var a;if(!this.canvas)return;const{width:t,height:r}=e;if(t||t===0){const h=Number.isFinite(t)?`${t}px`:t;this.canvas.style.width=h}if(r||r===0){const h=Number.isFinite(r)?`${r}px`:r;this.canvas.style.position=((a=e.style)==null?void 0:a.position)||"absolute",this.canvas.style.height=h}}_updateCanvasSize(){var a,h;const{canvas:e}=this;if(!e)return;const t=e.clientWidth??e.width,r=e.clientHeight??e.height;(t!==this.width||r!==this.height)&&(this.width=t,this.height=r,(a=this.viewManager)==null||a.setProps({width:t,height:r}),(h=this.layerManager)==null||h.activateViewport(this.getViewports()[0]),this.props.onResize({width:t,height:r}))}_createAnimationLoop(e,t){const{gl:r,onError:a,useDevicePixels:h}=t;return new jj({device:e,useDevicePixels:h,autoResizeDrawingBuffer:!r,autoResizeViewport:!1,onInitialize:y=>this._setDevice(y.device),onRender:this._onRenderFrame.bind(this),onError:a})}_getViewState(){return this.props.viewState||this.viewState}_getViews(){const{views:e}=this.props,t=Array.isArray(e)?e:e?[e]:[new uA({id:"default-view"})];return t.length&&this.props.controller&&(t[0].props.controller=this.props.controller),t}_onContextLost(){const{onError:e}=this.props;this.animationLoop&&e&&e(new Error("WebGL context is lost"))}_pickAndCallback(){var t,r,a,h;if(((t=this.device)==null?void 0:t.type)==="webgpu")return;const{_pickRequest:e}=this;if(e.event){const{result:y,emptyInfo:s}=this._pick("pickObject","pickObject Time",e);this.cursorState.isHovering=y.length>0;let T=s,B=!1;for(const F of y)T=F,B=((r=F.layer)==null?void 0:r.onHover(F,e.event))||B;B||((h=(a=this.props).onHover)==null||h.call(a,T,e.event),this.widgetManager.onHover(T,e.event)),e.event=null}}_updateCursor(){const e=this.props.parent||this.canvas;e&&(e.style.cursor=this.props.getCursor(this.cursorState))}_setDevice(e){var a,h;if(this.device=e,!this.animationLoop)return;this.canvas||(this.canvas=(a=this.device.canvasContext)==null?void 0:a.canvas),this.device.type==="webgl"&&this.device.setParametersWebGL({blend:!0,blendFunc:[770,771,1,771],polygonOffsetFill:!0,depthTest:!0,depthFunc:515}),this.props.onDeviceInitialized(this.device),this.device.type==="webgl"&&this.props.onWebGLInitialized(this.device.gl);const t=new gP;t.play(),this.animationLoop.attachTimeline(t),this.eventManager=new KV(this.props.parent||this.canvas,{touchAction:this.props.touchAction,recognizers:Object.keys(P3).map(y=>{var se;const[s,T,B,F]=P3[y],V=(se=this.props.eventRecognizerOptions)==null?void 0:se[y],X={...T,...V,event:y};return{recognizer:new s(X),recognizeWith:B,requestFailure:F}}),events:{pointerdown:this._onPointerDown,pointermove:this._onPointerMove,pointerleave:this._onPointerMove}});for(const y in W1)this.eventManager.on(y,this._onEvent);this.viewManager=new f9({timeline:t,eventManager:this.eventManager,onViewStateChange:this._onViewStateChange.bind(this),onInteractionStateChange:this._onInteractionStateChange.bind(this),views:this._getViews(),viewState:this._getViewState(),width:this.width,height:this.height});const r=this.viewManager.getViewports()[0];this.layerManager=new d9(this.device,{deck:this,stats:this.stats,viewport:r,timeline:t}),this.effectManager=new I9({deck:this,device:this.device}),this.deckRenderer=new R9(this.device),this.deckPicker=new k9(this.device),this.widgetManager=new z9({deck:this,parentElement:(h=this.canvas)==null?void 0:h.parentElement}),this.widgetManager.addDefault(new V9),this.setProps(this.props),this._updateCanvasSize(),this.props.onLoad()}_drawLayers(e,t){var y;const{device:r,gl:a}=this.layerManager.context;this.props.onBeforeRender({device:r,gl:a});const h={target:this.props._framebuffer,layers:this.layerManager.getLayers(),viewports:this.viewManager.getViewports(),onViewportActive:this.layerManager.activateViewport,views:this.viewManager.getViews(),pass:"screen",effects:this.effectManager.getEffects(),...t};(y=this.deckRenderer)==null||y.renderLayers(h),h.pass==="screen"&&this.widgetManager.onRedraw({viewports:h.viewports,layers:h.layers}),this.props.onAfterRender({device:r,gl:a})}_onRenderFrame(){var e;this._getFrameStats(),this._metricsCounter++%60===0&&(this._getMetrics(),this.stats.reset(),gr.table(4,this.metrics)(),this.props._onMetrics&&this.props._onMetrics(this.metrics)),this._updateCanvasSize(),this._updateCursor(),this.layerManager.updateLayers(),((e=this.device)==null?void 0:e.type)!=="webgpu"&&this._pickAndCallback(),this.redraw(),this.viewManager&&this.viewManager.updateViewStates()}_onViewStateChange(e){const t=this.props.onViewStateChange(e)||e.viewState;this.viewState&&(this.viewState={...this.viewState,[e.viewId]:t},this.props.viewState||this.viewManager&&this.viewManager.setProps({viewState:this.viewState}))}_onInteractionStateChange(e){this.cursorState.isDragging=e.isDragging||!1,this.props.onInteractionStateChange(e)}_getFrameStats(){const{stats:e}=this;e.get("frameRate").timeEnd(),e.get("frameRate").timeStart();const t=this.animationLoop.stats;e.get("GPU Time").addTime(t.get("GPU Time").lastTiming),e.get("CPU Time").addTime(t.get("CPU Time").lastTiming)}_getMetrics(){const{metrics:e,stats:t}=this;e.fps=t.get("frameRate").getHz(),e.setPropsTime=t.get("setProps Time").time,e.updateAttributesTime=t.get("Update Attributes").time,e.framesRedrawn=t.get("Redraw Count").count,e.pickTime=t.get("pickObject Time").time+t.get("pickMultipleObjects Time").time+t.get("pickObjects Time").time,e.pickCount=t.get("Pick Count").count,e.gpuTime=t.get("GPU Time").time,e.cpuTime=t.get("CPU Time").time,e.gpuTimePerFrame=t.get("GPU Time").getAverageTime(),e.cpuTimePerFrame=t.get("CPU Time").getAverageTime();const r=M1.stats.get("Memory Usage");e.bufferMemory=r.get("Buffer Memory").count,e.textureMemory=r.get("Texture Memory").count,e.renderbufferMemory=r.get("Renderbuffer Memory").count,e.gpuMemory=r.get("GPU Memory").count}}Tm.defaultProps=VP;Tm.VERSION=hz;function zG(i){switch(i){case"float64":return Float64Array;case"uint8":case"unorm8":return Uint8ClampedArray;default:return dR(i)}}const UG=hR;function Lg(i,e,t){const r=t==="webgpu"&&e.type==="uint8"?"unorm8":e.type;return{attribute:i,format:e.size>1?`${r}x${e.size}`:e.type,byteOffset:e.offset||0}}function vu(i){return i.stride||i.size*i.bytesPerElement}function VG(i,e){return i.type===e.type&&i.size===e.size&&vu(i)===vu(e)&&(i.offset||0)===(e.offset||0)}function ow(i,e){e.offset&&gr.removed("shaderAttribute.offset","vertexOffset, elementOffset")();const t=vu(i),r=e.vertexOffset!==void 0?e.vertexOffset:i.vertexOffset||0,a=e.elementOffset||0,h=r*t+a*i.bytesPerElement+(i.offset||0);return{...e,offset:h,stride:t}}function jG(i,e){const t=ow(i,e);return{high:t,low:{...t,offset:t.offset+i.size*4}}}class HG{constructor(e,t,r){this._buffer=null,this.device=e,this.id=t.id||"",this.size=t.size||1;const a=t.logicalType||t.type,h=a==="float64";let{defaultValue:y}=t;y=Number.isFinite(y)?[y]:y||new Array(this.size).fill(0);let s;h?s="float32":!a&&t.isIndexed?s="uint32":s=a||"float32";let T=zG(a||s);this.doublePrecision=h,h&&t.fp64===!1&&(T=Float32Array),this.value=null,this.settings={...t,defaultType:T,defaultValue:y,logicalType:a,type:s,normalized:s.includes("norm"),size:this.size,bytesPerElement:T.BYTES_PER_ELEMENT},this.state={...r,externalBuffer:null,bufferAccessor:this.settings,allocatedValue:null,numInstances:0,bounds:null,constant:!1}}get isConstant(){return this.state.constant}get buffer(){return this._buffer}get byteOffset(){const e=this.getAccessor();return e.vertexOffset?e.vertexOffset*vu(e):0}get numInstances(){return this.state.numInstances}set numInstances(e){this.state.numInstances=e}delete(){this._buffer&&(this._buffer.delete(),this._buffer=null),xm.release(this.state.allocatedValue)}getBuffer(){return this.state.constant?null:this.state.externalBuffer||this._buffer}getValue(e=this.id,t=null){const r={};if(this.state.constant){const a=this.value;if(t){const h=ow(this.getAccessor(),t),y=h.offset/a.BYTES_PER_ELEMENT,s=h.size||this.size;r[e]=a.subarray(y,y+s)}else r[e]=a}else r[e]=this.getBuffer();return this.doublePrecision&&(this.value instanceof Float64Array?r[`${e}64Low`]=r[e]:r[`${e}64Low`]=new Float32Array(this.size)),r}_getBufferLayout(e=this.id,t=null){const r=this.getAccessor(),a=[],h={name:this.id,byteStride:vu(r),attributes:a};if(this.doublePrecision){const y=jG(r,t||{});a.push(Lg(e,{...r,...y.high},this.device.type),Lg(`${e}64Low`,{...r,...y.low},this.device.type))}else if(t){const y=ow(r,t);a.push(Lg(e,{...r,...y},this.device.type))}else a.push(Lg(e,r,this.device.type));return h}setAccessor(e){this.state.bufferAccessor=e}getAccessor(){return this.state.bufferAccessor}getBounds(){if(this.state.bounds)return this.state.bounds;let e=null;if(this.state.constant&&this.value){const t=Array.from(this.value);e=[t,t]}else{const{value:t,numInstances:r,size:a}=this,h=r*a;if(t&&h&&t.length>=h){const y=new Array(a).fill(1/0),s=new Array(a).fill(-1/0);for(let T=0;T<h;)for(let B=0;B<a;B++){const F=t[T++];F<y[B]&&(y[B]=F),F>s[B]&&(s[B]=F)}e=[y,s]}}return this.state.bounds=e,e}setData(e){const{state:t}=this;let r;ArrayBuffer.isView(e)?r={value:e}:e instanceof Gr?r={buffer:e}:r=e;const a={...this.settings,...r};if(ArrayBuffer.isView(r.value)){if(!r.type)if(this.doublePrecision&&r.value instanceof Float64Array)a.type="float32";else{const y=UG(r.value);a.type=a.normalized?y.replace("int","norm"):y}a.bytesPerElement=r.value.BYTES_PER_ELEMENT,a.stride=vu(a)}if(t.bounds=null,r.constant){let h=r.value;if(h=this._normalizeValue(h,[],0),this.settings.normalized&&(h=this.normalizeConstant(h)),!(!t.constant||!this._areValuesEqual(h,this.value)))return!1;t.externalBuffer=null,t.constant=!0,this.value=ArrayBuffer.isView(h)?h:new Float32Array(h)}else if(r.buffer){const h=r.buffer;t.externalBuffer=h,t.constant=!1,this.value=r.value||null}else if(r.value){this._checkExternalBuffer(r);let h=r.value;t.externalBuffer=null,t.constant=!1,this.value=h;let{buffer:y}=this;const s=vu(a),T=(a.vertexOffset||0)*s;if(this.doublePrecision&&h instanceof Float64Array&&(h=eb(h,a)),this.settings.isIndexed){const F=this.settings.defaultType;h.constructor!==F&&(h=new F(h))}const B=h.byteLength+T+s*2;(!y||y.byteLength<B)&&(y=this._createBuffer(B)),y.write(h,T)}return this.setAccessor(a),!0}updateSubBuffer(e={}){this.state.bounds=null;const t=this.value,{startOffset:r=0,endOffset:a}=e;this.buffer.write(this.doublePrecision&&t instanceof Float64Array?eb(t,{size:this.size,startIndex:r,endIndex:a}):t.subarray(r,a),r*t.BYTES_PER_ELEMENT+this.byteOffset)}allocate(e,t=!1){const{state:r}=this,a=r.allocatedValue,h=xm.allocate(a,e+1,{size:this.size,type:this.settings.defaultType,copy:t});this.value=h;const{byteOffset:y}=this;let{buffer:s}=this;return(!s||s.byteLength<h.byteLength+y)&&(s=this._createBuffer(h.byteLength+y),t&&a&&s.write(a instanceof Float64Array?eb(a,this):a,y)),r.allocatedValue=h,r.constant=!1,r.externalBuffer=null,this.setAccessor(this.settings),!0}_checkExternalBuffer(e){const{value:t}=e;if(!ArrayBuffer.isView(t))throw new Error(`Attribute ${this.id} value is not TypedArray`);const r=this.settings.defaultType;let a=!1;if(this.doublePrecision&&(a=t.BYTES_PER_ELEMENT<4),a)throw new Error(`Attribute ${this.id} does not support ${t.constructor.name}`);!(t instanceof r)&&this.settings.normalized&&!("normalized"in e)&&gr.warn(`Attribute ${this.id} is normalized`)()}normalizeConstant(e){switch(this.settings.type){case"snorm8":return new Float32Array(e).map(t=>(t+128)/255*2-1);case"snorm16":return new Float32Array(e).map(t=>(t+32768)/65535*2-1);case"unorm8":return new Float32Array(e).map(t=>t/255);case"unorm16":return new Float32Array(e).map(t=>t/65535);default:return e}}_normalizeValue(e,t,r){const{defaultValue:a,size:h}=this.settings;if(Number.isFinite(e))return t[r]=e,t;if(!e){let y=h;for(;--y>=0;)t[r+y]=a[y];return t}switch(h){case 4:t[r+3]=Number.isFinite(e[3])?e[3]:a[3];case 3:t[r+2]=Number.isFinite(e[2])?e[2]:a[2];case 2:t[r+1]=Number.isFinite(e[1])?e[1]:a[1];case 1:t[r+0]=Number.isFinite(e[0])?e[0]:a[0];break;default:let y=h;for(;--y>=0;)t[r+y]=Number.isFinite(e[y])?e[y]:a[y]}return t}_areValuesEqual(e,t){if(!e||!t)return!1;const{size:r}=this;for(let a=0;a<r;a++)if(e[a]!==t[a])return!1;return!0}_createBuffer(e){var a;this._buffer&&this._buffer.destroy();const{isIndexed:t,type:r}=this.settings;return this._buffer=this.device.createBuffer({...(a=this._buffer)==null?void 0:a.props,id:this.id,usage:(t?Gr.INDEX:Gr.VERTEX)|Gr.COPY_DST,indexType:t?r:void 0,byteLength:e}),this._buffer}}const hI=[],dI=[];function jP(i,e=0,t=1/0){let r=hI;const a={index:-1,data:i,target:[]};return i?typeof i[Symbol.iterator]=="function"?r=i:i.length>0&&(dI.length=i.length,r=dI):r=hI,(e>0||Number.isFinite(t))&&(r=(Array.isArray(r)?r:Array.from(r)).slice(e,t),a.index=e-1),{iterable:r,objectInfo:a}}function HP(i){return i&&i[Symbol.asyncIterator]}function GG(i,e){const{size:t,stride:r,offset:a,startIndices:h,nested:y}=e,s=i.BYTES_PER_ELEMENT,T=r?r/s:t,B=a?a/s:0,F=Math.floor((i.length-B)/T);return(V,{index:X,target:se})=>{if(!h){const _e=X*T+B;for(let ke=0;ke<t;ke++)se[ke]=i[_e+ke];return se}const ne=h[X],K=h[X+1]||F;let ue;if(y){ue=new Array(K-ne);for(let _e=ne;_e<K;_e++){const ke=_e*T+B;se=new Array(t);for(let we=0;we<t;we++)se[we]=i[ke+we];ue[_e-ne]=se}}else if(T===t)ue=i.subarray(ne*t+B,K*t+B);else{ue=new i.constructor((K-ne)*t);let _e=0;for(let ke=ne;ke<K;ke++){const we=ke*T+B;for(let ge=0;ge<t;ge++)ue[_e++]=i[we+ge]}}return ue}}const $G=[],Qg=[[0,1/0]];function WG(i,e){if(i===Qg||(e[0]<0&&(e[0]=0),e[0]>=e[1]))return i;const t=[],r=i.length;let a=0;for(let h=0;h<r;h++){const y=i[h];y[1]<e[0]?(t.push(y),a=h+1):y[0]>e[1]?t.push(y):e=[Math.min(y[0],e[0]),Math.max(y[1],e[1])]}return t.splice(a,0,e),t}const qG={interpolation:{duration:0,easing:i=>i},spring:{stiffness:.05,damping:.5}};function GP(i,e){if(!i)return null;Number.isFinite(i)&&(i={type:"interpolation",duration:i});const t=i.type||"interpolation";return{...qG[t],...e,...i,type:t}}class $P extends HG{constructor(e,t){super(e,t,{startIndices:null,lastExternalBuffer:null,binaryValue:null,binaryAccessor:null,needsUpdate:!0,needsRedraw:!1,layoutChanged:!1,updateRanges:Qg}),this.constant=!1,this.settings.update=t.update||(t.accessor?this._autoUpdater:void 0),Object.seal(this.settings),Object.seal(this.state),this._validateAttributeUpdaters()}get startIndices(){return this.state.startIndices}set startIndices(e){this.state.startIndices=e}needsUpdate(){return this.state.needsUpdate}needsRedraw({clearChangedFlags:e=!1}={}){const t=this.state.needsRedraw;return this.state.needsRedraw=t&&!e,t}layoutChanged(){return this.state.layoutChanged}setAccessor(e){var t;(t=this.state).layoutChanged||(t.layoutChanged=!VG(e,this.getAccessor())),super.setAccessor(e)}getUpdateTriggers(){const{accessor:e}=this.settings;return[this.id].concat(typeof e!="function"&&e||[])}supportsTransition(){return!!this.settings.transition}getTransitionSetting(e){if(!e||!this.supportsTransition())return null;const{accessor:t}=this.settings,r=this.settings.transition,a=Array.isArray(t)?e[t.find(h=>e[h])]:e[t];return GP(a,r)}setNeedsUpdate(e=this.id,t){if(this.state.needsUpdate=this.state.needsUpdate||e,this.setNeedsRedraw(e),t){const{startRow:r=0,endRow:a=1/0}=t;this.state.updateRanges=WG(this.state.updateRanges,[r,a])}else this.state.updateRanges=Qg}clearNeedsUpdate(){this.state.needsUpdate=!1,this.state.updateRanges=$G}setNeedsRedraw(e=this.id){this.state.needsRedraw=this.state.needsRedraw||e}allocate(e){const{state:t,settings:r}=this;return r.noAlloc?!1:r.update?(super.allocate(e,t.updateRanges!==Qg),!0):!1}updateBuffer({numInstances:e,data:t,props:r,context:a}){if(!this.needsUpdate())return!1;const{state:{updateRanges:h},settings:{update:y,noAlloc:s}}=this;let T=!0;if(y){for(const[B,F]of h)y.call(a,this,{data:t,startRow:B,endRow:F,props:r,numInstances:e});if(this.value)if(this.constant||!this.buffer||this.buffer.byteLength<this.value.byteLength+this.byteOffset)this.setData({value:this.value,constant:this.constant}),this.constant=!1;else for(const[B,F]of h){const V=Number.isFinite(B)?this.getVertexOffset(B):0,X=Number.isFinite(F)?this.getVertexOffset(F):s||!Number.isFinite(e)?this.value.length:e*this.size;super.updateSubBuffer({startOffset:V,endOffset:X})}this._checkAttributeArray()}else T=!1;return this.clearNeedsUpdate(),this.setNeedsRedraw(),T}setConstantValue(e){return this.device.type==="webgpu"||e===void 0||typeof e=="function"?!1:(this.setData({constant:!0,value:e})&&this.setNeedsRedraw(),this.clearNeedsUpdate(),!0)}setExternalBuffer(e){const{state:t}=this;return e?(this.clearNeedsUpdate(),t.lastExternalBuffer===e||(t.lastExternalBuffer=e,this.setNeedsRedraw(),this.setData(e)),!0):(t.lastExternalBuffer=null,!1)}setBinaryValue(e,t=null){const{state:r,settings:a}=this;if(!e)return r.binaryValue=null,r.binaryAccessor=null,!1;if(a.noAlloc)return!1;if(r.binaryValue===e)return this.clearNeedsUpdate(),!0;if(r.binaryValue=e,this.setNeedsRedraw(),a.transform||t!==this.startIndices){ArrayBuffer.isView(e)&&(e={value:e});const y=e;In(ArrayBuffer.isView(y.value),`invalid ${a.accessor}`);const s=!!y.size&&y.size!==this.size;return r.binaryAccessor=GG(y.value,{size:y.size||this.size,stride:y.stride,offset:y.offset,startIndices:t,nested:s}),!1}return this.clearNeedsUpdate(),this.setData(e),!0}getVertexOffset(e){const{startIndices:t}=this;return(t?e<t.length?t[e]:this.numInstances:e)*this.size}getValue(){const e=this.settings.shaderAttributes,t=super.getValue();if(!e)return t;for(const r in e)Object.assign(t,super.getValue(r,e[r]));return t}getBufferLayout(e){this.state.layoutChanged=!1;const t=this.settings.shaderAttributes,r=super._getBufferLayout(),{stepMode:a}=this.settings;if(a==="dynamic"?r.stepMode=e?e.isInstanced?"instance":"vertex":"instance":r.stepMode=a??"vertex",!t)return r;for(const h in t){const y=super._getBufferLayout(h,t[h]);r.attributes.push(...y.attributes)}return r}_autoUpdater(e,{data:t,startRow:r,endRow:a,props:h,numInstances:y}){if(e.constant&&this.context.device.type!=="webgpu")return;const{settings:s,state:T,value:B,size:F,startIndices:V}=e,{accessor:X,transform:se}=s;let ne=T.binaryAccessor||(typeof X=="function"?X:h[X]);typeof ne!="function"&&(ne=()=>ne),In(typeof ne=="function",`accessor "${X}" is not a function`);let K=e.getVertexOffset(r);const{iterable:ue,objectInfo:_e}=jP(t,r,a);for(const ke of ue){_e.index++;let we=ne(ke,_e);if(se&&(we=se.call(this,we)),V){const ge=(_e.index<V.length-1?V[_e.index+1]:y)-V[_e.index];if(we&&Array.isArray(we[0])){let Le=K;for(const $e of we)e._normalizeValue($e,B,Le),Le+=F}else we&&we.length>F?B.set(we,K):(e._normalizeValue(we,_e.target,0),a9({target:B,source:_e.target,start:K,count:ge}));K+=ge*F}else e._normalizeValue(we,B,K),K+=F}}_validateAttributeUpdaters(){const{settings:e}=this;if(!(e.noAlloc||typeof e.update=="function"))throw new Error(`Attribute ${this.id} missing update or accessor`)}_checkAttributeArray(){const{value:e}=this,t=Math.min(4,this.size);if(e&&e.length>=t){let r=!0;switch(t){case 4:r=r&&Number.isFinite(e[3]);case 3:r=r&&Number.isFinite(e[2]);case 2:r=r&&Number.isFinite(e[1]);case 1:r=r&&Number.isFinite(e[0]);break;default:r=!1}if(!r)throw new Error(`Illegal attribute generated for ${this.id}`)}}}function cb(i){const{source:e,target:t,start:r=0,size:a,getData:h}=i,y=i.end||t.length,s=e.length,T=y-r;if(s>T){t.set(e.subarray(0,T),r);return}if(t.set(e,r),!h)return;let B=s;for(;B<T;){const F=h(B,e);for(let V=0;V<a;V++)t[r+B]=F[V]||0,B++}}function XG({source:i,target:e,size:t,getData:r,sourceStartIndices:a,targetStartIndices:h}){if(!a||!h)return cb({source:i,target:e,size:t,getData:r}),e;let y=0,s=0;const T=r&&((F,V)=>r(F+s,V)),B=Math.min(a.length,h.length);for(let F=1;F<B;F++){const V=a[F]*t,X=h[F]*t;cb({source:i.subarray(y,V),target:e,start:s,end:X,size:t,getData:T}),y=V,s=X}return s<e.length&&cb({source:[],target:e,start:s,size:t,getData:T}),e}function ZG(i){const{device:e,settings:t,value:r}=i,a=new $P(e,t);return a.setData({value:r instanceof Float64Array?new Float64Array(0):new Float32Array(0),normalized:t.normalized}),a}function WP(i){switch(i){case 1:return"float";case 2:return"vec2";case 3:return"vec3";case 4:return"vec4";default:throw new Error(`No defined attribute type for size "${i}"`)}}function qP(i){switch(i){case 1:return"float32";case 2:return"float32x2";case 3:return"float32x3";case 4:return"float32x4";default:throw new Error("invalid type size")}}function XP(i){i.push(i.shift())}function YG(i,e){const{doublePrecision:t,settings:r,value:a,size:h}=i,y=t&&a instanceof Float64Array?2:1;let s=0;const{shaderAttributes:T}=i.settings;if(T)for(const B of Object.values(T))s=Math.max(s,B.vertexOffset??0);return(r.noAlloc?a.length:(e+s)*h)*y}function ZP({device:i,source:e,target:t}){return(!t||t.byteLength<e.byteLength)&&(t==null||t.destroy(),t=i.createBuffer({byteLength:e.byteLength,usage:e.usage})),t}function YP({device:i,buffer:e,attribute:t,fromLength:r,toLength:a,fromStartIndices:h,getData:y=s=>s}){const s=t.doublePrecision&&t.value instanceof Float64Array?2:1,T=t.size*s,B=t.byteOffset,F=t.settings.bytesPerElement<4?B/t.settings.bytesPerElement*4:B,V=t.startIndices,X=h&&V,se=t.isConstant;if(!X&&e&&r>=a)return e;const ne=t.value instanceof Float64Array?Float32Array:t.value.constructor,K=se?t.value:new ne(t.getBuffer().readSyncWebGL(B,a*ne.BYTES_PER_ELEMENT).buffer);if(t.settings.normalized&&!se){const we=y;y=(ge,Le)=>t.normalizeConstant(we(ge,Le))}const ue=se?(we,ge)=>y(K,ge):(we,ge)=>y(K.subarray(we+B,we+B+T),ge),_e=e?new Float32Array(e.readSyncWebGL(F,r*4).buffer):new Float32Array(0),ke=new Float32Array(a);return XG({source:_e,target:ke,sourceStartIndices:h,targetStartIndices:V,size:T,getData:ue}),(!e||e.byteLength<ke.byteLength+F)&&(e==null||e.destroy(),e=i.createBuffer({byteLength:ke.byteLength+F,usage:35050})),e.write(ke,F),e}class KP{constructor({device:e,attribute:t,timeline:r}){this.buffers=[],this.currentLength=0,this.device=e,this.transition=new y0(r),this.attribute=t,this.attributeInTransition=ZG(t),this.currentStartIndices=t.startIndices}get inProgress(){return this.transition.inProgress}start(e,t,r=1/0){this.settings=e,this.currentStartIndices=this.attribute.startIndices,this.currentLength=YG(this.attribute,t),this.transition.start({...e,duration:r})}update(){const e=this.transition.update();return e&&this.onUpdate(),e}setBuffer(e){this.attributeInTransition.setData({buffer:e,normalized:this.attribute.settings.normalized,value:this.attributeInTransition.value})}cancel(){this.transition.cancel()}delete(){this.cancel();for(const e of this.buffers)e.destroy();this.buffers.length=0}}class KG extends KP{constructor({device:e,attribute:t,timeline:r}){super({device:e,attribute:t,timeline:r}),this.type="interpolation",this.transform=t$(e,t)}start(e,t){const r=this.currentLength,a=this.currentStartIndices;if(super.start(e,t,e.duration),e.duration<=0){this.transition.cancel();return}const{buffers:h,attribute:y}=this;XP(h),h[0]=YP({device:this.device,buffer:h[0],attribute:y,fromLength:r,toLength:this.currentLength,fromStartIndices:a,getData:e.enter}),h[1]=ZP({device:this.device,source:h[0],target:h[1]}),this.setBuffer(h[1]);const{transform:s}=this,T=s.model;let B=Math.floor(this.currentLength/y.size);JP(y)&&(B/=2),T.setVertexCount(B),y.isConstant?(T.setAttributes({aFrom:h[0]}),T.setConstantAttributes({aTo:y.value})):T.setAttributes({aFrom:h[0],aTo:y.getBuffer()}),s.transformFeedback.setBuffers({vCurrent:h[1]})}onUpdate(){const{duration:e,easing:t}=this.settings,{time:r}=this.transition;let a=r/e;t&&(a=t(a));const{model:h}=this.transform,y={time:a};h.shaderInputs.setProps({interpolation:y}),this.transform.run({discard:!0})}delete(){super.delete(),this.transform.destroy()}}const JG=`uniform interpolationUniforms {
  float time;
} interpolation;
`,fI={name:"interpolation",vs:JG,uniformTypes:{time:"f32"}},QG=`#version 300 es
#define SHADER_NAME interpolation-transition-vertex-shader

in ATTRIBUTE_TYPE aFrom;
in ATTRIBUTE_TYPE aTo;
out ATTRIBUTE_TYPE vCurrent;

void main(void) {
  vCurrent = mix(aFrom, aTo, interpolation.time);
  gl_Position = vec4(0.0);
}
`,e$=`#version 300 es
#define SHADER_NAME interpolation-transition-vertex-shader

in ATTRIBUTE_TYPE aFrom;
in ATTRIBUTE_TYPE aFrom64Low;
in ATTRIBUTE_TYPE aTo;
in ATTRIBUTE_TYPE aTo64Low;
out ATTRIBUTE_TYPE vCurrent;
out ATTRIBUTE_TYPE vCurrent64Low;

vec2 mix_fp64(vec2 a, vec2 b, float x) {
  vec2 range = sub_fp64(b, a);
  return sum_fp64(a, mul_fp64(range, vec2(x, 0.0)));
}

void main(void) {
  for (int i=0; i<ATTRIBUTE_SIZE; i++) {
    vec2 value = mix_fp64(vec2(aFrom[i], aFrom64Low[i]), vec2(aTo[i], aTo64Low[i]), interpolation.time);
    vCurrent[i] = value.x;
    vCurrent64Low[i] = value.y;
  }
  gl_Position = vec4(0.0);
}
`;function JP(i){return i.doublePrecision&&i.value instanceof Float64Array}function t$(i,e){const t=e.size,r=WP(t),a=qP(t),h=e.getBufferLayout();return JP(e)?new wm(i,{vs:e$,bufferLayout:[{name:"aFrom",byteStride:8*t,attributes:[{attribute:"aFrom",format:a,byteOffset:0},{attribute:"aFrom64Low",format:a,byteOffset:4*t}]},{name:"aTo",byteStride:8*t,attributes:[{attribute:"aTo",format:a,byteOffset:0},{attribute:"aTo64Low",format:a,byteOffset:4*t}]}],modules:[V6,fI],defines:{ATTRIBUTE_TYPE:r,ATTRIBUTE_SIZE:t},moduleSettings:{},varyings:["vCurrent","vCurrent64Low"],bufferMode:35980,disableWarnings:!0}):new wm(i,{vs:QG,bufferLayout:[{name:"aFrom",format:a},{name:"aTo",format:h.attributes[0].format}],modules:[fI],defines:{ATTRIBUTE_TYPE:r},varyings:["vCurrent"],disableWarnings:!0})}class i$ extends KP{constructor({device:e,attribute:t,timeline:r}){super({device:e,attribute:t,timeline:r}),this.type="spring",this.texture=l$(e),this.framebuffer=c$(e,this.texture),this.transform=a$(e,t)}start(e,t){const r=this.currentLength,a=this.currentStartIndices;super.start(e,t);const{buffers:h,attribute:y}=this;for(let T=0;T<2;T++)h[T]=YP({device:this.device,buffer:h[T],attribute:y,fromLength:r,toLength:this.currentLength,fromStartIndices:a,getData:e.enter});h[2]=ZP({device:this.device,source:h[0],target:h[2]}),this.setBuffer(h[1]);const{model:s}=this.transform;s.setVertexCount(Math.floor(this.currentLength/y.size)),y.isConstant?s.setConstantAttributes({aTo:y.value}):s.setAttributes({aTo:y.getBuffer()})}onUpdate(){const{buffers:e,transform:t,framebuffer:r,transition:a}=this,h=this.settings;t.model.setAttributes({aPrev:e[0],aCur:e[1]}),t.transformFeedback.setBuffers({vNext:e[2]});const y={stiffness:h.stiffness,damping:h.damping};t.model.shaderInputs.setProps({spring:y}),t.run({framebuffer:r,discard:!1,parameters:{viewport:[0,0,1,1]},clearColor:[0,0,0,0]}),XP(e),this.setBuffer(e[1]),this.device.readPixelsToArrayWebGL(r)[0]>0||a.end()}delete(){super.delete(),this.transform.destroy(),this.texture.destroy(),this.framebuffer.destroy()}}const r$=`uniform springUniforms {
  float damping;
  float stiffness;
} spring;
`,n$={name:"spring",vs:r$,uniformTypes:{damping:"f32",stiffness:"f32"}},s$=`#version 300 es
#define SHADER_NAME spring-transition-vertex-shader

#define EPSILON 0.00001

in ATTRIBUTE_TYPE aPrev;
in ATTRIBUTE_TYPE aCur;
in ATTRIBUTE_TYPE aTo;
out ATTRIBUTE_TYPE vNext;
out float vIsTransitioningFlag;

ATTRIBUTE_TYPE getNextValue(ATTRIBUTE_TYPE cur, ATTRIBUTE_TYPE prev, ATTRIBUTE_TYPE dest) {
  ATTRIBUTE_TYPE velocity = cur - prev;
  ATTRIBUTE_TYPE delta = dest - cur;
  ATTRIBUTE_TYPE force = delta * spring.stiffness;
  ATTRIBUTE_TYPE resistance = velocity * spring.damping;
  return force - resistance + velocity + cur;
}

void main(void) {
  bool isTransitioning = length(aCur - aPrev) > EPSILON || length(aTo - aCur) > EPSILON;
  vIsTransitioningFlag = isTransitioning ? 1.0 : 0.0;

  vNext = getNextValue(aCur, aPrev, aTo);
  gl_Position = vec4(0, 0, 0, 1);
  gl_PointSize = 100.0;
}
`,o$=`#version 300 es
#define SHADER_NAME spring-transition-is-transitioning-fragment-shader

in float vIsTransitioningFlag;

out vec4 fragColor;

void main(void) {
  if (vIsTransitioningFlag == 0.0) {
    discard;
  }
  fragColor = vec4(1.0);
}`;function a$(i,e){const t=WP(e.size),r=qP(e.size);return new wm(i,{vs:s$,fs:o$,bufferLayout:[{name:"aPrev",format:r},{name:"aCur",format:r},{name:"aTo",format:e.getBufferLayout().attributes[0].format}],varyings:["vNext"],modules:[n$],defines:{ATTRIBUTE_TYPE:t},parameters:{depthCompare:"always",blendColorOperation:"max",blendColorSrcFactor:"one",blendColorDstFactor:"one",blendAlphaOperation:"max",blendAlphaSrcFactor:"one",blendAlphaDstFactor:"one"}})}function l$(i){return i.createTexture({data:new Uint8Array(4),format:"rgba8unorm",mipmaps:!1,width:1,height:1})}function c$(i,e){return i.createFramebuffer({id:"spring-transition-is-transitioning-framebuffer",width:1,height:1,colorAttachments:[e]})}const u$={interpolation:KG,spring:i$};class h${constructor(e,{id:t,timeline:r}){if(!e)throw new Error("AttributeTransitionManager is constructed without device");this.id=t,this.device=e,this.timeline=r,this.transitions={},this.needsRedraw=!1,this.numInstances=1}finalize(){for(const e in this.transitions)this._removeTransition(e)}update({attributes:e,transitions:t,numInstances:r}){this.numInstances=r||1;for(const a in e){const h=e[a],y=h.getTransitionSetting(t);y&&this._updateAttribute(a,h,y)}for(const a in this.transitions){const h=e[a];(!h||!h.getTransitionSetting(t))&&this._removeTransition(a)}}hasAttribute(e){const t=this.transitions[e];return t&&t.inProgress}getAttributes(){const e={};for(const t in this.transitions){const r=this.transitions[t];r.inProgress&&(e[t]=r.attributeInTransition)}return e}run(){if(this.numInstances===0)return!1;for(const t in this.transitions)this.transitions[t].update()&&(this.needsRedraw=!0);const e=this.needsRedraw;return this.needsRedraw=!1,e}_removeTransition(e){this.transitions[e].delete(),delete this.transitions[e]}_updateAttribute(e,t,r){const a=this.transitions[e];let h=!a||a.type!==r.type;if(h){a&&this._removeTransition(e);const y=u$[r.type];y?this.transitions[e]=new y({attribute:t,timeline:this.timeline,device:this.device}):(gr.error(`unsupported transition type '${r.type}'`)(),h=!1)}(h||t.needsRedraw())&&(this.needsRedraw=!0,this.transitions[e].start(r,this.numInstances))}}const pI="attributeManager.invalidate",d$="attributeManager.updateStart",f$="attributeManager.updateEnd",p$="attribute.updateStart",m$="attribute.allocate",_$="attribute.updateEnd";class g${constructor(e,{id:t="attribute-manager",stats:r,timeline:a}={}){this.mergeBoundsMemoized=Lm(uj),this.id=t,this.device=e,this.attributes={},this.updateTriggers={},this.needsRedraw=!0,this.userData={},this.stats=r,this.attributeTransitionManager=new h$(e,{id:`${t}-transitions`,timeline:a}),Object.seal(this)}finalize(){for(const e in this.attributes)this.attributes[e].delete();this.attributeTransitionManager.finalize()}getNeedsRedraw(e={clearRedrawFlags:!1}){const t=this.needsRedraw;return this.needsRedraw=this.needsRedraw&&!e.clearRedrawFlags,t&&this.id}setNeedsRedraw(){this.needsRedraw=!0}add(e){this._add(e)}addInstanced(e){this._add(e,{stepMode:"instance"})}remove(e){for(const t of e)this.attributes[t]!==void 0&&(this.attributes[t].delete(),delete this.attributes[t])}invalidate(e,t){const r=this._invalidateTrigger(e,t);bs(pI,this,e,r)}invalidateAll(e){for(const t in this.attributes)this.attributes[t].setNeedsUpdate(t,e);bs(pI,this,"all")}update({data:e,numInstances:t,startIndices:r=null,transitions:a,props:h={},buffers:y={},context:s={}}){let T=!1;bs(d$,this),this.stats&&this.stats.get("Update Attributes").timeStart();for(const B in this.attributes){const F=this.attributes[B],V=F.settings.accessor;F.startIndices=r,F.numInstances=t,h[B]&&gr.removed(`props.${B}`,`data.attributes.${B}`)(),F.setExternalBuffer(y[B])||F.setBinaryValue(typeof V=="string"?y[V]:void 0,e.startIndices)||typeof V=="string"&&!y[V]&&F.setConstantValue(h[V])||F.needsUpdate()&&(T=!0,this._updateAttribute({attribute:F,numInstances:t,data:e,props:h,context:s})),this.needsRedraw=this.needsRedraw||F.needsRedraw()}T&&bs(f$,this,t),this.stats&&this.stats.get("Update Attributes").timeEnd(),this.attributeTransitionManager.update({attributes:this.attributes,numInstances:t,transitions:a})}updateTransition(){const{attributeTransitionManager:e}=this,t=e.run();return this.needsRedraw=this.needsRedraw||t,t}getAttributes(){return{...this.attributes,...this.attributeTransitionManager.getAttributes()}}getBounds(e){const t=e.map(r=>{var a;return(a=this.attributes[r])==null?void 0:a.getBounds()});return this.mergeBoundsMemoized(t)}getChangedAttributes(e={clearChangedFlags:!1}){const{attributes:t,attributeTransitionManager:r}=this,a={...r.getAttributes()};for(const h in t){const y=t[h];y.needsRedraw(e)&&!r.hasAttribute(h)&&(a[h]=y)}return a}getBufferLayouts(e){return Object.values(this.getAttributes()).map(t=>t.getBufferLayout(e))}_add(e,t){for(const r in e){const a=e[r],h={...a,id:r,size:a.isIndexed&&1||a.size||1,...t};this.attributes[r]=new $P(this.device,h)}this._mapUpdateTriggersToAttributes()}_mapUpdateTriggersToAttributes(){const e={};for(const t in this.attributes)this.attributes[t].getUpdateTriggers().forEach(a=>{e[a]||(e[a]=[]),e[a].push(t)});this.updateTriggers=e}_invalidateTrigger(e,t){const{attributes:r,updateTriggers:a}=this,h=a[e];return h&&h.forEach(y=>{const s=r[y];s&&s.setNeedsUpdate(s.id,t)}),h}_updateAttribute(e){const{attribute:t,numInstances:r}=e;if(bs(p$,t),t.constant){t.setConstantValue(t.value);return}t.allocate(r)&&bs(m$,t,r),t.updateBuffer(e)&&(this.needsRedraw=!0,bs(_$,t,r))}}class y$ extends y0{get value(){return this._value}_onUpdate(){const{time:e,settings:{fromValue:t,toValue:r,duration:a,easing:h}}=this,y=h(e/a);this._value=Cy(t,r,y)}}const mI=1e-5;function _I(i,e,t,r,a){const h=e-i,s=(t-e)*a,T=-h*r;return s+T+h+e}function v$(i,e,t,r,a){if(Array.isArray(t)){const h=[];for(let y=0;y<t.length;y++)h[y]=_I(i[y],e[y],t[y],r,a);return h}return _I(i,e,t,r,a)}function gI(i,e){if(Array.isArray(i)){let t=0;for(let r=0;r<i.length;r++){const a=i[r]-e[r];t+=a*a}return Math.sqrt(t)}return Math.abs(i-e)}class x$ extends y0{get value(){return this._currValue}_onUpdate(){const{fromValue:e,toValue:t,damping:r,stiffness:a}=this.settings,{_prevValue:h=e,_currValue:y=e}=this;let s=v$(h,y,t,r,a);const T=gI(s,t),B=gI(s,y);T<mI&&B<mI&&(s=t,this.end()),this._prevValue=y,this._currValue=s}}const b$={interpolation:y$,spring:x$};class w${constructor(e){this.transitions=new Map,this.timeline=e}get active(){return this.transitions.size>0}add(e,t,r,a){const{transitions:h}=this;if(h.has(e)){const T=h.get(e),{value:B=T.settings.fromValue}=T;t=B,this.remove(e)}if(a=GP(a),!a)return;const y=b$[a.type];if(!y){gr.error(`unsupported transition type '${a.type}'`)();return}const s=new y(this.timeline);s.start({...a,fromValue:t,toValue:r}),h.set(e,s)}remove(e){const{transitions:t}=this;t.has(e)&&(t.get(e).cancel(),t.delete(e))}update(){const e={};for(const[t,r]of this.transitions)r.update(),e[t]=r.value,r.inProgress||this.remove(t);return e}clear(){for(const e of this.transitions.keys())this.remove(e)}}function A$(i){const e=i[Au];for(const t in e){const r=e[t],{validate:a}=r;if(a&&!a(i[t],r))throw new Error(`Invalid prop ${t}: ${i[t]}`)}}function T$(i,e){const t=QP({newProps:i,oldProps:e,propTypes:i[Au],ignoreProps:{data:null,updateTriggers:null,extensions:null,transitions:null}}),r=S$(i,e);let a=!1;return r||(a=I$(i,e)),{dataChanged:r,propsChanged:t,updateTriggersChanged:a,extensionsChanged:C$(i,e),transitionsChanged:E$(i,e)}}function E$(i,e){if(!i.transitions)return!1;const t={},r=i[Au];let a=!1;for(const h in i.transitions){const y=r[h],s=y&&y.type;(s==="number"||s==="color"||s==="array")&&aw(i[h],e[h],y)&&(t[h]=!0,a=!0)}return a?t:!1}function QP({newProps:i,oldProps:e,ignoreProps:t={},propTypes:r={},triggerName:a="props"}){if(e===i)return!1;if(typeof i!="object"||i===null)return`${a} changed shallowly`;if(typeof e!="object"||e===null)return`${a} changed shallowly`;for(const h of Object.keys(i))if(!(h in t)){if(!(h in e))return`${a}.${h} added`;const y=aw(i[h],e[h],r[h]);if(y)return`${a}.${h} ${y}`}for(const h of Object.keys(e))if(!(h in t)){if(!(h in i))return`${a}.${h} dropped`;if(!Object.hasOwnProperty.call(i,h)){const y=aw(i[h],e[h],r[h]);if(y)return`${a}.${h} ${y}`}}return!1}function aw(i,e,t){let r=t&&t.equal;return r&&!r(i,e,t)||!r&&(r=i&&e&&i.equals,r&&!r.call(i,e))?"changed deeply":!r&&e!==i?"changed shallowly":null}function S$(i,e){if(e===null)return"oldProps is null, initial diff";let t=!1;const{dataComparator:r,_dataDiff:a}=i;return r?r(i.data,e.data)||(t="Data comparator detected a change"):i.data!==e.data&&(t="A new data container was supplied"),t&&a&&(t=a(i.data,e.data)||t),t}function I$(i,e){if(e===null)return{all:!0};if("all"in i.updateTriggers&&yI(i,e,"all"))return{all:!0};const t={};let r=!1;for(const a in i.updateTriggers)a!=="all"&&yI(i,e,a)&&(t[a]=!0,r=!0);return r?t:!1}function C$(i,e){if(e===null)return!0;const t=e.extensions,{extensions:r}=i;if(r===t)return!1;if(!t||!r||r.length!==t.length)return!0;for(let a=0;a<r.length;a++)if(!r[a].equals(t[a]))return!0;return!1}function yI(i,e,t){let r=i.updateTriggers[t];r=r??{};let a=e.updateTriggers[t];return a=a??{},QP({oldProps:a,newProps:r,triggerName:t})}const M$="count(): argument not an object",R$="count(): argument not a container";function P$(i){if(!D$(i))throw new Error(M$);if(typeof i.count=="function")return i.count();if(Number.isFinite(i.size))return i.size;if(Number.isFinite(i.length))return i.length;if(B$(i))return Object.keys(i).length;throw new Error(R$)}function B$(i){return i!==null&&typeof i=="object"&&i.constructor===Object}function D$(i){return i!==null&&typeof i=="object"}function vI(i,e){if(!e)return i;const t={...i,...e};if("defines"in e&&(t.defines={...i.defines,...e.defines}),"modules"in e&&(t.modules=(i.modules||[]).concat(e.modules),e.modules.some(r=>r.name==="project64"))){const r=t.modules.findIndex(a=>a.name==="project32");r>=0&&t.modules.splice(r,1)}if("inject"in e)if(!i.inject)t.inject=e.inject;else{const r={...i.inject};for(const a in e.inject)r[a]=(r[a]||"")+e.inject[a];t.inject=r}return t}const O$={minFilter:"linear",mipmapFilter:"linear",magFilter:"linear",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"},lw={};function F$(i,e,t,r){if(t instanceof en)return t;t.constructor&&t.constructor.name!=="Object"&&(t={data:t});let a=null;t.compressed&&(a={minFilter:"linear",mipmapFilter:t.data.length>1?"nearest":"linear"});const h=e.createTexture({...t,sampler:{...O$,...a,...r},mipmaps:!0});return lw[h.id]=i,h}function k$(i,e){!e||!(e instanceof en)||lw[e.id]===i&&(e.delete(),delete lw[e.id])}const L$={boolean:{validate(i,e){return!0},equal(i,e,t){return!!i==!!e}},number:{validate(i,e){return Number.isFinite(i)&&(!("max"in e)||i<=e.max)&&(!("min"in e)||i>=e.min)}},color:{validate(i,e){return e.optional&&!i||cw(i)&&(i.length===3||i.length===4)},equal(i,e,t){return Zo(i,e,1)}},accessor:{validate(i,e){const t=Ny(i);return t==="function"||t===Ny(e.value)},equal(i,e,t){return typeof e=="function"?!0:Zo(i,e,1)}},array:{validate(i,e){return e.optional&&!i||cw(i)},equal(i,e,t){const{compare:r}=t,a=Number.isInteger(r)?r:r?1:0;return r?Zo(i,e,a):i===e}},object:{equal(i,e,t){if(t.ignore)return!0;const{compare:r}=t,a=Number.isInteger(r)?r:r?1:0;return r?Zo(i,e,a):i===e}},function:{validate(i,e){return e.optional&&!i||typeof i=="function"},equal(i,e,t){return!t.compare&&t.ignore!==!1||i===e}},data:{transform:(i,e,t)=>{if(!i)return i;const{dataTransform:r}=t.props;return r?r(i):typeof i.shape=="string"&&i.shape.endsWith("-table")&&Array.isArray(i.data)?i.data:i}},image:{transform:(i,e,t)=>{const r=t.context;return!r||!r.device?null:F$(t.id,r.device,i,{...e.parameters,...t.props.textureParameters})},release:(i,e,t)=>{k$(t.id,i)}}};function N$(i){const e={},t={},r={};for(const[a,h]of Object.entries(i)){const y=h==null?void 0:h.deprecatedFor;if(y)r[a]=Array.isArray(y)?y:[y];else{const s=z$(a,h);e[a]=s,t[a]=s.value}}return{propTypes:e,defaultProps:t,deprecatedProps:r}}function z$(i,e){switch(Ny(e)){case"object":return Np(i,e);case"array":return Np(i,{type:"array",value:e,compare:!1});case"boolean":return Np(i,{type:"boolean",value:e});case"number":return Np(i,{type:"number",value:e});case"function":return Np(i,{type:"function",value:e,compare:!0});default:return{name:i,type:"unknown",value:e}}}function Np(i,e){return"type"in e?{name:i,...L$[e.type],...e}:"value"in e?{name:i,type:Ny(e.value),...e}:{name:i,type:"object",value:e}}function cw(i){return Array.isArray(i)||ArrayBuffer.isView(i)}function Ny(i){return cw(i)?"array":i===null?"null":typeof i}function U$(i,e){let t;for(let h=e.length-1;h>=0;h--){const y=e[h];"extensions"in y&&(t=y.extensions)}const r=uw(i.constructor,t),a=Object.create(r);a[ky]=i,a[Bu]={},a[nc]={};for(let h=0;h<e.length;++h){const y=e[h];for(const s in y)a[s]=y[s]}return Object.freeze(a),a}const V$="_mergedDefaultProps";function uw(i,e){if(!(i instanceof v0.constructor))return{};let t=V$;if(e)for(const a of e){const h=a.constructor;h&&(t+=`:${h.extensionName||h.name}`)}const r=eB(i,t);return r||(i[t]=j$(i,e||[]))}function j$(i,e){if(!i.prototype)return null;const r=Object.getPrototypeOf(i),a=uw(r),h=eB(i,"defaultProps")||{},y=N$(h),s=Object.assign(Object.create(null),a,y.defaultProps),T=Object.assign(Object.create(null),a==null?void 0:a[Au],y.propTypes),B=Object.assign(Object.create(null),a==null?void 0:a[nb],y.deprecatedProps);for(const F of e){const V=uw(F.constructor);V&&(Object.assign(s,V),Object.assign(T,V[Au]),Object.assign(B,V[nb]))}return H$(s,i),$$(s,T),G$(s,B),s[Au]=T,s[nb]=B,e.length===0&&!_A(i,"_propTypes")&&(i._propTypes=T),s}function H$(i,e){const t=q$(e);Object.defineProperties(i,{id:{writable:!0,value:t}})}function G$(i,e){for(const t in e)Object.defineProperty(i,t,{enumerable:!1,set(r){const a=`${this.id}: ${t}`;for(const h of e[t])_A(this,h)||(this[h]=r);gr.deprecated(a,e[t].join("/"))()}})}function $$(i,e){const t={},r={};for(const a in e){const h=e[a],{name:y,value:s}=h;h.async&&(t[y]=s,r[y]=W$(y))}i[gd]=t,i[Bu]={},Object.defineProperties(i,r)}function W$(i){return{enumerable:!0,set(e){typeof e=="string"||e instanceof Promise||HP(e)?this[Bu][i]=e:this[nc][i]=e},get(){if(this[nc]){if(i in this[nc])return this[nc][i]||this[gd][i];if(i in this[Bu]){const e=this[ky]&&this[ky].internalState;if(e&&e.hasAsyncProp(i))return e.getAsyncProp(i)||this[gd][i]}}return this[gd][i]}}}function _A(i,e){return Object.prototype.hasOwnProperty.call(i,e)}function eB(i,e){return _A(i,e)&&i[e]}function q$(i){const e=i.componentName;return e||gr.warn(`${i.name}.componentName not specified`)(),e||i.name}let X$=0;class v0{constructor(...e){this.props=U$(this,e),this.id=this.props.id,this.count=X$++}clone(e){const{props:t}=this,r={};for(const a in t[gd])a in t[nc]?r[a]=t[nc][a]:a in t[Bu]&&(r[a]=t[Bu][a]);return new this.constructor({...t,...r,...e})}}v0.componentName="Component";v0.defaultProps={};const Z$=Object.freeze({});class Y${constructor(e){this.component=e,this.asyncProps={},this.onAsyncPropUpdated=()=>{},this.oldProps=null,this.oldAsyncProps=null}finalize(){for(const e in this.asyncProps){const t=this.asyncProps[e];t&&t.type&&t.type.release&&t.type.release(t.resolvedValue,t.type,this.component)}this.asyncProps={},this.component=null,this.resetOldProps()}getOldProps(){return this.oldAsyncProps||this.oldProps||Z$}resetOldProps(){this.oldAsyncProps=null,this.oldProps=this.component?this.component.props:null}hasAsyncProp(e){return e in this.asyncProps}getAsyncProp(e){const t=this.asyncProps[e];return t&&t.resolvedValue}isAsyncPropLoading(e){if(e){const t=this.asyncProps[e];return!!(t&&t.pendingLoadCount>0&&t.pendingLoadCount!==t.resolvedLoadCount)}for(const t in this.asyncProps)if(this.isAsyncPropLoading(t))return!0;return!1}reloadAsyncProp(e,t){this._watchPromise(e,Promise.resolve(t))}setAsyncProps(e){this.component=e[ky]||this.component;const t=e[nc]||{},r=e[Bu]||e,a=e[gd]||{};for(const h in t){const y=t[h];this._createAsyncPropData(h,a[h]),this._updateAsyncProp(h,y),t[h]=this.getAsyncProp(h)}for(const h in r){const y=r[h];this._createAsyncPropData(h,a[h]),this._updateAsyncProp(h,y)}}_fetch(e,t){return null}_onResolve(e,t){}_onError(e,t){}_updateAsyncProp(e,t){if(this._didAsyncInputValueChange(e,t)){if(typeof t=="string"&&(t=this._fetch(e,t)),t instanceof Promise){this._watchPromise(e,t);return}if(HP(t)){this._resolveAsyncIterable(e,t);return}this._setPropValue(e,t)}}_freezeAsyncOldProps(){if(!this.oldAsyncProps&&this.oldProps){this.oldAsyncProps=Object.create(this.oldProps);for(const e in this.asyncProps)Object.defineProperty(this.oldAsyncProps,e,{enumerable:!0,value:this.oldProps[e]})}}_didAsyncInputValueChange(e,t){const r=this.asyncProps[e];return t===r.resolvedValue||t===r.lastValue?!1:(r.lastValue=t,!0)}_setPropValue(e,t){this._freezeAsyncOldProps();const r=this.asyncProps[e];r&&(t=this._postProcessValue(r,t),r.resolvedValue=t,r.pendingLoadCount++,r.resolvedLoadCount=r.pendingLoadCount)}_setAsyncPropValue(e,t,r){const a=this.asyncProps[e];a&&r>=a.resolvedLoadCount&&t!==void 0&&(this._freezeAsyncOldProps(),a.resolvedValue=t,a.resolvedLoadCount=r,this.onAsyncPropUpdated(e,t))}_watchPromise(e,t){const r=this.asyncProps[e];if(r){r.pendingLoadCount++;const a=r.pendingLoadCount;t.then(h=>{this.component&&(h=this._postProcessValue(r,h),this._setAsyncPropValue(e,h,a),this._onResolve(e,h))}).catch(h=>{this._onError(e,h)})}}async _resolveAsyncIterable(e,t){if(e!=="data"){this._setPropValue(e,t);return}const r=this.asyncProps[e];if(!r)return;r.pendingLoadCount++;const a=r.pendingLoadCount;let h=[],y=0;for await(const s of t){if(!this.component)return;const{dataTransform:T}=this.component.props;T?h=T(s,h):h=h.concat(s),Object.defineProperty(h,"__diff",{enumerable:!1,value:[{startRow:y,endRow:h.length}]}),y=h.length,this._setAsyncPropValue(e,h,a)}this._onResolve(e,h)}_postProcessValue(e,t){const r=e.type;return r&&this.component&&(r.release&&r.release(e.resolvedValue,r,this.component),r.transform)?r.transform(t,r,this.component):t}_createAsyncPropData(e,t){if(!this.asyncProps[e]){const a=this.component&&this.component.props[Au];this.asyncProps[e]={type:a&&a[e],lastValue:null,resolvedValue:t,pendingLoadCount:0,resolvedLoadCount:0}}}}class K$ extends Y${constructor({attributeManager:e,layer:t}){super(t),this.attributeManager=e,this.needsRedraw=!0,this.needsUpdate=!0,this.subLayers=null,this.usesPickingColorCache=!1}get layer(){return this.component}_fetch(e,t){const r=this.layer,a=r==null?void 0:r.props.fetch;return a?a(t,{propName:e,layer:r}):super._fetch(e,t)}_onResolve(e,t){const r=this.layer;if(r){const a=r.props.onDataLoad;e==="data"&&a&&a(t,{propName:e,layer:r})}}_onError(e,t){const r=this.layer;r&&r.raiseError(t,`loading ${e} of ${this.layer}`)}}const J$="layer.changeFlag",Q$="layer.initialize",e7="layer.update",t7="layer.finalize",i7="layer.matched",xI=2**24-1,r7=Object.freeze([]),n7=Lm(({oldViewport:i,viewport:e})=>i.equals(e));let jo=new Uint8ClampedArray(0);const s7={data:{type:"data",value:r7,async:!0},dataComparator:{type:"function",value:null,optional:!0},_dataDiff:{type:"function",value:i=>i&&i.__diff,optional:!0},dataTransform:{type:"function",value:null,optional:!0},onDataLoad:{type:"function",value:null,optional:!0},onError:{type:"function",value:null,optional:!0},fetch:{type:"function",value:(i,{propName:e,layer:t,loaders:r,loadOptions:a,signal:h})=>{const{resourceManager:y}=t.context;a=a||t.getLoadOptions(),r=r||t.props.loaders,h&&(a={...a,fetch:{...a==null?void 0:a.fetch,signal:h}});let s=y.contains(i);return!s&&!a&&(y.add({resourceId:i,data:w1(i,r),persistent:!1}),s=!0),s?y.subscribe({resourceId:i,onChange:T=>{var B;return(B=t.internalState)==null?void 0:B.reloadAsyncProp(e,T)},consumerId:t.id,requestId:e}):w1(i,r,a)}},updateTriggers:{},visible:!0,pickable:!1,opacity:{type:"number",min:0,max:1,value:1},operation:"draw",onHover:{type:"function",value:null,optional:!0},onClick:{type:"function",value:null,optional:!0},onDragStart:{type:"function",value:null,optional:!0},onDrag:{type:"function",value:null,optional:!0},onDragEnd:{type:"function",value:null,optional:!0},coordinateSystem:lr.DEFAULT,coordinateOrigin:{type:"array",value:[0,0,0],compare:!0},modelMatrix:{type:"array",value:null,compare:!0,optional:!0},wrapLongitude:!1,positionFormat:"XYZ",colorFormat:"RGBA",parameters:{type:"object",value:{},optional:!0,compare:2},loadOptions:{type:"object",value:null,optional:!0,ignore:!0},transitions:null,extensions:[],loaders:{type:"array",value:[],optional:!0,ignore:!0},getPolygonOffset:{type:"function",value:({layerIndex:i})=>[0,-i*100]},highlightedObjectIndex:null,autoHighlight:!1,highlightColor:{type:"accessor",value:[0,0,128,128]}};class gA extends v0{constructor(){super(...arguments),this.internalState=null,this.lifecycle=nd.NO_STATE,this.parent=null}static get componentName(){return Object.prototype.hasOwnProperty.call(this,"layerName")?this.layerName:""}get root(){let e=this;for(;e.parent;)e=e.parent;return e}toString(){return`${this.constructor.layerName||this.constructor.name}({id: '${this.props.id}'})`}project(e){In(this.internalState);const t=this.internalState.viewport||this.context.viewport,r=_P(e,{viewport:t,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem}),[a,h,y]=dP(r,t.pixelProjectionMatrix);return e.length===2?[a,h]:[a,h,y]}unproject(e){return In(this.internalState),(this.internalState.viewport||this.context.viewport).unproject(e)}projectPosition(e,t){In(this.internalState);const r=this.internalState.viewport||this.context.viewport;return _j(e,{viewport:r,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem,...t})}get isComposite(){return!1}get isDrawable(){return!0}setState(e){this.setChangeFlags({stateChanged:!0}),Object.assign(this.state,e),this.setNeedsRedraw()}setNeedsRedraw(){this.internalState&&(this.internalState.needsRedraw=!0)}setNeedsUpdate(){this.internalState&&(this.context.layerManager.setNeedsUpdate(String(this)),this.internalState.needsUpdate=!0)}get isLoaded(){return this.internalState?!this.internalState.isAsyncPropLoading():!1}get wrapLongitude(){return this.props.wrapLongitude}isPickable(){return this.props.pickable&&this.props.visible}getModels(){const e=this.state;return e&&(e.models||e.model&&[e.model])||[]}setShaderModuleProps(...e){for(const t of this.getModels())t.shaderInputs.setProps(...e)}getAttributeManager(){return this.internalState&&this.internalState.attributeManager}getCurrentLayer(){return this.internalState&&this.internalState.layer}getLoadOptions(){return this.props.loadOptions}use64bitPositions(){const{coordinateSystem:e}=this.props;return e===lr.DEFAULT||e===lr.LNGLAT||e===lr.CARTESIAN}onHover(e,t){return this.props.onHover&&this.props.onHover(e,t)||!1}onClick(e,t){return this.props.onClick&&this.props.onClick(e,t)||!1}nullPickingColor(){return[0,0,0]}encodePickingColor(e,t=[]){return t[0]=e+1&255,t[1]=e+1>>8&255,t[2]=e+1>>8>>8&255,t}decodePickingColor(e){In(e instanceof Uint8Array);const[t,r,a]=e;return t+r*256+a*65536-1}getNumInstances(){return Number.isFinite(this.props.numInstances)?this.props.numInstances:this.state&&this.state.numInstances!==void 0?this.state.numInstances:P$(this.props.data)}getStartIndices(){return this.props.startIndices?this.props.startIndices:this.state&&this.state.startIndices?this.state.startIndices:null}getBounds(){var e;return(e=this.getAttributeManager())==null?void 0:e.getBounds(["positions","instancePositions"])}getShaders(e){e=vI(e,{disableWarnings:!0,modules:this.context.defaultShaderModules});for(const t of this.props.extensions)e=vI(e,t.getShaders.call(this,t));return e}shouldUpdateState(e){return e.changeFlags.propsOrDataChanged}updateState(e){const t=this.getAttributeManager(),{dataChanged:r}=e.changeFlags;if(r&&t)if(Array.isArray(r))for(const a of r)t.invalidateAll(a);else t.invalidateAll();if(t){const{props:a}=e,h=this.internalState.hasPickingBuffer,y=Number.isInteger(a.highlightedObjectIndex)||a.pickable||a.extensions.some(s=>s.getNeedsPickingBuffer.call(this,s));if(h!==y){this.internalState.hasPickingBuffer=y;const{pickingColors:s,instancePickingColors:T}=t.attributes,B=s||T;B&&(y&&B.constant&&(B.constant=!1,t.invalidate(B.id)),!B.value&&!y&&(B.constant=!0,B.value=[0,0,0]))}}}finalizeState(e){for(const r of this.getModels())r.destroy();const t=this.getAttributeManager();t&&t.finalize(),this.context&&this.context.resourceManager.unsubscribe({consumerId:this.id}),this.internalState&&(this.internalState.uniformTransitions.clear(),this.internalState.finalize())}draw(e){for(const t of this.getModels())t.draw(e.renderPass)}getPickingInfo({info:e,mode:t,sourceLayer:r}){const{index:a}=e;return a>=0&&Array.isArray(this.props.data)&&(e.object=this.props.data[a]),e}raiseError(e,t){var r,a,h,y;t&&(e=new Error(`${t}: ${e.message}`,{cause:e})),(a=(r=this.props).onError)!=null&&a.call(r,e)||(y=(h=this.context)==null?void 0:h.onError)==null||y.call(h,e,this)}getNeedsRedraw(e={clearRedrawFlags:!1}){return this._getNeedsRedraw(e)}needsUpdate(){return this.internalState?this.internalState.needsUpdate||this.hasUniformTransition()||this.shouldUpdateState(this._getUpdateParams()):!1}hasUniformTransition(){var e;return((e=this.internalState)==null?void 0:e.uniformTransitions.active)||!1}activateViewport(e){if(!this.internalState)return;const t=this.internalState.viewport;this.internalState.viewport=e,(!t||!n7({oldViewport:t,viewport:e}))&&(this.setChangeFlags({viewportChanged:!0}),this.isComposite?this.needsUpdate()&&this.setNeedsUpdate():this._update())}invalidateAttribute(e="all"){const t=this.getAttributeManager();t&&(e==="all"?t.invalidateAll():t.invalidate(e))}updateAttributes(e){let t=!1;for(const r in e)e[r].layoutChanged()&&(t=!0);for(const r of this.getModels())this._setModelAttributes(r,e,t)}_updateAttributes(){const e=this.getAttributeManager();if(!e)return;const t=this.props,r=this.getNumInstances(),a=this.getStartIndices();e.update({data:t.data,numInstances:r,startIndices:a,props:t,transitions:t.transitions,buffers:t.data.attributes,context:this});const h=e.getChangedAttributes({clearChangedFlags:!0});this.updateAttributes(h)}_updateAttributeTransition(){const e=this.getAttributeManager();e&&e.updateTransition()}_updateUniformTransition(){const{uniformTransitions:e}=this.internalState;if(e.active){const t=e.update(),r=Object.create(this.props);for(const a in t)Object.defineProperty(r,a,{value:t[a]});return r}return this.props}calculateInstancePickingColors(e,{numInstances:t}){if(e.constant)return;const r=Math.floor(jo.length/4);if(this.internalState.usesPickingColorCache=!0,r<t){t>xI&&gr.warn("Layer has too many data objects. Picking might not be able to distinguish all objects.")(),jo=xm.allocate(jo,t,{size:4,copy:!0,maxCount:Math.max(t,xI)});const a=Math.floor(jo.length/4),h=[0,0,0];for(let y=r;y<a;y++)this.encodePickingColor(y,h),jo[y*4+0]=h[0],jo[y*4+1]=h[1],jo[y*4+2]=h[2],jo[y*4+3]=0}e.value=jo.subarray(0,t*4)}_setModelAttributes(e,t,r=!1){var s;if(!Object.keys(t).length)return;if(r){const T=this.getAttributeManager();e.setBufferLayout(T.getBufferLayouts(e)),t=T.getAttributes()}const a=((s=e.userData)==null?void 0:s.excludeAttributes)||{},h={},y={};for(const T in t){if(a[T])continue;const B=t[T].getValue();for(const F in B){const V=B[F];V instanceof Gr?t[T].settings.isIndexed?e.setIndexBuffer(V):h[F]=V:V&&(y[F]=V)}}e.setAttributes(h),e.setConstantAttributes(y)}disablePickingIndex(e){const t=this.props.data;if(!("attributes"in t)){this._disablePickingIndex(e);return}const{pickingColors:r,instancePickingColors:a}=this.getAttributeManager().attributes,h=r||a,y=h&&t.attributes&&t.attributes[h.id];if(y&&y.value){const s=y.value,T=this.encodePickingColor(e);for(let B=0;B<t.length;B++){const F=h.getVertexOffset(B);s[F]===T[0]&&s[F+1]===T[1]&&s[F+2]===T[2]&&this._disablePickingIndex(B)}}else this._disablePickingIndex(e)}_disablePickingIndex(e){const{pickingColors:t,instancePickingColors:r}=this.getAttributeManager().attributes,a=t||r;if(!a)return;const h=a.getVertexOffset(e),y=a.getVertexOffset(e+1);a.buffer.write(new Uint8Array(y-h),h)}restorePickingColors(){const{pickingColors:e,instancePickingColors:t}=this.getAttributeManager().attributes,r=e||t;r&&(this.internalState.usesPickingColorCache&&r.value.buffer!==jo.buffer&&(r.value=jo.subarray(0,r.value.length)),r.updateSubBuffer({startOffset:0}))}_initialize(){In(!this.internalState),In(Number.isFinite(this.props.coordinateSystem)),bs(Q$,this);const e=this._getAttributeManager();e&&e.addInstanced({instancePickingColors:{type:"uint8",size:4,noAlloc:!0,update:this.calculateInstancePickingColors}}),this.internalState=new K$({attributeManager:e,layer:this}),this._clearChangeFlags(),this.state={},Object.defineProperty(this.state,"attributeManager",{get:()=>(gr.deprecated("layer.state.attributeManager","layer.getAttributeManager()")(),e)}),this.internalState.uniformTransitions=new w$(this.context.timeline),this.internalState.onAsyncPropUpdated=this._onAsyncPropUpdated.bind(this),this.internalState.setAsyncProps(this.props),this.initializeState(this.context);for(const t of this.props.extensions)t.initializeState.call(this,this.context,t);this.setChangeFlags({dataChanged:"init",propsChanged:"init",viewportChanged:!0,extensionsChanged:!0}),this._update()}_transferState(e){bs(i7,this,this===e);const{state:t,internalState:r}=e;this!==e&&(this.internalState=r,this.state=t,this.internalState.setAsyncProps(this.props),this._diffProps(this.props,this.internalState.getOldProps()))}_update(){const e=this.needsUpdate();if(bs(e7,this,e),!e)return;const t=this.props,r=this.context,a=this.internalState,h=r.viewport,y=this._updateUniformTransition();a.propsInTransition=y,r.viewport=a.viewport||h,this.props=y;try{const s=this._getUpdateParams(),T=this.getModels();if(r.device)this.updateState(s);else try{this.updateState(s)}catch{}for(const F of this.props.extensions)F.updateState.call(this,s,F);this.setNeedsRedraw(),this._updateAttributes();const B=this.getModels()[0]!==T[0];this._postUpdate(s,B)}finally{r.viewport=h,this.props=t,this._clearChangeFlags(),a.needsUpdate=!1,a.resetOldProps()}}_finalize(){bs(t7,this),this.finalizeState(this.context);for(const e of this.props.extensions)e.finalizeState.call(this,this.context,e)}_drawLayer({renderPass:e,shaderModuleProps:t=null,uniforms:r={},parameters:a={}}){this._updateAttributeTransition();const h=this.props,y=this.context;this.props=this.internalState.propsInTransition||h;try{t&&this.setShaderModuleProps(t);const{getPolygonOffset:s}=this.props,T=s&&s(r)||[0,0];y.device instanceof hd&&y.device.setParametersWebGL({polygonOffset:T});for(const B of this.getModels())B.device.type==="webgpu"?B.setParameters({...B.parameters,...a}):B.setParameters(a);if(y.device instanceof hd)y.device.withParametersWebGL(a,()=>{const B={renderPass:e,shaderModuleProps:t,uniforms:r,parameters:a,context:y};for(const F of this.props.extensions)F.draw.call(this,B,F);this.draw(B)});else{const B={renderPass:e,shaderModuleProps:t,uniforms:r,parameters:a,context:y};for(const F of this.props.extensions)F.draw.call(this,B,F);this.draw(B)}}finally{this.props=h}}getChangeFlags(){var e;return(e=this.internalState)==null?void 0:e.changeFlags}setChangeFlags(e){if(!this.internalState)return;const{changeFlags:t}=this.internalState;for(const a in e)if(e[a]){let h=!1;switch(a){case"dataChanged":const y=e[a],s=t[a];y&&Array.isArray(s)&&(t.dataChanged=Array.isArray(y)?s.concat(y):y,h=!0);default:t[a]||(t[a]=e[a],h=!0)}h&&bs(J$,this,a,e)}const r=!!(t.dataChanged||t.updateTriggersChanged||t.propsChanged||t.extensionsChanged);t.propsOrDataChanged=r,t.somethingChanged=r||t.viewportChanged||t.stateChanged}_clearChangeFlags(){this.internalState.changeFlags={dataChanged:!1,propsChanged:!1,updateTriggersChanged:!1,viewportChanged:!1,stateChanged:!1,extensionsChanged:!1,propsOrDataChanged:!1,somethingChanged:!1}}_diffProps(e,t){var a;const r=T$(e,t);if(r.updateTriggersChanged)for(const h in r.updateTriggersChanged)r.updateTriggersChanged[h]&&this.invalidateAttribute(h);if(r.transitionsChanged)for(const h in r.transitionsChanged)this.internalState.uniformTransitions.add(h,t[h],e[h],(a=e.transitions)==null?void 0:a[h]);return this.setChangeFlags(r)}validateProps(){A$(this.props)}updateAutoHighlight(e){this.props.autoHighlight&&!Number.isInteger(this.props.highlightedObjectIndex)&&this._updateAutoHighlight(e)}_updateAutoHighlight(e){const t={highlightedObjectColor:e.picked?e.color:null},{highlightColor:r}=this.props;e.picked&&typeof r=="function"&&(t.highlightColor=r(e)),this.setShaderModuleProps({picking:t}),this.setNeedsRedraw()}_getAttributeManager(){const e=this.context;return new g$(e.device,{id:this.props.id,stats:e.stats,timeline:e.timeline})}_postUpdate(e,t){const{props:r,oldProps:a}=e,h=this.state.model;h!=null&&h.isInstanced&&h.setInstanceCount(this.getNumInstances());const{autoHighlight:y,highlightedObjectIndex:s,highlightColor:T}=r;if(t||a.autoHighlight!==y||a.highlightedObjectIndex!==s||a.highlightColor!==T){const B={};Array.isArray(T)&&(B.highlightColor=T),(t||a.autoHighlight!==y||s!==a.highlightedObjectIndex)&&(B.highlightedObjectColor=Number.isFinite(s)&&s>=0?this.encodePickingColor(s):null),this.setShaderModuleProps({picking:B})}}_getUpdateParams(){return{props:this.props,oldProps:this.internalState.getOldProps(),context:this.context,changeFlags:this.internalState.changeFlags}}_getNeedsRedraw(e){if(!this.internalState)return!1;let t=!1;t=t||this.internalState.needsRedraw&&this.id;const r=this.getAttributeManager(),a=r?r.getNeedsRedraw(e):!1;if(t=t||a,t)for(const h of this.props.extensions)h.onNeedsRedraw.call(this,h);return this.internalState.needsRedraw=this.internalState.needsRedraw&&!e.clearRedrawFlags,t}_onAsyncPropUpdated(){this._diffProps(this.props,this.internalState.getOldProps()),this.setNeedsUpdate()}}gA.defaultProps=s7;gA.layerName="Layer";const Ng=Math.PI/180,bI=180/Math.PI,ey=6370972,dd=256;function o7(){const i=dd/ey,e=Math.PI/180*dd;return{unitsPerMeter:[i,i,i],unitsPerMeter2:[0,0,0],metersPerUnit:[1/i,1/i,1/i],unitsPerDegree:[e,e,i],unitsPerDegree2:[0,0,0],degreesPerUnit:[1/e,1/e,1/i]}}class a7 extends Md{constructor(e={}){const{longitude:t=0,zoom:r=0,nearZMultiplier:a=.5,farZMultiplier:h=1,resolution:y=10}=e;let{latitude:s=0,height:T,altitude:B=1.5,fovy:F}=e;s=Math.max(Math.min(s,Dy),-85.051129),T=T||1,F?B=sA(F):F=vm(B);const V=1/Math.PI/Math.cos(s*Math.PI/180),X=Math.pow(2,r)*V,se=e.nearZ??a,ne=e.farZ??(B+dd*2*X/T)*h,K=new qn().lookAt({eye:[0,-B,0],up:[0,0,1]});K.rotateX(s*Ng),K.rotateZ(-t*Ng),K.scale(X/T),super({...e,height:T,viewMatrix:K,longitude:t,latitude:s,zoom:r,distanceScales:o7(),fovy:F,focalDistance:B,near:se,far:ne}),this.scale=X,this.latitude=s,this.longitude=t,this.resolution=y}get projectionMode(){return Hs.GLOBE}getDistanceScales(){return this.distanceScales}getBounds(e={}){const t={targetZ:e.z||0},r=this.unproject([0,this.height/2],t),a=this.unproject([this.width/2,0],t),h=this.unproject([this.width,this.height/2],t),y=this.unproject([this.width/2,this.height],t);return h[0]<this.longitude&&(h[0]+=360),r[0]>this.longitude&&(r[0]-=360),[Math.min(r[0],h[0],a[0],y[0]),Math.min(r[1],h[1],a[1],y[1]),Math.max(r[0],h[0],a[0],y[0]),Math.max(r[1],h[1],a[1],y[1])]}unproject(e,{topLeft:t=!0,targetZ:r}={}){const[a,h,y]=e,s=t?h:this.height-h,{pixelUnprojectionMatrix:T}=this;let B;if(Number.isFinite(y))B=ub(T,[a,s,y,1]);else{const se=ub(T,[a,s,-1,1]),ne=ub(T,[a,s,1,1]),K=((r||0)/ey+1)*dd,ue=qx(jR([],se,ne)),_e=qx(se),ke=qx(ne),ge=4*((4*_e*ke-(ue-_e-ke)**2)/16)/ue,Le=Math.sqrt(_e-ge),$e=Math.sqrt(Math.max(0,K*K-ge)),Ye=(Le-$e)/Math.sqrt(ue);B=BU([],se,ne,Ye)}const[F,V,X]=this.unprojectPosition(B);return Number.isFinite(y)?[F,V,X]:Number.isFinite(r)?[F,V,r]:[F,V]}projectPosition(e){const[t,r,a=0]=e,h=t*Ng,y=r*Ng,s=Math.cos(y),T=(a/ey+1)*dd;return[Math.sin(h)*s*T,-Math.cos(h)*s*T,Math.sin(y)*T]}unprojectPosition(e){const[t,r,a]=e,h=HR(e),y=Math.asin(a/h),T=Math.atan2(t,-r)*bI,B=y*bI,F=(h/dd-1)*ey;return[T,B,F]}projectFlat(e){return e}unprojectFlat(e){return e}panByPosition(e,t){const r=this.unproject(t);return{longitude:e[0]-r[0]+this.longitude,latitude:e[1]-r[1]+this.latitude}}}function ub(i,e){const t=Cd([],e,i);return iA(t,t,1/t[3]),t}class l7 extends EP{applyConstraints(e){const{maxZoom:t,minZoom:r,zoom:a}=e;e.zoom=ba(a,r,t);const{longitude:h,latitude:y}=e;return(h<-180||h>180)&&(e.longitude=oj(h+180,360)-180),e.latitude=ba(y,-85.051129,Dy),e}}class c7 extends TP{constructor(){super(...arguments),this.ControllerState=l7,this.transition={transitionDuration:300,transitionInterpolator:new cA(["longitude","latitude","zoom"])},this.dragMode="pan"}setProps(e){super.setProps(e),this.dragRotate=!1,this.touchRotate=!1}}class tB extends AP{constructor(e={}){super(e)}getViewportType(e){return e.zoom>12?Ru:a7}get ControllerType(){return c7}}tB.displayName="GlobeView";const hb=512,u7=Math.PI/180;function iB({map:i,gl:e,deck:t}){if(i.__deck)return i.__deck;const r=t==null?void 0:t.props._customRender,a=t==null?void 0:t.props.onLoad,h={...t==null?void 0:t.props,_customRender:()=>{i.triggerRepaint(),r==null||r("")}};h.parameters={...hw(i,!0),...h.parameters},h.views||(h.views=zy(i));let y;return(!t||t.props.gl===e)&&(Object.assign(h,{gl:e,width:null,height:null,touchAction:"unset",viewState:Em(i)}),t!=null&&t.isInitialized?wI(t,i):h.onLoad=()=>{a==null||a(),wI(y,i)}),t?(y=t,t.setProps(h),t.userData.isExternal=!0):(y=new Tm(h),i.on("remove",()=>{rB(i)})),y.userData.mapboxLayers=new Set,i.__deck=y,i.on("render",()=>{y.isInitialized&&_7(y,i)}),y}function wI(i,e){const t=()=>{i.isInitialized?g7(i,e):e.off("move",t)};e.on("move",t)}function rB(i){var e;(e=i.__deck)==null||e.finalize(),i.__deck=null}function hw(i,e){const t=e?{depthWriteEnabled:!0,depthCompare:"less-equal",depthBias:0,blend:!0,blendColorSrcFactor:"src-alpha",blendColorDstFactor:"one-minus-src-alpha",blendAlphaSrcFactor:"one",blendAlphaDstFactor:"one-minus-src-alpha",blendColorOperation:"add",blendAlphaOperation:"add"}:{};return nB(i)==="globe"&&(t.cullMode="back"),t}function h7(i,e){i.userData.mapboxLayers.add(e),yA(i)}function d7(i,e){i.userData.mapboxLayers.delete(e),yA(i)}function f7(i,e){yA(i)}function p7(i,e,t,r){let{currentViewport:a}=i.userData,h=!1;a||(a=sB(i,e,r),i.userData.currentViewport=a,h=!0),i.isInitialized&&i._drawLayers("mapbox-repaint",{viewports:[a],layerFilter:({layer:y})=>t.id===y.id||y.props.operation.includes("terrain"),clearStack:h,clearCanvas:!1})}function nB(i){var r;const e=(r=i.getProjection)==null?void 0:r.call(i),t=(e==null?void 0:e.type)||(e==null?void 0:e.name);if(t==="globe")return"globe";if(t&&t!=="mercator")throw new Error("Unsupported projection");return"mercator"}function zy(i){return nB(i)==="globe"?new tB({id:"mapbox"}):new uA({id:"mapbox"})}function Em(i){var a;const{lng:e,lat:t}=i.getCenter(),r={longitude:(e+540)%360-180,latitude:t,zoom:i.getZoom(),bearing:i.getBearing(),pitch:i.getPitch(),padding:i.getPadding(),repeat:i.getRenderWorldCopies()};return(a=i.getTerrain)!=null&&a.call(i)&&m7(i,r),r}function m7(i,e){if(i.getFreeCameraOptions){const{position:t}=i.getFreeCameraOptions();if(!t||t.z===void 0)return;const r=i.transform.height,{longitude:a,latitude:h,pitch:y}=e,s=t.x*hb,T=(1-t.y)*hb,B=t.z*hb,F=ym([a,h]),V=s-F[0],X=T-F[1],se=Math.sqrt(V*V+X*X),ne=y*u7,K=1.5*r,ue=ne<.001?K*Math.cos(ne)/B:K*Math.sin(ne)/se;e.zoom=Math.log2(ue);const _e=K*Math.cos(ne)/ue,ke=B-_e;e.position=[0,0,ke/Jg(h)]}else typeof i.transform.elevation=="number"&&(e.position=[0,0,i.transform.elevation])}function sB(i,e,t){const r=Em(e),a=zy(e);t&&(a.props.nearZMultiplier=.2);const h=(t==null?void 0:t.nearZ)??e.transform._nearZ,y=(t==null?void 0:t.farZ)??e.transform._farZ;return Number.isFinite(h)&&(r.nearZ=h/e.transform.height,r.farZ=y/e.transform.height),a.makeViewport({width:i.width,height:i.height,viewState:r})}function _7(i,e){const{mapboxLayers:t,isExternal:r}=i.userData;if(r){const a=Array.from(t,F=>F.id),y=Am(i.props.layers,Boolean).some(F=>F&&!a.includes(F.id));let s=i.getViewports();const T=s.findIndex(F=>F.id==="mapbox"),B=s.length>1||T<0;(y||B)&&(T>=0&&(s=s.slice(),s[T]=sB(i,e)),i._drawLayers("mapbox-repaint",{viewports:s,layerFilter:F=>(!i.props.layerFilter||i.props.layerFilter(F))&&(F.viewport.id!=="mapbox"||!a.includes(F.layer.id)),clearCanvas:!1}))}i.userData.currentViewport=null}function g7(i,e){i.setProps({viewState:Em(e)}),i.needsRedraw({clearRedrawFlags:!0})}function yA(i){if(i.userData.isExternal)return;const e=[];i.userData.mapboxLayers.forEach(t=>{const r=t.props.type,a=new r(t.props);e.push(a)}),i.setProps({layers:e})}class y7{constructor(e){if(!e.id)throw new Error("Layer must have an unique id");this.id=e.id,this.type="custom",this.renderingMode=e.renderingMode||"3d",this.slot=e.slot,this.map=null,this.deck=null,this.props=e}onAdd(e,t){this.map=e,this.deck=iB({map:e,gl:t,deck:this.props.deck}),h7(this.deck,this)}onRemove(){this.deck&&d7(this.deck,this)}setProps(e){Object.assign(this.props,e,{id:this.id}),this.deck&&f7(this.deck)}render(e,t){p7(this.deck,this.map,this,t)}}const db="__UNDEFINED__";function zg(i,e,t,r){if(!i||!e||!i.style||!i.style._loaded)return;const a=Am(r,Boolean);if(t!==r){const s=Am(t,Boolean),T=new Set(s.map(B=>B.id));for(const B of a)T.delete(B.id);for(const B of T)i.getLayer(B)&&i.removeLayer(B)}for(const s of a){const T=i.getLayer(s.id);T?(T.implementation||T).setProps(s.props):i.addLayer(new y7({id:s.id,deck:e,slot:s.props.slot}),s.props.beforeId)}const h=i.style._order,y={};for(const s of a){let{beforeId:T}=s.props;(!T||!h.includes(T))&&(T=db),y[T]=y[T]||[],y[T].push(s.id)}for(const s in y){const T=y[s];let B=s===db?h.length:h.indexOf(s),F=s===db?void 0:s;for(let V=T.length-1;V>=0;V--){const X=T[V],se=h.indexOf(X);se!==B-1&&(i.moveLayer(X,F),se>B&&B++),B--,F=X}}}class v7{constructor(e){this._handleStyleChange=()=>{zg(this._map,this._deck,this._props.layers,this._props.layers)},this._updateContainerSize=()=>{if(this._map&&this._container){const{clientWidth:a,clientHeight:h}=this._map.getContainer();Object.assign(this._container.style,{width:`${a}px`,height:`${h}px`})}},this._updateViewState=()=>{const a=this._deck,h=this._map;a&&h&&(a.setProps({views:this._props.views||zy(h),viewState:Em(h)}),a.isInitialized&&a.redraw())},this._handleMouseEvent=a=>{const h=this._deck;if(!h||!h.isInitialized)return;const y={type:a.type,offsetCenter:a.point,srcEvent:a},s=this._lastMouseDownPoint;switch(!a.point&&s&&(y.deltaX=a.originalEvent.clientX-s.clientX,y.deltaY=a.originalEvent.clientY-s.clientY,y.offsetCenter={x:s.x+y.deltaX,y:s.y+y.deltaY}),y.type){case"mousedown":h._onPointerDown(y),this._lastMouseDownPoint={...a.point,clientX:a.originalEvent.clientX,clientY:a.originalEvent.clientY};break;case"dragstart":y.type="panstart",h._onEvent(y);break;case"drag":y.type="panmove",h._onEvent(y);break;case"dragend":y.type="panend",h._onEvent(y);break;case"click":y.tapCount=1,h._onEvent(y);break;case"dblclick":y.type="click",y.tapCount=2,h._onEvent(y);break;case"mousemove":y.type="pointermove",h._onPointerMove(y);break;case"mouseout":y.type="pointerleave",h._onPointerMove(y);break;default:return}};const{interleaved:t=!1,...r}=e;this._interleaved=t,this._props=r}setProps(e){this._interleaved&&e.layers&&zg(this._map,this._deck,this._props.layers,e.layers),Object.assign(this._props,e),this._deck&&this._map&&this._deck.setProps({...this._props,parameters:{...hw(this._map,this._interleaved),...this._props.parameters}})}onAdd(e){return this._map=e,this._interleaved?this._onAddInterleaved(e):this._onAddOverlaid(e)}_onAddOverlaid(e){const t=document.createElement("div");return Object.assign(t.style,{position:"absolute",left:0,top:0,textAlign:"initial",pointerEvents:"none"}),this._container=t,this._deck=new Tm({...this._props,parent:t,parameters:{...hw(e,!1),...this._props.parameters},views:this._props.views||zy(e),viewState:Em(e)}),e.on("resize",this._updateContainerSize),e.on("render",this._updateViewState),e.on("mousedown",this._handleMouseEvent),e.on("dragstart",this._handleMouseEvent),e.on("drag",this._handleMouseEvent),e.on("dragend",this._handleMouseEvent),e.on("mousemove",this._handleMouseEvent),e.on("mouseout",this._handleMouseEvent),e.on("click",this._handleMouseEvent),e.on("dblclick",this._handleMouseEvent),this._updateContainerSize(),t}_onAddInterleaved(e){const t=e.painter.context.gl;return t instanceof WebGLRenderingContext&&gr.warn("Incompatible basemap library. See: https://deck.gl/docs/api-reference/mapbox/overview#compatibility")(),this._deck=iB({map:e,gl:t,deck:new Tm({...this._props,gl:t})}),e.on("styledata",this._handleStyleChange),zg(e,this._deck,[],this._props.layers),document.createElement("div")}onRemove(){const e=this._map;e&&(this._interleaved?this._onRemoveInterleaved(e):this._onRemoveOverlaid(e)),this._deck=void 0,this._map=void 0,this._container=void 0}_onRemoveOverlaid(e){var t;e.off("resize",this._updateContainerSize),e.off("render",this._updateViewState),e.off("mousedown",this._handleMouseEvent),e.off("dragstart",this._handleMouseEvent),e.off("drag",this._handleMouseEvent),e.off("dragend",this._handleMouseEvent),e.off("mousemove",this._handleMouseEvent),e.off("mouseout",this._handleMouseEvent),e.off("click",this._handleMouseEvent),e.off("dblclick",this._handleMouseEvent),(t=this._deck)==null||t.finalize()}_onRemoveInterleaved(e){e.off("styledata",this._handleStyleChange),zg(e,this._deck,this._props.layers,[]),rB(e)}getDefaultPosition(){return"top-left"}pickObject(e){return In(this._deck),this._deck.pickObject(e)}pickMultipleObjects(e){return In(this._deck),this._deck.pickMultipleObjects(e)}pickObjects(e){return In(this._deck),this._deck.pickObjects(e)}finalize(){this._map&&this._map.removeControl(this)}getCanvas(){return this._map?this._interleaved?this._map.getCanvas():this._deck.getCanvas():null}}const fb=Math.PI/180,Ug=new Float32Array(16),AI=new Float32Array(12);function TI(i,e,t){const r=e[0]*fb,a=e[1]*fb,h=e[2]*fb,y=Math.sin(h),s=Math.sin(r),T=Math.sin(a),B=Math.cos(h),F=Math.cos(r),V=Math.cos(a),X=t[0],se=t[1],ne=t[2];i[0]=X*V*F,i[1]=X*T*F,i[2]=X*-s,i[3]=se*(-T*B+V*s*y),i[4]=se*(V*B+T*s*y),i[5]=se*F*y,i[6]=ne*(T*y+V*s*B),i[7]=ne*(-V*y+T*s*B),i[8]=ne*F*B}function EI(i){return i[0]=i[0],i[1]=i[1],i[2]=i[2],i[3]=i[4],i[4]=i[5],i[5]=i[6],i[6]=i[8],i[7]=i[9],i[8]=i[10],i[9]=i[12],i[10]=i[13],i[11]=i[14],i.subarray(0,12)}const x7={size:12,accessor:["getOrientation","getScale","getTranslation","getTransformMatrix"],shaderAttributes:{instanceModelMatrixCol0:{size:3,elementOffset:0},instanceModelMatrixCol1:{size:3,elementOffset:3},instanceModelMatrixCol2:{size:3,elementOffset:6},instanceTranslation:{size:3,elementOffset:9}},update(i,{startRow:e,endRow:t}){const{data:r,getOrientation:a,getScale:h,getTranslation:y,getTransformMatrix:s}=this.props,T=Array.isArray(s),B=T&&s.length===16,F=Array.isArray(h),V=Array.isArray(a),X=Array.isArray(y),se=B||!T&&!!s(r[0]);se?i.constant=B:i.constant=V&&F&&X;const ne=i.value;if(i.constant){let K;se?(Ug.set(s),K=EI(Ug)):(K=AI,TI(K,a,h),K.set(y,9)),i.value=new Float32Array(K)}else{let K=e*i.size;const{iterable:ue,objectInfo:_e}=jP(r,e,t);for(const ke of ue){_e.index++;let we;if(se)Ug.set(B?s:s(ke,_e)),we=EI(Ug);else{we=AI;const ge=V?a:a(ke,_e),Le=F?h:h(ke,_e);TI(we,ge,Le),we.set(X?y:y(ke,_e),9)}ne[K++]=we[0],ne[K++]=we[1],ne[K++]=we[2],ne[K++]=we[3],ne[K++]=we[4],ne[K++]=we[5],ne[K++]=we[6],ne[K++]=we[7],ne[K++]=we[8],ne[K++]=we[9],ne[K++]=we[10],ne[K++]=we[11]}}}};function b7(i,e){return e===lr.CARTESIAN||e===lr.METER_OFFSETS||e===lr.DEFAULT&&!i.isGeospatial}var Wo;(function(i){i[i.FUNC_ADD=32774]="FUNC_ADD",i[i.ONE=1]="ONE",i[i.SRC_ALPHA=770]="SRC_ALPHA",i[i.ONE_MINUS_SRC_ALPHA=771]="ONE_MINUS_SRC_ALPHA",i[i.TEXTURE_MIN_FILTER=10241]="TEXTURE_MIN_FILTER",i[i.LINEAR=9729]="LINEAR",i[i.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",i[i.UNPACK_FLIP_Y_WEBGL=37440]="UNPACK_FLIP_Y_WEBGL"})(Wo||(Wo={}));function w7(i,e,t,r){const a={defines:{MANUAL_SRGB:1,SRGB_FAST_APPROXIMATION:1},bindings:{},uniforms:{camera:[0,0,0],metallicRoughnessValues:[1,1]},parameters:{},glParameters:{},generatedTextures:[]};a.defines.USE_TEX_LOD=1;const{imageBasedLightingEnvironment:h}=r;return h&&(a.bindings.pbr_diffuseEnvSampler=h.diffuseEnvSampler.texture,a.bindings.pbr_specularEnvSampler=h.specularEnvSampler.texture,a.bindings.pbr_BrdfLUT=h.brdfLutTexture.texture,a.uniforms.scaleIBLAmbient=[1,1]),r!=null&&r.pbrDebug&&(a.defines.PBR_DEBUG=1,a.uniforms.scaleDiffBaseMR=[0,0,0,0],a.uniforms.scaleFGDSpec=[0,0,0,0]),t.NORMAL&&(a.defines.HAS_NORMALS=1),t.TANGENT&&(r!=null&&r.useTangents)&&(a.defines.HAS_TANGENTS=1),t.TEXCOORD_0&&(a.defines.HAS_UV=1),r!=null&&r.imageBasedLightingEnvironment&&(a.defines.USE_IBL=1),r!=null&&r.lights&&(a.defines.USE_LIGHTS=1),e&&A7(i,e,a),a}function A7(i,e,t){if(t.uniforms.unlit=!!e.unlit,e.pbrMetallicRoughness&&T7(i,e.pbrMetallicRoughness,t),e.normalTexture){sm(i,e.normalTexture,"pbr_normalSampler","HAS_NORMALMAP",t);const{scale:r=1}=e.normalTexture;t.uniforms.normalScale=r}if(e.occlusionTexture){sm(i,e.occlusionTexture,"pbr_occlusionSampler","HAS_OCCLUSIONMAP",t);const{strength:r=1}=e.occlusionTexture;t.uniforms.occlusionStrength=r}switch(e.emissiveTexture&&(sm(i,e.emissiveTexture,"pbr_emissiveSampler","HAS_EMISSIVEMAP",t),t.uniforms.emissiveFactor=e.emissiveFactor||[0,0,0]),e.alphaMode){case"MASK":const{alphaCutoff:r=.5}=e;t.defines.ALPHA_CUTOFF=1,t.uniforms.alphaCutoff=r;break;case"BLEND":Gt.warn("glTF BLEND alphaMode might not work well because it requires mesh sorting")(),t.parameters.blendColorOperation="add",t.parameters.blendColorSrcFactor="src-alpha",t.parameters.blendColorDstFactor="one-minus-src-alpha",t.parameters.blendAlphaOperation="add",t.parameters.blendAlphaSrcFactor="one",t.parameters.blendAlphaDstFactor="one-minus-src-alpha",t.glParameters.blend=!0,t.glParameters.blendEquation=Wo.FUNC_ADD,t.glParameters.blendFunc=[Wo.SRC_ALPHA,Wo.ONE_MINUS_SRC_ALPHA,Wo.ONE,Wo.ONE_MINUS_SRC_ALPHA];break}}function T7(i,e,t){e.baseColorTexture&&sm(i,e.baseColorTexture,"pbr_baseColorSampler","HAS_BASECOLORMAP",t),t.uniforms.baseColorFactor=e.baseColorFactor||[1,1,1,1],e.metallicRoughnessTexture&&sm(i,e.metallicRoughnessTexture,"pbr_metallicRoughnessSampler","HAS_METALROUGHNESSMAP",t);const{metallicFactor:r=1,roughnessFactor:a=1}=e;t.uniforms.metallicRoughnessValues=[r,a]}function sm(i,e,t,r=null,a){var F,V;const h=((V=(F=e==null?void 0:e.texture)==null?void 0:F.sampler)==null?void 0:V.parameters)||{},y=e.texture.source.image;let s,T={};y.compressed?(s=y,T={[Wo.TEXTURE_MIN_FILTER]:y.data.length>1?Wo.LINEAR_MIPMAP_NEAREST:Wo.LINEAR}):s={data:y};const B=i.createTexture({id:e.uniformName||e.id,parameters:{...h,...T},pixelStore:{[Wo.UNPACK_FLIP_Y_WEBGL]:!1},...s});a.bindings[t]=B,r&&(a.defines[r]=1),a.generatedTextures.push(B)}const E7="4.3.2",Uy={TRANSCODER:"basis_transcoder.js",TRANSCODER_WASM:"basis_transcoder.wasm",ENCODER:"basis_encoder.js",ENCODER_WASM:"basis_encoder.wasm"};let SI;async function II(i){GL(i.modules);const e=$L("basis");return e||(SI||(SI=S7(i)),await SI)}async function S7(i){let e=null,t=null;return[e,t]=await Promise.all([await bu(Uy.TRANSCODER,"textures",i),await bu(Uy.TRANSCODER_WASM,"textures",i)]),e=e||globalThis.BASIS,await I7(e,t)}function I7(i,e){const t={};return e&&(t.wasmBinary=e),new Promise(r=>{i(t).then(a=>{const{BasisFile:h,initializeBasis:y}=a;y(),r({BasisFile:h})})})}let pb;async function CI(i){const e=i.modules||{};return e.basisEncoder?e.basisEncoder:(pb=pb||C7(i),await pb)}async function C7(i){let e=null,t=null;return[e,t]=await Promise.all([await bu(Uy.ENCODER,"textures",i),await bu(Uy.ENCODER_WASM,"textures",i)]),e=e||globalThis.BASIS,await M7(e,t)}function M7(i,e){const t={};return e&&(t.wasmBinary=e),new Promise(r=>{i(t).then(a=>{const{BasisFile:h,KTX2File:y,initializeBasis:s,BasisEncoder:T}=a;s(),r({BasisFile:h,KTX2File:y,BasisEncoder:T})})})}const rd={COMPRESSED_RGB_S3TC_DXT1_EXT:33776,COMPRESSED_RGBA_S3TC_DXT5_EXT:33779,COMPRESSED_RGB_PVRTC_4BPPV1_IMG:35840,COMPRESSED_RGBA_PVRTC_4BPPV1_IMG:35842,COMPRESSED_RGB_ETC1_WEBGL:36196,COMPRESSED_RGBA_ASTC_4X4_KHR:37808},R7=["","WEBKIT_","MOZ_"],MI={WEBGL_compressed_texture_s3tc:"dxt",WEBGL_compressed_texture_s3tc_srgb:"dxt-srgb",WEBGL_compressed_texture_etc1:"etc1",WEBGL_compressed_texture_etc:"etc2",WEBGL_compressed_texture_pvrtc:"pvrtc",WEBGL_compressed_texture_atc:"atc",WEBGL_compressed_texture_astc:"astc",EXT_texture_compression_rgtc:"rgtc"};let Vg=null;function P7(i){if(!Vg){i=i||B7()||void 0,Vg=new Set;for(const e of R7)for(const t in MI)if(i&&i.getExtension(`${e}${t}`)){const r=MI[t];Vg.add(r)}}return Vg}function B7(){try{return document.createElement("canvas").getContext("webgl")}catch{return null}}const Vs=[171,75,84,88,32,50,48,187,13,10,26,10];function D7(i){const e=new Uint8Array(i);return!(e.byteLength<Vs.length||e[0]!==Vs[0]||e[1]!==Vs[1]||e[2]!==Vs[2]||e[3]!==Vs[3]||e[4]!==Vs[4]||e[5]!==Vs[5]||e[6]!==Vs[6]||e[7]!==Vs[7]||e[8]!==Vs[8]||e[9]!==Vs[9]||e[10]!==Vs[10]||e[11]!==Vs[11])}const O7={etc1:{basisFormat:0,compressed:!0,format:rd.COMPRESSED_RGB_ETC1_WEBGL},etc2:{basisFormat:1,compressed:!0},bc1:{basisFormat:2,compressed:!0,format:rd.COMPRESSED_RGB_S3TC_DXT1_EXT},bc3:{basisFormat:3,compressed:!0,format:rd.COMPRESSED_RGBA_S3TC_DXT5_EXT},bc4:{basisFormat:4,compressed:!0},bc5:{basisFormat:5,compressed:!0},"bc7-m6-opaque-only":{basisFormat:6,compressed:!0},"bc7-m5":{basisFormat:7,compressed:!0},"pvrtc1-4-rgb":{basisFormat:8,compressed:!0,format:rd.COMPRESSED_RGB_PVRTC_4BPPV1_IMG},"pvrtc1-4-rgba":{basisFormat:9,compressed:!0,format:rd.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG},"astc-4x4":{basisFormat:10,compressed:!0,format:rd.COMPRESSED_RGBA_ASTC_4X4_KHR},"atc-rgb":{basisFormat:11,compressed:!0},"atc-rgba-interpolated-alpha":{basisFormat:12,compressed:!0},rgba32:{basisFormat:13,compressed:!1},rgb565:{basisFormat:14,compressed:!1},bgr565:{basisFormat:15,compressed:!1},rgba4444:{basisFormat:16,compressed:!1}};async function F7(i,e){if(e.basis.containerFormat==="auto"){if(D7(i)){const r=await CI(e);return RI(r.KTX2File,i,e)}const{BasisFile:t}=await II(e);return mb(t,i,e)}switch(e.basis.module){case"encoder":const t=await CI(e);switch(e.basis.containerFormat){case"ktx2":return RI(t.KTX2File,i,e);case"basis":default:return mb(t.BasisFile,i,e)}case"transcoder":default:const{BasisFile:r}=await II(e);return mb(r,i,e)}}function mb(i,e,t){const r=new i(new Uint8Array(e));try{if(!r.startTranscoding())throw new Error("Failed to start basis transcoding");const a=r.getNumImages(),h=[];for(let y=0;y<a;y++){const s=r.getNumLevels(y),T=[];for(let B=0;B<s;B++)T.push(k7(r,y,B,t));h.push(T)}return h}finally{r.close(),r.delete()}}function k7(i,e,t,r){const a=i.getImageWidth(e,t),h=i.getImageHeight(e,t),y=i.getHasAlpha(),{compressed:s,format:T,basisFormat:B}=oB(r,y),F=i.getImageTranscodedSizeInBytes(e,t,B),V=new Uint8Array(F);if(!i.transcodeImage(V,e,t,B,0,0))throw new Error("failed to start Basis transcoding");return{width:a,height:h,data:V,compressed:s,format:T,hasAlpha:y}}function RI(i,e,t){const r=new i(new Uint8Array(e));try{if(!r.startTranscoding())throw new Error("failed to start KTX2 transcoding");const a=r.getLevels(),h=[];for(let y=0;y<a;y++)h.push(L7(r,y,t));return[h]}finally{r.close(),r.delete()}}function L7(i,e,t){const{alphaFlag:r,height:a,width:h}=i.getImageLevelInfo(e,0,0),{compressed:y,format:s,basisFormat:T}=oB(t,r),B=i.getImageTranscodedSizeInBytes(e,0,0,T),F=new Uint8Array(B);if(!i.transcodeImage(F,e,0,0,T,0,-1,-1))throw new Error("Failed to transcode KTX2 image");return{width:h,height:a,data:F,compressed:y,levelSize:B,hasAlpha:r,format:s}}function oB(i,e){let t=i&&i.basis&&i.basis.format;return t==="auto"&&(t=aB()),typeof t=="object"&&(t=e?t.alpha:t.noAlpha),t=t.toLowerCase(),O7[t]}function aB(){const i=P7();return i.has("astc")?"astc-4x4":i.has("dxt")?{alpha:"bc3",noAlpha:"bc1"}:i.has("pvrtc")?{alpha:"pvrtc1-4-rgba",noAlpha:"pvrtc1-4-rgb"}:i.has("etc1")?"etc1":i.has("etc2")?"etc2":"rgb565"}const N7={dataType:null,batchType:null,name:"Basis",id:"basis",module:"textures",version:E7,worker:!0,extensions:["basis","ktx2"],mimeTypes:["application/octet-stream","image/ktx2"],tests:["sB"],binary:!0,options:{basis:{format:"auto",libraryPath:"libs/",containerFormat:"auto",module:"transcoder"}}},z7={...N7,parse:F7},U7={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},V7={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array};class j7{constructor(e){pe(this,"name");pe(this,"startTime",0);pe(this,"playing",!0);pe(this,"speed",1);pe(this,"channels",[]);Object.assign(this,e)}animate(e){if(!this.playing)return;const r=(e/1e3-this.startTime)*this.speed;this.channels.forEach(({sampler:a,target:h,path:y})=>{Z7(r,a,h,y),$7(h,h._node)})}}class H7{constructor(e){pe(this,"animations");this.animations=e.animations.map((t,r)=>{const a=t.name||`Animation-${r}`,h=t.samplers.map(({input:s,interpolation:T="LINEAR",output:B})=>({input:PI(e.accessors[s]),interpolation:T,output:PI(e.accessors[B])})),y=t.channels.map(({sampler:s,target:T})=>({sampler:h[s],target:e.nodes[T.node],path:T.path}));return new j7({name:a,channels:y})})}animate(e){this.setTime(e)}setTime(e){this.animations.forEach(t=>t.animate(e))}getAnimations(){return this.animations}}function PI(i){if(!i._animation){const e=V7[i.componentType],t=U7[i.type],r=t*i.count,{buffer:a,byteOffset:h}=i.bufferView.data,y=new e(a,h+(i.byteOffset||0),r);if(t===1)i._animation=Array.from(y);else{const s=[];for(let T=0;T<y.length;T+=t)s.push(Array.from(y.slice(T,T+t)));i._animation=s}}return i._animation}const G7=new qn;function $7(i,e){if(e.matrix.identity(),i.translation&&e.matrix.translate(i.translation),i.rotation){const t=G7.fromQuaternion(i.rotation);e.matrix.multiplyRight(t)}i.scale&&e.matrix.scale(i.scale)}const _b=new O6;function W7(i,e,t,r,a){if(e==="rotation"){_b.slerp({start:t,target:r,ratio:a});for(let h=0;h<_b.length;h++)i[e][h]=_b[h]}else for(let h=0;h<t.length;h++)i[e][h]=a*r[h]+(1-a)*t[h]}function q7(i,e,{p0:t,outTangent0:r,inTangent1:a,p1:h,tDiff:y,ratio:s}){for(let T=0;T<i[e].length;T++){const B=r[T]*y,F=a[T]*y;i[e][T]=(2*Math.pow(s,3)-3*Math.pow(s,2)+1)*t[T]+(Math.pow(s,3)-2*Math.pow(s,2)+s)*B+(-2*Math.pow(s,3)+3*Math.pow(s,2))*h[T]+(Math.pow(s,3)-Math.pow(s,2))*F}}function X7(i,e,t){for(let r=0;r<t.length;r++)i[e][r]=t[r]}function Z7(i,{input:e,interpolation:t,output:r},a,h){const y=e[e.length-1],s=i%y,T=e.findIndex(X=>X>=s),B=Math.max(0,T-1);if(!Array.isArray(a[h]))switch(h){case"translation":a[h]=[0,0,0];break;case"rotation":a[h]=[0,0,0,1];break;case"scale":a[h]=[1,1,1];break;default:Gt.warn(`Bad animation path ${h}`)()}const F=e[B],V=e[T];switch(t){case"STEP":X7(a,h,r[B]);break;case"LINEAR":if(V>F){const X=(s-F)/(V-F);W7(a,h,r[B],r[T],X)}break;case"CUBICSPLINE":if(V>F){const X=(s-F)/(V-F),se=V-F,ne=r[3*B+1],K=r[3*B+2],ue=r[3*T+0],_e=r[3*T+1];q7(a,h,{p0:ne,outTangent0:K,inTangent1:ue,p1:_e,tDiff:se,ratio:X})}break;default:Gt.warn(`Interpolation ${t} not supported`)();break}}const Y7=`
layout(0) positions: vec4; // in vec4 POSITION;

  #ifdef HAS_NORMALS
    in vec4 normals; // in vec4 NORMAL;
  #endif

  #ifdef HAS_TANGENTS
    in vec4 TANGENT;
  #endif

  #ifdef HAS_UV
    // in vec2 TEXCOORD_0;
    in vec2 texCoords;
  #endif

@vertex
  void main(void) {
    vec4 _NORMAL = vec4(0.);
    vec4 _TANGENT = vec4(0.);
    vec2 _TEXCOORD_0 = vec2(0.);

    #ifdef HAS_NORMALS
      _NORMAL = normals;
    #endif

    #ifdef HAS_TANGENTS
      _TANGENT = TANGENT;
    #endif

    #ifdef HAS_UV
      _TEXCOORD_0 = texCoords;
    #endif

    pbr_setPositionNormalTangentUV(positions, _NORMAL, _TANGENT, _TEXCOORD_0);
    gl_Position = u_MVPMatrix * positions;
  }

@fragment
  out vec4 fragmentColor;

  void main(void) {
    vec3 pos = pbr_vPosition;
    fragmentColor = pbr_filterColor(vec4(1.0));
  }
`,K7=`#version 300 es

  // in vec4 POSITION;
  in vec4 positions;

  #ifdef HAS_NORMALS
    // in vec4 NORMAL;
    in vec4 normals;
  #endif

  #ifdef HAS_TANGENTS
    in vec4 TANGENT;
  #endif

  #ifdef HAS_UV
    // in vec2 TEXCOORD_0;
    in vec2 texCoords;
  #endif

  void main(void) {
    vec4 _NORMAL = vec4(0.);
    vec4 _TANGENT = vec4(0.);
    vec2 _TEXCOORD_0 = vec2(0.);

    #ifdef HAS_NORMALS
      _NORMAL = normals;
    #endif

    #ifdef HAS_TANGENTS
      _TANGENT = TANGENT;
    #endif

    #ifdef HAS_UV
      _TEXCOORD_0 = texCoords;
    #endif

    pbr_setPositionNormalTangentUV(positions, _NORMAL, _TANGENT, _TEXCOORD_0);
    gl_Position = pbrProjection.modelViewProjectionMatrix * positions;
  }
`,J7=`#version 300 es
  out vec4 fragmentColor;

  void main(void) {
    vec3 pos = pbr_vPosition;
    fragmentColor = pbr_filterColor(vec4(1.0));
  }
`;function Q7(i,e){const{id:t,geometry:r,material:a,vertexCount:h,materialOptions:y,modelOptions:s}=e,T=w7(i,a,r.attributes,y);Gt.info(4,"createGLTFModel defines: ",T.defines)();const B=[],F={depthWriteEnabled:!0,depthCompare:"less",depthFormat:"depth24plus",cullMode:"back"},V={id:t,source:Y7,vs:K7,fs:J7,geometry:r,topology:r.topology,vertexCount:h,modules:[JR],...s,defines:{...T.defines,...s.defines},parameters:{...F,...T.parameters,...s.parameters}},X=new bm(i,V),{camera:se,...ne}={...T.uniforms,...s.uniforms,...T.bindings,...s.bindings};return X.shaderInputs.setProps({pbrMaterial:ne,pbrProjection:{camera:se}}),new tw({managedResources:B,model:X})}var gu;(function(i){i[i.POINTS=0]="POINTS",i[i.LINES=1]="LINES",i[i.LINE_LOOP=2]="LINE_LOOP",i[i.LINE_STRIP=3]="LINE_STRIP",i[i.TRIANGLES=4]="TRIANGLES",i[i.TRIANGLE_STRIP=5]="TRIANGLE_STRIP",i[i.TRIANGLE_FAN=6]="TRIANGLE_FAN"})(gu||(gu={}));function eW(i){switch(i){case gu.POINTS:return"point-list";case gu.LINES:return"line-list";case gu.LINE_STRIP:return"line-strip";case gu.TRIANGLES:return"triangle-list";case gu.TRIANGLE_STRIP:return"triangle-strip";default:throw new Error(String(i))}}const tW={modelOptions:{},pbrDebug:!1,imageBasedLightingEnvironment:null,lights:!0,useTangents:!1};class iW{constructor(e,t={}){pe(this,"device");pe(this,"options");pe(this,"gltf");this.device=e,this.options={...tW,...t}}instantiate(e){return this.gltf=dw(e),(this.gltf.scenes||[]).map(r=>this.createScene(r))}createAnimator(){return Array.isArray(this.gltf.animations)?new H7(this.gltf):null}createScene(e){const r=(e.nodes||[]).map(h=>this.createNode(h));return new _d({id:e.name||e.id,children:r})}createNode(e){if(!e._node){const a=(e.children||[]).map(y=>this.createNode(y));e.mesh&&a.push(this.createMesh(e.mesh));const h=new _d({id:e.name||e.id,children:a});if(e.matrix)h.setMatrix(e.matrix);else{if(h.matrix.identity(),e.translation&&h.matrix.translate(e.translation),e.rotation){const y=new qn().fromQuaternion(e.rotation);h.matrix.multiplyRight(y)}e.scale&&h.matrix.scale(e.scale)}e._node=h}const t=this.gltf.nodes.find(r=>r.id===e.id);return t._node=e._node,e._node}createMesh(e){if(!e._mesh){const r=(e.primitives||[]).map((h,y)=>this.createPrimitive(h,y,e)),a=new _d({id:e.name||e.id,children:r});e._mesh=a}return e._mesh}createPrimitive(e,t,r){const a=e.name||`${r.name||r.id}-primitive-${t}`,h=eW(e.mode||4),y=e.indices?e.indices.count:this.getVertexCount(e.attributes),s=Q7(this.device,{id:a,geometry:this.createGeometry(a,e,h),material:e.material,materialOptions:this.options,modelOptions:this.options.modelOptions,vertexCount:y});return s.bounds=[e.attributes.POSITION.min,e.attributes.POSITION.max],s}getVertexCount(e){throw new Error("getVertexCount not implemented")}createGeometry(e,t,r){const a={};for(const[h,y]of Object.entries(t.attributes)){const{components:s,size:T,value:B}=y;a[h]={size:T??s,value:B}}return new r9({id:e,topology:r,indices:t.indices.value,attributes:a})}createBuffer(e,t){e.bufferView||(e.bufferView={});const{bufferView:r}=e;return r.lumaBuffers||(r.lumaBuffers={}),r.lumaBuffers[t]||(r.lumaBuffers[t]=this.device.createBuffer({id:`from-${r.id}`,data:r.data||e.value})),r.lumaBuffers[t]}createSampler(e){return e}needsPOT(){return!1}}function dw(i){if(ArrayBuffer.isView(i)||i instanceof ArrayBuffer||i instanceof ImageBitmap)return i;if(Array.isArray(i))return i.map(dw);if(i&&typeof i=="object"){const e={};for(const t in i)e[t]=dw(i[t]);return e}return i}function rW(i,e,t){const r=new iW(i,t),a=r.instantiate(e),h=r.createAnimator();return{scenes:a,animator:h}}function Gs(i,e){if(!i)throw new Error(e||"assert failed: gltf")}const lB={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},cB={5120:1,5121:1,5122:2,5123:2,5125:4,5126:4},BI=["SCALAR","VEC2","VEC3","VEC4"],nW=[[Int8Array,5120],[Uint8Array,5121],[Int16Array,5122],[Uint16Array,5123],[Uint32Array,5125],[Float32Array,5126],[Float64Array,5130]],sW=new Map(nW),oW={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},aW={5120:1,5121:1,5122:2,5123:2,5125:4,5126:4},lW={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array};function uB(i){return BI[i-1]||BI[0]}function x0(i){const e=sW.get(i.constructor);if(!e)throw new Error("Illegal typed array");return e}function vA(i,e){const t=lW[i.componentType],r=oW[i.type],a=aW[i.componentType],h=i.count*r,y=i.count*r*a;Gs(y>=0&&y<=e.byteLength);const s=cB[i.componentType],T=lB[i.type];return{ArrayType:t,length:h,byteLength:y,componentByteSize:s,numberOfComponentsInElement:T}}function cW(i,e,t){const r=i.bufferViews[t];Gs(r);const a=r.buffer,h=e[a];Gs(h);const y=(r.byteOffset||0)+h.byteOffset;return new Uint8Array(h.arrayBuffer,y,r.byteLength)}function uW(i,e,t){var K,ue;const r=typeof t=="number"?(K=i.accessors)==null?void 0:K[t]:t;if(!r)throw new Error(`No gltf accessor ${JSON.stringify(t)}`);const a=(ue=i.bufferViews)==null?void 0:ue[r.bufferView||0];if(!a)throw new Error(`No gltf buffer view for accessor ${a}`);const{arrayBuffer:h,byteOffset:y}=e[a.buffer],s=(y||0)+(r.byteOffset||0)+(a.byteOffset||0),{ArrayType:T,length:B,componentByteSize:F,numberOfComponentsInElement:V}=vA(r,a),X=F*V,se=a.byteStride||X;if(typeof a.byteStride>"u"||a.byteStride===X)return new T(h,s,B);const ne=new T(B);for(let _e=0;_e<r.count;_e++){const ke=new T(h,s+_e*se,V);ne.set(ke,_e*V)}return ne}function hW(){return{asset:{version:"2.0",generator:"loaders.gl"},buffers:[],extensions:{},extensionsRequired:[],extensionsUsed:[]}}class Fn{constructor(e){pe(this,"gltf");pe(this,"sourceBuffers");pe(this,"byteLength");this.gltf={json:(e==null?void 0:e.json)||hW(),buffers:(e==null?void 0:e.buffers)||[],images:(e==null?void 0:e.images)||[]},this.sourceBuffers=[],this.byteLength=0,this.gltf.buffers&&this.gltf.buffers[0]&&(this.byteLength=this.gltf.buffers[0].byteLength,this.sourceBuffers=[this.gltf.buffers[0]])}get json(){return this.gltf.json}getApplicationData(e){return this.json[e]}getExtraData(e){return(this.json.extras||{})[e]}hasExtension(e){const t=this.getUsedExtensions().find(a=>a===e),r=this.getRequiredExtensions().find(a=>a===e);return typeof t=="string"||typeof r=="string"}getExtension(e){const t=this.getUsedExtensions().find(a=>a===e),r=this.json.extensions||{};return t?r[e]:null}getRequiredExtension(e){return this.getRequiredExtensions().find(r=>r===e)?this.getExtension(e):null}getRequiredExtensions(){return this.json.extensionsRequired||[]}getUsedExtensions(){return this.json.extensionsUsed||[]}getRemovedExtensions(){return this.json.extensionsRemoved||[]}getObjectExtension(e,t){return(e.extensions||{})[t]}getScene(e){return this.getObject("scenes",e)}getNode(e){return this.getObject("nodes",e)}getSkin(e){return this.getObject("skins",e)}getMesh(e){return this.getObject("meshes",e)}getMaterial(e){return this.getObject("materials",e)}getAccessor(e){return this.getObject("accessors",e)}getTexture(e){return this.getObject("textures",e)}getSampler(e){return this.getObject("samplers",e)}getImage(e){return this.getObject("images",e)}getBufferView(e){return this.getObject("bufferViews",e)}getBuffer(e){return this.getObject("buffers",e)}getObject(e,t){if(typeof t=="object")return t;const r=this.json[e]&&this.json[e][t];if(!r)throw new Error(`glTF file error: Could not find ${e}[${t}]`);return r}getTypedArrayForBufferView(e){e=this.getBufferView(e);const t=e.buffer,r=this.gltf.buffers[t];Gs(r);const a=(e.byteOffset||0)+r.byteOffset;return new Uint8Array(r.arrayBuffer,a,e.byteLength)}getTypedArrayForAccessor(e){const t=this.getAccessor(e);return uW(this.gltf.json,this.gltf.buffers,t)}getTypedArrayForImageData(e){e=this.getAccessor(e);const t=this.getBufferView(e.bufferView),a=this.getBuffer(t.buffer).data,h=t.byteOffset||0;return new Uint8Array(a,h,t.byteLength)}addApplicationData(e,t){return this.json[e]=t,this}addExtraData(e,t){return this.json.extras=this.json.extras||{},this.json.extras[e]=t,this}addObjectExtension(e,t,r){return e.extensions=e.extensions||{},e.extensions[t]=r,this.registerUsedExtension(t),this}setObjectExtension(e,t,r){const a=e.extensions||{};a[t]=r}removeObjectExtension(e,t){const r=(e==null?void 0:e.extensions)||{};if(r[t]){this.json.extensionsRemoved=this.json.extensionsRemoved||[];const a=this.json.extensionsRemoved;a.includes(t)||a.push(t)}delete r[t]}addExtension(e,t={}){return Gs(t),this.json.extensions=this.json.extensions||{},this.json.extensions[e]=t,this.registerUsedExtension(e),t}addRequiredExtension(e,t={}){return Gs(t),this.addExtension(e,t),this.registerRequiredExtension(e),t}registerUsedExtension(e){this.json.extensionsUsed=this.json.extensionsUsed||[],this.json.extensionsUsed.find(t=>t===e)||this.json.extensionsUsed.push(e)}registerRequiredExtension(e){this.registerUsedExtension(e),this.json.extensionsRequired=this.json.extensionsRequired||[],this.json.extensionsRequired.find(t=>t===e)||this.json.extensionsRequired.push(e)}removeExtension(e){var t;if((t=this.json.extensions)!=null&&t[e]){this.json.extensionsRemoved=this.json.extensionsRemoved||[];const r=this.json.extensionsRemoved;r.includes(e)||r.push(e)}this.json.extensions&&delete this.json.extensions[e],this.json.extensionsRequired&&this._removeStringFromArray(this.json.extensionsRequired,e),this.json.extensionsUsed&&this._removeStringFromArray(this.json.extensionsUsed,e)}setDefaultScene(e){this.json.scene=e}addScene(e){const{nodeIndices:t}=e;return this.json.scenes=this.json.scenes||[],this.json.scenes.push({nodes:t}),this.json.scenes.length-1}addNode(e){const{meshIndex:t,matrix:r}=e;this.json.nodes=this.json.nodes||[];const a={mesh:t};return r&&(a.matrix=r),this.json.nodes.push(a),this.json.nodes.length-1}addMesh(e){const{attributes:t,indices:r,material:a,mode:h=4}=e,s={primitives:[{attributes:this._addAttributes(t),mode:h}]};if(r){const T=this._addIndices(r);s.primitives[0].indices=T}return Number.isFinite(a)&&(s.primitives[0].material=a),this.json.meshes=this.json.meshes||[],this.json.meshes.push(s),this.json.meshes.length-1}addPointCloud(e){const r={primitives:[{attributes:this._addAttributes(e),mode:0}]};return this.json.meshes=this.json.meshes||[],this.json.meshes.push(r),this.json.meshes.length-1}addImage(e,t){const r=Uw(e),a=t||(r==null?void 0:r.mimeType),y={bufferView:this.addBufferView(e),mimeType:a};return this.json.images=this.json.images||[],this.json.images.push(y),this.json.images.length-1}addBufferView(e,t=0,r=this.byteLength){const a=e.byteLength;Gs(Number.isFinite(a)),this.sourceBuffers=this.sourceBuffers||[],this.sourceBuffers.push(e);const h={buffer:t,byteOffset:r,byteLength:a};return this.byteLength+=Dm(a,4),this.json.bufferViews=this.json.bufferViews||[],this.json.bufferViews.push(h),this.json.bufferViews.length-1}addAccessor(e,t){const r={bufferView:e,type:uB(t.size),componentType:t.componentType,count:t.count,max:t.max,min:t.min};return this.json.accessors=this.json.accessors||[],this.json.accessors.push(r),this.json.accessors.length-1}addBinaryBuffer(e,t={size:3}){const r=this.addBufferView(e);let a={min:t.min,max:t.max};(!a.min||!a.max)&&(a=this._getAccessorMinMax(e,t.size));const h={size:t.size,componentType:x0(e),count:Math.round(e.length/t.size),min:a.min,max:a.max};return this.addAccessor(r,Object.assign(h,t))}addTexture(e){const{imageIndex:t}=e,r={source:t};return this.json.textures=this.json.textures||[],this.json.textures.push(r),this.json.textures.length-1}addMaterial(e){return this.json.materials=this.json.materials||[],this.json.materials.push(e),this.json.materials.length-1}createBinaryChunk(){var h,y;const e=this.byteLength,t=new ArrayBuffer(e),r=new Uint8Array(t);let a=0;for(const s of this.sourceBuffers||[])a=_4(s,r,a);(y=(h=this.json)==null?void 0:h.buffers)!=null&&y[0]?this.json.buffers[0].byteLength=e:this.json.buffers=[{byteLength:e}],this.gltf.binary=t,this.sourceBuffers=[t],this.gltf.buffers=[{arrayBuffer:t,byteOffset:0,byteLength:t.byteLength}]}_removeStringFromArray(e,t){let r=!0;for(;r;){const a=e.indexOf(t);a>-1?e.splice(a,1):r=!1}}_addAttributes(e={}){const t={};for(const r in e){const a=e[r],h=this._getGltfAttributeName(r),y=this.addBinaryBuffer(a.value,a);t[h]=y}return t}_addIndices(e){return this.addBinaryBuffer(e,{size:1})}_getGltfAttributeName(e){switch(e.toLowerCase()){case"position":case"positions":case"vertices":return"POSITION";case"normal":case"normals":return"NORMAL";case"color":case"colors":return"COLOR_0";case"texcoord":case"texcoords":return"TEXCOORD_0";default:return e}}_getAccessorMinMax(e,t){const r={min:null,max:null};if(e.length<t)return r;r.min=[],r.max=[];const a=e.subarray(0,t);for(const h of a)r.min.push(h),r.max.push(h);for(let h=t;h<e.length;h+=t)for(let y=0;y<t;y++)r.min[0+y]=Math.min(r.min[0+y],e[h+y]),r.max[0+y]=Math.max(r.max[0+y],e[h+y]);return r}}function DI(i){return(i%1+1)%1}const hB={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16,BOOLEAN:1,STRING:1,ENUM:1},dW={INT8:Int8Array,UINT8:Uint8Array,INT16:Int16Array,UINT16:Uint16Array,INT32:Int32Array,UINT32:Uint32Array,INT64:BigInt64Array,UINT64:BigUint64Array,FLOAT32:Float32Array,FLOAT64:Float64Array},dB={INT8:1,UINT8:1,INT16:2,UINT16:2,INT32:4,UINT32:4,INT64:8,UINT64:8,FLOAT32:4,FLOAT64:8};function xA(i,e){return dB[e]*hB[i]}function b0(i,e,t,r){if(t!=="UINT8"&&t!=="UINT16"&&t!=="UINT32"&&t!=="UINT64")return null;const a=i.getTypedArrayForBufferView(e),h=w0(a,"SCALAR",t,r+1);return h instanceof BigInt64Array||h instanceof BigUint64Array?null:h}function w0(i,e,t,r=1){const a=hB[e],h=dW[t],y=dB[t],s=r*a,T=s*y;let B=i.buffer,F=i.byteOffset;return F%y!==0&&(B=new Uint8Array(B).slice(F,F+T).buffer,F=0),new h(B,F,s)}function bA(i,e,t){var B,F,V,X,se;const r=`TEXCOORD_${e.texCoord||0}`,a=t.attributes[r],h=i.getTypedArrayForAccessor(a),y=i.gltf.json,s=e.index,T=(F=(B=y.textures)==null?void 0:B[s])==null?void 0:F.source;if(typeof T<"u"){const ne=(X=(V=y.images)==null?void 0:V[T])==null?void 0:X.mimeType,K=(se=i.gltf.images)==null?void 0:se[T];if(K&&typeof K.width<"u"){const ue=[];for(let _e=0;_e<h.length;_e+=2){const ke=fW(K,ne,h,_e,e.channels);ue.push(ke)}return ue}}return[]}function fB(i,e,t,r,a){if(!(t!=null&&t.length))return;const h=[];for(const F of t){let V=r.findIndex(X=>X===F);V===-1&&(V=r.push(F)-1),h.push(V)}const y=new Uint32Array(h),s=i.gltf.buffers.push({arrayBuffer:y.buffer,byteOffset:y.byteOffset,byteLength:y.byteLength})-1,T=i.addBufferView(y,s,0),B=i.addAccessor(T,{size:1,componentType:x0(y),count:y.length});a.attributes[e]=B}function fW(i,e,t,r,a=[0]){const h={r:{offset:0,shift:0},g:{offset:1,shift:8},b:{offset:2,shift:16},a:{offset:3,shift:24}},y=t[r],s=t[r+1];let T=1;e&&(e.indexOf("image/jpeg")!==-1||e.indexOf("image/png")!==-1)&&(T=4);const B=pW(y,s,i,T);let F=0;for(const V of a){const X=typeof V=="number"?Object.values(h)[V]:h[V],se=B+X.offset,ne=GM(i);if(ne.data.length<=se)throw new Error(`${ne.data.length} <= ${se}`);const K=ne.data[se];F|=K<<X.shift}return F}function pW(i,e,t,r=1){const a=t.width,h=DI(i)*(a-1),y=Math.round(h),s=t.height,T=DI(e)*(s-1),B=Math.round(T),F=t.components?t.components:r;return(B*a+y)*F}function pB(i,e,t,r,a){const h=[];for(let y=0;y<e;y++){const s=t[y],T=t[y+1]-t[y];if(T+s>r)break;const B=s/a,F=T/a;h.push(i.slice(B,B+F))}return h}function mB(i,e,t){const r=[];for(let a=0;a<e;a++){const h=a*t;r.push(i.slice(h,h+t))}return r}function _B(i,e,t,r){if(t)throw new Error("Not implemented - arrayOffsets for strings is specified");if(r){const a=[],h=new TextDecoder("utf8");let y=0;for(let s=0;s<i;s++){const T=r[s+1]-r[s];if(T+y<=e.length){const B=e.subarray(y,T+y),F=h.decode(B);a.push(F),y+=T}}return a}return[]}const yd="EXT_mesh_features",mW=yd;async function _W(i,e){const t=new Fn(i);yW(t,e)}function gW(i,e){const t=new Fn(i);return xW(t),t.createBinaryChunk(),t.gltf}function yW(i,e){const t=i.gltf.json;if(t.meshes)for(const r of t.meshes)for(const a of r.primitives)vW(i,a,e)}function vW(i,e,t){var h,y,s;if(!((h=t==null?void 0:t.gltf)!=null&&h.loadBuffers))return;const r=(y=e.extensions)==null?void 0:y[yd],a=r==null?void 0:r.featureIds;if(a)for(const T of a){let B;if(typeof T.attribute<"u"){const F=`_FEATURE_ID_${T.attribute}`,V=e.attributes[F];B=i.getTypedArrayForAccessor(V)}else typeof T.texture<"u"&&((s=t==null?void 0:t.gltf)!=null&&s.loadImages)?B=bA(i,T.texture,e):B=[];T.data=B}}function xW(i,e){const t=i.gltf.json.meshes;if(t)for(const r of t)for(const a of r.primitives)wW(i,a)}function bW(i,e,t,r){e.extensions||(e.extensions={});let a=e.extensions[yd];a||(a={featureIds:[]},e.extensions[yd]=a);const{featureIds:h}=a,y={featureCount:t.length,propertyTable:r,data:t};h.push(y),i.addObjectExtension(e,yd,a)}function wW(i,e){var a;const t=(a=e.extensions)==null?void 0:a[yd];if(!t)return;const r=t.featureIds;r.forEach((h,y)=>{if(h.data){const{accessorKey:s,index:T}=AW(e.attributes),B=new Uint32Array(h.data);r[y]={featureCount:B.length,propertyTable:h.propertyTable,attribute:T},i.gltf.buffers.push({arrayBuffer:B.buffer,byteOffset:B.byteOffset,byteLength:B.byteLength});const F=i.addBufferView(B),V=i.addAccessor(F,{size:1,componentType:x0(B),count:B.length});e.attributes[s]=V}})}function AW(i){const e="_FEATURE_ID_",t=Object.keys(i).filter(h=>h.indexOf(e)===0);let r=-1;for(const h of t){const y=Number(h.substring(e.length));y>r&&(r=y)}return r++,{accessorKey:`${e}${r}`,index:r}}const TW=Object.freeze(Object.defineProperty({__proto__:null,createExtMeshFeatures:bW,decode:_W,encode:gW,name:mW},Symbol.toStringTag,{value:"Module"})),Ed="EXT_structural_metadata",EW=Ed;async function SW(i,e){const t=new Fn(i);CW(t,e)}function IW(i,e){const t=new Fn(i);return GW(t),t.createBinaryChunk(),t.gltf}function CW(i,e){var r,a;if(!((r=e.gltf)!=null&&r.loadBuffers))return;const t=i.getExtension(Ed);t&&((a=e.gltf)!=null&&a.loadImages&&MW(i,t),RW(i,t))}function MW(i,e){const t=e.propertyTextures,r=i.gltf.json;if(t&&r.meshes)for(const a of r.meshes)for(const h of a.primitives)BW(i,t,h,e)}function RW(i,e){const t=e.schema;if(!t)return;const r=t.classes,a=e.propertyTables;if(r&&a)for(const h in r){const y=PW(a,h);y&&OW(i,t,y)}}function PW(i,e){for(const t of i)if(t.class===e)return t;return null}function BW(i,e,t,r){var y;if(!e)return;const a=(y=t.extensions)==null?void 0:y[Ed],h=a==null?void 0:a.propertyTextures;if(h)for(const s of h){const T=e[s];DW(i,T,t,r)}}function DW(i,e,t,r){var h;if(!e.properties)return;r.dataAttributeNames||(r.dataAttributeNames=[]);const a=e.class;for(const y in e.properties){const s=`${a}_${y}`,T=(h=e.properties)==null?void 0:h[y];if(!T)continue;T.data||(T.data=[]);const B=T.data,F=bA(i,T,t);F!==null&&(fB(i,s,F,B,t),T.data=B,r.dataAttributeNames.push(s))}}function OW(i,e,t){var h,y;const r=(h=e.classes)==null?void 0:h[t.class];if(!r)throw new Error(`Incorrect data in the EXT_structural_metadata extension: no schema class with name ${t.class}`);const a=t.count;for(const s in r.properties){const T=r.properties[s],B=(y=t.properties)==null?void 0:y[s];if(B){const F=FW(i,e,T,a,B);B.data=F}}}function FW(i,e,t,r,a){let h=[];const y=a.values,s=i.getTypedArrayForBufferView(y),T=kW(i,t,a,r),B=LW(i,a,r);switch(t.type){case"SCALAR":case"VEC2":case"VEC3":case"VEC4":case"MAT2":case"MAT3":case"MAT4":{h=NW(t,r,s,T);break}case"BOOLEAN":throw new Error(`Not implemented - classProperty.type=${t.type}`);case"STRING":{h=_B(r,s,T,B);break}case"ENUM":{h=zW(e,t,r,s,T);break}default:throw new Error(`Unknown classProperty type ${t.type}`)}return h}function kW(i,e,t,r){return e.array&&typeof e.count>"u"&&typeof t.arrayOffsets<"u"?b0(i,t.arrayOffsets,t.arrayOffsetType||"UINT32",r):null}function LW(i,e,t){return typeof e.stringOffsets<"u"?b0(i,e.stringOffsets,e.stringOffsetType||"UINT32",t):null}function NW(i,e,t,r){const a=i.array,h=i.count,y=xA(i.type,i.componentType),s=t.byteLength/y;let T;return i.componentType?T=w0(t,i.type,i.componentType,s):T=t,a?r?pB(T,e,r,t.length,y):h?mB(T,e,h):[]:T}function zW(i,e,t,r,a){var V;const h=e.enumType;if(!h)throw new Error("Incorrect data in the EXT_structural_metadata extension: classProperty.enumType is not set for type ENUM");const y=(V=i.enums)==null?void 0:V[h];if(!y)throw new Error(`Incorrect data in the EXT_structural_metadata extension: schema.enums does't contain ${h}`);const s=y.valueType||"UINT16",T=xA(e.type,s),B=r.byteLength/T;let F=w0(r,e.type,s,B);if(F||(F=r),e.array){if(a)return UW({valuesData:F,numberOfElements:t,arrayOffsets:a,valuesDataBytesLength:r.length,elementSize:T,enumEntry:y});const X=e.count;return X?VW(F,t,X,y):[]}return wA(F,0,t,y)}function UW(i){const{valuesData:e,numberOfElements:t,arrayOffsets:r,valuesDataBytesLength:a,elementSize:h,enumEntry:y}=i,s=[];for(let T=0;T<t;T++){const B=r[T],F=r[T+1]-r[T];if(F+B>a)break;const V=B/h,X=F/h,se=wA(e,V,X,y);s.push(se)}return s}function VW(i,e,t,r){const a=[];for(let h=0;h<e;h++){const y=t*h,s=wA(i,y,t,r);a.push(s)}return a}function wA(i,e,t,r){const a=[];for(let h=0;h<t;h++)if(i instanceof BigInt64Array||i instanceof BigUint64Array)a.push("");else{const y=i[e+h],s=jW(r,y);s?a.push(s.name):a.push("")}return a}function jW(i,e){for(const t of i.values)if(t.value===e)return t;return null}const HW="schemaClassId";function GW(i,e){var r,a;const t=i.getExtension(Ed);if(t&&t.propertyTables)for(const h of t.propertyTables){const y=h.class,s=(a=(r=t.schema)==null?void 0:r.classes)==null?void 0:a[y];h.properties&&s&&$W(h,s,i)}}function $W(i,e,t){for(const r in i.properties){const a=i.properties[r].data;if(a){const h=e.properties[r];if(h){const y=ZW(a,h,t);i.properties[r]=y}}}}function WW(i,e,t=HW){let r=i.getExtension(Ed);r||(r=i.addExtension(Ed)),r.schema=qW(e,t,r.schema);const a=XW(e,t,r.schema);return r.propertyTables||(r.propertyTables=[]),r.propertyTables.push(a)-1}function qW(i,e,t){const r=t??{id:"schema_id"},a={properties:{}};for(const h of i){const y={type:h.elementType,componentType:h.componentType};a.properties[h.name]=y}return r.classes={},r.classes[e]=a,r}function XW(i,e,t){var y;const r={class:e,count:0};let a=0;const h=(y=t.classes)==null?void 0:y[e];for(const s of i){if(a===0&&(a=s.values.length),a!==s.values.length&&s.values.length)throw new Error("Illegal values in attributes");(h==null?void 0:h.properties[s.name])&&(r.properties||(r.properties={}),r.properties[s.name]={values:0,data:s.values})}return r.count=a,r}function ZW(i,e,t){const r={values:0};if(e.type==="STRING"){const{stringData:a,stringOffsets:h}=JW(i);r.stringOffsets=gb(h,t),r.values=gb(a,t)}else if(e.type==="SCALAR"&&e.componentType){const a=KW(i,e.componentType);r.values=gb(a,t)}return r}const YW={INT8:Int8Array,UINT8:Uint8Array,INT16:Int16Array,UINT16:Uint16Array,INT32:Int32Array,UINT32:Uint32Array,INT64:Int32Array,UINT64:Uint32Array,FLOAT32:Float32Array,FLOAT64:Float64Array};function KW(i,e){const t=[];for(const a of i)t.push(Number(a));const r=YW[e];if(!r)throw new Error("Illegal component type");return new r(t)}function JW(i){const e=new TextEncoder,t=[];let r=0;for(const T of i){const B=e.encode(T);r+=B.length,t.push(B)}const a=new Uint8Array(r),h=[];let y=0;for(const T of t)a.set(T,y),h.push(y),y+=T.length;h.push(y);const s=new Uint32Array(h);return{stringData:a,stringOffsets:s}}function gb(i,e){return e.gltf.buffers.push({arrayBuffer:i.buffer,byteOffset:i.byteOffset,byteLength:i.byteLength}),e.addBufferView(i)}const QW=Object.freeze(Object.defineProperty({__proto__:null,createExtStructuralMetadata:WW,decode:SW,encode:IW,name:EW},Symbol.toStringTag,{value:"Module"})),gB="EXT_feature_metadata",eq=gB;async function tq(i,e){const t=new Fn(i);iq(t,e)}function iq(i,e){var r,a;if(!((r=e.gltf)!=null&&r.loadBuffers))return;const t=i.getExtension(gB);t&&((a=e.gltf)!=null&&a.loadImages&&rq(i,t),nq(i,t))}function rq(i,e){const t=e.schema;if(!t)return;const r=t.classes,{featureTextures:a}=e;if(r&&a)for(const h in r){const y=r[h],s=oq(a,h);s&&lq(i,s,y)}}function nq(i,e){const t=e.schema;if(!t)return;const r=t.classes,a=e.featureTables;if(r&&a)for(const h in r){const y=sq(a,h);y&&aq(i,t,y)}}function sq(i,e){for(const t in i){const r=i[t];if(r.class===e)return r}return null}function oq(i,e){for(const t in i){const r=i[t];if(r.class===e)return r}return null}function aq(i,e,t){var h,y;if(!t.class)return;const r=(h=e.classes)==null?void 0:h[t.class];if(!r)throw new Error(`Incorrect data in the EXT_structural_metadata extension: no schema class with name ${t.class}`);const a=t.count;for(const s in r.properties){const T=r.properties[s],B=(y=t.properties)==null?void 0:y[s];if(B){const F=cq(i,e,T,a,B);B.data=F}}}function lq(i,e,t){var a;const r=e.class;for(const h in t.properties){const y=(a=e==null?void 0:e.properties)==null?void 0:a[h];if(y){const s=pq(i,y,r);y.data=s}}}function cq(i,e,t,r,a){let h=[];const y=a.bufferView,s=i.getTypedArrayForBufferView(y),T=uq(i,t,a,r),B=hq(i,t,a,r);return t.type==="STRING"||t.componentType==="STRING"?h=_B(r,s,T,B):dq(t)&&(h=fq(t,r,s,T)),h}function uq(i,e,t,r){return e.type==="ARRAY"&&typeof e.componentCount>"u"&&typeof t.arrayOffsetBufferView<"u"?b0(i,t.arrayOffsetBufferView,t.offsetType||"UINT32",r):null}function hq(i,e,t,r){return typeof t.stringOffsetBufferView<"u"?b0(i,t.stringOffsetBufferView,t.offsetType||"UINT32",r):null}function dq(i){const e=["UINT8","INT16","UINT16","INT32","UINT32","INT64","UINT64","FLOAT32","FLOAT64"];return e.includes(i.type)||typeof i.componentType<"u"&&e.includes(i.componentType)}function fq(i,e,t,r){const a=i.type==="ARRAY",h=i.componentCount,y="SCALAR",s=i.componentType||i.type,T=xA(y,s),B=t.byteLength/T,F=w0(t,y,s,B);return a?r?pB(F,e,r,t.length,T):h?mB(F,e,h):[]:F}function pq(i,e,t){const r=i.gltf.json;if(!r.meshes)return[];const a=[];for(const h of r.meshes)for(const y of h.primitives)mq(i,t,e,a,y);return a}function mq(i,e,t,r,a){const h={channels:t.channels,...t.texture},y=bA(i,h,a);y&&fB(i,e,y,r,a)}const _q=Object.freeze(Object.defineProperty({__proto__:null,decode:tq,name:eq},Symbol.toStringTag,{value:"Module"})),gq="4.3.2",Sd=!0,OI=1735152710,AA=12,Vy=8,yq=1313821514,vq=5130562,xq=0,bq=0,wq=1;function Aq(i,e=0){return`${String.fromCharCode(i.getUint8(e+0))}${String.fromCharCode(i.getUint8(e+1))}${String.fromCharCode(i.getUint8(e+2))}${String.fromCharCode(i.getUint8(e+3))}`}function Tq(i,e=0,t={}){const r=new DataView(i),{magic:a=OI}=t,h=r.getUint32(e,!1);return h===a||h===OI}function Eq(i,e,t=0,r={}){const a=new DataView(e),h=Aq(a,t+0),y=a.getUint32(t+4,Sd),s=a.getUint32(t+8,Sd);switch(Object.assign(i,{header:{byteOffset:t,byteLength:s,hasBinChunk:!1},type:h,version:y,json:{},binChunks:[]}),t+=AA,i.version){case 1:return Sq(i,a,t);case 2:return Iq(i,a,t,r={});default:throw new Error(`Invalid GLB version ${i.version}. Only supports version 1 and 2.`)}}function Sq(i,e,t){tl(i.header.byteLength>AA+Vy);const r=e.getUint32(t+0,Sd),a=e.getUint32(t+4,Sd);return t+=Vy,tl(a===xq),fw(i,e,t,r),t+=r,t+=pw(i,e,t,i.header.byteLength),t}function Iq(i,e,t,r){return tl(i.header.byteLength>AA+Vy),Cq(i,e,t,r),t+i.header.byteLength}function Cq(i,e,t,r){for(;t+8<=i.header.byteLength;){const a=e.getUint32(t+0,Sd),h=e.getUint32(t+4,Sd);switch(t+=Vy,h){case yq:fw(i,e,t,a);break;case vq:pw(i,e,t,a);break;case bq:r.strict||fw(i,e,t,a);break;case wq:r.strict||pw(i,e,t,a);break}t+=Dm(a,4)}return t}function fw(i,e,t,r){const a=new Uint8Array(e.buffer,t,r),y=new TextDecoder("utf8").decode(a);return i.json=JSON.parse(y),Dm(r,4)}function pw(i,e,t,r){return i.header.hasBinChunk=!0,i.binChunks.push({byteOffset:t,byteLength:r,arrayBuffer:e.buffer}),Dm(r,4)}function yB(i,e){if(i.startsWith("data:")||i.startsWith("http:")||i.startsWith("https:"))return i;const r=e.baseUri||e.uri;if(!r)throw new Error(`'baseUri' must be provided to resolve relative url ${i}`);return r.substr(0,r.lastIndexOf("/")+1)+i}const Mq="B9h9z9tFBBBF8fL9gBB9gLaaaaaFa9gEaaaB9gFaFa9gEaaaFaEMcBFFFGGGEIIILF9wFFFLEFBFKNFaFCx/IFMO/LFVK9tv9t9vq95GBt9f9f939h9z9t9f9j9h9s9s9f9jW9vq9zBBp9tv9z9o9v9wW9f9kv9j9v9kv9WvqWv94h919m9mvqBF8Z9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv94h919m9mvqBGy9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv949TvZ91v9u9jvBEn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9P9jWBIi9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9R919hWBLn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9F949wBKI9z9iqlBOc+x8ycGBM/qQFTa8jUUUUBCU/EBlHL8kUUUUBC9+RKGXAGCFJAI9LQBCaRKAE2BBC+gF9HQBALAEAIJHOAGlAGTkUUUBRNCUoBAG9uC/wgBZHKCUGAKCUG9JyRVAECFJRICBRcGXEXAcAF9PQFAVAFAclAcAVJAF9JyRMGXGXAG9FQBAMCbJHKC9wZRSAKCIrCEJCGrRQANCUGJRfCBRbAIRTEXGXAOATlAQ9PQBCBRISEMATAQJRIGXAS9FQBCBRtCBREEXGXAOAIlCi9PQBCBRISLMANCU/CBJAEJRKGXGXGXGXGXATAECKrJ2BBAtCKZrCEZfIBFGEBMAKhB83EBAKCNJhB83EBSEMAKAI2BIAI2BBHmCKrHYAYCE6HYy86BBAKCFJAICIJAYJHY2BBAmCIrCEZHPAPCE6HPy86BBAKCGJAYAPJHY2BBAmCGrCEZHPAPCE6HPy86BBAKCEJAYAPJHY2BBAmCEZHmAmCE6Hmy86BBAKCIJAYAmJHY2BBAI2BFHmCKrHPAPCE6HPy86BBAKCLJAYAPJHY2BBAmCIrCEZHPAPCE6HPy86BBAKCKJAYAPJHY2BBAmCGrCEZHPAPCE6HPy86BBAKCOJAYAPJHY2BBAmCEZHmAmCE6Hmy86BBAKCNJAYAmJHY2BBAI2BGHmCKrHPAPCE6HPy86BBAKCVJAYAPJHY2BBAmCIrCEZHPAPCE6HPy86BBAKCcJAYAPJHY2BBAmCGrCEZHPAPCE6HPy86BBAKCMJAYAPJHY2BBAmCEZHmAmCE6Hmy86BBAKCSJAYAmJHm2BBAI2BEHICKrHYAYCE6HYy86BBAKCQJAmAYJHm2BBAICIrCEZHYAYCE6HYy86BBAKCfJAmAYJHm2BBAICGrCEZHYAYCE6HYy86BBAKCbJAmAYJHK2BBAICEZHIAICE6HIy86BBAKAIJRISGMAKAI2BNAI2BBHmCIrHYAYCb6HYy86BBAKCFJAICNJAYJHY2BBAmCbZHmAmCb6Hmy86BBAKCGJAYAmJHm2BBAI2BFHYCIrHPAPCb6HPy86BBAKCEJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCIJAmAYJHm2BBAI2BGHYCIrHPAPCb6HPy86BBAKCLJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCKJAmAYJHm2BBAI2BEHYCIrHPAPCb6HPy86BBAKCOJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCNJAmAYJHm2BBAI2BIHYCIrHPAPCb6HPy86BBAKCVJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCcJAmAYJHm2BBAI2BLHYCIrHPAPCb6HPy86BBAKCMJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCSJAmAYJHm2BBAI2BKHYCIrHPAPCb6HPy86BBAKCQJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCfJAmAYJHm2BBAI2BOHICIrHYAYCb6HYy86BBAKCbJAmAYJHK2BBAICbZHIAICb6HIy86BBAKAIJRISFMAKAI8pBB83BBAKCNJAICNJ8pBB83BBAICTJRIMAtCGJRtAECTJHEAS9JQBMMGXAIQBCBRISEMGXAM9FQBANAbJ2BBRtCBRKAfREEXAEANCU/CBJAKJ2BBHTCFrCBATCFZl9zAtJHt86BBAEAGJREAKCFJHKAM9HQBMMAfCFJRfAIRTAbCFJHbAG9HQBMMABAcAG9sJANCUGJAMAG9sTkUUUBpANANCUGJAMCaJAG9sJAGTkUUUBpMAMCBAIyAcJRcAIQBMC9+RKSFMCBC99AOAIlAGCAAGCA9Ly6yRKMALCU/EBJ8kUUUUBAKM+OmFTa8jUUUUBCoFlHL8kUUUUBC9+RKGXAFCE9uHOCtJAI9LQBCaRKAE2BBHNC/wFZC/gF9HQBANCbZHVCF9LQBALCoBJCgFCUFT+JUUUBpALC84Jha83EBALC8wJha83EBALC8oJha83EBALCAJha83EBALCiJha83EBALCTJha83EBALha83ENALha83EBAEAIJC9wJRcAECFJHNAOJRMGXAF9FQBCQCbAVCF6yRSABRECBRVCBRQCBRfCBRICBRKEXGXAMAcuQBC9+RKSEMGXGXAN2BBHOC/vF9LQBALCoBJAOCIrCa9zAKJCbZCEWJHb8oGIRTAb8oGBRtGXAOCbZHbAS9PQBALAOCa9zAIJCbZCGWJ8oGBAVAbyROAb9FRbGXGXAGCG9HQBABAt87FBABCIJAO87FBABCGJAT87FBSFMAEAtjGBAECNJAOjGBAECIJATjGBMAVAbJRVALCoBJAKCEWJHmAOjGBAmATjGIALAICGWJAOjGBALCoBJAKCFJCbZHKCEWJHTAtjGBATAOjGIAIAbJRIAKCFJRKSGMGXGXAbCb6QBAQAbJAbC989zJCFJRQSFMAM1BBHbCgFZROGXGXAbCa9MQBAMCFJRMSFMAM1BFHbCgBZCOWAOCgBZqROGXAbCa9MQBAMCGJRMSFMAM1BGHbCgBZCfWAOqROGXAbCa9MQBAMCEJRMSFMAM1BEHbCgBZCdWAOqROGXAbCa9MQBAMCIJRMSFMAM2BIC8cWAOqROAMCLJRMMAOCFrCBAOCFZl9zAQJRQMGXGXAGCG9HQBABAt87FBABCIJAQ87FBABCGJAT87FBSFMAEAtjGBAECNJAQjGBAECIJATjGBMALCoBJAKCEWJHOAQjGBAOATjGIALAICGWJAQjGBALCoBJAKCFJCbZHKCEWJHOAtjGBAOAQjGIAICFJRIAKCFJRKSFMGXAOCDF9LQBALAIAcAOCbZJ2BBHbCIrHTlCbZCGWJ8oGBAVCFJHtATyROALAIAblCbZCGWJ8oGBAtAT9FHmJHtAbCbZHTyRbAT9FRTGXGXAGCG9HQBABAV87FBABCIJAb87FBABCGJAO87FBSFMAEAVjGBAECNJAbjGBAECIJAOjGBMALAICGWJAVjGBALCoBJAKCEWJHYAOjGBAYAVjGIALAICFJHICbZCGWJAOjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAIAmJCbZHICGWJAbjGBALCoBJAKCGJCbZHKCEWJHOAVjGBAOAbjGIAKCFJRKAIATJRIAtATJRVSFMAVCBAM2BBHYyHTAOC/+F6HPJROAYCbZRtGXGXAYCIrHmQBAOCFJRbSFMAORbALAIAmlCbZCGWJ8oGBROMGXGXAtQBAbCFJRVSFMAbRVALAIAYlCbZCGWJ8oGBRbMGXGXAP9FQBAMCFJRYSFMAM1BFHYCgFZRTGXGXAYCa9MQBAMCGJRYSFMAM1BGHYCgBZCOWATCgBZqRTGXAYCa9MQBAMCEJRYSFMAM1BEHYCgBZCfWATqRTGXAYCa9MQBAMCIJRYSFMAM1BIHYCgBZCdWATqRTGXAYCa9MQBAMCLJRYSFMAMCKJRYAM2BLC8cWATqRTMATCFrCBATCFZl9zAQJHQRTMGXGXAmCb6QBAYRPSFMAY1BBHMCgFZROGXGXAMCa9MQBAYCFJRPSFMAY1BFHMCgBZCOWAOCgBZqROGXAMCa9MQBAYCGJRPSFMAY1BGHMCgBZCfWAOqROGXAMCa9MQBAYCEJRPSFMAY1BEHMCgBZCdWAOqROGXAMCa9MQBAYCIJRPSFMAYCLJRPAY2BIC8cWAOqROMAOCFrCBAOCFZl9zAQJHQROMGXGXAtCb6QBAPRMSFMAP1BBHMCgFZRbGXGXAMCa9MQBAPCFJRMSFMAP1BFHMCgBZCOWAbCgBZqRbGXAMCa9MQBAPCGJRMSFMAP1BGHMCgBZCfWAbqRbGXAMCa9MQBAPCEJRMSFMAP1BEHMCgBZCdWAbqRbGXAMCa9MQBAPCIJRMSFMAPCLJRMAP2BIC8cWAbqRbMAbCFrCBAbCFZl9zAQJHQRbMGXGXAGCG9HQBABAT87FBABCIJAb87FBABCGJAO87FBSFMAEATjGBAECNJAbjGBAECIJAOjGBMALCoBJAKCEWJHYAOjGBAYATjGIALAICGWJATjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAICFJHICbZCGWJAOjGBALCoBJAKCGJCbZCEWJHOATjGBAOAbjGIALAIAm9FAmCb6qJHICbZCGWJAbjGBAIAt9FAtCb6qJRIAKCEJRKMANCFJRNABCKJRBAECSJREAKCbZRKAICbZRIAfCEJHfAF9JQBMMCBC99AMAc6yRKMALCoFJ8kUUUUBAKM/tIFGa8jUUUUBCTlRLC9+RKGXAFCLJAI9LQBCaRKAE2BBC/+FZC/QF9HQBALhB83ENAECFJRKAEAIJC98JREGXAF9FQBGXAGCG6QBEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMALCNJAICFZCGWqHGAICGrCBAICFrCFZl9zAG8oGBJHIjGBABAIjGBABCIJRBAFCaJHFQBSGMMEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMABAICGrCBAICFrCFZl9zALCNJAICFZCGWqHI8oGBJHG87FBAIAGjGBABCGJRBAFCaJHFQBMMCBC99AKAE6yRKMAKM+lLKFaF99GaG99FaG99GXGXAGCI9HQBAF9FQFEXGXGX9DBBB8/9DBBB+/ABCGJHG1BB+yAB1BBHE+yHI+L+TABCFJHL1BBHK+yHO+L+THN9DBBBB9gHVyAN9DBB/+hANAN+U9DBBBBANAVyHcAc+MHMAECa3yAI+SHIAI+UAcAMAKCa3yAO+SHcAc+U+S+S+R+VHO+U+SHN+L9DBBB9P9d9FQBAN+oRESFMCUUUU94REMAGAE86BBGXGX9DBBB8/9DBBB+/Ac9DBBBB9gyAcAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMALAG86BBGXGX9DBBB8/9DBBB+/AI9DBBBB9gyAIAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMABAG86BBABCIJRBAFCaJHFQBSGMMAF9FQBEXGXGX9DBBB8/9DBBB+/ABCIJHG8uFB+yAB8uFBHE+yHI+L+TABCGJHL8uFBHK+yHO+L+THN9DBBBB9gHVyAN9DB/+g6ANAN+U9DBBBBANAVyHcAc+MHMAECa3yAI+SHIAI+UAcAMAKCa3yAO+SHcAc+U+S+S+R+VHO+U+SHN+L9DBBB9P9d9FQBAN+oRESFMCUUUU94REMAGAE87FBGXGX9DBBB8/9DBBB+/Ac9DBBBB9gyAcAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMALAG87FBGXGX9DBBB8/9DBBB+/AI9DBBBB9gyAIAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMABAG87FBABCNJRBAFCaJHFQBMMM/SEIEaE99EaF99GXAF9FQBCBREABRIEXGXGX9D/zI818/AICKJ8uFBHLCEq+y+VHKAI8uFB+y+UHO9DB/+g6+U9DBBB8/9DBBB+/AO9DBBBB9gy+SHN+L9DBBB9P9d9FQBAN+oRVSFMCUUUU94RVMAICIJ8uFBRcAICGJ8uFBRMABALCFJCEZAEqCFWJAV87FBGXGXAKAM+y+UHN9DB/+g6+U9DBBB8/9DBBB+/AN9DBBBB9gy+SHS+L9DBBB9P9d9FQBAS+oRMSFMCUUUU94RMMABALCGJCEZAEqCFWJAM87FBGXGXAKAc+y+UHK9DB/+g6+U9DBBB8/9DBBB+/AK9DBBBB9gy+SHS+L9DBBB9P9d9FQBAS+oRcSFMCUUUU94RcMABALCaJCEZAEqCFWJAc87FBGXGX9DBBU8/AOAO+U+TANAN+U+TAKAK+U+THO9DBBBBAO9DBBBB9gy+R9DB/+g6+U9DBBB8/+SHO+L9DBBB9P9d9FQBAO+oRcSFMCUUUU94RcMABALCEZAEqCFWJAc87FBAICNJRIAECIJREAFCaJHFQBMMM9JBGXAGCGrAF9sHF9FQBEXABAB8oGBHGCNWCN91+yAGCi91CnWCUUU/8EJ+++U84GBABCIJRBAFCaJHFQBMMM9TFEaCBCB8oGUkUUBHFABCEJC98ZJHBjGUkUUBGXGXAB8/BCTWHGuQBCaREABAGlCggEJCTrXBCa6QFMAFREMAEM/lFFFaGXGXAFABqCEZ9FQBABRESFMGXGXAGCT9PQBABRESFMABREEXAEAF8oGBjGBAECIJAFCIJ8oGBjGBAECNJAFCNJ8oGBjGBAECSJAFCSJ8oGBjGBAECTJREAFCTJRFAGC9wJHGCb9LQBMMAGCI9JQBEXAEAF8oGBjGBAFCIJRFAECIJREAGC98JHGCE9LQBMMGXAG9FQBEXAEAF2BB86BBAECFJREAFCFJRFAGCaJHGQBMMABMoFFGaGXGXABCEZ9FQBABRESFMAFCgFZC+BwsN9sRIGXGXAGCT9PQBABRESFMABREEXAEAIjGBAECSJAIjGBAECNJAIjGBAECIJAIjGBAECTJREAGC9wJHGCb9LQBMMAGCI9JQBEXAEAIjGBAECIJREAGC98JHGCE9LQBMMGXAG9FQBEXAEAF86BBAECFJREAGCaJHGQBMMABMMMFBCUNMIT9kBB",Rq="B9h9z9tFBBBF8dL9gBB9gLaaaaaFa9gEaaaB9gGaaB9gFaFaEQSBBFBFFGEGEGIILF9wFFFLEFBFKNFaFCx/aFMO/LFVK9tv9t9vq95GBt9f9f939h9z9t9f9j9h9s9s9f9jW9vq9zBBp9tv9z9o9v9wW9f9kv9j9v9kv9WvqWv94h919m9mvqBG8Z9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv94h919m9mvqBIy9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv949TvZ91v9u9jvBLn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9P9jWBKi9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9R919hWBNn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9F949wBcI9z9iqlBMc/j9JSIBTEM9+FLa8jUUUUBCTlRBCBRFEXCBRGCBREEXABCNJAGJAECUaAFAGrCFZHIy86BBAEAIJREAGCFJHGCN9HQBMAFCx+YUUBJAE86BBAFCEWCxkUUBJAB8pEN83EBAFCFJHFCUG9HQBMMkRIbaG97FaK978jUUUUBCU/KBlHL8kUUUUBC9+RKGXAGCFJAI9LQBCaRKAE2BBC+gF9HQBALAEAIJHOAGlAG/8cBBCUoBAG9uC/wgBZHKCUGAKCUG9JyRNAECFJRKCBRVGXEXAVAF9PQFANAFAVlAVANJAF9JyRcGXGXAG9FQBAcCbJHIC9wZHMCE9sRSAMCFWRQAICIrCEJCGrRfCBRbEXAKRTCBRtGXEXGXAOATlAf9PQBCBRKSLMALCU/CBJAtAM9sJRmATAfJRKCBREGXAMCoB9JQBAOAKlC/gB9JQBCBRIEXAmAIJREGXGXGXGXGXATAICKrJ2BBHYCEZfIBFGEBMAECBDtDMIBSEMAEAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIBAKCIJAnDeBJAeCx+YUUBJ2BBJRKSGMAEAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIBAKCNJAnDeBJAeCx+YUUBJ2BBJRKSFMAEAKDBBBDMIBAKCTJRKMGXGXGXGXGXAYCGrCEZfIBFGEBMAECBDtDMITSEMAEAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMITAKCIJAnDeBJAeCx+YUUBJ2BBJRKSGMAEAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMITAKCNJAnDeBJAeCx+YUUBJ2BBJRKSFMAEAKDBBBDMITAKCTJRKMGXGXGXGXGXAYCIrCEZfIBFGEBMAECBDtDMIASEMAEAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIAAKCIJAnDeBJAeCx+YUUBJ2BBJRKSGMAEAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIAAKCNJAnDeBJAeCx+YUUBJ2BBJRKSFMAEAKDBBBDMIAAKCTJRKMGXGXGXGXGXAYCKrfIBFGEBMAECBDtDMI8wSEMAEAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HYCEWCxkUUBJDBEBAYCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HYCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMI8wAKCIJAnDeBJAYCx+YUUBJ2BBJRKSGMAEAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HYCEWCxkUUBJDBEBAYCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HYCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMI8wAKCNJAnDeBJAYCx+YUUBJ2BBJRKSFMAEAKDBBBDMI8wAKCTJRKMAICoBJREAICUFJAM9LQFAERIAOAKlC/fB9LQBMMGXAEAM9PQBAECErRIEXGXAOAKlCi9PQBCBRKSOMAmAEJRYGXGXGXGXGXATAECKrJ2BBAICKZrCEZfIBFGEBMAYCBDtDMIBSEMAYAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIBAKCIJAnDeBJAeCx+YUUBJ2BBJRKSGMAYAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIBAKCNJAnDeBJAeCx+YUUBJ2BBJRKSFMAYAKDBBBDMIBAKCTJRKMAICGJRIAECTJHEAM9JQBMMGXAK9FQBAKRTAtCFJHtCI6QGSFMMCBRKSEMGXAM9FQBALCUGJAbJREALAbJDBGBRnCBRYEXAEALCU/CBJAYJHIDBIBHdCFD9tAdCFDbHPD9OD9hD9RHdAIAMJDBIBHiCFD9tAiAPD9OD9hD9RHiDQBTFtGmEYIPLdKeOnH8ZAIAQJDBIBHpCFD9tApAPD9OD9hD9RHpAIASJDBIBHyCFD9tAyAPD9OD9hD9RHyDQBTFtGmEYIPLdKeOnH8cDQBFTtGEmYILPdKOenHPAPDQBFGEBFGEBFGEBFGEAnD9uHnDyBjGBAEAGJHIAnAPAPDQILKOILKOILKOILKOD9uHnDyBjGBAIAGJHIAnAPAPDQNVcMNVcMNVcMNVcMD9uHnDyBjGBAIAGJHIAnAPAPDQSQfbSQfbSQfbSQfbD9uHnDyBjGBAIAGJHIAnA8ZA8cDQNVi8ZcMpySQ8c8dfb8e8fHPAPDQBFGEBFGEBFGEBFGED9uHnDyBjGBAIAGJHIAnAPAPDQILKOILKOILKOILKOD9uHnDyBjGBAIAGJHIAnAPAPDQNVcMNVcMNVcMNVcMD9uHnDyBjGBAIAGJHIAnAPAPDQSQfbSQfbSQfbSQfbD9uHnDyBjGBAIAGJHIAnAdAiDQNiV8ZcpMyS8cQ8df8eb8fHdApAyDQNiV8ZcpMyS8cQ8df8eb8fHiDQBFTtGEmYILPdKOenHPAPDQBFGEBFGEBFGEBFGED9uHnDyBjGBAIAGJHIAnAPAPDQILKOILKOILKOILKOD9uHnDyBjGBAIAGJHIAnAPAPDQNVcMNVcMNVcMNVcMD9uHnDyBjGBAIAGJHIAnAPAPDQSQfbSQfbSQfbSQfbD9uHnDyBjGBAIAGJHIAnAdAiDQNVi8ZcMpySQ8c8dfb8e8fHPAPDQBFGEBFGEBFGEBFGED9uHnDyBjGBAIAGJHIAnAPAPDQILKOILKOILKOILKOD9uHnDyBjGBAIAGJHIAnAPAPDQNVcMNVcMNVcMNVcMD9uHnDyBjGBAIAGJHIAnAPAPDQSQfbSQfbSQfbSQfbD9uHnDyBjGBAIAGJREAYCTJHYAM9JQBMMAbCIJHbAG9JQBMMABAVAG9sJALCUGJAcAG9s/8cBBALALCUGJAcCaJAG9sJAG/8cBBMAcCBAKyAVJRVAKQBMC9+RKSFMCBC99AOAKlAGCAAGCA9Ly6yRKMALCU/KBJ8kUUUUBAKMNBT+BUUUBM+KmFTa8jUUUUBCoFlHL8kUUUUBC9+RKGXAFCE9uHOCtJAI9LQBCaRKAE2BBHNC/wFZC/gF9HQBANCbZHVCF9LQBALCoBJCgFCUF/8MBALC84Jha83EBALC8wJha83EBALC8oJha83EBALCAJha83EBALCiJha83EBALCTJha83EBALha83ENALha83EBAEAIJC9wJRcAECFJHNAOJRMGXAF9FQBCQCbAVCF6yRSABRECBRVCBRQCBRfCBRICBRKEXGXAMAcuQBC9+RKSEMGXGXAN2BBHOC/vF9LQBALCoBJAOCIrCa9zAKJCbZCEWJHb8oGIRTAb8oGBRtGXAOCbZHbAS9PQBALAOCa9zAIJCbZCGWJ8oGBAVAbyROAb9FRbGXGXAGCG9HQBABAt87FBABCIJAO87FBABCGJAT87FBSFMAEAtjGBAECNJAOjGBAECIJATjGBMAVAbJRVALCoBJAKCEWJHmAOjGBAmATjGIALAICGWJAOjGBALCoBJAKCFJCbZHKCEWJHTAtjGBATAOjGIAIAbJRIAKCFJRKSGMGXGXAbCb6QBAQAbJAbC989zJCFJRQSFMAM1BBHbCgFZROGXGXAbCa9MQBAMCFJRMSFMAM1BFHbCgBZCOWAOCgBZqROGXAbCa9MQBAMCGJRMSFMAM1BGHbCgBZCfWAOqROGXAbCa9MQBAMCEJRMSFMAM1BEHbCgBZCdWAOqROGXAbCa9MQBAMCIJRMSFMAM2BIC8cWAOqROAMCLJRMMAOCFrCBAOCFZl9zAQJRQMGXGXAGCG9HQBABAt87FBABCIJAQ87FBABCGJAT87FBSFMAEAtjGBAECNJAQjGBAECIJATjGBMALCoBJAKCEWJHOAQjGBAOATjGIALAICGWJAQjGBALCoBJAKCFJCbZHKCEWJHOAtjGBAOAQjGIAICFJRIAKCFJRKSFMGXAOCDF9LQBALAIAcAOCbZJ2BBHbCIrHTlCbZCGWJ8oGBAVCFJHtATyROALAIAblCbZCGWJ8oGBAtAT9FHmJHtAbCbZHTyRbAT9FRTGXGXAGCG9HQBABAV87FBABCIJAb87FBABCGJAO87FBSFMAEAVjGBAECNJAbjGBAECIJAOjGBMALAICGWJAVjGBALCoBJAKCEWJHYAOjGBAYAVjGIALAICFJHICbZCGWJAOjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAIAmJCbZHICGWJAbjGBALCoBJAKCGJCbZHKCEWJHOAVjGBAOAbjGIAKCFJRKAIATJRIAtATJRVSFMAVCBAM2BBHYyHTAOC/+F6HPJROAYCbZRtGXGXAYCIrHmQBAOCFJRbSFMAORbALAIAmlCbZCGWJ8oGBROMGXGXAtQBAbCFJRVSFMAbRVALAIAYlCbZCGWJ8oGBRbMGXGXAP9FQBAMCFJRYSFMAM1BFHYCgFZRTGXGXAYCa9MQBAMCGJRYSFMAM1BGHYCgBZCOWATCgBZqRTGXAYCa9MQBAMCEJRYSFMAM1BEHYCgBZCfWATqRTGXAYCa9MQBAMCIJRYSFMAM1BIHYCgBZCdWATqRTGXAYCa9MQBAMCLJRYSFMAMCKJRYAM2BLC8cWATqRTMATCFrCBATCFZl9zAQJHQRTMGXGXAmCb6QBAYRPSFMAY1BBHMCgFZROGXGXAMCa9MQBAYCFJRPSFMAY1BFHMCgBZCOWAOCgBZqROGXAMCa9MQBAYCGJRPSFMAY1BGHMCgBZCfWAOqROGXAMCa9MQBAYCEJRPSFMAY1BEHMCgBZCdWAOqROGXAMCa9MQBAYCIJRPSFMAYCLJRPAY2BIC8cWAOqROMAOCFrCBAOCFZl9zAQJHQROMGXGXAtCb6QBAPRMSFMAP1BBHMCgFZRbGXGXAMCa9MQBAPCFJRMSFMAP1BFHMCgBZCOWAbCgBZqRbGXAMCa9MQBAPCGJRMSFMAP1BGHMCgBZCfWAbqRbGXAMCa9MQBAPCEJRMSFMAP1BEHMCgBZCdWAbqRbGXAMCa9MQBAPCIJRMSFMAPCLJRMAP2BIC8cWAbqRbMAbCFrCBAbCFZl9zAQJHQRbMGXGXAGCG9HQBABAT87FBABCIJAb87FBABCGJAO87FBSFMAEATjGBAECNJAbjGBAECIJAOjGBMALCoBJAKCEWJHYAOjGBAYATjGIALAICGWJATjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAICFJHICbZCGWJAOjGBALCoBJAKCGJCbZCEWJHOATjGBAOAbjGIALAIAm9FAmCb6qJHICbZCGWJAbjGBAIAt9FAtCb6qJRIAKCEJRKMANCFJRNABCKJRBAECSJREAKCbZRKAICbZRIAfCEJHfAF9JQBMMCBC99AMAc6yRKMALCoFJ8kUUUUBAKM/tIFGa8jUUUUBCTlRLC9+RKGXAFCLJAI9LQBCaRKAE2BBC/+FZC/QF9HQBALhB83ENAECFJRKAEAIJC98JREGXAF9FQBGXAGCG6QBEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMALCNJAICFZCGWqHGAICGrCBAICFrCFZl9zAG8oGBJHIjGBABAIjGBABCIJRBAFCaJHFQBSGMMEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMABAICGrCBAICFrCFZl9zALCNJAICFZCGWqHI8oGBJHG87FBAIAGjGBABCGJRBAFCaJHFQBMMCBC99AKAE6yRKMAKM/xLGEaK978jUUUUBCAlHE8kUUUUBGXGXAGCI9HQBGXAFC98ZHI9FQBABRGCBRLEXAGAGDBBBHKCiD+rFCiD+sFD/6FHOAKCND+rFCiD+sFD/6FAOD/gFAKCTD+rFCiD+sFD/6FHND/gFD/kFD/lFHVCBDtD+2FHcAOCUUUU94DtHMD9OD9RD/kFHO9DBB/+hDYAOAOD/mFAVAVD/mFANAcANAMD9OD9RD/kFHOAOD/mFD/kFD/kFD/jFD/nFHND/mF9DBBX9LDYHcD/kFCgFDtD9OAKCUUU94DtD9OD9QAOAND/mFAcD/kFCND+rFCU/+EDtD9OD9QAVAND/mFAcD/kFCTD+rFCUU/8ODtD9OD9QDMBBAGCTJRGALCIJHLAI9JQBMMAIAF9PQFAEAFCEZHLCGWHGqCBCTAGl/8MBAEABAICGWJHIAG/8cBBGXAL9FQBAEAEDBIBHKCiD+rFCiD+sFD/6FHOAKCND+rFCiD+sFD/6FAOD/gFAKCTD+rFCiD+sFD/6FHND/gFD/kFD/lFHVCBDtD+2FHcAOCUUUU94DtHMD9OD9RD/kFHO9DBB/+hDYAOAOD/mFAVAVD/mFANAcANAMD9OD9RD/kFHOAOD/mFD/kFD/kFD/jFD/nFHND/mF9DBBX9LDYHcD/kFCgFDtD9OAKCUUU94DtD9OD9QAOAND/mFAcD/kFCND+rFCU/+EDtD9OD9QAVAND/mFAcD/kFCTD+rFCUU/8ODtD9OD9QDMIBMAIAEAG/8cBBSFMABAFC98ZHGT+HUUUBAGAF9PQBAEAFCEZHICEWHLJCBCAALl/8MBAEABAGCEWJHGAL/8cBBAEAIT+HUUUBAGAEAL/8cBBMAECAJ8kUUUUBM+yEGGaO97GXAF9FQBCBRGEXABCTJHEAEDBBBHICBDtHLCUU98D8cFCUU98D8cEHKD9OABDBBBHOAIDQILKOSQfbPden8c8d8e8fCggFDtD9OD/6FAOAIDQBFGENVcMTtmYi8ZpyHICTD+sFD/6FHND/gFAICTD+rFCTD+sFD/6FHVD/gFD/kFD/lFHI9DB/+g6DYAVAIALD+2FHLAVCUUUU94DtHcD9OD9RD/kFHVAVD/mFAIAID/mFANALANAcD9OD9RD/kFHIAID/mFD/kFD/kFD/jFD/nFHND/mF9DBBX9LDYHLD/kFCTD+rFAVAND/mFALD/kFCggEDtD9OD9QHVAIAND/mFALD/kFCaDbCBDnGCBDnECBDnKCBDnOCBDncCBDnMCBDnfCBDnbD9OHIDQNVi8ZcMpySQ8c8dfb8e8fD9QDMBBABAOAKD9OAVAIDQBFTtGEmYILPdKOenD9QDMBBABCAJRBAGCIJHGAF9JQBMMM94FEa8jUUUUBCAlHE8kUUUUBABAFC98ZHIT+JUUUBGXAIAF9PQBAEAFCEZHLCEWHFJCBCAAFl/8MBAEABAICEWJHBAF/8cBBAEALT+JUUUBABAEAF/8cBBMAECAJ8kUUUUBM/hEIGaF97FaL978jUUUUBCTlRGGXAF9FQBCBREEXAGABDBBBHIABCTJHLDBBBHKDQILKOSQfbPden8c8d8e8fHOCTD+sFHNCID+rFDMIBAB9DBBU8/DY9D/zI818/DYANCEDtD9QD/6FD/nFHNAIAKDQBFGENVcMTtmYi8ZpyHICTD+rFCTD+sFD/6FD/mFHKAKD/mFANAICTD+sFD/6FD/mFHVAVD/mFANAOCTD+rFCTD+sFD/6FD/mFHOAOD/mFD/kFD/kFD/lFCBDtD+4FD/jF9DB/+g6DYHND/mF9DBBX9LDYHID/kFCggEDtHcD9OAVAND/mFAID/kFCTD+rFD9QHVAOAND/mFAID/kFCTD+rFAKAND/mFAID/kFAcD9OD9QHNDQBFTtGEmYILPdKOenHID8dBAGDBIBDyB+t+J83EBABCNJAID8dFAGDBIBDyF+t+J83EBALAVANDQNVi8ZcMpySQ8c8dfb8e8fHND8dBAGDBIBDyG+t+J83EBABCiJAND8dFAGDBIBDyE+t+J83EBABCAJRBAECIJHEAF9JQBMMM/3FGEaF978jUUUUBCoBlREGXAGCGrAF9sHIC98ZHL9FQBCBRGABRFEXAFAFDBBBHKCND+rFCND+sFD/6FAKCiD+sFCnD+rFCUUU/8EDtD+uFD/mFDMBBAFCTJRFAGCIJHGAL9JQBMMGXALAI9PQBAEAICEZHGCGWHFqCBCoBAFl/8MBAEABALCGWJHLAF/8cBBGXAG9FQBAEAEDBIBHKCND+rFCND+sFD/6FAKCiD+sFCnD+rFCUUU/8EDtD+uFD/mFDMIBMALAEAF/8cBBMM9TFEaCBCB8oGUkUUBHFABCEJC98ZJHBjGUkUUBGXGXAB8/BCTWHGuQBCaREABAGlCggEJCTrXBCa6QFMAFREMAEMMMFBCUNMIT9tBB",Pq=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]),Bq=new Uint8Array([32,0,65,253,3,1,2,34,4,106,6,5,11,8,7,20,13,33,12,16,128,9,116,64,19,113,127,15,10,21,22,14,255,66,24,54,136,107,18,23,192,26,114,118,132,17,77,101,130,144,27,87,131,44,45,74,156,154,70,167]),Dq={0:"",1:"meshopt_decodeFilterOct",2:"meshopt_decodeFilterQuat",3:"meshopt_decodeFilterExp",NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},Oq={0:"meshopt_decodeVertexBuffer",1:"meshopt_decodeIndexBuffer",2:"meshopt_decodeIndexSequence",ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"};async function Fq(i,e,t,r,a,h="NONE"){const y=await kq();zq(y,y.exports[Oq[a]],i,e,t,r,y.exports[Dq[h||"NONE"]])}let yb;async function kq(){return yb||(yb=Lq()),yb}async function Lq(){let i=Mq;WebAssembly.validate(Pq)&&(i=Rq,console.log("Warning: meshopt_decoder is using experimental SIMD support"));const e=await WebAssembly.instantiate(Nq(i),{});return await e.instance.exports.__wasm_call_ctors(),e.instance}function Nq(i){const e=new Uint8Array(i.length);for(let r=0;r<i.length;++r){const a=i.charCodeAt(r);e[r]=a>96?a-71:a>64?a-65:a>47?a+4:a>46?63:62}let t=0;for(let r=0;r<i.length;++r)e[t++]=e[r]<60?Bq[e[r]]:(e[r]-60)*64+e[++r];return e.buffer.slice(0,t)}function zq(i,e,t,r,a,h,y){const s=i.exports.sbrk,T=r+3&-4,B=s(T*a),F=s(h.length),V=new Uint8Array(i.exports.memory.buffer);V.set(h,F);const X=e(B,r,a,F,h.length);if(X===0&&y&&y(B,T,a),t.set(V.subarray(B,B+r*a)),s(B-s(0)),X!==0)throw new Error(`Malformed buffer data: ${X}`)}const jy="EXT_meshopt_compression",Uq=jy;async function Vq(i,e){var a,h;const t=new Fn(i);if(!((a=e==null?void 0:e.gltf)!=null&&a.decompressMeshes)||!((h=e.gltf)!=null&&h.loadBuffers))return;const r=[];for(const y of i.json.bufferViews||[])r.push(jq(t,y));await Promise.all(r),t.removeExtension(jy)}async function jq(i,e){const t=i.getObjectExtension(e,jy);if(t){const{byteOffset:r=0,byteLength:a=0,byteStride:h,count:y,mode:s,filter:T="NONE",buffer:B}=t,F=i.gltf.buffers[B],V=new Uint8Array(F.arrayBuffer,F.byteOffset+r,a),X=new Uint8Array(i.gltf.buffers[e.buffer].arrayBuffer,e.byteOffset,e.byteLength);await Fq(X,y,h,V,s,T),i.removeObjectExtension(e,jy)}}const Hq=Object.freeze(Object.defineProperty({__proto__:null,decode:Vq,name:Uq},Symbol.toStringTag,{value:"Module"})),sd="EXT_texture_webp",Gq=sd;function $q(i,e){const t=new Fn(i);if(!rz("image/webp")){if(t.getRequiredExtensions().includes(sd))throw new Error(`gltf: Required extension ${sd} not supported by browser`);return}const{json:r}=t;for(const a of r.textures||[]){const h=t.getObjectExtension(a,sd);h&&(a.source=h.source),t.removeObjectExtension(a,sd)}t.removeExtension(sd)}const Wq=Object.freeze(Object.defineProperty({__proto__:null,name:Gq,preprocess:$q},Symbol.toStringTag,{value:"Module"})),ty="KHR_texture_basisu",qq=ty;function Xq(i,e){const t=new Fn(i),{json:r}=t;for(const a of r.textures||[]){const h=t.getObjectExtension(a,ty);h&&(a.source=h.source,t.removeObjectExtension(a,ty))}t.removeExtension(ty)}const Zq=Object.freeze(Object.defineProperty({__proto__:null,name:qq,preprocess:Xq},Symbol.toStringTag,{value:"Module"})),Yq="4.3.2",Kq={dataType:null,batchType:null,name:"Draco",id:"draco",module:"draco",version:Yq,worker:!0,extensions:["drc"],mimeTypes:["application/octet-stream"],binary:!0,tests:["DRACO"],options:{draco:{decoderType:typeof WebAssembly=="object"?"wasm":"js",libraryPath:"libs/",extraAttributes:{},attributeNameEntry:void 0}}};function Jq(i,e,t){const r=vB(e.metadata),a=[],h=Qq(e.attributes);for(const y in i){const s=i[y],T=FI(y,s,h[y]);a.push(T)}if(t){const y=FI("indices",t);a.push(y)}return{fields:a,metadata:r}}function Qq(i){const e={};for(const t in i){const r=i[t];e[r.name||"undefined"]=r}return e}function FI(i,e,t){const r=t?vB(t.metadata):void 0;return AN(i,e,r)}function vB(i){Object.entries(i);const e={};for(const t in i)e[`${t}.string`]=JSON.stringify(i[t]);return e}const kI={POSITION:"POSITION",NORMAL:"NORMAL",COLOR:"COLOR_0",TEX_COORD:"TEXCOORD_0"},eX={1:Int8Array,2:Uint8Array,3:Int16Array,4:Uint16Array,5:Int32Array,6:Uint32Array,9:Float32Array},tX=4;class iX{constructor(e){pe(this,"draco");pe(this,"decoder");pe(this,"metadataQuerier");this.draco=e,this.decoder=new this.draco.Decoder,this.metadataQuerier=new this.draco.MetadataQuerier}destroy(){this.draco.destroy(this.decoder),this.draco.destroy(this.metadataQuerier)}parseSync(e,t={}){const r=new this.draco.DecoderBuffer;r.Init(new Int8Array(e),e.byteLength),this._disableAttributeTransforms(t);const a=this.decoder.GetEncodedGeometryType(r),h=a===this.draco.TRIANGULAR_MESH?new this.draco.Mesh:new this.draco.PointCloud;try{let y;switch(a){case this.draco.TRIANGULAR_MESH:y=this.decoder.DecodeBufferToMesh(r,h);break;case this.draco.POINT_CLOUD:y=this.decoder.DecodeBufferToPointCloud(r,h);break;default:throw new Error("DRACO: Unknown geometry type.")}if(!y.ok()||!h.ptr){const X=`DRACO decompression failed: ${y.error_msg()}`;throw new Error(X)}const s=this._getDracoLoaderData(h,a,t),T=this._getMeshData(h,s,t),B=wN(T.attributes),F=Jq(T.attributes,s,T.indices);return{loader:"draco",loaderData:s,header:{vertexCount:h.num_points(),boundingBox:B},...T,schema:F}}finally{this.draco.destroy(r),h&&this.draco.destroy(h)}}_getDracoLoaderData(e,t,r){const a=this._getTopLevelMetadata(e),h=this._getDracoAttributes(e,r);return{geometry_type:t,num_attributes:e.num_attributes(),num_points:e.num_points(),num_faces:e instanceof this.draco.Mesh?e.num_faces():0,metadata:a,attributes:h}}_getDracoAttributes(e,t){const r={};for(let a=0;a<e.num_attributes();a++){const h=this.decoder.GetAttribute(e,a),y=this._getAttributeMetadata(e,a);r[h.unique_id()]={unique_id:h.unique_id(),attribute_type:h.attribute_type(),data_type:h.data_type(),num_components:h.num_components(),byte_offset:h.byte_offset(),byte_stride:h.byte_stride(),normalized:h.normalized(),attribute_index:a,metadata:y};const s=this._getQuantizationTransform(h,t);s&&(r[h.unique_id()].quantization_transform=s);const T=this._getOctahedronTransform(h,t);T&&(r[h.unique_id()].octahedron_transform=T)}return r}_getMeshData(e,t,r){const a=this._getMeshAttributes(t,e,r);if(!a.POSITION)throw new Error("DRACO: No position attribute found.");if(e instanceof this.draco.Mesh)switch(r.topology){case"triangle-strip":return{topology:"triangle-strip",mode:4,attributes:a,indices:{value:this._getTriangleStripIndices(e),size:1}};case"triangle-list":default:return{topology:"triangle-list",mode:5,attributes:a,indices:{value:this._getTriangleListIndices(e),size:1}}}return{topology:"point-list",mode:0,attributes:a}}_getMeshAttributes(e,t,r){const a={};for(const h of Object.values(e.attributes)){const y=this._deduceAttributeName(h,r);h.name=y;const s=this._getAttributeValues(t,h);if(s){const{value:T,size:B}=s;a[y]={value:T,size:B,byteOffset:h.byte_offset,byteStride:h.byte_stride,normalized:h.normalized}}}return a}_getTriangleListIndices(e){const r=e.num_faces()*3,a=r*tX,h=this.draco._malloc(a);try{return this.decoder.GetTrianglesUInt32Array(e,a,h),new Uint32Array(this.draco.HEAPF32.buffer,h,r).slice()}finally{this.draco._free(h)}}_getTriangleStripIndices(e){const t=new this.draco.DracoInt32Array;try{return this.decoder.GetTriangleStripsFromMesh(e,t),sX(t)}finally{this.draco.destroy(t)}}_getAttributeValues(e,t){const r=eX[t.data_type];if(!r)return console.warn(`DRACO: Unsupported attribute type ${t.data_type}`),null;const a=t.num_components,y=e.num_points()*a,s=y*r.BYTES_PER_ELEMENT,T=rX(this.draco,r);let B;const F=this.draco._malloc(s);try{const V=this.decoder.GetAttribute(e,t.attribute_index);this.decoder.GetAttributeDataArrayForAllPoints(e,V,T,s,F),B=new r(this.draco.HEAPF32.buffer,F,y).slice()}finally{this.draco._free(F)}return{value:B,size:a}}_deduceAttributeName(e,t){const r=e.unique_id;for(const[y,s]of Object.entries(t.extraAttributes||{}))if(s===r)return y;const a=e.attribute_type;for(const y in kI)if(this.draco[y]===a)return kI[y];const h=t.attributeNameEntry||"name";return e.metadata[h]?e.metadata[h].string:`CUSTOM_ATTRIBUTE_${r}`}_getTopLevelMetadata(e){const t=this.decoder.GetMetadata(e);return this._getDracoMetadata(t)}_getAttributeMetadata(e,t){const r=this.decoder.GetAttributeMetadata(e,t);return this._getDracoMetadata(r)}_getDracoMetadata(e){if(!e||!e.ptr)return{};const t={},r=this.metadataQuerier.NumEntries(e);for(let a=0;a<r;a++){const h=this.metadataQuerier.GetEntryName(e,a);t[h]=this._getDracoMetadataField(e,h)}return t}_getDracoMetadataField(e,t){const r=new this.draco.DracoInt32Array;try{this.metadataQuerier.GetIntEntryArray(e,t,r);const a=nX(r);return{int:this.metadataQuerier.GetIntEntry(e,t),string:this.metadataQuerier.GetStringEntry(e,t),double:this.metadataQuerier.GetDoubleEntry(e,t),intArray:a}}finally{this.draco.destroy(r)}}_disableAttributeTransforms(e){const{quantizedAttributes:t=[],octahedronAttributes:r=[]}=e,a=[...t,...r];for(const h of a)this.decoder.SkipAttributeTransform(this.draco[h])}_getQuantizationTransform(e,t){const{quantizedAttributes:r=[]}=t,a=e.attribute_type();if(r.map(y=>this.decoder[y]).includes(a)){const y=new this.draco.AttributeQuantizationTransform;try{if(y.InitFromAttribute(e))return{quantization_bits:y.quantization_bits(),range:y.range(),min_values:new Float32Array([1,2,3]).map(s=>y.min_value(s))}}finally{this.draco.destroy(y)}}return null}_getOctahedronTransform(e,t){const{octahedronAttributes:r=[]}=t,a=e.attribute_type();if(r.map(y=>this.decoder[y]).includes(a)){const y=new this.draco.AttributeQuantizationTransform;try{if(y.InitFromAttribute(e))return{quantization_bits:y.quantization_bits()}}finally{this.draco.destroy(y)}}return null}}function rX(i,e){switch(e){case Float32Array:return i.DT_FLOAT32;case Int8Array:return i.DT_INT8;case Int16Array:return i.DT_INT16;case Int32Array:return i.DT_INT32;case Uint8Array:return i.DT_UINT8;case Uint16Array:return i.DT_UINT16;case Uint32Array:return i.DT_UINT32;default:return i.DT_INVALID}}function nX(i){const e=i.size(),t=new Int32Array(e);for(let r=0;r<e;r++)t[r]=i.GetValue(r);return t}function sX(i){const e=i.size(),t=new Int32Array(e);for(let r=0;r<e;r++)t[r]=i.GetValue(r);return t}const oX="1.5.6",aX="1.4.1",vb=`https://www.gstatic.com/draco/versioned/decoders/${oX}`,Ms={DECODER:"draco_wasm_wrapper.js",DECODER_WASM:"draco_decoder.wasm",FALLBACK_DECODER:"draco_decoder.js",ENCODER:"draco_encoder.js"},xb={[Ms.DECODER]:`${vb}/${Ms.DECODER}`,[Ms.DECODER_WASM]:`${vb}/${Ms.DECODER_WASM}`,[Ms.FALLBACK_DECODER]:`${vb}/${Ms.FALLBACK_DECODER}`,[Ms.ENCODER]:`https://raw.githubusercontent.com/google/draco/${aX}/javascript/${Ms.ENCODER}`};let bb;async function lX(i){const e=i.modules||{};return e.draco3d?bb||(bb=e.draco3d.createDecoderModule({}).then(t=>({draco:t}))):bb||(bb=cX(i)),await bb}async function cX(i){let e,t;switch(i.draco&&i.draco.decoderType){case"js":e=await bu(xb[Ms.FALLBACK_DECODER],"draco",i,Ms.FALLBACK_DECODER);break;case"wasm":default:[e,t]=await Promise.all([await bu(xb[Ms.DECODER],"draco",i,Ms.DECODER),await bu(xb[Ms.DECODER_WASM],"draco",i,Ms.DECODER_WASM)])}return e=e||globalThis.DracoDecoderModule,await uX(e,t)}function uX(i,e){const t={};return e&&(t.wasmBinary=e),new Promise(r=>{i({...t,onModuleLoaded:a=>r({draco:a})})})}const hX={...Kq,parse:dX};async function dX(i,e){const{draco:t}=await lX(e),r=new iX(t);try{return r.parseSync(i,e==null?void 0:e.draco)}finally{r.destroy()}}function fX(i){const e={};for(const t in i){const r=i[t];if(t!=="indices"){const a=xB(r);e[t]=a}}return e}function xB(i){const{buffer:e,size:t,count:r}=pX(i);return{value:e,size:t,byteOffset:0,count:r,type:uB(t),componentType:x0(e)}}function pX(i){let e=i,t=1,r=0;return i&&i.value&&(e=i.value,t=i.size||1),e&&(ArrayBuffer.isView(e)||(e=mX(e,Float32Array)),r=e.length/t),{buffer:e,size:t,count:r}}function mX(i,e,t=!1){return i?Array.isArray(i)?new e(i):t&&!(i instanceof e)?new e(i):i:null}const lc="KHR_draco_mesh_compression",_X=lc;function gX(i,e,t){const r=new Fn(i);for(const a of bB(r))r.getObjectExtension(a,lc)}async function yX(i,e,t){var h;if(!((h=e==null?void 0:e.gltf)!=null&&h.decompressMeshes))return;const r=new Fn(i),a=[];for(const y of bB(r))r.getObjectExtension(y,lc)&&a.push(xX(r,y,e,t));await Promise.all(a),r.removeExtension(lc)}function vX(i,e={}){const t=new Fn(i);for(const r of t.json.meshes||[])bX(r),t.addRequiredExtension(lc)}async function xX(i,e,t,r){const a=i.getObjectExtension(e,lc);if(!a)return;const h=i.getTypedArrayForBufferView(a.bufferView),y=MM(h.buffer,h.byteOffset),s={...t};delete s["3d-tiles"];const T=await bM(y,hX,s,r),B=fX(T.attributes);for(const[F,V]of Object.entries(B))if(F in e.attributes){const X=e.attributes[F],se=i.getAccessor(X);se!=null&&se.min&&(se!=null&&se.max)&&(V.min=se.min,V.max=se.max)}e.attributes=B,T.indices&&(e.indices=xB(T.indices)),i.removeObjectExtension(e,lc),wX(e)}function bX(i,e,t=4,r,a){var F;if(!r.DracoWriter)throw new Error("options.gltf.DracoWriter not provided");const h=r.DracoWriter.encodeSync({attributes:i}),y=(F=a==null?void 0:a.parseSync)==null?void 0:F.call(a,{attributes:i}),s=r._addFauxAttributes(y.attributes),T=r.addBufferView(h);return{primitives:[{attributes:s,mode:t,extensions:{[lc]:{bufferView:T,attributes:s}}}]}}function wX(i){if(!i.attributes&&Object.keys(i.attributes).length>0)throw new Error("glTF: Empty primitive detected: Draco decompression failure?")}function*bB(i){for(const e of i.json.meshes||[])for(const t of e.primitives)yield t}const AX=Object.freeze(Object.defineProperty({__proto__:null,decode:yX,encode:vX,name:_X,preprocess:gX},Symbol.toStringTag,{value:"Module"})),A0="KHR_texture_transform",TX=A0,jg=new Wn,EX=new km,SX=new km;async function IX(i,e){var h;if(!new Fn(i).hasExtension(A0)||!((h=e.gltf)!=null&&h.loadBuffers))return;const a=i.json.materials||[];for(let y=0;y<a.length;y++)CX(y,i)}function CX(i,e){var h,y,s,T;const t=(h=e.json.materials)==null?void 0:h[i],r=[(y=t==null?void 0:t.pbrMetallicRoughness)==null?void 0:y.baseColorTexture,t==null?void 0:t.emissiveTexture,t==null?void 0:t.normalTexture,t==null?void 0:t.occlusionTexture,(s=t==null?void 0:t.pbrMetallicRoughness)==null?void 0:s.metallicRoughnessTexture],a=[];for(const B of r)B&&((T=B==null?void 0:B.extensions)!=null&&T[A0])&&MX(e,i,B,a)}function MX(i,e,t,r){const a=RX(t,r);if(!a)return;const h=i.json.meshes||[];for(const y of h)for(const s of y.primitives){const T=s.material;Number.isFinite(T)&&e===T&&PX(i,s,a)}}function RX(i,e){var y;const t=(y=i.extensions)==null?void 0:y[A0],{texCoord:r=0}=i,{texCoord:a=r}=t;if(!(e.findIndex(([s,T])=>s===r&&T===a)!==-1)){const s=OX(t);return r!==a&&(i.texCoord=a),e.push([r,a]),{originalTexCoord:r,texCoord:a,matrix:s}}return null}function PX(i,e,t){var s,T;const{originalTexCoord:r,texCoord:a,matrix:h}=t,y=e.attributes[`TEXCOORD_${r}`];if(Number.isFinite(y)){const B=(s=i.json.accessors)==null?void 0:s[y];if(B&&B.bufferView){const F=(T=i.json.bufferViews)==null?void 0:T[B.bufferView];if(F){const{arrayBuffer:V,byteOffset:X}=i.buffers[F.buffer],se=(X||0)+(B.byteOffset||0)+(F.byteOffset||0),{ArrayType:ne,length:K}=vA(B,F),ue=cB[B.componentType],_e=lB[B.type],ke=F.byteStride||ue*_e,we=new Float32Array(K);for(let ge=0;ge<B.count;ge++){const Le=new ne(V,se+ge*ke,2);jg.set(Le[0],Le[1],1),jg.transformByMatrix3(h),we.set([jg[0],jg[1]],ge*_e)}r===a?BX(B,F,i.buffers,we):DX(a,B,e,i,we)}}}}function BX(i,e,t,r){i.componentType=5126,t.push({arrayBuffer:r.buffer,byteOffset:0,byteLength:r.buffer.byteLength}),e.buffer=t.length-1,e.byteLength=r.buffer.byteLength,e.byteOffset=0,delete e.byteStride}function DX(i,e,t,r,a){r.buffers.push({arrayBuffer:a.buffer,byteOffset:0,byteLength:a.buffer.byteLength});const h=r.json.bufferViews;if(!h)return;h.push({buffer:r.buffers.length-1,byteLength:a.buffer.byteLength,byteOffset:0});const y=r.json.accessors;y&&(y.push({bufferView:(h==null?void 0:h.length)-1,byteOffset:0,componentType:5126,count:e.count,type:"VEC2"}),t.attributes[`TEXCOORD_${i}`]=y.length-1)}function OX(i){const{offset:e=[0,0],rotation:t=0,scale:r=[1,1]}=i,a=new km().set(1,0,0,0,1,0,e[0],e[1],1),h=EX.set(Math.cos(t),Math.sin(t),0,-Math.sin(t),Math.cos(t),0,0,0,1),y=SX.set(r[0],0,0,0,r[1],0,0,0,1);return a.multiplyRight(h).multiplyRight(y)}const FX=Object.freeze(Object.defineProperty({__proto__:null,decode:IX,name:TX},Symbol.toStringTag,{value:"Module"})),xu="KHR_lights_punctual",kX=xu;async function LX(i){const e=new Fn(i),{json:t}=e,r=e.getExtension(xu);r&&(e.json.lights=r.lights,e.removeExtension(xu));for(const a of t.nodes||[]){const h=e.getObjectExtension(a,xu);h&&(a.light=h.light),e.removeObjectExtension(a,xu)}}async function NX(i){const e=new Fn(i),{json:t}=e;if(t.lights){const r=e.addExtension(xu);Gs(!r.lights),r.lights=t.lights,delete t.lights}if(e.json.lights){for(const r of e.json.lights){const a=r.node;e.addObjectExtension(a,xu,r)}delete e.json.lights}}const zX=Object.freeze(Object.defineProperty({__proto__:null,decode:LX,encode:NX,name:kX},Symbol.toStringTag,{value:"Module"})),Sm="KHR_materials_unlit",UX=Sm;async function VX(i){const e=new Fn(i),{json:t}=e;for(const r of t.materials||[])r.extensions&&r.extensions.KHR_materials_unlit&&(r.unlit=!0),e.removeObjectExtension(r,Sm);e.removeExtension(Sm)}function jX(i){const e=new Fn(i),{json:t}=e;if(e.materials)for(const r of t.materials||[])r.unlit&&(delete r.unlit,e.addObjectExtension(r,Sm,{}),e.addExtension(Sm))}const HX=Object.freeze(Object.defineProperty({__proto__:null,decode:VX,encode:jX,name:UX},Symbol.toStringTag,{value:"Module"})),$p="KHR_techniques_webgl",GX=$p;async function $X(i){const e=new Fn(i),{json:t}=e,r=e.getExtension($p);if(r){const a=qX(r,e);for(const h of t.materials||[]){const y=e.getObjectExtension(h,$p);y&&(h.technique=Object.assign({},y,a[y.technique]),h.technique.values=XX(h.technique,e)),e.removeObjectExtension(h,$p)}e.removeExtension($p)}}async function WX(i,e){}function qX(i,e){const{programs:t=[],shaders:r=[],techniques:a=[]}=i,h=new TextDecoder;return r.forEach(y=>{if(Number.isFinite(y.bufferView))y.code=h.decode(e.getTypedArrayForBufferView(y.bufferView));else throw new Error("KHR_techniques_webgl: no shader code")}),t.forEach(y=>{y.fragmentShader=r[y.fragmentShader],y.vertexShader=r[y.vertexShader]}),a.forEach(y=>{y.program=t[y.program]}),a}function XX(i,e){const t=Object.assign({},i.values);return Object.keys(i.uniforms||{}).forEach(r=>{i.uniforms[r].value&&!(r in t)&&(t[r]=i.uniforms[r].value)}),Object.keys(t).forEach(r=>{typeof t[r]=="object"&&t[r].index!==void 0&&(t[r].texture=e.getTexture(t[r].index))}),t}const ZX=Object.freeze(Object.defineProperty({__proto__:null,decode:$X,encode:WX,name:GX},Symbol.toStringTag,{value:"Module"})),wB=[QW,TW,Hq,Wq,Zq,AX,zX,HX,ZX,FX,_q];function YX(i,e={},t){var a;const r=wB.filter(h=>AB(h.name,e));for(const h of r)(a=h.preprocess)==null||a.call(h,i,e,t)}async function KX(i,e={},t){var a;const r=wB.filter(h=>AB(h.name,e));for(const h of r)await((a=h.decode)==null?void 0:a.call(h,i,e,t))}function AB(i,e){var a;const t=((a=e==null?void 0:e.gltf)==null?void 0:a.excludeExtensions)||{};return!(i in t&&!t[i])}const wb="KHR_binary_glTF";function JX(i){const e=new Fn(i),{json:t}=e;for(const r of t.images||[]){const a=e.getObjectExtension(r,wb);a&&Object.assign(r,a),e.removeObjectExtension(r,wb)}t.buffers&&t.buffers[0]&&delete t.buffers[0].uri,e.removeExtension(wb)}const LI={accessors:"accessor",animations:"animation",buffers:"buffer",bufferViews:"bufferView",images:"image",materials:"material",meshes:"mesh",nodes:"node",samplers:"sampler",scenes:"scene",skins:"skin",textures:"texture"},QX={accessor:"accessors",animations:"animation",buffer:"buffers",bufferView:"bufferViews",image:"images",material:"materials",mesh:"meshes",node:"nodes",sampler:"samplers",scene:"scenes",skin:"skins",texture:"textures"};class eZ{constructor(){pe(this,"idToIndexMap",{animations:{},accessors:{},buffers:{},bufferViews:{},images:{},materials:{},meshes:{},nodes:{},samplers:{},scenes:{},skins:{},textures:{}});pe(this,"json")}normalize(e,t){this.json=e.json;const r=e.json;switch(r.asset&&r.asset.version){case"2.0":return;case void 0:case"1.0":break;default:console.warn(`glTF: Unknown version ${r.asset.version}`);return}if(!t.normalize)throw new Error("glTF v1 is not supported.");console.warn("Converting glTF v1 to glTF v2 format. This is experimental and may fail."),this._addAsset(r),this._convertTopLevelObjectsToArrays(r),JX(e),this._convertObjectIdsToArrayIndices(r),this._updateObjects(r),this._updateMaterial(r)}_addAsset(e){e.asset=e.asset||{},e.asset.version="2.0",e.asset.generator=e.asset.generator||"Normalized to glTF 2.0 by loaders.gl"}_convertTopLevelObjectsToArrays(e){for(const t in LI)this._convertTopLevelObjectToArray(e,t)}_convertTopLevelObjectToArray(e,t){const r=e[t];if(!(!r||Array.isArray(r))){e[t]=[];for(const a in r){const h=r[a];h.id=h.id||a;const y=e[t].length;e[t].push(h),this.idToIndexMap[t][a]=y}}}_convertObjectIdsToArrayIndices(e){for(const t in LI)this._convertIdsToIndices(e,t);"scene"in e&&(e.scene=this._convertIdToIndex(e.scene,"scene"));for(const t of e.textures)this._convertTextureIds(t);for(const t of e.meshes)this._convertMeshIds(t);for(const t of e.nodes)this._convertNodeIds(t);for(const t of e.scenes)this._convertSceneIds(t)}_convertTextureIds(e){e.source&&(e.source=this._convertIdToIndex(e.source,"image"))}_convertMeshIds(e){for(const t of e.primitives){const{attributes:r,indices:a,material:h}=t;for(const y in r)r[y]=this._convertIdToIndex(r[y],"accessor");a&&(t.indices=this._convertIdToIndex(a,"accessor")),h&&(t.material=this._convertIdToIndex(h,"material"))}}_convertNodeIds(e){e.children&&(e.children=e.children.map(t=>this._convertIdToIndex(t,"node"))),e.meshes&&(e.meshes=e.meshes.map(t=>this._convertIdToIndex(t,"mesh")))}_convertSceneIds(e){e.nodes&&(e.nodes=e.nodes.map(t=>this._convertIdToIndex(t,"node")))}_convertIdsToIndices(e,t){e[t]||(console.warn(`gltf v1: json doesn't contain attribute ${t}`),e[t]=[]);for(const r of e[t])for(const a in r){const h=r[a],y=this._convertIdToIndex(h,a);r[a]=y}}_convertIdToIndex(e,t){const r=QX[t];if(r in this.idToIndexMap){const a=this.idToIndexMap[r][e];if(!Number.isFinite(a))throw new Error(`gltf v1: failed to resolve ${t} with id ${e}`);return a}return e}_updateObjects(e){for(const t of this.json.buffers)delete t.type}_updateMaterial(e){var t,r,a;for(const h of e.materials){h.pbrMetallicRoughness={baseColorFactor:[1,1,1,1],metallicFactor:1,roughnessFactor:1};const y=((t=h.values)==null?void 0:t.tex)||((r=h.values)==null?void 0:r.texture2d_0)||((a=h.values)==null?void 0:a.diffuseTex),s=e.textures.findIndex(T=>T.id===y);s!==-1&&(h.pbrMetallicRoughness.baseColorTexture={index:s})}}}function tZ(i,e={}){return new eZ().normalize(i,e)}async function iZ(i,e,t=0,r,a){var h,y,s;return rZ(i,e,t,r),tZ(i,{normalize:(h=r==null?void 0:r.gltf)==null?void 0:h.normalize}),YX(i,r,a),(y=r==null?void 0:r.gltf)!=null&&y.loadBuffers&&i.json.buffers&&await nZ(i,r,a),(s=r==null?void 0:r.gltf)!=null&&s.loadImages&&await sZ(i,r,a),await KX(i,r,a),i}function rZ(i,e,t,r){if(r.uri&&(i.baseUri=r.uri),e instanceof ArrayBuffer&&!Tq(e,t,r)&&(e=new TextDecoder().decode(e)),typeof e=="string")i.json=d4(e);else if(e instanceof ArrayBuffer){const y={};t=Eq(y,e,t,r.glb),Gs(y.type==="glTF",`Invalid GLB magic string ${y.type}`),i._glb=y,i.json=y.json}else Gs(!1,"GLTF: must be ArrayBuffer or string");const a=i.json.buffers||[];if(i.buffers=new Array(a.length).fill(null),i._glb&&i._glb.header.hasBinChunk){const{binChunks:y}=i._glb;i.buffers[0]={arrayBuffer:y[0].arrayBuffer,byteOffset:y[0].byteOffset,byteLength:y[0].byteLength}}const h=i.json.images||[];i.images=new Array(h.length).fill({})}async function nZ(i,e,t){var a,h;const r=i.json.buffers||[];for(let y=0;y<r.length;++y){const s=r[y];if(s.uri){const{fetch:T}=t;Gs(T);const B=yB(s.uri,e),F=await((a=t==null?void 0:t.fetch)==null?void 0:a.call(t,B)),V=await((h=F==null?void 0:F.arrayBuffer)==null?void 0:h.call(F));i.buffers[y]={arrayBuffer:V,byteOffset:0,byteLength:V.byteLength},delete s.uri}else i.buffers[y]===null&&(i.buffers[y]={arrayBuffer:new ArrayBuffer(s.byteLength),byteOffset:0,byteLength:s.byteLength})}}async function sZ(i,e,t){const r=oZ(i),a=i.json.images||[],h=[];for(const y of r)h.push(aZ(i,a[y],y,e,t));return await Promise.all(h)}function oZ(i){const e=new Set,t=i.json.textures||[];for(const r of t)r.source!==void 0&&e.add(r.source);return Array.from(e).sort()}async function aZ(i,e,t,r,a){let h;if(e.uri&&!e.hasOwnProperty("bufferView")){const s=yB(e.uri,r),{fetch:T}=a;h=await(await T(s)).arrayBuffer(),e.bufferView={data:h}}if(Number.isFinite(e.bufferView)){const s=cW(i.json,i.buffers,e.bufferView);h=MM(s.buffer,s.byteOffset,s.byteLength)}Gs(h,"glTF image has no data");let y=await bM(h,[qM,z7],{...r,mimeType:e.mimeType,basis:r.basis||{format:aB()}},a);y&&y[0]&&(y={compressed:!0,mipmaps:!1,width:y[0].width,height:y[0].height,data:y[0]}),i.images=i.images||[],i.images[t]=y}const mw={dataType:null,batchType:null,name:"glTF",id:"gltf",module:"gltf",version:gq,extensions:["gltf","glb"],mimeTypes:["model/gltf+json","model/gltf-binary"],text:!0,binary:!0,tests:["glTF"],parse:lZ,options:{gltf:{normalize:!0,loadBuffers:!0,loadImages:!0,decompressMeshes:!0},log:console}};async function lZ(i,e={},t){e={...mw.options,...e},e.gltf={...mw.options.gltf,...e.gltf};const{byteOffset:r=0}=e;return await iZ({},i,r,e,t)}const cZ={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},uZ={5120:1,5121:1,5122:2,5123:2,5125:4,5126:4},ho={TEXTURE_MAG_FILTER:10240,TEXTURE_MIN_FILTER:10241,TEXTURE_WRAP_S:10242,TEXTURE_WRAP_T:10243,REPEAT:10497,LINEAR:9729,NEAREST_MIPMAP_LINEAR:9986},hZ={magFilter:ho.TEXTURE_MAG_FILTER,minFilter:ho.TEXTURE_MIN_FILTER,wrapS:ho.TEXTURE_WRAP_S,wrapT:ho.TEXTURE_WRAP_T},dZ={[ho.TEXTURE_MAG_FILTER]:ho.LINEAR,[ho.TEXTURE_MIN_FILTER]:ho.NEAREST_MIPMAP_LINEAR,[ho.TEXTURE_WRAP_S]:ho.REPEAT,[ho.TEXTURE_WRAP_T]:ho.REPEAT};function fZ(){return{id:"default-sampler",parameters:dZ}}function pZ(i){return uZ[i]}function mZ(i){return cZ[i]}class _Z{constructor(){pe(this,"baseUri","");pe(this,"jsonUnprocessed");pe(this,"json");pe(this,"buffers",[]);pe(this,"images",[])}postProcess(e,t={}){const{json:r,buffers:a=[],images:h=[]}=e,{baseUri:y=""}=e;return Gs(r),this.baseUri=y,this.buffers=a,this.images=h,this.jsonUnprocessed=r,this.json=this._resolveTree(e.json,t),this.json}_resolveTree(e,t={}){const r={...e};return this.json=r,e.bufferViews&&(r.bufferViews=e.bufferViews.map((a,h)=>this._resolveBufferView(a,h))),e.images&&(r.images=e.images.map((a,h)=>this._resolveImage(a,h))),e.samplers&&(r.samplers=e.samplers.map((a,h)=>this._resolveSampler(a,h))),e.textures&&(r.textures=e.textures.map((a,h)=>this._resolveTexture(a,h))),e.accessors&&(r.accessors=e.accessors.map((a,h)=>this._resolveAccessor(a,h))),e.materials&&(r.materials=e.materials.map((a,h)=>this._resolveMaterial(a,h))),e.meshes&&(r.meshes=e.meshes.map((a,h)=>this._resolveMesh(a,h))),e.nodes&&(r.nodes=e.nodes.map((a,h)=>this._resolveNode(a,h)),r.nodes=r.nodes.map((a,h)=>this._resolveNodeChildren(a))),e.skins&&(r.skins=e.skins.map((a,h)=>this._resolveSkin(a,h))),e.scenes&&(r.scenes=e.scenes.map((a,h)=>this._resolveScene(a,h))),typeof this.json.scene=="number"&&r.scenes&&(r.scene=r.scenes[this.json.scene]),r}getScene(e){return this._get(this.json.scenes,e)}getNode(e){return this._get(this.json.nodes,e)}getSkin(e){return this._get(this.json.skins,e)}getMesh(e){return this._get(this.json.meshes,e)}getMaterial(e){return this._get(this.json.materials,e)}getAccessor(e){return this._get(this.json.accessors,e)}getCamera(e){return this._get(this.json.cameras,e)}getTexture(e){return this._get(this.json.textures,e)}getSampler(e){return this._get(this.json.samplers,e)}getImage(e){return this._get(this.json.images,e)}getBufferView(e){return this._get(this.json.bufferViews,e)}getBuffer(e){return this._get(this.json.buffers,e)}_get(e,t){if(typeof t=="object")return t;const r=e&&e[t];return r||console.warn(`glTF file error: Could not find ${e}[${t}]`),r}_resolveScene(e,t){return{...e,id:e.id||`scene-${t}`,nodes:(e.nodes||[]).map(r=>this.getNode(r))}}_resolveNode(e,t){const r={...e,id:(e==null?void 0:e.id)||`node-${t}`};return e.mesh!==void 0&&(r.mesh=this.getMesh(e.mesh)),e.camera!==void 0&&(r.camera=this.getCamera(e.camera)),e.skin!==void 0&&(r.skin=this.getSkin(e.skin)),e.meshes!==void 0&&e.meshes.length&&(r.mesh=e.meshes.reduce((a,h)=>{const y=this.getMesh(h);return a.id=y.id,a.primitives=a.primitives.concat(y.primitives),a},{primitives:[]})),r}_resolveNodeChildren(e){return e.children&&(e.children=e.children.map(t=>this.getNode(t))),e}_resolveSkin(e,t){const r=typeof e.inverseBindMatrices=="number"?this.getAccessor(e.inverseBindMatrices):void 0;return{...e,id:e.id||`skin-${t}`,inverseBindMatrices:r}}_resolveMesh(e,t){const r={...e,id:e.id||`mesh-${t}`,primitives:[]};return e.primitives&&(r.primitives=e.primitives.map(a=>{const h={...a,attributes:{},indices:void 0,material:void 0},y=a.attributes;for(const s in y)h.attributes[s]=this.getAccessor(y[s]);return a.indices!==void 0&&(h.indices=this.getAccessor(a.indices)),a.material!==void 0&&(h.material=this.getMaterial(a.material)),h})),r}_resolveMaterial(e,t){const r={...e,id:e.id||`material-${t}`};if(r.normalTexture&&(r.normalTexture={...r.normalTexture},r.normalTexture.texture=this.getTexture(r.normalTexture.index)),r.occlusionTexture&&(r.occlusionTexture={...r.occlusionTexture},r.occlusionTexture.texture=this.getTexture(r.occlusionTexture.index)),r.emissiveTexture&&(r.emissiveTexture={...r.emissiveTexture},r.emissiveTexture.texture=this.getTexture(r.emissiveTexture.index)),r.emissiveFactor||(r.emissiveFactor=r.emissiveTexture?[1,1,1]:[0,0,0]),r.pbrMetallicRoughness){r.pbrMetallicRoughness={...r.pbrMetallicRoughness};const a=r.pbrMetallicRoughness;a.baseColorTexture&&(a.baseColorTexture={...a.baseColorTexture},a.baseColorTexture.texture=this.getTexture(a.baseColorTexture.index)),a.metallicRoughnessTexture&&(a.metallicRoughnessTexture={...a.metallicRoughnessTexture},a.metallicRoughnessTexture.texture=this.getTexture(a.metallicRoughnessTexture.index))}return r}_resolveAccessor(e,t){const r=pZ(e.componentType),a=mZ(e.type),h=r*a,y={...e,id:e.id||`accessor-${t}`,bytesPerComponent:r,components:a,bytesPerElement:h,value:void 0,bufferView:void 0,sparse:void 0};if(e.bufferView!==void 0&&(y.bufferView=this.getBufferView(e.bufferView)),y.bufferView){const s=y.bufferView.buffer,{ArrayType:T,byteLength:B}=vA(y,y.bufferView),F=(y.bufferView.byteOffset||0)+(y.byteOffset||0)+s.byteOffset;let V=s.arrayBuffer.slice(F,F+B);y.bufferView.byteStride&&(V=this._getValueFromInterleavedBuffer(s,F,y.bufferView.byteStride,y.bytesPerElement,y.count)),y.value=new T(V)}return y}_getValueFromInterleavedBuffer(e,t,r,a,h){const y=new Uint8Array(h*a);for(let s=0;s<h;s++){const T=t+s*r;y.set(new Uint8Array(e.arrayBuffer.slice(T,T+a)),s*a)}return y.buffer}_resolveTexture(e,t){return{...e,id:e.id||`texture-${t}`,sampler:typeof e.sampler=="number"?this.getSampler(e.sampler):fZ(),source:typeof e.source=="number"?this.getImage(e.source):void 0}}_resolveSampler(e,t){const r={id:e.id||`sampler-${t}`,...e,parameters:{}};for(const a in r){const h=this._enumSamplerParameter(a);h!==void 0&&(r.parameters[h]=r[a])}return r}_enumSamplerParameter(e){return hZ[e]}_resolveImage(e,t){const r={...e,id:e.id||`image-${t}`,image:null,bufferView:e.bufferView!==void 0?this.getBufferView(e.bufferView):void 0},a=this.images[t];return a&&(r.image=a),r}_resolveBufferView(e,t){const r=e.buffer,a=this.buffers[r].arrayBuffer;let h=this.buffers[r].byteOffset||0;return e.byteOffset&&(h+=e.byteOffset),{id:`bufferView-${t}`,...e,buffer:this.buffers[r],data:new Uint8Array(a,h,e.byteLength)}}_resolveCamera(e,t){const r={...e,id:e.id||`camera-${t}`};return r.perspective,r.orthographic,r}}function gZ(i,e){return new _Z().postProcess(i,e)}async function yZ(i){const e=[];return i.scenes.forEach(t=>{t.traverse(r=>{Object.values(r.model.uniforms).forEach(a=>{a.loaded===!1&&e.push(a)})})}),await vZ(()=>e.some(t=>!t.loaded))}async function vZ(i){for(;i();)await new Promise(e=>requestAnimationFrame(e))}const NI=`uniform scenegraphUniforms {
  float sizeScale;
  float sizeMinPixels;
  float sizeMaxPixels;
  mat4 sceneModelMatrix;
  bool composeModelMatrix;
} scenegraph;
`,xZ={name:"scenegraph",vs:NI,fs:NI,uniformTypes:{sizeScale:"f32",sizeMinPixels:"f32",sizeMaxPixels:"f32",sceneModelMatrix:"mat4x4<f32>",composeModelMatrix:"f32"}},bZ=`#version 300 es
#define SHADER_NAME scenegraph-layer-vertex-shader
in vec3 instancePositions;
in vec3 instancePositions64Low;
in vec4 instanceColors;
in vec3 instancePickingColors;
in vec3 instanceModelMatrixCol0;
in vec3 instanceModelMatrixCol1;
in vec3 instanceModelMatrixCol2;
in vec3 instanceTranslation;
in vec3 positions;
#ifdef HAS_UV
in vec2 texCoords;
#endif
#ifdef LIGHTING_PBR
#ifdef HAS_NORMALS
in vec3 normals;
#endif
#endif
out vec4 vColor;
#ifndef LIGHTING_PBR
#ifdef HAS_UV
out vec2 vTEXCOORD_0;
#endif
#endif
void main(void) {
#if defined(HAS_UV) && !defined(LIGHTING_PBR)
vTEXCOORD_0 = texCoords;
geometry.uv = texCoords;
#endif
geometry.worldPosition = instancePositions;
geometry.pickingColor = instancePickingColors;
mat3 instanceModelMatrix = mat3(instanceModelMatrixCol0, instanceModelMatrixCol1, instanceModelMatrixCol2);
vec3 normal = vec3(0.0, 0.0, 1.0);
#ifdef LIGHTING_PBR
#ifdef HAS_NORMALS
normal = instanceModelMatrix * (scenegraph.sceneModelMatrix * vec4(normals, 0.0)).xyz;
#endif
#endif
float originalSize = project_size_to_pixel(scenegraph.sizeScale);
float clampedSize = clamp(originalSize, scenegraph.sizeMinPixels, scenegraph.sizeMaxPixels);
vec3 pos = (instanceModelMatrix * (scenegraph.sceneModelMatrix * vec4(positions, 1.0)).xyz) * scenegraph.sizeScale * (clampedSize / originalSize) + instanceTranslation;
if(scenegraph.composeModelMatrix) {
DECKGL_FILTER_SIZE(pos, geometry);
geometry.normal = project_normal(normal);
geometry.worldPosition += pos;
gl_Position = project_position_to_clipspace(pos + instancePositions, instancePositions64Low, vec3(0.0), geometry.position);
}
else {
pos = project_size(pos);
DECKGL_FILTER_SIZE(pos, geometry);
gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, pos, geometry.position);
geometry.normal = project_normal(normal);
}
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
#ifdef LIGHTING_PBR
pbr_vPosition = geometry.position.xyz;
#ifdef HAS_NORMALS
pbr_vNormal = geometry.normal;
#endif
#ifdef HAS_UV
pbr_vUV = texCoords;
#else
pbr_vUV = vec2(0., 0.);
#endif
geometry.uv = pbr_vUV;
#endif
vColor = instanceColors;
DECKGL_FILTER_COLOR(vColor, geometry);
}
`,wZ=`#version 300 es
#define SHADER_NAME scenegraph-layer-fragment-shader
in vec4 vColor;
out vec4 fragColor;
#ifndef LIGHTING_PBR
#if defined(HAS_UV) && defined(HAS_BASECOLORMAP)
in vec2 vTEXCOORD_0;
uniform sampler2D pbr_baseColorSampler;
#endif
#endif
void main(void) {
#ifdef LIGHTING_PBR
fragColor = vColor * pbr_filterColor(vec4(0));
geometry.uv = pbr_vUV;
#else
#if defined(HAS_UV) && defined(HAS_BASECOLORMAP)
fragColor = vColor * texture(pbr_baseColorSampler, vTEXCOORD_0);
geometry.uv = vTEXCOORD_0;
#else
fragColor = vColor;
#endif
#endif
fragColor.a *= layer.opacity;
DECKGL_FILTER_COLOR(fragColor, geometry);
}
`,TB=[255,255,255,255],AZ={scenegraph:{type:"object",value:null,async:!0},getScene:i=>i&&i.scenes?typeof i.scene=="object"?i.scene:i.scenes[i.scene||0]:i,getAnimator:i=>i&&i.animator,_animations:null,sizeScale:{type:"number",value:1,min:0},sizeMinPixels:{type:"number",min:0,value:0},sizeMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},getPosition:{type:"accessor",value:i=>i.position},getColor:{type:"accessor",value:TB},_lighting:"flat",_imageBasedLightingEnvironment:void 0,getOrientation:{type:"accessor",value:[0,0,0]},getScale:{type:"accessor",value:[1,1,1]},getTranslation:{type:"accessor",value:[0,0,0]},getTransformMatrix:{type:"accessor",value:[]},loaders:[mw]};class TA extends gA{getShaders(){const e={};let t;this.props._lighting==="pbr"?(t=JR,e.LIGHTING_PBR=1):t={name:"pbrMaterial"};const r=[y8,j8,xZ,t];return super.getShaders({defines:e,vs:bZ,fs:wZ,modules:r})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:3,type:"float64",fp64:this.use64bitPositions(),accessor:"getPosition",transition:!0},instanceColors:{type:"unorm8",size:this.props.colorFormat.length,accessor:"getColor",defaultValue:TB,transition:!0},instanceModelMatrix:x7})}updateState(e){super.updateState(e);const{props:t,oldProps:r}=e;t.scenegraph!==r.scenegraph?this._updateScenegraph():t._animations!==r._animations&&this._applyAnimationsProp(this.state.animator,t._animations)}finalizeState(e){var t;super.finalizeState(e),(t=this.state.scenegraph)==null||t.destroy()}get isLoaded(){var e;return!!((e=this.state)!=null&&e.scenegraph&&super.isLoaded)}_updateScenegraph(){var s;const e=this.props,{device:t}=this.context;let r=null;if(e.scenegraph instanceof Fy)r={scenes:[e.scenegraph]};else if(e.scenegraph&&typeof e.scenegraph=="object"){const T=e.scenegraph,B=T.json?gZ(T):T,F=rW(t,B,this._getModelOptions());r={gltf:B,...F},yZ(F).then(()=>{this.setNeedsRedraw()}).catch(V=>{this.raiseError(V,"loading glTF")})}const a={layer:this,device:this.context.device},h=e.getScene(r,a),y=e.getAnimator(r,a);if(h instanceof _d){(s=this.state.scenegraph)==null||s.destroy(),this._applyAnimationsProp(y,e._animations);const T=[];h.traverse(B=>{B instanceof tw&&T.push(B.model)}),this.setState({scenegraph:h,animator:y,models:T}),this.getAttributeManager().invalidateAll()}else h!==null&&gr.warn("invalid scenegraph:",h)()}_applyAnimationsProp(e,t){if(!e||!t)return;const r=e.getAnimations();Object.keys(t).sort().forEach(a=>{const h=t[a];if(a==="*")r.forEach(y=>{Object.assign(y,h)});else if(Number.isFinite(Number(a))){const y=Number(a);y>=0&&y<r.length?Object.assign(r[y],h):gr.warn(`animation ${a} not found`)()}else{const y=r.find(({name:s})=>s===a);y?Object.assign(y,h):gr.warn(`animation ${a} not found`)()}})}_getModelOptions(){const{_imageBasedLightingEnvironment:e}=this.props;let t;return e&&(typeof e=="function"?t=e({gl:this.context.gl,layer:this}):t=e),{imageBasedLightingEnvironment:t,modelOptions:{id:this.props.id,isInstanced:!0,bufferLayout:this.getAttributeManager().getBufferLayouts(),...this.getShaders()},useTangents:!1}}draw({context:e}){if(!this.state.scenegraph)return;this.props._animations&&this.state.animator&&(this.state.animator.animate(e.timeline.getTime()),this.setNeedsRedraw());const{viewport:t,renderPass:r}=this.context,{sizeScale:a,sizeMinPixels:h,sizeMaxPixels:y,coordinateSystem:s}=this.props,T=this.getNumInstances();this.state.scenegraph.traverse((B,{worldMatrix:F})=>{if(B instanceof tw){const{model:V}=B;V.setInstanceCount(T);const X={camera:V.uniforms.cameraPosition},se={sizeScale:a,sizeMinPixels:h,sizeMaxPixels:y,composeModelMatrix:b7(t,s),sceneModelMatrix:F};V.shaderInputs.setProps({pbrProjection:X,scenegraph:se}),V.draw(r)}})}}TA.defaultProps=AZ;TA.layerName="ScenegraphLayer";var Ab,zI;function Pd(){if(zI)return Ab;zI=1,Ab=e;var i=Object.prototype.hasOwnProperty;function e(){for(var t={},r=0;r<arguments.length;r++){var a=arguments[r];for(var h in a)i.call(a,h)&&(t[h]=a[h])}return t}return Ab}var Tb={exports:{}},UI;function TZ(){return UI||(UI=1,function(i,e){(function(){var t={};i.exports=t,t.simpleFilter=function(r,a){return a.filter(function(h){return t.test(r,h)})},t.test=function(r,a){return t.match(r,a)!==null},t.match=function(r,a,h){h=h||{};var y=0,s=[],T=a.length,B=0,F=0,V=h.pre||"",X=h.post||"",se=h.caseSensitive&&a||a.toLowerCase(),ne;r=h.caseSensitive&&r||r.toLowerCase();for(var K=0;K<T;K++)ne=a[K],se[K]===r[y]?(ne=V+ne+X,y+=1,F+=1+F):F=0,B+=F,s[s.length]=ne;return y===r.length?(B=se===r?1/0:B,{rendered:s.join(""),score:B}):null},t.filter=function(r,a,h){return!a||a.length===0?[]:typeof r!="string"?a:(h=h||{},a.reduce(function(y,s,T,B){var F=s;h.extract&&(F=h.extract(s));var V=t.match(r,F,h);return V!=null&&(y[y.length]={string:V.rendered,score:V.score,index:T,original:s}),y},[]).sort(function(y,s){var T=s.score-y.score;return T||y.index-s.index}))}})()}(Tb)),Tb.exports}var Eb,VI;function EZ(){if(VI)return Eb;VI=1;var i=function(e){return this.component=e,this.items=[],this.active=0,this.wrapper=document.createElement("div"),this.wrapper.className="suggestions-wrapper",this.element=document.createElement("ul"),this.element.className="suggestions",this.wrapper.appendChild(this.element),this.selectingListItem=!1,e.el.parentNode.insertBefore(this.wrapper,e.el.nextSibling),this};return i.prototype.show=function(){this.element.style.display="block"},i.prototype.hide=function(){this.element.style.display="none"},i.prototype.add=function(e){this.items.push(e)},i.prototype.clear=function(){this.items=[],this.active=0},i.prototype.isEmpty=function(){return!this.items.length},i.prototype.isVisible=function(){return this.element.style.display==="block"},i.prototype.draw=function(){if(this.element.innerHTML="",this.items.length===0){this.hide();return}for(var e=0;e<this.items.length;e++)this.drawItem(this.items[e],this.active===e);this.show()},i.prototype.drawItem=function(e,t){var r=document.createElement("li"),a=document.createElement("a");t&&(r.className+=" active"),a.innerHTML=e.string,r.appendChild(a),this.element.appendChild(r),r.addEventListener("mousedown",(function(){this.selectingListItem=!0}).bind(this)),r.addEventListener("mouseup",(function(){this.handleMouseUp.call(this,e)}).bind(this))},i.prototype.handleMouseUp=function(e){this.selectingListItem=!1,this.component.value(e.original),this.clear(),this.draw()},i.prototype.move=function(e){this.active=e,this.draw()},i.prototype.previous=function(){this.move(this.active===0?this.items.length-1:this.active-1)},i.prototype.next=function(){this.move(this.active===this.items.length-1?0:this.active+1)},i.prototype.drawError=function(e){var t=document.createElement("li");t.innerHTML=e,this.element.appendChild(t),this.show()},Eb=i,Eb}var Sb,jI;function SZ(){if(jI)return Sb;jI=1;var i=Pd(),e=TZ(),t=EZ(),r=function(a,h,y){return y=y||{},this.options=i({minLength:2,limit:5,filter:!0,hideOnBlur:!0},y),this.el=a,this.data=h||[],this.list=new t(this),this.query="",this.selected=null,this.list.draw(),this.el.addEventListener("keyup",(function(s){this.handleKeyUp(s.keyCode)}).bind(this),!1),this.el.addEventListener("keydown",(function(s){this.handleKeyDown(s)}).bind(this)),this.el.addEventListener("focus",(function(){this.handleFocus()}).bind(this)),this.el.addEventListener("blur",(function(){this.handleBlur()}).bind(this)),this.el.addEventListener("paste",(function(s){this.handlePaste(s)}).bind(this)),this.render=this.options.render?this.options.render.bind(this):this.render.bind(this),this.getItemValue=this.options.getItemValue?this.options.getItemValue.bind(this):this.getItemValue.bind(this),this};return r.prototype.handleKeyUp=function(a){a===40||a===38||a===27||a===13||a===9||this.handleInputChange(this.el.value)},r.prototype.handleKeyDown=function(a){switch(a.keyCode){case 13:case 9:this.list.isEmpty()||(this.list.isVisible()&&a.preventDefault(),this.value(this.list.items[this.list.active].original),this.list.hide());break;case 27:this.list.isEmpty()||this.list.hide();break;case 38:this.list.previous();break;case 40:this.list.next();break}},r.prototype.handleBlur=function(){!this.list.selectingListItem&&this.options.hideOnBlur&&this.list.hide()},r.prototype.handlePaste=function(a){if(a.clipboardData)this.handleInputChange(a.clipboardData.getData("Text"));else{var h=this;setTimeout(function(){h.handleInputChange(a.target.value)},100)}},r.prototype.handleInputChange=function(a){if(this.query=this.normalize(a),this.list.clear(),this.query.length<this.options.minLength){this.list.draw();return}this.getCandidates((function(h){for(var y=0;y<h.length&&(this.list.add(h[y]),y!==this.options.limit-1);y++);this.list.draw()}).bind(this))},r.prototype.handleFocus=function(){this.list.isEmpty()||this.list.show(),this.list.selectingListItem=!1},r.prototype.update=function(a){this.data=a,this.handleKeyUp()},r.prototype.clear=function(){this.data=[],this.list.clear()},r.prototype.normalize=function(a){return a=a.toLowerCase(),a},r.prototype.match=function(a,h){return a.indexOf(h)>-1},r.prototype.value=function(a){if(this.selected=a,this.el.value=this.getItemValue(a),document.createEvent){var h=document.createEvent("HTMLEvents");h.initEvent("change",!0,!1),this.el.dispatchEvent(h)}else this.el.fireEvent("onchange")},r.prototype.getCandidates=function(a){var h={pre:"<strong>",post:"</strong>",extract:(function(s){return this.getItemValue(s)}).bind(this)},y;this.options.filter?(y=e.filter(this.query,this.data,h),y=y.map((function(s){return{original:s.original,string:this.render(s.original,s.string)}}).bind(this))):y=this.data.map((function(s){var T=this.render(s);return{original:s,string:T}}).bind(this)),a(y)},r.prototype.getItemValue=function(a){return a},r.prototype.render=function(a,h){if(h)return h;for(var y=a.original?this.getItemValue(a.original):this.getItemValue(a),s=this.normalize(y),T=s.lastIndexOf(this.query);T>-1;){var B=T+this.query.length;y=y.slice(0,T)+"<strong>"+y.slice(T,B)+"</strong>"+y.slice(B),T=s.slice(0,T).lastIndexOf(this.query)}return y},r.prototype.renderError=function(a){this.list.drawError(a)},Sb=r,Sb}var Ib,HI;function IZ(){if(HI)return Ib;HI=1;var i=SZ();return Ib=i,typeof window<"u"&&(window.Suggestions=i),Ib}var Cb,GI;function CZ(){if(GI)return Cb;GI=1;var i="Expected a function",e=NaN,t="[object Symbol]",r=/^\s+|\s+$/g,a=/^[-+]0x[0-9a-f]+$/i,h=/^0b[01]+$/i,y=/^0o[0-7]+$/i,s=parseInt,T=typeof ec=="object"&&ec&&ec.Object===Object&&ec,B=typeof self=="object"&&self&&self.Object===Object&&self,F=T||B||Function("return this")(),V=Object.prototype,X=V.toString,se=Math.max,ne=Math.min,K=function(){return F.Date.now()};function ue(Le,$e,Ye){var St,Pt,vt,yt,hi,Pi,Si=0,qt=!1,Br=!1,xr=!0;if(typeof Le!="function")throw new TypeError(i);$e=ge($e)||0,_e(Ye)&&(qt=!!Ye.leading,Br="maxWait"in Ye,vt=Br?se(ge(Ye.maxWait)||0,$e):vt,xr="trailing"in Ye?!!Ye.trailing:xr);function os(fr){var br=St,kn=Pt;return St=Pt=void 0,Si=fr,yt=Le.apply(kn,br),yt}function pi(fr){return Si=fr,hi=setTimeout(Kr,$e),qt?os(fr):yt}function mn(fr){var br=fr-Pi,kn=fr-Si,Re=$e-br;return Br?ne(Re,vt-kn):Re}function as(fr){var br=fr-Pi,kn=fr-Si;return Pi===void 0||br>=$e||br<0||Br&&kn>=vt}function Kr(){var fr=K();if(as(fr))return si(fr);hi=setTimeout(Kr,mn(fr))}function si(fr){return hi=void 0,xr&&St?os(fr):(St=Pt=void 0,yt)}function $s(){hi!==void 0&&clearTimeout(hi),Si=0,St=Pi=Pt=hi=void 0}function ls(){return hi===void 0?yt:si(K())}function cs(){var fr=K(),br=as(fr);if(St=arguments,Pt=this,Pi=fr,br){if(hi===void 0)return pi(Pi);if(Br)return hi=setTimeout(Kr,$e),os(Pi)}return hi===void 0&&(hi=setTimeout(Kr,$e)),yt}return cs.cancel=$s,cs.flush=ls,cs}function _e(Le){var $e=typeof Le;return!!Le&&($e=="object"||$e=="function")}function ke(Le){return!!Le&&typeof Le=="object"}function we(Le){return typeof Le=="symbol"||ke(Le)&&X.call(Le)==t}function ge(Le){if(typeof Le=="number")return Le;if(we(Le))return e;if(_e(Le)){var $e=typeof Le.valueOf=="function"?Le.valueOf():Le;Le=_e($e)?$e+"":$e}if(typeof Le!="string")return Le===0?Le:+Le;Le=Le.replace(r,"");var Ye=h.test(Le);return Ye||y.test(Le)?s(Le.slice(2),Ye?2:8):a.test(Le)?e:+Le}return Cb=ue,Cb}var Hg={exports:{}},$I;function MZ(){if($I)return Hg.exports;$I=1;var i=typeof Reflect=="object"?Reflect:null,e=i&&typeof i.apply=="function"?i.apply:function(Le,$e,Ye){return Function.prototype.apply.call(Le,$e,Ye)},t;i&&typeof i.ownKeys=="function"?t=i.ownKeys:Object.getOwnPropertySymbols?t=function(Le){return Object.getOwnPropertyNames(Le).concat(Object.getOwnPropertySymbols(Le))}:t=function(Le){return Object.getOwnPropertyNames(Le)};function r(ge){console&&console.warn&&console.warn(ge)}var a=Number.isNaN||function(Le){return Le!==Le};function h(){h.init.call(this)}Hg.exports=h,Hg.exports.once=_e,h.EventEmitter=h,h.prototype._events=void 0,h.prototype._eventsCount=0,h.prototype._maxListeners=void 0;var y=10;function s(ge){if(typeof ge!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof ge)}Object.defineProperty(h,"defaultMaxListeners",{enumerable:!0,get:function(){return y},set:function(ge){if(typeof ge!="number"||ge<0||a(ge))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+ge+".");y=ge}}),h.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},h.prototype.setMaxListeners=function(Le){if(typeof Le!="number"||Le<0||a(Le))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+Le+".");return this._maxListeners=Le,this};function T(ge){return ge._maxListeners===void 0?h.defaultMaxListeners:ge._maxListeners}h.prototype.getMaxListeners=function(){return T(this)},h.prototype.emit=function(Le){for(var $e=[],Ye=1;Ye<arguments.length;Ye++)$e.push(arguments[Ye]);var St=Le==="error",Pt=this._events;if(Pt!==void 0)St=St&&Pt.error===void 0;else if(!St)return!1;if(St){var vt;if($e.length>0&&(vt=$e[0]),vt instanceof Error)throw vt;var yt=new Error("Unhandled error."+(vt?" ("+vt.message+")":""));throw yt.context=vt,yt}var hi=Pt[Le];if(hi===void 0)return!1;if(typeof hi=="function")e(hi,this,$e);else for(var Pi=hi.length,Si=ne(hi,Pi),Ye=0;Ye<Pi;++Ye)e(Si[Ye],this,$e);return!0};function B(ge,Le,$e,Ye){var St,Pt,vt;if(s($e),Pt=ge._events,Pt===void 0?(Pt=ge._events=Object.create(null),ge._eventsCount=0):(Pt.newListener!==void 0&&(ge.emit("newListener",Le,$e.listener?$e.listener:$e),Pt=ge._events),vt=Pt[Le]),vt===void 0)vt=Pt[Le]=$e,++ge._eventsCount;else if(typeof vt=="function"?vt=Pt[Le]=Ye?[$e,vt]:[vt,$e]:Ye?vt.unshift($e):vt.push($e),St=T(ge),St>0&&vt.length>St&&!vt.warned){vt.warned=!0;var yt=new Error("Possible EventEmitter memory leak detected. "+vt.length+" "+String(Le)+" listeners added. Use emitter.setMaxListeners() to increase limit");yt.name="MaxListenersExceededWarning",yt.emitter=ge,yt.type=Le,yt.count=vt.length,r(yt)}return ge}h.prototype.addListener=function(Le,$e){return B(this,Le,$e,!1)},h.prototype.on=h.prototype.addListener,h.prototype.prependListener=function(Le,$e){return B(this,Le,$e,!0)};function F(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function V(ge,Le,$e){var Ye={fired:!1,wrapFn:void 0,target:ge,type:Le,listener:$e},St=F.bind(Ye);return St.listener=$e,Ye.wrapFn=St,St}h.prototype.once=function(Le,$e){return s($e),this.on(Le,V(this,Le,$e)),this},h.prototype.prependOnceListener=function(Le,$e){return s($e),this.prependListener(Le,V(this,Le,$e)),this},h.prototype.removeListener=function(Le,$e){var Ye,St,Pt,vt,yt;if(s($e),St=this._events,St===void 0)return this;if(Ye=St[Le],Ye===void 0)return this;if(Ye===$e||Ye.listener===$e)--this._eventsCount===0?this._events=Object.create(null):(delete St[Le],St.removeListener&&this.emit("removeListener",Le,Ye.listener||$e));else if(typeof Ye!="function"){for(Pt=-1,vt=Ye.length-1;vt>=0;vt--)if(Ye[vt]===$e||Ye[vt].listener===$e){yt=Ye[vt].listener,Pt=vt;break}if(Pt<0)return this;Pt===0?Ye.shift():K(Ye,Pt),Ye.length===1&&(St[Le]=Ye[0]),St.removeListener!==void 0&&this.emit("removeListener",Le,yt||$e)}return this},h.prototype.off=h.prototype.removeListener,h.prototype.removeAllListeners=function(Le){var $e,Ye,St;if(Ye=this._events,Ye===void 0)return this;if(Ye.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):Ye[Le]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete Ye[Le]),this;if(arguments.length===0){var Pt=Object.keys(Ye),vt;for(St=0;St<Pt.length;++St)vt=Pt[St],vt!=="removeListener"&&this.removeAllListeners(vt);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if($e=Ye[Le],typeof $e=="function")this.removeListener(Le,$e);else if($e!==void 0)for(St=$e.length-1;St>=0;St--)this.removeListener(Le,$e[St]);return this};function X(ge,Le,$e){var Ye=ge._events;if(Ye===void 0)return[];var St=Ye[Le];return St===void 0?[]:typeof St=="function"?$e?[St.listener||St]:[St]:$e?ue(St):ne(St,St.length)}h.prototype.listeners=function(Le){return X(this,Le,!0)},h.prototype.rawListeners=function(Le){return X(this,Le,!1)},h.listenerCount=function(ge,Le){return typeof ge.listenerCount=="function"?ge.listenerCount(Le):se.call(ge,Le)},h.prototype.listenerCount=se;function se(ge){var Le=this._events;if(Le!==void 0){var $e=Le[ge];if(typeof $e=="function")return 1;if($e!==void 0)return $e.length}return 0}h.prototype.eventNames=function(){return this._eventsCount>0?t(this._events):[]};function ne(ge,Le){for(var $e=new Array(Le),Ye=0;Ye<Le;++Ye)$e[Ye]=ge[Ye];return $e}function K(ge,Le){for(;Le+1<ge.length;Le++)ge[Le]=ge[Le+1];ge.pop()}function ue(ge){for(var Le=new Array(ge.length),$e=0;$e<Le.length;++$e)Le[$e]=ge[$e].listener||ge[$e];return Le}function _e(ge,Le){return new Promise(function($e,Ye){function St(vt){ge.removeListener(Le,Pt),Ye(vt)}function Pt(){typeof ge.removeListener=="function"&&ge.removeListener("error",St),$e([].slice.call(arguments))}we(ge,Le,Pt,{once:!0}),Le!=="error"&&ke(ge,St,{once:!0})})}function ke(ge,Le,$e){typeof ge.on=="function"&&we(ge,"error",Le,$e)}function we(ge,Le,$e,Ye){if(typeof ge.on=="function")Ye.once?ge.once(Le,$e):ge.on(Le,$e);else if(typeof ge.addEventListener=="function")ge.addEventListener(Le,function St(Pt){Ye.once&&ge.removeEventListener(Le,St),$e(Pt)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof ge)}return Hg.exports}var Mb,WI;function RZ(){return WI||(WI=1,Mb={fr:{name:"France",bbox:[[-4.59235,41.380007],[9.560016,51.148506]]},us:{name:"United States",bbox:[[-171.791111,18.91619],[-66.96466,71.357764]]},ru:{name:"Russia",bbox:[[19.66064,41.151416],[190.10042,81.2504]]},ca:{name:"Canada",bbox:[[-140.99778,41.675105],[-52.648099,83.23324]]}}),Mb}var Rb,qI;function PZ(){if(qI)return Rb;qI=1;function i(r){var a=r.match(/\s*(.+)\s*=\s*"?([^"]+)"?/);return a?{key:a[1],value:a[2]}:null}function e(r){var a=r.match(/<?([^>]*)>(.*)/);if(!a)return null;var h=a[1],y=a[2].split(";"),s=null,T=y.reduce(function(B,F){var V=i(F);return V?V.key==="rel"?(s||(s=V.value),B):(B[V.key]=V.value,B):B},{});return s?{url:h,rel:s,params:T}:null}function t(r){return r?r.split(/,\s*</).reduce(function(a,h){var y=e(h);if(!y)return a;var s=y.rel.split(/\s+/);return s.forEach(function(T){a[T]||(a[T]={url:y.url,params:y.params})}),a},{}):{}}return Rb=t,Rb}var Pb,XI;function BZ(){if(XI)return Pb;XI=1;var i=PZ();function e(t,r){this.request=t,this.headers=r.headers,this.rawBody=r.body,this.statusCode=r.statusCode;try{this.body=JSON.parse(r.body||"{}")}catch{this.body=r.body}this.links=i(this.headers.link)}return e.prototype.hasNextPage=function(){return!!this.links.next},e.prototype.nextPage=function(){return this.hasNextPage()?this.request._extend({path:this.links.next.url}):null},Pb=e,Pb}var Bb,ZI;function T0(){return ZI||(ZI=1,Bb={API_ORIGIN:"https://api.mapbox.com",EVENT_PROGRESS_DOWNLOAD:"downloadProgress",EVENT_PROGRESS_UPLOAD:"uploadProgress",EVENT_ERROR:"error",EVENT_RESPONSE:"response",ERROR_HTTP:"HttpError",ERROR_REQUEST_ABORTED:"RequestAbortedError"}),Bb}var Db,YI;function DZ(){if(YI)return Db;YI=1;var i=T0();function e(t){var r=t.type||i.ERROR_HTTP,a;if(t.body)try{a=JSON.parse(t.body)}catch{a=t.body}else a=null;var h=t.message||null;h||(typeof a=="string"?h=a:a&&typeof a.message=="string"?h=a.message:r===i.ERROR_REQUEST_ABORTED&&(h="Request aborted")),this.message=h,this.type=r,this.statusCode=t.statusCode||null,this.request=t.request,this.body=a}return Db=e,Db}var Ob,KI;function OZ(){if(KI)return Ob;KI=1;function i(t){var r=t.indexOf(":"),a=t.substring(0,r).trim().toLowerCase(),h=t.substring(r+1).trim();return{name:a,value:h}}function e(t){var r={};return t&&t.trim().split(/[\r|\n]+/).forEach(function(a){var h=i(a);r[h.name]=h.value}),r}return Ob=e,Ob}var Fb,JI;function FZ(){if(JI)return Fb;JI=1;var i=BZ(),e=DZ(),t=T0(),r=OZ(),a={};function h(V){var X=a[V.id];X&&(X.abort(),delete a[V.id])}function y(V,X){return new i(V,{body:X.response,headers:r(X.getAllResponseHeaders()),statusCode:X.status})}function s(V){var X=V.total,se=V.loaded,ne=100*se/X;return{total:X,transferred:se,percent:ne}}function T(V,X){return new Promise(function(se,ne){X.onprogress=function(_e){V.emitter.emit(t.EVENT_PROGRESS_DOWNLOAD,s(_e))};var K=V.file;K&&(X.upload.onprogress=function(_e){V.emitter.emit(t.EVENT_PROGRESS_UPLOAD,s(_e))}),X.onerror=function(_e){ne(_e)},X.onabort=function(){var _e=new e({request:V,type:t.ERROR_REQUEST_ABORTED});ne(_e)},X.onload=function(){if(delete a[V.id],X.status<200||X.status>=400){var _e=new e({request:V,body:X.response,statusCode:X.status});ne(_e);return}se(X)};var ue=V.body;typeof ue=="string"?X.send(ue):ue?X.send(JSON.stringify(ue)):K?X.send(K):X.send(),a[V.id]=X}).then(function(se){return y(V,se)})}function B(V,X){var se=V.url(X),ne=new window.XMLHttpRequest;return ne.open(V.method,se),Object.keys(V.headers).forEach(function(K){ne.setRequestHeader(K,V.headers[K])}),ne}function F(V){return Promise.resolve().then(function(){var X=B(V,V.client.accessToken);return T(V,X)})}return Fb={browserAbort:h,sendRequestXhr:T,browserSend:F,createRequestXhr:B},Fb}var Wp={exports:{}};/*! http://mths.be/base64 v0.1.0 by @mathias | MIT license */var kZ=Wp.exports,QI;function LZ(){return QI||(QI=1,function(i,e){(function(t){var r=e,a=i&&i.exports==r&&i,h=typeof ec=="object"&&ec;(h.global===h||h.window===h)&&(t=h);var y=function(ne){this.message=ne};y.prototype=new Error,y.prototype.name="InvalidCharacterError";var s=function(ne){throw new y(ne)},T="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",B=/[\t\n\f\r ]/g,F=function(ne){ne=String(ne).replace(B,"");var K=ne.length;K%4==0&&(ne=ne.replace(/==?$/,""),K=ne.length),(K%4==1||/[^+a-zA-Z0-9/]/.test(ne))&&s("Invalid character: the string to be decoded is not correctly encoded.");for(var ue=0,_e,ke,we="",ge=-1;++ge<K;)ke=T.indexOf(ne.charAt(ge)),_e=ue%4?_e*64+ke:ke,ue++%4&&(we+=String.fromCharCode(255&_e>>(-2*ue&6)));return we},V=function(ne){ne=String(ne),/[^\0-\xFF]/.test(ne)&&s("The string to be encoded contains characters outside of the Latin1 range.");for(var K=ne.length%3,ue="",_e=-1,ke,we,ge,Le,$e=ne.length-K;++_e<$e;)ke=ne.charCodeAt(_e)<<16,we=ne.charCodeAt(++_e)<<8,ge=ne.charCodeAt(++_e),Le=ke+we+ge,ue+=T.charAt(Le>>18&63)+T.charAt(Le>>12&63)+T.charAt(Le>>6&63)+T.charAt(Le&63);return K==2?(ke=ne.charCodeAt(_e)<<8,we=ne.charCodeAt(++_e),Le=ke+we,ue+=T.charAt(Le>>10)+T.charAt(Le>>4&63)+T.charAt(Le<<2&63)+"="):K==1&&(Le=ne.charCodeAt(_e),ue+=T.charAt(Le>>2)+T.charAt(Le<<4&63)+"=="),ue},X={encode:V,decode:F,version:"0.1.0"};if(r&&!r.nodeType)if(a)a.exports=X;else for(var se in X)X.hasOwnProperty(se)&&(r[se]=X[se]);else t.base64=X})(kZ)}(Wp,Wp.exports)),Wp.exports}var kb,eC;function EB(){if(eC)return kb;eC=1;var i=LZ(),e={};function t(h){if(e[h])return e[h];var y=h.split("."),s=y[0],T=y[1];if(!T)throw new Error("Invalid token");var B=r(T),F={usage:s,user:B.u};return a(B,"a")&&(F.authorization=B.a),a(B,"exp")&&(F.expires=B.exp*1e3),a(B,"iat")&&(F.created=B.iat*1e3),a(B,"scopes")&&(F.scopes=B.scopes),a(B,"client")&&(F.client=B.client),a(B,"ll")&&(F.lastLogin=B.ll),a(B,"iu")&&(F.impersonator=B.iu),e[h]=F,F}function r(h){try{return JSON.parse(i.decode(h))}catch{throw new Error("Invalid token")}}function a(h,y){return Object.prototype.hasOwnProperty.call(h,y)}return kb=t,kb}var Lb={exports:{}},tC;function NZ(){return tC||(tC=1,function(i){var e=Object.prototype.hasOwnProperty,t="~";function r(){}Object.create&&(r.prototype=Object.create(null),new r().__proto__||(t=!1));function a(T,B,F){this.fn=T,this.context=B,this.once=F||!1}function h(T,B,F,V,X){if(typeof F!="function")throw new TypeError("The listener must be a function");var se=new a(F,V||T,X),ne=t?t+B:B;return T._events[ne]?T._events[ne].fn?T._events[ne]=[T._events[ne],se]:T._events[ne].push(se):(T._events[ne]=se,T._eventsCount++),T}function y(T,B){--T._eventsCount===0?T._events=new r:delete T._events[B]}function s(){this._events=new r,this._eventsCount=0}s.prototype.eventNames=function(){var B=[],F,V;if(this._eventsCount===0)return B;for(V in F=this._events)e.call(F,V)&&B.push(t?V.slice(1):V);return Object.getOwnPropertySymbols?B.concat(Object.getOwnPropertySymbols(F)):B},s.prototype.listeners=function(B){var F=t?t+B:B,V=this._events[F];if(!V)return[];if(V.fn)return[V.fn];for(var X=0,se=V.length,ne=new Array(se);X<se;X++)ne[X]=V[X].fn;return ne},s.prototype.listenerCount=function(B){var F=t?t+B:B,V=this._events[F];return V?V.fn?1:V.length:0},s.prototype.emit=function(B,F,V,X,se,ne){var K=t?t+B:B;if(!this._events[K])return!1;var ue=this._events[K],_e=arguments.length,ke,we;if(ue.fn){switch(ue.once&&this.removeListener(B,ue.fn,void 0,!0),_e){case 1:return ue.fn.call(ue.context),!0;case 2:return ue.fn.call(ue.context,F),!0;case 3:return ue.fn.call(ue.context,F,V),!0;case 4:return ue.fn.call(ue.context,F,V,X),!0;case 5:return ue.fn.call(ue.context,F,V,X,se),!0;case 6:return ue.fn.call(ue.context,F,V,X,se,ne),!0}for(we=1,ke=new Array(_e-1);we<_e;we++)ke[we-1]=arguments[we];ue.fn.apply(ue.context,ke)}else{var ge=ue.length,Le;for(we=0;we<ge;we++)switch(ue[we].once&&this.removeListener(B,ue[we].fn,void 0,!0),_e){case 1:ue[we].fn.call(ue[we].context);break;case 2:ue[we].fn.call(ue[we].context,F);break;case 3:ue[we].fn.call(ue[we].context,F,V);break;case 4:ue[we].fn.call(ue[we].context,F,V,X);break;default:if(!ke)for(Le=1,ke=new Array(_e-1);Le<_e;Le++)ke[Le-1]=arguments[Le];ue[we].fn.apply(ue[we].context,ke)}}return!0},s.prototype.on=function(B,F,V){return h(this,B,F,V,!1)},s.prototype.once=function(B,F,V){return h(this,B,F,V,!0)},s.prototype.removeListener=function(B,F,V,X){var se=t?t+B:B;if(!this._events[se])return this;if(!F)return y(this,se),this;var ne=this._events[se];if(ne.fn)ne.fn===F&&(!X||ne.once)&&(!V||ne.context===V)&&y(this,se);else{for(var K=0,ue=[],_e=ne.length;K<_e;K++)(ne[K].fn!==F||X&&!ne[K].once||V&&ne[K].context!==V)&&ue.push(ne[K]);ue.length?this._events[se]=ue.length===1?ue[0]:ue:y(this,se)}return this},s.prototype.removeAllListeners=function(B){var F;return B?(F=t?t+B:B,this._events[F]&&y(this,F)):(this._events=new r,this._eventsCount=0),this},s.prototype.off=s.prototype.removeListener,s.prototype.addListener=s.prototype.on,s.prefixed=t,s.EventEmitter=s,i.exports=s}(Lb)),Lb.exports}var Nb,iC;function zZ(){if(iC)return Nb;iC=1;function i(y){return y.map(encodeURIComponent).join(",")}function e(y){return Array.isArray(y)?i(y):encodeURIComponent(String(y))}function t(y,s,T){if(T===!1||T===null)return y;var B=/\?/.test(y)?"&":"?",F=encodeURIComponent(s);return T!==void 0&&T!==""&&T!==!0&&(F+="="+e(T)),""+y+B+F}function r(y,s){if(!s)return y;var T=y;return Object.keys(s).forEach(function(B){var F=s[B];F!==void 0&&(Array.isArray(F)&&(F=F.filter(function(V){return V!=null}).join(",")),T=t(T,B,F))}),T}function a(y,s){if(!s||y.slice(0,4)==="http")return y;var T=y[0]==="/"?"":"/";return""+s.replace(/\/$/,"")+T+y}function h(y,s){return s?y.replace(/\/:([a-zA-Z0-9]+)/g,function(T,B){var F=s[B];if(F===void 0)throw new Error("Unspecified route parameter "+B);var V=e(F);return"/"+V}):y}return Nb={appendQueryObject:r,appendQueryParam:t,prependOrigin:a,interpolateRouteParams:h},Nb}var zb,rC;function UZ(){if(rC)return zb;rC=1;var i=EB(),e=Pd(),t=NZ(),r=zZ(),a=T0(),h=1;function y(s,T){if(!s)throw new Error("MapiRequest requires a client");if(!T||!T.path||!T.method)throw new Error("MapiRequest requires an options object with path and method properties");var B={};T.body&&(B["content-type"]="application/json");var F=e(B,T.headers),V=Object.keys(F).reduce(function(X,se){return X[se.toLowerCase()]=F[se],X},{});this.id=h++,this._options=T,this.emitter=new t,this.client=s,this.response=null,this.error=null,this.sent=!1,this.aborted=!1,this.path=T.path,this.method=T.method,this.origin=T.origin||s.origin,this.query=T.query||{},this.params=T.params||{},this.body=T.body||null,this.file=T.file||null,this.encoding=T.encoding||"utf8",this.sendFileAs=T.sendFileAs||null,this.headers=V}return y.prototype.url=function(T){var B=r.prependOrigin(this.path,this.origin);B=r.appendQueryObject(B,this.query);var F=this.params,V=T??this.client.accessToken;if(V){B=r.appendQueryParam(B,"access_token",V);var X=i(V).user;F=e({ownerId:X},F)}return B=r.interpolateRouteParams(B,F),B},y.prototype.send=function(){var T=this;if(T.sent)throw new Error("This request has already been sent. Check the response and error properties. Create a new request with clone().");return T.sent=!0,T.client.sendRequest(T).then(function(B){return T.response=B,T.emitter.emit(a.EVENT_RESPONSE,B),B},function(B){throw T.error=B,T.emitter.emit(a.EVENT_ERROR,B),B})},y.prototype.abort=function(){this._nextPageRequest&&(this._nextPageRequest.abort(),delete this._nextPageRequest),!(this.response||this.error||this.aborted)&&(this.aborted=!0,this.client.abortRequest(this))},y.prototype.eachPage=function(T){var B=this;function F(se){function ne(){delete B._nextPageRequest;var K=se.nextPage();K&&(B._nextPageRequest=K,X(K))}T(null,se,ne)}function V(se){T(se,null,function(){})}function X(se){se.send().then(F,V)}X(this)},y.prototype.clone=function(){return this._extend()},y.prototype._extend=function(T){var B=e(this._options,T);return new y(this.client,B)},zb=y,zb}var Ub,nC;function SB(){if(nC)return Ub;nC=1;var i=EB(),e=UZ(),t=T0();function r(a){if(!a||!a.accessToken)throw new Error("Cannot create a client without an access token");i(a.accessToken),this.accessToken=a.accessToken,this.origin=a.origin||t.API_ORIGIN}return r.prototype.createRequest=function(h){return new e(this,h)},Ub=r,Ub}var Vb,sC;function IB(){if(sC)return Vb;sC=1;var i=FZ(),e=SB();function t(a){e.call(this,a)}t.prototype=Object.create(e.prototype),t.prototype.constructor=t,t.prototype.sendRequest=i.browserSend,t.prototype.abortRequest=i.browserAbort;function r(a){return new t(a)}return Vb=r,Vb}var jb,oC;function VZ(){if(oC)return jb;oC=1;var i=IB();return jb=i,jb}var Hb,aC;function jZ(){if(aC)return Hb;aC=1;var i=Object.prototype.toString;return Hb=function(e){var t;return i.call(e)==="[object Object]"&&(t=Object.getPrototypeOf(e),t===null||t===Object.getPrototypeOf({}))},Hb}var Gb,lC;function HZ(){if(lC)return Gb;lC=1;var i=jZ(),e=Pd(),t="value",r=`
  `,a={};a.assert=function(ne,K){return K=K||{},function(ue){var _e=y(ne,ue);if(_e){var ke=s(_e,K);throw K.apiName&&(ke=K.apiName+": "+ke),new Error(ke)}}},a.shape=function(K){var ue=se(K);return function(ke){var we=y(a.plainObject,ke);if(we)return we;for(var ge,Le,$e=[],Ye=0;Ye<ue.length;Ye++)ge=ue[Ye].key,Le=ue[Ye].value,we=y(Le,ke[ge]),we&&$e.push([ge].concat(we));return $e.length<2?$e[0]:function(St){$e=$e.map(function(yt){var hi=yt[0],Pi=s(yt,St).split(`
`).join(r);return"- "+hi+": "+Pi});var Pt=St.path.join("."),vt=Pt===t?"":" of "+Pt;return"The following properties"+vt+" have invalid values:"+r+$e.join(r)}}},a.strictShape=function(K){var ue=a.shape(K);return function(ke){var we=ue(ke);if(we)return we;var ge=Object.keys(ke).reduce(function(Le,$e){return K[$e]===void 0&&Le.push($e),Le},[]);if(ge.length!==0)return function(){return"The following keys are invalid: "+ge.join(", ")}}},a.arrayOf=function(K){return h(K)},a.tuple=function(){var K=Array.isArray(arguments[0])?arguments[0]:Array.prototype.slice.call(arguments);return h(K)};function h(ne){var K=Array.isArray(ne),ue=function(_e){return K?ne[_e]:ne};return function(ke){var we=y(a.plainArray,ke);if(we)return we;if(K&&ke.length!==ne.length)return"an array with "+ne.length+" items";for(var ge=0;ge<ke.length;ge++)if(we=y(ue(ge),ke[ge]),we)return[ge].concat(we)}}a.required=function(K){function ue(_e){return _e==null?function(ke){return V(ke,X(ke.path)?"cannot be undefined/null.":"is required.")}:K.apply(this,arguments)}return ue.__required=!0,ue},a.oneOfType=function(){var K=Array.isArray(arguments[0])?arguments[0]:Array.prototype.slice.call(arguments);return function(_e){var ke=K.map(function(we){return y(we,_e)}).filter(Boolean);if(ke.length===K.length)return ke.every(function(we){return we.length===1&&typeof we[0]=="string"})?T(ke.map(function(we){return we[0]})):ke.reduce(function(we,ge){return ge.length>we.length?ge:we})}},a.equal=function(K){return function(_e){if(_e!==K)return JSON.stringify(K)}},a.oneOf=function(){var K=Array.isArray(arguments[0])?arguments[0]:Array.prototype.slice.call(arguments),ue=K.map(function(_e){return a.equal(_e)});return a.oneOfType.apply(this,ue)},a.range=function(K){var ue=K[0],_e=K[1];return function(we){var ge=y(a.number,we);if(ge||we<ue||we>_e)return"number between "+ue+" & "+_e+" (inclusive)"}},a.any=function(){},a.boolean=function(K){if(typeof K!="boolean")return"boolean"},a.number=function(K){if(typeof K!="number")return"number"},a.plainArray=function(K){if(!Array.isArray(K))return"array"},a.plainObject=function(K){if(!i(K))return"object"},a.string=function(K){if(typeof K!="string")return"string"},a.func=function(K){if(typeof K!="function")return"function"};function y(ne,K){if(!(K==null&&!ne.hasOwnProperty("__required"))){var ue=ne(K);if(ue)return Array.isArray(ue)?ue:[ue]}}function s(ne,K){var ue=ne.length,_e=ne[ue-1],ke=ne.slice(0,ue-1);return ke.length===0&&(ke=[t]),K=e(K,{path:ke}),typeof _e=="function"?_e(K):V(K,B(_e))}function T(ne){return ne.length<2?ne[0]:ne.length===2?ne.join(" or "):ne.slice(0,-1).join(", ")+", or "+ne.slice(-1)}function B(ne){return"must be "+F(ne)+"."}function F(ne){return/^an? /.test(ne)?ne:/^[aeiou]/i.test(ne)?"an "+ne:/^[a-z]/i.test(ne)?"a "+ne:ne}function V(ne,K){var ue=X(ne.path),_e=ne.path.join(".")+" "+K,ke=ue?"Item at position ":"";return ke+_e}function X(ne){return typeof ne[ne.length-1]=="number"||typeof ne[0]=="number"}function se(ne){return Object.keys(ne||{}).map(function(K){return{key:K,value:ne[K]}})}return a.validate=y,a.processMessage=s,Gb=a,Gb}var $b,cC;function GZ(){if(cC)return $b;cC=1;var i=Pd(),e=HZ();function t(y){if(typeof window<"u")return y instanceof ec.Blob||y instanceof ec.ArrayBuffer?void 0:"Blob or ArrayBuffer";if(!(typeof y=="string"||y.pipe!==void 0))return"Filename or Readable stream"}function r(y,s){return e.assert(e.strictShape(y),s)}function a(y){var s="date";if(typeof y=="boolean")return s;try{var T=new Date(y);if(T.getTime&&isNaN(T.getTime()))return s}catch{return s}}function h(y){return e.tuple(e.number,e.number)(y)}return $b=i(e,{file:t,date:a,coordinates:h,assertShape:r}),$b}var Wb,uC;function $Z(){if(uC)return Wb;uC=1;function i(e,t){var r=function(a,h){return t.indexOf(a)!==-1&&h!==void 0};return typeof t=="function"&&(r=t),Object.keys(e).filter(function(a){return r(a,e[a])}).reduce(function(a,h){return a[h]=e[h],a},{})}return Wb=i,Wb}var qb,hC;function WZ(){if(hC)return qb;hC=1;function i(e,t){return Object.keys(e).reduce(function(r,a){return r[a]=t(a,e[a]),r},{})}return qb=i,qb}var Xb,dC;function qZ(){if(dC)return Xb;dC=1;var i=WZ();function e(t){return i(t,function(r,a){return typeof a=="boolean"?JSON.stringify(a):a})}return Xb=e,Xb}var Zb,fC;function XZ(){if(fC)return Zb;fC=1;var i=SB(),e=IB();function t(r){return function(a){var h;i.prototype.isPrototypeOf(a)?h=a:h=e(a);var y=Object.create(r);return y.client=h,y}}return Zb=t,Zb}var Yb,pC;function ZZ(){if(pC)return Yb;pC=1;var i=Pd(),e=GZ(),t=$Z(),r=qZ(),a=XZ(),h={},y=["country","region","postcode","district","place","locality","neighborhood","address","poi","poi.landmark"];return h.forwardGeocode=function(s){e.assertShape({query:e.required(e.string),mode:e.oneOf("mapbox.places","mapbox.places-permanent"),countries:e.arrayOf(e.string),proximity:e.oneOf(e.coordinates,"ip"),types:e.arrayOf(e.oneOf(y)),autocomplete:e.boolean,bbox:e.arrayOf(e.number),limit:e.number,language:e.arrayOf(e.string),routing:e.boolean,fuzzyMatch:e.boolean,worldview:e.string,session_token:e.string})(s),s.mode=s.mode||"mapbox.places";var T=r(i({country:s.countries},t(s,["proximity","types","autocomplete","bbox","limit","language","routing","fuzzyMatch","worldview","session_token"])));return this.client.createRequest({method:"GET",path:"/geocoding/v5/:mode/:query.json",params:t(s,["mode","query"]),query:T})},h.reverseGeocode=function(s){e.assertShape({query:e.required(e.coordinates),mode:e.oneOf("mapbox.places","mapbox.places-permanent"),countries:e.arrayOf(e.string),types:e.arrayOf(e.oneOf(y)),bbox:e.arrayOf(e.number),limit:e.number,language:e.arrayOf(e.string),reverseMode:e.oneOf("distance","score"),routing:e.boolean,worldview:e.string,session_token:e.string})(s),s.mode=s.mode||"mapbox.places";var T=r(i({country:s.countries},t(s,["country","types","bbox","limit","language","reverseMode","routing","worldview","session_token"])));return this.client.createRequest({method:"GET",path:"/geocoding/v5/:mode/:query.json",params:t(s,["mode","query"]),query:T})},Yb=a(h),Yb}let YZ="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict",CB=i=>crypto.getRandomValues(new Uint8Array(i)),MB=(i,e,t)=>{let r=(2<<Math.log(i.length-1)/Math.LN2)-1,a=-~(1.6*r*e/i.length);return(h=e)=>{let y="";for(;;){let s=t(a),T=a|0;for(;T--;)if(y+=i[s[T]&r]||"",y.length===h)return y}}},KZ=(i,e=21)=>MB(i,e,CB),JZ=(i=21)=>crypto.getRandomValues(new Uint8Array(i)).reduce((e,t)=>(t&=63,t<36?e+=t.toString(36):t<62?e+=(t-26).toString(36).toUpperCase():t>62?e+="-":e+="_",e),"");const QZ=Object.freeze(Object.defineProperty({__proto__:null,customAlphabet:KZ,customRandom:MB,nanoid:JZ,random:CB,urlAlphabet:YZ},Symbol.toStringTag,{value:"Module"})),eY=MF(QZ);var Kb,mC;function tY(){if(mC)return Kb;mC=1;var i=eY.nanoid;function e(t){this.origin=t.origin||"https://api.mapbox.com",this.endpoint="events/v2",this.access_token=t.accessToken,this.version="0.3.0",this.pluginSessionID=this.generateSessionID(),this.sessionIncrementer=0,this.userAgent=this.getUserAgent(),this.options=t,this.send=this.send.bind(this),this.countries=t.countries?t.countries.split(","):null,this.types=t.types?t.types.split(","):null,this.bbox=t.bbox?t.bbox:null,this.language=t.language?t.language.split(","):null,this.limit=t.limit?+t.limit:null,this.locale=navigator.language||null,this.enableEventLogging=this.shouldEnableLogging(t),this.eventQueue=new Array,this.flushInterval=t.flushInterval||1e3,this.maxQueueSize=t.maxQueueSize||100,this.timer=this.flushInterval?setTimeout(this.flush.bind(this),this.flushInterval):null,this.lastSentInput="",this.lastSentIndex=0}return e.prototype={select:function(t,r){var a=this.getEventPayload("search.select",r,{selectedFeature:t});if(a&&!(a.resultIndex===this.lastSentIndex&&a.queryString===this.lastSentInput||a.resultIndex==-1))return this.lastSentIndex=a.resultIndex,this.lastSentInput=a.queryString,this.push(a)},start:function(t){var r=this.getEventPayload("search.start",t);if(r)return this.push(r)},keyevent:function(t,r){if(t.key&&!(t.metaKey||[9,27,37,39,13,38,40].indexOf(t.keyCode)!==-1)){var a=this.getEventPayload("search.keystroke",r,{key:t.key});if(a)return this.push(a)}},send:function(t,r){if(!this.enableEventLogging)return r?r():void 0;var a=this.getRequestOptions(t);this.request(a,(function(h){if(h)return this.handleError(h,r);if(r)return r()}).bind(this))},getRequestOptions:function(t){Array.isArray(t)||(t=[t]);var r={method:"POST",host:this.origin,path:this.endpoint+"?access_token="+this.access_token,headers:{"Content-Type":"application/json"},body:JSON.stringify(t)};return r},getEventPayload:function(t,r,a={}){if(t==="search.select"&&!a.selectedFeature||t==="search.keystroke"&&!a.key)return null;var h;if(!r.options.proximity)h=null;else if(typeof r.options.proximity=="object")h=[r.options.proximity.longitude,r.options.proximity.latitude];else if(r.options.proximity==="ip"){var y=r._headers?r._headers["ip-proximity"]:null;y&&typeof y=="string"?h=y.split(",").map(parseFloat):h=[999,999]}else h=r.options.proximity;var s=r._map?r._map.getZoom():void 0,T={event:t,version:this.getEventSchemaVersion(t),created:+new Date,sessionIdentifier:this.getSessionId(),country:this.countries,userAgent:this.userAgent,language:this.language,bbox:this.bbox,types:this.types,endpoint:"mapbox.places",autocomplete:r.options.autocomplete,fuzzyMatch:r.options.fuzzyMatch,proximity:h,limit:r.options.limit,routing:r.options.routing,worldview:r.options.worldview,mapZoom:s,keyboardLocale:this.locale};if(t==="search.select"?T.queryString=r.inputString:t!="search.select"&&r._inputEl?T.queryString=r._inputEl.value:T.queryString=r.inputString,["search.keystroke","search.select"].includes(t)&&(T.path="geocoding/v5/mapbox.places"),t==="search.keystroke"&&a.key)T.lastAction=a.key;else if(t==="search.select"&&a.selectedFeature){var B=a.selectedFeature,F=this.getSelectedIndex(B,r);if(T.resultIndex=F,T.resultPlaceName=B.place_name,T.resultId=B.id,B.properties&&(T.resultMapboxId=B.properties.mapbox_id),r._typeahead){var V=r._typeahead.data;V&&V.length>0&&(T.suggestionIds=this.getSuggestionIds(V),T.suggestionNames=this.getSuggestionNames(V),T.suggestionTypes=this.getSuggestionTypes(V),T.suggestionSources=this.getSuggestionSources(V))}}return this.validatePayload(T)?T:null},request:function(t,r){var a=new XMLHttpRequest;a.onreadystatechange=function(){if(this.readyState==4)return this.status==204?r(null):r(this.statusText)},a.open(t.method,t.host+"/"+t.path,!0);for(var h in t.headers){var y=t.headers[h];a.setRequestHeader(h,y)}a.send(t.body)},handleError:function(t,r){if(r)return r(t)},generateSessionID:function(){return i()},getSessionId:function(){return this.pluginSessionID+"."+this.sessionIncrementer},getUserAgent:function(){return"mapbox-gl-geocoder."+this.version+"."+navigator.userAgent},getSelectedIndex:function(t,r){if(r._typeahead){var a=r._typeahead.data,h=t.id,y=a.map(function(T){return T.id}),s=y.indexOf(h);return s}},getSuggestionIds:function(t){return t.map(function(r){return r.properties?r.properties.mapbox_id||"":r.id||""})},getSuggestionNames:function(t){return t.map(function(r){return r.place_name||""})},getSuggestionTypes:function(t){return t.map(function(r){return r.place_type&&Array.isArray(r.place_type)&&r.place_type[0]||""})},getSuggestionSources:function(t){return t.map(function(r){return r._source||""})},getEventSchemaVersion:function(t){return["search.keystroke","search.select"].includes(t)?"2.2":"2.0"},validatePayload:function(t){if(!t||!t.event)return!1;var r=["event","created","sessionIdentifier","queryString"],a=["event","created","sessionIdentifier","queryString","lastAction"],h=["event","created","sessionIdentifier","queryString","resultIndex","path","suggestionIds"],y=t.event;return y==="search.start"?this.objectHasRequiredProps(t,r):y==="search.keystroke"?this.objectHasRequiredProps(t,a):y==="search.select"?this.objectHasRequiredProps(t,h):!0},objectHasRequiredProps:function(t,r){return r.every(function(a){return a==="queryString"?typeof t[a]=="string"&&t[a].length>0:t[a]!==void 0})},shouldEnableLogging:function(t){return!(t.enableEventLogging===!1||t.origin&&t.origin!=="https://api.mapbox.com")},flush:function(){this.eventQueue.length>0&&(this.send(this.eventQueue),this.eventQueue=new Array),this.timer&&clearTimeout(this.timer),this.flushInterval&&(this.timer=setTimeout(this.flush.bind(this),this.flushInterval))},push:function(t,r){this.eventQueue.push(t),(this.eventQueue.length>=this.maxQueueSize||r)&&this.flush()},remove:function(){this.flush()}},Kb=e,Kb}var Jb,_C;function iY(){if(_C)return Jb;_C=1;var i={de:"Suche",it:"Ricerca",en:"Search",nl:"Zoeken",fr:"Chercher",ca:"Cerca",he:"",ja:"",lv:"Meklt",pt:"Procurar",sr:"",zh:"",cs:"Vyhledvn",hu:"Keress",ka:"",nb:"Ske",sk:"Vyhadvanie",th:"",fi:"Hae",is:"Leita",ko:"",pl:"Szukaj",sl:"Iskanje",fa:"",ru:""};return Jb={placeholder:i},Jb}var iy={exports:{}},rY=iy.exports,gC;function nY(){return gC||(gC=1,function(i){(function(e,t,r){i.exports?i.exports=r():e[t]=r()})(rY,"subtag",function(){var e="",t=/^([a-zA-Z]{2,3})(?:[_-]+([a-zA-Z]{3})(?=$|[_-]+))?(?:[_-]+([a-zA-Z]{4})(?=$|[_-]+))?(?:[_-]+([a-zA-Z]{2}|[0-9]{3})(?=$|[_-]+))?/;function r(T){return T.match(t)||[]}function a(T){return r(T).filter(function(B,F){return B&&F})}function h(T){return T=r(T),{language:T[1]||e,extlang:T[2]||e,script:T[3]||e,region:T[4]||e}}function y(T,B,F){Object.defineProperty(T,B,{value:F,enumerable:!0})}function s(T,B,F){function V(X){return r(X)[T]||e}y(V,"pattern",B),y(h,F,V)}return s(1,/^[a-zA-Z]{2,3}$/,"language"),s(2,/^[a-zA-Z]{3}$/,"extlang"),s(3,/^[a-zA-Z]{4}$/,"script"),s(4,/^[a-zA-Z]{2}$|^[0-9]{3}$/,"region"),y(h,"split",a),h})}(iy)),iy.exports}var Qb,yC;function sY(){if(yC)return Qb;yC=1;function i(){}return i.prototype={isSupport:function(){return!!window.navigator.geolocation},getCurrentPosition:function(){const e={enableHighAccuracy:!0};return new Promise(function(t,r){window.navigator.geolocation.getCurrentPosition(t,r,e)})}},Qb=i,Qb}var e1,vC;function oY(){if(vC)return e1;vC=1;function i(r,a){const h=e(r),y=["address","street","place","country"];var s;if(typeof a=="function")return a(h);const T=y.indexOf(a);return T===-1?s=y:s=y.slice(T),s.reduce(function(B,F){return h[F]?(B!==""&&(B=B+", "),B+h[F]):B},"")}function e(r){const a=r.address||"",h=r.text||"",y=r.place_name||"",T={address:y.split(",")[0],houseNumber:a,street:h,placeName:y};return r.context.forEach(function(B){const F=B.id.split(".")[0];T[F]=B.text}),T}return e1={transformFeatureToGeolocationText:i,getAddressInfo:e,REVERSE_GEOCODE_COORD_RGX:/^[ ]*(-?\d{1,3}(\.\d{0,256})?)[, ]+(-?\d{1,3}(\.\d{0,256})?)[ ]*$/},e1}var t1,xC;function aY(){if(xC)return t1;xC=1;var i=IZ(),e=CZ(),t=Pd(),r=MZ().EventEmitter,a=RZ(),h=VZ(),y=ZZ(),s=tY(),T=iY(),B=nY(),F=sY(),V=oY();const X={FORWARD:0,LOCAL:1,REVERSE:2};function se(){var K=document.createElement("div");return K.className="mapboxgl-ctrl-geocoder--powered-by",K.innerHTML='<a href="https://www.mapbox.com/search-service" target="_blank">Powered by Mapbox</a>',K}function ne(K){this._eventEmitter=new r,this.options=t({},this.options,K),this.inputString="",this.fresh=!0,this.lastSelected=null,this.geolocation=new F}return ne.prototype={options:{zoom:16,flyTo:!0,trackProximity:!0,minLength:2,reverseGeocode:!1,flipCoordinates:!1,limit:5,origin:"https://api.mapbox.com",enableEventLogging:!0,marker:!0,mapboxgl:null,collapsed:!1,clearAndBlurOnEsc:!1,clearOnBlur:!1,enableGeolocation:!1,addressAccuracy:"street",getItemValue:function(K){return K.place_name},render:function(K){var ue=K.place_name.split(",");return'<div class="mapboxgl-ctrl-geocoder--suggestion"><div class="mapboxgl-ctrl-geocoder--suggestion-title">'+ue[0]+'</div><div class="mapboxgl-ctrl-geocoder--suggestion-address">'+ue.splice(1,ue.length).join(",")+"</div></div>"}},_headers:{},addTo:function(K){function ue(_e,ke){if(!document.body.contains(ke))throw new Error("Element provided to #addTo() exists, but is not in the DOM");const we=_e.onAdd();ke.appendChild(we)}if(K._controlContainer)K.addControl(this);else if(K instanceof HTMLElement)ue(this,K);else if(typeof K=="string"){const _e=document.querySelectorAll(K);if(_e.length===0)throw new Error("Element ",K,"not found.");if(_e.length>1)throw new Error("Geocoder can only be added to a single html element");ue(this,_e[0])}else throw new Error("Error: addTo must be a mapbox-gl-js map, an html element, or a CSS selector query for a single html element")},onAdd:function(K){if(K&&typeof K!="string"&&(this._map=K),this.setLanguage(),this.options.localGeocoderOnly||(this.geocoderService=y(h({accessToken:this.options.accessToken,origin:this.options.origin}))),this.options.localGeocoderOnly&&!this.options.localGeocoder)throw new Error("A localGeocoder function must be specified to use localGeocoderOnly mode");this.eventManager=new s(this.options),this._onChange=this._onChange.bind(this),this._onKeyDown=this._onKeyDown.bind(this),this._onPaste=this._onPaste.bind(this),this._onBlur=this._onBlur.bind(this),this._showButton=this._showButton.bind(this),this._hideButton=this._hideButton.bind(this),this._onQueryResult=this._onQueryResult.bind(this),this.clear=this.clear.bind(this),this._updateProximity=this._updateProximity.bind(this),this._collapse=this._collapse.bind(this),this._unCollapse=this._unCollapse.bind(this),this._clear=this._clear.bind(this),this._clearOnBlur=this._clearOnBlur.bind(this),this._geolocateUser=this._geolocateUser.bind(this);var ue=this.container=document.createElement("div");ue.className="mapboxgl-ctrl-geocoder mapboxgl-ctrl";var _e=this.createIcon("search",'<path d="M7.4 2.5c-2.7 0-4.9 2.2-4.9 4.9s2.2 4.9 4.9 4.9c1 0 1.8-.2 2.5-.8l3.7 3.7c.2.2.4.3.8.3.7 0 1.1-.4 1.1-1.1 0-.3-.1-.5-.3-.8L11.4 10c.4-.8.8-1.6.8-2.5.1-2.8-2.1-5-4.8-5zm0 1.6c1.8 0 3.2 1.4 3.2 3.2s-1.4 3.2-3.2 3.2-3.3-1.3-3.3-3.1 1.4-3.3 3.3-3.3z"/>');this._inputEl=document.createElement("input"),this._inputEl.type="text",this._inputEl.className="mapboxgl-ctrl-geocoder--input",this.setPlaceholder(),this.options.collapsed&&(this._collapse(),this.container.addEventListener("mouseenter",this._unCollapse),this.container.addEventListener("mouseleave",this._collapse),this._inputEl.addEventListener("focus",this._unCollapse)),(this.options.collapsed||this.options.clearOnBlur)&&this._inputEl.addEventListener("blur",this._onBlur),this._inputEl.addEventListener("keydown",e(this._onKeyDown,200)),this._inputEl.addEventListener("paste",this._onPaste),this._inputEl.addEventListener("change",this._onChange),this.container.addEventListener("mouseenter",this._showButton),this.container.addEventListener("mouseleave",this._hideButton),this._inputEl.addEventListener("keyup",(function(St){this.eventManager.keyevent(St,this)}).bind(this));var ke=document.createElement("div");ke.classList.add("mapboxgl-ctrl-geocoder--pin-right"),this._clearEl=document.createElement("button"),this._clearEl.setAttribute("aria-label","Clear"),this._clearEl.addEventListener("click",this.clear),this._clearEl.className="mapboxgl-ctrl-geocoder--button";var we=this.createIcon("close",'<path d="M3.8 2.5c-.6 0-1.3.7-1.3 1.3 0 .3.2.7.5.8L7.2 9 3 13.2c-.3.3-.5.7-.5 1 0 .6.7 1.3 1.3 1.3.3 0 .7-.2 1-.5L9 10.8l4.2 4.2c.2.3.7.3 1 .3.6 0 1.3-.7 1.3-1.3 0-.3-.2-.7-.3-1l-4.4-4L15 4.6c.3-.2.5-.5.5-.8 0-.7-.7-1.3-1.3-1.3-.3 0-.7.2-1 .3L9 7.1 4.8 2.8c-.3-.1-.7-.3-1-.3z"/>');if(this._clearEl.appendChild(we),this._loadingEl=this.createIcon("loading",'<path fill="#333" d="M4.4 4.4l.8.8c2.1-2.1 5.5-2.1 7.6 0l.8-.8c-2.5-2.5-6.7-2.5-9.2 0z"/><path opacity=".1" d="M12.8 12.9c-2.1 2.1-5.5 2.1-7.6 0-2.1-2.1-2.1-5.5 0-7.7l-.8-.8c-2.5 2.5-2.5 6.7 0 9.2s6.6 2.5 9.2 0 2.5-6.6 0-9.2l-.8.8c2.2 2.1 2.2 5.6 0 7.7z"/>'),ke.appendChild(this._clearEl),ke.appendChild(this._loadingEl),ue.appendChild(_e),ue.appendChild(this._inputEl),ue.appendChild(ke),this.options.enableGeolocation&&this.geolocation.isSupport()){this._geolocateEl=document.createElement("button"),this._geolocateEl.setAttribute("aria-label","Geolocate"),this._geolocateEl.addEventListener("click",this._geolocateUser),this._geolocateEl.className="mapboxgl-ctrl-geocoder--button";var ge=this.createIcon("geolocate",'<path d="M12.999 3.677L2.042 8.269c-.962.403-.747 1.823.29 1.912l5.032.431.431 5.033c.089 1.037 1.509 1.252 1.912.29l4.592-10.957c.345-.822-.477-1.644-1.299-1.299z" fill="#4264fb"/>');this._geolocateEl.appendChild(ge),ke.appendChild(this._geolocateEl),this._showGeolocateButton()}var Le=this._typeahead=new i(this._inputEl,[],{filter:!1,minLength:this.options.minLength,limit:this.options.limit});this.setRenderFunction(this.options.render),Le.getItemValue=this.options.getItemValue;var $e=Le.list.draw,Ye=this._footerNode=se();return Le.list.draw=function(){$e.call(this),Ye.addEventListener("mousedown",(function(){this.selectingListItem=!0}).bind(this)),Ye.addEventListener("mouseup",(function(){this.selectingListItem=!1}).bind(this)),this.element.appendChild(Ye)},this.mapMarker=null,this._handleMarker=this._handleMarker.bind(this),this._map&&(this.options.trackProximity&&(this._updateProximity(),this._map.on("moveend",this._updateProximity)),this._mapboxgl=this.options.mapboxgl,!this._mapboxgl&&this.options.marker&&(console.error("No mapboxgl detected in options. Map markers are disabled. Please set options.mapboxgl."),this.options.marker=!1)),ue},_geolocateUser:function(){this._hideGeolocateButton(),this._showLoadingIcon(),this.geolocation.getCurrentPosition().then((function(K){this._hideLoadingIcon();const ue={geometry:{type:"Point",coordinates:[K.coords.longitude,K.coords.latitude]}};this._handleMarker(ue),this._fly(ue),this._typeahead.clear(),this._typeahead.selected=!0,this.lastSelected=JSON.stringify(ue),this._showClearButton(),this.fresh=!1;const _e={limit:1,language:[this.options.language],query:ue.geometry.coordinates,types:["address"]};if(this.options.localGeocoderOnly){const ke=ue.geometry.coordinates[0]+","+ue.geometry.coordinates[1];this._setInputValue(ke),this._eventEmitter.emit("result",{result:ue})}else this.geocoderService.reverseGeocode(_e).send().then((function(ke){const we=ke.body.features[0];if(we){const ge=V.transformFeatureToGeolocationText(we,this.options.addressAccuracy);this._setInputValue(ge),we.user_coordinates=ue.geometry.coordinates,this._eventEmitter.emit("result",{result:we})}else this._eventEmitter.emit("result",{result:{user_coordinates:ue.geometry.coordinates}})}).bind(this))}).bind(this)).catch((function(K){K.code===1?this._renderUserDeniedGeolocationError():this._renderLocationError(),this._hideLoadingIcon(),this._showGeolocateButton(),this._hideAttribution()}).bind(this))},createIcon:function(K,ue){var _e=document.createElementNS("http://www.w3.org/2000/svg","svg");return _e.setAttribute("class","mapboxgl-ctrl-geocoder--icon mapboxgl-ctrl-geocoder--icon-"+K),_e.setAttribute("viewBox","0 0 18 18"),_e.setAttribute("xml:space","preserve"),_e.setAttribute("width",18),_e.setAttribute("height",18),_e.innerHTML=ue,_e},onRemove:function(){return this.container.parentNode.removeChild(this.container),this.options.trackProximity&&this._map&&this._map.off("moveend",this._updateProximity),this._removeMarker(),this._map=null,this},_setInputValue:function(K){this._inputEl.value=K,setTimeout((function(){this._inputEl.focus(),this._inputEl.scrollLeft=0,this._inputEl.setSelectionRange(0,0)}).bind(this),1)},_onPaste:function(K){var ue=(K.clipboardData||window.clipboardData).getData("text");ue.length>=this.options.minLength&&this._geocode(ue)},_onKeyDown:function(K){var ue=27,_e=9;if(K.keyCode===ue&&this.options.clearAndBlurOnEsc)return this._clear(K),this._inputEl.blur();var ke=K.target&&K.target.shadowRoot?K.target.shadowRoot.activeElement:K.target,we=ke?ke.value:"";if(!we)return this.fresh=!0,K.keyCode!==_e&&this.clear(K),this._showGeolocateButton(),this._hideClearButton();this._hideGeolocateButton(),!(K.metaKey||[_e,ue,37,39,13,38,40].indexOf(K.keyCode)!==-1)&&ke.value.length>=this.options.minLength&&this._geocode(ke.value)},_showButton:function(){this._typeahead.selected&&this._showClearButton()},_hideButton:function(){this._typeahead.selected&&this._hideClearButton()},_showClearButton:function(){this._clearEl.style.display="block"},_hideClearButton:function(){this._clearEl.style.display="none"},_showGeolocateButton:function(){this._geolocateEl&&this.geolocation.isSupport()&&(this._geolocateEl.style.display="block")},_hideGeolocateButton:function(){this._geolocateEl&&(this._geolocateEl.style.display="none")},_showLoadingIcon:function(){this._loadingEl.style.display="block"},_hideLoadingIcon:function(){this._loadingEl.style.display="none"},_showAttribution:function(){this._footerNode.style.display="block"},_hideAttribution:function(){this._footerNode.style.display="none"},_onBlur:function(K){this.options.clearOnBlur&&this._clearOnBlur(K),this.options.collapsed&&this._collapse()},_onChange:function(){var K=this._typeahead.selected;K&&JSON.stringify(K)!==this.lastSelected&&(this._hideClearButton(),this.options.flyTo&&this._fly(K),this.options.marker&&this._mapboxgl&&this._handleMarker(K),this._inputEl.focus(),this._inputEl.scrollLeft=0,this._inputEl.setSelectionRange(0,0),this.lastSelected=JSON.stringify(K),this._eventEmitter.emit("result",{result:K}),this.eventManager.select(K,this))},_fly:function(K){var ue;if(K.properties&&a[K.properties.short_code])ue=t({},this.options.flyTo),this._map&&this._map.fitBounds(a[K.properties.short_code].bbox,ue);else if(K.bbox){var _e=K.bbox;ue=t({},this.options.flyTo),this._map&&this._map.fitBounds([[_e[0],_e[1]],[_e[2],_e[3]]],ue)}else{var ke={zoom:this.options.zoom};ue=t({},ke,this.options.flyTo),K.center?ue.center=K.center:K.geometry&&K.geometry.type&&K.geometry.type==="Point"&&K.geometry.coordinates&&(ue.center=K.geometry.coordinates),this._map&&this._map.flyTo(ue)}},_requestType:function(K,ue){var _e;return K.localGeocoderOnly?_e=X.LOCAL:K.reverseGeocode&&V.REVERSE_GEOCODE_COORD_RGX.test(ue)?_e=X.REVERSE:_e=X.FORWARD,_e},_setupConfig:function(K,ue){const _e=["bbox","limit","proximity","countries","types","language","reverseMode","mode","autocomplete","fuzzyMatch","routing","worldview"],ke=/[\s,]+/;var we=this,ge=_e.reduce(function($e,Ye){if(we.options[Ye]===void 0||we.options[Ye]===null)return $e;["countries","types","language"].indexOf(Ye)>-1?$e[Ye]=we.options[Ye].split(ke):$e[Ye]=we.options[Ye];const St=typeof we.options[Ye].longitude=="number"&&typeof we.options[Ye].latitude=="number";if(Ye==="proximity"&&St){const Pt=we.options[Ye].longitude,vt=we.options[Ye].latitude;$e[Ye]=[Pt,vt]}return $e},{});switch(K){case X.REVERSE:{var Le=ue.split(ke).map(function($e){return parseFloat($e,10)});we.options.flipCoordinates||Le.reverse(),ge.types&&ge.types[0],ge=t(ge,{query:Le,limit:1}),["proximity","autocomplete","fuzzyMatch","bbox"].forEach(function($e){$e in ge&&delete ge[$e]})}break;case X.FORWARD:{const $e=ue.trim();/^(-?\d{1,3}(\.\d{0,256})?)[, ]+(-?\d{1,3}(\.\d{0,256})?)?$/.test($e)&&(ue=ue.replace(/,/g," ")),ge=t(ge,{query:ue})}break}return ge.session_token=this.eventManager.getSessionId(),ge},_geocode:function(K){this.inputString=K,this._showLoadingIcon(),this._eventEmitter.emit("loading",{query:K});const ue=this._requestType(this.options,K),_e=this._setupConfig(ue,K);var ke;switch(ue){case X.LOCAL:ke=Promise.resolve();break;case X.FORWARD:ke=this.geocoderService.forwardGeocode(_e).send();break;case X.REVERSE:ke=this.geocoderService.reverseGeocode(_e).send();break}var we=this.options.localGeocoder?this.options.localGeocoder(K)||[]:[],ge=[],Le=null;return ke.catch((function($e){Le=$e}).bind(this)).then((function($e){this._hideLoadingIcon();var Ye={};return $e?$e.statusCode=="200"&&(Ye=$e.body,Ye.request=$e.request,Ye.headers=$e.headers,this._headers=$e.headers):Ye={type:"FeatureCollection",features:[]},Ye.config=_e,this.fresh&&(this.eventManager.start(this),this.fresh=!1),Ye.features&&Ye.features.length&&Ye.features.map(function(St){St._source="mapbox"}),Ye.features=Ye.features?we.concat(Ye.features):we,this.options.externalGeocoder?(ge=this.options.externalGeocoder(K,Ye.features)||Promise.resolve([]),ge.then(function(St){return Ye.features=Ye.features?St.concat(Ye.features):St,Ye},function(){return Ye})):Ye}).bind(this)).then((function($e){if(Le)throw Le;this.options.filter&&$e.features.length&&($e.features=$e.features.filter(this.options.filter)),$e.features.length?(this._showClearButton(),this._hideGeolocateButton(),this._showAttribution(),this._eventEmitter.emit("results",$e),this._typeahead.update($e.features)):(this._hideClearButton(),this._hideAttribution(),this._typeahead.selected=null,this._renderNoResults(),this._eventEmitter.emit("results",$e))}).bind(this)).catch((function($e){this._hideLoadingIcon(),this._hideAttribution(),we.length&&this.options.localGeocoder||ge.length&&this.options.externalGeocoder?(this._showClearButton(),this._hideGeolocateButton(),this._typeahead.update(we)):(this._hideClearButton(),this._typeahead.selected=null,this._renderError()),this._eventEmitter.emit("results",{features:we}),this._eventEmitter.emit("error",{error:$e})}).bind(this)),ke},_clear:function(K){K&&K.preventDefault(),this._inputEl.value="",this._typeahead.selected=null,this._typeahead.clear(),this.eventManager.sessionIncrementer++,this._onChange(),this._hideClearButton(),this._showGeolocateButton(),this._removeMarker(),this.lastSelected=null,this._eventEmitter.emit("clear"),this.fresh=!0},clear:function(K){this._clear(K),this._inputEl.focus()},_clearOnBlur:function(K){var ue=this;K.relatedTarget&&ue._clear(K)},_onQueryResult:function(K){var ue=K.body;if(ue.features.length){var _e=ue.features[0];this._typeahead.selected=_e,this._inputEl.value=_e.place_name,this._onChange()}},_updateProximity:function(){if(!(!this._map||!this.options.trackProximity))if(this._map.getZoom()>9){var K=this._map.getCenter().wrap();this.setProximity({longitude:K.lng,latitude:K.lat},!1)}else this.setProximity(null,!1)},_collapse:function(){!this._inputEl.value&&this._inputEl!==document.activeElement&&this.container.classList.add("mapboxgl-ctrl-geocoder--collapsed")},_unCollapse:function(){this.container.classList.remove("mapboxgl-ctrl-geocoder--collapsed")},query:function(K){return this._geocode(K).then(this._onQueryResult),this},_renderError:function(){var K="<div class='mapbox-gl-geocoder--error'>There was an error reaching the server</div>";this._renderMessage(K)},_renderLocationError:function(){var K="<div class='mapbox-gl-geocoder--error'>A location error has occurred</div>";this._renderMessage(K)},_renderNoResults:function(){var K="<div class='mapbox-gl-geocoder--error mapbox-gl-geocoder--no-results'>No results found</div>";this._renderMessage(K)},_renderUserDeniedGeolocationError:function(){var K="<div class='mapbox-gl-geocoder--error'>Geolocation permission denied</div>";this._renderMessage(K)},_renderMessage:function(K){this._typeahead.update([]),this._typeahead.selected=null,this._typeahead.clear(),this._typeahead.renderError(K)},_getPlaceholderText:function(){if(this.options.placeholder)return this.options.placeholder;if(this.options.language){var K=this.options.language.split(",")[0],ue=B.language(K),_e=T.placeholder[ue];if(_e)return _e}return"Search"},setInput:function(K,ue){return ue===void 0&&(ue=!1),this._inputEl.value=K,this._typeahead.selected=null,this._typeahead.clear(),K.length>=this.options.minLength&&(ue?this._geocode(K):this._onChange()),this},setProximity:function(K,ue=!0){return this.options.proximity=K,ue&&(this.options.trackProximity=!1),this},getProximity:function(){return this.options.proximity},setRenderFunction:function(K){return K&&typeof K=="function"&&(this._typeahead.render=K),this},getRenderFunction:function(){return this._typeahead.render},setLanguage:function(K){var ue=navigator.language||navigator.userLanguage||navigator.browserLanguage;return this.options.language=K||this.options.language||ue,this},getLanguage:function(){return this.options.language},getZoom:function(){return this.options.zoom},setZoom:function(K){return this.options.zoom=K,this},getFlyTo:function(){return this.options.flyTo},setFlyTo:function(K){return this.options.flyTo=K,this},getPlaceholder:function(){return this.options.placeholder},setPlaceholder:function(K){return this.options.placeholder=K||this._getPlaceholderText(),this._inputEl.placeholder=this.options.placeholder,this._inputEl.setAttribute("aria-label",this.options.placeholder),this},getBbox:function(){return this.options.bbox},setBbox:function(K){return this.options.bbox=K,this},getCountries:function(){return this.options.countries},setCountries:function(K){return this.options.countries=K,this},getTypes:function(){return this.options.types},setTypes:function(K){return this.options.types=K,this},getMinLength:function(){return this.options.minLength},setMinLength:function(K){return this.options.minLength=K,this._typeahead&&(this._typeahead.options.minLength=K),this},getLimit:function(){return this.options.limit},setLimit:function(K){return this.options.limit=K,this._typeahead&&(this._typeahead.options.limit=K),this},getFilter:function(){return this.options.filter},setFilter:function(K){return this.options.filter=K,this},setOrigin:function(K){return this.options.origin=K,this.geocoderService=y(h({accessToken:this.options.accessToken,origin:this.options.origin})),this},getOrigin:function(){return this.options.origin},setAccessToken:function(K){return this.options.accessToken=K,this.geocoderService=y(h({accessToken:this.options.accessToken,origin:this.options.origin})),this},setAutocomplete:function(K){return this.options.autocomplete=K,this},getAutocomplete:function(){return this.options.autocomplete},setFuzzyMatch:function(K){return this.options.fuzzyMatch=K,this},getFuzzyMatch:function(){return this.options.fuzzyMatch},setRouting:function(K){return this.options.routing=K,this},getRouting:function(){return this.options.routing},setWorldview:function(K){return this.options.worldview=K,this},getWorldview:function(){return this.options.worldview},_handleMarker:function(K){if(this._map){this._removeMarker();var ue={color:"#4668F2"},_e=t({},ue,this.options.marker);return this.mapMarker=new this._mapboxgl.Marker(_e),K.center?this.mapMarker.setLngLat(K.center).addTo(this._map):K.geometry&&K.geometry.type&&K.geometry.type==="Point"&&K.geometry.coordinates&&this.mapMarker.setLngLat(K.geometry.coordinates).addTo(this._map),this}},_removeMarker:function(){this.mapMarker&&(this.mapMarker.remove(),this.mapMarker=null)},on:function(K,ue){return this._eventEmitter.on(K,ue),this},off:function(K,ue){return this._eventEmitter.removeListener(K,ue),this.eventManager.remove(),this}},t1=ne,t1}var lY=aY();const cY=OC(lY);var ry={exports:{}},uY=ry.exports,bC;function hY(){return bC||(bC=1,function(i,e){(function(t,r){i.exports=r()})(uY,function(){var t,r,a;function h(s,T){if(!t)t=T;else if(!r)r=T;else{var B="self.onerror = function() { console.error('An error occurred while parsing the WebWorker bundle. This is most likely due to improper transpilation by Babel; please see https://docs.mapbox.com/mapbox-gl-js/guides/install/#transpiling'); }; var sharedChunk = {}; ("+t+")(sharedChunk); ("+r+")(sharedChunk); self.onerror = null;",F={};t(F),a=T(F),typeof window<"u"&&window&&window.URL&&window.URL.createObjectURL&&(a.workerUrl=window.URL.createObjectURL(new Blob([B],{type:"text/javascript"})))}}h(["exports"],function(s){function T(u){return u&&u.__esModule&&Object.prototype.hasOwnProperty.call(u,"default")?u.default:u}var B,F={},V={};function X(){if(B)return V;B=1,Object.defineProperty(V,"__esModule",{value:!0}),V.setMatrixArrayType=function(_){V.ARRAY_TYPE=n=_},V.toRadian=function(_){return _*d},V.equals=function(_,f){return Math.abs(_-f)<=u*Math.max(1,Math.abs(_),Math.abs(f))},V.RANDOM=V.ARRAY_TYPE=V.EPSILON=void 0;var u=1e-6;V.EPSILON=u;var n=typeof Float32Array<"u"?Float32Array:Array;V.ARRAY_TYPE=n;var l=Math.random;V.RANDOM=l;var d=Math.PI/180;return Math.hypot||(Math.hypot=function(){for(var _=0,f=arguments.length;f--;)_+=arguments[f]*arguments[f];return Math.sqrt(_)}),V}var se,ne={};function K(){if(se)return ne;function u(f){return u=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(g){return typeof g}:function(g){return g&&typeof Symbol=="function"&&g.constructor===Symbol&&g!==Symbol.prototype?"symbol":typeof g},u(f)}se=1,Object.defineProperty(ne,"__esModule",{value:!0}),ne.create=function(){var f=new n.ARRAY_TYPE(4);return n.ARRAY_TYPE!=Float32Array&&(f[1]=0,f[2]=0),f[0]=1,f[3]=1,f},ne.clone=function(f){var g=new n.ARRAY_TYPE(4);return g[0]=f[0],g[1]=f[1],g[2]=f[2],g[3]=f[3],g},ne.copy=function(f,g){return f[0]=g[0],f[1]=g[1],f[2]=g[2],f[3]=g[3],f},ne.identity=function(f){return f[0]=1,f[1]=0,f[2]=0,f[3]=1,f},ne.fromValues=function(f,g,w,S){var P=new n.ARRAY_TYPE(4);return P[0]=f,P[1]=g,P[2]=w,P[3]=S,P},ne.set=function(f,g,w,S,P){return f[0]=g,f[1]=w,f[2]=S,f[3]=P,f},ne.transpose=function(f,g){if(f===g){var w=g[1];f[1]=g[2],f[2]=w}else f[0]=g[0],f[1]=g[2],f[2]=g[1],f[3]=g[3];return f},ne.invert=function(f,g){var w=g[0],S=g[1],P=g[2],x=g[3],I=w*x-P*S;return I?(f[0]=x*(I=1/I),f[1]=-S*I,f[2]=-P*I,f[3]=w*I,f):null},ne.adjoint=function(f,g){var w=g[0];return f[0]=g[3],f[1]=-g[1],f[2]=-g[2],f[3]=w,f},ne.determinant=function(f){return f[0]*f[3]-f[2]*f[1]},ne.multiply=d,ne.rotate=function(f,g,w){var S=g[0],P=g[1],x=g[2],I=g[3],R=Math.sin(w),E=Math.cos(w);return f[0]=S*E+x*R,f[1]=P*E+I*R,f[2]=S*-R+x*E,f[3]=P*-R+I*E,f},ne.scale=function(f,g,w){var S=g[1],P=g[2],x=g[3],I=w[0],R=w[1];return f[0]=g[0]*I,f[1]=S*I,f[2]=P*R,f[3]=x*R,f},ne.fromRotation=function(f,g){var w=Math.sin(g),S=Math.cos(g);return f[0]=S,f[1]=w,f[2]=-w,f[3]=S,f},ne.fromScaling=function(f,g){return f[0]=g[0],f[1]=0,f[2]=0,f[3]=g[1],f},ne.str=function(f){return"mat2("+f[0]+", "+f[1]+", "+f[2]+", "+f[3]+")"},ne.frob=function(f){return Math.hypot(f[0],f[1],f[2],f[3])},ne.LDU=function(f,g,w,S){return f[2]=S[2]/S[0],w[0]=S[0],w[1]=S[1],w[3]=S[3]-f[2]*w[1],[f,g,w]},ne.add=function(f,g,w){return f[0]=g[0]+w[0],f[1]=g[1]+w[1],f[2]=g[2]+w[2],f[3]=g[3]+w[3],f},ne.subtract=_,ne.exactEquals=function(f,g){return f[0]===g[0]&&f[1]===g[1]&&f[2]===g[2]&&f[3]===g[3]},ne.equals=function(f,g){var w=f[0],S=f[1],P=f[2],x=f[3],I=g[0],R=g[1],E=g[2],C=g[3];return Math.abs(w-I)<=n.EPSILON*Math.max(1,Math.abs(w),Math.abs(I))&&Math.abs(S-R)<=n.EPSILON*Math.max(1,Math.abs(S),Math.abs(R))&&Math.abs(P-E)<=n.EPSILON*Math.max(1,Math.abs(P),Math.abs(E))&&Math.abs(x-C)<=n.EPSILON*Math.max(1,Math.abs(x),Math.abs(C))},ne.multiplyScalar=function(f,g,w){return f[0]=g[0]*w,f[1]=g[1]*w,f[2]=g[2]*w,f[3]=g[3]*w,f},ne.multiplyScalarAndAdd=function(f,g,w,S){return f[0]=g[0]+w[0]*S,f[1]=g[1]+w[1]*S,f[2]=g[2]+w[2]*S,f[3]=g[3]+w[3]*S,f},ne.sub=ne.mul=void 0;var n=function(f,g){if(f&&f.__esModule)return f;if(f===null||u(f)!=="object"&&typeof f!="function")return{default:f};var w=l(void 0);if(w&&w.has(f))return w.get(f);var S={},P=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var x in f)if(x!=="default"&&Object.prototype.hasOwnProperty.call(f,x)){var I=P?Object.getOwnPropertyDescriptor(f,x):null;I&&(I.get||I.set)?Object.defineProperty(S,x,I):S[x]=f[x]}return S.default=f,w&&w.set(f,S),S}(X());function l(f){if(typeof WeakMap!="function")return null;var g=new WeakMap,w=new WeakMap;return(l=function(S){return S?w:g})(f)}function d(f,g,w){var S=g[0],P=g[1],x=g[2],I=g[3],R=w[0],E=w[1],C=w[2],D=w[3];return f[0]=S*R+x*E,f[1]=P*R+I*E,f[2]=S*C+x*D,f[3]=P*C+I*D,f}function _(f,g,w){return f[0]=g[0]-w[0],f[1]=g[1]-w[1],f[2]=g[2]-w[2],f[3]=g[3]-w[3],f}return ne.mul=d,ne.sub=_,ne}var ue,_e={};function ke(){if(ue)return _e;function u(f){return u=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(g){return typeof g}:function(g){return g&&typeof Symbol=="function"&&g.constructor===Symbol&&g!==Symbol.prototype?"symbol":typeof g},u(f)}ue=1,Object.defineProperty(_e,"__esModule",{value:!0}),_e.create=function(){var f=new n.ARRAY_TYPE(6);return n.ARRAY_TYPE!=Float32Array&&(f[1]=0,f[2]=0,f[4]=0,f[5]=0),f[0]=1,f[3]=1,f},_e.clone=function(f){var g=new n.ARRAY_TYPE(6);return g[0]=f[0],g[1]=f[1],g[2]=f[2],g[3]=f[3],g[4]=f[4],g[5]=f[5],g},_e.copy=function(f,g){return f[0]=g[0],f[1]=g[1],f[2]=g[2],f[3]=g[3],f[4]=g[4],f[5]=g[5],f},_e.identity=function(f){return f[0]=1,f[1]=0,f[2]=0,f[3]=1,f[4]=0,f[5]=0,f},_e.fromValues=function(f,g,w,S,P,x){var I=new n.ARRAY_TYPE(6);return I[0]=f,I[1]=g,I[2]=w,I[3]=S,I[4]=P,I[5]=x,I},_e.set=function(f,g,w,S,P,x,I){return f[0]=g,f[1]=w,f[2]=S,f[3]=P,f[4]=x,f[5]=I,f},_e.invert=function(f,g){var w=g[0],S=g[1],P=g[2],x=g[3],I=g[4],R=g[5],E=w*x-S*P;return E?(f[0]=x*(E=1/E),f[1]=-S*E,f[2]=-P*E,f[3]=w*E,f[4]=(P*R-x*I)*E,f[5]=(S*I-w*R)*E,f):null},_e.determinant=function(f){return f[0]*f[3]-f[1]*f[2]},_e.multiply=d,_e.rotate=function(f,g,w){var S=g[0],P=g[1],x=g[2],I=g[3],R=g[4],E=g[5],C=Math.sin(w),D=Math.cos(w);return f[0]=S*D+x*C,f[1]=P*D+I*C,f[2]=S*-C+x*D,f[3]=P*-C+I*D,f[4]=R,f[5]=E,f},_e.scale=function(f,g,w){var S=g[1],P=g[2],x=g[3],I=g[4],R=g[5],E=w[0],C=w[1];return f[0]=g[0]*E,f[1]=S*E,f[2]=P*C,f[3]=x*C,f[4]=I,f[5]=R,f},_e.translate=function(f,g,w){var S=g[0],P=g[1],x=g[2],I=g[3],R=g[4],E=g[5],C=w[0],D=w[1];return f[0]=S,f[1]=P,f[2]=x,f[3]=I,f[4]=S*C+x*D+R,f[5]=P*C+I*D+E,f},_e.fromRotation=function(f,g){var w=Math.sin(g),S=Math.cos(g);return f[0]=S,f[1]=w,f[2]=-w,f[3]=S,f[4]=0,f[5]=0,f},_e.fromScaling=function(f,g){return f[0]=g[0],f[1]=0,f[2]=0,f[3]=g[1],f[4]=0,f[5]=0,f},_e.fromTranslation=function(f,g){return f[0]=1,f[1]=0,f[2]=0,f[3]=1,f[4]=g[0],f[5]=g[1],f},_e.str=function(f){return"mat2d("+f[0]+", "+f[1]+", "+f[2]+", "+f[3]+", "+f[4]+", "+f[5]+")"},_e.frob=function(f){return Math.hypot(f[0],f[1],f[2],f[3],f[4],f[5],1)},_e.add=function(f,g,w){return f[0]=g[0]+w[0],f[1]=g[1]+w[1],f[2]=g[2]+w[2],f[3]=g[3]+w[3],f[4]=g[4]+w[4],f[5]=g[5]+w[5],f},_e.subtract=_,_e.multiplyScalar=function(f,g,w){return f[0]=g[0]*w,f[1]=g[1]*w,f[2]=g[2]*w,f[3]=g[3]*w,f[4]=g[4]*w,f[5]=g[5]*w,f},_e.multiplyScalarAndAdd=function(f,g,w,S){return f[0]=g[0]+w[0]*S,f[1]=g[1]+w[1]*S,f[2]=g[2]+w[2]*S,f[3]=g[3]+w[3]*S,f[4]=g[4]+w[4]*S,f[5]=g[5]+w[5]*S,f},_e.exactEquals=function(f,g){return f[0]===g[0]&&f[1]===g[1]&&f[2]===g[2]&&f[3]===g[3]&&f[4]===g[4]&&f[5]===g[5]},_e.equals=function(f,g){var w=f[0],S=f[1],P=f[2],x=f[3],I=f[4],R=f[5],E=g[0],C=g[1],D=g[2],N=g[3],z=g[4],G=g[5];return Math.abs(w-E)<=n.EPSILON*Math.max(1,Math.abs(w),Math.abs(E))&&Math.abs(S-C)<=n.EPSILON*Math.max(1,Math.abs(S),Math.abs(C))&&Math.abs(P-D)<=n.EPSILON*Math.max(1,Math.abs(P),Math.abs(D))&&Math.abs(x-N)<=n.EPSILON*Math.max(1,Math.abs(x),Math.abs(N))&&Math.abs(I-z)<=n.EPSILON*Math.max(1,Math.abs(I),Math.abs(z))&&Math.abs(R-G)<=n.EPSILON*Math.max(1,Math.abs(R),Math.abs(G))},_e.sub=_e.mul=void 0;var n=function(f,g){if(f&&f.__esModule)return f;if(f===null||u(f)!=="object"&&typeof f!="function")return{default:f};var w=l(void 0);if(w&&w.has(f))return w.get(f);var S={},P=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var x in f)if(x!=="default"&&Object.prototype.hasOwnProperty.call(f,x)){var I=P?Object.getOwnPropertyDescriptor(f,x):null;I&&(I.get||I.set)?Object.defineProperty(S,x,I):S[x]=f[x]}return S.default=f,w&&w.set(f,S),S}(X());function l(f){if(typeof WeakMap!="function")return null;var g=new WeakMap,w=new WeakMap;return(l=function(S){return S?w:g})(f)}function d(f,g,w){var S=g[0],P=g[1],x=g[2],I=g[3],R=g[4],E=g[5],C=w[0],D=w[1],N=w[2],z=w[3],G=w[4],W=w[5];return f[0]=S*C+x*D,f[1]=P*C+I*D,f[2]=S*N+x*z,f[3]=P*N+I*z,f[4]=S*G+x*W+R,f[5]=P*G+I*W+E,f}function _(f,g,w){return f[0]=g[0]-w[0],f[1]=g[1]-w[1],f[2]=g[2]-w[2],f[3]=g[3]-w[3],f[4]=g[4]-w[4],f[5]=g[5]-w[5],f}return _e.mul=d,_e.sub=_,_e}var we,ge={};function Le(){if(we)return ge;function u(f){return u=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(g){return typeof g}:function(g){return g&&typeof Symbol=="function"&&g.constructor===Symbol&&g!==Symbol.prototype?"symbol":typeof g},u(f)}we=1,Object.defineProperty(ge,"__esModule",{value:!0}),ge.create=function(){var f=new n.ARRAY_TYPE(9);return n.ARRAY_TYPE!=Float32Array&&(f[1]=0,f[2]=0,f[3]=0,f[5]=0,f[6]=0,f[7]=0),f[0]=1,f[4]=1,f[8]=1,f},ge.fromMat4=function(f,g){return f[0]=g[0],f[1]=g[1],f[2]=g[2],f[3]=g[4],f[4]=g[5],f[5]=g[6],f[6]=g[8],f[7]=g[9],f[8]=g[10],f},ge.clone=function(f){var g=new n.ARRAY_TYPE(9);return g[0]=f[0],g[1]=f[1],g[2]=f[2],g[3]=f[3],g[4]=f[4],g[5]=f[5],g[6]=f[6],g[7]=f[7],g[8]=f[8],g},ge.copy=function(f,g){return f[0]=g[0],f[1]=g[1],f[2]=g[2],f[3]=g[3],f[4]=g[4],f[5]=g[5],f[6]=g[6],f[7]=g[7],f[8]=g[8],f},ge.fromValues=function(f,g,w,S,P,x,I,R,E){var C=new n.ARRAY_TYPE(9);return C[0]=f,C[1]=g,C[2]=w,C[3]=S,C[4]=P,C[5]=x,C[6]=I,C[7]=R,C[8]=E,C},ge.set=function(f,g,w,S,P,x,I,R,E,C){return f[0]=g,f[1]=w,f[2]=S,f[3]=P,f[4]=x,f[5]=I,f[6]=R,f[7]=E,f[8]=C,f},ge.identity=function(f){return f[0]=1,f[1]=0,f[2]=0,f[3]=0,f[4]=1,f[5]=0,f[6]=0,f[7]=0,f[8]=1,f},ge.transpose=function(f,g){if(f===g){var w=g[1],S=g[2],P=g[5];f[1]=g[3],f[2]=g[6],f[3]=w,f[5]=g[7],f[6]=S,f[7]=P}else f[0]=g[0],f[1]=g[3],f[2]=g[6],f[3]=g[1],f[4]=g[4],f[5]=g[7],f[6]=g[2],f[7]=g[5],f[8]=g[8];return f},ge.invert=function(f,g){var w=g[0],S=g[1],P=g[2],x=g[3],I=g[4],R=g[5],E=g[6],C=g[7],D=g[8],N=D*I-R*C,z=-D*x+R*E,G=C*x-I*E,W=w*N+S*z+P*G;return W?(f[0]=N*(W=1/W),f[1]=(-D*S+P*C)*W,f[2]=(R*S-P*I)*W,f[3]=z*W,f[4]=(D*w-P*E)*W,f[5]=(-R*w+P*x)*W,f[6]=G*W,f[7]=(-C*w+S*E)*W,f[8]=(I*w-S*x)*W,f):null},ge.adjoint=function(f,g){var w=g[0],S=g[1],P=g[2],x=g[3],I=g[4],R=g[5],E=g[6],C=g[7],D=g[8];return f[0]=I*D-R*C,f[1]=P*C-S*D,f[2]=S*R-P*I,f[3]=R*E-x*D,f[4]=w*D-P*E,f[5]=P*x-w*R,f[6]=x*C-I*E,f[7]=S*E-w*C,f[8]=w*I-S*x,f},ge.determinant=function(f){var g=f[3],w=f[4],S=f[5],P=f[6],x=f[7],I=f[8];return f[0]*(I*w-S*x)+f[1]*(-I*g+S*P)+f[2]*(x*g-w*P)},ge.multiply=d,ge.translate=function(f,g,w){var S=g[0],P=g[1],x=g[2],I=g[3],R=g[4],E=g[5],C=g[6],D=g[7],N=g[8],z=w[0],G=w[1];return f[0]=S,f[1]=P,f[2]=x,f[3]=I,f[4]=R,f[5]=E,f[6]=z*S+G*I+C,f[7]=z*P+G*R+D,f[8]=z*x+G*E+N,f},ge.rotate=function(f,g,w){var S=g[0],P=g[1],x=g[2],I=g[3],R=g[4],E=g[5],C=g[6],D=g[7],N=g[8],z=Math.sin(w),G=Math.cos(w);return f[0]=G*S+z*I,f[1]=G*P+z*R,f[2]=G*x+z*E,f[3]=G*I-z*S,f[4]=G*R-z*P,f[5]=G*E-z*x,f[6]=C,f[7]=D,f[8]=N,f},ge.scale=function(f,g,w){var S=w[0],P=w[1];return f[0]=S*g[0],f[1]=S*g[1],f[2]=S*g[2],f[3]=P*g[3],f[4]=P*g[4],f[5]=P*g[5],f[6]=g[6],f[7]=g[7],f[8]=g[8],f},ge.fromTranslation=function(f,g){return f[0]=1,f[1]=0,f[2]=0,f[3]=0,f[4]=1,f[5]=0,f[6]=g[0],f[7]=g[1],f[8]=1,f},ge.fromRotation=function(f,g){var w=Math.sin(g),S=Math.cos(g);return f[0]=S,f[1]=w,f[2]=0,f[3]=-w,f[4]=S,f[5]=0,f[6]=0,f[7]=0,f[8]=1,f},ge.fromScaling=function(f,g){return f[0]=g[0],f[1]=0,f[2]=0,f[3]=0,f[4]=g[1],f[5]=0,f[6]=0,f[7]=0,f[8]=1,f},ge.fromMat2d=function(f,g){return f[0]=g[0],f[1]=g[1],f[2]=0,f[3]=g[2],f[4]=g[3],f[5]=0,f[6]=g[4],f[7]=g[5],f[8]=1,f},ge.fromQuat=function(f,g){var w=g[0],S=g[1],P=g[2],x=g[3],I=w+w,R=S+S,E=P+P,C=w*I,D=S*I,N=S*R,z=P*I,G=P*R,W=P*E,H=x*I,q=x*R,Y=x*E;return f[0]=1-N-W,f[3]=D-Y,f[6]=z+q,f[1]=D+Y,f[4]=1-C-W,f[7]=G-H,f[2]=z-q,f[5]=G+H,f[8]=1-C-N,f},ge.normalFromMat4=function(f,g){var w=g[0],S=g[1],P=g[2],x=g[3],I=g[4],R=g[5],E=g[6],C=g[7],D=g[8],N=g[9],z=g[10],G=g[11],W=g[12],H=g[13],q=g[14],Y=g[15],ie=w*R-S*I,he=w*E-P*I,ce=w*C-x*I,le=S*E-P*R,Te=S*C-x*R,de=P*C-x*E,Se=D*H-N*W,Pe=D*q-z*W,Me=D*Y-G*W,Oe=N*q-z*H,Ue=N*Y-G*H,Ge=z*Y-G*q,Ne=ie*Ge-he*Ue+ce*Oe+le*Me-Te*Pe+de*Se;return Ne?(f[0]=(R*Ge-E*Ue+C*Oe)*(Ne=1/Ne),f[1]=(E*Me-I*Ge-C*Pe)*Ne,f[2]=(I*Ue-R*Me+C*Se)*Ne,f[3]=(P*Ue-S*Ge-x*Oe)*Ne,f[4]=(w*Ge-P*Me+x*Pe)*Ne,f[5]=(S*Me-w*Ue-x*Se)*Ne,f[6]=(H*de-q*Te+Y*le)*Ne,f[7]=(q*ce-W*de-Y*he)*Ne,f[8]=(W*Te-H*ce+Y*ie)*Ne,f):null},ge.projection=function(f,g,w){return f[0]=2/g,f[1]=0,f[2]=0,f[3]=0,f[4]=-2/w,f[5]=0,f[6]=-1,f[7]=1,f[8]=1,f},ge.str=function(f){return"mat3("+f[0]+", "+f[1]+", "+f[2]+", "+f[3]+", "+f[4]+", "+f[5]+", "+f[6]+", "+f[7]+", "+f[8]+")"},ge.frob=function(f){return Math.hypot(f[0],f[1],f[2],f[3],f[4],f[5],f[6],f[7],f[8])},ge.add=function(f,g,w){return f[0]=g[0]+w[0],f[1]=g[1]+w[1],f[2]=g[2]+w[2],f[3]=g[3]+w[3],f[4]=g[4]+w[4],f[5]=g[5]+w[5],f[6]=g[6]+w[6],f[7]=g[7]+w[7],f[8]=g[8]+w[8],f},ge.subtract=_,ge.multiplyScalar=function(f,g,w){return f[0]=g[0]*w,f[1]=g[1]*w,f[2]=g[2]*w,f[3]=g[3]*w,f[4]=g[4]*w,f[5]=g[5]*w,f[6]=g[6]*w,f[7]=g[7]*w,f[8]=g[8]*w,f},ge.multiplyScalarAndAdd=function(f,g,w,S){return f[0]=g[0]+w[0]*S,f[1]=g[1]+w[1]*S,f[2]=g[2]+w[2]*S,f[3]=g[3]+w[3]*S,f[4]=g[4]+w[4]*S,f[5]=g[5]+w[5]*S,f[6]=g[6]+w[6]*S,f[7]=g[7]+w[7]*S,f[8]=g[8]+w[8]*S,f},ge.exactEquals=function(f,g){return f[0]===g[0]&&f[1]===g[1]&&f[2]===g[2]&&f[3]===g[3]&&f[4]===g[4]&&f[5]===g[5]&&f[6]===g[6]&&f[7]===g[7]&&f[8]===g[8]},ge.equals=function(f,g){var w=f[0],S=f[1],P=f[2],x=f[3],I=f[4],R=f[5],E=f[6],C=f[7],D=f[8],N=g[0],z=g[1],G=g[2],W=g[3],H=g[4],q=g[5],Y=g[6],ie=g[7],he=g[8];return Math.abs(w-N)<=n.EPSILON*Math.max(1,Math.abs(w),Math.abs(N))&&Math.abs(S-z)<=n.EPSILON*Math.max(1,Math.abs(S),Math.abs(z))&&Math.abs(P-G)<=n.EPSILON*Math.max(1,Math.abs(P),Math.abs(G))&&Math.abs(x-W)<=n.EPSILON*Math.max(1,Math.abs(x),Math.abs(W))&&Math.abs(I-H)<=n.EPSILON*Math.max(1,Math.abs(I),Math.abs(H))&&Math.abs(R-q)<=n.EPSILON*Math.max(1,Math.abs(R),Math.abs(q))&&Math.abs(E-Y)<=n.EPSILON*Math.max(1,Math.abs(E),Math.abs(Y))&&Math.abs(C-ie)<=n.EPSILON*Math.max(1,Math.abs(C),Math.abs(ie))&&Math.abs(D-he)<=n.EPSILON*Math.max(1,Math.abs(D),Math.abs(he))},ge.sub=ge.mul=void 0;var n=function(f,g){if(f&&f.__esModule)return f;if(f===null||u(f)!=="object"&&typeof f!="function")return{default:f};var w=l(void 0);if(w&&w.has(f))return w.get(f);var S={},P=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var x in f)if(x!=="default"&&Object.prototype.hasOwnProperty.call(f,x)){var I=P?Object.getOwnPropertyDescriptor(f,x):null;I&&(I.get||I.set)?Object.defineProperty(S,x,I):S[x]=f[x]}return S.default=f,w&&w.set(f,S),S}(X());function l(f){if(typeof WeakMap!="function")return null;var g=new WeakMap,w=new WeakMap;return(l=function(S){return S?w:g})(f)}function d(f,g,w){var S=g[0],P=g[1],x=g[2],I=g[3],R=g[4],E=g[5],C=g[6],D=g[7],N=g[8],z=w[0],G=w[1],W=w[2],H=w[3],q=w[4],Y=w[5],ie=w[6],he=w[7],ce=w[8];return f[0]=z*S+G*I+W*C,f[1]=z*P+G*R+W*D,f[2]=z*x+G*E+W*N,f[3]=H*S+q*I+Y*C,f[4]=H*P+q*R+Y*D,f[5]=H*x+q*E+Y*N,f[6]=ie*S+he*I+ce*C,f[7]=ie*P+he*R+ce*D,f[8]=ie*x+he*E+ce*N,f}function _(f,g,w){return f[0]=g[0]-w[0],f[1]=g[1]-w[1],f[2]=g[2]-w[2],f[3]=g[3]-w[3],f[4]=g[4]-w[4],f[5]=g[5]-w[5],f[6]=g[6]-w[6],f[7]=g[7]-w[7],f[8]=g[8]-w[8],f}return ge.mul=d,ge.sub=_,ge}var $e,Ye={};function St(){if($e)return Ye;function u(x){return u=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(I){return typeof I}:function(I){return I&&typeof Symbol=="function"&&I.constructor===Symbol&&I!==Symbol.prototype?"symbol":typeof I},u(x)}$e=1,Object.defineProperty(Ye,"__esModule",{value:!0}),Ye.create=function(){var x=new n.ARRAY_TYPE(16);return n.ARRAY_TYPE!=Float32Array&&(x[1]=0,x[2]=0,x[3]=0,x[4]=0,x[6]=0,x[7]=0,x[8]=0,x[9]=0,x[11]=0,x[12]=0,x[13]=0,x[14]=0),x[0]=1,x[5]=1,x[10]=1,x[15]=1,x},Ye.clone=function(x){var I=new n.ARRAY_TYPE(16);return I[0]=x[0],I[1]=x[1],I[2]=x[2],I[3]=x[3],I[4]=x[4],I[5]=x[5],I[6]=x[6],I[7]=x[7],I[8]=x[8],I[9]=x[9],I[10]=x[10],I[11]=x[11],I[12]=x[12],I[13]=x[13],I[14]=x[14],I[15]=x[15],I},Ye.copy=function(x,I){return x[0]=I[0],x[1]=I[1],x[2]=I[2],x[3]=I[3],x[4]=I[4],x[5]=I[5],x[6]=I[6],x[7]=I[7],x[8]=I[8],x[9]=I[9],x[10]=I[10],x[11]=I[11],x[12]=I[12],x[13]=I[13],x[14]=I[14],x[15]=I[15],x},Ye.fromValues=function(x,I,R,E,C,D,N,z,G,W,H,q,Y,ie,he,ce){var le=new n.ARRAY_TYPE(16);return le[0]=x,le[1]=I,le[2]=R,le[3]=E,le[4]=C,le[5]=D,le[6]=N,le[7]=z,le[8]=G,le[9]=W,le[10]=H,le[11]=q,le[12]=Y,le[13]=ie,le[14]=he,le[15]=ce,le},Ye.set=function(x,I,R,E,C,D,N,z,G,W,H,q,Y,ie,he,ce,le){return x[0]=I,x[1]=R,x[2]=E,x[3]=C,x[4]=D,x[5]=N,x[6]=z,x[7]=G,x[8]=W,x[9]=H,x[10]=q,x[11]=Y,x[12]=ie,x[13]=he,x[14]=ce,x[15]=le,x},Ye.identity=d,Ye.transpose=function(x,I){if(x===I){var R=I[1],E=I[2],C=I[3],D=I[6],N=I[7],z=I[11];x[1]=I[4],x[2]=I[8],x[3]=I[12],x[4]=R,x[6]=I[9],x[7]=I[13],x[8]=E,x[9]=D,x[11]=I[14],x[12]=C,x[13]=N,x[14]=z}else x[0]=I[0],x[1]=I[4],x[2]=I[8],x[3]=I[12],x[4]=I[1],x[5]=I[5],x[6]=I[9],x[7]=I[13],x[8]=I[2],x[9]=I[6],x[10]=I[10],x[11]=I[14],x[12]=I[3],x[13]=I[7],x[14]=I[11],x[15]=I[15];return x},Ye.invert=function(x,I){var R=I[0],E=I[1],C=I[2],D=I[3],N=I[4],z=I[5],G=I[6],W=I[7],H=I[8],q=I[9],Y=I[10],ie=I[11],he=I[12],ce=I[13],le=I[14],Te=I[15],de=R*z-E*N,Se=R*G-C*N,Pe=R*W-D*N,Me=E*G-C*z,Oe=E*W-D*z,Ue=C*W-D*G,Ge=H*ce-q*he,Ne=H*le-Y*he,rt=H*Te-ie*he,mt=q*le-Y*ce,it=q*Te-ie*ce,Bt=Y*Te-ie*le,Mt=de*Bt-Se*it+Pe*mt+Me*rt-Oe*Ne+Ue*Ge;return Mt?(x[0]=(z*Bt-G*it+W*mt)*(Mt=1/Mt),x[1]=(C*it-E*Bt-D*mt)*Mt,x[2]=(ce*Ue-le*Oe+Te*Me)*Mt,x[3]=(Y*Oe-q*Ue-ie*Me)*Mt,x[4]=(G*rt-N*Bt-W*Ne)*Mt,x[5]=(R*Bt-C*rt+D*Ne)*Mt,x[6]=(le*Pe-he*Ue-Te*Se)*Mt,x[7]=(H*Ue-Y*Pe+ie*Se)*Mt,x[8]=(N*it-z*rt+W*Ge)*Mt,x[9]=(E*rt-R*it-D*Ge)*Mt,x[10]=(he*Oe-ce*Pe+Te*de)*Mt,x[11]=(q*Pe-H*Oe-ie*de)*Mt,x[12]=(z*Ne-N*mt-G*Ge)*Mt,x[13]=(R*mt-E*Ne+C*Ge)*Mt,x[14]=(ce*Se-he*Me-le*de)*Mt,x[15]=(H*Me-q*Se+Y*de)*Mt,x):null},Ye.adjoint=function(x,I){var R=I[0],E=I[1],C=I[2],D=I[3],N=I[4],z=I[5],G=I[6],W=I[7],H=I[8],q=I[9],Y=I[10],ie=I[11],he=I[12],ce=I[13],le=I[14],Te=I[15];return x[0]=z*(Y*Te-ie*le)-q*(G*Te-W*le)+ce*(G*ie-W*Y),x[1]=-(E*(Y*Te-ie*le)-q*(C*Te-D*le)+ce*(C*ie-D*Y)),x[2]=E*(G*Te-W*le)-z*(C*Te-D*le)+ce*(C*W-D*G),x[3]=-(E*(G*ie-W*Y)-z*(C*ie-D*Y)+q*(C*W-D*G)),x[4]=-(N*(Y*Te-ie*le)-H*(G*Te-W*le)+he*(G*ie-W*Y)),x[5]=R*(Y*Te-ie*le)-H*(C*Te-D*le)+he*(C*ie-D*Y),x[6]=-(R*(G*Te-W*le)-N*(C*Te-D*le)+he*(C*W-D*G)),x[7]=R*(G*ie-W*Y)-N*(C*ie-D*Y)+H*(C*W-D*G),x[8]=N*(q*Te-ie*ce)-H*(z*Te-W*ce)+he*(z*ie-W*q),x[9]=-(R*(q*Te-ie*ce)-H*(E*Te-D*ce)+he*(E*ie-D*q)),x[10]=R*(z*Te-W*ce)-N*(E*Te-D*ce)+he*(E*W-D*z),x[11]=-(R*(z*ie-W*q)-N*(E*ie-D*q)+H*(E*W-D*z)),x[12]=-(N*(q*le-Y*ce)-H*(z*le-G*ce)+he*(z*Y-G*q)),x[13]=R*(q*le-Y*ce)-H*(E*le-C*ce)+he*(E*Y-C*q),x[14]=-(R*(z*le-G*ce)-N*(E*le-C*ce)+he*(E*G-C*z)),x[15]=R*(z*Y-G*q)-N*(E*Y-C*q)+H*(E*G-C*z),x},Ye.determinant=function(x){var I=x[0],R=x[1],E=x[2],C=x[3],D=x[4],N=x[5],z=x[6],G=x[7],W=x[8],H=x[9],q=x[10],Y=x[11],ie=x[12],he=x[13],ce=x[14],le=x[15];return(I*N-R*D)*(q*le-Y*ce)-(I*z-E*D)*(H*le-Y*he)+(I*G-C*D)*(H*ce-q*he)+(R*z-E*N)*(W*le-Y*ie)-(R*G-C*N)*(W*ce-q*ie)+(E*G-C*z)*(W*he-H*ie)},Ye.multiply=_,Ye.translate=function(x,I,R){var E,C,D,N,z,G,W,H,q,Y,ie,he,ce=R[0],le=R[1],Te=R[2];return I===x?(x[12]=I[0]*ce+I[4]*le+I[8]*Te+I[12],x[13]=I[1]*ce+I[5]*le+I[9]*Te+I[13],x[14]=I[2]*ce+I[6]*le+I[10]*Te+I[14],x[15]=I[3]*ce+I[7]*le+I[11]*Te+I[15]):(C=I[1],D=I[2],N=I[3],z=I[4],G=I[5],W=I[6],H=I[7],q=I[8],Y=I[9],ie=I[10],he=I[11],x[0]=E=I[0],x[1]=C,x[2]=D,x[3]=N,x[4]=z,x[5]=G,x[6]=W,x[7]=H,x[8]=q,x[9]=Y,x[10]=ie,x[11]=he,x[12]=E*ce+z*le+q*Te+I[12],x[13]=C*ce+G*le+Y*Te+I[13],x[14]=D*ce+W*le+ie*Te+I[14],x[15]=N*ce+H*le+he*Te+I[15]),x},Ye.scale=function(x,I,R){var E=R[0],C=R[1],D=R[2];return x[0]=I[0]*E,x[1]=I[1]*E,x[2]=I[2]*E,x[3]=I[3]*E,x[4]=I[4]*C,x[5]=I[5]*C,x[6]=I[6]*C,x[7]=I[7]*C,x[8]=I[8]*D,x[9]=I[9]*D,x[10]=I[10]*D,x[11]=I[11]*D,x[12]=I[12],x[13]=I[13],x[14]=I[14],x[15]=I[15],x},Ye.rotate=function(x,I,R,E){var C,D,N,z,G,W,H,q,Y,ie,he,ce,le,Te,de,Se,Pe,Me,Oe,Ue,Ge,Ne,rt,mt,it=E[0],Bt=E[1],Mt=E[2],bt=Math.hypot(it,Bt,Mt);return bt<n.EPSILON?null:(it*=bt=1/bt,Bt*=bt,Mt*=bt,C=Math.sin(R),D=Math.cos(R),G=I[1],W=I[2],H=I[3],Y=I[5],ie=I[6],he=I[7],le=I[9],Te=I[10],de=I[11],Se=it*it*(N=1-D)+D,Oe=it*Bt*N-Mt*C,Ue=Bt*Bt*N+D,Ge=Mt*Bt*N+it*C,Ne=it*Mt*N+Bt*C,rt=Bt*Mt*N-it*C,mt=Mt*Mt*N+D,x[0]=(z=I[0])*Se+(q=I[4])*(Pe=Bt*it*N+Mt*C)+(ce=I[8])*(Me=Mt*it*N-Bt*C),x[1]=G*Se+Y*Pe+le*Me,x[2]=W*Se+ie*Pe+Te*Me,x[3]=H*Se+he*Pe+de*Me,x[4]=z*Oe+q*Ue+ce*Ge,x[5]=G*Oe+Y*Ue+le*Ge,x[6]=W*Oe+ie*Ue+Te*Ge,x[7]=H*Oe+he*Ue+de*Ge,x[8]=z*Ne+q*rt+ce*mt,x[9]=G*Ne+Y*rt+le*mt,x[10]=W*Ne+ie*rt+Te*mt,x[11]=H*Ne+he*rt+de*mt,I!==x&&(x[12]=I[12],x[13]=I[13],x[14]=I[14],x[15]=I[15]),x)},Ye.rotateX=function(x,I,R){var E=Math.sin(R),C=Math.cos(R),D=I[4],N=I[5],z=I[6],G=I[7],W=I[8],H=I[9],q=I[10],Y=I[11];return I!==x&&(x[0]=I[0],x[1]=I[1],x[2]=I[2],x[3]=I[3],x[12]=I[12],x[13]=I[13],x[14]=I[14],x[15]=I[15]),x[4]=D*C+W*E,x[5]=N*C+H*E,x[6]=z*C+q*E,x[7]=G*C+Y*E,x[8]=W*C-D*E,x[9]=H*C-N*E,x[10]=q*C-z*E,x[11]=Y*C-G*E,x},Ye.rotateY=function(x,I,R){var E=Math.sin(R),C=Math.cos(R),D=I[0],N=I[1],z=I[2],G=I[3],W=I[8],H=I[9],q=I[10],Y=I[11];return I!==x&&(x[4]=I[4],x[5]=I[5],x[6]=I[6],x[7]=I[7],x[12]=I[12],x[13]=I[13],x[14]=I[14],x[15]=I[15]),x[0]=D*C-W*E,x[1]=N*C-H*E,x[2]=z*C-q*E,x[3]=G*C-Y*E,x[8]=D*E+W*C,x[9]=N*E+H*C,x[10]=z*E+q*C,x[11]=G*E+Y*C,x},Ye.rotateZ=function(x,I,R){var E=Math.sin(R),C=Math.cos(R),D=I[0],N=I[1],z=I[2],G=I[3],W=I[4],H=I[5],q=I[6],Y=I[7];return I!==x&&(x[8]=I[8],x[9]=I[9],x[10]=I[10],x[11]=I[11],x[12]=I[12],x[13]=I[13],x[14]=I[14],x[15]=I[15]),x[0]=D*C+W*E,x[1]=N*C+H*E,x[2]=z*C+q*E,x[3]=G*C+Y*E,x[4]=W*C-D*E,x[5]=H*C-N*E,x[6]=q*C-z*E,x[7]=Y*C-G*E,x},Ye.fromTranslation=function(x,I){return x[0]=1,x[1]=0,x[2]=0,x[3]=0,x[4]=0,x[5]=1,x[6]=0,x[7]=0,x[8]=0,x[9]=0,x[10]=1,x[11]=0,x[12]=I[0],x[13]=I[1],x[14]=I[2],x[15]=1,x},Ye.fromScaling=function(x,I){return x[0]=I[0],x[1]=0,x[2]=0,x[3]=0,x[4]=0,x[5]=I[1],x[6]=0,x[7]=0,x[8]=0,x[9]=0,x[10]=I[2],x[11]=0,x[12]=0,x[13]=0,x[14]=0,x[15]=1,x},Ye.fromRotation=function(x,I,R){var E,C,D,N=R[0],z=R[1],G=R[2],W=Math.hypot(N,z,G);return W<n.EPSILON?null:(N*=W=1/W,z*=W,G*=W,E=Math.sin(I),C=Math.cos(I),x[0]=N*N*(D=1-C)+C,x[1]=z*N*D+G*E,x[2]=G*N*D-z*E,x[3]=0,x[4]=N*z*D-G*E,x[5]=z*z*D+C,x[6]=G*z*D+N*E,x[7]=0,x[8]=N*G*D+z*E,x[9]=z*G*D-N*E,x[10]=G*G*D+C,x[11]=0,x[12]=0,x[13]=0,x[14]=0,x[15]=1,x)},Ye.fromXRotation=function(x,I){var R=Math.sin(I),E=Math.cos(I);return x[0]=1,x[1]=0,x[2]=0,x[3]=0,x[4]=0,x[5]=E,x[6]=R,x[7]=0,x[8]=0,x[9]=-R,x[10]=E,x[11]=0,x[12]=0,x[13]=0,x[14]=0,x[15]=1,x},Ye.fromYRotation=function(x,I){var R=Math.sin(I),E=Math.cos(I);return x[0]=E,x[1]=0,x[2]=-R,x[3]=0,x[4]=0,x[5]=1,x[6]=0,x[7]=0,x[8]=R,x[9]=0,x[10]=E,x[11]=0,x[12]=0,x[13]=0,x[14]=0,x[15]=1,x},Ye.fromZRotation=function(x,I){var R=Math.sin(I),E=Math.cos(I);return x[0]=E,x[1]=R,x[2]=0,x[3]=0,x[4]=-R,x[5]=E,x[6]=0,x[7]=0,x[8]=0,x[9]=0,x[10]=1,x[11]=0,x[12]=0,x[13]=0,x[14]=0,x[15]=1,x},Ye.fromRotationTranslation=f,Ye.fromQuat2=function(x,I){var R=new n.ARRAY_TYPE(3),E=-I[0],C=-I[1],D=-I[2],N=I[3],z=I[4],G=I[5],W=I[6],H=I[7],q=E*E+C*C+D*D+N*N;return q>0?(R[0]=2*(z*N+H*E+G*D-W*C)/q,R[1]=2*(G*N+H*C+W*E-z*D)/q,R[2]=2*(W*N+H*D+z*C-G*E)/q):(R[0]=2*(z*N+H*E+G*D-W*C),R[1]=2*(G*N+H*C+W*E-z*D),R[2]=2*(W*N+H*D+z*C-G*E)),f(x,I,R),x},Ye.getTranslation=function(x,I){return x[0]=I[12],x[1]=I[13],x[2]=I[14],x},Ye.getScaling=g,Ye.getRotation=function(x,I){var R=new n.ARRAY_TYPE(3);g(R,I);var E=1/R[0],C=1/R[1],D=1/R[2],N=I[0]*E,z=I[1]*C,G=I[2]*D,W=I[4]*E,H=I[5]*C,q=I[6]*D,Y=I[8]*E,ie=I[9]*C,he=I[10]*D,ce=N+H+he,le=0;return ce>0?(le=2*Math.sqrt(ce+1),x[3]=.25*le,x[0]=(q-ie)/le,x[1]=(Y-G)/le,x[2]=(z-W)/le):N>H&&N>he?(le=2*Math.sqrt(1+N-H-he),x[3]=(q-ie)/le,x[0]=.25*le,x[1]=(z+W)/le,x[2]=(Y+G)/le):H>he?(le=2*Math.sqrt(1+H-N-he),x[3]=(Y-G)/le,x[0]=(z+W)/le,x[1]=.25*le,x[2]=(q+ie)/le):(le=2*Math.sqrt(1+he-N-H),x[3]=(z-W)/le,x[0]=(Y+G)/le,x[1]=(q+ie)/le,x[2]=.25*le),x},Ye.fromRotationTranslationScale=function(x,I,R,E){var C=I[0],D=I[1],N=I[2],z=I[3],G=C+C,W=D+D,H=N+N,q=C*G,Y=C*W,ie=C*H,he=D*W,ce=D*H,le=N*H,Te=z*G,de=z*W,Se=z*H,Pe=E[0],Me=E[1],Oe=E[2];return x[0]=(1-(he+le))*Pe,x[1]=(Y+Se)*Pe,x[2]=(ie-de)*Pe,x[3]=0,x[4]=(Y-Se)*Me,x[5]=(1-(q+le))*Me,x[6]=(ce+Te)*Me,x[7]=0,x[8]=(ie+de)*Oe,x[9]=(ce-Te)*Oe,x[10]=(1-(q+he))*Oe,x[11]=0,x[12]=R[0],x[13]=R[1],x[14]=R[2],x[15]=1,x},Ye.fromRotationTranslationScaleOrigin=function(x,I,R,E,C){var D=I[0],N=I[1],z=I[2],G=I[3],W=D+D,H=N+N,q=z+z,Y=D*W,ie=D*H,he=D*q,ce=N*H,le=N*q,Te=z*q,de=G*W,Se=G*H,Pe=G*q,Me=E[0],Oe=E[1],Ue=E[2],Ge=C[0],Ne=C[1],rt=C[2],mt=(1-(ce+Te))*Me,it=(ie+Pe)*Me,Bt=(he-Se)*Me,Mt=(ie-Pe)*Oe,bt=(1-(Y+Te))*Oe,_t=(le+de)*Oe,Ht=(he+Se)*Ue,Ft=(le-de)*Ue,zt=(1-(Y+ce))*Ue;return x[0]=mt,x[1]=it,x[2]=Bt,x[3]=0,x[4]=Mt,x[5]=bt,x[6]=_t,x[7]=0,x[8]=Ht,x[9]=Ft,x[10]=zt,x[11]=0,x[12]=R[0]+Ge-(mt*Ge+Mt*Ne+Ht*rt),x[13]=R[1]+Ne-(it*Ge+bt*Ne+Ft*rt),x[14]=R[2]+rt-(Bt*Ge+_t*Ne+zt*rt),x[15]=1,x},Ye.fromQuat=function(x,I){var R=I[0],E=I[1],C=I[2],D=I[3],N=R+R,z=E+E,G=C+C,W=R*N,H=E*N,q=E*z,Y=C*N,ie=C*z,he=C*G,ce=D*N,le=D*z,Te=D*G;return x[0]=1-q-he,x[1]=H+Te,x[2]=Y-le,x[3]=0,x[4]=H-Te,x[5]=1-W-he,x[6]=ie+ce,x[7]=0,x[8]=Y+le,x[9]=ie-ce,x[10]=1-W-q,x[11]=0,x[12]=0,x[13]=0,x[14]=0,x[15]=1,x},Ye.frustum=function(x,I,R,E,C,D,N){var z=1/(R-I),G=1/(C-E),W=1/(D-N);return x[0]=2*D*z,x[1]=0,x[2]=0,x[3]=0,x[4]=0,x[5]=2*D*G,x[6]=0,x[7]=0,x[8]=(R+I)*z,x[9]=(C+E)*G,x[10]=(N+D)*W,x[11]=-1,x[12]=0,x[13]=0,x[14]=N*D*2*W,x[15]=0,x},Ye.perspectiveNO=w,Ye.perspectiveZO=function(x,I,R,E,C){var D,N=1/Math.tan(I/2);return x[0]=N/R,x[1]=0,x[2]=0,x[3]=0,x[4]=0,x[5]=N,x[6]=0,x[7]=0,x[8]=0,x[9]=0,x[11]=-1,x[12]=0,x[13]=0,x[15]=0,C!=null&&C!==1/0?(x[10]=C*(D=1/(E-C)),x[14]=C*E*D):(x[10]=-1,x[14]=-E),x},Ye.perspectiveFromFieldOfView=function(x,I,R,E){var C=Math.tan(I.upDegrees*Math.PI/180),D=Math.tan(I.downDegrees*Math.PI/180),N=Math.tan(I.leftDegrees*Math.PI/180),z=Math.tan(I.rightDegrees*Math.PI/180),G=2/(N+z),W=2/(C+D);return x[0]=G,x[1]=0,x[2]=0,x[3]=0,x[4]=0,x[5]=W,x[6]=0,x[7]=0,x[8]=-(N-z)*G*.5,x[9]=(C-D)*W*.5,x[10]=E/(R-E),x[11]=-1,x[12]=0,x[13]=0,x[14]=E*R/(R-E),x[15]=0,x},Ye.orthoNO=S,Ye.orthoZO=function(x,I,R,E,C,D,N){var z=1/(I-R),G=1/(E-C),W=1/(D-N);return x[0]=-2*z,x[1]=0,x[2]=0,x[3]=0,x[4]=0,x[5]=-2*G,x[6]=0,x[7]=0,x[8]=0,x[9]=0,x[10]=W,x[11]=0,x[12]=(I+R)*z,x[13]=(C+E)*G,x[14]=D*W,x[15]=1,x},Ye.lookAt=function(x,I,R,E){var C,D,N,z,G,W,H,q,Y,ie,he=I[0],ce=I[1],le=I[2],Te=E[0],de=E[1],Se=E[2],Pe=R[0],Me=R[1],Oe=R[2];return Math.abs(he-Pe)<n.EPSILON&&Math.abs(ce-Me)<n.EPSILON&&Math.abs(le-Oe)<n.EPSILON?d(x):(H=he-Pe,q=ce-Me,Y=le-Oe,C=de*(Y*=ie=1/Math.hypot(H,q,Y))-Se*(q*=ie),D=Se*(H*=ie)-Te*Y,N=Te*q-de*H,(ie=Math.hypot(C,D,N))?(C*=ie=1/ie,D*=ie,N*=ie):(C=0,D=0,N=0),z=q*N-Y*D,G=Y*C-H*N,W=H*D-q*C,(ie=Math.hypot(z,G,W))?(z*=ie=1/ie,G*=ie,W*=ie):(z=0,G=0,W=0),x[0]=C,x[1]=z,x[2]=H,x[3]=0,x[4]=D,x[5]=G,x[6]=q,x[7]=0,x[8]=N,x[9]=W,x[10]=Y,x[11]=0,x[12]=-(C*he+D*ce+N*le),x[13]=-(z*he+G*ce+W*le),x[14]=-(H*he+q*ce+Y*le),x[15]=1,x)},Ye.targetTo=function(x,I,R,E){var C=I[0],D=I[1],N=I[2],z=E[0],G=E[1],W=E[2],H=C-R[0],q=D-R[1],Y=N-R[2],ie=H*H+q*q+Y*Y;ie>0&&(H*=ie=1/Math.sqrt(ie),q*=ie,Y*=ie);var he=G*Y-W*q,ce=W*H-z*Y,le=z*q-G*H;return(ie=he*he+ce*ce+le*le)>0&&(he*=ie=1/Math.sqrt(ie),ce*=ie,le*=ie),x[0]=he,x[1]=ce,x[2]=le,x[3]=0,x[4]=q*le-Y*ce,x[5]=Y*he-H*le,x[6]=H*ce-q*he,x[7]=0,x[8]=H,x[9]=q,x[10]=Y,x[11]=0,x[12]=C,x[13]=D,x[14]=N,x[15]=1,x},Ye.str=function(x){return"mat4("+x[0]+", "+x[1]+", "+x[2]+", "+x[3]+", "+x[4]+", "+x[5]+", "+x[6]+", "+x[7]+", "+x[8]+", "+x[9]+", "+x[10]+", "+x[11]+", "+x[12]+", "+x[13]+", "+x[14]+", "+x[15]+")"},Ye.frob=function(x){return Math.hypot(x[0],x[1],x[2],x[3],x[4],x[5],x[6],x[7],x[8],x[9],x[10],x[11],x[12],x[13],x[14],x[15])},Ye.add=function(x,I,R){return x[0]=I[0]+R[0],x[1]=I[1]+R[1],x[2]=I[2]+R[2],x[3]=I[3]+R[3],x[4]=I[4]+R[4],x[5]=I[5]+R[5],x[6]=I[6]+R[6],x[7]=I[7]+R[7],x[8]=I[8]+R[8],x[9]=I[9]+R[9],x[10]=I[10]+R[10],x[11]=I[11]+R[11],x[12]=I[12]+R[12],x[13]=I[13]+R[13],x[14]=I[14]+R[14],x[15]=I[15]+R[15],x},Ye.subtract=P,Ye.multiplyScalar=function(x,I,R){return x[0]=I[0]*R,x[1]=I[1]*R,x[2]=I[2]*R,x[3]=I[3]*R,x[4]=I[4]*R,x[5]=I[5]*R,x[6]=I[6]*R,x[7]=I[7]*R,x[8]=I[8]*R,x[9]=I[9]*R,x[10]=I[10]*R,x[11]=I[11]*R,x[12]=I[12]*R,x[13]=I[13]*R,x[14]=I[14]*R,x[15]=I[15]*R,x},Ye.multiplyScalarAndAdd=function(x,I,R,E){return x[0]=I[0]+R[0]*E,x[1]=I[1]+R[1]*E,x[2]=I[2]+R[2]*E,x[3]=I[3]+R[3]*E,x[4]=I[4]+R[4]*E,x[5]=I[5]+R[5]*E,x[6]=I[6]+R[6]*E,x[7]=I[7]+R[7]*E,x[8]=I[8]+R[8]*E,x[9]=I[9]+R[9]*E,x[10]=I[10]+R[10]*E,x[11]=I[11]+R[11]*E,x[12]=I[12]+R[12]*E,x[13]=I[13]+R[13]*E,x[14]=I[14]+R[14]*E,x[15]=I[15]+R[15]*E,x},Ye.exactEquals=function(x,I){return x[0]===I[0]&&x[1]===I[1]&&x[2]===I[2]&&x[3]===I[3]&&x[4]===I[4]&&x[5]===I[5]&&x[6]===I[6]&&x[7]===I[7]&&x[8]===I[8]&&x[9]===I[9]&&x[10]===I[10]&&x[11]===I[11]&&x[12]===I[12]&&x[13]===I[13]&&x[14]===I[14]&&x[15]===I[15]},Ye.equals=function(x,I){var R=x[0],E=x[1],C=x[2],D=x[3],N=x[4],z=x[5],G=x[6],W=x[7],H=x[8],q=x[9],Y=x[10],ie=x[11],he=x[12],ce=x[13],le=x[14],Te=x[15],de=I[0],Se=I[1],Pe=I[2],Me=I[3],Oe=I[4],Ue=I[5],Ge=I[6],Ne=I[7],rt=I[8],mt=I[9],it=I[10],Bt=I[11],Mt=I[12],bt=I[13],_t=I[14],Ht=I[15];return Math.abs(R-de)<=n.EPSILON*Math.max(1,Math.abs(R),Math.abs(de))&&Math.abs(E-Se)<=n.EPSILON*Math.max(1,Math.abs(E),Math.abs(Se))&&Math.abs(C-Pe)<=n.EPSILON*Math.max(1,Math.abs(C),Math.abs(Pe))&&Math.abs(D-Me)<=n.EPSILON*Math.max(1,Math.abs(D),Math.abs(Me))&&Math.abs(N-Oe)<=n.EPSILON*Math.max(1,Math.abs(N),Math.abs(Oe))&&Math.abs(z-Ue)<=n.EPSILON*Math.max(1,Math.abs(z),Math.abs(Ue))&&Math.abs(G-Ge)<=n.EPSILON*Math.max(1,Math.abs(G),Math.abs(Ge))&&Math.abs(W-Ne)<=n.EPSILON*Math.max(1,Math.abs(W),Math.abs(Ne))&&Math.abs(H-rt)<=n.EPSILON*Math.max(1,Math.abs(H),Math.abs(rt))&&Math.abs(q-mt)<=n.EPSILON*Math.max(1,Math.abs(q),Math.abs(mt))&&Math.abs(Y-it)<=n.EPSILON*Math.max(1,Math.abs(Y),Math.abs(it))&&Math.abs(ie-Bt)<=n.EPSILON*Math.max(1,Math.abs(ie),Math.abs(Bt))&&Math.abs(he-Mt)<=n.EPSILON*Math.max(1,Math.abs(he),Math.abs(Mt))&&Math.abs(ce-bt)<=n.EPSILON*Math.max(1,Math.abs(ce),Math.abs(bt))&&Math.abs(le-_t)<=n.EPSILON*Math.max(1,Math.abs(le),Math.abs(_t))&&Math.abs(Te-Ht)<=n.EPSILON*Math.max(1,Math.abs(Te),Math.abs(Ht))},Ye.sub=Ye.mul=Ye.ortho=Ye.perspective=void 0;var n=function(x,I){if(x&&x.__esModule)return x;if(x===null||u(x)!=="object"&&typeof x!="function")return{default:x};var R=l(void 0);if(R&&R.has(x))return R.get(x);var E={},C=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var D in x)if(D!=="default"&&Object.prototype.hasOwnProperty.call(x,D)){var N=C?Object.getOwnPropertyDescriptor(x,D):null;N&&(N.get||N.set)?Object.defineProperty(E,D,N):E[D]=x[D]}return E.default=x,R&&R.set(x,E),E}(X());function l(x){if(typeof WeakMap!="function")return null;var I=new WeakMap,R=new WeakMap;return(l=function(E){return E?R:I})(x)}function d(x){return x[0]=1,x[1]=0,x[2]=0,x[3]=0,x[4]=0,x[5]=1,x[6]=0,x[7]=0,x[8]=0,x[9]=0,x[10]=1,x[11]=0,x[12]=0,x[13]=0,x[14]=0,x[15]=1,x}function _(x,I,R){var E=I[0],C=I[1],D=I[2],N=I[3],z=I[4],G=I[5],W=I[6],H=I[7],q=I[8],Y=I[9],ie=I[10],he=I[11],ce=I[12],le=I[13],Te=I[14],de=I[15],Se=R[0],Pe=R[1],Me=R[2],Oe=R[3];return x[0]=Se*E+Pe*z+Me*q+Oe*ce,x[1]=Se*C+Pe*G+Me*Y+Oe*le,x[2]=Se*D+Pe*W+Me*ie+Oe*Te,x[3]=Se*N+Pe*H+Me*he+Oe*de,x[4]=(Se=R[4])*E+(Pe=R[5])*z+(Me=R[6])*q+(Oe=R[7])*ce,x[5]=Se*C+Pe*G+Me*Y+Oe*le,x[6]=Se*D+Pe*W+Me*ie+Oe*Te,x[7]=Se*N+Pe*H+Me*he+Oe*de,x[8]=(Se=R[8])*E+(Pe=R[9])*z+(Me=R[10])*q+(Oe=R[11])*ce,x[9]=Se*C+Pe*G+Me*Y+Oe*le,x[10]=Se*D+Pe*W+Me*ie+Oe*Te,x[11]=Se*N+Pe*H+Me*he+Oe*de,x[12]=(Se=R[12])*E+(Pe=R[13])*z+(Me=R[14])*q+(Oe=R[15])*ce,x[13]=Se*C+Pe*G+Me*Y+Oe*le,x[14]=Se*D+Pe*W+Me*ie+Oe*Te,x[15]=Se*N+Pe*H+Me*he+Oe*de,x}function f(x,I,R){var E=I[0],C=I[1],D=I[2],N=I[3],z=E+E,G=C+C,W=D+D,H=E*z,q=E*G,Y=E*W,ie=C*G,he=C*W,ce=D*W,le=N*z,Te=N*G,de=N*W;return x[0]=1-(ie+ce),x[1]=q+de,x[2]=Y-Te,x[3]=0,x[4]=q-de,x[5]=1-(H+ce),x[6]=he+le,x[7]=0,x[8]=Y+Te,x[9]=he-le,x[10]=1-(H+ie),x[11]=0,x[12]=R[0],x[13]=R[1],x[14]=R[2],x[15]=1,x}function g(x,I){var R=I[4],E=I[5],C=I[6],D=I[8],N=I[9],z=I[10];return x[0]=Math.hypot(I[0],I[1],I[2]),x[1]=Math.hypot(R,E,C),x[2]=Math.hypot(D,N,z),x}function w(x,I,R,E,C){var D,N=1/Math.tan(I/2);return x[0]=N/R,x[1]=0,x[2]=0,x[3]=0,x[4]=0,x[5]=N,x[6]=0,x[7]=0,x[8]=0,x[9]=0,x[11]=-1,x[12]=0,x[13]=0,x[15]=0,C!=null&&C!==1/0?(x[10]=(C+E)*(D=1/(E-C)),x[14]=2*C*E*D):(x[10]=-1,x[14]=-2*E),x}function S(x,I,R,E,C,D,N){var z=1/(I-R),G=1/(E-C),W=1/(D-N);return x[0]=-2*z,x[1]=0,x[2]=0,x[3]=0,x[4]=0,x[5]=-2*G,x[6]=0,x[7]=0,x[8]=0,x[9]=0,x[10]=2*W,x[11]=0,x[12]=(I+R)*z,x[13]=(C+E)*G,x[14]=(N+D)*W,x[15]=1,x}function P(x,I,R){return x[0]=I[0]-R[0],x[1]=I[1]-R[1],x[2]=I[2]-R[2],x[3]=I[3]-R[3],x[4]=I[4]-R[4],x[5]=I[5]-R[5],x[6]=I[6]-R[6],x[7]=I[7]-R[7],x[8]=I[8]-R[8],x[9]=I[9]-R[9],x[10]=I[10]-R[10],x[11]=I[11]-R[11],x[12]=I[12]-R[12],x[13]=I[13]-R[13],x[14]=I[14]-R[14],x[15]=I[15]-R[15],x}return Ye.perspective=w,Ye.ortho=S,Ye.mul=_,Ye.sub=P,Ye}var Pt,vt={},yt={};function hi(){if(Pt)return yt;function u(C){return u=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(D){return typeof D}:function(D){return D&&typeof Symbol=="function"&&D.constructor===Symbol&&D!==Symbol.prototype?"symbol":typeof D},u(C)}Pt=1,Object.defineProperty(yt,"__esModule",{value:!0}),yt.create=d,yt.clone=function(C){var D=new n.ARRAY_TYPE(3);return D[0]=C[0],D[1]=C[1],D[2]=C[2],D},yt.length=_,yt.fromValues=function(C,D,N){var z=new n.ARRAY_TYPE(3);return z[0]=C,z[1]=D,z[2]=N,z},yt.copy=function(C,D){return C[0]=D[0],C[1]=D[1],C[2]=D[2],C},yt.set=function(C,D,N,z){return C[0]=D,C[1]=N,C[2]=z,C},yt.add=function(C,D,N){return C[0]=D[0]+N[0],C[1]=D[1]+N[1],C[2]=D[2]+N[2],C},yt.subtract=f,yt.multiply=g,yt.divide=w,yt.ceil=function(C,D){return C[0]=Math.ceil(D[0]),C[1]=Math.ceil(D[1]),C[2]=Math.ceil(D[2]),C},yt.floor=function(C,D){return C[0]=Math.floor(D[0]),C[1]=Math.floor(D[1]),C[2]=Math.floor(D[2]),C},yt.min=function(C,D,N){return C[0]=Math.min(D[0],N[0]),C[1]=Math.min(D[1],N[1]),C[2]=Math.min(D[2],N[2]),C},yt.max=function(C,D,N){return C[0]=Math.max(D[0],N[0]),C[1]=Math.max(D[1],N[1]),C[2]=Math.max(D[2],N[2]),C},yt.round=function(C,D){return C[0]=Math.round(D[0]),C[1]=Math.round(D[1]),C[2]=Math.round(D[2]),C},yt.scale=function(C,D,N){return C[0]=D[0]*N,C[1]=D[1]*N,C[2]=D[2]*N,C},yt.scaleAndAdd=function(C,D,N,z){return C[0]=D[0]+N[0]*z,C[1]=D[1]+N[1]*z,C[2]=D[2]+N[2]*z,C},yt.distance=S,yt.squaredDistance=P,yt.squaredLength=x,yt.negate=function(C,D){return C[0]=-D[0],C[1]=-D[1],C[2]=-D[2],C},yt.inverse=function(C,D){return C[0]=1/D[0],C[1]=1/D[1],C[2]=1/D[2],C},yt.normalize=function(C,D){var N=D[0],z=D[1],G=D[2],W=N*N+z*z+G*G;return W>0&&(W=1/Math.sqrt(W)),C[0]=D[0]*W,C[1]=D[1]*W,C[2]=D[2]*W,C},yt.dot=I,yt.cross=function(C,D,N){var z=D[0],G=D[1],W=D[2],H=N[0],q=N[1],Y=N[2];return C[0]=G*Y-W*q,C[1]=W*H-z*Y,C[2]=z*q-G*H,C},yt.lerp=function(C,D,N,z){var G=D[0],W=D[1],H=D[2];return C[0]=G+z*(N[0]-G),C[1]=W+z*(N[1]-W),C[2]=H+z*(N[2]-H),C},yt.hermite=function(C,D,N,z,G,W){var H=W*W,q=H*(2*W-3)+1,Y=H*(W-2)+W,ie=H*(W-1),he=H*(3-2*W);return C[0]=D[0]*q+N[0]*Y+z[0]*ie+G[0]*he,C[1]=D[1]*q+N[1]*Y+z[1]*ie+G[1]*he,C[2]=D[2]*q+N[2]*Y+z[2]*ie+G[2]*he,C},yt.bezier=function(C,D,N,z,G,W){var H=1-W,q=H*H,Y=W*W,ie=q*H,he=3*W*q,ce=3*Y*H,le=Y*W;return C[0]=D[0]*ie+N[0]*he+z[0]*ce+G[0]*le,C[1]=D[1]*ie+N[1]*he+z[1]*ce+G[1]*le,C[2]=D[2]*ie+N[2]*he+z[2]*ce+G[2]*le,C},yt.random=function(C,D){D=D||1;var N=2*n.RANDOM()*Math.PI,z=2*n.RANDOM()-1,G=Math.sqrt(1-z*z)*D;return C[0]=Math.cos(N)*G,C[1]=Math.sin(N)*G,C[2]=z*D,C},yt.transformMat4=function(C,D,N){var z=D[0],G=D[1],W=D[2],H=N[3]*z+N[7]*G+N[11]*W+N[15];return C[0]=(N[0]*z+N[4]*G+N[8]*W+N[12])/(H=H||1),C[1]=(N[1]*z+N[5]*G+N[9]*W+N[13])/H,C[2]=(N[2]*z+N[6]*G+N[10]*W+N[14])/H,C},yt.transformMat3=function(C,D,N){var z=D[0],G=D[1],W=D[2];return C[0]=z*N[0]+G*N[3]+W*N[6],C[1]=z*N[1]+G*N[4]+W*N[7],C[2]=z*N[2]+G*N[5]+W*N[8],C},yt.transformQuat=function(C,D,N){var z=N[0],G=N[1],W=N[2],H=D[0],q=D[1],Y=D[2],ie=G*Y-W*q,he=W*H-z*Y,ce=z*q-G*H,le=G*ce-W*he,Te=W*ie-z*ce,de=z*he-G*ie,Se=2*N[3];return he*=Se,ce*=Se,Te*=2,de*=2,C[0]=H+(ie*=Se)+(le*=2),C[1]=q+he+Te,C[2]=Y+ce+de,C},yt.rotateX=function(C,D,N,z){var G=[],W=[];return G[0]=D[0]-N[0],G[1]=D[1]-N[1],G[2]=D[2]-N[2],W[0]=G[0],W[1]=G[1]*Math.cos(z)-G[2]*Math.sin(z),W[2]=G[1]*Math.sin(z)+G[2]*Math.cos(z),C[0]=W[0]+N[0],C[1]=W[1]+N[1],C[2]=W[2]+N[2],C},yt.rotateY=function(C,D,N,z){var G=[],W=[];return G[0]=D[0]-N[0],G[1]=D[1]-N[1],G[2]=D[2]-N[2],W[0]=G[2]*Math.sin(z)+G[0]*Math.cos(z),W[1]=G[1],W[2]=G[2]*Math.cos(z)-G[0]*Math.sin(z),C[0]=W[0]+N[0],C[1]=W[1]+N[1],C[2]=W[2]+N[2],C},yt.rotateZ=function(C,D,N,z){var G=[],W=[];return G[0]=D[0]-N[0],G[1]=D[1]-N[1],G[2]=D[2]-N[2],W[0]=G[0]*Math.cos(z)-G[1]*Math.sin(z),W[1]=G[0]*Math.sin(z)+G[1]*Math.cos(z),W[2]=G[2],C[0]=W[0]+N[0],C[1]=W[1]+N[1],C[2]=W[2]+N[2],C},yt.angle=function(C,D){var N=C[0],z=C[1],G=C[2],W=D[0],H=D[1],q=D[2],Y=Math.sqrt(N*N+z*z+G*G)*Math.sqrt(W*W+H*H+q*q),ie=Y&&I(C,D)/Y;return Math.acos(Math.min(Math.max(ie,-1),1))},yt.zero=function(C){return C[0]=0,C[1]=0,C[2]=0,C},yt.str=function(C){return"vec3("+C[0]+", "+C[1]+", "+C[2]+")"},yt.exactEquals=function(C,D){return C[0]===D[0]&&C[1]===D[1]&&C[2]===D[2]},yt.equals=function(C,D){var N=C[0],z=C[1],G=C[2],W=D[0],H=D[1],q=D[2];return Math.abs(N-W)<=n.EPSILON*Math.max(1,Math.abs(N),Math.abs(W))&&Math.abs(z-H)<=n.EPSILON*Math.max(1,Math.abs(z),Math.abs(H))&&Math.abs(G-q)<=n.EPSILON*Math.max(1,Math.abs(G),Math.abs(q))},yt.forEach=yt.sqrLen=yt.len=yt.sqrDist=yt.dist=yt.div=yt.mul=yt.sub=void 0;var n=function(C,D){if(C&&C.__esModule)return C;if(C===null||u(C)!=="object"&&typeof C!="function")return{default:C};var N=l(void 0);if(N&&N.has(C))return N.get(C);var z={},G=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var W in C)if(W!=="default"&&Object.prototype.hasOwnProperty.call(C,W)){var H=G?Object.getOwnPropertyDescriptor(C,W):null;H&&(H.get||H.set)?Object.defineProperty(z,W,H):z[W]=C[W]}return z.default=C,N&&N.set(C,z),z}(X());function l(C){if(typeof WeakMap!="function")return null;var D=new WeakMap,N=new WeakMap;return(l=function(z){return z?N:D})(C)}function d(){var C=new n.ARRAY_TYPE(3);return n.ARRAY_TYPE!=Float32Array&&(C[0]=0,C[1]=0,C[2]=0),C}function _(C){return Math.hypot(C[0],C[1],C[2])}function f(C,D,N){return C[0]=D[0]-N[0],C[1]=D[1]-N[1],C[2]=D[2]-N[2],C}function g(C,D,N){return C[0]=D[0]*N[0],C[1]=D[1]*N[1],C[2]=D[2]*N[2],C}function w(C,D,N){return C[0]=D[0]/N[0],C[1]=D[1]/N[1],C[2]=D[2]/N[2],C}function S(C,D){return Math.hypot(D[0]-C[0],D[1]-C[1],D[2]-C[2])}function P(C,D){var N=D[0]-C[0],z=D[1]-C[1],G=D[2]-C[2];return N*N+z*z+G*G}function x(C){var D=C[0],N=C[1],z=C[2];return D*D+N*N+z*z}function I(C,D){return C[0]*D[0]+C[1]*D[1]+C[2]*D[2]}yt.sub=f,yt.mul=g,yt.div=w,yt.dist=S,yt.sqrDist=P,yt.len=_,yt.sqrLen=x;var R,E=(R=d(),function(C,D,N,z,G,W){var H,q;for(D||(D=3),N||(N=0),q=z?Math.min(z*D+N,C.length):C.length,H=N;H<q;H+=D)R[0]=C[H],R[1]=C[H+1],R[2]=C[H+2],G(R,R,W),C[H]=R[0],C[H+1]=R[1],C[H+2]=R[2];return C});return yt.forEach=E,yt}var Pi,Si,qt={};function Br(){if(Pi)return qt;function u(E){return u=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(C){return typeof C}:function(C){return C&&typeof Symbol=="function"&&C.constructor===Symbol&&C!==Symbol.prototype?"symbol":typeof C},u(E)}Pi=1,Object.defineProperty(qt,"__esModule",{value:!0}),qt.create=d,qt.clone=function(E){var C=new n.ARRAY_TYPE(4);return C[0]=E[0],C[1]=E[1],C[2]=E[2],C[3]=E[3],C},qt.fromValues=function(E,C,D,N){var z=new n.ARRAY_TYPE(4);return z[0]=E,z[1]=C,z[2]=D,z[3]=N,z},qt.copy=function(E,C){return E[0]=C[0],E[1]=C[1],E[2]=C[2],E[3]=C[3],E},qt.set=function(E,C,D,N,z){return E[0]=C,E[1]=D,E[2]=N,E[3]=z,E},qt.add=function(E,C,D){return E[0]=C[0]+D[0],E[1]=C[1]+D[1],E[2]=C[2]+D[2],E[3]=C[3]+D[3],E},qt.subtract=_,qt.multiply=f,qt.divide=g,qt.ceil=function(E,C){return E[0]=Math.ceil(C[0]),E[1]=Math.ceil(C[1]),E[2]=Math.ceil(C[2]),E[3]=Math.ceil(C[3]),E},qt.floor=function(E,C){return E[0]=Math.floor(C[0]),E[1]=Math.floor(C[1]),E[2]=Math.floor(C[2]),E[3]=Math.floor(C[3]),E},qt.min=function(E,C,D){return E[0]=Math.min(C[0],D[0]),E[1]=Math.min(C[1],D[1]),E[2]=Math.min(C[2],D[2]),E[3]=Math.min(C[3],D[3]),E},qt.max=function(E,C,D){return E[0]=Math.max(C[0],D[0]),E[1]=Math.max(C[1],D[1]),E[2]=Math.max(C[2],D[2]),E[3]=Math.max(C[3],D[3]),E},qt.round=function(E,C){return E[0]=Math.round(C[0]),E[1]=Math.round(C[1]),E[2]=Math.round(C[2]),E[3]=Math.round(C[3]),E},qt.scale=function(E,C,D){return E[0]=C[0]*D,E[1]=C[1]*D,E[2]=C[2]*D,E[3]=C[3]*D,E},qt.scaleAndAdd=function(E,C,D,N){return E[0]=C[0]+D[0]*N,E[1]=C[1]+D[1]*N,E[2]=C[2]+D[2]*N,E[3]=C[3]+D[3]*N,E},qt.distance=w,qt.squaredDistance=S,qt.length=P,qt.squaredLength=x,qt.negate=function(E,C){return E[0]=-C[0],E[1]=-C[1],E[2]=-C[2],E[3]=-C[3],E},qt.inverse=function(E,C){return E[0]=1/C[0],E[1]=1/C[1],E[2]=1/C[2],E[3]=1/C[3],E},qt.normalize=function(E,C){var D=C[0],N=C[1],z=C[2],G=C[3],W=D*D+N*N+z*z+G*G;return W>0&&(W=1/Math.sqrt(W)),E[0]=D*W,E[1]=N*W,E[2]=z*W,E[3]=G*W,E},qt.dot=function(E,C){return E[0]*C[0]+E[1]*C[1]+E[2]*C[2]+E[3]*C[3]},qt.cross=function(E,C,D,N){var z=D[0]*N[1]-D[1]*N[0],G=D[0]*N[2]-D[2]*N[0],W=D[0]*N[3]-D[3]*N[0],H=D[1]*N[2]-D[2]*N[1],q=D[1]*N[3]-D[3]*N[1],Y=D[2]*N[3]-D[3]*N[2],ie=C[0],he=C[1],ce=C[2],le=C[3];return E[0]=he*Y-ce*q+le*H,E[1]=-ie*Y+ce*W-le*G,E[2]=ie*q-he*W+le*z,E[3]=-ie*H+he*G-ce*z,E},qt.lerp=function(E,C,D,N){var z=C[0],G=C[1],W=C[2],H=C[3];return E[0]=z+N*(D[0]-z),E[1]=G+N*(D[1]-G),E[2]=W+N*(D[2]-W),E[3]=H+N*(D[3]-H),E},qt.random=function(E,C){var D,N,z,G,W,H;C=C||1;do W=(D=2*n.RANDOM()-1)*D+(N=2*n.RANDOM()-1)*N;while(W>=1);do H=(z=2*n.RANDOM()-1)*z+(G=2*n.RANDOM()-1)*G;while(H>=1);var q=Math.sqrt((1-W)/H);return E[0]=C*D,E[1]=C*N,E[2]=C*z*q,E[3]=C*G*q,E},qt.transformMat4=function(E,C,D){var N=C[0],z=C[1],G=C[2],W=C[3];return E[0]=D[0]*N+D[4]*z+D[8]*G+D[12]*W,E[1]=D[1]*N+D[5]*z+D[9]*G+D[13]*W,E[2]=D[2]*N+D[6]*z+D[10]*G+D[14]*W,E[3]=D[3]*N+D[7]*z+D[11]*G+D[15]*W,E},qt.transformQuat=function(E,C,D){var N=C[0],z=C[1],G=C[2],W=D[0],H=D[1],q=D[2],Y=D[3],ie=Y*N+H*G-q*z,he=Y*z+q*N-W*G,ce=Y*G+W*z-H*N,le=-W*N-H*z-q*G;return E[0]=ie*Y+le*-W+he*-q-ce*-H,E[1]=he*Y+le*-H+ce*-W-ie*-q,E[2]=ce*Y+le*-q+ie*-H-he*-W,E[3]=C[3],E},qt.zero=function(E){return E[0]=0,E[1]=0,E[2]=0,E[3]=0,E},qt.str=function(E){return"vec4("+E[0]+", "+E[1]+", "+E[2]+", "+E[3]+")"},qt.exactEquals=function(E,C){return E[0]===C[0]&&E[1]===C[1]&&E[2]===C[2]&&E[3]===C[3]},qt.equals=function(E,C){var D=E[0],N=E[1],z=E[2],G=E[3],W=C[0],H=C[1],q=C[2],Y=C[3];return Math.abs(D-W)<=n.EPSILON*Math.max(1,Math.abs(D),Math.abs(W))&&Math.abs(N-H)<=n.EPSILON*Math.max(1,Math.abs(N),Math.abs(H))&&Math.abs(z-q)<=n.EPSILON*Math.max(1,Math.abs(z),Math.abs(q))&&Math.abs(G-Y)<=n.EPSILON*Math.max(1,Math.abs(G),Math.abs(Y))},qt.forEach=qt.sqrLen=qt.len=qt.sqrDist=qt.dist=qt.div=qt.mul=qt.sub=void 0;var n=function(E,C){if(E&&E.__esModule)return E;if(E===null||u(E)!=="object"&&typeof E!="function")return{default:E};var D=l(void 0);if(D&&D.has(E))return D.get(E);var N={},z=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var G in E)if(G!=="default"&&Object.prototype.hasOwnProperty.call(E,G)){var W=z?Object.getOwnPropertyDescriptor(E,G):null;W&&(W.get||W.set)?Object.defineProperty(N,G,W):N[G]=E[G]}return N.default=E,D&&D.set(E,N),N}(X());function l(E){if(typeof WeakMap!="function")return null;var C=new WeakMap,D=new WeakMap;return(l=function(N){return N?D:C})(E)}function d(){var E=new n.ARRAY_TYPE(4);return n.ARRAY_TYPE!=Float32Array&&(E[0]=0,E[1]=0,E[2]=0,E[3]=0),E}function _(E,C,D){return E[0]=C[0]-D[0],E[1]=C[1]-D[1],E[2]=C[2]-D[2],E[3]=C[3]-D[3],E}function f(E,C,D){return E[0]=C[0]*D[0],E[1]=C[1]*D[1],E[2]=C[2]*D[2],E[3]=C[3]*D[3],E}function g(E,C,D){return E[0]=C[0]/D[0],E[1]=C[1]/D[1],E[2]=C[2]/D[2],E[3]=C[3]/D[3],E}function w(E,C){return Math.hypot(C[0]-E[0],C[1]-E[1],C[2]-E[2],C[3]-E[3])}function S(E,C){var D=C[0]-E[0],N=C[1]-E[1],z=C[2]-E[2],G=C[3]-E[3];return D*D+N*N+z*z+G*G}function P(E){return Math.hypot(E[0],E[1],E[2],E[3])}function x(E){var C=E[0],D=E[1],N=E[2],z=E[3];return C*C+D*D+N*N+z*z}qt.sub=_,qt.mul=f,qt.div=g,qt.dist=w,qt.sqrDist=S,qt.len=P,qt.sqrLen=x;var I,R=(I=d(),function(E,C,D,N,z,G){var W,H;for(C||(C=4),D||(D=0),H=N?Math.min(N*C+D,E.length):E.length,W=D;W<H;W+=C)I[0]=E[W],I[1]=E[W+1],I[2]=E[W+2],I[3]=E[W+3],z(I,I,G),E[W]=I[0],E[W+1]=I[1],E[W+2]=I[2],E[W+3]=I[3];return E});return qt.forEach=R,qt}function xr(){if(Si)return vt;function u(de){return u=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(Se){return typeof Se}:function(Se){return Se&&typeof Symbol=="function"&&Se.constructor===Symbol&&Se!==Symbol.prototype?"symbol":typeof Se},u(de)}Si=1,Object.defineProperty(vt,"__esModule",{value:!0}),vt.create=w,vt.identity=function(de){return de[0]=0,de[1]=0,de[2]=0,de[3]=1,de},vt.setAxisAngle=S,vt.getAxisAngle=function(de,Se){var Pe=2*Math.acos(Se[3]),Me=Math.sin(Pe/2);return Me>n.EPSILON?(de[0]=Se[0]/Me,de[1]=Se[1]/Me,de[2]=Se[2]/Me):(de[0]=1,de[1]=0,de[2]=0),Pe},vt.getAngle=function(de,Se){var Pe=D(de,Se);return Math.acos(2*Pe*Pe-1)},vt.multiply=P,vt.rotateX=function(de,Se,Pe){Pe*=.5;var Me=Se[0],Oe=Se[1],Ue=Se[2],Ge=Se[3],Ne=Math.sin(Pe),rt=Math.cos(Pe);return de[0]=Me*rt+Ge*Ne,de[1]=Oe*rt+Ue*Ne,de[2]=Ue*rt-Oe*Ne,de[3]=Ge*rt-Me*Ne,de},vt.rotateY=function(de,Se,Pe){Pe*=.5;var Me=Se[0],Oe=Se[1],Ue=Se[2],Ge=Se[3],Ne=Math.sin(Pe),rt=Math.cos(Pe);return de[0]=Me*rt-Ue*Ne,de[1]=Oe*rt+Ge*Ne,de[2]=Ue*rt+Me*Ne,de[3]=Ge*rt-Oe*Ne,de},vt.rotateZ=function(de,Se,Pe){Pe*=.5;var Me=Se[0],Oe=Se[1],Ue=Se[2],Ge=Se[3],Ne=Math.sin(Pe),rt=Math.cos(Pe);return de[0]=Me*rt+Oe*Ne,de[1]=Oe*rt-Me*Ne,de[2]=Ue*rt+Ge*Ne,de[3]=Ge*rt-Ue*Ne,de},vt.calculateW=function(de,Se){var Pe=Se[0],Me=Se[1],Oe=Se[2];return de[0]=Pe,de[1]=Me,de[2]=Oe,de[3]=Math.sqrt(Math.abs(1-Pe*Pe-Me*Me-Oe*Oe)),de},vt.exp=x,vt.ln=I,vt.pow=function(de,Se,Pe){return I(de,Se),C(de,de,Pe),x(de,de),de},vt.slerp=R,vt.random=function(de){var Se=n.RANDOM(),Pe=n.RANDOM(),Me=n.RANDOM(),Oe=Math.sqrt(1-Se),Ue=Math.sqrt(Se);return de[0]=Oe*Math.sin(2*Math.PI*Pe),de[1]=Oe*Math.cos(2*Math.PI*Pe),de[2]=Ue*Math.sin(2*Math.PI*Me),de[3]=Ue*Math.cos(2*Math.PI*Me),de},vt.invert=function(de,Se){var Pe=Se[0],Me=Se[1],Oe=Se[2],Ue=Se[3],Ge=Pe*Pe+Me*Me+Oe*Oe+Ue*Ue,Ne=Ge?1/Ge:0;return de[0]=-Pe*Ne,de[1]=-Me*Ne,de[2]=-Oe*Ne,de[3]=Ue*Ne,de},vt.conjugate=function(de,Se){return de[0]=-Se[0],de[1]=-Se[1],de[2]=-Se[2],de[3]=Se[3],de},vt.fromMat3=E,vt.fromEuler=function(de,Se,Pe,Me){var Oe=.5*Math.PI/180;Se*=Oe,Pe*=Oe,Me*=Oe;var Ue=Math.sin(Se),Ge=Math.cos(Se),Ne=Math.sin(Pe),rt=Math.cos(Pe),mt=Math.sin(Me),it=Math.cos(Me);return de[0]=Ue*rt*it-Ge*Ne*mt,de[1]=Ge*Ne*it+Ue*rt*mt,de[2]=Ge*rt*mt-Ue*Ne*it,de[3]=Ge*rt*it+Ue*Ne*mt,de},vt.str=function(de){return"quat("+de[0]+", "+de[1]+", "+de[2]+", "+de[3]+")"},vt.setAxes=vt.sqlerp=vt.rotationTo=vt.equals=vt.exactEquals=vt.normalize=vt.sqrLen=vt.squaredLength=vt.len=vt.length=vt.lerp=vt.dot=vt.scale=vt.mul=vt.add=vt.set=vt.copy=vt.fromValues=vt.clone=void 0;var n=g(X()),l=g(Le()),d=g(hi()),_=g(Br());function f(de){if(typeof WeakMap!="function")return null;var Se=new WeakMap,Pe=new WeakMap;return(f=function(Me){return Me?Pe:Se})(de)}function g(de,Se){if(de&&de.__esModule)return de;if(de===null||u(de)!=="object"&&typeof de!="function")return{default:de};var Pe=f(Se);if(Pe&&Pe.has(de))return Pe.get(de);var Me={},Oe=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var Ue in de)if(Ue!=="default"&&Object.prototype.hasOwnProperty.call(de,Ue)){var Ge=Oe?Object.getOwnPropertyDescriptor(de,Ue):null;Ge&&(Ge.get||Ge.set)?Object.defineProperty(Me,Ue,Ge):Me[Ue]=de[Ue]}return Me.default=de,Pe&&Pe.set(de,Me),Me}function w(){var de=new n.ARRAY_TYPE(4);return n.ARRAY_TYPE!=Float32Array&&(de[0]=0,de[1]=0,de[2]=0),de[3]=1,de}function S(de,Se,Pe){Pe*=.5;var Me=Math.sin(Pe);return de[0]=Me*Se[0],de[1]=Me*Se[1],de[2]=Me*Se[2],de[3]=Math.cos(Pe),de}function P(de,Se,Pe){var Me=Se[0],Oe=Se[1],Ue=Se[2],Ge=Se[3],Ne=Pe[0],rt=Pe[1],mt=Pe[2],it=Pe[3];return de[0]=Me*it+Ge*Ne+Oe*mt-Ue*rt,de[1]=Oe*it+Ge*rt+Ue*Ne-Me*mt,de[2]=Ue*it+Ge*mt+Me*rt-Oe*Ne,de[3]=Ge*it-Me*Ne-Oe*rt-Ue*mt,de}function x(de,Se){var Pe=Se[0],Me=Se[1],Oe=Se[2],Ue=Se[3],Ge=Math.sqrt(Pe*Pe+Me*Me+Oe*Oe),Ne=Math.exp(Ue),rt=Ge>0?Ne*Math.sin(Ge)/Ge:0;return de[0]=Pe*rt,de[1]=Me*rt,de[2]=Oe*rt,de[3]=Ne*Math.cos(Ge),de}function I(de,Se){var Pe=Se[0],Me=Se[1],Oe=Se[2],Ue=Se[3],Ge=Math.sqrt(Pe*Pe+Me*Me+Oe*Oe),Ne=Ge>0?Math.atan2(Ge,Ue)/Ge:0;return de[0]=Pe*Ne,de[1]=Me*Ne,de[2]=Oe*Ne,de[3]=.5*Math.log(Pe*Pe+Me*Me+Oe*Oe+Ue*Ue),de}function R(de,Se,Pe,Me){var Oe,Ue,Ge,Ne,rt,mt=Se[0],it=Se[1],Bt=Se[2],Mt=Se[3],bt=Pe[0],_t=Pe[1],Ht=Pe[2],Ft=Pe[3];return(Ue=mt*bt+it*_t+Bt*Ht+Mt*Ft)<0&&(Ue=-Ue,bt=-bt,_t=-_t,Ht=-Ht,Ft=-Ft),1-Ue>n.EPSILON?(Oe=Math.acos(Ue),Ge=Math.sin(Oe),Ne=Math.sin((1-Me)*Oe)/Ge,rt=Math.sin(Me*Oe)/Ge):(Ne=1-Me,rt=Me),de[0]=Ne*mt+rt*bt,de[1]=Ne*it+rt*_t,de[2]=Ne*Bt+rt*Ht,de[3]=Ne*Mt+rt*Ft,de}function E(de,Se){var Pe,Me=Se[0]+Se[4]+Se[8];if(Me>0)Pe=Math.sqrt(Me+1),de[3]=.5*Pe,de[0]=(Se[5]-Se[7])*(Pe=.5/Pe),de[1]=(Se[6]-Se[2])*Pe,de[2]=(Se[1]-Se[3])*Pe;else{var Oe=0;Se[4]>Se[0]&&(Oe=1),Se[8]>Se[3*Oe+Oe]&&(Oe=2);var Ue=(Oe+1)%3,Ge=(Oe+2)%3;Pe=Math.sqrt(Se[3*Oe+Oe]-Se[3*Ue+Ue]-Se[3*Ge+Ge]+1),de[Oe]=.5*Pe,de[3]=(Se[3*Ue+Ge]-Se[3*Ge+Ue])*(Pe=.5/Pe),de[Ue]=(Se[3*Ue+Oe]+Se[3*Oe+Ue])*Pe,de[Ge]=(Se[3*Ge+Oe]+Se[3*Oe+Ge])*Pe}return de}vt.clone=_.clone,vt.fromValues=_.fromValues,vt.copy=_.copy,vt.set=_.set,vt.add=_.add,vt.mul=P;var C=_.scale;vt.scale=C;var D=_.dot;vt.dot=D,vt.lerp=_.lerp;var N=_.length;vt.length=N,vt.len=N;var z=_.squaredLength;vt.squaredLength=z,vt.sqrLen=z;var G=_.normalize;vt.normalize=G,vt.exactEquals=_.exactEquals,vt.equals=_.equals;var W,H,q,Y=(W=d.create(),H=d.fromValues(1,0,0),q=d.fromValues(0,1,0),function(de,Se,Pe){var Me=d.dot(Se,Pe);return Me<-.999999?(d.cross(W,H,Se),d.len(W)<1e-6&&d.cross(W,q,Se),d.normalize(W,W),S(de,W,Math.PI),de):Me>.999999?(de[0]=0,de[1]=0,de[2]=0,de[3]=1,de):(d.cross(W,Se,Pe),de[0]=W[0],de[1]=W[1],de[2]=W[2],de[3]=1+Me,G(de,de))});vt.rotationTo=Y;var ie,he,ce=(ie=w(),he=w(),function(de,Se,Pe,Me,Oe,Ue){return R(ie,Se,Oe,Ue),R(he,Pe,Me,Ue),R(de,ie,he,2*Ue*(1-Ue)),de});vt.sqlerp=ce;var le,Te=(le=l.create(),function(de,Se,Pe,Me){return le[0]=Pe[0],le[3]=Pe[1],le[6]=Pe[2],le[1]=Me[0],le[4]=Me[1],le[7]=Me[2],le[2]=-Se[0],le[5]=-Se[1],le[8]=-Se[2],G(de,E(de,le))});return vt.setAxes=Te,vt}var os,pi={};function mn(){if(os)return pi;function u(R){return u=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(E){return typeof E}:function(E){return E&&typeof Symbol=="function"&&E.constructor===Symbol&&E!==Symbol.prototype?"symbol":typeof E},u(R)}os=1,Object.defineProperty(pi,"__esModule",{value:!0}),pi.create=function(){var R=new n.ARRAY_TYPE(8);return n.ARRAY_TYPE!=Float32Array&&(R[0]=0,R[1]=0,R[2]=0,R[4]=0,R[5]=0,R[6]=0,R[7]=0),R[3]=1,R},pi.clone=function(R){var E=new n.ARRAY_TYPE(8);return E[0]=R[0],E[1]=R[1],E[2]=R[2],E[3]=R[3],E[4]=R[4],E[5]=R[5],E[6]=R[6],E[7]=R[7],E},pi.fromValues=function(R,E,C,D,N,z,G,W){var H=new n.ARRAY_TYPE(8);return H[0]=R,H[1]=E,H[2]=C,H[3]=D,H[4]=N,H[5]=z,H[6]=G,H[7]=W,H},pi.fromRotationTranslationValues=function(R,E,C,D,N,z,G){var W=new n.ARRAY_TYPE(8);W[0]=R,W[1]=E,W[2]=C,W[3]=D;var H=.5*N,q=.5*z,Y=.5*G;return W[4]=H*D+q*C-Y*E,W[5]=q*D+Y*R-H*C,W[6]=Y*D+H*E-q*R,W[7]=-H*R-q*E-Y*C,W},pi.fromRotationTranslation=g,pi.fromTranslation=function(R,E){return R[0]=0,R[1]=0,R[2]=0,R[3]=1,R[4]=.5*E[0],R[5]=.5*E[1],R[6]=.5*E[2],R[7]=0,R},pi.fromRotation=function(R,E){return R[0]=E[0],R[1]=E[1],R[2]=E[2],R[3]=E[3],R[4]=0,R[5]=0,R[6]=0,R[7]=0,R},pi.fromMat4=function(R,E){var C=l.create();d.getRotation(C,E);var D=new n.ARRAY_TYPE(3);return d.getTranslation(D,E),g(R,C,D),R},pi.copy=w,pi.identity=function(R){return R[0]=0,R[1]=0,R[2]=0,R[3]=1,R[4]=0,R[5]=0,R[6]=0,R[7]=0,R},pi.set=function(R,E,C,D,N,z,G,W,H){return R[0]=E,R[1]=C,R[2]=D,R[3]=N,R[4]=z,R[5]=G,R[6]=W,R[7]=H,R},pi.getDual=function(R,E){return R[0]=E[4],R[1]=E[5],R[2]=E[6],R[3]=E[7],R},pi.setDual=function(R,E){return R[4]=E[0],R[5]=E[1],R[6]=E[2],R[7]=E[3],R},pi.getTranslation=function(R,E){var C=E[4],D=E[5],N=E[6],z=E[7],G=-E[0],W=-E[1],H=-E[2],q=E[3];return R[0]=2*(C*q+z*G+D*H-N*W),R[1]=2*(D*q+z*W+N*G-C*H),R[2]=2*(N*q+z*H+C*W-D*G),R},pi.translate=function(R,E,C){var D=E[0],N=E[1],z=E[2],G=E[3],W=.5*C[0],H=.5*C[1],q=.5*C[2],Y=E[4],ie=E[5],he=E[6],ce=E[7];return R[0]=D,R[1]=N,R[2]=z,R[3]=G,R[4]=G*W+N*q-z*H+Y,R[5]=G*H+z*W-D*q+ie,R[6]=G*q+D*H-N*W+he,R[7]=-D*W-N*H-z*q+ce,R},pi.rotateX=function(R,E,C){var D=-E[0],N=-E[1],z=-E[2],G=E[3],W=E[4],H=E[5],q=E[6],Y=E[7],ie=W*G+Y*D+H*z-q*N,he=H*G+Y*N+q*D-W*z,ce=q*G+Y*z+W*N-H*D,le=Y*G-W*D-H*N-q*z;return l.rotateX(R,E,C),R[4]=ie*(G=R[3])+le*(D=R[0])+he*(z=R[2])-ce*(N=R[1]),R[5]=he*G+le*N+ce*D-ie*z,R[6]=ce*G+le*z+ie*N-he*D,R[7]=le*G-ie*D-he*N-ce*z,R},pi.rotateY=function(R,E,C){var D=-E[0],N=-E[1],z=-E[2],G=E[3],W=E[4],H=E[5],q=E[6],Y=E[7],ie=W*G+Y*D+H*z-q*N,he=H*G+Y*N+q*D-W*z,ce=q*G+Y*z+W*N-H*D,le=Y*G-W*D-H*N-q*z;return l.rotateY(R,E,C),R[4]=ie*(G=R[3])+le*(D=R[0])+he*(z=R[2])-ce*(N=R[1]),R[5]=he*G+le*N+ce*D-ie*z,R[6]=ce*G+le*z+ie*N-he*D,R[7]=le*G-ie*D-he*N-ce*z,R},pi.rotateZ=function(R,E,C){var D=-E[0],N=-E[1],z=-E[2],G=E[3],W=E[4],H=E[5],q=E[6],Y=E[7],ie=W*G+Y*D+H*z-q*N,he=H*G+Y*N+q*D-W*z,ce=q*G+Y*z+W*N-H*D,le=Y*G-W*D-H*N-q*z;return l.rotateZ(R,E,C),R[4]=ie*(G=R[3])+le*(D=R[0])+he*(z=R[2])-ce*(N=R[1]),R[5]=he*G+le*N+ce*D-ie*z,R[6]=ce*G+le*z+ie*N-he*D,R[7]=le*G-ie*D-he*N-ce*z,R},pi.rotateByQuatAppend=function(R,E,C){var D=C[0],N=C[1],z=C[2],G=C[3],W=E[0],H=E[1],q=E[2],Y=E[3];return R[0]=W*G+Y*D+H*z-q*N,R[1]=H*G+Y*N+q*D-W*z,R[2]=q*G+Y*z+W*N-H*D,R[3]=Y*G-W*D-H*N-q*z,R[4]=(W=E[4])*G+(Y=E[7])*D+(H=E[5])*z-(q=E[6])*N,R[5]=H*G+Y*N+q*D-W*z,R[6]=q*G+Y*z+W*N-H*D,R[7]=Y*G-W*D-H*N-q*z,R},pi.rotateByQuatPrepend=function(R,E,C){var D=E[0],N=E[1],z=E[2],G=E[3],W=C[0],H=C[1],q=C[2],Y=C[3];return R[0]=D*Y+G*W+N*q-z*H,R[1]=N*Y+G*H+z*W-D*q,R[2]=z*Y+G*q+D*H-N*W,R[3]=G*Y-D*W-N*H-z*q,R[4]=D*(Y=C[7])+G*(W=C[4])+N*(q=C[6])-z*(H=C[5]),R[5]=N*Y+G*H+z*W-D*q,R[6]=z*Y+G*q+D*H-N*W,R[7]=G*Y-D*W-N*H-z*q,R},pi.rotateAroundAxis=function(R,E,C,D){if(Math.abs(D)<n.EPSILON)return w(R,E);var N=Math.hypot(C[0],C[1],C[2]);D*=.5;var z=Math.sin(D),G=z*C[0]/N,W=z*C[1]/N,H=z*C[2]/N,q=Math.cos(D),Y=E[0],ie=E[1],he=E[2],ce=E[3];R[0]=Y*q+ce*G+ie*H-he*W,R[1]=ie*q+ce*W+he*G-Y*H,R[2]=he*q+ce*H+Y*W-ie*G,R[3]=ce*q-Y*G-ie*W-he*H;var le=E[4],Te=E[5],de=E[6],Se=E[7];return R[4]=le*q+Se*G+Te*H-de*W,R[5]=Te*q+Se*W+de*G-le*H,R[6]=de*q+Se*H+le*W-Te*G,R[7]=Se*q-le*G-Te*W-de*H,R},pi.add=function(R,E,C){return R[0]=E[0]+C[0],R[1]=E[1]+C[1],R[2]=E[2]+C[2],R[3]=E[3]+C[3],R[4]=E[4]+C[4],R[5]=E[5]+C[5],R[6]=E[6]+C[6],R[7]=E[7]+C[7],R},pi.multiply=S,pi.scale=function(R,E,C){return R[0]=E[0]*C,R[1]=E[1]*C,R[2]=E[2]*C,R[3]=E[3]*C,R[4]=E[4]*C,R[5]=E[5]*C,R[6]=E[6]*C,R[7]=E[7]*C,R},pi.lerp=function(R,E,C,D){var N=1-D;return P(E,C)<0&&(D=-D),R[0]=E[0]*N+C[0]*D,R[1]=E[1]*N+C[1]*D,R[2]=E[2]*N+C[2]*D,R[3]=E[3]*N+C[3]*D,R[4]=E[4]*N+C[4]*D,R[5]=E[5]*N+C[5]*D,R[6]=E[6]*N+C[6]*D,R[7]=E[7]*N+C[7]*D,R},pi.invert=function(R,E){var C=I(E);return R[0]=-E[0]/C,R[1]=-E[1]/C,R[2]=-E[2]/C,R[3]=E[3]/C,R[4]=-E[4]/C,R[5]=-E[5]/C,R[6]=-E[6]/C,R[7]=E[7]/C,R},pi.conjugate=function(R,E){return R[0]=-E[0],R[1]=-E[1],R[2]=-E[2],R[3]=E[3],R[4]=-E[4],R[5]=-E[5],R[6]=-E[6],R[7]=E[7],R},pi.normalize=function(R,E){var C=I(E);if(C>0){C=Math.sqrt(C);var D=E[0]/C,N=E[1]/C,z=E[2]/C,G=E[3]/C,W=E[4],H=E[5],q=E[6],Y=E[7],ie=D*W+N*H+z*q+G*Y;R[0]=D,R[1]=N,R[2]=z,R[3]=G,R[4]=(W-D*ie)/C,R[5]=(H-N*ie)/C,R[6]=(q-z*ie)/C,R[7]=(Y-G*ie)/C}return R},pi.str=function(R){return"quat2("+R[0]+", "+R[1]+", "+R[2]+", "+R[3]+", "+R[4]+", "+R[5]+", "+R[6]+", "+R[7]+")"},pi.exactEquals=function(R,E){return R[0]===E[0]&&R[1]===E[1]&&R[2]===E[2]&&R[3]===E[3]&&R[4]===E[4]&&R[5]===E[5]&&R[6]===E[6]&&R[7]===E[7]},pi.equals=function(R,E){var C=R[0],D=R[1],N=R[2],z=R[3],G=R[4],W=R[5],H=R[6],q=R[7],Y=E[0],ie=E[1],he=E[2],ce=E[3],le=E[4],Te=E[5],de=E[6],Se=E[7];return Math.abs(C-Y)<=n.EPSILON*Math.max(1,Math.abs(C),Math.abs(Y))&&Math.abs(D-ie)<=n.EPSILON*Math.max(1,Math.abs(D),Math.abs(ie))&&Math.abs(N-he)<=n.EPSILON*Math.max(1,Math.abs(N),Math.abs(he))&&Math.abs(z-ce)<=n.EPSILON*Math.max(1,Math.abs(z),Math.abs(ce))&&Math.abs(G-le)<=n.EPSILON*Math.max(1,Math.abs(G),Math.abs(le))&&Math.abs(W-Te)<=n.EPSILON*Math.max(1,Math.abs(W),Math.abs(Te))&&Math.abs(H-de)<=n.EPSILON*Math.max(1,Math.abs(H),Math.abs(de))&&Math.abs(q-Se)<=n.EPSILON*Math.max(1,Math.abs(q),Math.abs(Se))},pi.sqrLen=pi.squaredLength=pi.len=pi.length=pi.dot=pi.mul=pi.setReal=pi.getReal=void 0;var n=f(X()),l=f(xr()),d=f(St());function _(R){if(typeof WeakMap!="function")return null;var E=new WeakMap,C=new WeakMap;return(_=function(D){return D?C:E})(R)}function f(R,E){if(R&&R.__esModule)return R;if(R===null||u(R)!=="object"&&typeof R!="function")return{default:R};var C=_(E);if(C&&C.has(R))return C.get(R);var D={},N=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var z in R)if(z!=="default"&&Object.prototype.hasOwnProperty.call(R,z)){var G=N?Object.getOwnPropertyDescriptor(R,z):null;G&&(G.get||G.set)?Object.defineProperty(D,z,G):D[z]=R[z]}return D.default=R,C&&C.set(R,D),D}function g(R,E,C){var D=.5*C[0],N=.5*C[1],z=.5*C[2],G=E[0],W=E[1],H=E[2],q=E[3];return R[0]=G,R[1]=W,R[2]=H,R[3]=q,R[4]=D*q+N*H-z*W,R[5]=N*q+z*G-D*H,R[6]=z*q+D*W-N*G,R[7]=-D*G-N*W-z*H,R}function w(R,E){return R[0]=E[0],R[1]=E[1],R[2]=E[2],R[3]=E[3],R[4]=E[4],R[5]=E[5],R[6]=E[6],R[7]=E[7],R}function S(R,E,C){var D=E[0],N=E[1],z=E[2],G=E[3],W=C[4],H=C[5],q=C[6],Y=C[7],ie=E[4],he=E[5],ce=E[6],le=E[7],Te=C[0],de=C[1],Se=C[2],Pe=C[3];return R[0]=D*Pe+G*Te+N*Se-z*de,R[1]=N*Pe+G*de+z*Te-D*Se,R[2]=z*Pe+G*Se+D*de-N*Te,R[3]=G*Pe-D*Te-N*de-z*Se,R[4]=D*Y+G*W+N*q-z*H+ie*Pe+le*Te+he*Se-ce*de,R[5]=N*Y+G*H+z*W-D*q+he*Pe+le*de+ce*Te-ie*Se,R[6]=z*Y+G*q+D*H-N*W+ce*Pe+le*Se+ie*de-he*Te,R[7]=G*Y-D*W-N*H-z*q+le*Pe-ie*Te-he*de-ce*Se,R}pi.getReal=l.copy,pi.setReal=l.copy,pi.mul=S;var P=l.dot;pi.dot=P;var x=l.length;pi.length=x,pi.len=x;var I=l.squaredLength;return pi.squaredLength=I,pi.sqrLen=I,pi}var as,Kr,si={};function $s(){if(as)return si;function u(E){return u=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(C){return typeof C}:function(C){return C&&typeof Symbol=="function"&&C.constructor===Symbol&&C!==Symbol.prototype?"symbol":typeof C},u(E)}as=1,Object.defineProperty(si,"__esModule",{value:!0}),si.create=d,si.clone=function(E){var C=new n.ARRAY_TYPE(2);return C[0]=E[0],C[1]=E[1],C},si.fromValues=function(E,C){var D=new n.ARRAY_TYPE(2);return D[0]=E,D[1]=C,D},si.copy=function(E,C){return E[0]=C[0],E[1]=C[1],E},si.set=function(E,C,D){return E[0]=C,E[1]=D,E},si.add=function(E,C,D){return E[0]=C[0]+D[0],E[1]=C[1]+D[1],E},si.subtract=_,si.multiply=f,si.divide=g,si.ceil=function(E,C){return E[0]=Math.ceil(C[0]),E[1]=Math.ceil(C[1]),E},si.floor=function(E,C){return E[0]=Math.floor(C[0]),E[1]=Math.floor(C[1]),E},si.min=function(E,C,D){return E[0]=Math.min(C[0],D[0]),E[1]=Math.min(C[1],D[1]),E},si.max=function(E,C,D){return E[0]=Math.max(C[0],D[0]),E[1]=Math.max(C[1],D[1]),E},si.round=function(E,C){return E[0]=Math.round(C[0]),E[1]=Math.round(C[1]),E},si.scale=function(E,C,D){return E[0]=C[0]*D,E[1]=C[1]*D,E},si.scaleAndAdd=function(E,C,D,N){return E[0]=C[0]+D[0]*N,E[1]=C[1]+D[1]*N,E},si.distance=w,si.squaredDistance=S,si.length=P,si.squaredLength=x,si.negate=function(E,C){return E[0]=-C[0],E[1]=-C[1],E},si.inverse=function(E,C){return E[0]=1/C[0],E[1]=1/C[1],E},si.normalize=function(E,C){var D=C[0],N=C[1],z=D*D+N*N;return z>0&&(z=1/Math.sqrt(z)),E[0]=C[0]*z,E[1]=C[1]*z,E},si.dot=function(E,C){return E[0]*C[0]+E[1]*C[1]},si.cross=function(E,C,D){var N=C[0]*D[1]-C[1]*D[0];return E[0]=E[1]=0,E[2]=N,E},si.lerp=function(E,C,D,N){var z=C[0],G=C[1];return E[0]=z+N*(D[0]-z),E[1]=G+N*(D[1]-G),E},si.random=function(E,C){C=C||1;var D=2*n.RANDOM()*Math.PI;return E[0]=Math.cos(D)*C,E[1]=Math.sin(D)*C,E},si.transformMat2=function(E,C,D){var N=C[0],z=C[1];return E[0]=D[0]*N+D[2]*z,E[1]=D[1]*N+D[3]*z,E},si.transformMat2d=function(E,C,D){var N=C[0],z=C[1];return E[0]=D[0]*N+D[2]*z+D[4],E[1]=D[1]*N+D[3]*z+D[5],E},si.transformMat3=function(E,C,D){var N=C[0],z=C[1];return E[0]=D[0]*N+D[3]*z+D[6],E[1]=D[1]*N+D[4]*z+D[7],E},si.transformMat4=function(E,C,D){var N=C[0],z=C[1];return E[0]=D[0]*N+D[4]*z+D[12],E[1]=D[1]*N+D[5]*z+D[13],E},si.rotate=function(E,C,D,N){var z=C[0]-D[0],G=C[1]-D[1],W=Math.sin(N),H=Math.cos(N);return E[0]=z*H-G*W+D[0],E[1]=z*W+G*H+D[1],E},si.angle=function(E,C){var D=E[0],N=E[1],z=C[0],G=C[1],W=Math.sqrt(D*D+N*N)*Math.sqrt(z*z+G*G);return Math.acos(Math.min(Math.max(W&&(D*z+N*G)/W,-1),1))},si.zero=function(E){return E[0]=0,E[1]=0,E},si.str=function(E){return"vec2("+E[0]+", "+E[1]+")"},si.exactEquals=function(E,C){return E[0]===C[0]&&E[1]===C[1]},si.equals=function(E,C){var D=E[0],N=E[1],z=C[0],G=C[1];return Math.abs(D-z)<=n.EPSILON*Math.max(1,Math.abs(D),Math.abs(z))&&Math.abs(N-G)<=n.EPSILON*Math.max(1,Math.abs(N),Math.abs(G))},si.forEach=si.sqrLen=si.sqrDist=si.dist=si.div=si.mul=si.sub=si.len=void 0;var n=function(E,C){if(E&&E.__esModule)return E;if(E===null||u(E)!=="object"&&typeof E!="function")return{default:E};var D=l(void 0);if(D&&D.has(E))return D.get(E);var N={},z=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var G in E)if(G!=="default"&&Object.prototype.hasOwnProperty.call(E,G)){var W=z?Object.getOwnPropertyDescriptor(E,G):null;W&&(W.get||W.set)?Object.defineProperty(N,G,W):N[G]=E[G]}return N.default=E,D&&D.set(E,N),N}(X());function l(E){if(typeof WeakMap!="function")return null;var C=new WeakMap,D=new WeakMap;return(l=function(N){return N?D:C})(E)}function d(){var E=new n.ARRAY_TYPE(2);return n.ARRAY_TYPE!=Float32Array&&(E[0]=0,E[1]=0),E}function _(E,C,D){return E[0]=C[0]-D[0],E[1]=C[1]-D[1],E}function f(E,C,D){return E[0]=C[0]*D[0],E[1]=C[1]*D[1],E}function g(E,C,D){return E[0]=C[0]/D[0],E[1]=C[1]/D[1],E}function w(E,C){return Math.hypot(C[0]-E[0],C[1]-E[1])}function S(E,C){var D=C[0]-E[0],N=C[1]-E[1];return D*D+N*N}function P(E){return Math.hypot(E[0],E[1])}function x(E){var C=E[0],D=E[1];return C*C+D*D}si.len=P,si.sub=_,si.mul=f,si.div=g,si.dist=w,si.sqrDist=S,si.sqrLen=x;var I,R=(I=d(),function(E,C,D,N,z,G){var W,H;for(C||(C=2),D||(D=0),H=N?Math.min(N*C+D,E.length):E.length,W=D;W<H;W+=C)I[0]=E[W],I[1]=E[W+1],z(I,I,G),E[W]=I[0],E[W+1]=I[1];return E});return si.forEach=R,si}function ls(){if(Kr)return F;function u(E){return u=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(C){return typeof C}:function(C){return C&&typeof Symbol=="function"&&C.constructor===Symbol&&C!==Symbol.prototype?"symbol":typeof C},u(E)}Kr=1,Object.defineProperty(F,"__esModule",{value:!0}),F.vec4=F.vec3=F.vec2=F.quat2=F.quat=F.mat4=F.mat3=F.mat2d=F.mat2=F.glMatrix=void 0;var n=R(X());F.glMatrix=n;var l=R(K());F.mat2=l;var d=R(ke());F.mat2d=d;var _=R(Le());F.mat3=_;var f=R(St());F.mat4=f;var g=R(xr());F.quat=g;var w=R(mn());F.quat2=w;var S=R($s());F.vec2=S;var P=R(hi());F.vec3=P;var x=R(Br());function I(E){if(typeof WeakMap!="function")return null;var C=new WeakMap,D=new WeakMap;return(I=function(N){return N?D:C})(E)}function R(E,C){if(E&&E.__esModule)return E;if(E===null||u(E)!=="object"&&typeof E!="function")return{default:E};var D=I(C);if(D&&D.has(E))return D.get(E);var N={},z=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var G in E)if(G!=="default"&&Object.prototype.hasOwnProperty.call(E,G)){var W=z?Object.getOwnPropertyDescriptor(E,G):null;W&&(W.get||W.set)?Object.defineProperty(N,G,W):N[G]=E[G]}return N.default=E,D&&D.set(E,N),N}return F.vec4=x,F}var cs,fr,br,kn,Re=ls(),sr=function(){if(fr)return cs;function u(n,l,d,_){this.cx=3*n,this.bx=3*(d-n)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*l,this.by=3*(_-l)-this.cy,this.ay=1-this.cy-this.by,this.p1x=n,this.p1y=l,this.p2x=d,this.p2y=_}return fr=1,cs=u,u.prototype={sampleCurveX:function(n){return((this.ax*n+this.bx)*n+this.cx)*n},sampleCurveY:function(n){return((this.ay*n+this.by)*n+this.cy)*n},sampleCurveDerivativeX:function(n){return(3*this.ax*n+2*this.bx)*n+this.cx},solveCurveX:function(n,l){if(l===void 0&&(l=1e-6),n<0)return 0;if(n>1)return 1;for(var d=n,_=0;_<8;_++){var f=this.sampleCurveX(d)-n;if(Math.abs(f)<l)return d;var g=this.sampleCurveDerivativeX(d);if(Math.abs(g)<1e-6)break;d-=f/g}var w=0,S=1;for(d=n,_=0;_<20&&(f=this.sampleCurveX(d),!(Math.abs(f-n)<l));_++)n>f?w=d:S=d,d=.5*(S-w)+w;return d},solve:function(n,l){return this.sampleCurveY(this.solveCurveX(n,l))}},cs}(),Xn=T(sr);function _n(){if(kn)return br;function u(n,l){this.x=n,this.y=l}return kn=1,br=u,u.prototype={clone:function(){return new u(this.x,this.y)},add:function(n){return this.clone()._add(n)},sub:function(n){return this.clone()._sub(n)},multByPoint:function(n){return this.clone()._multByPoint(n)},divByPoint:function(n){return this.clone()._divByPoint(n)},mult:function(n){return this.clone()._mult(n)},div:function(n){return this.clone()._div(n)},rotate:function(n){return this.clone()._rotate(n)},rotateAround:function(n,l){return this.clone()._rotateAround(n,l)},matMult:function(n){return this.clone()._matMult(n)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(n){return this.x===n.x&&this.y===n.y},dist:function(n){return Math.sqrt(this.distSqr(n))},distSqr:function(n){var l=n.x-this.x,d=n.y-this.y;return l*l+d*d},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(n){return Math.atan2(this.y-n.y,this.x-n.x)},angleWith:function(n){return this.angleWithSep(n.x,n.y)},angleWithSep:function(n,l){return Math.atan2(this.x*l-this.y*n,this.x*n+this.y*l)},_matMult:function(n){var l=n[2]*this.x+n[3]*this.y;return this.x=n[0]*this.x+n[1]*this.y,this.y=l,this},_add:function(n){return this.x+=n.x,this.y+=n.y,this},_sub:function(n){return this.x-=n.x,this.y-=n.y,this},_mult:function(n){return this.x*=n,this.y*=n,this},_div:function(n){return this.x/=n,this.y/=n,this},_multByPoint:function(n){return this.x*=n.x,this.y*=n.y,this},_divByPoint:function(n){return this.x/=n.x,this.y/=n.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var n=this.y;return this.y=this.x,this.x=-n,this},_rotate:function(n){var l=Math.cos(n),d=Math.sin(n),_=d*this.x+l*this.y;return this.x=l*this.x-d*this.y,this.y=_,this},_rotateAround:function(n,l){var d=Math.cos(n),_=Math.sin(n),f=l.y+_*(this.x-l.x)+d*(this.y-l.y);return this.x=l.x+d*(this.x-l.x)-_*(this.y-l.y),this.y=f,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},u.convert=function(n){return n instanceof u?n:Array.isArray(n)?new u(n[0],n[1]):n},br}var At=T(_n());function Wr(u,n){if(Array.isArray(u)){if(!Array.isArray(n)||u.length!==n.length)return!1;for(let l=0;l<u.length;l++)if(!Wr(u[l],n[l]))return!1;return!0}if(typeof u=="object"&&u!==null&&n!==null){if(typeof n!="object"||Object.keys(u).length!==Object.keys(n).length)return!1;for(const l in u)if(!Wr(u[l],n[l]))return!1;return!0}return u===n}const gn=Math.PI/180,Zn=180/Math.PI;function Ti(u){return u*gn}function kr(u){return u*Zn}const Ln=[[0,0],[1,0],[1,1],[0,1]];function Ws(u){if(u<=0)return 0;if(u>=1)return 1;const n=u*u,l=n*u;return 4*(u<.5?l:3*(u-n)+l-.75)}function bo(u,n,l,d){const _=new Xn(u,n,l,d);return function(f){return _.solve(f)}}const wo=bo(.25,.1,.25,1);function yi(u,n,l){return Math.min(l,Math.max(n,u))}function ws(u,n,l){return(l=yi((l-u)/(n-u),0,1))*l*(3-2*l)}function us(u,n,l){const d=l-n,_=((u-n)%d+d)%d+n;return _===n?l:_}function Cn(u,n,l){if(!u.length)return l(null,[]);let d=u.length;const _=new Array(u.length);let f=null;u.forEach((g,w)=>{n(g,(S,P)=>{S&&(f=S),_[w]=P,--d==0&&l(f,_)})})}function Mn(u,...n){for(const l of n)for(const d in l)u[d]=l[d];return u}let Ao=1;function Aa(){return Ao++}function nl(u){return u<=1?1:Math.pow(2,Math.ceil(Math.log(u)/Math.LN2))}function sl(u,n){u.forEach(l=>{n[l]&&(n[l]=n[l].bind(n))})}function Nn(u,n){return u.indexOf(n,u.length-n.length)!==-1}function ol(u,n,l){const d={};for(const _ in u)d[_]=n.call(this,u[_],_,u);return d}function al(u,n,l){const d={};for(const _ in u)n.call(this,u[_],_,u)&&(d[_]=u[_]);return d}function hs(u){return Array.isArray(u)?u.map(hs):typeof u=="object"&&u?ol(u,hs):u}const Ta={};function mi(u){Ta[u]||(typeof console<"u"&&console.warn(u),Ta[u]=!0)}function qs(u,n,l){return(l.y-u.y)*(n.x-u.x)>(n.y-u.y)*(l.x-u.x)}function Lu(u){let n=0;for(let l,d,_=0,f=u.length,g=f-1;_<f;g=_++)l=u[_],d=u[g],n+=(d.x-l.x)*(l.y+d.y);return n}function Yn([u,n,l]){const d=Ti(n+90),_=Ti(l);return{x:u*Math.cos(d)*Math.sin(_),y:u*Math.sin(d)*Math.sin(_),z:u*Math.cos(_),azimuthal:n,polar:l}}function To(){return typeof WorkerGlobalScope<"u"&&typeof self<"u"&&self instanceof WorkerGlobalScope}function ll(u){const n={};if(u.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,(l,d,_,f)=>{const g=_||f;return n[d]=!g||g.toLowerCase(),""}),n["max-age"]){const l=parseInt(n["max-age"],10);isNaN(l)?delete n["max-age"]:n["max-age"]=l}return n}let cl=null;function ul(u,n){return[u[4*n],u[4*n+1],u[4*n+2],u[4*n+3]]}function Nu(u,n,l,d){for(;n<l;){const _=n+l>>1;u[_]<d?n=_+1:l=_}return n}function hl(u,n,l,d){for(;n<l;){const _=n+l>>1;u[_]<=d?n=_+1:l=_}return n}function zu(u){return u>0?1/(1.001-u):1+u}function Uu(u){return u>0?1-1/(1.001-u):-u}const Vr={API_URL:"https://api.mapbox.com",get API_URL_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/|\?|$)/i},get API_TILEJSON_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/v[0-9]*\/.*\.json.*$)/i},get API_SPRITE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*\/sprite.*\..*$)/i},get API_FONTS_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/fonts\/v[0-9]*\/)(.*\.pbf.*$)/i},get API_STYLE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*$)/i},get API_CDN_URL_REGEX(){return/^((https?:)?\/\/)?api\.mapbox\.c(n|om)(\/mapbox-gl-js\/)(.*$)/i},get EVENTS_URL(){if(!Vr.API_URL)return null;try{const u=new URL(Vr.API_URL);return u.hostname==="api.mapbox.cn"?"https://events.mapbox.cn/events/v2":u.hostname==="api.mapbox.com"?"https://events.mapbox.com/events/v2":null}catch{return null}},SESSION_PATH:"/map-sessions/v1",FEEDBACK_URL:"https://apps.mapbox.com/feedback",TILE_URL_VERSION:"v4",RASTER_URL_PREFIX:"raster/v1",RASTERARRAYS_URL_PREFIX:"rasterarrays/v1",REQUIRE_ACCESS_TOKEN:!0,ACCESS_TOKEN:null,DEFAULT_STYLE:"mapbox://styles/mapbox/standard",MAX_PARALLEL_IMAGE_REQUESTS:16,DRACO_URL:"https://api.mapbox.com/mapbox-gl-js/draco_decoder_gltf_v1.5.6.wasm",MESHOPT_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_base_v0.20.wasm",MESHOPT_SIMD_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_simd_v0.20.wasm",GLYPHS_URL:"mapbox://fonts/mapbox/{fontstack}/{range}.pbf",TILES3D_URL_PREFIX:"3dtiles/v1"};function cc(u){return Vr.API_URL_REGEX.test(u)}function Vu(u){return Vr.API_SPRITE_REGEX.test(u)}let uc,ln,Xs,Je,J,re;function oe(){return uc==null&&(uc=self.OffscreenCanvas&&new OffscreenCanvas(1,1).getContext("2d")&&typeof self.createImageBitmap=="function"),uc}const xe={now:()=>Je!==void 0?Je:performance.now(),setNow(u){Je=u},restoreNow(){Je=void 0},frame(u){const n=requestAnimationFrame(u);return{cancel:()=>cancelAnimationFrame(n)}},getImageData(u,n=0){const{width:l,height:d}=u;J||(J=document.createElement("canvas"));const _=J.getContext("2d",{willReadFrequently:!0});if(!_)throw new Error("failed to create canvas 2d context");return(l>J.width||d>J.height)&&(J.width=l,J.height=d),_.clearRect(-n,-n,l+2*n,d+2*n),_.drawImage(u,0,0,l,d),_.getImageData(-n,-n,l+2*n,d+2*n)},resolveURL:u=>(ln||(ln=document.createElement("a")),ln.href=u,ln.href),get devicePixelRatio(){return window.devicePixelRatio},get prefersReducedMotion(){return!!window.matchMedia&&(Xs==null&&(Xs=window.matchMedia("(prefers-reduced-motion: reduce)")),Xs.matches)},hasCanvasFingerprintNoise(){if(re!==void 0)return re;if(!oe())return re=!1,!1;const u=new OffscreenCanvas(85,1),n=u.getContext("2d",{willReadFrequently:!0});let l=0;for(let _=0;_<u.width;++_)n.fillStyle=`rgba(${l++},${l++},${l++}, 255)`,n.fillRect(_,0,1,1);const d=n.getImageData(0,0,u.width,u.height);l=0;for(let _=0;_<d.data.length;++_)if(_%4!=3&&l++!==d.data[_])return re=!0,!0;return re=!1,!1}};function Ee(u,n){const l=u.indexOf("?");if(l<0)return`${u}?${new URLSearchParams(n).toString()}`;const d=new URLSearchParams(u.slice(l));for(const _ in n)d.set(_,n[_]);return`${u.slice(0,l)}?${d.toString()}`}function Be(u,n={persistentParams:[]}){const l=u.indexOf("?");if(l<0)return u;const d=new URLSearchParams,_=new URLSearchParams(u.slice(l));for(const g of n.persistentParams){const w=_.get(g);w&&d.set(g,w)}const f=d.toString();return`${u.slice(0,l)}${f.length>0?`?${f}`:""}`}const He="mapbox-tiles";let De=500,Ze=50;const Xe=["language","worldview","jobid"];let Ke,dt;function It(){try{return caches}catch{}}function Ct(){const u=It();u&&Ke==null&&(Ke=u.open(He))}let Zt=1/0;const ei={supported:!1,testSupport:function(u){!Ii&&Jt&&(Di?ki(u):ti=u)}};let ti,Jt,Ii=!1,Di=!1;const vi=typeof self<"u"?self:{};function ki(u){const n=u.createTexture();u.bindTexture(u.TEXTURE_2D,n);try{if(u.texImage2D(u.TEXTURE_2D,0,u.RGBA,u.RGBA,u.UNSIGNED_BYTE,Jt),u.isContextLost())return;ei.supported=!0}catch{}u.deleteTexture(n),Ii=!0}vi.document&&(Jt=vi.document.createElement("img"),Jt.onload=function(){ti&&ki(ti),ti=null,Di=!0},Jt.onerror=function(){Ii=!0,ti=null},Jt.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA=");const zi={Unknown:"Unknown",Style:"Style",Source:"Source",Tile:"Tile",Glyphs:"Glyphs",SpriteImage:"SpriteImage",SpriteJSON:"SpriteJSON",Iconset:"Iconset",Image:"Image",Model:"Model"};typeof Object.freeze=="function"&&Object.freeze(zi);class Dr extends Error{constructor(n,l,d){l===401&&cc(d)&&(n+=": you may have provided an invalid Mapbox access token. See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes"),super(n),this.status=l,this.url=d}toString(){return`${this.name}: ${this.message} (${this.status}): ${this.url}`}}const Zs=To()?()=>self.worker&&self.worker.referrer:()=>(location.protocol==="blob:"?parent:self).location.href,jr=function(u,n){if(!(/^file:/.test(l=u.url)||/^file:/.test(Zs())&&!/^\w+:/.test(l))){if(self.fetch&&self.Request&&self.AbortController&&Request.prototype.hasOwnProperty("signal"))return function(d,_){const f=new AbortController,g=new Request(d.url,{method:d.method||"GET",body:d.body,credentials:d.credentials,headers:d.headers,referrer:Zs(),referrerPolicy:d.referrerPolicy,signal:f.signal});let w=!1,S=!1;const P=(x=g.url).indexOf("sku=")>0&&cc(x);var x;d.type==="json"&&g.headers.set("Accept","application/json");const I=(E,C,D)=>{if(S)return;if(E&&E.message!=="SecurityError"&&mi(E.toString()),C&&D)return R(C);const N=Date.now();fetch(g).then(z=>{if(z.ok){const G=P?z.clone():null;return R(z,G,N)}return _(new Dr(z.statusText,z.status,d.url))}).catch(z=>{z.name!=="AbortError"&&_(new Error(`${z.message} ${d.url}`))})},R=(E,C,D)=>{(d.type==="arrayBuffer"?E.arrayBuffer():d.type==="json"?E.json():E.text()).then(N=>{S||(C&&D&&function(z,G,W){if(Ct(),Ke==null)return;const H=ll(G.headers.get("Cache-Control")||"");if(H["no-store"])return;const q={status:G.status,statusText:G.statusText,headers:new Headers};G.headers.forEach((he,ce)=>q.headers.set(ce,he)),H["max-age"]&&q.headers.set("Expires",new Date(W+1e3*H["max-age"]).toUTCString());const Y=q.headers.get("Expires");if(!Y||new Date(Y).getTime()-W<42e4)return;let ie=Be(z.url,{persistentParams:Xe});if(G.status===206){const he=z.headers.get("Range");if(!he)return;q.status=200,ie=Ee(ie,{range:he})}(function(he,ce){if(dt===void 0)try{new Response(new ReadableStream),dt=!0}catch{dt=!1}dt?ce(he.body):he.blob().then(ce)})(G,he=>{const ce=new Response((le=G.status)!==200&&le!==404&&[101,103,204,205,304].includes(le)?null:he,q);var le;Ct(),Ke!=null&&Ke.then(Te=>Te.put(ie,ce)).catch(Te=>mi(Te.message))})}(g,C,D),w=!0,_(null,N,E.headers.get("Cache-Control"),E.headers.get("Expires")))}).catch(N=>{S||_(new Error(N.message))})};return P?function(E,C){if(Ct(),Ke==null)return C(null);Ke.then(D=>{let N=Be(E.url,{persistentParams:Xe});const z=E.headers.get("Range");z&&(N=Ee(N,{range:z})),D.match(N).then(G=>{const W=function(H){if(!H)return!1;const q=new Date(H.headers.get("Expires")||0),Y=ll(H.headers.get("Cache-Control")||"");return q>Date.now()&&!Y["no-cache"]}(G);D.delete(N),W&&D.put(N,G.clone()),C(null,G,W)}).catch(C)}).catch(C)}(g,I):I(null,null),{cancel:()=>{S=!0,w||f.abort()}}}(u,n);if(To()&&self.worker&&self.worker.actor)return self.worker.actor.send("getResource",u,n,void 0,!0)}var l;return function(d,_){const f=new XMLHttpRequest;f.open(d.method||"GET",d.url,!0),d.type==="arrayBuffer"&&(f.responseType="arraybuffer");for(const g in d.headers)f.setRequestHeader(g,d.headers[g]);return d.type==="json"&&(f.responseType="text",f.setRequestHeader("Accept","application/json")),f.withCredentials=d.credentials==="include",f.onerror=()=>{_(new Error(f.statusText))},f.onload=()=>{if((f.status>=200&&f.status<300||f.status===0)&&f.response!==null){let g=f.response;if(d.type==="json")try{g=JSON.parse(f.response)}catch(w){return _(w)}_(null,g,f.getResponseHeader("Cache-Control"),f.getResponseHeader("Expires"))}else _(new Dr(f.statusText,f.status,d.url))},f.send(d.body),{cancel:()=>f.abort()}}(u,n)},qr=function(u,n){return jr(Mn(u,{type:"arrayBuffer"}),n)};function Rn(u){const n=document.createElement("a");return n.href=u,n.protocol===location.protocol&&n.host===location.host}const hc="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";let Eo,dc;Eo=[],dc=0;const Dd=function(u,n){if(ei.supported&&(u.headers||(u.headers={}),u.headers.accept="image/webp,*/*"),dc>=Vr.MAX_PARALLEL_IMAGE_REQUESTS){const f={requestParameters:u,callback:n,cancelled:!1,cancel(){this.cancelled=!0}};return Eo.push(f),f}dc++;let l=!1;const d=()=>{if(!l)for(l=!0,dc--;Eo.length&&dc<Vr.MAX_PARALLEL_IMAGE_REQUESTS;){const f=Eo.shift(),{requestParameters:g,callback:w,cancelled:S}=f;S||(f.cancel=Dd(g,w).cancel)}},_=qr(u,(f,g,w,S)=>{d(),f?n(f):g&&(self.createImageBitmap?function(P,x){const I=new Blob([new Uint8Array(P)],{type:"image/png"});createImageBitmap(I).then(R=>{x(null,R)}).catch(R=>{x(new Error(`Could not load image because of ${R.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`))})}(g,(P,x)=>n(P,x,w,S)):function(P,x){const I=new Image;I.onload=()=>{x(null,I),URL.revokeObjectURL(I.src),I.onload=null,requestAnimationFrame(()=>{I.src=hc})},I.onerror=()=>x(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const R=new Blob([new Uint8Array(P)],{type:"image/png"});I.src=P.byteLength?URL.createObjectURL(R):hc}(g,(P,x)=>n(P,x,w,S)))});return{cancel:()=>{_.cancel(),d()}}};var zm,Od,Fd,Pn={exports:{}},Ps={exports:{}},So={exports:{}},Ys=function(){if(Fd)return Pn.exports;Fd=1;var u=(zm||(zm=1,Ps.exports=function(l,d){var _,f,g,w,S,P,x,I;for(f=l.length-(_=3&l.length),g=d,S=3432918353,P=461845907,I=0;I<f;)x=255&l.charCodeAt(I)|(255&l.charCodeAt(++I))<<8|(255&l.charCodeAt(++I))<<16|(255&l.charCodeAt(++I))<<24,++I,g=27492+(65535&(w=5*(65535&(g=(g^=x=(65535&(x=(x=(65535&x)*S+(((x>>>16)*S&65535)<<16)&4294967295)<<15|x>>>17))*P+(((x>>>16)*P&65535)<<16)&4294967295)<<13|g>>>19))+((5*(g>>>16)&65535)<<16)&4294967295))+((58964+(w>>>16)&65535)<<16);switch(x=0,_){case 3:x^=(255&l.charCodeAt(I+2))<<16;case 2:x^=(255&l.charCodeAt(I+1))<<8;case 1:g^=x=(65535&(x=(x=(65535&(x^=255&l.charCodeAt(I)))*S+(((x>>>16)*S&65535)<<16)&4294967295)<<15|x>>>17))*P+(((x>>>16)*P&65535)<<16)&4294967295}return g^=l.length,g=2246822507*(65535&(g^=g>>>16))+((2246822507*(g>>>16)&65535)<<16)&4294967295,g=3266489909*(65535&(g^=g>>>13))+((3266489909*(g>>>16)&65535)<<16)&4294967295,(g^=g>>>16)>>>0}),Ps.exports),n=(Od||(Od=1,So.exports=function(l,d){for(var _,f=l.length,g=d^f,w=0;f>=4;)_=1540483477*(65535&(_=255&l.charCodeAt(w)|(255&l.charCodeAt(++w))<<8|(255&l.charCodeAt(++w))<<16|(255&l.charCodeAt(++w))<<24))+((1540483477*(_>>>16)&65535)<<16),g=1540483477*(65535&g)+((1540483477*(g>>>16)&65535)<<16)^(_=1540483477*(65535&(_^=_>>>24))+((1540483477*(_>>>16)&65535)<<16)),f-=4,++w;switch(f){case 3:g^=(255&l.charCodeAt(w+2))<<16;case 2:g^=(255&l.charCodeAt(w+1))<<8;case 1:g=1540483477*(65535&(g^=255&l.charCodeAt(w)))+((1540483477*(g>>>16)&65535)<<16)}return g=1540483477*(65535&(g^=g>>>13))+((1540483477*(g>>>16)&65535)<<16),(g^=g>>>15)>>>0}),So.exports);return Pn.exports=u,Pn.exports.murmur3=u,Pn.exports.murmur2=n,Pn.exports}(),Bs=T(Ys);class Ks{constructor(n,...l){Mn(this,l[0]||{}),this.type=n}}class ju extends Ks{constructor(n,l={}){super("error",Mn({error:n},l))}}function kd(u,n,l){l[u]&&l[u].indexOf(n)!==-1||(l[u]=l[u]||[],l[u].push(n))}function Jo(u,n,l){if(l&&l[u]){const d=l[u].indexOf(n);d!==-1&&l[u].splice(d,1)}}class Qo{on(n,l){return this._listeners=this._listeners||{},kd(n,l,this._listeners),this}off(n,l){return Jo(n,l,this._listeners),Jo(n,l,this._oneTimeListeners),this}once(n,l){return l?(this._oneTimeListeners=this._oneTimeListeners||{},kd(n,l,this._oneTimeListeners),this):new Promise(d=>this.once(n,d))}fire(n,l){const d=typeof n=="string"?new Ks(n,l):n,_=d.type;if(this.listens(_)){d.target=this;const f=this._listeners&&this._listeners[_]?this._listeners[_].slice():[];for(const S of f)S.call(this,d);const g=this._oneTimeListeners&&this._oneTimeListeners[_]?this._oneTimeListeners[_].slice():[];for(const S of g)Jo(_,S,this._oneTimeListeners),S.call(this,d);const w=this._eventedParent;w&&(Mn(d,typeof this._eventedParentData=="function"?this._eventedParentData():this._eventedParentData),w.fire(d))}else d instanceof ju&&console.error(d.error);return this}listens(n){return!!(this._listeners&&this._listeners[n]&&this._listeners[n].length>0||this._oneTimeListeners&&this._oneTimeListeners[n]&&this._oneTimeListeners[n].length>0||this._eventedParent&&this._eventedParent.listens(n))}setEventedParent(n,l){return this._eventedParent=n,this._eventedParentData=l,this}}var Um,Ld={},As=function(){if(Um)return Ld;Um=1;var u={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function n(f){return(f=Math.round(f))<0?0:f>255?255:f}function l(f){return n(f[f.length-1]==="%"?parseFloat(f)/100*255:parseInt(f))}function d(f){return(g=f[f.length-1]==="%"?parseFloat(f)/100:parseFloat(f))<0?0:g>1?1:g;var g}function _(f,g,w){return w<0?w+=1:w>1&&(w-=1),6*w<1?f+(g-f)*w*6:2*w<1?g:3*w<2?f+(g-f)*(2/3-w)*6:f}try{Ld.parseCSSColor=function(f){var g,w=f.replace(/ /g,"").toLowerCase();if(w in u)return u[w].slice();if(w[0]==="#")return w.length===4?(g=parseInt(w.substr(1),16))>=0&&g<=4095?[(3840&g)>>4|(3840&g)>>8,240&g|(240&g)>>4,15&g|(15&g)<<4,1]:null:w.length===7&&(g=parseInt(w.substr(1),16))>=0&&g<=16777215?[(16711680&g)>>16,(65280&g)>>8,255&g,1]:null;var S=w.indexOf("("),P=w.indexOf(")");if(S!==-1&&P+1===w.length){var x=w.substr(0,S),I=w.substr(S+1,P-(S+1)).split(","),R=1;switch(x){case"rgba":if(I.length!==4)return null;R=d(I.pop());case"rgb":return I.length!==3?null:[l(I[0]),l(I[1]),l(I[2]),R];case"hsla":if(I.length!==4)return null;R=d(I.pop());case"hsl":if(I.length!==3)return null;var E=(parseFloat(I[0])%360+360)%360/360,C=d(I[1]),D=d(I[2]),N=D<=.5?D*(C+1):D+C-D*C,z=2*D-N;return[n(255*_(z,N,E+1/3)),n(255*_(z,N,E)),n(255*_(z,N,E-1/3)),R];default:return null}}return null}}catch{}return Ld}();class Vi{constructor(n,l,d,_=1){this.r=n,this.g=l,this.b=d,this.a=_}static parse(n){if(!n)return;if(n instanceof Vi)return n;if(typeof n!="string")return;const l=As.parseCSSColor(n);return l?new Vi(l[0]/255*l[3],l[1]/255*l[3],l[2]/255*l[3],l[3]):void 0}toStringPremultipliedAlpha(){const[n,l,d,_]=this.a===0?[0,0,0,0]:[255*this.r/this.a,255*this.g/this.a,255*this.b/this.a,this.a];return`rgba(${Math.round(n)},${Math.round(l)},${Math.round(d)},${_})`}toString(){const[n,l,d,_]=[this.r,this.g,this.b,this.a];return`rgba(${Math.round(255*n)},${Math.round(255*l)},${Math.round(255*d)},${_})`}toRenderColor(n){const{r:l,g:d,b:_,a:f}=this;return new Nd(n,l,d,_,f)}clone(){return new Vi(this.r,this.g,this.b,this.a)}}class Nd{constructor(n,l,d,_,f){if(n){const g=n.image.height,w=g*g;l=f===0?0:l/f*(g-1),d=f===0?0:d/f*(g-1),_=f===0?0:_/f*(g-1);const S=Math.floor(l),P=Math.floor(d),x=Math.floor(_),I=Math.ceil(l),R=Math.ceil(d),E=Math.ceil(_),C=l-S,D=d-P,N=_-x,z=n.image.data,G=4*(S+P*w+x*g),W=4*(S+P*w+E*g),H=4*(S+R*w+x*g),q=4*(S+R*w+E*g),Y=4*(I+P*w+x*g),ie=4*(I+P*w+E*g),he=4*(I+R*w+x*g),ce=4*(I+R*w+E*g);if(G<0||ce>=z.length)throw new Error("out of range");this.r=ii(ii(ii(z[G],z[W],N),ii(z[H],z[q],N),D),ii(ii(z[Y],z[ie],N),ii(z[he],z[ce],N),D),C)/255*f,this.g=ii(ii(ii(z[G+1],z[W+1],N),ii(z[H+1],z[q+1],N),D),ii(ii(z[Y+1],z[ie+1],N),ii(z[he+1],z[ce+1],N),D),C)/255*f,this.b=ii(ii(ii(z[G+2],z[W+2],N),ii(z[H+2],z[q+2],N),D),ii(ii(z[Y+2],z[ie+2],N),ii(z[he+2],z[ce+2],N),D),C)/255*f,this.a=f}else this.r=l,this.g=d,this.b=_,this.a=f}toArray(){const{r:n,g:l,b:d,a:_}=this;return _===0?[0,0,0,0]:[255*n/_,255*l/_,255*d/_,_]}toHslaArray(){if(this.a===0)return[0,0,0,0];const{r:n,g:l,b:d,a:_}=this,f=Math.min(Math.max(n/_,0),1),g=Math.min(Math.max(l/_,0),1),w=Math.min(Math.max(d/_,0),1),S=Math.min(f,g,w),P=Math.max(f,g,w),x=(S+P)/2;if(S===P)return[0,0,100*x,_];const I=P-S,R=x>.5?I/(2-P-S):I/(P+S);let E=0;return P===f?E=(g-w)/I+(g<w?6:0):P===g?E=(w-f)/I+2:P===w&&(E=(f-g)/I+4),E*=60,[Math.min(Math.max(E,0),360),Math.min(Math.max(100*R,0),100),Math.min(Math.max(100*x,0),100),_]}toArray01(){const{r:n,g:l,b:d,a:_}=this;return _===0?[0,0,0,0]:[n/_,l/_,d/_,_]}toArray01Scaled(n){const{r:l,g:d,b:_,a:f}=this;return f===0?[0,0,0]:[l/f*n,d/f*n,_/f*n]}toArray01PremultipliedAlpha(){const{r:n,g:l,b:d,a:_}=this;return[n,l,d,_]}toArray01Linear(){const{r:n,g:l,b:d,a:_}=this;return _===0?[0,0,0,0]:[Math.pow(n/_,2.2),Math.pow(l/_,2.2),Math.pow(d/_,2.2),_]}}function ii(u,n,l){return u*(1-l)+n*l}function Vm(u,n,l){return u.map((d,_)=>ii(d,n[_],l))}Vi.black=new Vi(0,0,0,1),Vi.white=new Vi(1,1,1,1),Vi.transparent=new Vi(0,0,0,0),Vi.red=new Vi(1,0,0,1),Vi.blue=new Vi(0,0,1,1);var Hu=Object.freeze({__proto__:null,array:Vm,color:function(u,n,l){return new Vi(ii(u.r,n.r,l),ii(u.g,n.g,l),ii(u.b,n.b,l),ii(u.a,n.a,l))},number:ii});function Gu(u,...n){for(const l of n)for(const d in l)u[d]=l[d];return u}class bi extends Error{constructor(n,l){super(l),this.message=l,this.key=n}}class $u{constructor(n,l=[]){this.parent=n,this.bindings={};for(const[d,_]of l)this.bindings[d]=_}concat(n){return new $u(this,n)}get(n){if(this.bindings[n])return this.bindings[n];if(this.parent)return this.parent.get(n);throw new Error(`${n} not found in scope.`)}has(n){return!!this.bindings[n]||!!this.parent&&this.parent.has(n)}}const Ea={kind:"null"},jt={kind:"number"},$i={kind:"string"},Oi={kind:"boolean"},yn={kind:"color"},Io={kind:"object"},Ni={kind:"value"},fc={kind:"collator"},Js={kind:"formatted"},pc={kind:"resolvedImage"};function rn(u,n){return{kind:"array",itemType:u,N:n}}function wr(u){if(u.kind==="array"){const n=wr(u.itemType);return typeof u.N=="number"?`array<${n}, ${u.N}>`:u.itemType.kind==="value"?"array":`array<${n}>`}return u.kind}const zd=[Ea,jt,$i,Oi,yn,Js,Io,rn(Ni),pc];function zn(u,n){if(n.kind==="error")return null;if(u.kind==="array"){if(n.kind==="array"&&(n.N===0&&n.itemType.kind==="value"||!zn(u.itemType,n.itemType))&&(typeof u.N!="number"||u.N===n.N))return null}else{if(u.kind===n.kind)return null;if(u.kind==="value"){for(const l of zd)if(!zn(l,n))return null}}return`Expected ${wr(u)} but found ${wr(n)} instead.`}function Wu(u,n){return n.some(l=>l.kind===u.kind)}function mc(u,n){return n.some(l=>l==="null"?u===null:l==="array"?Array.isArray(u):l==="object"?u&&!Array.isArray(u)&&typeof u=="object":l===typeof u)}class qu{constructor(n,l,d){this.sensitivity=n?l?"variant":"case":l?"accent":"base",this.locale=d,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(n,l){return this.collator.compare(n,l)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class _c{constructor(n,l,d,_,f){this.text=n.normalize?n.normalize():n,this.image=l,this.scale=d,this.fontStack=_,this.textColor=f}}class vn{constructor(n){this.sections=n}static fromString(n){return new vn([new _c(n,null,null,null,null)])}isEmpty(){return this.sections.length===0||!this.sections.some(n=>n.text.length!==0||n.image&&n.image.namePrimary)}static factory(n){return n instanceof vn?n:vn.fromString(n)}toString(){return this.sections.length===0?"":this.sections.map(n=>n.text).join("")}serialize(){const n=["format"];for(const l of this.sections){if(l.image){n.push(["image",l.image.namePrimary]);continue}n.push(l.text);const d={};l.fontStack&&(d["text-font"]=["literal",l.fontStack.split(",")]),l.scale&&(d["font-scale"]=l.scale),l.textColor&&(d["text-color"]=["rgba"].concat(l.textColor.toRenderColor(null).toArray())),n.push(d)}return n}}class Qs{constructor(n,l){if(this.id=n,this.options=l||{params:{}},this.options.transform){const{a:d,b:_,c:f,d:g,e:w,f:S}=this.options.transform;this.options.transform=new DOMMatrix([d,_,f,g,w,S])}else this.options.transform=new DOMMatrix([1,0,0,1,0,0])}static deserializeId(n){return JSON.parse(n).id}static deserializeFromString(n){const l=JSON.parse(n),{a:d,b:_,c:f,d:g,e:w,f:S}=l.options.transform;return new DOMMatrix([d,_,f,g,w,S]),new Qs(l.id,l.options)}scaleSelf(n){return this.options.transform=this.options.transform.scale(n),this}serialize(){const n={id:this.id};this.options&&(n.options=this.options);const{a:l,b:d,c:_,d:f,e:g,f:w}=this.options.transform;return n.options.transform={a:l,b:d,c:_,d:f,e:g,f:w},JSON.stringify(n)}}class cn{constructor(n){this.namePrimary=n.namePrimary,n.nameSecondary&&(this.nameSecondary=n.nameSecondary),n.optionsPrimary&&(this.optionsPrimary=n.optionsPrimary),n.optionsSecondary&&(this.optionsSecondary=n.optionsSecondary),this.available=n.available}toString(){return this.namePrimary&&this.nameSecondary?`[${this.namePrimary},${this.nameSecondary}]`:this.namePrimary}getPrimary(){return new Qs(this.namePrimary,{params:this.optionsPrimary&&this.optionsPrimary.params||{}})}getSerializedPrimary(){return this.getPrimary().serialize()}getSecondary(){return this.nameSecondary?new Qs(this.nameSecondary,{params:this.optionsSecondary&&this.optionsSecondary.params||{}}):null}static from(n){return typeof n=="string"?cn.build(n):n}static build(n,l,d,_){return n?new cn({namePrimary:n,nameSecondary:l,optionsPrimary:d,optionsSecondary:_,available:!1}):null}}function Ud(u,n,l,d){return typeof u=="number"&&u>=0&&u<=255&&typeof n=="number"&&n>=0&&n<=255&&typeof l=="number"&&l>=0&&l<=255?d===void 0||typeof d=="number"&&d>=0&&d<=1?null:`Invalid rgba value [${[u,n,l,d].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${(typeof d=="number"?[u,n,l,d]:[u,n,l]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function Co(u){if(u===null||typeof u=="string"||typeof u=="boolean"||typeof u=="number"||u instanceof Vi||u instanceof qu||u instanceof vn||u instanceof cn)return!0;if(Array.isArray(u)){for(const n of u)if(!Co(n))return!1;return!0}if(typeof u=="object"){for(const n in u)if(!Co(u[n]))return!1;return!0}return!1}function yr(u){if(u===null)return Ea;if(typeof u=="string")return $i;if(typeof u=="boolean")return Oi;if(typeof u=="number")return jt;if(u instanceof Vi)return yn;if(u instanceof qu)return fc;if(u instanceof vn)return Js;if(u instanceof cn)return pc;if(Array.isArray(u)){const n=u.length;let l;for(const d of u){const _=yr(d);if(l){if(l===_)continue;l=Ni;break}l=_}return rn(l||Ni,n)}return Io}function Ts(u){const n=typeof u;return u===null?"":n==="string"||n==="number"||n==="boolean"?String(u):u instanceof Vi?u.toStringPremultipliedAlpha():u instanceof vn||u instanceof cn?u.toString():JSON.stringify(u)}class nn{constructor(n,l){this.type=n,this.value=l}static parse(n,l){if(n.length!==2)return l.error(`'literal' expression requires exactly one argument, but found ${n.length-1} instead.`);if(!Co(n[1]))return l.error("invalid value");const d=n[1];let _=yr(d);const f=l.expectedType;return _.kind!=="array"||_.N!==0||!f||f.kind!=="array"||typeof f.N=="number"&&f.N!==0||(_=f),new nn(_,d)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return this.type.kind==="array"||this.type.kind==="object"?["literal",this.value]:this.value instanceof Vi?["rgba"].concat(this.value.toRenderColor(null).toArray()):this.value instanceof vn?this.value.serialize():this.value}}class Or{constructor(n){this.name="ExpressionEvaluationError",this.message=n}toJSON(){return this.message}}const gc={string:$i,number:jt,boolean:Oi,object:Io};class Ds{constructor(n,l){this.type=n,this.args=l}static parse(n,l){if(n.length<2)return l.error("Expected at least one argument.");let d,_=1;const f=n[0];if(f==="array"){let w,S;if(n.length>2){const P=n[1];if(typeof P!="string"||!(P in gc)||P==="object")return l.error('The item type argument of "array" must be one of string, number, boolean',1);w=gc[P],_++}else w=Ni;if(n.length>3){if(n[2]!==null&&(typeof n[2]!="number"||n[2]<0||n[2]!==Math.floor(n[2])))return l.error('The length argument to "array" must be a positive integer literal',2);S=n[2],_++}d=rn(w,S)}else d=gc[f];const g=[];for(;_<n.length;_++){const w=l.parse(n[_],_,Ni);if(!w)return null;g.push(w)}return new Ds(d,g)}evaluate(n){for(let l=0;l<this.args.length;l++){const d=this.args[l].evaluate(n);if(!zn(this.type,yr(d)))return d;if(l===this.args.length-1)throw new Or(`The expression ${JSON.stringify(this.args[l].serialize())} evaluated to ${wr(yr(d))} but was expected to be of type ${wr(this.type)}.`)}return null}eachChild(n){this.args.forEach(n)}outputDefined(){return this.args.every(n=>n.outputDefined())}serialize(){const n=this.type,l=[n.kind];if(n.kind==="array"){const d=n.itemType;if(d.kind==="string"||d.kind==="number"||d.kind==="boolean"){l.push(d.kind);const _=n.N;(typeof _=="number"||this.args.length>1)&&l.push(_)}}return l.concat(this.args.map(d=>d.serialize()))}}class Sa{constructor(n){this.type=Js,this.sections=n}static parse(n,l){if(n.length<2)return l.error("Expected at least one argument.");const d=n[1];if(!Array.isArray(d)&&typeof d=="object")return l.error("First argument must be an image or text section.");const _=[];let f=!1;for(let g=1;g<=n.length-1;++g){const w=n[g];if(f&&typeof w=="object"&&!Array.isArray(w)){f=!1;let S=null;if(w["font-scale"]&&(S=l.parseObjectValue(w["font-scale"],g,"font-scale",jt),!S))return null;let P=null;if(w["text-font"]&&(P=l.parseObjectValue(w["text-font"],g,"text-font",rn($i)),!P))return null;let x=null;if(w["text-color"]&&(x=l.parseObjectValue(w["text-color"],g,"text-color",yn),!x))return null;const I=_[_.length-1];I.scale=S,I.font=P,I.textColor=x}else{const S=l.parse(n[g],g,Ni);if(!S)return null;const P=S.type.kind;if(P!=="string"&&P!=="value"&&P!=="null"&&P!=="resolvedImage")return l.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");f=!0,_.push({content:S,scale:null,font:null,textColor:null})}}return new Sa(_)}evaluate(n){return new vn(this.sections.map(l=>{const d=l.content.evaluate(n);return yr(d)===pc?new _c("",d,null,null,null):new _c(Ts(d),null,l.scale?l.scale.evaluate(n):null,l.font?l.font.evaluate(n).join(","):null,l.textColor?l.textColor.evaluate(n):null)}))}eachChild(n){for(const l of this.sections)n(l.content),l.scale&&n(l.scale),l.font&&n(l.font),l.textColor&&n(l.textColor)}outputDefined(){return!1}serialize(){const n=["format"];for(const l of this.sections){n.push(l.content.serialize());const d={};l.scale&&(d["font-scale"]=l.scale.serialize()),l.font&&(d["text-font"]=l.font.serialize()),l.textColor&&(d["text-color"]=l.textColor.serialize()),n.push(d)}return n}}class yc{constructor(n,l,d,_){this._imageWarnHistory={},this.type=pc,this.inputPrimary=n,this.inputSecondary=l,this.inputPrimaryParams=d,this.inputSecondaryParams=_}static parse(n,l){if(n.length<2)return l.error("Expected two or more arguments.");let d=1;const _=[];function f(){if(d<n.length){const w=l.parse(n[d],d++,$i);return w?(_.push({image:w,options:void 0}),!0):(l.error(_.length?"Secondary image variant is not a string.":"No image name provided."),!1)}return!0}function g(){if(d<n.length){if((w=n[d])===null||typeof w!="object"||Array.isArray(w))return!0;const S=n[d].params,P=l.concat(d);if(!S)return d++,!0;if(typeof S!="object"||S.constructor!==Object)return P.error('Image options "params" should be an object'),!1;const x={},I=P.concat(void 0,"params");for(const R in S){if(!R)return I.error("Image parameter name should be non-empty"),!1;const E=I.concat(void 0,R).parse(S[R],void 0,yn,void 0,{typeAnnotation:"coerce"});if(!E)return!1;x[R]=E}return _[_.length-1].options=x,d++,!0}var w;return!0}for(let w=0;w<2;w++)if(!f()||!g())return;return new yc(_[0].image,_[1]?_[1].image:void 0,_[0].options,_[1]?_[1].options:void 0)}evaluateParams(n,l){const d={};if(l){for(const _ in l)if(l[_])try{const f=l[_].evaluate(n),g=`Ignoring image parameter "${_}" with semi-transparent color ${f.toString()}`;if(f.a!==1){this._imageWarnHistory[g]||(console.warn(g),this._imageWarnHistory[g]=!0);continue}d[_]=f}catch{continue}if(Object.keys(d).length!==0)return{params:d}}}evaluate(n){const l=cn.build(this.inputPrimary.evaluate(n),this.inputSecondary?this.inputSecondary.evaluate(n):void 0,this.inputPrimaryParams?this.evaluateParams(n,this.inputPrimaryParams):void 0,this.inputSecondaryParams?this.evaluateParams(n,this.inputSecondaryParams):void 0);return l&&n.availableImages&&(l.available=n.availableImages.indexOf(l.namePrimary)>-1,l.nameSecondary&&l.available&&n.availableImages&&(l.available=n.availableImages.indexOf(l.nameSecondary)>-1)),l}eachChild(n){if(n(this.inputPrimary),this.inputPrimaryParams)for(const l in this.inputPrimaryParams)this.inputPrimaryParams[l]&&n(this.inputPrimaryParams[l]);if(this.inputSecondary&&(n(this.inputSecondary),this.inputSecondaryParams))for(const l in this.inputSecondaryParams)this.inputSecondaryParams[l]&&n(this.inputSecondaryParams[l])}outputDefined(){return!1}serializeParams(n){const l={};if(n){for(const d in n)n[d]&&(l[d]=n[d].serialize());return{params:l}}}serialize(){const n=["image",this.inputPrimary.serialize()];return this.inputPrimaryParams&&n.push(this.serializeParams(this.inputPrimaryParams)),this.inputSecondary&&(n.push(this.inputSecondary.serialize()),this.inputSecondaryParams&&n.push(this.serializeParams(this.inputSecondaryParams))),n}}function Os(u){return u instanceof Number?"number":u instanceof String?"string":u instanceof Boolean?"boolean":Array.isArray(u)?"array":u===null?"null":typeof u}const Vd={"to-boolean":Oi,"to-color":yn,"to-number":jt,"to-string":$i};class Mo{constructor(n,l){this.type=n,this.args=l}static parse(n,l){if(n.length<2)return l.error("Expected at least one argument.");const d=n[0],_=[];let f=Ea;if(d==="to-array"){if(!Array.isArray(n[1]))return null;const g=n[1].length;if(l.expectedType){if(l.expectedType.kind!=="array")return l.error(`Expected ${l.expectedType.kind} but found array.`);f=rn(l.expectedType.itemType,g)}else{if(!(g>0&&Co(n[1][0])))return null;f=rn(yr(n[1][0]),g)}for(let w=0;w<g;w++){const S=n[1][w];let P;if(Os(S)==="array")P=l.parse(S,void 0,f.itemType);else{const x=Os(S);if(x!==f.itemType.kind)return l.error(`Expected ${f.itemType.kind} but found ${x}.`);P=l.registry.literal.parse(["literal",S===void 0?null:S],l)}if(!P)return null;_.push(P)}}else{if((d==="to-boolean"||d==="to-string")&&n.length!==2)return l.error("Expected one argument.");f=Vd[d];for(let g=1;g<n.length;g++){const w=l.parse(n[g],g,Ni);if(!w)return null;_.push(w)}}return new Mo(f,_)}evaluate(n){if(this.type.kind==="boolean")return!!this.args[0].evaluate(n);if(this.type.kind==="color"){let l,d;for(const _ of this.args){if(l=_.evaluate(n),d=null,l instanceof Vi)return l;if(typeof l=="string"){const f=n.parseColor(l);if(f)return f}else if(Array.isArray(l)&&(d=l.length<3||l.length>4?`Invalid rbga value ${JSON.stringify(l)}: expected an array containing either three or four numeric values.`:Ud(l[0],l[1],l[2],l[3]),!d))return new Vi(l[0]/255,l[1]/255,l[2]/255,l[3])}throw new Or(d||`Could not parse color from value '${typeof l=="string"?l:String(JSON.stringify(l))}'`)}if(this.type.kind==="number"){let l=null;for(const d of this.args){if(l=d.evaluate(n),l===null)return 0;const _=Number(l);if(!isNaN(_))return _}throw new Or(`Could not convert ${JSON.stringify(l)} to number.`)}return this.type.kind==="formatted"?vn.fromString(Ts(this.args[0].evaluate(n))):this.type.kind==="resolvedImage"?cn.build(Ts(this.args[0].evaluate(n))):this.type.kind==="array"?this.args.map(l=>l.evaluate(n)):Ts(this.args[0].evaluate(n))}eachChild(n){this.args.forEach(n)}outputDefined(){return this.args.every(n=>n.outputDefined())}serialize(){if(this.type.kind==="formatted")return new Sa([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if(this.type.kind==="resolvedImage")return new yc(this.args[0]).serialize();const n=this.type.kind==="array"?[]:[`to-${this.type.kind}`];return this.eachChild(l=>{n.push(l.serialize())}),n}}const S0=["Unknown","Point","LineString","Polygon"];class jd{constructor(n,l){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null,this.scope=n,this.options=l}id(){return this.feature&&this.feature.id!==void 0?this.feature.id:null}geometryType(){return this.feature?typeof this.feature.type=="number"?S0[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}measureLight(n){return this.globals.brightness||0}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){const n=this.featureDistanceData.center,l=this.featureDistanceData.scale,{x:d,y:_}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(d*l-n[0])+this.featureDistanceData.bearing[1]*(_*l-n[1])}return 0}parseColor(n){let l=this._parseColorCache[n];return l||(l=this._parseColorCache[n]=Vi.parse(n)),l}getConfig(n){return this.options?this.options.get(n):null}}class Un{constructor(n,l,d,_,f){this.name=n,this.type=l,this._evaluate=d,this.args=_,this._overloadIndex=f}evaluate(n){if(!this._evaluate){const l=Un.definitions[this.name];this._evaluate=Array.isArray(l)?l[2]:l.overloads[this._overloadIndex][1]}return this._evaluate(n,this.args)}eachChild(n){this.args.forEach(n)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map(n=>n.serialize()))}static parse(n,l){const d=n[0],_=Un.definitions[d];if(!_)return l.error(`Unknown expression "${d}". If you wanted a literal array, use ["literal", [...]].`,0);const f=Array.isArray(_)?_[0]:_.type,g=Array.isArray(_)?[[_[1],_[2]]]:_.overloads,w=[];let S=null,P=-1;for(const[x,I]of g){if(Array.isArray(x)&&x.length!==n.length-1)continue;w.push(x),P++,S=new Cc(l.registry,l.path,null,l.scope,void 0,l._scope,l.options);const R=[];let E=!1;for(let C=1;C<n.length;C++){const D=n[C],N=Array.isArray(x)?x[C-1]:x.type,z=S.parse(D,1+R.length,N);if(!z){E=!0;break}R.push(z)}if(!E)if(Array.isArray(x)&&x.length!==R.length)S.error(`Expected ${x.length} arguments, but found ${R.length} instead.`);else{for(let C=0;C<R.length;C++){const D=Array.isArray(x)?x[C]:x.type,N=R[C];S.concat(C+1).checkSubtype(D,N.type)}if(S.errors.length===0)return new Un(d,f,I,R,P)}}if(w.length===1)l.errors.push(...S.errors);else{const x=(w.length?w:g.map(([R])=>R)).map(Hd).join(" | "),I=[];for(let R=1;R<n.length;R++){const E=l.parse(n[R],1+I.length);if(!E)return null;I.push(wr(E.type))}l.error(`Expected arguments of type ${x}, but found (${I.join(", ")}) instead.`)}return null}static register(n,l){Un.definitions=l;for(const d in l)n[d]=Un}}function Hd(u){return Array.isArray(u)?`(${u.map(wr).join(", ")})`:`(${wr(u.type)}...)`}class Xu{constructor(n,l,d){this.type=fc,this.locale=d,this.caseSensitive=n,this.diacriticSensitive=l}static parse(n,l){if(n.length!==2)return l.error("Expected one argument.");const d=n[1];if(typeof d!="object"||Array.isArray(d))return l.error("Collator options argument must be an object.");const _=d["case-sensitive"]===void 0?l.parse(!1,1,Oi):l.parseObjectValue(d["case-sensitive"],1,"case-sensitive",Oi);if(!_)return null;const f=d["diacritic-sensitive"]===void 0?l.parse(!1,1,Oi):l.parseObjectValue(d["diacritic-sensitive"],1,"diacritic-sensitive",Oi);if(!f)return null;let g=null;return d.locale&&(g=l.parseObjectValue(d.locale,1,"locale",$i),!g)?null:new Xu(_,f,g)}evaluate(n){return new qu(this.caseSensitive.evaluate(n),this.diacriticSensitive.evaluate(n),this.locale?this.locale.evaluate(n):null)}eachChild(n){n(this.caseSensitive),n(this.diacriticSensitive),this.locale&&n(this.locale)}outputDefined(){return!1}serialize(){const n={};return n["case-sensitive"]=this.caseSensitive.serialize(),n["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(n.locale=this.locale.serialize()),["collator",n]}}function vc(u,n,l=0,d=u.length-1,_=I0){for(;d>l;){if(d-l>600){const S=d-l+1,P=n-l+1,x=Math.log(S),I=.5*Math.exp(2*x/3),R=.5*Math.sqrt(x*I*(S-I)/S)*(P-S/2<0?-1:1);vc(u,n,Math.max(l,Math.floor(n-P*I/S+R)),Math.min(d,Math.floor(n+(S-P)*I/S+R)),_)}const f=u[n];let g=l,w=d;for(xc(u,l,n),_(u[d],f)>0&&xc(u,l,d);g<w;){for(xc(u,g,w),g++,w--;_(u[g],f)<0;)g++;for(;_(u[w],f)>0;)w--}_(u[l],f)===0?xc(u,l,w):(w++,xc(u,w,d)),w<=n&&(l=w+1),n<=w&&(d=w-1)}}function xc(u,n,l){const d=u[n];u[n]=u[l],u[l]=d}function I0(u,n){return u<n?-1:u>n?1:0}function C0(u){let n=0;for(let l,d,_=0,f=u.length,g=f-1;_<f;g=_++)l=u[_],d=u[g],n+=(d.x-l.x)*(l.y+d.y);return n}function bc(u,n){u[0]=Math.min(u[0],n[0]),u[1]=Math.min(u[1],n[1]),u[2]=Math.max(u[2],n[0]),u[3]=Math.max(u[3],n[1])}function wc(u,n){return!(u[0]<=n[0]||u[2]>=n[2]||u[1]<=n[1]||u[3]>=n[3])}function M0(u,n,l){const d=u[0]-n[0],_=u[1]-n[1],f=u[0]-l[0],g=u[1]-l[1];return d*g-f*_==0&&d*f<=0&&_*g<=0}function dl(u,n,l=!1){let d=!1;for(let w=0,S=n.length;w<S;w++){const P=n[w];for(let x=0,I=P.length,R=I-1;x<I;R=x++){const E=P[R],C=P[x];if(M0(u,E,C))return l;(f=E)[1]>(_=u)[1]!=(g=C)[1]>_[1]&&_[0]<(g[0]-f[0])*(_[1]-f[1])/(g[1]-f[1])+f[0]&&(d=!d)}}var _,f,g;return d}function Gd(u,n,l,d){const _=d[0]-l[0],f=d[1]-l[1],g=(u[0]-l[0])*f-_*(u[1]-l[1]),w=(n[0]-l[0])*f-_*(n[1]-l[1]);return g>0&&w<0||g<0&&w>0}function Ro(u,n,l,d){return(_=[d[0]-l[0],d[1]-l[1]])[0]*(f=[n[0]-u[0],n[1]-u[1]])[1]-_[1]*f[0]!=0&&!(!Gd(u,n,l,d)||!Gd(l,d,u,n));var _,f}const ea=8192;function R0(u,n){const l=(180+u[0])/360,d=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+u[1]*Math.PI/360)))/360,_=Math.pow(2,n.z);return[Math.round(l*_*ea),Math.round(d*_*ea)]}function $d(u,n){for(let l=0;l<n.length;l++)if(dl(u,n[l]))return!0;return!1}function P0(u,n,l){for(const d of l)for(let _=0,f=d.length,g=f-1;_<f;g=_++)if(Ro(u,n,d[g],d[_]))return!0;return!1}function jm(u,n){for(let l=0;l<u.length;++l)if(!dl(u[l],n))return!1;for(let l=0;l<u.length-1;++l)if(P0(u[l],u[l+1],n))return!1;return!0}function B0(u,n){for(let l=0;l<n.length;l++)if(jm(u,n[l]))return!0;return!1}function Wd(u,n,l){const d=[];for(let _=0;_<u.length;_++){const f=[];for(let g=0;g<u[_].length;g++){const w=R0(u[_][g],l);bc(n,w),f.push(w)}d.push(f)}return d}function Ia(u,n,l){const d=[];for(let _=0;_<u.length;_++){const f=Wd(u[_],n,l);d.push(f)}return d}function xi(u,n,l,d){if(u[0]<l[0]||u[0]>l[2]){const _=.5*d;let f=u[0]-l[0]>_?-d:l[0]-u[0]>_?d:0;f===0&&(f=u[0]-l[2]>_?-d:l[2]-u[0]>_?d:0),u[0]+=f}bc(n,u)}function Yt(u,n,l,d){const _=Math.pow(2,d.z)*ea,f=[d.x*ea,d.y*ea],g=[];if(!u)return g;for(const w of u)for(const S of w){const P=[S.x+f[0],S.y+f[1]];xi(P,n,l,_),g.push(P)}return g}function Zu(u,n,l,d){const _=Math.pow(2,d.z)*ea,f=[d.x*ea,d.y*ea],g=[];if(!u)return g;for(const S of u){const P=[];for(const x of S){const I=[x.x+f[0],x.y+f[1]];bc(n,I),P.push(I)}g.push(P)}if(n[2]-n[0]<=_/2){(w=n)[0]=w[1]=1/0,w[2]=w[3]=-1/0;for(const S of g)for(const P of S)xi(P,n,l,_)}var w;return g}class oi{constructor(n,l){this.type=Oi,this.geojson=n,this.geometries=l}static parse(n,l){if(n.length!==2)return l.error(`'within' expression requires exactly one argument, but found ${n.length-1} instead.`);if(Co(n[1])){const d=n[1];if(d.type==="FeatureCollection")for(let _=0;_<d.features.length;++_){const f=d.features[_].geometry.type;if(f==="Polygon"||f==="MultiPolygon")return new oi(d,d.features[_].geometry)}else if(d.type==="Feature"){const _=d.geometry.type;if(_==="Polygon"||_==="MultiPolygon")return new oi(d,d.geometry)}else if(d.type==="Polygon"||d.type==="MultiPolygon")return new oi(d,d)}return l.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(n){if(n.geometry()!=null&&n.canonicalID()!=null){if(n.geometryType()==="Point")return function(l,d){const _=[1/0,1/0,-1/0,-1/0],f=[1/0,1/0,-1/0,-1/0],g=l.canonicalID();if(!g)return!1;if(d.type==="Polygon"){const w=Wd(d.coordinates,f,g),S=Yt(l.geometry(),_,f,g);if(!wc(_,f))return!1;for(const P of S)if(!dl(P,w))return!1}if(d.type==="MultiPolygon"){const w=Ia(d.coordinates,f,g),S=Yt(l.geometry(),_,f,g);if(!wc(_,f))return!1;for(const P of S)if(!$d(P,w))return!1}return!0}(n,this.geometries);if(n.geometryType()==="LineString")return function(l,d){const _=[1/0,1/0,-1/0,-1/0],f=[1/0,1/0,-1/0,-1/0],g=l.canonicalID();if(!g)return!1;if(d.type==="Polygon"){const w=Wd(d.coordinates,f,g),S=Zu(l.geometry(),_,f,g);if(!wc(_,f))return!1;for(const P of S)if(!jm(P,w))return!1}if(d.type==="MultiPolygon"){const w=Ia(d.coordinates,f,g),S=Zu(l.geometry(),_,f,g);if(!wc(_,f))return!1;for(const P of S)if(!B0(P,w))return!1}return!0}(n,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}}const fl={kilometers:1,miles:1e3/1609.344,nauticalmiles:1e3/1852,meters:1e3,metres:1e3,yards:1e3/.9144,feet:1e3/.3048,inches:1e3/.0254},Yu=1/298.257223563,li=Yu*(2-Yu),pl=Math.PI/180;class Ca{static fromTile(n,l,d){const _=Math.PI*(1-2*(n+.5)/Math.pow(2,l)),f=Math.atan(.5*(Math.exp(_)-Math.exp(-_)))/pl;return new Ca(f,d)}static get units(){return fl}constructor(n,l){if(n===void 0)throw new Error("No latitude given.");if(l&&!fl[l])throw new Error(`Unknown unit ${l}. Use one of: ${Object.keys(fl).join(", ")}`);const d=6378.137*pl*(l?fl[l]:1),_=Math.cos(n*pl),f=1/(1-li*(1-_*_)),g=Math.sqrt(f);this.kx=d*g*_,this.ky=d*g*f*(1-li)}distance(n,l){const d=Vn(n[0]-l[0])*this.kx,_=(n[1]-l[1])*this.ky;return Math.sqrt(d*d+_*_)}bearing(n,l){const d=Vn(l[0]-n[0])*this.kx;return Math.atan2(d,(l[1]-n[1])*this.ky)/pl}destination(n,l,d){const _=d*pl;return this.offset(n,Math.sin(_)*l,Math.cos(_)*l)}offset(n,l,d){return[n[0]+l/this.kx,n[1]+d/this.ky]}lineDistance(n){let l=0;for(let d=0;d<n.length-1;d++)l+=this.distance(n[d],n[d+1]);return l}area(n){let l=0;for(let d=0;d<n.length;d++){const _=n[d];for(let f=0,g=_.length,w=g-1;f<g;w=f++)l+=Vn(_[f][0]-_[w][0])*(_[f][1]+_[w][1])*(d?-1:1)}return Math.abs(l)/2*this.kx*this.ky}along(n,l){let d=0;if(l<=0)return n[0];for(let _=0;_<n.length-1;_++){const f=n[_],g=n[_+1],w=this.distance(f,g);if(d+=w,d>l)return Ku(f,g,(l-(d-w))/w)}return n[n.length-1]}pointToSegmentDistance(n,l,d){let[_,f]=l,g=Vn(d[0]-_)*this.kx,w=(d[1]-f)*this.ky;if(g!==0||w!==0){const S=(Vn(n[0]-_)*this.kx*g+(n[1]-f)*this.ky*w)/(g*g+w*w);S>1?(_=d[0],f=d[1]):S>0&&(_+=g/this.kx*S,f+=w/this.ky*S)}return g=Vn(n[0]-_)*this.kx,w=(n[1]-f)*this.ky,Math.sqrt(g*g+w*w)}pointOnLine(n,l){let d=1/0,_=n[0][0],f=n[0][1],g=0,w=0;for(let S=0;S<n.length-1;S++){let P=n[S][0],x=n[S][1],I=Vn(n[S+1][0]-P)*this.kx,R=(n[S+1][1]-x)*this.ky,E=0;I===0&&R===0||(E=(Vn(l[0]-P)*this.kx*I+(l[1]-x)*this.ky*R)/(I*I+R*R),E>1?(P=n[S+1][0],x=n[S+1][1]):E>0&&(P+=I/this.kx*E,x+=R/this.ky*E)),I=Vn(l[0]-P)*this.kx,R=(l[1]-x)*this.ky;const C=I*I+R*R;C<d&&(d=C,_=P,f=x,g=S,w=E)}return{point:[_,f],index:g,t:Math.max(0,Math.min(1,w))}}lineSlice(n,l,d){let _=this.pointOnLine(d,n),f=this.pointOnLine(d,l);if(_.index>f.index||_.index===f.index&&_.t>f.t){const P=_;_=f,f=P}const g=[_.point],w=_.index+1,S=f.index;!qd(d[w],g[0])&&w<=S&&g.push(d[w]);for(let P=w+1;P<=S;P++)g.push(d[P]);return qd(d[S],f.point)||g.push(f.point),g}lineSliceAlong(n,l,d){let _=0;const f=[];for(let g=0;g<d.length-1;g++){const w=d[g],S=d[g+1],P=this.distance(w,S);if(_+=P,_>n&&f.length===0&&f.push(Ku(w,S,(n-(_-P))/P)),_>=l)return f.push(Ku(w,S,(l-(_-P))/P)),f;_>n&&f.push(S)}return f}bufferPoint(n,l){const d=l/this.ky,_=l/this.kx;return[n[0]-_,n[1]-d,n[0]+_,n[1]+d]}bufferBBox(n,l){const d=l/this.ky,_=l/this.kx;return[n[0]-_,n[1]-d,n[2]+_,n[3]+d]}insideBBox(n,l){return Vn(n[0]-l[0])>=0&&Vn(n[0]-l[2])<=0&&n[1]>=l[1]&&n[1]<=l[3]}}function qd(u,n){return u[0]===n[0]&&u[1]===n[1]}function Ku(u,n,l){const d=Vn(n[0]-u[0]);return[u[0]+d*l,u[1]+(n[1]-u[1])*l]}function Vn(u){for(;u<-180;)u+=360;for(;u>180;)u-=360;return u}class un{constructor(n=[],l=(d,_)=>d<_?-1:d>_?1:0){if(this.data=n,this.length=this.data.length,this.compare=l,this.length>0)for(let d=(this.length>>1)-1;d>=0;d--)this._down(d)}push(n){this.data.push(n),this._up(this.length++)}pop(){if(this.length===0)return;const n=this.data[0],l=this.data.pop();return--this.length>0&&(this.data[0]=l,this._down(0)),n}peek(){return this.data[0]}_up(n){const{data:l,compare:d}=this,_=l[n];for(;n>0;){const f=n-1>>1,g=l[f];if(d(_,g)>=0)break;l[n]=g,n=f}l[n]=_}_down(n){const{data:l,compare:d}=this,_=this.length>>1,f=l[n];for(;n<_;){let g=1+(n<<1);const w=g+1;if(w<this.length&&d(l[w],l[g])<0&&(g=w),d(l[g],f)>=0)break;l[n]=l[g],n=g}l[n]=f}}var Rt=8192;function Xd(u,n){return n.dist-u.dist}const Ju=100,Ac=50;function ta(u){const n=[1/0,1/0,-1/0,-1/0];if(n.length!==u.length)return!1;for(let l=0;l<n.length;l++)if(n[l]!==u[l])return!1;return!0}function sn(u){return u[1]-u[0]+1}function Po(u,n){const l=u[1]>=u[0]&&u[1]<n;return l||console.warn("Distance Expression: Index is out of range"),l}function Zd(u,n){if(u[0]>u[1])return[null,null];const l=sn(u);if(n){if(l===2)return[u,null];const d=Math.floor(l/2);return[[u[0],u[0]+d],[u[0]+d,u[1]]]}{if(l===1)return[u,null];const d=Math.floor(l/2)-1;return[[u[0],u[0]+d],[u[0]+d+1,u[1]]]}}function Ma(u,n){const l=[1/0,1/0,-1/0,-1/0];if(!Po(n,u.length))return l;for(let d=n[0];d<=n[1];++d)bc(l,u[d]);return l}function Ra(u){const n=[1/0,1/0,-1/0,-1/0];for(let l=0;l<u.length;++l)for(let d=0;d<u[l].length;++d)bc(n,u[l][d]);return n}function Pa(u,n,l){if(ta(u)||ta(n))return NaN;let d=0,_=0;return u[2]<n[0]&&(d=n[0]-u[2]),u[0]>n[2]&&(d=u[0]-n[2]),u[1]>n[3]&&(_=u[1]-n[3]),u[3]<n[1]&&(_=n[1]-u[3]),l.distance([0,0],[d,_])}function Yd(u){return 360*u-180}function D0(u){return 360/Math.PI*Math.atan(Math.exp((180-360*u)*Math.PI/180))-90}function Kd(u,n){const l=Math.pow(2,n.z),d=(u.y/Rt+n.y)/l;return[Yd((u.x/Rt+n.x)/l),D0(d)]}function O0(u,n){const l=[];for(let d=0;d<u.length;++d)l.push(Kd(u[d],n));return l}function Hm(u,n,l){const d=l.pointOnLine(n,u).point;return l.distance(u,d)}function Jd(u,n,l,d,_){const f=l.slice(d[0],d[1]+1);let g=1/0;for(let w=n[0];w<=n[1];++w)if((g=Math.min(g,Hm(u[w],f,_)))===0)return 0;return g}function Qd(u,n,l,d,_){const f=Math.min(_.pointToSegmentDistance(u,l,d),_.pointToSegmentDistance(n,l,d)),g=Math.min(_.pointToSegmentDistance(l,u,n),_.pointToSegmentDistance(d,u,n));return Math.min(f,g)}function F0(u,n,l,d,_){if(!Po(n,u.length)||!Po(d,l.length))return NaN;let f=1/0;for(let g=n[0];g<n[1];++g)for(let w=d[0];w<d[1];++w){if(Ro(u[g],u[g+1],l[w],l[w+1]))return 0;f=Math.min(f,Qd(u[g],u[g+1],l[w],l[w+1],_))}return f}function Gm(u,n,l,d,_){if(!Po(n,u.length)||!Po(d,l.length))return NaN;let f=1/0;for(let g=n[0];g<=n[1];++g)for(let w=d[0];w<=d[1];++w)if((f=Math.min(f,_.distance(u[g],l[w])))===0)return f;return f}function Ba(u,n,l){if(dl(u,n,!0))return 0;let d=1/0;for(const _ of n){const f=_.length;if(f<2)return console.warn("Distance Expression: Invalid polygon!"),NaN;if(_[0]!==_[f-1]&&(d=Math.min(d,l.pointToSegmentDistance(u,_[f-1],_[0])))===0||(d=Math.min(d,Hm(u,_,l)))===0)return d}return d}function k0(u,n,l,d){if(!Po(n,u.length))return NaN;for(let f=n[0];f<=n[1];++f)if(dl(u[f],l,!0))return 0;let _=1/0;for(let f=n[0];f<n[1];++f)for(const g of l)for(let w=0,S=g.length,P=S-1;w<S;P=w++){if(Ro(u[f],u[f+1],g[P],g[w]))return 0;_=Math.min(_,Qd(u[f],u[f+1],g[P],g[w],d))}return _}function $m(u,n){for(const l of u)for(let d=0;d<=l.length-1;++d)if(dl(l[d],n,!0))return!0;return!1}function ef(u,n,l,d=1/0){const _=Ra(u),f=Ra(n);if(d!==1/0&&Pa(_,f,l)>=d)return d;if(wc(_,f)){if($m(u,n))return 0}else if($m(n,u))return 0;let g=d;for(const w of u)for(let S=0,P=w.length,x=P-1;S<P;x=S++)for(const I of n)for(let R=0,E=I.length,C=E-1;R<E;C=R++){if(Ro(w[x],w[S],I[C],I[R]))return 0;g=Math.min(g,Qd(w[x],w[S],I[C],I[R],l))}return g}function Tc(u,n,l,d,_,f,g){if(f===null||g===null)return;const w=Pa(Ma(d,f),Ma(_,g),l);w<n&&u.push({dist:w,range1:f,range2:g})}function Wm(u,n,l,d,_=1/0){let f=Math.min(d.distance(u[0],l[0][0]),_);if(f===0)return f;const g=new un([{dist:0,range1:[0,u.length-1],range2:[0,0]}],Xd),w=n?Ac:Ju,S=Ra(l);for(;g.length;){const P=g.pop();if(P.dist>=f)continue;const x=P.range1;if(sn(x)<=w){if(!Po(x,u.length))return NaN;if(n){const I=k0(u,x,l,d);if((f=Math.min(f,I))===0)return f}else for(let I=x[0];I<=x[1];++I){const R=Ba(u[I],l,d);if((f=Math.min(f,R))===0)return f}}else{const I=Zd(x,n);if(I[0]!==null){const R=Pa(Ma(u,I[0]),S,d);R<f&&g.push({dist:R,range1:I[0],range2:[0,0]})}if(I[1]!==null){const R=Pa(Ma(u,I[1]),S,d);R<f&&g.push({dist:R,range1:I[1],range2:[0,0]})}}}return f}function Es(u,n,l,d,_,f=1/0){let g=Math.min(f,_.distance(u[0],l[0]));if(g===0)return g;const w=new un([{dist:0,range1:[0,u.length-1],range2:[0,l.length-1]}],Xd),S=n?Ac:Ju,P=d?Ac:Ju;for(;w.length;){const x=w.pop();if(x.dist>=g)continue;const I=x.range1,R=x.range2;if(sn(I)<=S&&sn(R)<=P){if(!Po(I,u.length)||!Po(R,l.length))return NaN;if(n&&d?g=Math.min(g,F0(u,I,l,R,_)):n||d?n&&!d?g=Math.min(g,Jd(l,R,u,I,_)):!n&&d&&(g=Math.min(g,Jd(u,I,l,R,_))):g=Math.min(g,Gm(u,I,l,R,_)),g===0)return g}else{const E=Zd(I,n),C=Zd(R,d);Tc(w,g,_,u,l,E[0],C[0]),Tc(w,g,_,u,l,E[0],C[1]),Tc(w,g,_,u,l,E[1],C[0]),Tc(w,g,_,u,l,E[1],C[1])}}return g}function Qu(u,n,l,d,_=1/0){let f=_;const g=Ma(u,[0,u.length-1]);for(const w of l)if(!(f!==1/0&&Pa(g,Ma(w,[0,w.length-1]),d)>=f)&&(f=Math.min(f,Es(u,n,w,!0,d,f)),f===0))return f;return f}function Ec(u,n,l,d,_=1/0){let f=_;const g=Ma(u,[0,u.length-1]);for(const w of l){if(f!==1/0&&Pa(g,Ra(w),d)>=f)continue;const S=Wm(u,n,w,d,f);if(isNaN(S))return S;if((f=Math.min(f,S))===0)return f}return f}function eh(u){return u==="Point"||u==="MultiPoint"||u==="LineString"||u==="MultiLineString"||u==="Polygon"||u==="MultiPolygon"}class ia{constructor(n,l){this.type=jt,this.geojson=n,this.geometries=l}static parse(n,l){if(n.length!==2)return l.error(`'distance' expression requires either one argument, but found ' ${n.length-1} instead.`);if(Co(n[1])){const d=n[1];if(d.type==="FeatureCollection"){for(let _=0;_<d.features.length;++_)if(eh(d.features[_].geometry.type))return new ia(d,d.features[_].geometry)}else if(d.type==="Feature"){if(eh(d.geometry.type))return new ia(d,d.geometry)}else if(eh(d.type))return new ia(d,d)}return l.error("'distance' expression needs to be an array with format ['Distance', GeoJSONObj].")}evaluate(n){const l=n.geometry(),d=n.canonicalID();if(l!=null&&d!=null){if(n.geometryType()==="Point")return function(_,f,g){const w=[];for(const P of _)for(const x of P)w.push(Kd(x,f));const S=new Ca(w[0][1],"meters");return g.type==="Point"||g.type==="MultiPoint"||g.type==="LineString"?Es(w,!1,g.type==="Point"?[g.coordinates]:g.coordinates,g.type==="LineString",S):g.type==="MultiLineString"?Qu(w,!1,g.coordinates,S):g.type==="Polygon"||g.type==="MultiPolygon"?Ec(w,!1,g.type==="Polygon"?[g.coordinates]:g.coordinates,S):null}(l,d,this.geometries);if(n.geometryType()==="LineString")return function(_,f,g){const w=[];for(const P of _){const x=[];for(const I of P)x.push(Kd(I,f));w.push(x)}const S=new Ca(w[0][0][1],"meters");if(g.type==="Point"||g.type==="MultiPoint"||g.type==="LineString")return Qu(g.type==="Point"?[g.coordinates]:g.coordinates,g.type==="LineString",w,S);if(g.type==="MultiLineString"){let P=1/0;for(let x=0;x<g.coordinates.length;x++){const I=Qu(g.coordinates[x],!0,w,S,P);if(isNaN(I))return I;if((P=Math.min(P,I))===0)return P}return P}if(g.type==="Polygon"||g.type==="MultiPolygon"){let P=1/0;for(let x=0;x<w.length;x++){const I=Ec(w[x],!0,g.type==="Polygon"?[g.coordinates]:g.coordinates,S,P);if(isNaN(I))return I;if((P=Math.min(P,I))===0)return P}return P}return null}(l,d,this.geometries);if(n.geometryType()==="Polygon")return function(_,f,g){const w=[];for(const P of function(x,I){const R=x.length;if(R<=1)return[x];const E=[];let C,D;for(let N=0;N<R;N++){const z=C0(x[N]);z!==0&&(x[N].area=Math.abs(z),D===void 0&&(D=z<0),D===z<0?(C&&E.push(C),C=[x[N]]):C.push(x[N]))}return C&&E.push(C),E}(_)){const x=[];for(let I=0;I<P.length;++I)x.push(O0(P[I],f));w.push(x)}const S=new Ca(w[0][0][0][1],"meters");if(g.type==="Point"||g.type==="MultiPoint"||g.type==="LineString")return Ec(g.type==="Point"?[g.coordinates]:g.coordinates,g.type==="LineString",w,S);if(g.type==="MultiLineString"){let P=1/0;for(let x=0;x<g.coordinates.length;x++){const I=Ec(g.coordinates[x],!0,w,S,P);if(isNaN(I))return I;if((P=Math.min(P,I))===0)return P}return P}return g.type==="Polygon"||g.type==="MultiPolygon"?function(P,x,I){let R=1/0;for(const E of P)for(const C of x){const D=ef(E,C,I,R);if(isNaN(D))return D;if((R=Math.min(R,D))===0)return R}return R}(g.type==="Polygon"?[g.coordinates]:g.coordinates,w,S):null}(l,d,this.geometries);console.warn("Distance Expression: currently only evaluates valid Point/LineString/Polygon geometries.")}else console.warn("Distance Expression: requirs valid feature and canonical information.");return null}eachChild(){}outputDefined(){return!0}serialize(){return["distance",this.geojson]}}function th(u,n){switch(u){case"string":return Ts(n);case"number":return+n;case"boolean":return!!n;case"color":return Vi.parse(n);case"formatted":return vn.fromString(Ts(n));case"resolvedImage":return cn.build(Ts(n))}return n}function tf(u,n,l,d){return d!==void 0&&(u=d*Math.round(u/d)),n!==void 0&&u<n&&(u=n),l!==void 0&&u>l&&(u=l),u}class Da{constructor(n,l,d){this.type=n,this.key=l,this.scope=d}static parse(n,l){let d=l.expectedType;if(d==null&&(d=Ni),n.length<2||n.length>3)return l.error("Invalid number of arguments for 'config' expression.");const _=l.parse(n[1],1);if(!(_ instanceof nn))return l.error("Key name of 'config' expression must be a string literal.");if(n.length>=3){const f=l.parse(n[2],2);return f instanceof nn?new Da(d,Ts(_.value),Ts(f.value)):l.error("Scope of 'config' expression must be a string literal.")}return new Da(d,Ts(_.value))}evaluate(n){const l=[this.key,this.scope,n.scope].filter(Boolean).join(""),d=n.getConfig(l);if(!d)return null;const{type:_,value:f,values:g,minValue:w,maxValue:S,stepValue:P}=d,x=d.default.evaluate(n);let I=x;if(f){const R=n.scope;n.scope=(R||"").split("").slice(1).join(""),I=f.evaluate(n),n.scope=R}return _&&(I=th(_,I)),I===void 0||w===void 0&&S===void 0&&P===void 0||(typeof I=="number"?I=tf(I,w,S,P):Array.isArray(I)&&(I=I.map(R=>typeof R=="number"?tf(R,w,S,P):R))),f!==void 0&&I!==void 0&&g&&!g.includes(I)&&(I=x,_&&(I=th(_,I))),(_&&_!==this.type||I!==void 0&&yr(I)!==this.type)&&(I=th(this.type.kind,I)),I}eachChild(){}outputDefined(){return!1}serialize(){const n=["config",this.key];return this.scope&&n.concat(this.key),n}}function ml(u){if(u instanceof Un&&(u.name==="get"&&u.args.length===1||u.name==="feature-state"||u.name==="has"&&u.args.length===1||u.name==="properties"||u.name==="geometry-type"||u.name==="id"||/^filter-/.test(u.name))||u instanceof oi||u instanceof ia)return!1;let n=!0;return u.eachChild(l=>{n&&!ml(l)&&(n=!1)}),n}function Sc(u){if(u instanceof Un&&u.name==="feature-state")return!1;let n=!0;return u.eachChild(l=>{n&&!Sc(l)&&(n=!1)}),n}function Ic(u){if(u instanceof Da)return new Set([u.key]);let n=new Set;return u.eachChild(l=>{n=new Set([...n,...Ic(l)])}),n}function Oa(u,n){if(u instanceof Un&&n.indexOf(u.name)>=0)return!1;let l=!0;return u.eachChild(d=>{l&&!Oa(d,n)&&(l=!1)}),l}class Fa{constructor(n,l){this.type=l.type,this.name=n,this.boundExpression=l}static parse(n,l){if(n.length!==2||typeof n[1]!="string")return l.error("'var' expression requires exactly one string literal argument.");const d=n[1];return l.scope.has(d)?new Fa(d,l.scope.get(d)):l.error(`Unknown variable "${d}". Make sure "${d}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(n){return this.boundExpression.evaluate(n)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}}class _l{constructor(n,l=[],d,_=new $u,f=[],g,w){this.registry=n,this.path=l,this.key=l.map(S=>typeof S=="string"?`['${S}']`:`[${S}]`).join(""),this.scope=_,this.errors=f,this.expectedType=d,this._scope=g,this.options=w}parse(n,l,d,_,f={}){return l||d?this.concat(l,null,d,_)._parse(n,f):this._parse(n,f)}parseObjectValue(n,l,d,_,f,g={}){return this.concat(l,d,_,f)._parse(n,g)}_parse(n,l){function d(_,f,g){return g==="assert"?new Ds(f,[_]):g==="coerce"?new Mo(f,[_]):_}if(n!==null&&typeof n!="string"&&typeof n!="boolean"&&typeof n!="number"||(n=["literal",n]),Array.isArray(n)){if(n.length===0)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const _=typeof n[0]=="string"?this.registry[n[0]]:void 0;if(_){let f=_.parse(n,this);if(!f)return null;if(this.expectedType){const g=this.expectedType,w=f.type;if(g.kind!=="string"&&g.kind!=="number"&&g.kind!=="boolean"&&g.kind!=="object"&&g.kind!=="array"||w.kind!=="value")if(g.kind!=="color"&&g.kind!=="formatted"&&g.kind!=="resolvedImage"||w.kind!=="value"&&w.kind!=="string"){if(this.checkSubtype(g,w))return null}else f=d(f,g,l.typeAnnotation||"coerce");else f=d(f,g,l.typeAnnotation||"assert")}if(!(f instanceof nn)&&f.type.kind!=="resolvedImage"&&ih(f)){const g=new jd(this._scope,this.options);try{f=new nn(f.type,f.evaluate(g))}catch(w){return this.error(w.message),null}}return f}return Mo.parse(["to-array",n],this)}return this.error(n===void 0?"'undefined' value invalid. Use null instead.":typeof n=="object"?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof n} instead.`)}concat(n,l,d,_){let f=typeof n=="number"?this.path.concat(n):this.path;f=typeof l=="string"?f.concat(l):f;const g=_?this.scope.concat(_):this.scope;return new _l(this.registry,f,d||null,g,this.errors,this._scope,this.options)}error(n,...l){const d=`${this.key}${l.map(_=>`[${_}]`).join("")}`;this.errors.push(new bi(d,n))}checkSubtype(n,l){const d=zn(n,l);return d&&this.error(d),d}}var Cc=_l;function ih(u){if(u instanceof Fa)return ih(u.boundExpression);if(u instanceof Un&&u.name==="error"||u instanceof Xu||u instanceof oi||u instanceof ia||u instanceof Da)return!1;const n=u instanceof Mo||u instanceof Ds;let l=!0;return u.eachChild(d=>{l=n?l&&ih(d):l&&d instanceof nn}),!!l&&ml(u)&&Oa(u,["zoom","heatmap-density","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])}function Mc(u,n){const l=u.length-1;let d,_,f=0,g=l,w=0;for(;f<=g;)if(w=Math.floor((f+g)/2),d=u[w],_=u[w+1],d<=n){if(w===l||n<_)return w;f=w+1}else{if(!(d>n))throw new Or("Input is not a number.");g=w-1}return 0}class gl{constructor(n,l,d){this.type=n,this.input=l,this.labels=[],this.outputs=[];for(const[_,f]of d)this.labels.push(_),this.outputs.push(f)}static parse(n,l){if(n.length-1<4)return l.error(`Expected at least 4 arguments, but found only ${n.length-1}.`);if((n.length-1)%2!=0)return l.error("Expected an even number of arguments.");const d=l.parse(n[1],1,jt);if(!d)return null;const _=[];let f=null;l.expectedType&&l.expectedType.kind!=="value"&&(f=l.expectedType);for(let g=1;g<n.length;g+=2){const w=g===1?-1/0:n[g],S=n[g+1],P=g,x=g+1;if(typeof w!="number")return l.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',P);if(_.length&&_[_.length-1][0]>=w)return l.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',P);const I=l.parse(S,x,f);if(!I)return null;f=f||I.type,_.push([w,I])}return new gl(f,d,_)}evaluate(n){const l=this.labels,d=this.outputs;if(l.length===1)return d[0].evaluate(n);const _=this.input.evaluate(n);if(_<=l[0])return d[0].evaluate(n);const f=l.length;return _>=l[f-1]?d[f-1].evaluate(n):d[Mc(l,_)].evaluate(n)}eachChild(n){n(this.input);for(const l of this.outputs)n(l)}outputDefined(){return this.outputs.every(n=>n.outputDefined())}serialize(){const n=["step",this.input.serialize()];for(let l=0;l<this.labels.length;l++)l>0&&n.push(this.labels[l]),n.push(this.outputs[l].serialize());return n}}const ka=.95047,Mi=1.08883,qm=4/29,yl=6/29,Xm=3*yl*yl,Zm=yl*yl*yl,L0=Math.PI/180,or=180/Math.PI;function rf(u){return u>Zm?Math.pow(u,1/3):u/Xm+qm}function nf(u){return u>yl?u*u*u:Xm*(u-qm)}function sf(u){return 255*(u<=.0031308?12.92*u:1.055*Math.pow(u,1/2.4)-.055)}function of(u){return(u/=255)<=.04045?u/12.92:Math.pow((u+.055)/1.055,2.4)}function Ym(u){const n=of(u.r),l=of(u.g),d=of(u.b),_=rf((.4124564*n+.3575761*l+.1804375*d)/ka),f=rf((.2126729*n+.7151522*l+.072175*d)/1);return{l:116*f-16,a:500*(_-f),b:200*(f-rf((.0193339*n+.119192*l+.9503041*d)/Mi)),alpha:u.a}}function Km(u){let n=(u.l+16)/116,l=isNaN(u.a)?n:n+u.a/500,d=isNaN(u.b)?n:n-u.b/200;return n=1*nf(n),l=ka*nf(l),d=Mi*nf(d),new Vi(sf(3.2404542*l-1.5371385*n-.4985314*d),sf(-.969266*l+1.8760108*n+.041556*d),sf(.0556434*l-.2040259*n+1.0572252*d),u.alpha)}function N0(u,n,l){const d=n-u;return u+l*(d>180||d<-180?d-360*Math.round(d/360):d)}const Rc={forward:Ym,reverse:Km,interpolate:function(u,n,l){return{l:ii(u.l,n.l,l),a:ii(u.a,n.a,l),b:ii(u.b,n.b,l),alpha:ii(u.alpha,n.alpha,l)}}},Pc={forward:function(u){const{l:n,a:l,b:d}=Ym(u),_=Math.atan2(d,l)*or;return{h:_<0?_+360:_,c:Math.sqrt(l*l+d*d),l:n,alpha:u.a}},reverse:function(u){const n=u.h*L0,l=u.c;return Km({l:u.l,a:Math.cos(n)*l,b:Math.sin(n)*l,alpha:u.alpha})},interpolate:function(u,n,l){return{h:N0(u.h,n.h,l),c:ii(u.c,n.c,l),l:ii(u.l,n.l,l),alpha:ii(u.alpha,n.alpha,l)}}};var Jm=Object.freeze({__proto__:null,hcl:Pc,lab:Rc});class Kn{constructor(n,l,d,_,f,g){this.type=n,this.operator=l,this.interpolation=d,this.input=_,this.dynamicStops=f,this.labels=[],this.outputs=[];for(const[w,S]of g)this.labels.push(w),this.outputs.push(S)}static interpolationFactor(n,l,d,_){let f=0;if(n.name==="exponential")f=af(l,n.base,d,_);else if(n.name==="linear")f=af(l,1,d,_);else if(n.name==="cubic-bezier"){const g=n.controlPoints;f=new Xn(g[0],g[1],g[2],g[3]).solve(af(l,1,d,_))}return f}static parse(n,l){let[d,_,f,...g]=n;if(!Array.isArray(_)||_.length===0)return l.error("Expected an interpolation type expression.",1);if(_[0]==="linear")_={name:"linear"};else if(_[0]==="exponential"){const P=_[1];if(typeof P!="number")return l.error("Exponential interpolation requires a numeric base.",1,1);_={name:"exponential",base:P}}else{if(_[0]!=="cubic-bezier")return l.error(`Unknown interpolation type ${String(_[0])}`,1,0);{const P=_.slice(1);if(P.length!==4||P.some(x=>typeof x!="number"||x<0||x>1))return l.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);_={name:"cubic-bezier",controlPoints:P}}}if(n.length-1<3)return l.error(`Expected at least 3 arguments, but found only ${n.length-1}.`);if(n.length-1>3&&(n.length-1)%2!=0)return l.error("Expected an even number of arguments.");if(f=l.parse(f,2,jt),!f)return null;const w=[];let S=null;if(d==="interpolate-hcl"||d==="interpolate-lab"?S=yn:l.expectedType&&l.expectedType.kind!=="value"&&(S=l.expectedType),n.length-1==3){const P=l.parse(g[0],3,Ni);return P?new Kn(S,d,_,f,P,w):null}for(let P=0;P<g.length;P+=2){const x=g[P],I=g[P+1],R=P+3,E=P+4;if(typeof x!="number")return l.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',R);if(w.length&&w[w.length-1][0]>=x)return l.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',R);const C=l.parse(I,E,S);if(!C)return null;S=S||C.type,w.push([x,C])}return S.kind==="number"||S.kind==="color"||S.kind==="array"&&S.itemType.kind==="number"&&typeof S.N=="number"?new Kn(S,d,_,f,null,w):l.error(`Type ${wr(S)} is not interpolatable.`)}evaluate(n){let l=this.labels,d=this.outputs;if(this.dynamicStops){const x=this.dynamicStops.evaluate(n);if(x.length%2!=0)throw new Or("Expected an even number of arguments.");l=[],d=[];for(let I=0;I<x.length;I+=2){const R=x[I],E=new nn(jt,x[I+1]);if(typeof R!="number")throw new Or('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.');if(l.length&&l[l.length-1]>=R)throw new Or('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.');l.push(R),d.push(E)}if(l.length===0)throw new Or("Expected at least one input/output pair.")}if(l.length===1)return d[0].evaluate(n);const _=this.input.evaluate(n);if(_<=l[0])return d[0].evaluate(n);const f=l.length;if(_>=l[f-1])return d[f-1].evaluate(n);const g=Mc(l,_),w=Kn.interpolationFactor(this.interpolation,_,l[g],l[g+1]),S=d[g].evaluate(n),P=d[g+1].evaluate(n);return this.operator==="interpolate"?Hu[this.type.kind.toLowerCase()](S,P,w):this.operator==="interpolate-hcl"?Pc.reverse(Pc.interpolate(Pc.forward(S),Pc.forward(P),w)):Rc.reverse(Rc.interpolate(Rc.forward(S),Rc.forward(P),w))}eachChild(n){n(this.input);for(const l of this.outputs)n(l)}outputDefined(){return this.outputs.every(n=>n.outputDefined())}serialize(){let n;n=this.interpolation.name==="linear"?["linear"]:this.interpolation.name==="exponential"?this.interpolation.base===1?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier"].concat(this.interpolation.controlPoints);const l=[this.operator,n,this.input.serialize()];if(this.dynamicStops)l.push(this.dynamicStops.serialize());else for(let d=0;d<this.labels.length;d++)l.push(this.labels[d],this.outputs[d].serialize());return l}}function af(u,n,l,d){const _=d-l,f=u-l;return _===0?0:n===1?f/_:(Math.pow(n,f)-1)/(Math.pow(n,_)-1)}class rh{constructor(n,l){this.type=n,this.args=l}static parse(n,l){if(n.length<2)return l.error("Expectected at least one argument.");let d=null;const _=l.expectedType;_&&_.kind!=="value"&&(d=_);const f=[];for(const w of n.slice(1)){const S=l.parse(w,1+f.length,d,void 0,{typeAnnotation:"omit"});if(!S)return null;d=d||S.type,f.push(S)}const g=_&&f.some(w=>zn(_,w.type));return new rh(g?Ni:d,f)}evaluate(n){let l,d=null,_=0;for(const f of this.args){if(_++,d=f.evaluate(n),d&&d instanceof cn&&!d.available&&(l||(l=d),d=null,_===this.args.length))return l;if(d!==null)break}return d}eachChild(n){this.args.forEach(n)}outputDefined(){return this.args.every(n=>n.outputDefined())}serialize(){const n=["coalesce"];return this.eachChild(l=>{n.push(l.serialize())}),n}}class nh{constructor(n,l){this.type=l.type,this.bindings=[].concat(n),this.result=l}evaluate(n){return this.result.evaluate(n)}eachChild(n){for(const l of this.bindings)n(l[1]);n(this.result)}static parse(n,l){if(n.length<4)return l.error(`Expected at least 3 arguments, but found ${n.length-1} instead.`);const d=[];for(let f=1;f<n.length-1;f+=2){const g=n[f];if(typeof g!="string")return l.error(`Expected string, but found ${typeof g} instead.`,f);if(/[^a-zA-Z0-9_]/.test(g))return l.error("Variable names must contain only alphanumeric characters or '_'.",f);const w=l.parse(n[f+1],f+1);if(!w)return null;d.push([g,w])}const _=l.parse(n[n.length-1],n.length-1,l.expectedType,d);return _?new nh(d,_):null}outputDefined(){return this.result.outputDefined()}serialize(){const n=["let"];for(const[l,d]of this.bindings)n.push(l,d.serialize());return n.push(this.result.serialize()),n}}class lf{constructor(n,l,d){this.type=n,this.index=l,this.input=d}static parse(n,l){if(n.length!==3)return l.error(`Expected 2 arguments, but found ${n.length-1} instead.`);const d=l.parse(n[1],1,jt),_=l.parse(n[2],2,rn(l.expectedType||Ni));return d&&_?new lf(_.type.itemType,d,_):null}evaluate(n){const l=this.index.evaluate(n),d=this.input.evaluate(n);if(l<0)throw new Or(`Array index out of bounds: ${l} < 0.`);if(l>d.length-1)throw new Or(`Array index out of bounds: ${l} > ${d.length-1}.`);if(l===Math.floor(l))return d[l];const _=Math.floor(l),f=Math.ceil(l),g=d[_],w=d[f];if(typeof g!="number"||typeof w!="number")throw new Or(`Cannot interpolate between non-number values at index ${l}.`);const S=l-_;return g*(1-S)+w*S}eachChild(n){n(this.index),n(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}}class cf{constructor(n,l){this.type=Oi,this.needle=n,this.haystack=l}static parse(n,l){if(n.length!==3)return l.error(`Expected 2 arguments, but found ${n.length-1} instead.`);const d=l.parse(n[1],1,Ni),_=l.parse(n[2],2,Ni);return d&&_?Wu(d.type,[Oi,$i,jt,Ea,Ni])?new cf(d,_):l.error(`Expected first argument to be of type boolean, string, number or null, but found ${wr(d.type)} instead`):null}evaluate(n){const l=this.needle.evaluate(n),d=this.haystack.evaluate(n);if(d==null)return!1;if(!mc(l,["boolean","string","number","null"]))throw new Or(`Expected first argument to be of type boolean, string, number or null, but found ${wr(yr(l))} instead.`);if(!mc(d,["string","array"]))throw new Or(`Expected second argument to be of type array or string, but found ${wr(yr(d))} instead.`);return d.indexOf(l)>=0}eachChild(n){n(this.needle),n(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}}class sh{constructor(n,l,d){this.type=jt,this.needle=n,this.haystack=l,this.fromIndex=d}static parse(n,l){if(n.length<=2||n.length>=5)return l.error(`Expected 3 or 4 arguments, but found ${n.length-1} instead.`);const d=l.parse(n[1],1,Ni),_=l.parse(n[2],2,Ni);if(!d||!_)return null;if(!Wu(d.type,[Oi,$i,jt,Ea,Ni]))return l.error(`Expected first argument to be of type boolean, string, number or null, but found ${wr(d.type)} instead`);if(n.length===4){const f=l.parse(n[3],3,jt);return f?new sh(d,_,f):null}return new sh(d,_)}evaluate(n){const l=this.needle.evaluate(n),d=this.haystack.evaluate(n);if(!mc(l,["boolean","string","number","null"]))throw new Or(`Expected first argument to be of type boolean, string, number or null, but found ${wr(yr(l))} instead.`);if(!mc(d,["string","array"]))throw new Or(`Expected second argument to be of type array or string, but found ${wr(yr(d))} instead.`);if(this.fromIndex){const _=this.fromIndex.evaluate(n);return d.indexOf(l,_)}return d.indexOf(l)}eachChild(n){n(this.needle),n(this.haystack),this.fromIndex&&n(this.fromIndex)}outputDefined(){return!1}serialize(){if(this.fromIndex!=null&&this.fromIndex!==void 0){const n=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),n]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}}class uf{constructor(n,l,d,_,f,g){this.inputType=n,this.type=l,this.input=d,this.cases=_,this.outputs=f,this.otherwise=g}static parse(n,l){if(n.length<5)return l.error(`Expected at least 4 arguments, but found only ${n.length-1}.`);if(n.length%2!=1)return l.error("Expected an even number of arguments.");let d,_;l.expectedType&&l.expectedType.kind!=="value"&&(_=l.expectedType);const f={},g=[];for(let P=2;P<n.length-1;P+=2){let x=n[P];const I=n[P+1];Array.isArray(x)||(x=[x]);const R=l.concat(P);if(x.length===0)return R.error("Expected at least one branch label.");for(const C of x){if(typeof C!="number"&&typeof C!="string")return R.error("Branch labels must be numbers or strings.");if(typeof C=="number"&&Math.abs(C)>Number.MAX_SAFE_INTEGER)return R.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if(typeof C=="number"&&Math.floor(C)!==C)return R.error("Numeric branch labels must be integer values.");if(d){if(R.checkSubtype(d,yr(C)))return null}else d=yr(C);if(f[String(C)]!==void 0)return R.error("Branch labels must be unique.");f[String(C)]=g.length}const E=l.parse(I,P,_);if(!E)return null;_=_||E.type,g.push(E)}const w=l.parse(n[1],1,Ni);if(!w)return null;const S=l.parse(n[n.length-1],n.length-1,_);return S?w.type.kind!=="value"&&l.concat(1).checkSubtype(d,w.type)?null:new uf(d,_,w,f,g,S):null}evaluate(n){const l=this.input.evaluate(n);return(yr(l)===this.inputType&&this.outputs[this.cases[l]]||this.otherwise).evaluate(n)}eachChild(n){n(this.input),this.outputs.forEach(n),n(this.otherwise)}outputDefined(){return this.outputs.every(n=>n.outputDefined())&&this.otherwise.outputDefined()}serialize(){const n=["match",this.input.serialize()],l=Object.keys(this.cases).sort(),d=[],_={};for(const g of l){const w=_[this.cases[g]];w===void 0?(_[this.cases[g]]=d.length,d.push([this.cases[g],[g]])):d[w][1].push(g)}const f=g=>this.inputType.kind==="number"?Number(g):g;for(const[g,w]of d)n.push(w.length===1?f(w[0]):w.map(f)),n.push(this.outputs[g].serialize());return n.push(this.otherwise.serialize()),n}}class hf{constructor(n,l,d){this.type=n,this.branches=l,this.otherwise=d}static parse(n,l){if(n.length<4)return l.error(`Expected at least 3 arguments, but found only ${n.length-1}.`);if(n.length%2!=0)return l.error("Expected an odd number of arguments.");let d;l.expectedType&&l.expectedType.kind!=="value"&&(d=l.expectedType);const _=[];for(let g=1;g<n.length-1;g+=2){const w=l.parse(n[g],g,Oi);if(!w)return null;const S=l.parse(n[g+1],g+1,d);if(!S)return null;_.push([w,S]),d=d||S.type}const f=l.parse(n[n.length-1],n.length-1,d);return f?new hf(d,_,f):null}evaluate(n){for(const[l,d]of this.branches)if(l.evaluate(n))return d.evaluate(n);return this.otherwise.evaluate(n)}eachChild(n){for(const[l,d]of this.branches)n(l),n(d);n(this.otherwise)}outputDefined(){return this.branches.every(([n,l])=>l.outputDefined())&&this.otherwise.outputDefined()}serialize(){const n=["case"];return this.eachChild(l=>{n.push(l.serialize())}),n}}class oh{constructor(n,l,d,_){this.type=n,this.input=l,this.beginIndex=d,this.endIndex=_}static parse(n,l){if(n.length<=2||n.length>=5)return l.error(`Expected 3 or 4 arguments, but found ${n.length-1} instead.`);const d=l.parse(n[1],1,Ni),_=l.parse(n[2],2,jt);if(!d||!_)return null;if(!Wu(d.type,[rn(Ni),$i,Ni]))return l.error(`Expected first argument to be of type array or string, but found ${wr(d.type)} instead`);if(n.length===4){const f=l.parse(n[3],3,jt);return f?new oh(d.type,d,_,f):null}return new oh(d.type,d,_)}evaluate(n){const l=this.input.evaluate(n),d=this.beginIndex.evaluate(n);if(!mc(l,["string","array"]))throw new Or(`Expected first argument to be of type array or string, but found ${wr(yr(l))} instead.`);if(this.endIndex){const _=this.endIndex.evaluate(n);return l.slice(d,_)}return l.slice(d)}eachChild(n){n(this.input),n(this.beginIndex),this.endIndex&&n(this.endIndex)}outputDefined(){return!1}serialize(){if(this.endIndex!=null&&this.endIndex!==void 0){const n=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),n]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}}function Qm(u,n){return u==="=="||u==="!="?n.kind==="boolean"||n.kind==="string"||n.kind==="number"||n.kind==="null"||n.kind==="value":n.kind==="string"||n.kind==="number"||n.kind==="value"}function e_(u,n,l,d){return d.compare(n,l)===0}function vl(u,n,l){const d=u!=="=="&&u!=="!=";return class RB{constructor(f,g,w){this.type=Oi,this.lhs=f,this.rhs=g,this.collator=w,this.hasUntypedArgument=f.type.kind==="value"||g.type.kind==="value"}static parse(f,g){if(f.length!==3&&f.length!==4)return g.error("Expected two or three arguments.");const w=f[0];let S=g.parse(f[1],1,Ni);if(!S)return null;if(!Qm(w,S.type))return g.concat(1).error(`"${w}" comparisons are not supported for type '${wr(S.type)}'.`);let P=g.parse(f[2],2,Ni);if(!P)return null;if(!Qm(w,P.type))return g.concat(2).error(`"${w}" comparisons are not supported for type '${wr(P.type)}'.`);if(S.type.kind!==P.type.kind&&S.type.kind!=="value"&&P.type.kind!=="value")return g.error(`Cannot compare types '${wr(S.type)}' and '${wr(P.type)}'.`);d&&(S.type.kind==="value"&&P.type.kind!=="value"?S=new Ds(P.type,[S]):S.type.kind!=="value"&&P.type.kind==="value"&&(P=new Ds(S.type,[P])));let x=null;if(f.length===4){if(S.type.kind!=="string"&&P.type.kind!=="string"&&S.type.kind!=="value"&&P.type.kind!=="value")return g.error("Cannot use collator to compare non-string types.");if(x=g.parse(f[3],3,fc),!x)return null}return new RB(S,P,x)}evaluate(f){const g=this.lhs.evaluate(f),w=this.rhs.evaluate(f);if(d&&this.hasUntypedArgument){const S=yr(g),P=yr(w);if(S.kind!==P.kind||S.kind!=="string"&&S.kind!=="number")throw new Or(`Expected arguments for "${u}" to be (string, string) or (number, number), but found (${S.kind}, ${P.kind}) instead.`)}if(this.collator&&!d&&this.hasUntypedArgument){const S=yr(g),P=yr(w);if(S.kind!=="string"||P.kind!=="string")return n(f,g,w)}return this.collator?l(f,g,w,this.collator.evaluate(f)):n(f,g,w)}eachChild(f){f(this.lhs),f(this.rhs),this.collator&&f(this.collator)}outputDefined(){return!0}serialize(){const f=[u];return this.eachChild(g=>{f.push(g.serialize())}),f}}}const z0=vl("==",function(u,n,l){return n===l},e_),U0=vl("!=",function(u,n,l){return n!==l},function(u,n,l,d){return!e_(0,n,l,d)}),V0=vl("<",function(u,n,l){return n<l},function(u,n,l,d){return d.compare(n,l)<0}),j0=vl(">",function(u,n,l){return n>l},function(u,n,l,d){return d.compare(n,l)>0}),H0=vl("<=",function(u,n,l){return n<=l},function(u,n,l,d){return d.compare(n,l)<=0}),G0=vl(">=",function(u,n,l){return n>=l},function(u,n,l,d){return d.compare(n,l)>=0});class df{constructor(n,l,d,_,f,g){this.type=$i,this.number=n,this.locale=l,this.currency=d,this.unit=_,this.minFractionDigits=f,this.maxFractionDigits=g}static parse(n,l){if(n.length!==3)return l.error("Expected two arguments.");const d=l.parse(n[1],1,jt);if(!d)return null;const _=n[2];if(typeof _!="object"||Array.isArray(_))return l.error("NumberFormat options argument must be an object.");let f=null;if(_.locale&&(f=l.parseObjectValue(_.locale,2,"locale",$i),!f))return null;let g=null;if(_.currency&&(g=l.parseObjectValue(_.currency,2,"currency",$i),!g))return null;let w=null;if(_.unit&&(w=l.parseObjectValue(_.unit,2,"unit",$i),!w))return null;let S=null;if(_["min-fraction-digits"]&&(S=l.parseObjectValue(_["min-fraction-digits"],2,"min-fraction-digits",jt),!S))return null;let P=null;return _["max-fraction-digits"]&&(P=l.parseObjectValue(_["max-fraction-digits"],2,"max-fraction-digits",jt),!P)?null:new df(d,f,g,w,S,P)}evaluate(n){return new Intl.NumberFormat(this.locale?this.locale.evaluate(n):[],{style:(this.currency?"currency":this.unit&&"unit")||"decimal",currency:this.currency?this.currency.evaluate(n):void 0,unit:this.unit?this.unit.evaluate(n):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(n):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(n):void 0}).format(this.number.evaluate(n))}eachChild(n){n(this.number),this.locale&&n(this.locale),this.currency&&n(this.currency),this.unit&&n(this.unit),this.minFractionDigits&&n(this.minFractionDigits),this.maxFractionDigits&&n(this.maxFractionDigits)}outputDefined(){return!1}serialize(){const n={};return this.locale&&(n.locale=this.locale.serialize()),this.currency&&(n.currency=this.currency.serialize()),this.unit&&(n.unit=this.unit.serialize()),this.minFractionDigits&&(n["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(n["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),n]}}class ff{constructor(n){this.type=jt,this.input=n}static parse(n,l){if(n.length!==2)return l.error(`Expected 1 argument, but found ${n.length-1} instead.`);const d=l.parse(n[1],1);return d?d.type.kind!=="array"&&d.type.kind!=="string"&&d.type.kind!=="value"?l.error(`Expected argument of type string or array, but found ${wr(d.type)} instead.`):new ff(d):null}evaluate(n){const l=this.input.evaluate(n);if(typeof l=="string"||Array.isArray(l))return l.length;throw new Or(`Expected value to be of type string or array, but found ${wr(yr(l))} instead.`)}eachChild(n){n(this.input)}outputDefined(){return!1}serialize(){const n=["length"];return this.eachChild(l=>{n.push(l.serialize())}),n}}function ah(u){return function(){u=1831565813+(u|=0)|0;let n=Math.imul(u^u>>>15,1|u);return n=n+Math.imul(n^n>>>7,61|n)^n,((n^n>>>14)>>>0)/4294967296}}const xl={"==":z0,"!=":U0,">":j0,"<":V0,">=":G0,"<=":H0,array:Ds,at:lf,boolean:Ds,case:hf,coalesce:rh,collator:Xu,format:Sa,image:yc,in:cf,"index-of":sh,interpolate:Kn,"interpolate-hcl":Kn,"interpolate-lab":Kn,length:ff,let:nh,literal:nn,match:uf,number:Ds,"number-format":df,object:Ds,slice:oh,step:gl,string:Ds,"to-boolean":Mo,"to-color":Mo,"to-number":Mo,"to-string":Mo,var:Fa,within:oi,distance:ia,config:Da};function pf(u,[n,l,d,_]){n=n.evaluate(u),l=l.evaluate(u),d=d.evaluate(u);const f=_?_.evaluate(u):1,g=Ud(n,l,d,f);if(g)throw new Or(g);return new Vi(n/255*f,l/255*f,d/255*f,f)}function t_(u,[n,l,d,_]){n=n.evaluate(u),l=l.evaluate(u),d=d.evaluate(u);const f=_?_.evaluate(u):1,g=function(P,x,I,R){return typeof P=="number"&&P>=0&&P<=360?typeof x=="number"&&x>=0&&x<=100&&typeof I=="number"&&I>=0&&I<=100?R===void 0||typeof R=="number"&&R>=0&&R<=1?null:`Invalid hsla value [${[P,x,I,R].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid hsla value [${(typeof R=="number"?[P,x,I,R]:[P,x,I]).join(", ")}]: 's', and 'l' must be between 0 and 100.`:`Invalid hsla value [${(typeof R=="number"?[P,x,I,R]:[P,x,I]).join(", ")}]: 'h' must be between 0 and 360.`}(n,l,d,f);if(g)throw new Or(g);const w=`hsla(${n}, ${l}%, ${d}%, ${f})`,S=Vi.parse(w);if(!S)throw new Or(`Failed to parse HSLA color: ${w}`);return S}function i_(u,n){return u in n}function mf(u,n){const l=n[u];return l===void 0?null:l}function ra(u){return{type:u}}function _f(u){return{result:"success",value:u}}function ds(u){return{result:"error",value:u}}function lh(u,n){return!!u&&!!u.parameters&&u.parameters.indexOf(n)>-1}function Bc(u){return u["property-type"]==="data-driven"}function r_(u){return lh(u.expression,"measure-light")}function ch(u){return lh(u.expression,"zoom")}function Dc(u){return!!u.expression&&u.expression.interpolated}function gf(u){return typeof u=="object"&&u!==null&&!Array.isArray(u)}function $0(u){return u}function yf(u,n){const l=n.type==="color",d=u.stops&&typeof u.stops[0][0]=="object",_=d||!(d||u.property!==void 0),f=u.type||(Dc(n)?"exponential":"interval");if(l&&((u=Gu({},u)).stops&&(u.stops=u.stops.map(P=>[P[0],Vi.parse(P[1])])),u.default=Vi.parse(u.default?u.default:n.default)),u.colorSpace&&u.colorSpace!=="rgb"&&!Jm[u.colorSpace])throw new Error(`Unknown color space: ${u.colorSpace}`);let g,w,S;if(f==="exponential")g=n_;else if(f==="interval")g=q0;else if(f==="categorical"){g=W0,w=Object.create(null);for(const P of u.stops)w[P[0]]=P[1];S=typeof u.stops[0][0]}else{if(f!=="identity")throw new Error(`Unknown function type "${f}"`);g=s_}if(d){const P={},x=[];for(let E=0;E<u.stops.length;E++){const C=u.stops[E],D=C[0].zoom;P[D]===void 0&&(P[D]={zoom:D,type:u.type,property:u.property,default:u.default,stops:[]},x.push(D)),P[D].stops.push([C[0].value,C[1]])}const I=[];for(const E of x)I.push([P[E].zoom,yf(P[E],n)]);const R={name:"linear"};return{kind:"composite",interpolationType:R,interpolationFactor:Kn.interpolationFactor.bind(void 0,R),zoomStops:I.map(E=>E[0]),evaluate:({zoom:E},C)=>n_({stops:I,base:u.base},n,E).evaluate(E,C)}}if(_){const P=f==="exponential"?{name:"exponential",base:u.base!==void 0?u.base:1}:null;return{kind:"camera",interpolationType:P,interpolationFactor:Kn.interpolationFactor.bind(void 0,P),zoomStops:u.stops.map(x=>x[0]),evaluate:({zoom:x})=>g(u,n,x,w,S)}}return{kind:"source",evaluate(P,x){const I=x&&x.properties?x.properties[u.property]:void 0;return I===void 0?bl(u.default,n.default):g(u,n,I,w,S)}}}function bl(u,n,l){return u!==void 0?u:n!==void 0?n:l!==void 0?l:void 0}function W0(u,n,l,d,_){return bl(typeof l===_?d[l]:void 0,u.default,n.default)}function q0(u,n,l){if(Os(l)!=="number")return bl(u.default,n.default);const d=u.stops.length;if(d===1||l<=u.stops[0][0])return u.stops[0][1];if(l>=u.stops[d-1][0])return u.stops[d-1][1];const _=Mc(u.stops.map(f=>f[0]),l);return u.stops[_][1]}function n_(u,n,l){const d=u.base!==void 0?u.base:1;if(Os(l)!=="number")return bl(u.default,n.default);const _=u.stops.length;if(_===1||l<=u.stops[0][0])return u.stops[0][1];if(l>=u.stops[_-1][0])return u.stops[_-1][1];const f=Mc(u.stops.map(x=>x[0]),l),g=function(x,I,R,E){const C=E-R,D=x-R;return C===0?0:I===1?D/C:(Math.pow(I,D)-1)/(Math.pow(I,C)-1)}(l,d,u.stops[f][0],u.stops[f+1][0]),w=u.stops[f][1],S=u.stops[f+1][1];let P=Hu[n.type]||$0;if(u.colorSpace&&u.colorSpace!=="rgb"){const x=Jm[u.colorSpace];P=(I,R)=>x.reverse(x.interpolate(x.forward(I),x.forward(R),g))}return typeof w.evaluate=="function"?{evaluate(...x){const I=w.evaluate.apply(void 0,x),R=S.evaluate.apply(void 0,x);if(I!==void 0&&R!==void 0)return P(I,R,g)}}:P(w,S,g)}function s_(u,n,l){return n.type==="color"?l=Vi.parse(l):n.type==="formatted"?l=vn.fromString(l.toString()):n.type==="resolvedImage"?l=cn.build(l.toString()):Os(l)===n.type||n.type==="enum"&&n.values[l]||(l=void 0),bl(l,u.default,n.default)}Un.register(xl,{error:[{kind:"error"},[$i],(u,[n])=>{throw new Or(n.evaluate(u))}],typeof:[$i,[Ni],(u,[n])=>wr(yr(n.evaluate(u)))],"to-rgba":[rn(jt,4),[yn],(u,[n])=>n.evaluate(u).toRenderColor(null).toArray()],"to-hsla":[rn(jt,4),[yn],(u,[n])=>n.evaluate(u).toRenderColor(null).toHslaArray()],rgb:[yn,[jt,jt,jt],pf],rgba:[yn,[jt,jt,jt,jt],pf],hsl:[yn,[jt,jt,jt],t_],hsla:[yn,[jt,jt,jt,jt],t_],has:{type:Oi,overloads:[[[$i],(u,[n])=>i_(n.evaluate(u),u.properties())],[[$i,Io],(u,[n,l])=>i_(n.evaluate(u),l.evaluate(u))]]},get:{type:Ni,overloads:[[[$i],(u,[n])=>mf(n.evaluate(u),u.properties())],[[$i,Io],(u,[n,l])=>mf(n.evaluate(u),l.evaluate(u))]]},"feature-state":[Ni,[$i],(u,[n])=>mf(n.evaluate(u),u.featureState||{})],properties:[Io,[],u=>u.properties()],"geometry-type":[$i,[],u=>u.geometryType()],id:[Ni,[],u=>u.id()],zoom:[jt,[],u=>u.globals.zoom],pitch:[jt,[],u=>u.globals.pitch||0],"distance-from-center":[jt,[],u=>u.distanceFromCenter()],"measure-light":[jt,[$i],(u,[n])=>u.measureLight(n.evaluate(u))],"heatmap-density":[jt,[],u=>u.globals.heatmapDensity||0],"line-progress":[jt,[],u=>u.globals.lineProgress||0],"raster-value":[jt,[],u=>u.globals.rasterValue||0],"raster-particle-speed":[jt,[],u=>u.globals.rasterParticleSpeed||0],"sky-radial-progress":[jt,[],u=>u.globals.skyRadialProgress||0],accumulated:[Ni,[],u=>u.globals.accumulated===void 0?null:u.globals.accumulated],"+":[jt,ra(jt),(u,n)=>{let l=0;for(const d of n)l+=d.evaluate(u);return l}],"*":[jt,ra(jt),(u,n)=>{let l=1;for(const d of n)l*=d.evaluate(u);return l}],"-":{type:jt,overloads:[[[jt,jt],(u,[n,l])=>n.evaluate(u)-l.evaluate(u)],[[jt],(u,[n])=>-n.evaluate(u)]]},"/":[jt,[jt,jt],(u,[n,l])=>n.evaluate(u)/l.evaluate(u)],"%":[jt,[jt,jt],(u,[n,l])=>n.evaluate(u)%l.evaluate(u)],ln2:[jt,[],()=>Math.LN2],pi:[jt,[],()=>Math.PI],e:[jt,[],()=>Math.E],"^":[jt,[jt,jt],(u,[n,l])=>Math.pow(n.evaluate(u),l.evaluate(u))],sqrt:[jt,[jt],(u,[n])=>Math.sqrt(n.evaluate(u))],log10:[jt,[jt],(u,[n])=>Math.log(n.evaluate(u))/Math.LN10],ln:[jt,[jt],(u,[n])=>Math.log(n.evaluate(u))],log2:[jt,[jt],(u,[n])=>Math.log(n.evaluate(u))/Math.LN2],sin:[jt,[jt],(u,[n])=>Math.sin(n.evaluate(u))],cos:[jt,[jt],(u,[n])=>Math.cos(n.evaluate(u))],tan:[jt,[jt],(u,[n])=>Math.tan(n.evaluate(u))],asin:[jt,[jt],(u,[n])=>Math.asin(n.evaluate(u))],acos:[jt,[jt],(u,[n])=>Math.acos(n.evaluate(u))],atan:[jt,[jt],(u,[n])=>Math.atan(n.evaluate(u))],min:[jt,ra(jt),(u,n)=>Math.min(...n.map(l=>l.evaluate(u)))],max:[jt,ra(jt),(u,n)=>Math.max(...n.map(l=>l.evaluate(u)))],abs:[jt,[jt],(u,[n])=>Math.abs(n.evaluate(u))],round:[jt,[jt],(u,[n])=>{const l=n.evaluate(u);return l<0?-Math.round(-l):Math.round(l)}],floor:[jt,[jt],(u,[n])=>Math.floor(n.evaluate(u))],ceil:[jt,[jt],(u,[n])=>Math.ceil(n.evaluate(u))],"filter-==":[Oi,[$i,Ni],(u,[n,l])=>u.properties()[n.value]===l.value],"filter-id-==":[Oi,[Ni],(u,[n])=>u.id()===n.value],"filter-type-==":[Oi,[$i],(u,[n])=>u.geometryType()===n.value],"filter-<":[Oi,[$i,Ni],(u,[n,l])=>{const d=u.properties()[n.value],_=l.value;return typeof d==typeof _&&d<_}],"filter-id-<":[Oi,[Ni],(u,[n])=>{const l=u.id(),d=n.value;return typeof l==typeof d&&l<d}],"filter->":[Oi,[$i,Ni],(u,[n,l])=>{const d=u.properties()[n.value],_=l.value;return typeof d==typeof _&&d>_}],"filter-id->":[Oi,[Ni],(u,[n])=>{const l=u.id(),d=n.value;return typeof l==typeof d&&l>d}],"filter-<=":[Oi,[$i,Ni],(u,[n,l])=>{const d=u.properties()[n.value],_=l.value;return typeof d==typeof _&&d<=_}],"filter-id-<=":[Oi,[Ni],(u,[n])=>{const l=u.id(),d=n.value;return typeof l==typeof d&&l<=d}],"filter->=":[Oi,[$i,Ni],(u,[n,l])=>{const d=u.properties()[n.value],_=l.value;return typeof d==typeof _&&d>=_}],"filter-id->=":[Oi,[Ni],(u,[n])=>{const l=u.id(),d=n.value;return typeof l==typeof d&&l>=d}],"filter-has":[Oi,[Ni],(u,[n])=>n.value in u.properties()],"filter-has-id":[Oi,[],u=>u.id()!==null&&u.id()!==void 0],"filter-type-in":[Oi,[rn($i)],(u,[n])=>n.value.indexOf(u.geometryType())>=0],"filter-id-in":[Oi,[rn(Ni)],(u,[n])=>n.value.indexOf(u.id())>=0],"filter-in-small":[Oi,[$i,rn(Ni)],(u,[n,l])=>l.value.indexOf(u.properties()[n.value])>=0],"filter-in-large":[Oi,[$i,rn(Ni)],(u,[n,l])=>function(d,_,f,g){for(;f<=g;){const w=f+g>>1;if(_[w]===d)return!0;_[w]>d?g=w-1:f=w+1}return!1}(u.properties()[n.value],l.value,0,l.value.length-1)],all:{type:Oi,overloads:[[[Oi,Oi],(u,[n,l])=>n.evaluate(u)&&l.evaluate(u)],[ra(Oi),(u,n)=>{for(const l of n)if(!l.evaluate(u))return!1;return!0}]]},any:{type:Oi,overloads:[[[Oi,Oi],(u,[n,l])=>n.evaluate(u)||l.evaluate(u)],[ra(Oi),(u,n)=>{for(const l of n)if(l.evaluate(u))return!0;return!1}]]},"!":[Oi,[Oi],(u,[n])=>!n.evaluate(u)],"is-supported-script":[Oi,[$i],(u,[n])=>{const l=u.globals&&u.globals.isSupportedScript;return!l||l(n.evaluate(u))}],upcase:[$i,[$i],(u,[n])=>n.evaluate(u).toUpperCase()],downcase:[$i,[$i],(u,[n])=>n.evaluate(u).toLowerCase()],concat:[$i,ra(Ni),(u,n)=>n.map(l=>Ts(l.evaluate(u))).join("")],"resolved-locale":[$i,[fc],(u,[n])=>n.evaluate(u).resolvedLocale()],random:[jt,[jt,jt,Ni],(u,n)=>{const[l,d,_]=n.map(g=>g.evaluate(u));if(l>d||l===d)return l;let f;if(typeof _=="string")f=function(g){let w=0;if(g.length===0)return w;for(let S=0;S<g.length;S++)w=(w<<5)-w+g.charCodeAt(S),w|=0;return w}(_);else{if(typeof _!="number")throw new Or(`Invalid seed input: ${_}`);f=_}return l+ah(f)()*(d-l)}]});class uh{constructor(n,l,d,_){this.expression=n,this._warningHistory={},this._evaluator=new jd(d,_),this._defaultValue=l?function(f){return f.type==="color"&&(gf(f.default)||Array.isArray(f.default))?new Vi(0,0,0,0):f.type==="color"?Vi.parse(f.default)||null:f.default===void 0?null:f.default}(l):null,this._enumValues=l&&l.type==="enum"?l.values:null,this.configDependencies=Ic(n)}evaluateWithoutErrorHandling(n,l,d,_,f,g,w,S){return this._evaluator.globals=n,this._evaluator.feature=l,this._evaluator.featureState=d,this._evaluator.canonical=_||null,this._evaluator.availableImages=f||null,this._evaluator.formattedSection=g,this._evaluator.featureTileCoord=w||null,this._evaluator.featureDistanceData=S||null,this.expression.evaluate(this._evaluator)}evaluate(n,l,d,_,f,g,w,S){this._evaluator.globals=n,this._evaluator.feature=l||null,this._evaluator.featureState=d||null,this._evaluator.canonical=_||null,this._evaluator.availableImages=f||null,this._evaluator.formattedSection=g||null,this._evaluator.featureTileCoord=w||null,this._evaluator.featureDistanceData=S||null;try{const P=this.expression.evaluate(this._evaluator);if(P==null||typeof P=="number"&&P!=P)return this._defaultValue;if(this._enumValues&&!(P in this._enumValues))throw new Or(`Expected value to be one of ${Object.keys(this._enumValues).map(x=>JSON.stringify(x)).join(", ")}, but found ${JSON.stringify(P)} instead.`);return P}catch(P){return this._warningHistory[P.message]||(this._warningHistory[P.message]=!0,typeof console<"u"&&console.warn(`Failed to evaluate expression "${JSON.stringify(this.expression.serialize())}". ${P.message}`)),this._defaultValue}}}function wl(u){return Array.isArray(u)&&u.length>0&&typeof u[0]=="string"&&u[0]in xl}function Al(u,n,l,d){const _=new Cc(xl,[],n?function(g){const w={color:yn,string:$i,number:jt,enum:$i,boolean:Oi,formatted:Js,resolvedImage:pc};return g.type==="array"?rn(w[g.value]||Ni,g.length):w[g.type]}(n):void 0,void 0,void 0,l,d),f=_.parse(u,void 0,void 0,void 0,n&&n.type==="string"?{typeAnnotation:"coerce"}:void 0);return f?_f(new uh(f,n,l,d)):ds(_.errors)}class hh{constructor(n,l,d,_){this.kind=n,this._styleExpression=l,this.isLightConstant=d,this.isLineProgressConstant=_,this.isStateDependent=n!=="constant"&&!Sc(l.expression),this.configDependencies=Ic(l.expression)}evaluateWithoutErrorHandling(n,l,d,_,f,g){return this._styleExpression.evaluateWithoutErrorHandling(n,l,d,_,f,g)}evaluate(n,l,d,_,f,g){return this._styleExpression.evaluate(n,l,d,_,f,g)}}class Oc{constructor(n,l,d,_,f,g){this.kind=n,this.zoomStops=d,this._styleExpression=l,this.isStateDependent=n!=="camera"&&!Sc(l.expression),this.isLightConstant=f,this.isLineProgressConstant=g,this.configDependencies=Ic(l.expression),this.interpolationType=_}evaluateWithoutErrorHandling(n,l,d,_,f,g){return this._styleExpression.evaluateWithoutErrorHandling(n,l,d,_,f,g)}evaluate(n,l,d,_,f,g){return this._styleExpression.evaluate(n,l,d,_,f,g)}interpolationFactor(n,l,d){return this.interpolationType?Kn.interpolationFactor(this.interpolationType,n,l,d):0}}function o_(u,n,l,d){if((u=Al(u,n,l,d)).result==="error")return u;const _=u.value.expression,f=ml(_);if(!f&&!Bc(n))return ds([new bi("","data expressions not supported")]);const g=Oa(_,["zoom","pitch","distance-from-center"]);if(!g&&!ch(n))return ds([new bi("","zoom expressions not supported")]);const w=Oa(_,["measure-light"]);if(!w&&!r_(n))return ds([new bi("","measure-light expression not supported")]);const S=Oa(_,["line-progress"]);if(!S&&!function(I){return lh(I.expression,"line-progress")}(n))return ds([new bi("","line-progress expression not supported")]);const P=n.expression&&n.expression.relaxZoomRestriction,x=kc(_);return x||g||P?x instanceof bi?ds([x]):x instanceof Kn&&!Dc(n)?ds([new bi("",'"interpolate" expressions cannot be used with this property')]):_f(x?new Oc(f&&S?"camera":"composite",u.value,x.labels,x instanceof Kn?x.interpolation:void 0,w,S):new hh(f&&S?"constant":"source",u.value,w,S)):ds([new bi("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression, or in the properties of atmosphere.')])}class Fc{constructor(n,l){this._parameters=n,this._specification=l,Gu(this,yf(this._parameters,this._specification))}static deserialize(n){return new Fc(n._parameters,n._specification)}static serialize(n){return{_parameters:n._parameters,_specification:n._specification}}}function kc(u){let n=null;if(u instanceof nh)n=kc(u.result);else if(u instanceof rh){for(const l of u.args)if(n=kc(l),n)break}else(u instanceof gl||u instanceof Kn)&&u.input instanceof Un&&u.input.name==="zoom"&&(n=u);return n instanceof bi||u.eachChild(l=>{const d=kc(l);d instanceof bi?n=d:n&&d&&n!==d&&(n=new bi("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))}),n}var vf,a_,X0=function(){if(a_)return vf;a_=1,vf=n;var u=3;function n(l,d,_){var f=this.cells=[];if(l instanceof ArrayBuffer){this.arrayBuffer=l;var g=new Int32Array(this.arrayBuffer);l=g[0],this.d=(d=g[1])+2*(_=g[2]);for(var w=0;w<this.d*this.d;w++){var S=g[u+w],P=g[u+w+1];f.push(S===P?null:g.subarray(S,P))}var x=g[u+f.length+1];this.keys=g.subarray(g[u+f.length],x),this.bboxes=g.subarray(x),this.insert=this._insertReadonly}else{this.d=d+2*_;for(var I=0;I<this.d*this.d;I++)f.push([]);this.keys=[],this.bboxes=[]}this.n=d,this.extent=l,this.padding=_,this.scale=d/l,this.uid=0;var R=_/d*l;this.min=-R,this.max=l+R}return n.prototype.insert=function(l,d,_,f,g){this._forEachCell(d,_,f,g,this._insertCell,this.uid++),this.keys.push(l),this.bboxes.push(d),this.bboxes.push(_),this.bboxes.push(f),this.bboxes.push(g)},n.prototype._insertReadonly=function(){throw"Cannot insert into a GridIndex created from an ArrayBuffer."},n.prototype._insertCell=function(l,d,_,f,g,w){this.cells[g].push(w)},n.prototype.query=function(l,d,_,f,g){var w=this.min,S=this.max;if(l<=w&&d<=w&&S<=_&&S<=f&&!g)return Array.prototype.slice.call(this.keys);var P=[];return this._forEachCell(l,d,_,f,this._queryCell,P,{},g),P},n.prototype._queryCell=function(l,d,_,f,g,w,S,P){var x=this.cells[g];if(x!==null)for(var I=this.keys,R=this.bboxes,E=0;E<x.length;E++){var C=x[E];if(S[C]===void 0){var D=4*C;(P?P(R[D+0],R[D+1],R[D+2],R[D+3]):l<=R[D+2]&&d<=R[D+3]&&_>=R[D+0]&&f>=R[D+1])?(S[C]=!0,w.push(I[C])):S[C]=!1}}},n.prototype._forEachCell=function(l,d,_,f,g,w,S,P){for(var x=this._convertToCellCoord(l),I=this._convertToCellCoord(d),R=this._convertToCellCoord(_),E=this._convertToCellCoord(f),C=x;C<=R;C++)for(var D=I;D<=E;D++){var N=this.d*D+C;if((!P||P(this._convertFromCellCoord(C),this._convertFromCellCoord(D),this._convertFromCellCoord(C+1),this._convertFromCellCoord(D+1)))&&g.call(this,l,d,_,f,N,w,S,P))return}},n.prototype._convertFromCellCoord=function(l){return(l-this.padding)/this.scale},n.prototype._convertToCellCoord=function(l){return Math.max(0,Math.min(this.d-1,Math.floor(l*this.scale)+this.padding))},n.prototype.toArrayBuffer=function(){if(this.arrayBuffer)return this.arrayBuffer;for(var l=this.cells,d=u+this.cells.length+1+1,_=0,f=0;f<this.cells.length;f++)_+=this.cells[f].length;var g=new Int32Array(d+_+this.keys.length+this.bboxes.length);g[0]=this.extent,g[1]=this.n,g[2]=this.padding;for(var w=d,S=0;S<l.length;S++){var P=l[S];g[u+S]=w,g.set(P,w),w+=P.length}return g[u+l.length]=w,g.set(this.keys,w),g[u+l.length+1]=w+=this.keys.length,g.set(this.bboxes,w),w+=this.bboxes.length,g.buffer},vf}(),La=T(X0);const dh={};function Vt(u,n,l={}){Object.defineProperty(u,"_classRegistryKey",{value:n,writable:!1}),dh[n]={klass:u,omit:l.omit||[]}}Vt(Object,"Object"),La.serialize=function(u,n){const l=u.toArrayBuffer();return n&&n.add(l),{buffer:l}},La.deserialize=function(u){return new La(u.buffer)},Object.defineProperty(La,"name",{value:"Grid"}),Vt(La,"Grid"),typeof DOMMatrix<"u"&&Vt(DOMMatrix,"DOMMatrix"),Vt(Vi,"Color"),Vt(Error,"Error"),Vt(vn,"Formatted"),Vt(_c,"FormattedSection"),Vt(Dr,"AJAXError"),Vt(cn,"ResolvedImage"),Vt(Fc,"StylePropertyFunction"),Vt(uh,"StyleExpression",{omit:["_evaluator"]}),Vt(Qs,"ImageIdWithOptions"),Vt(Oc,"ZoomDependentExpression"),Vt(hh,"ZoomConstantExpression"),Vt(Un,"CompoundExpression",{omit:["_evaluate"]});for(const u in xl)dh[xl[u]._classRegistryKey]||Vt(xl[u],`Expression${u}`);function xf(u){return u&&typeof ArrayBuffer<"u"&&(u instanceof ArrayBuffer||u.constructor&&u.constructor.name==="ArrayBuffer")}function bf(u){return self.ImageBitmap&&u instanceof ImageBitmap}function na(u,n){if(u==null||typeof u=="boolean"||typeof u=="number"||typeof u=="string"||u instanceof Boolean||u instanceof Number||u instanceof String||u instanceof Date||u instanceof RegExp)return u;if(xf(u)||bf(u))return n&&n.add(u),u;if(ArrayBuffer.isView(u))return n&&n.add(u.buffer),u;if(u instanceof ImageData)return n&&n.add(u.data.buffer),u;if(Array.isArray(u)){const l=[];for(const d of u)l.push(na(d,n));return l}if(u instanceof Map){const l={$name:"Map"};for(const[d,_]of u.entries())l[d]=na(_);return l}if(u instanceof Set){const l={$name:"Set"};let d=0;for(const _ of u.values())l[++d]=na(_);return l}if(typeof u=="object"){const l=u.constructor,d=l._classRegistryKey;if(!d)throw new Error(`Can't serialize object of unregistered class "${d}".`);const _=l.serialize?l.serialize(u,n):{};if(!l.serialize){for(const f in u)u.hasOwnProperty(f)&&(dh[d].omit.indexOf(f)>=0||(_[f]=na(u[f],n)));u instanceof Error&&(_.message=u.message)}if(_.$name)throw new Error("$name property is reserved for worker serialization logic.");return d!=="Object"&&(_.$name=d),_}throw new Error("can't serialize object of type "+typeof u)}function Na(u){if(u==null||typeof u=="boolean"||typeof u=="number"||typeof u=="string"||u instanceof Boolean||u instanceof Number||u instanceof String||u instanceof Date||u instanceof RegExp||xf(u)||bf(u)||ArrayBuffer.isView(u)||u instanceof ImageData)return u;if(Array.isArray(u))return u.map(Na);if(typeof u=="object"){const n=u.$name||"Object";if(n==="Map"){const _=new Map;for(const f of Object.keys(u))f!=="$name"&&_.set(f,Na(u[f]));return _}if(n==="Set"){const _=new Set;for(const f of Object.keys(u))f!=="$name"&&_.add(Na(u[f]));return _}const{klass:l}=dh[n];if(!l)throw new Error(`Can't deserialize unregistered class "${n}".`);if(l.deserialize)return l.deserialize(u);const d=Object.create(l.prototype);for(const _ of Object.keys(u))_!=="$name"&&(d[_]=Na(u[_]));return d}throw new Error("can't deserialize object of type "+typeof u)}const $t={"Latin-1 Supplement":u=>u>=128&&u<=255,Arabic:u=>u>=1536&&u<=1791,"Arabic Supplement":u=>u>=1872&&u<=1919,"Arabic Extended-A":u=>u>=2208&&u<=2303,"Hangul Jamo":u=>u>=4352&&u<=4607,"Unified Canadian Aboriginal Syllabics":u=>u>=5120&&u<=5759,Khmer:u=>u>=6016&&u<=6143,"Unified Canadian Aboriginal Syllabics Extended":u=>u>=6320&&u<=6399,"General Punctuation":u=>u>=8192&&u<=8303,"Letterlike Symbols":u=>u>=8448&&u<=8527,"Number Forms":u=>u>=8528&&u<=8591,"Miscellaneous Technical":u=>u>=8960&&u<=9215,"Control Pictures":u=>u>=9216&&u<=9279,"Optical Character Recognition":u=>u>=9280&&u<=9311,"Enclosed Alphanumerics":u=>u>=9312&&u<=9471,"Geometric Shapes":u=>u>=9632&&u<=9727,"Miscellaneous Symbols":u=>u>=9728&&u<=9983,"Miscellaneous Symbols and Arrows":u=>u>=11008&&u<=11263,"CJK Radicals Supplement":u=>u>=11904&&u<=12031,"Kangxi Radicals":u=>u>=12032&&u<=12255,"Ideographic Description Characters":u=>u>=12272&&u<=12287,"CJK Symbols and Punctuation":u=>u>=12288&&u<=12351,Hiragana:u=>u>=12352&&u<=12447,Katakana:u=>u>=12448&&u<=12543,Bopomofo:u=>u>=12544&&u<=12591,"Hangul Compatibility Jamo":u=>u>=12592&&u<=12687,Kanbun:u=>u>=12688&&u<=12703,"Bopomofo Extended":u=>u>=12704&&u<=12735,"CJK Strokes":u=>u>=12736&&u<=12783,"Katakana Phonetic Extensions":u=>u>=12784&&u<=12799,"Enclosed CJK Letters and Months":u=>u>=12800&&u<=13055,"CJK Compatibility":u=>u>=13056&&u<=13311,"CJK Unified Ideographs Extension A":u=>u>=13312&&u<=19903,"Yijing Hexagram Symbols":u=>u>=19904&&u<=19967,"CJK Unified Ideographs":u=>u>=19968&&u<=40959,"Yi Syllables":u=>u>=40960&&u<=42127,"Yi Radicals":u=>u>=42128&&u<=42191,"Hangul Jamo Extended-A":u=>u>=43360&&u<=43391,"Hangul Syllables":u=>u>=44032&&u<=55215,"Hangul Jamo Extended-B":u=>u>=55216&&u<=55295,"Private Use Area":u=>u>=57344&&u<=63743,"CJK Compatibility Ideographs":u=>u>=63744&&u<=64255,"Arabic Presentation Forms-A":u=>u>=64336&&u<=65023,"Vertical Forms":u=>u>=65040&&u<=65055,"CJK Compatibility Forms":u=>u>=65072&&u<=65103,"Small Form Variants":u=>u>=65104&&u<=65135,"Arabic Presentation Forms-B":u=>u>=65136&&u<=65279,"Halfwidth and Fullwidth Forms":u=>u>=65280&&u<=65519,Osage:u=>u>=66736&&u<=66815,"CJK Unified Ideographs Extension B":u=>u>=131072&&u<=173791};function wf(u){for(const n of u)if(fh(n.charCodeAt(0)))return!0;return!1}function Z0(u){for(const n of u)if(!Y0(n.charCodeAt(0)))return!1;return!0}function Y0(u){return!($t.Arabic(u)||$t["Arabic Supplement"](u)||$t["Arabic Extended-A"](u)||$t["Arabic Presentation Forms-A"](u)||$t["Arabic Presentation Forms-B"](u))}function fh(u){return!(u!==746&&u!==747&&(u<4352||!($t["Bopomofo Extended"](u)||$t.Bopomofo(u)||$t["CJK Compatibility Forms"](u)&&!(u>=65097&&u<=65103)||$t["CJK Compatibility Ideographs"](u)||$t["CJK Compatibility"](u)||$t["CJK Radicals Supplement"](u)||$t["CJK Strokes"](u)||!(!$t["CJK Symbols and Punctuation"](u)||u>=12296&&u<=12305||u>=12308&&u<=12319||u===12336)||$t["CJK Unified Ideographs Extension A"](u)||$t["CJK Unified Ideographs"](u)||$t["Enclosed CJK Letters and Months"](u)||$t["Hangul Compatibility Jamo"](u)||$t["Hangul Jamo Extended-A"](u)||$t["Hangul Jamo Extended-B"](u)||$t["Hangul Jamo"](u)||$t["Hangul Syllables"](u)||$t.Hiragana(u)||$t["Ideographic Description Characters"](u)||$t.Kanbun(u)||$t["Kangxi Radicals"](u)||$t["Katakana Phonetic Extensions"](u)||$t.Katakana(u)&&u!==12540||!(!$t["Halfwidth and Fullwidth Forms"](u)||u===65288||u===65289||u===65293||u>=65306&&u<=65310||u===65339||u===65341||u===65343||u>=65371&&u<=65503||u===65507||u>=65512&&u<=65519)||!(!$t["Small Form Variants"](u)||u>=65112&&u<=65118||u>=65123&&u<=65126)||$t["Unified Canadian Aboriginal Syllabics"](u)||$t["Unified Canadian Aboriginal Syllabics Extended"](u)||$t["Vertical Forms"](u)||$t["Yijing Hexagram Symbols"](u)||$t["Yi Syllables"](u)||$t["Yi Radicals"](u))))}function Af(u){return!(fh(u)||function(n){return!!($t["Latin-1 Supplement"](n)&&(n===167||n===169||n===174||n===177||n===188||n===189||n===190||n===215||n===247)||$t["General Punctuation"](n)&&(n===8214||n===8224||n===8225||n===8240||n===8241||n===8251||n===8252||n===8258||n===8263||n===8264||n===8265||n===8273)||$t["Letterlike Symbols"](n)||$t["Number Forms"](n)||$t["Miscellaneous Technical"](n)&&(n>=8960&&n<=8967||n>=8972&&n<=8991||n>=8996&&n<=9e3||n===9003||n>=9085&&n<=9114||n>=9150&&n<=9165||n===9167||n>=9169&&n<=9179||n>=9186&&n<=9215)||$t["Control Pictures"](n)&&n!==9251||$t["Optical Character Recognition"](n)||$t["Enclosed Alphanumerics"](n)||$t["Geometric Shapes"](n)||$t["Miscellaneous Symbols"](n)&&!(n>=9754&&n<=9759)||$t["Miscellaneous Symbols and Arrows"](n)&&(n>=11026&&n<=11055||n>=11088&&n<=11097||n>=11192&&n<=11243)||$t["CJK Symbols and Punctuation"](n)||$t.Katakana(n)||$t["Private Use Area"](n)||$t["CJK Compatibility Forms"](n)||$t["Small Form Variants"](n)||$t["Halfwidth and Fullwidth Forms"](n)||n===8734||n===8756||n===8757||n>=9984&&n<=10087||n>=10102&&n<=10131||n===65532||n===65533)}(u))}function Tf(u){return u>=1424&&u<=2303||$t["Arabic Presentation Forms-A"](u)||$t["Arabic Presentation Forms-B"](u)}function l_(u,n){return!(!n&&Tf(u)||u>=2304&&u<=3583||u>=3840&&u<=4255||$t.Khmer(u))}function Ef(u){for(const n of u)if(Tf(n.charCodeAt(0)))return!0;return!1}const Lc="deferred",ph="loading",Sf="loaded";let eo=null,Jn="unavailable",sa=null;const If=function(u){u&&typeof u=="string"&&u.indexOf("NetworkError")>-1&&(Jn="error"),eo&&eo(u)};function Cf(){Tl.fire(new Ks("pluginStateChange",{pluginStatus:Jn,pluginURL:sa}))}const Tl=new Qo,mh=function(){return Jn},Nc=function(){if(Jn!==Lc||!sa)throw new Error("rtl-text-plugin cannot be downloaded unless a pluginURL is specified");Jn=ph,Cf(),sa&&qr({url:sa},u=>{u?If(u):(Jn=Sf,Cf())})},fs={applyArabicShaping:null,processBidirectionalText:null,processStyledBidirectionalText:null,isLoaded:()=>Jn===Sf||fs.applyArabicShaping!=null,isLoading:()=>Jn===ph,setState(u){Jn=u.pluginStatus,sa=u.pluginURL},isParsed:()=>fs.applyArabicShaping!=null&&fs.processBidirectionalText!=null&&fs.processStyledBidirectionalText!=null,getPluginURL:()=>sa};class tr{constructor(n,l){this.zoom=n,l?(this.now=l.now,this.fadeDuration=l.fadeDuration,this.transition=l.transition,this.pitch=l.pitch,this.brightness=l.brightness):(this.now=0,this.fadeDuration=0,this.transition={},this.pitch=0,this.brightness=0)}isSupportedScript(n){return function(l,d){for(const _ of l)if(!l_(_.charCodeAt(0),d))return!1;return!0}(n,fs.isLoaded())}}class _h{constructor(n,l,d,_){this.property=n,this.value=l,this.expression=function(f,g,w,S){if(gf(f))return new Fc(f,g);if(wl(f)||Array.isArray(f)&&f.length>0){const P=o_(f,g,w,S);if(P.result==="error")throw new Error(P.value.map(x=>`${x.key}: ${x.message}`).join(", "));return P.value}{let P=f;return typeof f=="string"&&g.type==="color"&&(P=Vi.parse(f)),{kind:"constant",configDependencies:new Set,evaluate:()=>P}}}(l===void 0?n.specification.default:l,n.specification,d,_)}isDataDriven(){return this.expression.kind==="source"||this.expression.kind==="composite"}possiblyEvaluate(n,l,d){return this.property.possiblyEvaluate(this,n,l,d)}}class zc{constructor(n,l,d){this.property=n,this.value=new _h(n,void 0,l,d)}transitioned(n,l){return new Mf(this.property,this.value,l,Mn({},n.transition,this.transition),n.now)}untransitioned(){return new Mf(this.property,this.value,null,{},0)}}class gh{constructor(n,l,d){this._properties=n,this._values=Object.create(n.defaultTransitionablePropertyValues),this._scope=l,this._options=d,this.configDependencies=new Set}getValue(n){return hs(this._values[n].value.value)}setValue(n,l){this._values.hasOwnProperty(n)||(this._values[n]=new zc(this._values[n].property,this._scope,this._options)),this._values[n].value=new _h(this._values[n].property,l===null?void 0:hs(l),this._scope,this._options),this._values[n].value.expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[n].value.expression.configDependencies]))}setTransitionOrValue(n,l){l&&(this._options=l);const d=this._properties.properties;if(n)for(const _ in n){const f=n[_];if(Nn(_,"-transition")){const g=_.slice(0,-11);d[g]&&this.setTransition(g,f)}else d.hasOwnProperty(_)&&this.setValue(_,f)}}getTransition(n){return hs(this._values[n].transition)}setTransition(n,l){this._values.hasOwnProperty(n)||(this._values[n]=new zc(this._values[n].property)),this._values[n].transition=hs(l)||void 0}serialize(){const n={};for(const l of Object.keys(this._values)){const d=this.getValue(l);d!==void 0&&(n[l]=d);const _=this.getTransition(l);_!==void 0&&(n[`${l}-transition`]=_)}return n}transitioned(n,l){const d=new Uc(this._properties);for(const _ of Object.keys(this._values))d._values[_]=this._values[_].transitioned(n,l._values[_]);return d}untransitioned(){const n=new Uc(this._properties);for(const l of Object.keys(this._values))n._values[l]=this._values[l].untransitioned();return n}}class Mf{constructor(n,l,d,_,f){const g=_.delay||0,w=_.duration||0;f=f||0,this.property=n,this.value=l,this.begin=f+g,this.end=this.begin+w,n.specification.transition&&(_.delay||_.duration)&&(this.prior=d)}possiblyEvaluate(n,l,d){const _=n.now||0,f=this.value.possiblyEvaluate(n,l,d),g=this.prior;if(g){if(_>this.end)return this.prior=null,f;if(this.value.isDataDriven())return this.prior=null,f;if(_<this.begin)return g.possiblyEvaluate(n,l,d);{const w=(_-this.begin)/(this.end-this.begin);return this.property.interpolate(g.possiblyEvaluate(n,l,d),f,Ws(w))}}return f}}class Uc{constructor(n){this._properties=n,this._values=Object.create(n.defaultTransitioningPropertyValues)}possiblyEvaluate(n,l,d){const _=new Il(this._properties);for(const f of Object.keys(this._values))_._values[f]=this._values[f].possiblyEvaluate(n,l,d);return _}hasTransition(){for(const n of Object.keys(this._values))if(this._values[n].prior)return!0;return!1}}class El{constructor(n,l,d){this._properties=n,this._values=Object.create(n.defaultPropertyValues),this._scope=l,this._options=d,this.configDependencies=new Set}getValue(n){return hs(this._values[n].value)}setValue(n,l){this._values[n]=new _h(this._values[n].property,l===null?void 0:hs(l),this._scope,this._options),this._values[n].expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[n].expression.configDependencies]))}serialize(){const n={};for(const l of Object.keys(this._values)){const d=this.getValue(l);d!==void 0&&(n[l]=d)}return n}possiblyEvaluate(n,l,d){const _=new Il(this._properties);for(const f of Object.keys(this._values))_._values[f]=this._values[f].possiblyEvaluate(n,l,d);return _}}class Sl{constructor(n,l,d){this.property=n,this.value=l,this.parameters=d}isConstant(){return this.value.kind==="constant"}constantOr(n){return this.value.kind==="constant"?this.value.value:n}evaluate(n,l,d,_){return this.property.evaluate(this.value,this.parameters,n,l,d,_)}}class Il{constructor(n){this._properties=n,this._values=Object.create(n.defaultPossiblyEvaluatedValues)}get(n){return this._values[n]}}class wt{constructor(n){this.specification=n}possiblyEvaluate(n,l){return n.expression.evaluate(l)}interpolate(n,l,d){const _=Hu[this.specification.type];return _?_(n,l,d):n}}class Nt{constructor(n,l){this.specification=n,this.overrides=l}possiblyEvaluate(n,l,d,_){return new Sl(this,n.expression.kind==="constant"||n.expression.kind==="camera"?{kind:"constant",value:n.expression.evaluate(l,null,{},d,_)}:n.expression,l)}interpolate(n,l,d){if(n.value.kind!=="constant"||l.value.kind!=="constant")return n;if(n.value.value===void 0||l.value.value===void 0)return new Sl(this,{kind:"constant",value:void 0},n.parameters);const _=Hu[this.specification.type];return _?new Sl(this,{kind:"constant",value:_(n.value.value,l.value.value,d)},n.parameters):n}evaluate(n,l,d,_,f,g){return n.kind==="constant"?n.value:n.evaluate(l,d,_,f,g)}}class Cl{constructor(n){this.specification=n}possiblyEvaluate(n,l,d,_){return!!n.expression.evaluate(l,null,{},d,_)}interpolate(){return!1}}class cr{constructor(n){this.properties=n,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];const l=new tr(0,{});for(const d in n){const _=n[d];_.specification.overridable&&this.overridableProperties.push(d);const f=this.defaultPropertyValues[d]=new _h(_,void 0),g=this.defaultTransitionablePropertyValues[d]=new zc(_);this.defaultTransitioningPropertyValues[d]=g.untransitioned(),this.defaultPossiblyEvaluatedValues[d]=f.possiblyEvaluate(l)}}}Vt(Nt,"DataDrivenProperty"),Vt(wt,"DataConstantProperty"),Vt(Cl,"ColorRampProperty");var qe=JSON.parse('{"$version":8,"$root":{"version":{"required":true,"type":"enum","values":[8]},"fragment":{"type":"boolean"},"name":{"type":"string"},"metadata":{"type":"*"},"center":{"type":"array","value":"number"},"zoom":{"type":"number"},"bearing":{"type":"number","default":0,"period":360},"pitch":{"type":"number","default":0},"light":{"type":"light"},"lights":{"required":false,"type":"array","value":"light-3d"},"terrain":{"type":"terrain","optional":true},"fog":{"type":"fog"},"snow":{"type":"snow","experimental":true},"rain":{"type":"rain","experimental":true},"camera":{"type":"camera"},"color-theme":{"type":"colorTheme"},"indoor":{"type":"indoor","experimental":true},"imports":{"type":"array","value":"import"},"schema":{"type":"schema"},"sources":{"required":true,"type":"sources"},"sprite":{"type":"string"},"glyphs":{"type":"string","default":"mapbox://fonts/mapbox/{fontstack}/{range}.pbf"},"transition":{"type":"transition"},"projection":{"type":"projection"},"layers":{"required":true,"type":"array","value":"layer"},"models":{"type":"models"},"featuresets":{"experimental":true,"type":"featuresets"}},"featuresets":{"experimental":true,"*":{"type":"featureset"}},"featureset":{"experimental":true,"metadata":{"experimental":true,"type":"*"},"selectors":{"experimental":true,"type":"array","value":"selector"}},"selector":{"experimental":true,"layer":{"experimental":true,"type":"string","required":true},"properties":{"experimental":true,"type":"selectorProperty","required":false},"featureNamespace":{"experimental":true,"type":"string","required":false},"_uniqueFeatureID":{"experimental":true,"type":"boolean","private":true,"required":false}},"selectorProperty":{"experimental":true,"*":{"experimental":true,"type":"*"}},"model":{"type":"string","required":true},"import":{"id":{"type":"string","required":true},"url":{"type":"string","required":true},"config":{"type":"config"},"data":{"type":"$root"},"color-theme":{"type":"colorTheme","optional":true}},"config":{"*":{"type":"*"}},"schema":{"*":{"type":"option"}},"option":{"default":{"type":"*","property-type":"data-constant","expression":{},"required":true},"type":{"type":"enum","values":{"string":1,"number":1,"boolean":1,"color":1}},"array":{"type":"boolean"},"minValue":{"type":"number"},"maxValue":{"type":"number"},"stepValue":{"type":"number"},"values":{"type":"array","value":"*"},"metadata":{"type":"*"}},"models":{"*":{"type":"model"}},"light-3d":{"id":{"type":"string","required":true},"properties":{"type":"properties"},"type":{"type":"enum","values":{"ambient":{},"directional":{},"flat":{}}}},"properties":["properties_light_directional","properties_light_ambient","properties_light_flat"],"properties_light_directional":{"direction":{"type":"array","default":[210,30],"minimum":[0,0],"maximum":[360,90],"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"cast-shadows":{"type":"boolean","default":false,"property-type":"data-constant"},"shadow-quality":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1,"expression":{"parameters":["zoom"]},"experimental":true},"shadow-intensity":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_ambient":{"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_flat":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"property-type":"data-constant","expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"sources":{"*":{"type":"source"}},"source":["source_vector","source_raster","source_raster_dem","source_raster_array","source_geojson","source_video","source_image","source_model"],"source_vector":{"type":{"required":true,"type":"enum","values":{"vector":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"attribution":{"type":"string"},"promoteId":{"type":"promoteId"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster":{"type":{"required":true,"type":"enum","values":{"raster":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"attribution":{"type":"string"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_dem":{"type":{"required":true,"type":"enum","values":{"raster-dem":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"encoding":{"type":"enum","values":{"terrarium":1,"mapbox":1},"default":"mapbox"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_array":{"experimental":true,"type":{"required":true,"type":"enum","values":{"raster-array":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"rasterLayers":{"type":"*"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_geojson":{"type":{"required":true,"type":"enum","values":{"geojson":1}},"data":{"type":"*"},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"attribution":{"type":"string"},"buffer":{"type":"number","default":128,"maximum":512,"minimum":0},"filter":{"type":"*"},"tolerance":{"type":"number","default":0.375},"cluster":{"type":"boolean","default":false},"clusterRadius":{"type":"number","default":50,"minimum":0},"clusterMaxZoom":{"type":"number"},"clusterMinPoints":{"type":"number"},"clusterProperties":{"type":"*"},"lineMetrics":{"type":"boolean","default":false},"generateId":{"type":"boolean","default":false},"promoteId":{"type":"promoteId"},"dynamic":{"type":"boolean","default":false}},"source_video":{"type":{"required":true,"type":"enum","values":{"video":1}},"urls":{"required":true,"type":"array","value":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_image":{"type":{"required":true,"type":"enum","values":{"image":1}},"url":{"required":false,"type":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_model":{"type":{"required":true,"type":"enum","values":{"model":1,"batched-model":1}},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"tiles":{"type":"array","value":"string"}},"layer":{"id":{"type":"string","required":true},"type":{"type":"enum","values":{"fill":{},"line":{},"symbol":{},"circle":{},"heatmap":{},"fill-extrusion":{},"raster":{},"raster-particle":{"experimental":true},"hillshade":{},"model":{"experimental":true},"background":{},"sky":{},"slot":{},"clip":{}},"required":true},"metadata":{"type":"*"},"source":{"type":"string"},"source-layer":{"type":"string"},"slot":{"type":"string"},"minzoom":{"type":"number","minimum":0,"maximum":24},"maxzoom":{"type":"number","minimum":0,"maximum":24},"filter":{"type":"filter"},"layout":{"type":"layout"},"paint":{"type":"paint"}},"layout":["layout_clip","layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_symbol","layout_raster","layout_raster-particle","layout_hillshade","layout_background","layout_sky","layout_model"],"layout_background":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_sky":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_model":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"model-id":{"type":"string","default":"","property-type":"data-driven","expression":{"parameters":["zoom","feature"]}}},"layout_clip":{"clip-layer-types":{"type":"array","value":"enum","values":{"model":1,"symbol":1},"default":[],"expression":{},"property-type":"data-constant"},"clip-layer-scope":{"type":"array","value":"string","default":[],"expression":{},"property-type":"data-constant"}},"layout_fill":{"fill-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"fill-elevation-reference":{"type":"enum","values":{"none":1,"hd-road-base":1,"hd-road-markup":1},"default":"none","experimental":true,"private":true,"expression":{},"property-type":"data-constant"}},"layout_circle":{"circle-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"circle-elevation-reference":{"type":"enum","values":{"none":1,"hd-road-markup":1},"default":"none","experimental":true,"expression":{},"property-type":"data-constant"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_heatmap":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_fill-extrusion":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"fill-extrusion-edge-radius":{"type":"number","experimental":true,"default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"constant"}},"layout_line":{"line-cap":{"type":"enum","values":{"butt":1,"round":1,"square":1},"default":"butt","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-join":{"type":"enum","values":{"bevel":1,"round":1,"miter":1,"none":1},"default":"miter","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{"type":"number","default":2,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-round-limit":{"type":"number","default":1.05,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-z-offset":{"type":"number","experimental":true,"default":0,"expression":{"parameters":["zoom","feature","line-progress"]},"property-type":"data-driven"},"line-elevation-reference":{"type":"enum","values":{"none":1,"sea":1,"ground":1,"hd-road-markup":1},"default":"none","experimental":true,"expression":{},"property-type":"data-constant"},"line-cross-slope":{"type":"number","experimental":true,"expression":{},"property-type":"constant"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"line-width-unit":{"type":"enum","values":{"pixels":1,"meters":1},"default":"pixels","experimental":true,"private":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"}},"layout_symbol":{"symbol-placement":{"type":"enum","values":{"point":1,"line":1,"line-center":1},"default":"point","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-spacing":{"type":"number","default":250,"minimum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"symbol-avoid-edges":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{"type":"enum","values":{"auto":1,"viewport-y":1,"source":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-z-elevate":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-elevation-reference":{"type":"enum","values":{"sea":1,"ground":1,"hd-road-markup":1},"default":"ground","experimental":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-size":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":0.1,"maximum":10,"experimental":true,"private":true,"expression":{},"property-type":"data-constant"},"icon-text-fit":{"type":"enum","values":{"none":1,"width":1,"height":1,"both":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit-padding":{"type":"array","value":"number","length":4,"default":[0,0,0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-image":{"type":"resolvedImage","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-keep-upright":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-field":{"type":"formatted","default":"","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-font":{"type":"array","value":"string","default":["Open Sans Regular","Arial Unicode MS Regular"],"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size":{"type":"number","default":16,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":0.1,"maximum":10,"experimental":true,"private":true,"expression":{},"property-type":"data-constant"},"text-max-width":{"type":"number","default":10,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{"type":"number","default":1.2,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-letter-spacing":{"type":"number","default":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-justify":{"type":"enum","values":{"auto":1,"left":1,"center":1,"right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{"type":"number","default":0,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["zoom","feature"]}},"text-variable-anchor":{"type":"array","value":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{"type":"number","default":45,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-writing-mode":{"type":"array","value":"enum","values":{"horizontal":1,"vertical":1},"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-keep-upright":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-transform":{"type":"enum","values":{"none":1,"uppercase":1,"lowercase":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_raster":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_raster-particle":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_hillshade":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"filter":{"type":"array","value":"*"},"filter_symbol":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature","pitch","distance-from-center"]}},"filter_fill":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_hillshade":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster-particle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_clip":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_model":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_line":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_circle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_fill-extrusion":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_heatmap":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_operator":{"type":"enum","values":{"==":1,"!=":1,">":1,">=":1,"<":1,"<=":1,"in":1,"!in":1,"all":1,"any":1,"none":1,"has":1,"!has":1}},"geometry_type":{"type":"enum","values":{"Point":1,"LineString":1,"Polygon":1}},"function":{"expression":{"type":"expression"},"stops":{"type":"array","value":"function_stop"},"base":{"type":"number","default":1,"minimum":0},"property":{"type":"string","default":"$zoom"},"type":{"type":"enum","values":{"identity":1,"exponential":1,"interval":1,"categorical":1},"default":"exponential"},"colorSpace":{"type":"enum","values":{"rgb":1,"lab":1,"hcl":1},"default":"rgb"},"default":{"type":"*","required":false}},"function_stop":{"type":"array","minimum":0,"maximum":24,"value":["number","color"],"length":2},"expression":{"type":"array","value":"*","minimum":1},"fog":{"range":{"type":"array","default":[0.5,10],"minimum":-20,"maximum":20,"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"high-color":{"type":"color","property-type":"data-constant","default":"#245cdf","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"space-color":{"type":"color","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],4,"#010b19",7,"#367ab9"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"horizon-blend":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],4,0.2,7,0.1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"star-intensity":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],5,0.35,6,0],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vertical-range":{"type":"array","default":[0,0],"minimum":0,"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}}},"snow":{"density":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],11,0,13,0.85],"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"opacity":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],11,0,13,0.3],"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","property-type":"data-constant","default":"#ffffff","experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"center-thinning":{"type":"number","property-type":"data-constant","default":0.4,"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,50],"minimum":0,"maximum":360,"length":2,"value":"number","property-type":"data-constant","transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"flake-size":{"type":"number","property-type":"data-constant","default":0.71,"minimum":0,"maximum":5,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"rain":{"density":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],11,0,13,0.5],"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","property-type":"data-constant","default":["interpolate",["linear"],["measure-light","brightness"],0,"#03113d",0.3,"#a8adbc"],"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"opacity":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["measure-light","brightness"],0,0.88,1,0.7],"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],11,0,13,1],"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","property-type":"data-constant","default":["interpolate",["linear"],["measure-light","brightness"],0,"#001736",0.3,"#464646"],"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"center-thinning":{"type":"number","property-type":"data-constant","default":0.57,"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,80],"minimum":0,"maximum":360,"length":2,"value":"number","property-type":"data-constant","transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"droplet-size":{"type":"array","default":[2.6,18.2],"minimum":0,"maximum":50,"length":2,"value":"number","property-type":"data-constant","transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"distortion-strength":{"type":"number","property-type":"data-constant","default":0.7,"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"camera":{"camera-projection":{"type":"enum","values":{"perspective":1,"orthographic":1},"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"default":"perspective","property-type":"data-constant"}},"colorTheme":{"data":{"type":"string","property-type":"data-constant","expression":{}}},"indoor":{"floorplanFeaturesetId":{"type":"string","experimental":true,"property-type":"data-constant","expression":{}},"buildingFeaturesetId":{"type":"string","experimental":true,"property-type":"data-constant","expression":{}}},"light":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"property-type":"data-constant","expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"projection":{"name":{"type":"enum","values":{"albers":1,"equalEarth":1,"equirectangular":1,"lambertConformalConic":1,"mercator":1,"naturalEarth":1,"winkelTripel":1,"globe":1},"default":"mercator","required":true},"center":{"type":"array","length":2,"value":"number","property-type":"data-constant","minimum":[-180,-90],"maximum":[180,90]},"parallels":{"type":"array","length":2,"value":"number","property-type":"data-constant","minimum":[-90,-90],"maximum":[90,90]}},"terrain":{"source":{"type":"string","required":true},"exaggeration":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1000,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint":["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_symbol","paint_raster","paint_raster-particle","paint_hillshade","paint_background","paint_sky","paint_model"],"paint_fill":{"fill-antialias":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-outline-color":{"type":"color","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"fill-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-extrusion-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-height-alignment":{"type":"enum","experimental":true,"values":{"terrain":1,"flat":1},"default":"flat","property-type":"data-constant"},"fill-extrusion-base-alignment":{"type":"enum","experimental":true,"values":{"terrain":1,"flat":1},"default":"terrain","property-type":"data-constant"},"fill-extrusion-vertical-gradient":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-ambient-occlusion-intensity":{"property-type":"data-constant","type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-radius":{"property-type":"data-constant","type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-wall-radius":{"property-type":"data-constant","type":"number","experimental":true,"default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-radius":{"property-type":"data-constant","type":"number","experimental":true,"default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-attenuation":{"property-type":"data-constant","type":"number","experimental":true,"default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-flood-light-color":{"property-type":"data-constant","type":"color","experimental":true,"default":"#ffffff","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-intensity":{"property-type":"data-constant","type":"number","experimental":true,"default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-wall-radius":{"property-type":"data-driven","type":"number","experimental":true,"default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-radius":{"property-type":"data-driven","type":"number","experimental":true,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-attenuation":{"property-type":"data-constant","type":"number","experimental":true,"default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-vertical-scale":{"property-type":"data-constant","type":"number","experimental":true,"default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-rounded-roof":{"property-type":"data-constant","type":"boolean","default":true,"experimental":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"},"fill-extrusion-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"fill-extrusion-line-width":{"type":"number","default":0,"minimum":0,"transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-cast-shadows":{"type":"boolean","default":true,"property-type":"data-constant"}},"paint_line":{"line-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"line-width":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light","line-progress"]},"property-type":"data-driven"},"line-gap-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-offset":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-dasharray":{"type":"array","value":"number","minimum":0,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-gradient":{"type":"color","expression":{"interpolated":true,"parameters":["line-progress"]},"property-type":"color-ramp"},"line-trim-offset":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"property-type":"constant"},"line-trim-fade-range":{"type":"array","value":"number","experimental":true,"length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"line-trim-color":{"type":"color","experimental":true,"default":"transparent","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"line-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"line-border-width":{"type":"number","private":true,"default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-border-color":{"type":"color","private":true,"default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-occlusion-opacity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true,"property-type":"data-constant"}},"paint_circle":{"circle-radius":{"type":"number","default":5,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-blur":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"circle-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-scale":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-stroke-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_heatmap":{"heatmap-radius":{"type":"number","default":30,"minimum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-weight":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-intensity":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"heatmap-color":{"type":"color","default":["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",0.1,"royalblue",0.3,"cyan",0.5,"lime",0.7,"yellow",1,"red"],"expression":{"interpolated":true,"parameters":["heatmap-density"]},"property-type":"color-ramp"},"heatmap-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_symbol":{"icon-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"text-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"icon-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-image-cross-fade":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"transition":true},"text-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-color":{"type":"color","default":"#000000","transition":true,"overridable":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-color-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{},"property-type":"data-constant"},"icon-color-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{},"property-type":"data-constant"},"icon-color-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"},"icon-color-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"},"symbol-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"}},"paint_raster":{"raster-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-color":{"type":"color","expression":{"interpolated":true,"parameters":["raster-value"]},"property-type":"color-ramp"},"raster-color-mix":{"type":"array","default":[0.2126,0.7152,0.0722,0],"length":4,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color-range":{"type":"array","length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-hue-rotate":{"type":"number","default":0,"period":360,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-resampling":{"type":"enum","values":{"linear":1,"nearest":1},"default":"linear","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"raster-fade-duration":{"type":"number","default":300,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"raster-array-band":{"type":"string","required":false,"experimental":true,"property-type":"data-constant"},"raster-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_raster-particle":{"raster-particle-array-band":{"type":"string","required":false,"property-type":"data-constant"},"raster-particle-count":{"type":"number","default":512,"minimum":1,"property-type":"data-constant"},"raster-particle-color":{"type":"color","expression":{"interpolated":true,"parameters":["raster-particle-speed"]},"property-type":"color-ramp"},"raster-particle-max-speed":{"type":"number","default":1,"minimum":1,"property-type":"data-constant"},"raster-particle-speed-factor":{"type":"number","default":0.2,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-particle-fade-opacity-factor":{"type":"number","default":0.98,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-particle-reset-rate-factor":{"type":"number","default":0.8,"minimum":0,"maximum":1,"property-type":"data-constant"},"raster-particle-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_hillshade":{"hillshade-illumination-direction":{"type":"number","default":335,"minimum":0,"maximum":359,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-illumination-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-exaggeration":{"type":"number","default":0.5,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-shadow-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-highlight-color":{"type":"color","default":"#FFFFFF","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-accent-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_background":{"background-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":[]},"experimental":true,"property-type":"data-constant"},"background-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"background-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"background-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"background-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_sky":{"sky-type":{"type":"enum","values":{"gradient":1,"atmosphere":1},"default":"atmosphere","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun":{"type":"array","value":"number","length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun-intensity":{"type":"number","default":10,"minimum":0,"maximum":100,"property-type":"data-constant"},"sky-gradient-center":{"type":"array","value":"number","default":[0,0],"length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient-radius":{"type":"number","default":90,"minimum":0,"maximum":180,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient":{"type":"color","default":["interpolate",["linear"],["sky-radial-progress"],0.8,"#87ceeb",1,"white"],"expression":{"interpolated":true,"parameters":["sky-radial-progress"]},"property-type":"color-ramp"},"sky-atmosphere-halo-color":{"type":"color","default":"white","property-type":"data-constant"},"sky-atmosphere-color":{"type":"color","default":"white","property-type":"data-constant"},"sky-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_model":{"model-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"property-type":"data-driven"},"model-rotation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-scale":{"type":"array","value":"number","length":3,"default":[1,1,1],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-translation":{"type":"array","value":"number","length":3,"default":[0,0,0],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-color":{"type":"color","default":"#ffffff","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light","zoom"]},"transition":true},"model-color-mix-intensity":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-type":{"type":"enum","values":{"common-3d":1,"location-indicator":1},"default":"common-3d","property-type":"data-constant"},"model-cast-shadows":{"type":"boolean","default":true,"property-type":"data-constant"},"model-receive-shadows":{"type":"boolean","default":true,"property-type":"data-constant"},"model-ambient-occlusion-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant","transition":true},"model-emissive-strength":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-roughness":{"type":"number","default":1,"minimum":0,"maximum":1,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state"]},"transition":true},"model-height-based-emissive-strength-multiplier":{"type":"array","default":[1,1,1,1,0],"length":5,"value":"number","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"},"model-front-cutoff":{"type":"array","private":true,"value":"number","property-type":"data-constant","expression":{"interpolated":true,"parameters":["zoom"]},"length":3,"default":[0,0,1],"minimum":[0,0,0],"maximum":[1,1,1]}},"transition":{"duration":{"type":"number","default":300,"minimum":0},"delay":{"type":"number","default":0,"minimum":0}},"property-type":{"data-driven":{"type":"property-type"},"color-ramp":{"type":"property-type"},"data-constant":{"type":"property-type"},"constant":{"type":"property-type"}},"promoteId":{"*":{"type":"*"}}}');function c_(u){return u instanceof Number||u instanceof String||u instanceof Boolean?u.valueOf():u}function yh(u){if(Array.isArray(u))return u.map(yh);if(u instanceof Object&&!(u instanceof Number||u instanceof String||u instanceof Boolean)){const n={};for(const l in u)n[l]=yh(u[l]);return n}return c_(u)}function Rf(u){if(u===!0||u===!1)return!0;if(!Array.isArray(u)||u.length===0)return!1;switch(u[0]){case"has":return u.length>=2&&u[1]!=="$id"&&u[1]!=="$type";case"in":return u.length>=3&&(typeof u[1]!="string"||Array.isArray(u[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return u.length!==3||Array.isArray(u[1])||Array.isArray(u[2]);case"any":case"all":for(const n of u.slice(1))if(!Rf(n)&&typeof n!="boolean")return!1;return!0;default:return!0}}function u_(u,n="",l=null,d="fill"){if(u==null)return{filter:()=>!0,needGeometry:!1,needFeature:!1};Rf(u)||(u=vh(u));const _=u;let f=!0;try{f=function(x){if(!Ml(x))return x;let I=yh(x);return d_(I),I=h_(I),I}(_)}catch{console.warn(`Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.
This is most likely a bug, please report this via https://github.com/mapbox/mapbox-gl-js/issues/new?assignees=&labels=&template=Bug_report.md
and paste the contents of this message in the report.
Thank you!
Filter Expression:
${JSON.stringify(_,null,2)}
        `)}let g=null,w=null;if(d!=="background"&&d!=="sky"&&d!=="slot"){w=qe[`filter_${d}`];const x=Al(f,w,n,l);if(x.result==="error")throw new Error(x.value.map(I=>`${I.key}: ${I.message}`).join(", "));g=(I,R,E)=>x.value.evaluate(I,R,{},E)}let S=null,P=null;if(f!==_){const x=Al(_,w,n,l);if(x.result==="error")throw new Error(x.value.map(I=>`${I.key}: ${I.message}`).join(", "));S=(I,R,E,C,D)=>x.value.evaluate(I,R,{},E,void 0,void 0,C,D),P=!ml(x.value.expression)}return{filter:g,dynamicFilter:S||void 0,needGeometry:f_(f),needFeature:!!P}}function h_(u){if(!Array.isArray(u))return u;const n=function(l){if(K0.has(l[0])){for(let d=1;d<l.length;d++)if(Ml(l[d]))return!0}return l}(u);return n===!0?n:n.map(l=>h_(l))}function d_(u){let n=!1;const l=[];if(u[0]==="case"){for(let d=1;d<u.length-1;d+=2)n=n||Ml(u[d]),l.push(u[d+1]);l.push(u[u.length-1])}else if(u[0]==="match"){n=n||Ml(u[1]);for(let d=2;d<u.length-1;d+=2)l.push(u[d+1]);l.push(u[u.length-1])}else if(u[0]==="step"){n=n||Ml(u[1]);for(let d=1;d<u.length-1;d+=2)l.push(u[d+1])}n&&(u.length=0,u.push("any",...l));for(let d=1;d<u.length;d++)d_(u[d])}function Ml(u){if(!Array.isArray(u))return!1;if((n=u[0])==="pitch"||n==="distance-from-center")return!0;var n;for(let l=1;l<u.length;l++)if(Ml(u[l]))return!0;return!1}const K0=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function J0(u,n){return u<n?-1:u>n?1:0}function f_(u){if(!Array.isArray(u))return!1;if(u[0]==="within"||u[0]==="distance")return!0;for(let n=1;n<u.length;n++)if(f_(u[n]))return!0;return!1}function vh(u){if(!u)return!0;const n=u[0];return u.length<=1?n!=="any":n==="=="?oa(u[1],u[2],"=="):n==="!="?za(oa(u[1],u[2],"==")):n==="<"||n===">"||n==="<="||n===">="?oa(u[1],u[2],n):n==="any"?(l=u.slice(1),["any"].concat(l.map(vh))):n==="all"?["all"].concat(u.slice(1).map(vh)):n==="none"?["all"].concat(u.slice(1).map(vh).map(za)):n==="in"?Pf(u[1],u.slice(2)):n==="!in"?za(Pf(u[1],u.slice(2))):n==="has"?Bf(u[1]):n!=="!has"||za(Bf(u[1]));var l}function oa(u,n,l){switch(u){case"$type":return[`filter-type-${l}`,n];case"$id":return[`filter-id-${l}`,n];default:return[`filter-${l}`,u,n]}}function Pf(u,n){if(n.length===0)return!1;switch(u){case"$type":return["filter-type-in",["literal",n]];case"$id":return["filter-id-in",["literal",n]];default:return n.length>200&&!n.some(l=>typeof l!=typeof n[0])?["filter-in-large",u,["literal",n.sort(J0)]]:["filter-in-small",u,["literal",n]]}}function Bf(u){switch(u){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",u]}}function za(u){return["!",u]}const xh="";function to(u,n){return n?`${u}${xh}${n}`:u}const Bo="-transition",p_=new Set(["fill","line","background","hillshade","raster"]);class Jr extends Qo{constructor(n,l,d,_,f){if(super(),this.id=n.id,this.fqid=to(this.id,d),this.type=n.type,this.scope=d,this.lut=_,this.options=f,this._featureFilter={filter:()=>!0,needGeometry:!1,needFeature:!1},this._filterCompiled=!1,this.configDependencies=new Set,n.type!=="custom"){if(this.metadata=n.metadata,this.minzoom=n.minzoom,this.maxzoom=n.maxzoom,n.type&&n.type!=="background"&&n.type!=="sky"&&n.type!=="slot"){this.source=n.source,this.sourceLayer=n["source-layer"],this.filter=n.filter;const g=Al(this.filter,qe[`filter_${n.type}`]);g.result!=="error"&&(this.configDependencies=new Set([...this.configDependencies,...g.value.configDependencies]))}if(n.slot&&(this.slot=n.slot),l.layout&&(this._unevaluatedLayout=new El(l.layout,this.scope,f),this.configDependencies=new Set([...this.configDependencies,...this._unevaluatedLayout.configDependencies])),l.paint){this._transitionablePaint=new gh(l.paint,this.scope,f);for(const g in n.paint)this.setPaintProperty(g,n.paint[g]);for(const g in n.layout)this.setLayoutProperty(g,n.layout[g]);this.configDependencies=new Set([...this.configDependencies,...this._transitionablePaint.configDependencies]),this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new Il(l.paint)}}}onAdd(n){}onRemove(n){}isDraped(n){return!this.is3D()&&p_.has(this.type)}getLayoutProperty(n){return n==="visibility"?this.visibility:this._unevaluatedLayout.getValue(n)}setLayoutProperty(n,l){if(this.type==="custom"&&n==="visibility")return void(this.visibility=l);const d=this._unevaluatedLayout;d._properties.properties[n]&&(d.setValue(n,l),this.configDependencies=new Set([...this.configDependencies,...d.configDependencies]),n==="visibility"&&this.possiblyEvaluateVisibility())}possiblyEvaluateVisibility(){this._unevaluatedLayout._values.visibility&&(this.visibility=this._unevaluatedLayout._values.visibility.possiblyEvaluate({zoom:0}))}getPaintProperty(n){return Nn(n,Bo)?this._transitionablePaint.getTransition(n.slice(0,-11)):this._transitionablePaint.getValue(n)}setPaintProperty(n,l){const d=this._transitionablePaint,_=d._properties.properties;if(Nn(n,Bo)){const I=n.slice(0,-11);return _[I]&&d.setTransition(I,l||void 0),!1}if(!_[n])return!1;const f=d._values[n],g=f.value.isDataDriven(),w=f.value;d.setValue(n,l),this.configDependencies=new Set([...this.configDependencies,...d.configDependencies]),this._handleSpecialPaintPropertyUpdate(n);const S=d._values[n].value,P=S.isDataDriven(),x=Nn(n,"pattern")||n==="line-dasharray";return P||g||x||this._handleOverridablePaintPropertyUpdate(n,w,S)}_handleSpecialPaintPropertyUpdate(n){}getProgramIds(){return null}getDefaultProgramParams(n,l,d){return null}_handleOverridablePaintPropertyUpdate(n,l,d){return!1}isHidden(n){return!!(this.minzoom&&n<this.minzoom)||!!(this.maxzoom&&n>=this.maxzoom)||this.visibility==="none"}updateTransitions(n){this._transitioningPaint=this._transitionablePaint.transitioned(n,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(n,l){this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(n,void 0,l)),this.paint=this._transitioningPaint.possiblyEvaluate(n,void 0,l)}serialize(){return al({id:this.id,type:this.type,slot:this.slot,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()},(n,l)=>!(n===void 0||l==="layout"&&!Object.keys(n).length||l==="paint"&&!Object.keys(n).length))}is3D(){return!1}isSky(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}hasShadowPass(){return!1}canCastShadows(){return!1}hasLightBeamPass(){return!1}cutoffRange(){return 0}tileCoverLift(){return 0}resize(){}isStateDependent(){for(const n in this.paint._values){const l=this.paint.get(n);if(l instanceof Sl&&Bc(l.property.specification)&&(l.value.kind==="source"||l.value.kind==="composite")&&l.value.isStateDependent)return!0}return!1}compileFilter(n){this._filterCompiled||(this._featureFilter=u_(this.filter,this.scope,n),this._filterCompiled=!0)}invalidateCompiledFilter(){this._filterCompiled=!1}dynamicFilter(){return this._featureFilter.dynamicFilter}dynamicFilterNeedsFeature(){return this._featureFilter.needFeature}getLayerRenderingStats(){return this._stats}resetLayerRenderingStats(n){this._stats&&(n.renderPass==="shadow"?this._stats.numRenderedVerticesInShadowPass=0:this._stats.numRenderedVerticesInTransparentPass=0)}queryRadius(n){}queryIntersectsFeature(n,l,d,_,f,g,w,S,P){}}const Q0={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class Vc{constructor(n,l){this._structArray=n,this._pos1=l*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class ir{constructor(){this.isTransferred=!1,this.capacity=-1,this.resize(0)}static serialize(n,l){return n._trim(),l&&(n.isTransferred=!0,l.add(n.arrayBuffer)),{length:n.length,arrayBuffer:n.arrayBuffer}}static deserialize(n){const l=Object.create(this.prototype);return l.arrayBuffer=n.arrayBuffer,l.length=n.length,l.capacity=n.arrayBuffer.byteLength/l.bytesPerElement,l._refreshViews(),l}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(n){this.reserve(n),this.length=n}reserve(n){if(n>this.capacity){this.capacity=Math.max(n,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const l=this.uint8;this._refreshViews(),l&&this.uint8.set(l)}}_refreshViews(){throw new Error("StructArray#_refreshViews() must be implemented by each concrete StructArray layout")}emplace(...n){throw new Error("StructArray#emplace() must be implemented by each concrete StructArray layout")}emplaceBack(...n){throw new Error("StructArray#emplaceBack() must be implemented by each concrete StructArray layout")}destroy(){this.int8=this.uint8=this.int16=this.uint16=this.int32=this.uint32=this.float32=null,this.arrayBuffer=null}}function ji(u,n=1){let l=0,d=0;return{members:u.map(_=>{const f=Q0[_.type].BYTES_PER_ELEMENT,g=l=m_(l,Math.max(n,f)),w=_.components||1;return d=Math.max(d,f),l+=f*w,{name:_.name,type:_.type,components:w,offset:g}}),size:m_(l,Math.max(d,n)),alignment:n}}function m_(u,n){return Math.ceil(u/n)*n}class Do extends ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(n,l){const d=this.length;return this.resize(d+1),this.emplace(d,n,l)}emplace(n,l,d){const _=2*n;return this.int16[_+0]=l,this.int16[_+1]=d,n}}Do.prototype.bytesPerElement=4,Vt(Do,"StructArrayLayout2i4");class Rl extends ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(n,l,d){const _=this.length;return this.resize(_+1),this.emplace(_,n,l,d)}emplace(n,l,d,_){const f=3*n;return this.int16[f+0]=l,this.int16[f+1]=d,this.int16[f+2]=_,n}}Rl.prototype.bytesPerElement=6,Vt(Rl,"StructArrayLayout3i6");class Oo extends ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(n,l,d,_){const f=this.length;return this.resize(f+1),this.emplace(f,n,l,d,_)}emplace(n,l,d,_,f){const g=4*n;return this.int16[g+0]=l,this.int16[g+1]=d,this.int16[g+2]=_,this.int16[g+3]=f,n}}Oo.prototype.bytesPerElement=8,Vt(Oo,"StructArrayLayout4i8");class bh extends ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(n,l,d,_,f){const g=this.length;return this.resize(g+1),this.emplace(g,n,l,d,_,f)}emplace(n,l,d,_,f,g){const w=5*n;return this.int16[w+0]=l,this.int16[w+1]=d,this.int16[w+2]=_,this.int16[w+3]=f,this.int16[w+4]=g,n}}bh.prototype.bytesPerElement=10,Vt(bh,"StructArrayLayout5i10");class jc extends ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(n,l,d,_,f,g,w){const S=this.length;return this.resize(S+1),this.emplace(S,n,l,d,_,f,g,w)}emplace(n,l,d,_,f,g,w,S){const P=6*n,x=12*n,I=3*n;return this.int16[P+0]=l,this.int16[P+1]=d,this.uint8[x+4]=_,this.uint8[x+5]=f,this.uint8[x+6]=g,this.uint8[x+7]=w,this.float32[I+2]=S,n}}jc.prototype.bytesPerElement=12,Vt(jc,"StructArrayLayout2i4ub1f12");class io extends ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(n,l,d){const _=this.length;return this.resize(_+1),this.emplace(_,n,l,d)}emplace(n,l,d,_){const f=3*n;return this.float32[f+0]=l,this.float32[f+1]=d,this.float32[f+2]=_,n}}io.prototype.bytesPerElement=12,Vt(io,"StructArrayLayout3f12");class xn extends ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(n,l,d,_,f){const g=this.length;return this.resize(g+1),this.emplace(g,n,l,d,_,f)}emplace(n,l,d,_,f,g){const w=6*n,S=3*n;return this.uint16[w+0]=l,this.uint16[w+1]=d,this.uint16[w+2]=_,this.uint16[w+3]=f,this.float32[S+2]=g,n}}xn.prototype.bytesPerElement=12,Vt(xn,"StructArrayLayout4ui1f12");class wh extends ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(n,l,d,_){const f=this.length;return this.resize(f+1),this.emplace(f,n,l,d,_)}emplace(n,l,d,_,f){const g=4*n;return this.uint16[g+0]=l,this.uint16[g+1]=d,this.uint16[g+2]=_,this.uint16[g+3]=f,n}}wh.prototype.bytesPerElement=8,Vt(wh,"StructArrayLayout4ui8");class Hc extends ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(n,l,d,_,f,g){const w=this.length;return this.resize(w+1),this.emplace(w,n,l,d,_,f,g)}emplace(n,l,d,_,f,g,w){const S=6*n;return this.int16[S+0]=l,this.int16[S+1]=d,this.int16[S+2]=_,this.int16[S+3]=f,this.int16[S+4]=g,this.int16[S+5]=w,n}}Hc.prototype.bytesPerElement=12,Vt(Hc,"StructArrayLayout6i12");class Df extends ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(n,l,d,_,f,g,w,S,P,x,I,R){const E=this.length;return this.resize(E+1),this.emplace(E,n,l,d,_,f,g,w,S,P,x,I,R)}emplace(n,l,d,_,f,g,w,S,P,x,I,R,E){const C=12*n;return this.int16[C+0]=l,this.int16[C+1]=d,this.int16[C+2]=_,this.int16[C+3]=f,this.uint16[C+4]=g,this.uint16[C+5]=w,this.uint16[C+6]=S,this.uint16[C+7]=P,this.int16[C+8]=x,this.int16[C+9]=I,this.int16[C+10]=R,this.int16[C+11]=E,n}}Df.prototype.bytesPerElement=24,Vt(Df,"StructArrayLayout4i4ui4i24");class Of extends ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(n,l,d,_,f,g){const w=this.length;return this.resize(w+1),this.emplace(w,n,l,d,_,f,g)}emplace(n,l,d,_,f,g,w){const S=10*n,P=5*n;return this.int16[S+0]=l,this.int16[S+1]=d,this.int16[S+2]=_,this.float32[P+2]=f,this.float32[P+3]=g,this.float32[P+4]=w,n}}Of.prototype.bytesPerElement=20,Vt(Of,"StructArrayLayout3i3f20");class Ua extends ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(n,l,d,_){const f=this.length;return this.resize(f+1),this.emplace(f,n,l,d,_)}emplace(n,l,d,_,f){const g=4*n;return this.float32[g+0]=l,this.float32[g+1]=d,this.float32[g+2]=_,this.float32[g+3]=f,n}}Ua.prototype.bytesPerElement=16,Vt(Ua,"StructArrayLayout4f16");class Ff extends ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(n){const l=this.length;return this.resize(l+1),this.emplace(l,n)}emplace(n,l){return this.uint32[1*n+0]=l,n}}Ff.prototype.bytesPerElement=4,Vt(Ff,"StructArrayLayout1ul4");class aa extends ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(n,l){const d=this.length;return this.resize(d+1),this.emplace(d,n,l)}emplace(n,l,d){const _=2*n;return this.uint16[_+0]=l,this.uint16[_+1]=d,n}}aa.prototype.bytesPerElement=4,Vt(aa,"StructArrayLayout2ui4");class kf extends ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(n,l,d,_,f,g,w,S,P,x,I,R,E){const C=this.length;return this.resize(C+1),this.emplace(C,n,l,d,_,f,g,w,S,P,x,I,R,E)}emplace(n,l,d,_,f,g,w,S,P,x,I,R,E,C){const D=20*n,N=10*n;return this.int16[D+0]=l,this.int16[D+1]=d,this.int16[D+2]=_,this.int16[D+3]=f,this.int16[D+4]=g,this.float32[N+3]=w,this.float32[N+4]=S,this.float32[N+5]=P,this.float32[N+6]=x,this.int16[D+14]=I,this.uint32[N+8]=R,this.uint16[D+18]=E,this.uint16[D+19]=C,n}}kf.prototype.bytesPerElement=40,Vt(kf,"StructArrayLayout5i4f1i1ul2ui40");class Ah extends ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(n,l,d,_,f,g,w){const S=this.length;return this.resize(S+1),this.emplace(S,n,l,d,_,f,g,w)}emplace(n,l,d,_,f,g,w,S){const P=8*n;return this.int16[P+0]=l,this.int16[P+1]=d,this.int16[P+2]=_,this.int16[P+4]=f,this.int16[P+5]=g,this.int16[P+6]=w,this.int16[P+7]=S,n}}Ah.prototype.bytesPerElement=16,Vt(Ah,"StructArrayLayout3i2i2i16");class Lf extends ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(n,l,d,_,f){const g=this.length;return this.resize(g+1),this.emplace(g,n,l,d,_,f)}emplace(n,l,d,_,f,g){const w=4*n,S=8*n;return this.float32[w+0]=l,this.float32[w+1]=d,this.float32[w+2]=_,this.int16[S+6]=f,this.int16[S+7]=g,n}}Lf.prototype.bytesPerElement=16,Vt(Lf,"StructArrayLayout2f1f2i16");class Nf extends ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(n,l,d,_,f,g){const w=this.length;return this.resize(w+1),this.emplace(w,n,l,d,_,f,g)}emplace(n,l,d,_,f,g,w){const S=20*n,P=5*n;return this.uint8[S+0]=l,this.uint8[S+1]=d,this.float32[P+1]=_,this.float32[P+2]=f,this.float32[P+3]=g,this.float32[P+4]=w,n}}Nf.prototype.bytesPerElement=20,Vt(Nf,"StructArrayLayout2ub4f20");class on extends ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(n,l,d){const _=this.length;return this.resize(_+1),this.emplace(_,n,l,d)}emplace(n,l,d,_){const f=3*n;return this.uint16[f+0]=l,this.uint16[f+1]=d,this.uint16[f+2]=_,n}}on.prototype.bytesPerElement=6,Vt(on,"StructArrayLayout3ui6");class zf extends ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(n,l,d,_,f,g,w,S,P,x,I,R,E,C,D,N,z,G,W,H,q){const Y=this.length;return this.resize(Y+1),this.emplace(Y,n,l,d,_,f,g,w,S,P,x,I,R,E,C,D,N,z,G,W,H,q)}emplace(n,l,d,_,f,g,w,S,P,x,I,R,E,C,D,N,z,G,W,H,q,Y){const ie=30*n,he=15*n,ce=60*n;return this.int16[ie+0]=l,this.int16[ie+1]=d,this.int16[ie+2]=_,this.float32[he+2]=f,this.float32[he+3]=g,this.uint16[ie+8]=w,this.uint16[ie+9]=S,this.uint32[he+5]=P,this.uint32[he+6]=x,this.uint32[he+7]=I,this.uint16[ie+16]=R,this.uint16[ie+17]=E,this.uint16[ie+18]=C,this.float32[he+10]=D,this.float32[he+11]=N,this.uint8[ce+48]=z,this.uint8[ce+49]=G,this.uint8[ce+50]=W,this.uint32[he+13]=H,this.int16[ie+28]=q,this.uint8[ce+58]=Y,n}}zf.prototype.bytesPerElement=60,Vt(zf,"StructArrayLayout3i2f2ui3ul3ui2f3ub1ul1i1ub60");class Uf extends ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(n,l,d,_,f,g,w,S,P,x,I,R,E,C,D,N,z,G,W,H,q,Y,ie,he,ce,le,Te,de,Se,Pe,Me,Oe){const Ue=this.length;return this.resize(Ue+1),this.emplace(Ue,n,l,d,_,f,g,w,S,P,x,I,R,E,C,D,N,z,G,W,H,q,Y,ie,he,ce,le,Te,de,Se,Pe,Me,Oe)}emplace(n,l,d,_,f,g,w,S,P,x,I,R,E,C,D,N,z,G,W,H,q,Y,ie,he,ce,le,Te,de,Se,Pe,Me,Oe,Ue){const Ge=20*n,Ne=40*n,rt=80*n;return this.float32[Ge+0]=l,this.float32[Ge+1]=d,this.int16[Ne+4]=_,this.int16[Ne+5]=f,this.int16[Ne+6]=g,this.int16[Ne+7]=w,this.int16[Ne+8]=S,this.int16[Ne+9]=P,this.int16[Ne+10]=x,this.int16[Ne+11]=I,this.int16[Ne+12]=R,this.uint16[Ne+13]=E,this.uint16[Ne+14]=C,this.uint16[Ne+15]=D,this.uint16[Ne+16]=N,this.uint16[Ne+17]=z,this.uint16[Ne+18]=G,this.uint16[Ne+19]=W,this.uint16[Ne+20]=H,this.uint16[Ne+21]=q,this.uint16[Ne+22]=Y,this.uint16[Ne+23]=ie,this.uint16[Ne+24]=he,this.uint16[Ne+25]=ce,this.uint16[Ne+26]=le,this.uint16[Ne+27]=Te,this.uint32[Ge+14]=de,this.float32[Ge+15]=Se,this.float32[Ge+16]=Pe,this.float32[Ge+17]=Me,this.float32[Ge+18]=Oe,this.uint8[rt+76]=Ue,n}}Uf.prototype.bytesPerElement=80,Vt(Uf,"StructArrayLayout2f9i15ui1ul4f1ub80");class Gc extends ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(n){const l=this.length;return this.resize(l+1),this.emplace(l,n)}emplace(n,l){return this.float32[1*n+0]=l,n}}Gc.prototype.bytesPerElement=4,Vt(Gc,"StructArrayLayout1f4");class la extends ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(n,l,d,_,f){const g=this.length;return this.resize(g+1),this.emplace(g,n,l,d,_,f)}emplace(n,l,d,_,f,g){const w=5*n;return this.float32[w+0]=l,this.float32[w+1]=d,this.float32[w+2]=_,this.float32[w+3]=f,this.float32[w+4]=g,n}}la.prototype.bytesPerElement=20,Vt(la,"StructArrayLayout5f20");class Th extends ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(n,l,d,_,f,g,w){const S=this.length;return this.resize(S+1),this.emplace(S,n,l,d,_,f,g,w)}emplace(n,l,d,_,f,g,w,S){const P=7*n;return this.float32[P+0]=l,this.float32[P+1]=d,this.float32[P+2]=_,this.float32[P+3]=f,this.float32[P+4]=g,this.float32[P+5]=w,this.float32[P+6]=S,n}}Th.prototype.bytesPerElement=28,Vt(Th,"StructArrayLayout7f28");class ro extends ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(n,l,d,_,f,g,w,S,P,x,I){const R=this.length;return this.resize(R+1),this.emplace(R,n,l,d,_,f,g,w,S,P,x,I)}emplace(n,l,d,_,f,g,w,S,P,x,I,R){const E=11*n;return this.float32[E+0]=l,this.float32[E+1]=d,this.float32[E+2]=_,this.float32[E+3]=f,this.float32[E+4]=g,this.float32[E+5]=w,this.float32[E+6]=S,this.float32[E+7]=P,this.float32[E+8]=x,this.float32[E+9]=I,this.float32[E+10]=R,n}}ro.prototype.bytesPerElement=44,Vt(ro,"StructArrayLayout11f44");class Eh extends ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(n,l,d,_,f,g,w,S,P){const x=this.length;return this.resize(x+1),this.emplace(x,n,l,d,_,f,g,w,S,P)}emplace(n,l,d,_,f,g,w,S,P,x){const I=9*n;return this.float32[I+0]=l,this.float32[I+1]=d,this.float32[I+2]=_,this.float32[I+3]=f,this.float32[I+4]=g,this.float32[I+5]=w,this.float32[I+6]=S,this.float32[I+7]=P,this.float32[I+8]=x,n}}Eh.prototype.bytesPerElement=36,Vt(Eh,"StructArrayLayout9f36");class Pl extends ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(n,l){const d=this.length;return this.resize(d+1),this.emplace(d,n,l)}emplace(n,l,d){const _=2*n;return this.float32[_+0]=l,this.float32[_+1]=d,n}}Pl.prototype.bytesPerElement=8,Vt(Pl,"StructArrayLayout2f8");class Vf extends ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(n,l,d,_){const f=this.length;return this.resize(f+1),this.emplace(f,n,l,d,_)}emplace(n,l,d,_,f){const g=6*n;return this.uint32[3*n+0]=l,this.uint16[g+2]=d,this.uint16[g+3]=_,this.uint16[g+4]=f,n}}Vf.prototype.bytesPerElement=12,Vt(Vf,"StructArrayLayout1ul3ui12");class jf extends ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(n){const l=this.length;return this.resize(l+1),this.emplace(l,n)}emplace(n,l){return this.uint16[1*n+0]=l,n}}jf.prototype.bytesPerElement=2,Vt(jf,"StructArrayLayout1ui2");class $c extends ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(n,l,d,_,f,g,w,S,P,x,I,R,E,C,D,N){const z=this.length;return this.resize(z+1),this.emplace(z,n,l,d,_,f,g,w,S,P,x,I,R,E,C,D,N)}emplace(n,l,d,_,f,g,w,S,P,x,I,R,E,C,D,N,z){const G=16*n;return this.float32[G+0]=l,this.float32[G+1]=d,this.float32[G+2]=_,this.float32[G+3]=f,this.float32[G+4]=g,this.float32[G+5]=w,this.float32[G+6]=S,this.float32[G+7]=P,this.float32[G+8]=x,this.float32[G+9]=I,this.float32[G+10]=R,this.float32[G+11]=E,this.float32[G+12]=C,this.float32[G+13]=D,this.float32[G+14]=N,this.float32[G+15]=z,n}}$c.prototype.bytesPerElement=64,Vt($c,"StructArrayLayout16f64");class Wc extends ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(n,l,d,_,f,g,w){const S=this.length;return this.resize(S+1),this.emplace(S,n,l,d,_,f,g,w)}emplace(n,l,d,_,f,g,w,S){const P=10*n,x=5*n;return this.uint16[P+0]=l,this.uint16[P+1]=d,this.uint16[P+2]=_,this.uint16[P+3]=f,this.float32[x+2]=g,this.float32[x+3]=w,this.float32[x+4]=S,n}}Wc.prototype.bytesPerElement=20,Vt(Wc,"StructArrayLayout4ui3f20");class Hf extends ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(n){const l=this.length;return this.resize(l+1),this.emplace(l,n)}emplace(n,l){return this.int16[1*n+0]=l,n}}Hf.prototype.bytesPerElement=2,Vt(Hf,"StructArrayLayout1i2");class Sh extends ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer)}emplaceBack(n){const l=this.length;return this.resize(l+1),this.emplace(l,n)}emplace(n,l){return this.uint8[1*n+0]=l,n}}Sh.prototype.bytesPerElement=1,Vt(Sh,"StructArrayLayout1ub1");class __ extends Vc{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.int16[this._pos2+3]}get tileAnchorY(){return this._structArray.int16[this._pos2+4]}get x1(){return this._structArray.float32[this._pos4+3]}get y1(){return this._structArray.float32[this._pos4+4]}get x2(){return this._structArray.float32[this._pos4+5]}get y2(){return this._structArray.float32[this._pos4+6]}get padding(){return this._structArray.int16[this._pos2+14]}get featureIndex(){return this._structArray.uint32[this._pos4+8]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+18]}get bucketIndex(){return this._structArray.uint16[this._pos2+19]}}__.prototype.size=40;class Gf extends kf{get(n){return new __(this,n)}}Vt(Gf,"CollisionBoxArray");class qc extends Vc{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+8]}get numGlyphs(){return this._structArray.uint16[this._pos2+9]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+5]}get lineStartIndex(){return this._structArray.uint32[this._pos4+6]}get lineLength(){return this._structArray.uint32[this._pos4+7]}get segment(){return this._structArray.uint16[this._pos2+16]}get lowerSize(){return this._structArray.uint16[this._pos2+17]}get upperSize(){return this._structArray.uint16[this._pos2+18]}get lineOffsetX(){return this._structArray.float32[this._pos4+10]}get lineOffsetY(){return this._structArray.float32[this._pos4+11]}get writingMode(){return this._structArray.uint8[this._pos1+48]}get placedOrientation(){return this._structArray.uint8[this._pos1+49]}set placedOrientation(n){this._structArray.uint8[this._pos1+49]=n}get hidden(){return this._structArray.uint8[this._pos1+50]}set hidden(n){this._structArray.uint8[this._pos1+50]=n}get crossTileID(){return this._structArray.uint32[this._pos4+13]}set crossTileID(n){this._structArray.uint32[this._pos4+13]=n}get associatedIconIndex(){return this._structArray.int16[this._pos2+28]}get flipState(){return this._structArray.uint8[this._pos1+58]}set flipState(n){this._structArray.uint8[this._pos1+58]=n}}qc.prototype.size=60;class g_ extends zf{get(n){return new qc(this,n)}}Vt(g_,"PlacedSymbolArray");class y_ extends Vc{get tileAnchorX(){return this._structArray.float32[this._pos4+0]}get tileAnchorY(){return this._structArray.float32[this._pos4+1]}get projectedAnchorX(){return this._structArray.int16[this._pos2+4]}get projectedAnchorY(){return this._structArray.int16[this._pos2+5]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+6]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+7]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+8]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+9]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+10]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+11]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+12]}get key(){return this._structArray.uint16[this._pos2+13]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+14]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+15]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+16]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+17]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+18]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+19]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+20]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+21]}get featureIndex(){return this._structArray.uint16[this._pos2+22]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+23]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+24]}get numIconVertices(){return this._structArray.uint16[this._pos2+25]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+26]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+27]}get crossTileID(){return this._structArray.uint32[this._pos4+14]}set crossTileID(n){this._structArray.uint32[this._pos4+14]=n}get textOffset0(){return this._structArray.float32[this._pos4+15]}get textOffset1(){return this._structArray.float32[this._pos4+16]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+17]}get zOffset(){return this._structArray.float32[this._pos4+18]}set zOffset(n){this._structArray.float32[this._pos4+18]=n}get hasIconTextFit(){return this._structArray.uint8[this._pos1+76]}}y_.prototype.size=80;class v_ extends Uf{get(n){return new y_(this,n)}}Vt(v_,"SymbolInstanceArray");class x_ extends Gc{getoffsetX(n){return this.float32[1*n+0]}}Vt(x_,"GlyphOffsetArray");class b_ extends Do{getx(n){return this.int16[2*n+0]}gety(n){return this.int16[2*n+1]}}Vt(b_,"SymbolLineVertexArray");class Xc extends Vc{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}get layoutVertexArrayOffset(){return this._structArray.uint16[this._pos2+4]}}Xc.prototype.size=12;class Zc extends Vf{get(n){return new Xc(this,n)}}Vt(Zc,"FeatureIndexArray");class Qn extends aa{geta_centroid_pos0(n){return this.uint16[2*n+0]}geta_centroid_pos1(n){return this.uint16[2*n+1]}}Vt(Qn,"FillExtrusionCentroidArray");class Yc extends Vc{get a_join_normal_inside0(){return this._structArray.int16[this._pos2+0]}get a_join_normal_inside1(){return this._structArray.int16[this._pos2+1]}get a_join_normal_inside2(){return this._structArray.int16[this._pos2+2]}}Yc.prototype.size=6;class w_ extends Rl{get(n){return new Yc(this,n)}}Vt(w_,"FillExtrusionWallArray");const ev=ji([{name:"a_pos",components:2,type:"Int16"}],4),tv=ji([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]);class Ar{constructor(n=[]){this.segments=n}_prepareSegment(n,l,d,_){let f=this.segments[this.segments.length-1];return n>Ar.MAX_VERTEX_ARRAY_LENGTH&&mi(`Max vertices per segment is ${Ar.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${n}`),(!f||f.vertexLength+n>Ar.MAX_VERTEX_ARRAY_LENGTH||f.sortKey!==_)&&(f={vertexOffset:l,primitiveOffset:d,vertexLength:0,primitiveLength:0},_!==void 0&&(f.sortKey=_),this.segments.push(f)),f}prepareSegment(n,l,d,_){return this._prepareSegment(n,l.length,d.length,_)}get(){return this.segments}destroy(){for(const n of this.segments)for(const l in n.vaos)n.vaos[l].destroy()}static simpleSegment(n,l,d,_){return new Ar([{vertexOffset:n,primitiveOffset:l,vertexLength:d,primitiveLength:_,vaos:{},sortKey:0}])}}function Ih(u,n){return 256*(u=yi(Math.floor(u),0,255))+yi(Math.floor(n),0,255)}Ar.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,Vt(Ar,"SegmentVector");const iv=ji([{name:"a_pattern",components:4,type:"Uint16"},{name:"a_pixel_ratio",components:1,type:"Float32"}]),$f=ji([{name:"a_dash",components:4,type:"Uint16"}]);class Kc{constructor(){this.ids=[],this.uniqueIds=[],this.positions=[],this.indexed=!1}add(n,l,d,_){this.ids.push(A_(n)),this.positions.push(l,d,_)}eachPosition(n,l){const d=A_(n);let _=0,f=this.ids.length-1;for(;_<f;){const g=_+f>>1;this.ids[g]>=d?f=g:_=g+1}for(;this.ids[_]===d;)l(this.positions[3*_],this.positions[3*_+1],this.positions[3*_+2]),_++}static serialize(n,l){const d=new Float64Array(n.ids),_=new Uint32Array(n.positions);return Jc(d,_,0,d.length-1),l&&(l.add(d.buffer),l.add(_.buffer)),{ids:d,positions:_}}static deserialize(n){const l=new Kc;let d;l.ids=n.ids,l.positions=n.positions;for(const _ of l.ids)_!==d&&l.uniqueIds.push(_),d=_;return l.indexed=!0,l}}function A_(u){const n=+u;return!isNaN(n)&&Number.MIN_SAFE_INTEGER<=n&&n<=Number.MAX_SAFE_INTEGER?n:Bs(String(u))}function Jc(u,n,l,d){for(;l<d;){const _=u[l+d>>1];let f=l-1,g=d+1;for(;;){do f++;while(u[f]<_);do g--;while(u[g]>_);if(f>=g)break;Ch(u,f,g),Ch(n,3*f,3*g),Ch(n,3*f+1,3*g+1),Ch(n,3*f+2,3*g+2)}g-l<d-g?(Jc(u,n,l,g),l=g+1):(Jc(u,n,g+1,d),d=g)}}function Ch(u,n,l){const d=u[n];u[n]=u[l],u[l]=d}Vt(Kc,"FeaturePositionMap");class no{constructor(n){this.gl=n.gl,this.initialized=!1}fetchUniformLocation(n,l){return this.location||this.initialized||(this.location=this.gl.getUniformLocation(n,l),this.initialized=!0),!!this.location}set(n,l,d){throw new Error("Uniform#set() must be implemented by each concrete Uniform")}}class Qc extends no{constructor(n){super(n),this.current=0}set(n,l,d){this.fetchUniformLocation(n,l)&&this.current!==d&&(this.current=d,this.gl.uniform1i(this.location,d))}}class Sr extends no{constructor(n){super(n),this.current=0}set(n,l,d){this.fetchUniformLocation(n,l)&&this.current!==d&&(this.current=d,this.gl.uniform1f(this.location,d))}}class Ss extends no{constructor(n){super(n),this.current=[0,0]}set(n,l,d){this.fetchUniformLocation(n,l)&&(d[0]===this.current[0]&&d[1]===this.current[1]||(this.current=d,this.gl.uniform2f(this.location,d[0],d[1])))}}class Bl extends no{constructor(n){super(n),this.current=[0,0,0]}set(n,l,d){this.fetchUniformLocation(n,l)&&(d[0]===this.current[0]&&d[1]===this.current[1]&&d[2]===this.current[2]||(this.current=d,this.gl.uniform3f(this.location,d[0],d[1],d[2])))}}class eu extends no{constructor(n){super(n),this.current=[0,0,0,0]}set(n,l,d){this.fetchUniformLocation(n,l)&&(d[0]===this.current[0]&&d[1]===this.current[1]&&d[2]===this.current[2]&&d[3]===this.current[3]||(this.current=d,this.gl.uniform4f(this.location,d[0],d[1],d[2],d[3])))}}class T_ extends no{constructor(n){super(n),this.current=Vi.transparent.toRenderColor(null)}set(n,l,d){this.fetchUniformLocation(n,l)&&(d.r===this.current.r&&d.g===this.current.g&&d.b===this.current.b&&d.a===this.current.a||(this.current=d,this.gl.uniform4f(this.location,d.r,d.g,d.b,d.a)))}}const E_=new Float32Array(16);class tu extends no{constructor(n){super(n),this.current=E_}set(n,l,d){if(this.fetchUniformLocation(n,l)){if(d[12]!==this.current[12]||d[0]!==this.current[0])return this.current=d,void this.gl.uniformMatrix4fv(this.location,!1,d);for(let _=1;_<16;_++)if(d[_]!==this.current[_]){this.current=d,this.gl.uniformMatrix4fv(this.location,!1,d);break}}}}const Wf=new Float32Array(9),rv=new Float32Array(4);class qf extends no{constructor(n){super(n),this.current=rv}set(n,l,d){if(this.fetchUniformLocation(n,l)){for(let _=0;_<4;_++)if(d[_]!==this.current[_]){this.current=d,this.gl.uniformMatrix2fv(this.location,!1,d);break}}}}function Xf(u){return[Ih(255*u.r,255*u.g),Ih(255*u.b,255*u.a)]}class Va{constructor(n,l,d,_){this.value=n,this.uniformNames=l.map(f=>`u_${f}`),this.type=d,this.context=_}setUniform(n,l,d,_,f){const g=_.constantOr(this.value);l.set(n,f,g instanceof Vi?g.toRenderColor(this.ignoreLut?null:this.context.lut):g)}getBinding(n,l){return this.type==="color"?new T_(n):new Sr(n)}}class ja{constructor(n,l){this.uniformNames=l.map(d=>`u_${d}`),this.pattern=null,this.pixelRatio=1}setConstantPatternPositions(n){this.pixelRatio=n.pixelRatio||1,this.pattern=n.tl.concat(n.br)}setUniform(n,l,d,_,f){const g=f==="u_pattern"||f==="u_dash"?this.pattern:f==="u_pixel_ratio"?this.pixelRatio:null;g&&l.set(n,f,g)}getBinding(n,l){return l==="u_pattern"||l==="u_dash"?new eu(n):new Sr(n)}}class Fo{constructor(n,l,d,_){this.expression=n,this.type=d,this.maxValue=0,this.paintVertexAttributes=l.map(f=>({name:`a_${f}`,type:"Float32",components:d==="color"?2:1,offset:0})),this.paintVertexArray=new _}populatePaintArray(n,l,d,_,f,g,w){const S=this.paintVertexArray.length,P=this.expression.kind==="composite"||this.expression.kind==="source"?this.expression.evaluate(new tr(0,{brightness:g}),l,{},f,_,w):this.expression.kind==="constant"&&this.expression.value;!this.lutExpression||this.lutExpression.kind!=="composite"&&this.lutExpression.kind!=="source"||(this.ignoreLut=this.lutExpression.evaluate(new tr(0,{brightness:g}),l,{},f,_,w)==="none"),this.paintVertexArray.resize(n),this._setPaintValue(S,n,P,this.context)}updatePaintArray(n,l,d,_,f,g,w){const S=this.expression.kind==="composite"||this.expression.kind==="source"?this.expression.evaluate({zoom:0,brightness:w},d,_,void 0,f):this.expression.kind==="constant"&&this.expression.value;!this.lutExpression||this.lutExpression.kind!=="composite"&&this.lutExpression.kind!=="source"||(this.ignoreLut=this.lutExpression.evaluate({zoom:0,brightness:w},d,_,void 0,f)==="none"),this._setPaintValue(n,l,S,this.context)}_setPaintValue(n,l,d,_){if(this.type==="color"){const f=Xf(d.toRenderColor(this.ignoreLut?null:_.lut));for(let g=n;g<l;g++)this.paintVertexArray.emplace(g,f[0],f[1])}else{for(let f=n;f<l;f++)this.paintVertexArray.emplace(f,d);this.maxValue=Math.max(this.maxValue,Math.abs(d))}}upload(n){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=n.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.lutExpression&&this.lutExpression.kind!=="constant"&&(this.lutExpression.isStateDependent||!this.lutExpression.isLightConstant)||this.expression.kind!=="constant"&&(this.expression.isStateDependent||!this.expression.isLightConstant)))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class Fs{constructor(n,l,d,_,f,g){this.expression=n,this.uniformNames=l.map(w=>`u_${w}_t`),this.type=d,this.useIntegerZoom=_,this.context=f,this.maxValue=0,this.paintVertexAttributes=l.map(w=>({name:`a_${w}`,type:"Float32",components:d==="color"?4:2,offset:0})),this.paintVertexArray=new g}populatePaintArray(n,l,d,_,f,g,w){const S=this.expression.evaluate(new tr(this.context.zoom,{brightness:g}),l,{},f,_,w),P=this.expression.evaluate(new tr(this.context.zoom+1,{brightness:g}),l,{},f,_,w);!this.lutExpression||this.lutExpression.kind!=="composite"&&this.lutExpression.kind!=="source"||(this.ignoreLut=this.lutExpression.evaluate(new tr(this.context.zoom,{brightness:g}),l,{},f,_,w)==="none");const x=this.paintVertexArray.length;this.paintVertexArray.resize(n),this._setPaintValue(x,n,S,P,this.context)}updatePaintArray(n,l,d,_,f,g,w){const S=this.expression.evaluate({zoom:this.context.zoom,brightness:w},d,_,void 0,f),P=this.expression.evaluate({zoom:this.context.zoom+1,brightness:w},d,_,void 0,f);!this.lutExpression||this.lutExpression.kind!=="composite"&&this.lutExpression.kind!=="source"||(this.ignoreLut=this.lutExpression.evaluate({zoom:this.context.zoom,brightness:w},d,_,void 0,f)==="none"),this._setPaintValue(n,l,S,P,this.context)}_setPaintValue(n,l,d,_,f){if(this.type==="color"){const g=Xf(d.toRenderColor(this.ignoreLut?null:f.lut)),w=Xf(d.toRenderColor(this.ignoreLut?null:f.lut));for(let S=n;S<l;S++)this.paintVertexArray.emplace(S,g[0],g[1],w[0],w[1])}else{for(let g=n;g<l;g++)this.paintVertexArray.emplace(g,d,_);this.maxValue=Math.max(this.maxValue,Math.abs(d),Math.abs(_))}}upload(n){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=n.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(n,l,d,_,f){const g=this.useIntegerZoom?Math.floor(d.zoom):d.zoom,w=yi(this.expression.interpolationFactor(g,this.context.zoom,this.context.zoom+1),0,1);l.set(n,f,w)}getBinding(n,l){return new Sr(n)}}class ca{constructor(n,l,d,_,f){this.expression=n,this.layerId=f,this.paintVertexAttributes=(d==="array"?$f:iv).members;for(let g=0;g<l.length;++g);this.paintVertexArray=new _}populatePaintArray(n,l,d,_){const f=this.paintVertexArray.length;this.paintVertexArray.resize(n),this._setPaintValues(f,n,l.patterns&&l.patterns[this.layerId],d)}updatePaintArray(n,l,d,_,f,g,w){this._setPaintValues(n,l,d.patterns&&d.patterns[this.layerId],g)}_setPaintValues(n,l,d,_){if(!_||!d)return;const f=_[d];if(!f)return;const{tl:g,br:w,pixelRatio:S}=f;for(let P=n;P<l;P++)this.paintVertexArray.emplace(P,g[0],g[1],w[0],w[1],S)}upload(n){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer=n.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class Ha{constructor(n,l,d=()=>!0){this.binders={},this._buffers=[],this.context=l;const _=[];for(const f in n.paint._values){const g=n.paint.get(f),w=n.paint.get(`${f}-use-theme`);if(f.endsWith("-use-theme")||!d(f)||!(g instanceof Sl&&Bc(g.property.specification)))continue;const S=sv(f,n.type),P=g.value,x=g.property.specification.type,I=!!g.property.useIntegerZoom,R=f==="line-dasharray"||f.endsWith("pattern"),E=f==="line-dasharray"&&n.layout.get("line-cap").value.kind!=="constant"||w&&w.value.kind!=="constant";if(P.kind!=="constant"||E)if(P.kind==="source"||E||R){const C=S_(f,x,"source");this.binders[f]=R?new ca(P,S,x,C,n.id):new Fo(P,S,x,C),_.push(`/a_${f}`)}else{const C=S_(f,x,"composite");this.binders[f]=new Fs(P,S,x,I,l,C),_.push(`/z_${f}`)}else this.binders[f]=R?new ja(P.value,S):new Va(P.value,S,x,l),_.push(`/u_${f}`);w&&(this.binders[f].ignoreLut=w.constantOr("default")==="none",this.binders[f].lutExpression=w.value,this.binders[f].checkUseTheme=!0)}this.cacheKey=_.sort().join("")}getMaxValue(n){const l=this.binders[n];return l instanceof Fo||l instanceof Fs?l.maxValue:0}populatePaintArrays(n,l,d,_,f,g,w){for(const S in this.binders){const P=this.binders[S];P.context=this.context,P instanceof Fo||P instanceof Fs||P instanceof ca?P.populatePaintArray(n,l,d,_,f,g,w):P.lutExpression&&P instanceof Va&&P.lutExpression&&(P.lutExpression.kind==="composite"||P.lutExpression.kind==="source")&&(P.ignoreLut=P.lutExpression.evaluate(new tr(0,{brightness:g}),l,{},f,_,w)==="none")}}setConstantPatternPositions(n){for(const l in this.binders){const d=this.binders[l];d instanceof ja&&d.setConstantPatternPositions(n)}}updatePaintArrays(n,l,d,_,f,g,w,S,P){let x=!1;const I=Object.keys(n),R=I.length!==0&&!S,E=R?I:l.uniqueIds;this.context.lut=f.lut;for(const C in this.binders){const D=this.binders[C];if(D.context=this.context,(D instanceof Fo||D instanceof Fs||D instanceof ca)&&D.expression&&D.expression.kind&&D.expression.kind!=="constant"&&(D.expression.isStateDependent===!0||D.expression.isLightConstant===!1)){const N=f.paint.get(C);D.expression=N.value;for(const z of E){const G=n[z.toString()];l.eachPosition(z,(W,H,q)=>{const Y=_.feature(W);D.updatePaintArray(H,q,Y,G,g,w,P)})}if(!R)for(const z of d.uniqueIds){const G=n[z.toString()];d.eachPosition(z,(W,H,q)=>{const Y=_.feature(W);D.updatePaintArray(H,q,Y,G,g,w,P)})}x=!0}}return x}defines(){const n=[];for(const l in this.binders){const d=this.binders[l];(d instanceof Va||d instanceof ja)&&n.push(...d.uniformNames.map(_=>`#define HAS_UNIFORM_${_}`))}return n}getBinderAttributes(){const n=[];for(const l in this.binders){const d=this.binders[l];if(d instanceof Fo||d instanceof Fs||d instanceof ca)for(let _=0;_<d.paintVertexAttributes.length;_++)n.push(d.paintVertexAttributes[_].name)}return n}getBinderUniforms(){const n=[];for(const l in this.binders){const d=this.binders[l];if(d instanceof Va||d instanceof ja||d instanceof Fs)for(const _ of d.uniformNames)n.push(_)}return n}getPaintVertexBuffers(){return this._buffers}getUniforms(n){const l=[];for(const d in this.binders){const _=this.binders[d];if(_ instanceof Va||_ instanceof ja||_ instanceof Fs)for(const f of _.uniformNames)l.push({name:f,property:d,binding:_.getBinding(n,f)})}return l}setUniforms(n,l,d,_,f){for(const{name:g,property:w,binding:S}of d){if(this.binders[w].checkUseTheme&&this.binders[w]instanceof Va){const P=_.get(`${w}-use-theme`);P.isConstant()&&(this.binders[w].ignoreLut=P.constantOr("default")==="none")}this.binders[w].setUniform(n,S,f,_.get(w),g)}}updatePaintBuffers(){this._buffers=[];for(const n in this.binders){const l=this.binders[n];(l instanceof Fo||l instanceof Fs||l instanceof ca)&&l.paintVertexBuffer&&this._buffers.push(l.paintVertexBuffer)}}upload(n){for(const l in this.binders){const d=this.binders[l];(d instanceof Fo||d instanceof Fs||d instanceof ca)&&d.upload(n)}this.updatePaintBuffers()}destroy(){for(const n in this.binders){const l=this.binders[n];(l instanceof Fo||l instanceof Fs||l instanceof ca)&&l.destroy()}}}class ua{constructor(n,l,d=()=>!0){this.programConfigurations={};for(const _ of n)this.programConfigurations[_.id]=new Ha(_,l,d);this.needsUpload=!1,this._featureMap=new Kc,this._featureMapWithoutIds=new Kc,this._bufferOffset=0,this._idlessCounter=0}populatePaintArrays(n,l,d,_,f,g,w,S){for(const P in this.programConfigurations)this.programConfigurations[P].populatePaintArrays(n,l,_,f,g,w,S);l.id!==void 0?this._featureMap.add(l.id,d,this._bufferOffset,n):(this._featureMapWithoutIds.add(this._idlessCounter,d,this._bufferOffset,n),this._idlessCounter+=1),this._bufferOffset=n,this.needsUpload=!0}updatePaintArrays(n,l,d,_,f,g,w){for(const S of d)this.needsUpload=this.programConfigurations[S.id].updatePaintArrays(n,this._featureMap,this._featureMapWithoutIds,l,S,_,f,g,w||0)||this.needsUpload}get(n){return this.programConfigurations[n]}upload(n){if(this.needsUpload){for(const l in this.programConfigurations)this.programConfigurations[l].upload(n);this.needsUpload=!1}}destroy(){for(const n in this.programConfigurations)this.programConfigurations[n].destroy()}}const nv={"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-occlusion-opacity":["occlusion_opacity"],"icon-occlusion-opacity":["occlusion_opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-emissive-strength":["emissive_strength"],"icon-emissive-strength":["emissive_strength"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"symbol-z-offset":["z_offset"],"line-gap-width":["gapwidth"],"line-pattern":["pattern","pixel_ratio"],"fill-pattern":["pattern","pixel_ratio"],"fill-extrusion-pattern":["pattern","pixel_ratio"],"line-dasharray":["dash"]};function sv(u,n){return nv[u]||[u.replace(`${n}-`,"").replace(/-/g,"_")]}const ov={"line-pattern":{source:xn,composite:xn},"fill-pattern":{source:xn,composite:xn},"fill-extrusion-pattern":{source:xn,composite:xn},"line-dasharray":{source:wh,composite:wh}},Mh={color:{source:Pl,composite:Ua},number:{source:Gc,composite:Pl}};function S_(u,n,l){const d=ov[u];return d&&d[l]||Mh[n][l]}Vt(Va,"ConstantBinder"),Vt(ja,"PatternConstantBinder"),Vt(Fo,"SourceExpressionBinder"),Vt(ca,"PatternCompositeBinder"),Vt(Fs,"CompositeExpressionBinder"),Vt(Ha,"ProgramConfiguration",{omit:["_buffers"]}),Vt(ua,"ProgramConfigurationSet");const Bn=Rt/Math.PI/2,Dl=5,I_=6,C_=16383,Ol=64,Rh=[Ol,32,16],ps=-Bn,ms=Bn;function Fl(u,n,l,d=Bn){return l=Ti(l),[u*Math.sin(l)*d,-n*d,u*Math.cos(l)*d]}function Ga(u,n,l){return Fl(Math.cos(Ti(u)),Math.sin(Ti(u)),n,l)}const $a=63710088e-1,Zf=2*Math.PI*$a;class Li{constructor(n,l){if(isNaN(n)||isNaN(l))throw new Error(`Invalid LngLat object: (${n}, ${l})`);if(this.lng=+n,this.lat=+l,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new Li(us(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(n){const l=Math.PI/180,d=this.lat*l,_=n.lat*l,f=Math.sin(d)*Math.sin(_)+Math.cos(d)*Math.cos(_)*Math.cos((n.lng-this.lng)*l);return $a*Math.acos(Math.min(f,1))}toBounds(n=0){const l=360*n/40075017,d=l/Math.cos(Math.PI/180*this.lat);return new ha({lng:this.lng-d,lat:this.lat-l},{lng:this.lng+d,lat:this.lat+l})}toEcef(n){return Ga(this.lat,this.lng,Bn+n*Bn/$a)}static convert(n){if(n instanceof Li)return n;if(Array.isArray(n)&&(n.length===2||n.length===3))return new Li(Number(n[0]),Number(n[1]));if(!Array.isArray(n)&&typeof n=="object"&&n!==null)return new Li(Number("lng"in n?n.lng:n.lon),Number(n.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}class ha{constructor(n,l){if(n)if(l)this.setSouthWest(n).setNorthEast(l);else if(n.length===4){const d=n;this.setSouthWest([d[0],d[1]]).setNorthEast([d[2],d[3]])}else{const d=n;this.setSouthWest(d[0]).setNorthEast(d[1])}}setNorthEast(n){return this._ne=n instanceof Li?new Li(n.lng,n.lat):Li.convert(n),this}setSouthWest(n){return this._sw=n instanceof Li?new Li(n.lng,n.lat):Li.convert(n),this}extend(n){const l=this._sw,d=this._ne;let _,f;if(n instanceof Li)_=n,f=n;else{if(!(n instanceof ha))return Array.isArray(n)?n.length===4||n.every(Array.isArray)?this.extend(ha.convert(n)):this.extend(Li.convert(n)):typeof n=="object"&&n!==null&&n.hasOwnProperty("lat")&&(n.hasOwnProperty("lon")||n.hasOwnProperty("lng"))?this.extend(Li.convert(n)):this;if(_=n._sw,f=n._ne,!_||!f)return this}return l||d?(l.lng=Math.min(_.lng,l.lng),l.lat=Math.min(_.lat,l.lat),d.lng=Math.max(f.lng,d.lng),d.lat=Math.max(f.lat,d.lat)):(this._sw=new Li(_.lng,_.lat),this._ne=new Li(f.lng,f.lat)),this}getCenter(){return new Li((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new Li(this.getWest(),this.getNorth())}getSouthEast(){return new Li(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(n){const{lng:l,lat:d}=Li.convert(n);let _=this._sw.lng<=l&&l<=this._ne.lng;return this._sw.lng>this._ne.lng&&(_=this._sw.lng>=l&&l>=this._ne.lng),this._sw.lat<=d&&d<=this._ne.lat&&_}static convert(n){if(n)return n instanceof ha?n:new ha(n)}}const av=0,lv=25.5;function Ph(u){return Zf*Math.cos(u*Math.PI/180)}function so(u){return(180+u)/360}function ks(u){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+u*Math.PI/360)))/360}function Dn(u,n){return u/Ph(n)}function es(u){return 360*u-180}function an(u){return 360/Math.PI*Math.atan(Math.exp((180-360*u)*Math.PI/180))-90}function M_(u,n){return u*Ph(an(n))}const jn=85.051129;function Yf(u){return Math.cos(Ti(yi(u,-85.051129,jn)))}function kl(u,n){const l=yi(n,av,lv),d=Math.pow(2,l);return Yf(u)*Zf/(512*d)}function p(u){return 1/Math.cos(u*Math.PI/180)}function o(u,n=0){const l=Math.exp(Math.PI*(1-(u.y+n/Rt)/(1<<u.z)*2));return 80150034*l/(l*l+1)/Rt/(1<<u.z)}class c{constructor(n,l,d=0){this.x=+n,this.y=+l,this.z=+d}static fromLngLat(n,l=0){const d=Li.convert(n);return new c(so(d.lng),ks(d.lat),Dn(l,d.lat))}toLngLat(){return new Li(es(this.x),an(this.y))}toAltitude(){return M_(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/Zf*p(an(this.y))}}function m(u,n,l,d,_,f,g,w,S){const P=(n+d)/2,x=(l+_)/2,I=new At(P,x);w(I),function(R,E,C,D,N,z){const G=C-N,W=D-z;return Math.abs((D-E)*G-(C-R)*W)/Math.hypot(G,W)}(I.x,I.y,f.x,f.y,g.x,g.y)>=S?(m(u,n,l,P,x,f,I,w,S),m(u,P,x,d,_,I,g,w,S)):u.push(g)}function v(u,n,l){let d=u[0],_=d.x,f=d.y;n(d);const g=[d];for(let w=1;w<u.length;w++){const S=u[w],{x:P,y:x}=S;n(S),m(g,_,f,P,x,d,S,n,l),_=P,f=x,d=S}return g}function b(u,n,l,d){if(d(n,l)){const _=n.add(l)._mult(.5);b(u,n,_,d),b(u,_,l,d)}else u.push(l)}function A(u,n){let l=u[0];const d=[l];for(let _=1;_<u.length;_++){const f=u[_];b(d,l,f,n),l=f}return d}const M=Math.pow(2,14)-1,O=-M-1;function k(u,n){const l=Math.round(u.x*n),d=Math.round(u.y*n);return u.x=yi(l,O,M),u.y=yi(d,O,M),(l<u.x||l>u.x+1||d<u.y||d>u.y+1)&&mi("Geometry exceeds allowed extent, reduce your vector tile buffer size"),u}function L(u,n,l){const d=u.loadGeometry(),_=u.extent,f=Rt/_;if(n&&l&&l.projection.isReprojectedInTileSpace){const g=1<<n.z,{scale:w,x:S,y:P,projection:x}=l,I=R=>{const E=es((n.x+R.x/_)/g),C=an((n.y+R.y/_)/g),D=x.project(E,C);R.x=(D.x*w-S)*_,R.y=(D.y*w-P)*_};for(let R=0;R<d.length;R++)if(u.type!==1)d[R]=v(d[R],I,1);else{const E=[];for(const C of d[R])C.x<0||C.x>=_||C.y<0||C.y>=_||(I(C),E.push(C));d[R]=E}}for(const g of d)for(const w of g)k(w,f);return d}function U(u,n){return{type:u.type,id:u.id,properties:u.properties,geometry:n?L(u):[]}}function j(u,n,l,d,_){u.emplaceBack(2*n+(d+1)/2,2*l+(_+1)/2)}function $(u,n,l){u.emplaceBack(n.x,n.y,n.z,l[0]*16384,l[1]*16384,l[2]*16384)}class Q{constructor(n){this.zoom=n.zoom,this.overscaling=n.overscaling,this.layers=n.layers,this.layerIds=this.layers.map(l=>l.fqid),this.index=n.index,this.hasPattern=!1,this.projection=n.projection,this.layoutVertexArray=new Do,this.indexArray=new on,this.segments=new Ar,this.programConfigurations=new ua(n.layers,{zoom:n.zoom,lut:n.lut}),this.stateDependentLayerIds=this.layers.filter(l=>l.isStateDependent()).map(l=>l.id)}updateFootprints(n,l){}populate(n,l,d,_){const f=this.layers[0],g=[];let w=null;f.type==="circle"&&(w=f.layout.get("circle-sort-key"));for(const{feature:P,id:x,index:I,sourceLayerIndex:R}of n){const E=this.layers[0]._featureFilter.needGeometry,C=U(P,E);if(!this.layers[0]._featureFilter.filter(new tr(this.zoom),C,d))continue;const D=w?w.evaluate(C,{},d):void 0,N={id:x,properties:P.properties,type:P.type,sourceLayerIndex:R,index:I,geometry:E?C.geometry:L(P,d,_),patterns:{},sortKey:D};g.push(N)}w&&g.sort((P,x)=>P.sortKey-x.sortKey);let S=null;_.projection.name==="globe"&&(this.globeExtVertexArray=new Hc,S=_.projection);for(const P of g){const{geometry:x,index:I,sourceLayerIndex:R}=P,E=n[I].feature;this.addFeature(P,x,I,l.availableImages,d,S,l.brightness),l.featureIndex.insert(E,x,I,R,this.index)}}update(n,l,d,_,f,g,w){this.programConfigurations.updatePaintArrays(n,l,f,d,_,g,w)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(n){this.uploaded||(this.layoutVertexBuffer=n.createVertexBuffer(this.layoutVertexArray,ev.members),this.indexBuffer=n.createIndexBuffer(this.indexArray),this.globeExtVertexArray&&(this.globeExtVertexBuffer=n.createVertexBuffer(this.globeExtVertexArray,tv.members))),this.programConfigurations.upload(n),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy())}addFeature(n,l,d,_,f,g,w){for(const S of l)for(const P of S){const x=P.x,I=P.y;if(x<0||x>=Rt||I<0||I>=Rt)continue;if(g){const C=g.projectTilePoint(x,I,f),D=g.upVector(f,x,I),N=this.globeExtVertexArray;$(N,C,D),$(N,C,D),$(N,C,D),$(N,C,D)}const R=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,n.sortKey),E=R.vertexLength;j(this.layoutVertexArray,x,I,-1,-1),j(this.layoutVertexArray,x,I,1,-1),j(this.layoutVertexArray,x,I,1,1),j(this.layoutVertexArray,x,I,-1,1),this.indexArray.emplaceBack(E,E+1,E+2),this.indexArray.emplaceBack(E,E+2,E+3),R.vertexLength+=4,R.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,n,d,{},_,f,w)}}function Z(u,n){for(let l=0;l<u.length;l++)if(ye(n,u[l]))return!0;for(let l=0;l<n.length;l++)if(ye(u,n[l]))return!0;return!!me(u,n)}function te(u,n,l){return!!ye(u,n)||!!Ae(n,u,l)}function ee(u,n){if(u.length===1)return be(n,u[0]);for(let l=0;l<n.length;l++){const d=n[l];for(let _=0;_<d.length;_++)if(ye(u,d[_]))return!0}for(let l=0;l<u.length;l++)if(be(n,u[l]))return!0;for(let l=0;l<n.length;l++)if(me(u,n[l]))return!0;return!1}function ae(u,n,l){if(u.length>1){if(me(u,n))return!0;for(let d=0;d<n.length;d++)if(Ae(n[d],u,l))return!0}for(let d=0;d<u.length;d++)if(Ae(u[d],n,l))return!0;return!1}function me(u,n){if(u.length===0||n.length===0)return!1;for(let l=0;l<u.length-1;l++){const d=u[l],_=u[l+1];for(let f=0;f<n.length-1;f++)if(fe(d,_,n[f],n[f+1]))return!0}return!1}function fe(u,n,l,d){return qs(u,l,d)!==qs(n,l,d)&&qs(u,n,l)!==qs(u,n,d)}function Ae(u,n,l){const d=l*l;if(n.length===1)return u.distSqr(n[0])<d;for(let _=1;_<n.length;_++)if(ve(u,n[_-1],n[_])<d)return!0;return!1}function ve(u,n,l){const d=n.distSqr(l);if(d===0)return u.distSqr(n);const _=((u.x-n.x)*(l.x-n.x)+(u.y-n.y)*(l.y-n.y))/d;return u.distSqr(_<0?n:_>1?l:l.sub(n)._mult(_)._add(n))}function be(u,n){let l,d,_,f=!1;for(let g=0;g<u.length;g++){l=u[g];for(let w=0,S=l.length-1;w<l.length;S=w++)d=l[w],_=l[S],d.y>n.y!=_.y>n.y&&n.x<(_.x-d.x)*(n.y-d.y)/(_.y-d.y)+d.x&&(f=!f)}return f}function ye(u,n){let l=!1;for(let d=0,_=u.length-1;d<u.length;_=d++){const f=u[d],g=u[_];f.y>n.y!=g.y>n.y&&n.x<(g.x-f.x)*(n.y-f.y)/(g.y-f.y)+f.x&&(l=!l)}return l}function Ie(u,n,l,d,_){for(const g of u)if(n<=g.x&&l<=g.y&&d>=g.x&&_>=g.y)return!0;const f=[new At(n,l),new At(n,_),new At(d,_),new At(d,l)];if(u.length>2){for(const g of f)if(ye(u,g))return!0}for(let g=0;g<u.length-1;g++)if(Fe(u[g],u[g+1],f))return!0;return!1}function Fe(u,n,l){const d=l[0],_=l[2];if(u.x<d.x&&n.x<d.x||u.x>_.x&&n.x>_.x||u.y<d.y&&n.y<d.y||u.y>_.y&&n.y>_.y)return!1;const f=qs(u,n,l[0]);return f!==qs(u,n,l[1])||f!==qs(u,n,l[2])||f!==qs(u,n,l[3])}function Qe(u,n,l,d,_,f){let g=n.y-u.y,w=u.x-n.x;if(f=f||0){const S=g*g+w*w;if(S===0)return!0;const P=Math.sqrt(S);g/=P,w/=P}return!((l.x-u.x)*g+(l.y-u.y)*w-f<0||(d.x-u.x)*g+(d.y-u.y)*w-f<0||(_.x-u.x)*g+(_.y-u.y)*w-f<0)}function We(u,n,l,d,_,f,g){return!(Qe(u,n,d,_,f,g)||Qe(n,l,d,_,f,g)||Qe(l,u,d,_,f,g)||Qe(d,_,u,n,l,g)||Qe(_,f,u,n,l,g)||Qe(f,d,u,n,l,g))}function at(u,n,l){const d=n.paint.get(u).value;return d.kind==="constant"?d.value:l.programConfigurations.get(n.id).getMaxValue(u)}function nt(u){return Math.sqrt(u[0]*u[0]+u[1]*u[1])}function je(u,n,l,d,_){if(!n[0]&&!n[1])return u;const f=At.convert(n)._mult(_);l==="viewport"&&f._rotate(-d);const g=[];for(let w=0;w<u.length;w++)g.push(u[w].sub(f));return g}function et(u,n,l,d){const _=At.convert(u)._mult(d);return n==="viewport"&&_._rotate(-l),_}let gt,Ve;Vt(Q,"CircleBucket",{omit:["layers"]});var ut,tt={exports:{}},Et=(ut||(ut=1,function(u,n){(function(l){function d(f,g,w){var S=_(256*f,256*(g=Math.pow(2,w)-g-1),w),P=_(256*(f+1),256*(g+1),w);return S[0]+","+S[1]+","+P[0]+","+P[1]}function _(f,g,w){var S=2*Math.PI*6378137/256/Math.pow(2,w);return[f*S-2*Math.PI*6378137/2,g*S-2*Math.PI*6378137/2]}l.getURL=function(f,g,w,S,P,x){return x=x||{},f+"?"+["bbox="+d(w,S,P),"format="+(x.format||"image/png"),"service="+(x.service||"WMS"),"version="+(x.version||"1.1.1"),"request="+(x.request||"GetMap"),"srs="+(x.srs||"EPSG:3857"),"width="+(x.width||256),"height="+(x.height||256),"layers="+g].join("&")},l.getTileBBox=d,l.getMercCoords=_,Object.defineProperty(l,"__esModule",{value:!0})})(n)}(0,tt.exports)),tt.exports);class ft{constructor(n,l,d){this.z=n,this.x=l,this.y=d,this.key=Tt(0,n,n,l,d)}equals(n){return this.z===n.z&&this.x===n.x&&this.y===n.y}url(n,l){const d=Et.getTileBBox(this.x,this.y,this.z),_=function(f,g,w){let S,P="";for(let x=f;x>0;x--)S=1<<x-1,P+=(g&S?1:0)+(w&S?2:0);return P}(this.z,this.x,this.y);return n[(this.x+this.y)%n.length].replace("{prefix}",(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String(l==="tms"?Math.pow(2,this.z)-this.y-1:this.y)).replace("{quadkey}",_).replace("{bbox-epsg-3857}",d)}toString(){return`${this.z}/${this.x}/${this.y}`}}class ct{constructor(n,l){this.wrap=n,this.canonical=l,this.key=Tt(n,l.z,l.z,l.x,l.y)}}class xt{constructor(n,l,d,_,f){this.overscaledZ=n,this.wrap=l,this.canonical=new ft(d,+_,+f),this.key=l===0&&n===d?this.canonical.key:Tt(l,n,d,_,f)}equals(n){return this.overscaledZ===n.overscaledZ&&this.wrap===n.wrap&&this.canonical.equals(n.canonical)}scaledTo(n){const l=this.canonical.z-n;return n>this.canonical.z?new xt(n,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new xt(n,this.wrap,n,this.canonical.x>>l,this.canonical.y>>l)}calculateScaledKey(n,l=!0){if(this.overscaledZ===n&&l)return this.key;if(n>this.canonical.z)return Tt(this.wrap*+l,n,this.canonical.z,this.canonical.x,this.canonical.y);{const d=this.canonical.z-n;return Tt(this.wrap*+l,n,n,this.canonical.x>>d,this.canonical.y>>d)}}isChildOf(n){if(n.wrap!==this.wrap)return!1;const l=this.canonical.z-n.canonical.z;return n.overscaledZ===0||n.overscaledZ<this.overscaledZ&&n.canonical.z<this.canonical.z&&n.canonical.x===this.canonical.x>>l&&n.canonical.y===this.canonical.y>>l}children(n){if(this.overscaledZ>=n)return[new xt(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const l=this.canonical.z+1,d=2*this.canonical.x,_=2*this.canonical.y;return[new xt(l,this.wrap,l,d,_),new xt(l,this.wrap,l,d+1,_),new xt(l,this.wrap,l,d,_+1),new xt(l,this.wrap,l,d+1,_+1)]}isLessThan(n){return this.wrap<n.wrap||!(this.wrap>n.wrap)&&(this.overscaledZ<n.overscaledZ||!(this.overscaledZ>n.overscaledZ)&&(this.canonical.x<n.canonical.x||!(this.canonical.x>n.canonical.x)&&this.canonical.y<n.canonical.y))}wrapped(){return new xt(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(n){return new xt(this.overscaledZ,n,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new ct(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}}function Tt(u,n,l,d,_){const f=1<<Math.min(l,22);let g=f*(_%f)+d%f;return u&&l<22&&(g+=f*f*((u<0?-2*u-1:2*u)%(1<<2*(22-l)))),16*(32*g+l)+(n-l)}const Lt=[u=>{let n=u.canonical.x-1,l=u.wrap;return n<0&&(n=(1<<u.canonical.z)-1,l--),new xt(u.overscaledZ,l,u.canonical.z,n,u.canonical.y)},u=>{let n=u.canonical.x+1,l=u.wrap;return n===1<<u.canonical.z&&(n=0,l++),new xt(u.overscaledZ,l,u.canonical.z,n,u.canonical.y)},u=>new xt(u.overscaledZ,u.wrap,u.canonical.z,u.canonical.x,(u.canonical.y===0?1<<u.canonical.z:u.canonical.y)-1),u=>new xt(u.overscaledZ,u.wrap,u.canonical.z,u.canonical.x,u.canonical.y===(1<<u.canonical.z)-1?0:u.canonical.y+1)];Vt(ft,"CanonicalTileID"),Vt(xt,"OverscaledTileID",{omit:["projMatrix","expandedProjMatrix"]});const Ut=ji([{type:"Float32",name:"a_globe_pos",components:3},{type:"Float32",name:"a_uv",components:2}]),{members:ni}=Ut,Xt=ji([{name:"a_pos_3",components:3,type:"Int16"}]);var Kt=ji([{name:"a_pos",type:"Int16",components:2}]);class ci{constructor(n,l){this.pos=n,this.dir=l}intersectsPlane(n,l,d){const _=Re.vec3.dot(l,this.dir);if(Math.abs(_)<1e-6)return!1;const f=((n[0]-this.pos[0])*l[0]+(n[1]-this.pos[1])*l[1]+(n[2]-this.pos[2])*l[2])/_;return d[0]=this.pos[0]+this.dir[0]*f,d[1]=this.pos[1]+this.dir[1]*f,d[2]=this.pos[2]+this.dir[2]*f,!0}closestPointOnSphere(n,l,d){if(Re.vec3.equals(this.pos,n)||l===0)return d[0]=d[1]=d[2]=0,!1;const[_,f,g]=this.dir,w=this.pos[0]-n[0],S=this.pos[1]-n[1],P=this.pos[2]-n[2],x=_*_+f*f+g*g,I=2*(w*_+S*f+P*g),R=I*I-4*x*(w*w+S*S+P*P-l*l);if(R<0){const E=Math.max(-I/2,0),C=w+_*E,D=S+f*E,N=P+g*E,z=Math.hypot(C,D,N);return d[0]=C*l/z,d[1]=D*l/z,d[2]=N*l/z,!1}{const E=(-I-Math.sqrt(R))/(2*x);if(E<0){const C=Math.hypot(w,S,P);return d[0]=w*l/C,d[1]=S*l/C,d[2]=P*l/C,!1}return d[0]=w+_*E,d[1]=S+f*E,d[2]=P+g*E,!0}}}class Ci{constructor(n,l,d,_,f){this.TL=n,this.TR=l,this.BR=d,this.BL=_,this.horizon=f}static fromInvProjectionMatrix(n,l,d){const _=[-1,1,1],f=[1,1,1],g=[1,-1,1],w=[-1,-1,1],S=Re.vec3.transformMat4(_,_,n),P=Re.vec3.transformMat4(f,f,n),x=Re.vec3.transformMat4(g,g,n),I=Re.vec3.transformMat4(w,w,n);return new Ci(S,P,x,I,l/d)}}function Xi(u,n,l){let d=1/0,_=-1/0;const f=[];for(const g of u){Re.vec3.sub(f,g,n);const w=Re.vec3.dot(f,l);d=Math.min(d,w),_=Math.max(_,w)}return[d,_]}function pr(u,n){let l=!0;for(let d=0;d<u.planes.length;d++){const _=u.planes[d];let f=0;for(let g=0;g<n.length;g++)f+=Re.vec3.dot(_,n[g])+_[3]>=0;if(f===0)return 0;f!==n.length&&(l=!1)}return l?2:1}function rr(u,n){for(const l of u.projections){const d=Xi(n,u.points[0],l.axis);if(l.projection[1]<d[0]||l.projection[0]>d[1])return 0}return 1}function di(u,n){let l=0;const d=[0,0,0,0];for(let _=0;_<u.length;_++)d[0]=u[_][0],d[1]=u[_][1],d[2]=u[_][2],d[3]=1,Re.vec4.dot(d,n)>=0&&l++;return l}class Fi{constructor(n,l){this.points=n||new Array(8).fill([0,0,0]),this.planes=l||new Array(6).fill([0,0,0,0]),this.bounds=Wt.fromPoints(this.points),this.projections=[],this.frustumEdges=[Re.vec3.sub([],this.points[2],this.points[3]),Re.vec3.sub([],this.points[0],this.points[3]),Re.vec3.sub([],this.points[4],this.points[0]),Re.vec3.sub([],this.points[5],this.points[1]),Re.vec3.sub([],this.points[6],this.points[2]),Re.vec3.sub([],this.points[7],this.points[3])];for(const d of this.frustumEdges){const _=[0,-d[2],d[1]],f=[d[2],0,-d[0]];this.projections.push({axis:_,projection:Xi(this.points,this.points[0],_)}),this.projections.push({axis:f,projection:Xi(this.points,this.points[0],f)})}}static fromInvProjectionMatrix(n,l,d,_){const f=Math.pow(2,d),g=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map(P=>{const x=Re.vec4.transformMat4([],P,n),I=1/x[3]/l*f;return Re.vec4.mul(x,x,[I,I,_?1/x[3]:I,I])}),w=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map(P=>{const x=Re.vec3.sub([],g[P[0]],g[P[1]]),I=Re.vec3.sub([],g[P[2]],g[P[1]]),R=Re.vec3.normalize([],Re.vec3.cross([],x,I)),E=-Re.vec3.dot(R,g[P[1]]);return R.concat(E)}),S=[];for(let P=0;P<g.length;P++)S.push([g[P][0],g[P][1],g[P][2]]);return new Fi(S,w)}intersectsPrecise(n,l,d){for(let _=0;_<l.length;_++)if(!di(n,l[_]))return 0;for(let _=0;_<this.planes.length;_++)if(!di(n,this.planes[_]))return 0;for(const _ of d)for(const f of this.frustumEdges){const g=Re.vec3.cross([],_,f),w=Re.vec3.length(g);if(w===0)continue;Re.vec3.scale(g,g,1/w);const S=Xi(this.points,this.points[0],g),P=Xi(n,this.points[0],g);if(S[0]>P[1]||P[0]>S[1])return 0}return 1}containsPoint(n){for(const l of this.planes){const d=l[3];if(Re.vec3.dot([l[0],l[1],l[2]],n)+d<0)return!1}return!0}}class Wt{static fromPoints(n){const l=[1/0,1/0,1/0],d=[-1/0,-1/0,-1/0];for(const _ of n)Re.vec3.min(l,l,_),Re.vec3.max(d,d,_);return new Wt(l,d)}static fromTileIdAndHeight(n,l,d){const _=1<<n.canonical.z,f=n.canonical.x,g=n.canonical.y;return new Wt([f/_,g/_,l],[(f+1)/_,(g+1)/_,d])}static applyTransform(n,l){const d=n.getCorners();for(let _=0;_<d.length;++_)Re.vec3.transformMat4(d[_],d[_],l);return Wt.fromPoints(d)}static applyTransformFast(n,l){const d=[l[12],l[13],l[14]],_=[...d];for(let f=0;f<3;f++)for(let g=0;g<3;g++){const w=l[4*g+f],S=w*n.min[g],P=w*n.max[g];d[f]+=Math.min(S,P),_[f]+=Math.max(S,P)}return new Wt(d,_)}static projectAabbCorners(n,l){const d=n.getCorners();for(let _=0;_<d.length;++_)Re.vec3.transformMat4(d[_],d[_],l);return d}constructor(n,l){this.min=n,this.max=l,this.center=Re.vec3.scale([],Re.vec3.add([],this.min,this.max),.5)}quadrant(n){const l=[n%2==0,n<2],d=Re.vec3.clone(this.min),_=Re.vec3.clone(this.max);for(let f=0;f<l.length;f++)d[f]=l[f]?this.min[f]:this.center[f],_[f]=l[f]?this.center[f]:this.max[f];return _[2]=this.max[2],new Wt(d,_)}distanceX(n){return Math.max(Math.min(this.max[0],n[0]),this.min[0])-n[0]}distanceY(n){return Math.max(Math.min(this.max[1],n[1]),this.min[1])-n[1]}distanceZ(n){return Math.max(Math.min(this.max[2],n[2]),this.min[2])-n[2]}getCorners(){const n=this.min,l=this.max;return[[n[0],n[1],n[2]],[l[0],n[1],n[2]],[l[0],l[1],n[2]],[n[0],l[1],n[2]],[n[0],n[1],l[2]],[l[0],n[1],l[2]],[l[0],l[1],l[2]],[n[0],l[1],l[2]]]}intersects(n){return this.intersectsAabb(n.bounds)?pr(n,this.getCorners()):0}intersectsFlat(n){return this.intersectsAabb(n.bounds)?pr(n,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsPrecise(n,l){return l||this.intersects(n)?rr(n,this.getCorners()):0}intersectsPreciseFlat(n,l){return l||this.intersectsFlat(n)?rr(n,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsAabb(n){for(let l=0;l<3;++l)if(this.min[l]>n.max[l]||n.min[l]>this.max[l])return!1;return!0}intersectsAabbXY(n){return!(this.min[0]>n.max[0]||n.min[0]>this.max[0]||this.min[1]>n.max[1]||n.min[1]>this.max[1])}encapsulate(n){for(let l=0;l<3;l++)this.min[l]=Math.min(this.min[l],n.min[l]),this.max[l]=Math.max(this.max[l],n.max[l])}encapsulatePoint(n){for(let l=0;l<3;l++)this.min[l]=Math.min(this.min[l],n[l]),this.max[l]=Math.max(this.max[l],n[l])}closestPoint(n){return[Math.max(Math.min(this.max[0],n[0]),this.min[0]),Math.max(Math.min(this.max[1],n[1]),this.min[1]),Math.max(Math.min(this.max[2],n[2]),this.min[2])]}}function Ei(u){return u*Bn/$a}Vt(Wt,"Aabb");const Ui=[new Wt([ps,ps,ps],[ms,ms,ms]),new Wt([ps,ps,ps],[0,0,ms]),new Wt([0,ps,ps],[ms,0,ms]),new Wt([ps,0,ps],[0,ms,ms]),new Wt([0,0,ps],[ms,ms,ms])];function Hi(u,n,l,d=!0){const _=Re.vec3.scale([],u._camera.position,u.worldSize),f=[n,l,1,1];Re.vec4.transformMat4(f,f,u.pixelMatrixInverse),Re.vec4.scale(f,f,1/f[3]);const g=Re.vec3.sub([],f,_),w=Re.vec3.normalize([],g),S=u.globeMatrix,P=[S[12],S[13],S[14]],x=Re.vec3.sub([],P,_),I=Re.vec3.length(x),R=Re.vec3.normalize([],x),E=u.worldSize/(2*Math.PI),C=Re.vec3.dot(R,w),D=Math.asin(E/I);if(D<Math.acos(C)){if(!d)return null;const Te=[],de=[];Re.vec3.scale(Te,w,I/C),Re.vec3.normalize(de,Re.vec3.sub(de,Te,x)),Re.vec3.normalize(w,Re.vec3.add(w,x,Re.vec3.scale(w,de,Math.tan(D)*I)))}const N=[];new ci(_,w).closestPointOnSphere(P,E,N);const z=Re.vec3.normalize([],ul(S,0)),G=Re.vec3.normalize([],ul(S,1)),W=Re.vec3.normalize([],ul(S,2)),H=Re.vec3.dot(z,N),q=Re.vec3.dot(G,N),Y=Re.vec3.dot(W,N),ie=kr(Math.asin(-q/E));let he=kr(Math.atan2(H,Y));he=u.center.lng+function(Te,de){const Se=(de-Te+180)%360-180;return Se<-180?Se+360:Se}(u.center.lng,he);const ce=so(he),le=yi(ks(ie),0,1);return new c(ce,le)}class ur{constructor(n,l,d){this.a=Re.vec3.sub([],n,d),this.b=Re.vec3.sub([],l,d),this.center=d;const _=Re.vec3.normalize([],this.a),f=Re.vec3.normalize([],this.b);this.angle=Math.acos(Re.vec3.dot(_,f))}}function Xr(u,n){if(u.angle===0)return null;let l;return l=u.a[n]===0?1/u.angle*.5*Math.PI:1/u.angle*Math.atan(u.b[n]/u.a[n]/Math.sin(u.angle)-1/Math.tan(u.angle)),l<0||l>1?null:function(d,_,f,g){const w=Math.sin(f);return d*(Math.sin((1-g)*f)/w)+_*(Math.sin(g*f)/w)}(u.a[n],u.b[n],u.angle,yi(l,0,1))+u.center[n]}function Lr(u){if(u.z<=1)return Ui[u.z+2*u.y+u.x];const n=Qi(hr(u));return Wt.fromPoints(n)}function Nr(u,n,l){return Re.vec3.scale(u,u,1-l),Re.vec3.scaleAndAdd(u,u,n,l)}function _s(u,n,l){for(const d of u)Re.vec3.transformMat4(d,d,n),Re.vec3.scale(d,d,l)}function bn(u,n,l,d){const _=n/u.worldSize,f=u.globeMatrix;if(l.z<=1){const ce=Lr(l).getCorners();return _s(ce,f,_),Wt.fromPoints(ce)}const g=hr(l,d),w=Qi(g,Bn+Ei(u._tileCoverLift));_s(w,f,_);const S=Number.MAX_VALUE,P=[-S,-S,-S],x=[S,S,S];if(g.contains(u.center)){for(const Te of w)Re.vec3.min(x,x,Te),Re.vec3.max(P,P,Te);P[2]=0;const ce=u.point,le=[ce.x*_,ce.y*_,0];return Re.vec3.min(x,x,le),Re.vec3.max(P,P,le),new Wt(x,P)}if(u._tileCoverLift>0){for(const ce of w)Re.vec3.min(x,x,ce),Re.vec3.max(P,P,ce);return new Wt(x,P)}const I=[f[12]*_,f[13]*_,f[14]*_],R=g.getCenter(),E=yi(u.center.lat,-85.051129,jn),C=yi(R.lat,-85.051129,jn),D=so(u.center.lng),N=ks(E);let z=D-so(R.lng);const G=N-ks(C);z>.5?z-=1:z<-.5&&(z+=1);let W=0;if(Math.abs(z)>Math.abs(G))W=z>=0?1:3;else{W=G>=0?0:2;const ce=[f[4]*_,f[5]*_,f[6]*_],le=-Math.sin(Ti(G>=0?g.getSouth():g.getNorth()))*Bn;Re.vec3.scaleAndAdd(I,I,ce,le)}const H=w[W],q=w[(W+1)%4],Y=new ur(H,q,I),ie=[Xr(Y,0)||H[0],Xr(Y,1)||H[1],Xr(Y,2)||H[2]],he=Hn(u.zoom);if(he>0){const ce=function({x:Te,y:de,z:Se},Pe,Me,Oe,Ue){const Ge=1/(1<<Se);let Ne=Te*Ge,rt=Ne+Ge,mt=de*Ge,it=mt+Ge,Bt=0;const Mt=(Ne+rt)/2-Oe;return Mt>.5?Bt=-1:Mt<-.5&&(Bt=1),Ne=((Ne+Bt)*Pe-(Oe*=Pe))*Me+Oe,rt=((rt+Bt)*Pe-Oe)*Me+Oe,mt=(mt*Pe-(Ue*=Pe))*Me+Ue,it=(it*Pe-Ue)*Me+Ue,[[Ne,it,0],[rt,it,0],[rt,mt,0],[Ne,mt,0]]}(l,n,u._pixelsPerMercatorPixel,D,N);for(let Te=0;Te<w.length;Te++)Nr(w[Te],ce[Te],he);const le=Re.vec3.add([],ce[W],ce[(W+1)%4]);Re.vec3.scale(le,le,.5),Nr(ie,le,he)}for(const ce of w)Re.vec3.min(x,x,ce),Re.vec3.max(P,P,ce);return x[2]=Math.min(H[2],q[2]),Re.vec3.min(x,x,ie),Re.vec3.max(P,P,ie),new Wt(x,P)}function hr({x:u,y:n,z:l},d=!1){const _=1/(1<<l),f=new Li(es(u*_),n===(1<<l)-1&&d?-90:an((n+1)*_)),g=new Li(es((u+1)*_),n===0&&d?90:an(n*_));return new ha(f,g)}function Qi(u,n=Bn){const l=Ti(u.getNorth()),d=Ti(u.getSouth()),_=Math.cos(l),f=Math.cos(d),g=Math.sin(l),w=Math.sin(d),S=u.getWest(),P=u.getEast();return[Fl(f,w,S,n),Fl(f,w,P,n),Fl(_,g,P,n),Fl(_,g,S,n)]}function Ki(u,n,l,d){const _=1<<l.z,f=(u/Rt+l.x)/_;return Ga(an((n/Rt+l.y)/_),es(f),d)}function Ri({min:u,max:n}){return C_/Math.max(n[0]-u[0],n[1]-u[1],n[2]-u[2])}const Ir=new Float64Array(16);function Zr(u){const n=Ri(u),l=Re.mat4.fromScaling(Ir,[n,n,n]);return Re.mat4.translate(l,l,Re.vec3.negate([],u.min))}function Ji(u){const n=Re.mat4.fromTranslation(Ir,u.min),l=1/Ri(u);return Re.mat4.scale(n,n,[l,l,l])}function wn(u){const n=Rt/(2*Math.PI);return u/(2*Math.PI)/n}function Is(u,n){return Rt/(512*Math.pow(2,u))*Ri(Lr(n))}function ts(u,n,l,d,_){const f=wn(l),g=[u,n,-l/(2*Math.PI)],w=Re.mat4.identity(new Float64Array(16));return Re.mat4.translate(w,w,g),Re.mat4.scale(w,w,[f,f,f]),Re.mat4.rotateX(w,w,Ti(-_)),Re.mat4.rotateY(w,w,Ti(-d)),w}function Hn(u){return ws(Dl,I_,u)}function oo(u,n){const l=Ga(n.lat,n.lng),d=function(f){const g=Ga(f._center.lat,f._center.lng),w=Re.vec3.fromValues(0,1,0);let S=Re.vec3.cross([],w,g);const P=Re.mat4.fromRotation([],-f.angle,g);S=Re.vec3.transformMat4(S,S,P),Re.mat4.fromRotation(P,-f._pitch,S);const x=Re.vec3.normalize([],g);return Re.vec3.scale(x,x,Ei(f.cameraToCenterDistance/f.pixelsPerMeter)),Re.vec3.transformMat4(x,x,P),Re.vec3.add([],g,x)}(u),_=Re.vec3.subtract([],d,l);return Re.vec3.angle(_,l)}function Cs(u,n){return oo(u,n)>Math.PI/2*1.01}const gs=Ti(85),Wa=Math.cos(gs),ao=Math.sin(gs),qa=Re.mat4.create(),Ll=u=>{const n=[];return u.paint.get("circle-pitch-alignment")==="map"&&n.push("PITCH_WITH_MAP"),u.paint.get("circle-pitch-scale")==="map"&&n.push("SCALE_WITH_MAP"),n};function Bh(u,n,l,d,_,f,g,w,S){if(f&&u.queryGeometry.isAboveHorizon)return!1;f&&(S*=u.pixelToTileUnitsFactor);const P=u.tileID.canonical,x=l.projection.upVectorScale(P,l.center.lat,l.worldSize).metersToTile;for(const I of n)for(const R of I){const E=R.add(w),C=_&&l.elevation?l.elevation.exaggeration()*_.getElevationAt(E.x,E.y,!0):0,D=l.projection.projectTilePoint(E.x,E.y,P);if(C>0){const W=l.projection.upVector(P,E.x,E.y);D.x+=W[0]*x*C,D.y+=W[1]*x*C,D.z+=W[2]*x*C}const N=f?E:Kf(D.x,D.y,D.z,d),z=f?u.tilespaceRays.map(W=>OB(W,C)):u.queryGeometry.screenGeometry,G=Re.vec4.transformMat4([],[D.x,D.y,D.z,1],d);if(!g&&f?S*=G[3]/l.cameraToCenterDistance:g&&!f&&(S*=l.cameraToCenterDistance/G[3]),f){const W=an((R.y/Rt+P.y)/(1<<P.z));S/=l.projection.pixelsPerMeter(W,1)/Dn(1,W)}if(te(z,N,S))return!0}return!1}function Kf(u,n,l,d){const _=Re.vec4.transformMat4([],[u,n,l,1],d);return new At(_[0]/_[3],_[1]/_[3])}const EA=Re.vec3.fromValues(0,0,0),DB=Re.vec3.fromValues(0,0,1);function OB(u,n){const l=Re.vec3.create();return EA[2]=n,u.intersectsPlane(EA,DB,l),new At(l[0],l[1])}class SA extends Q{}let IA,CA,MA,RA;function PA(u,{width:n,height:l},d,_){if(_){if(_ instanceof Uint8ClampedArray)_=new Uint8Array(_.buffer);else if(_.length!==n*l*d)throw new RangeError("mismatched image size")}else _=new Uint8Array(n*l*d);return u.width=n,u.height=l,u.data=_,u}function BA(u,n,l){const{width:d,height:_}=n;d===u.width&&_===u.height||(cv(u,n,{x:0,y:0},{x:0,y:0},{width:Math.min(u.width,d),height:Math.min(u.height,_)},l,null),u.width=d,u.height=_,u.data=n.data)}function cv(u,n,l,d,_,f,g,w){if(_.width===0||_.height===0)return n;if(_.width>u.width||_.height>u.height||l.x>u.width-_.width||l.y>u.height-_.height)throw new RangeError("out of range source coordinates for image copy");if(_.width>n.width||_.height>n.height||d.x>n.width-_.width||d.y>n.height-_.height)throw new RangeError("out of range destination coordinates for image copy");const S=u.data,P=n.data,x=f===4&&w;for(let I=0;I<_.height;I++){const R=((l.y+I)*u.width+l.x)*f,E=((d.y+I)*n.width+d.x)*f;if(x)for(let C=0;C<_.width;C++){const D=R+C*f+3,N=E+C*f;P[N+0]=255,P[N+1]=255,P[N+2]=255,P[N+3]=S[D]}else if(g)for(let C=0;C<_.width;C++){const D=R+C*f,N=E+C*f,z=S[D+3],G=new Vi(S[D+0]/255*z,S[D+1]/255*z,S[D+2]/255*z,z).toRenderColor(g).toArray();P[N+0]=G[0],P[N+1]=G[1],P[N+2]=G[2],P[N+3]=G[3]}else for(let C=0;C<_.width*f;C++)P[E+C]=S[R+C]}return n}Vt(SA,"HeatmapBucket",{omit:["layers"]});class Nl{constructor(n,l){PA(this,n,1,l)}resize(n){BA(this,new Nl(n),1)}clone(){return new Nl({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(n,l,d,_,f){cv(n,l,d,_,f,1,null)}}class hn{constructor(n,l){PA(this,n,4,l)}resize(n){BA(this,new hn(n),4)}replace(n,l){l?this.data.set(n):this.data=n instanceof Uint8ClampedArray?new Uint8Array(n.buffer):n}clone(){return new hn({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(n,l,d,_,f,g,w){cv(n,l,d,_,f,4,g,w)}}class DA{constructor(n,l){this.width=n.width,this.height=n.height,this.data=l instanceof Uint8Array?new Float32Array(l.buffer):l}}function Jf(u){const n={},l=u.resolution||256,d=u.clips?u.clips.length:1,_=u.image||new hn({width:l,height:d}),f=(g,w,S)=>{n[u.evaluationKey]=S;const P=u.expression.evaluate(n);P&&(_.data[g+w+0]=Math.floor(255*P.r/P.a),_.data[g+w+1]=Math.floor(255*P.g/P.a),_.data[g+w+2]=Math.floor(255*P.b/P.a),_.data[g+w+3]=Math.floor(255*P.a))};if(u.clips)for(let g=0,w=0;g<d;++g,w+=4*l)for(let S=0,P=0;S<l;S++,P+=4){const x=S/(l-1),{start:I,end:R}=u.clips[g];f(w,P,I*(1-x)+R*x)}else for(let g=0,w=0;g<l;g++,w+=4)f(0,w,g/(l-1));return _}Vt(Nl,"AlphaImage"),Vt(hn,"RGBAImage");const FB=ji([{name:"a_pos",components:2,type:"Int16"}],4),{members:kB}=FB;function Qf(u,n,l=2){const d=n&&n.length,_=d?n[0]*l:u.length;let f=OA(u,0,_,l,!0);const g=[];if(!f||f.next===f.prev)return g;let w,S,P;if(d&&(f=function(x,I,R,E){const C=[];for(let D=0,N=I.length;D<N;D++){const z=OA(x,I[D]*E,D<N-1?I[D+1]*E:x.length,E,!1);z===z.next&&(z.steiner=!0),C.push(GB(z))}C.sort(VB);for(let D=0;D<C.length;D++)R=jB(C[D],R);return R}(u,n,f,l)),u.length>80*l){w=1/0,S=1/0;let x=-1/0,I=-1/0;for(let R=l;R<_;R+=l){const E=u[R],C=u[R+1];E<w&&(w=E),C<S&&(S=C),E>x&&(x=E),C>I&&(I=C)}P=Math.max(x-w,I-S),P=P!==0?32767/P:0}return ep(f,g,l,w,S,P,0),g}function OA(u,n,l,d,_){let f;if(_===function(g,w,S,P){let x=0;for(let I=w,R=S-P;I<S;I+=P)x+=(g[R]-g[I])*(g[I+1]+g[R+1]),R=I;return x}(u,n,l,d)>0)for(let g=n;g<l;g+=d)f=LA(g/d|0,u[g],u[g+1],f);else for(let g=l-d;g>=n;g-=d)f=LA(g/d|0,u[g],u[g+1],f);return f&&R_(f,f.next)&&(ip(f),f=f.next),f}function iu(u,n){if(!u)return u;n||(n=u);let l,d=u;do if(l=!1,d.steiner||!R_(d,d.next)&&Yr(d.prev,d,d.next)!==0)d=d.next;else{if(ip(d),d=n=d.prev,d===d.next)break;l=!0}while(l||d!==n);return n}function ep(u,n,l,d,_,f,g){if(!u)return;!g&&f&&function(S,P,x,I){let R=S;do R.z===0&&(R.z=uv(R.x,R.y,P,x,I)),R.prevZ=R.prev,R.nextZ=R.next,R=R.next;while(R!==S);R.prevZ.nextZ=null,R.prevZ=null,function(E){let C,D=1;do{let N,z=E;E=null;let G=null;for(C=0;z;){C++;let W=z,H=0;for(let Y=0;Y<D&&(H++,W=W.nextZ,W);Y++);let q=D;for(;H>0||q>0&&W;)H!==0&&(q===0||!W||z.z<=W.z)?(N=z,z=z.nextZ,H--):(N=W,W=W.nextZ,q--),G?G.nextZ=N:E=N,N.prevZ=G,G=N;z=W}G.nextZ=null,D*=2}while(C>1)}(R)}(u,d,_,f);let w=u;for(;u.prev!==u.next;){const S=u.prev,P=u.next;if(f?NB(u,d,_,f):LB(u))n.push(S.i,u.i,P.i),ip(u),u=P.next,w=P.next;else if((u=P)===w){g?g===1?ep(u=zB(iu(u),n),n,l,d,_,f,2):g===2&&UB(u,n,l,d,_,f):ep(iu(u),n,l,d,_,f,1);break}}}function LB(u){const n=u.prev,l=u,d=u.next;if(Yr(n,l,d)>=0)return!1;const _=n.x,f=l.x,g=d.x,w=n.y,S=l.y,P=d.y,x=_<f?_<g?_:g:f<g?f:g,I=w<S?w<P?w:P:S<P?S:P,R=_>f?_>g?_:g:f>g?f:g,E=w>S?w>P?w:P:S>P?S:P;let C=d.next;for(;C!==n;){if(C.x>=x&&C.x<=R&&C.y>=I&&C.y<=E&&Dh(_,w,f,S,g,P,C.x,C.y)&&Yr(C.prev,C,C.next)>=0)return!1;C=C.next}return!0}function NB(u,n,l,d){const _=u.prev,f=u,g=u.next;if(Yr(_,f,g)>=0)return!1;const w=_.x,S=f.x,P=g.x,x=_.y,I=f.y,R=g.y,E=w<S?w<P?w:P:S<P?S:P,C=x<I?x<R?x:R:I<R?I:R,D=w>S?w>P?w:P:S>P?S:P,N=x>I?x>R?x:R:I>R?I:R,z=uv(E,C,n,l,d),G=uv(D,N,n,l,d);let W=u.prevZ,H=u.nextZ;for(;W&&W.z>=z&&H&&H.z<=G;){if(W.x>=E&&W.x<=D&&W.y>=C&&W.y<=N&&W!==_&&W!==g&&Dh(w,x,S,I,P,R,W.x,W.y)&&Yr(W.prev,W,W.next)>=0||(W=W.prevZ,H.x>=E&&H.x<=D&&H.y>=C&&H.y<=N&&H!==_&&H!==g&&Dh(w,x,S,I,P,R,H.x,H.y)&&Yr(H.prev,H,H.next)>=0))return!1;H=H.nextZ}for(;W&&W.z>=z;){if(W.x>=E&&W.x<=D&&W.y>=C&&W.y<=N&&W!==_&&W!==g&&Dh(w,x,S,I,P,R,W.x,W.y)&&Yr(W.prev,W,W.next)>=0)return!1;W=W.prevZ}for(;H&&H.z<=G;){if(H.x>=E&&H.x<=D&&H.y>=C&&H.y<=N&&H!==_&&H!==g&&Dh(w,x,S,I,P,R,H.x,H.y)&&Yr(H.prev,H,H.next)>=0)return!1;H=H.nextZ}return!0}function zB(u,n){let l=u;do{const d=l.prev,_=l.next.next;!R_(d,_)&&FA(d,l,l.next,_)&&tp(d,_)&&tp(_,d)&&(n.push(d.i,l.i,_.i),ip(l),ip(l.next),l=u=_),l=l.next}while(l!==u);return iu(l)}function UB(u,n,l,d,_,f){let g=u;do{let w=g.next.next;for(;w!==g.prev;){if(g.i!==w.i&&$B(g,w)){let S=kA(g,w);return g=iu(g,g.next),S=iu(S,S.next),ep(g,n,l,d,_,f,0),void ep(S,n,l,d,_,f,0)}w=w.next}g=g.next}while(g!==u)}function VB(u,n){return u.x-n.x}function jB(u,n){const l=function(_,f){let g=f;const w=_.x,S=_.y;let P,x=-1/0;do{if(S<=g.y&&S>=g.next.y&&g.next.y!==g.y){const D=g.x+(S-g.y)*(g.next.x-g.x)/(g.next.y-g.y);if(D<=w&&D>x&&(x=D,P=g.x<g.next.x?g:g.next,D===w))return P}g=g.next}while(g!==f);if(!P)return null;const I=P,R=P.x,E=P.y;let C=1/0;g=P;do{if(w>=g.x&&g.x>=R&&w!==g.x&&Dh(S<E?w:x,S,R,E,S<E?x:w,S,g.x,g.y)){const D=Math.abs(S-g.y)/(w-g.x);tp(g,_)&&(D<C||D===C&&(g.x>P.x||g.x===P.x&&HB(P,g)))&&(P=g,C=D)}g=g.next}while(g!==I);return P}(u,n);if(!l)return n;const d=kA(l,u);return iu(d,d.next),iu(l,l.next)}function HB(u,n){return Yr(u.prev,u,n.prev)<0&&Yr(n.next,u,u.next)<0}function uv(u,n,l,d,_){return(u=1431655765&((u=858993459&((u=252645135&((u=16711935&((u=(u-l)*_|0)|u<<8))|u<<4))|u<<2))|u<<1))|(n=1431655765&((n=858993459&((n=252645135&((n=16711935&((n=(n-d)*_|0)|n<<8))|n<<4))|n<<2))|n<<1))<<1}function GB(u){let n=u,l=u;do(n.x<l.x||n.x===l.x&&n.y<l.y)&&(l=n),n=n.next;while(n!==u);return l}function Dh(u,n,l,d,_,f,g,w){return(_-g)*(n-w)>=(u-g)*(f-w)&&(u-g)*(d-w)>=(l-g)*(n-w)&&(l-g)*(f-w)>=(_-g)*(d-w)}function $B(u,n){return u.next.i!==n.i&&u.prev.i!==n.i&&!function(l,d){let _=l;do{if(_.i!==l.i&&_.next.i!==l.i&&_.i!==d.i&&_.next.i!==d.i&&FA(_,_.next,l,d))return!0;_=_.next}while(_!==l);return!1}(u,n)&&(tp(u,n)&&tp(n,u)&&function(l,d){let _=l,f=!1;const g=(l.x+d.x)/2,w=(l.y+d.y)/2;do _.y>w!=_.next.y>w&&_.next.y!==_.y&&g<(_.next.x-_.x)*(w-_.y)/(_.next.y-_.y)+_.x&&(f=!f),_=_.next;while(_!==l);return f}(u,n)&&(Yr(u.prev,u,n.prev)||Yr(u,n.prev,n))||R_(u,n)&&Yr(u.prev,u,u.next)>0&&Yr(n.prev,n,n.next)>0)}function Yr(u,n,l){return(n.y-u.y)*(l.x-n.x)-(n.x-u.x)*(l.y-n.y)}function R_(u,n){return u.x===n.x&&u.y===n.y}function FA(u,n,l,d){const _=B_(Yr(u,n,l)),f=B_(Yr(u,n,d)),g=B_(Yr(l,d,u)),w=B_(Yr(l,d,n));return _!==f&&g!==w||!(_!==0||!P_(u,l,n))||!(f!==0||!P_(u,d,n))||!(g!==0||!P_(l,u,d))||!(w!==0||!P_(l,n,d))}function P_(u,n,l){return n.x<=Math.max(u.x,l.x)&&n.x>=Math.min(u.x,l.x)&&n.y<=Math.max(u.y,l.y)&&n.y>=Math.min(u.y,l.y)}function B_(u){return u>0?1:u<0?-1:0}function tp(u,n){return Yr(u.prev,u,u.next)<0?Yr(u,n,u.next)>=0&&Yr(u,u.prev,n)>=0:Yr(u,n,u.prev)<0||Yr(u,u.next,n)<0}function kA(u,n){const l=hv(u.i,u.x,u.y),d=hv(n.i,n.x,n.y),_=u.next,f=n.prev;return u.next=n,n.prev=u,l.next=_,_.prev=l,d.next=l,l.prev=d,f.next=d,d.prev=f,d}function LA(u,n,l,d){const _=hv(u,n,l);return d?(_.next=d.next,_.prev=d,d.next.prev=_,d.next=_):(_.prev=_,_.next=_),_}function ip(u){u.next.prev=u.prev,u.prev.next=u.next,u.prevZ&&(u.prevZ.nextZ=u.nextZ),u.nextZ&&(u.nextZ.prevZ=u.prevZ)}function hv(u,n,l){return{i:u,x:n,y:l,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function D_(u,n){const l=u.length;if(l<=1)return[u];const d=[];let _,f;for(let g=0;g<l;g++){const w=Lu(u[g]);w!==0&&(u[g].area=Math.abs(w),f===void 0&&(f=w<0),f===w<0?(_&&d.push(_),_=[u[g]]):_.push(u[g]))}if(_&&d.push(_),n>1)for(let g=0;g<d.length;g++)d[g].length<=n||(vc(d[g],n,1,d[g].length-1,WB),d[g]=d[g].slice(0,n));return d}function WB(u,n){return n.area-u.area}function NA(u,n,l=1){if(!u)return null;const d=typeof u=="string"?u:u.getPrimary().id;n[d]||(n[d]=[]);const _=cn.from(d).getPrimary().scaleSelf(l);return n[d].push(_),_.serialize()}function dv(u,n,l,d){const _=d.patternDependencies;let f=!1;for(const g of n){const w=g.paint.get(`${u}-pattern`);w.isConstant()||(f=!0),NA(w.constantOr(null),_,l)&&(f=!0)}return f}function fv(u,n,l,d,_,f){const g=f.patternDependencies;for(const w of n){const S=w.paint.get(`${u}-pattern`).value;if(S.kind!=="constant"){let P=S.evaluate({zoom:d},l,{},f.availableImages);P=P&&P.name?P.name:P;const x=NA(P,g,_);x&&(l.patterns[w.id]=x)}}return l}class pv{constructor(n){this.zoom=n.zoom,this.pixelRatio=n.pixelRatio,this.overscaling=n.overscaling,this.layers=n.layers,this.layerIds=this.layers.map(l=>l.fqid),this.index=n.index,this.hasPattern=!1,this.patternFeatures=[],this.layoutVertexArray=new Do,this.indexArray=new on,this.indexArray2=new aa,this.programConfigurations=new ua(n.layers,{zoom:n.zoom,lut:n.lut}),this.segments=new Ar,this.segments2=new Ar,this.stateDependentLayerIds=this.layers.filter(l=>l.isStateDependent()).map(l=>l.id),this.projection=n.projection}updateFootprints(n,l){}populate(n,l,d,_){this.hasPattern=dv("fill",this.layers,this.pixelRatio,l);const f=this.layers[0].layout.get("fill-sort-key"),g=[];for(const{feature:w,id:S,index:P,sourceLayerIndex:x}of n){const I=this.layers[0]._featureFilter.needGeometry,R=U(w,I);if(!this.layers[0]._featureFilter.filter(new tr(this.zoom),R,d))continue;const E=f?f.evaluate(R,{},d,l.availableImages):void 0,C={id:S,properties:w.properties,type:w.type,sourceLayerIndex:x,index:P,geometry:I?R.geometry:L(w,d,_),patterns:{},sortKey:E};g.push(C)}f&&g.sort((w,S)=>w.sortKey-S.sortKey);for(const w of g){const{geometry:S,index:P,sourceLayerIndex:x}=w;if(this.hasPattern){const I=fv("fill",this.layers,w,this.zoom,this.pixelRatio,l);this.patternFeatures.push(I)}else this.addFeature(w,S,P,d,{},l.availableImages,l.brightness,l.elevationFeatures);l.featureIndex.insert(n[P].feature,S,P,x,this.index)}}update(n,l,d,_,f,g,w){this.programConfigurations.updatePaintArrays(n,l,f,d,_,g,w)}addFeatures(n,l,d,_,f,g){for(const w of this.patternFeatures)this.addFeature(w,w.geometry,w.index,l,d,_,g,n.elevationFeatures)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(n){this.uploaded||(this.layoutVertexBuffer=n.createVertexBuffer(this.layoutVertexArray,kB),this.indexBuffer=n.createIndexBuffer(this.indexArray),this.indexBuffer2=n.createIndexBuffer(this.indexArray2)),this.programConfigurations.upload(n),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.indexBuffer2.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.segments2.destroy())}addFeature(n,l,d,_,f,g=[],w,S){for(const P of D_(l,500)){let x=0;for(const N of P)x+=N.length;const I=this.segments.prepareSegment(x,this.layoutVertexArray,this.indexArray),R=I.vertexLength,E=[],C=[];for(const N of P){if(N.length===0)continue;N!==P[0]&&C.push(E.length/2);const z=this.segments2.prepareSegment(N.length,this.layoutVertexArray,this.indexArray2),G=z.vertexLength;this.layoutVertexArray.emplaceBack(N[0].x,N[0].y),this.indexArray2.emplaceBack(G+N.length-1,G),E.push(N[0].x),E.push(N[0].y);for(let W=1;W<N.length;W++)this.layoutVertexArray.emplaceBack(N[W].x,N[W].y),this.indexArray2.emplaceBack(G+W-1,G+W),E.push(N[W].x),E.push(N[W].y);z.vertexLength+=N.length,z.primitiveLength+=N.length}const D=Qf(E,C);for(let N=0;N<D.length;N+=3)this.indexArray.emplaceBack(R+D[N],R+D[N+1],R+D[N+2]);I.vertexLength+=x,I.primitiveLength+=D.length/3}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,n,d,f,g,_,w)}}let zA,UA,VA,jA;Vt(pv,"FillBucket",{omit:["layers","patternFeatures"]});class mv{constructor(n,l,d,_){if(this.triangleCount=l.length/3,this.min=new At(0,0),this.max=new At(0,0),this.xScale=0,this.yScale=0,this.cellsX=0,this.cellsY=0,this.cells=[],this.payload=[],this.triangleCount===0||n.length===0)return;const[f,g]=[n[0].clone(),n[0].clone()];for(let I=1;I<n.length;++I){const R=n[I];f.x=Math.min(f.x,R.x),f.y=Math.min(f.y,R.y),g.x=Math.max(g.x,R.x),g.y=Math.max(g.y,R.y)}if(_){const I=Math.ceil(Math.max(g.x-f.x,g.y-f.y)/_);d=Math.max(d,I)}if(d===0)return;this.min=f,this.max=g;const w=this.max.sub(this.min);w.x=Math.max(w.x,1),w.y=Math.max(w.y,1);const S=Math.max(w.x,w.y)/d;this.cellsX=Math.max(1,Math.ceil(w.x/S)),this.cellsY=Math.max(1,Math.ceil(w.y/S)),this.xScale=1/S,this.yScale=1/S;const P=[];for(let I=0;I<this.triangleCount;I++){const R=n[l[3*I+0]].sub(this.min),E=n[l[3*I+1]].sub(this.min),C=n[l[3*I+2]].sub(this.min),D=da(Math.floor(Math.min(R.x,E.x,C.x)),this.xScale,this.cellsX),N=da(Math.floor(Math.max(R.x,E.x,C.x)),this.xScale,this.cellsX),z=da(Math.floor(Math.min(R.y,E.y,C.y)),this.yScale,this.cellsY),G=da(Math.floor(Math.max(R.y,E.y,C.y)),this.yScale,this.cellsY),W=new At(0,0),H=new At(0,0),q=new At(0,0),Y=new At(0,0);for(let ie=z;ie<=G;++ie){W.y=H.y=ie*S,q.y=Y.y=(ie+1)*S;for(let he=D;he<=N;++he)W.x=q.x=he*S,H.x=Y.x=(he+1)*S,(We(R,E,C,W,H,Y)||We(R,E,C,W,Y,q))&&P.push({cellIdx:ie*this.cellsX+he,triIdx:I})}}if(P.length===0)return;P.sort((I,R)=>I.cellIdx-R.cellIdx||I.triIdx-R.triIdx);let x=0;for(;x<P.length;){const I=P[x].cellIdx,R={start:this.payload.length,len:0};for(;x<P.length&&P[x].cellIdx===I;)++R.len,this.payload.push(P[x++].triIdx);this.cells[I]=R}}_lazyInitLookup(){this.lookup||(this.lookup=new Uint8Array(Math.ceil(this.triangleCount/8))),this.lookup.fill(0)}queryPoint(n,l){if(this.triangleCount===0||this.cells.length===0||n.x>this.max.x||this.min.x>n.x||n.y>this.max.y||this.min.y>n.y)return;const d=da(n.x-this.min.x,this.xScale,this.cellsX),_=da(n.y-this.min.y,this.yScale,this.cellsY),f=this.cells[_*this.cellsX+d];if(f){this._lazyInitLookup();for(let g=0;g<f.len;g++){const w=this.payload[f.start+g],S=Math.floor(w/8),P=1<<w%8;if(!(this.lookup[S]&P)&&(this.lookup[S]|=P,l.push(w),l.length===this.triangleCount))return}}}query(n,l,d){if(this.triangleCount===0||this.cells.length===0||n.x>this.max.x||this.min.x>l.x||n.y>this.max.y||this.min.y>l.y)return;this._lazyInitLookup();const _=da(n.x-this.min.x,this.xScale,this.cellsX),f=da(l.x-this.min.x,this.xScale,this.cellsX),g=da(n.y-this.min.y,this.yScale,this.cellsY),w=da(l.y-this.min.y,this.yScale,this.cellsY);for(let S=g;S<=w;S++)for(let P=_;P<=f;P++){const x=this.cells[S*this.cellsX+P];if(x)for(let I=0;I<x.len;I++){const R=this.payload[x.start+I],E=Math.floor(R/8),C=1<<R%8;if(!(this.lookup[E]&C)&&(this.lookup[E]|=C,d.push(R),d.length===this.triangleCount))return}}}}function da(u,n,l){return Math.max(0,Math.min(l-1,Math.floor(u*n)))}Vt(mv,"TriangleGridIndex");class HA{constructor(n){this.zoom=n.zoom,this.layers=n.layers,this.layerIds=this.layers.map(l=>l.fqid),this.index=n.index,this.hasPattern=!1,this.stateDependentLayerIds=this.layers.filter(l=>l.isStateDependent()).map(l=>l.id),this.footprints=[]}updateFootprints(n,l){for(const d of this.footprints)l.push({footprint:d,id:n})}populate(n,l,d,_){const f=[];for(const{feature:g,id:w,index:S,sourceLayerIndex:P}of n){const x=this.layers[0]._featureFilter.needGeometry,I=U(g,x);if(!this.layers[0]._featureFilter.filter(new tr(this.zoom),I,d))continue;const R={id:w,properties:g.properties,type:g.type,sourceLayerIndex:P,index:S,geometry:x?I.geometry:L(g,d,_),patterns:{}};f.push(R)}for(const g of f){const{geometry:w,index:S,sourceLayerIndex:P}=g;this.addFeature(g,w,S,d,{},l.availableImages,l.brightness),l.featureIndex.insert(n[S].feature,w,S,P,this.index)}}isEmpty(){return this.footprints.length===0}uploadPending(){return!1}upload(n){}update(n,l,d,_,f,g,w){}destroy(){}addFeature(n,l,d,_,f,g=[],w){for(const S of D_(l,2)){const P=[],x=[],I=[],R=new At(1/0,1/0),E=new At(-1/0,-1/0);for(const N of S)if(N.length!==0){N!==S[0]&&I.push(x.length/2);for(let z=0;z<N.length;z++)x.push(N[z].x),x.push(N[z].y),P.push(N[z]),R.x=Math.min(R.x,N[z].x),R.y=Math.min(R.y,N[z].y),E.x=Math.max(E.x,N[z].x),E.y=Math.max(E.y,N[z].y)}const C=Qf(x,I),D=new mv(P,C,8,256);this.footprints.push({vertices:P,indices:C,grid:D,min:R,max:E})}}}Vt(HA,"ClipBucket",{omit:["layers"]});const qB=ji([{name:"a_pos_normal_ed",components:4,type:"Int16"}]),XB=ji([{name:"a_pos_end",components:4,type:"Int16"},{name:"a_angular_offset_factor",components:1,type:"Int16"}]),ZB=ji([{name:"a_centroid_pos",components:2,type:"Uint16"}]),YB=ji([{name:"a_join_normal_inside",components:3,type:"Int16"}]),KB=ji([{name:"a_hidden_by_landmark",components:1,type:"Uint8"}]),JB=ji([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]),{members:QB}=qB;var _v,GA,gv,$A,yv,WA,qA,O_={};function XA(){if(GA)return _v;GA=1;var u=_n();function n(_,f,g,w,S){this.properties={},this.extent=g,this.type=0,this._pbf=_,this._geometry=-1,this._keys=w,this._values=S,_.readFields(l,this,f)}function l(_,f,g){_==1?f.id=g.readVarint():_==2?function(w,S){for(var P=w.readVarint()+w.pos;w.pos<P;){var x=S._keys[w.readVarint()],I=S._values[w.readVarint()];S.properties[x]=I}}(g,f):_==3?f.type=g.readVarint():_==4&&(f._geometry=g.pos)}function d(_){for(var f,g,w=0,S=0,P=_.length,x=P-1;S<P;x=S++)w+=((g=_[x]).x-(f=_[S]).x)*(f.y+g.y);return w}return _v=n,n.types=["Unknown","Point","LineString","Polygon"],n.prototype.loadGeometry=function(){var _=this._pbf;_.pos=this._geometry;for(var f,g=_.readVarint()+_.pos,w=1,S=0,P=0,x=0,I=[];_.pos<g;){if(S<=0){var R=_.readVarint();w=7&R,S=R>>3}if(S--,w===1||w===2)P+=_.readSVarint(),x+=_.readSVarint(),w===1&&(f&&I.push(f),f=[]),f.push(new u(P,x));else{if(w!==7)throw new Error("unknown command "+w);f&&f.push(f[0].clone())}}return f&&I.push(f),I},n.prototype.bbox=function(){var _=this._pbf;_.pos=this._geometry;for(var f=_.readVarint()+_.pos,g=1,w=0,S=0,P=0,x=1/0,I=-1/0,R=1/0,E=-1/0;_.pos<f;){if(w<=0){var C=_.readVarint();g=7&C,w=C>>3}if(w--,g===1||g===2)(S+=_.readSVarint())<x&&(x=S),S>I&&(I=S),(P+=_.readSVarint())<R&&(R=P),P>E&&(E=P);else if(g!==7)throw new Error("unknown command "+g)}return[x,R,I,E]},n.prototype.toGeoJSON=function(_,f,g){var w,S,P=this.extent*Math.pow(2,g),x=this.extent*_,I=this.extent*f,R=this.loadGeometry(),E=n.types[this.type];function C(z){for(var G=0;G<z.length;G++){var W=z[G];z[G]=[360*(W.x+x)/P-180,360/Math.PI*Math.atan(Math.exp((180-360*(W.y+I)/P)*Math.PI/180))-90]}}switch(this.type){case 1:var D=[];for(w=0;w<R.length;w++)D[w]=R[w][0];C(R=D);break;case 2:for(w=0;w<R.length;w++)C(R[w]);break;case 3:for(R=function(z){var G=z.length;if(G<=1)return[z];for(var W,H,q=[],Y=0;Y<G;Y++){var ie=d(z[Y]);ie!==0&&(H===void 0&&(H=ie<0),H===ie<0?(W&&q.push(W),W=[z[Y]]):W.push(z[Y]))}return W&&q.push(W),q}(R),w=0;w<R.length;w++)for(S=0;S<R[w].length;S++)C(R[w][S])}R.length===1?R=R[0]:E="Multi"+E;var N={type:"Feature",geometry:{type:E,coordinates:R},properties:this.properties};return"id"in this&&(N.id=this.id),N},_v}function ZA(){if($A)return gv;$A=1;var u=XA();function n(d,_){this.version=1,this.name=null,this.extent=4096,this.length=0,this._pbf=d,this._keys=[],this._values=[],this._features=[],d.readFields(l,this,_),this.length=this._features.length}function l(d,_,f){d===15?_.version=f.readVarint():d===1?_.name=f.readString():d===5?_.extent=f.readVarint():d===2?_._features.push(f.pos):d===3?_._keys.push(f.readString()):d===4&&_._values.push(function(g){for(var w=null,S=g.readVarint()+g.pos;g.pos<S;){var P=g.readVarint()>>3;w=P===1?g.readString():P===2?g.readFloat():P===3?g.readDouble():P===4?g.readVarint64():P===5?g.readVarint():P===6?g.readSVarint():P===7?g.readBoolean():null}return w}(f))}return gv=n,n.prototype.feature=function(d){if(d<0||d>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[d];var _=this._pbf.readVarint()+this._pbf.pos;return new u(this._pbf,_,this.extent,this._keys,this._values)},gv}function YA(){return qA||(qA=1,O_.VectorTile=function(){if(WA)return yv;WA=1;var u=ZA();function n(l,d,_){if(l===3){var f=new u(_,_.readVarint()+_.pos);f.length&&(d[f.name]=f)}}return yv=function(l,d){this.layers=l.readFields(n,{},d)},yv}(),O_.VectorTileFeature=XA(),O_.VectorTileLayer=ZA()),O_}var Oh=YA();class ru extends At{constructor(n,l,d){super(n,l),this.z=d}}class KA extends ru{constructor(n,l,d,_){super(n,l,d),this.w=_}}function F_(u,n,l,d){const _=[],f=d===0?(g,w,S,P,x,I)=>{g.push(new At(I,S+(I-w)/(P-w)*(x-S)))}:(g,w,S,P,x,I)=>{g.push(new At(w+(I-S)/(x-S)*(P-w),I))};for(const g of u){const w=[];for(const S of g){if(S.length<=2)continue;const P=[];for(let R=0;R<S.length-1;R++){const E=S[R].x,C=S[R].y,D=S[R+1].x,N=S[R+1].y,z=d===0?E:C,G=d===0?D:N;z<n?G>n&&f(P,E,C,D,N,n):z>l?G<l&&f(P,E,C,D,N,l):P.push(S[R]),G<n&&z>=n&&f(P,E,C,D,N,n),G>l&&z<=l&&f(P,E,C,D,N,l)}let x=S[S.length-1];const I=d===0?x.x:x.y;I>=n&&I<=l&&P.push(x),P.length&&(x=P[P.length-1],P[0].x===x.x&&P[0].y===x.y||P.push(P[0]),w.push(P))}w.length&&_.push(w)}return _}function JA(u,n,l,d){const _=l==="x"?"y":"x",f=(d-u[l])/(n[l]-u[l]);u[_]=u[_]+(n[_]-u[_])*f,u[l]=d,u.hasOwnProperty("z")&&(u.z=ii(u.z,n.z,f)),u.hasOwnProperty("w")&&(u.w=ii(u.w,n.w,f))}function QA(u,n,l,d){const _=l,f=d;for(const g of["x","y"]){let w=u,S=n;w[g]>=S[g]&&(w=n,S=u),w[g]<_&&S[g]>_&&JA(w,S,g,_),w[g]<f&&S[g]>f&&JA(S,w,g,f)}}const k_=Number.MAX_SAFE_INTEGER;function eT(u,n,l,d){return u.order<n||u.order===k_||!(u.clipMask&l)||function(_,f){return f.length!==0&&f.find(g=>g===_)===void 0}(d,u.clipScope)}function L_(u,n){return u.x-n.x||u.y-n.y}function tT(u,n){return L_(u.min,n.min)===0&&L_(u.max,n.max)===0}function vv(u,n){return!(u.min.x>n.max.x||u.max.x<n.min.x||u.min.y>n.max.y||u.max.y<n.min.y)}function xv(u,n){if(u.length!==n.length)return!1;for(let l=0;l<u.length;l++)if(u[l].sourceId!==n[l].sourceId||!tT(u[l],n[l])||u[l].order!==n[l].order||u[l].clipMask!==n[l].clipMask||!Wr(u[l].clipScope,n[l].clipScope))return!1;return!0}function iT(u,n,l){const d=1/Rt,_=1/(1<<l.canonical.z),f=(n.x*d+l.canonical.x)*_+l.wrap,g=(n.y*d+l.canonical.y)*_;return{min:new At((u.x*d+l.canonical.x)*_+l.wrap,(u.y*d+l.canonical.y)*_),max:new At(f,g)}}function eD(u,n,l){const d=1<<l.canonical.z,_=((n.x-l.wrap)*d-l.canonical.x)*Rt,f=(n.y*d-l.canonical.y)*Rt;return{min:new At(((u.x-l.wrap)*d-l.canonical.x)*Rt,(u.y*d-l.canonical.y)*Rt),max:new At(_,f)}}function rT(u,n,l,d,_,f,g){const w=u.indices,S=u.vertices,P=[];for(let x=d;x<d+_;x+=3){const I=n[l[x+0]+f],R=n[l[x+1]+f],E=n[l[x+2]+f],C=Math.min(I.x,R.x,E.x),D=Math.max(I.x,R.x,E.x),N=Math.min(I.y,R.y,E.y),z=Math.max(I.y,R.y,E.y);P.length=0,u.grid.query(new At(C,N),new At(D,z),P);for(let G=0;G<P.length;G++){const W=P[G];if(We(S[w[3*W+0]],S[w[3*W+1]],S[w[3*W+2]],I,R,E,g))return!0}}return!1}function nT(u,n,l,d){if(!u||!l)return!1;let _=u.vertices;if(!n.canonical.equals(d.canonical)||n.wrap!==d.wrap){if(l.vertices.length<u.vertices.length)return nT(l,d,u,n);const f=n.canonical,g=d.canonical,w=Math.pow(2,g.z-f.z);_=u.vertices.map(S=>new At((S.x+f.x*Rt)*w-g.x*Rt,(S.y+f.y*Rt)*w-g.y*Rt))}return rT(l,_,u.indices,0,u.indices.length,0,0)}function sT(u,n,l,d){const _=Math.pow(2,d.z-l.z);return new At((u+l.x*Rt)*_-d.x*Rt,(n+l.y*Rt)*_-d.y*Rt)}function oT(u,n){const l=[];n.grid.queryPoint(u,l);const d=n.indices,_=n.vertices;for(let f=0;f<l.length;f++){const g=l[f];if(ye([_[d[3*g+0]],_[d[3*g+1]],_[d[3*g+2]]],u))return!0}return!1}const bv=[new At(0,0),new At(Rt,0),new At(Rt,Rt),new At(0,Rt)];function aT(u,n){const l=[];let d=[];if(!n||u.length<2)return[u];if(u.length===2)return Fe(u[0],u[1],bv)?[u]:[];for(let _=0;_<u.length+2;_++){const f=u[_%u.length],g=u[(_+1)%u.length],w=Fe(_===0?u[u.length-1]:u[(_-1)%u.length],f,bv),S=Fe(f,g,bv),P=w||S;P&&d.push(f),P&&S||d.length>0&&(d.length>1&&l.push(d),d=[])}return d.length>1&&l.push(d),l}const wv=Oh.VectorTileFeature.types,tD=["fill-extrusion-base","fill-extrusion-height","fill-extrusion-color","fill-extrusion-pattern","fill-extrusion-flood-light-wall-radius","fill-extrusion-line-width","fill-extrusion-emissive-strength"],iD=["fill-extrusion-flood-light-ground-radius"],rD=Math.pow(2,13),nD=Math.pow(2,15)-1,lT=new At(0,1),zl=2147483648;function rp(u,n,l,d,_,f,g,w){u.emplaceBack((n<<1)+g,(l<<1)+f,(Math.floor(d*rD)<<1)+_,Math.round(w))}function np(u,n,l){u.emplaceBack(n.x*Rt,n.y*Rt,l?1:0)}function N_(u,n,l,d,_,f){u.emplaceBack(n.x,n.y,(l.x<<1)+d,(l.y<<1)+_,f)}function sp(u,n,l){u.emplaceBack(n.x,n.y,n.z,l[0]*16384,l[1]*16384,l[2]*16384)}class cT{constructor(){this.vertexOffset=0,this.vertexCount=0,this.indexOffset=0,this.indexCount=0}}class uT{constructor(){this.centroidXY=new At(0,0),this.vertexArrayOffset=0,this.vertexCount=0,this.groundVertexArrayOffset=0,this.groundVertexCount=0,this.flags=0,this.footprintSegIdx=-1,this.footprintSegLen=0,this.polygonSegIdx=-1,this.polygonSegLen=0,this.min=new At(Number.MAX_VALUE,Number.MAX_VALUE),this.max=new At(-Number.MAX_VALUE,-Number.MAX_VALUE),this.height=0}span(){return new At(this.max.x-this.min.x,this.max.y-this.min.y)}}class hT{constructor(){this.acc=new At(0,0),this.accCount=0,this.centroidDataIndex=0}startRing(n,l){n.min.x===Number.MAX_VALUE&&(n.min.x=n.max.x=l.x,n.min.y=n.max.y=l.y)}appendEdge(n,l,d){this.accCount++,this.acc._add(l);let _=!!this.borders;l.x<n.min.x?(n.min.x=l.x,_=!0):l.x>n.max.x&&(n.max.x=l.x,_=!0),l.y<n.min.y?(n.min.y=l.y,_=!0):l.y>n.max.y&&(n.max.y=l.y,_=!0),((l.x===0||l.x===Rt)&&l.x===d.x)!=((l.y===0||l.y===Rt)&&l.y===d.y)&&this.processBorderOverlap(l,d),_&&this.checkBorderIntersection(l,d)}checkBorderIntersection(n,l){l.x<0!=n.x<0&&this.addBorderIntersection(0,ii(l.y,n.y,(0-l.x)/(n.x-l.x))),l.x>Rt!=n.x>Rt&&this.addBorderIntersection(1,ii(l.y,n.y,(Rt-l.x)/(n.x-l.x))),l.y<0!=n.y<0&&this.addBorderIntersection(2,ii(l.x,n.x,(0-l.y)/(n.y-l.y))),l.y>Rt!=n.y>Rt&&this.addBorderIntersection(3,ii(l.x,n.x,(Rt-l.y)/(n.y-l.y)))}addBorderIntersection(n,l){this.borders||(this.borders=[[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE]]);const d=this.borders[n];l<d[0]&&(d[0]=l),l>d[1]&&(d[1]=l)}processBorderOverlap(n,l){if(n.x===l.x){if(n.y===l.y)return;const d=n.x===0?0:1;this.addBorderIntersection(d,l.y),this.addBorderIntersection(d,n.y)}else{const d=n.y===0?2:3;this.addBorderIntersection(d,l.x),this.addBorderIntersection(d,n.x)}}centroid(){return this.accCount===0?new At(0,0):new At(Math.floor(Math.max(0,this.acc.x)/this.accCount),Math.floor(Math.max(0,this.acc.y)/this.accCount))}intersectsCount(){return this.borders?this.borders.reduce((n,l)=>n+ +(l[0]!==Number.MAX_VALUE),0):0}}function dT(u,n){const l=u.add(n)._unit(),d=yi(u.x*l.x+u.y*l.y,-1,1);var _,f,g;return g=Math.acos(d),Math.min(4,Math.max(-4,Math.tan(g)))/4*nD*((_=u).x*(f=n).y-_.y*f.x<0?-1:1)}const sD=[u=>u.x<0,u=>u.x>Rt,u=>u.y<0,u=>u.y>Rt];function oD(u,n,l,d){const _=[4];if(d===0)return _;l._mult(d);const f=u.sub(l),g=n.sub(l),w=[u,n,f,g];for(let S=0;S<4;S++)for(const P of w)if(sD[S](P)){_.push(S);break}return _}class fT{constructor(n){this.vertexArray=new bh,this.indexArray=new on,this.programConfigurations=new ua(n.layers,{zoom:n.zoom,lut:n.lut},l=>iD.includes(l)),this._segments=new Ar,this.hiddenByLandmarkVertexArray=new Sh,this._segmentToGroundQuads={},this._segmentToGroundQuads[0]=[],this._segmentToRegionTriCounts={},this._segmentToRegionTriCounts[0]=[0,0,0,0,0],this.regionSegments={},this.regionSegments[4]=new Ar}getDefaultSegment(){return this.regionSegments[4]}hasData(){return this.vertexArray.length!==0}addData(n,l,d,_=!1){const f=n.length;if(f>2){let g=Math.max(0,this._segments.get().length-1);const w=this._segments._prepareSegment(4*f,this.vertexArray.length,2*this._segmentToGroundQuads[g].length);let S;g!==this._segments.get().length-1&&(g++,this._segmentToGroundQuads[g]=[],this._segmentToRegionTriCounts[g]=[0,0,0,0,0]);{const P=n[0],x=n[1];S=dT(P.sub(n[f-1])._perp()._unit(),x.sub(P)._perp()._unit())}for(let P=0;P<f;P++){const x=P===f-1?0:P+1,I=n[P],R=n[x],E=n[x===f-1?0:x+1],C=R.sub(I)._perp()._unit(),D=dT(C,E.sub(R)._perp()._unit()),N=S,z=D;if(Av(I,R,l)||_&&_T(I,l)&&_T(R,l)){S=D;continue}const G=w.vertexLength;N_(this.vertexArray,I,R,1,1,N),N_(this.vertexArray,I,R,1,0,N),N_(this.vertexArray,I,R,0,1,z),N_(this.vertexArray,I,R,0,0,z),w.vertexLength+=4;const W=oD(I,R,C,d);for(const H of W)this._segmentToGroundQuads[g].push({id:G,region:H}),this._segmentToRegionTriCounts[g][H]+=2,w.primitiveLength+=2;S=D}}}prepareBorderSegments(){if(!this.hasData())return;const n=this._segments.get(),l=n.length;for(let d=0;d<l;d++)this._segmentToGroundQuads[d].sort((_,f)=>_.region-f.region);for(let d=0;d<l;d++){const _=this._segmentToGroundQuads[d],f=n[d],g=this._segmentToRegionTriCounts[d];g.reduce((S,P)=>S+P,0);let w=0;for(let S=0;S<=4;S++){const P=g[S];if(P!==0){let x=this.regionSegments[S];x||(x=this.regionSegments[S]=new Ar);const I={vertexOffset:f.vertexOffset,primitiveOffset:f.primitiveOffset+w,vertexLength:f.vertexLength,primitiveLength:P};x.get().push(I)}w+=P}for(let S=0;S<_.length;S++){const P=_[S].id;this.indexArray.emplaceBack(P,P+1,P+3),this.indexArray.emplaceBack(P,P+3,P+2)}}this._segmentToGroundQuads=null,this._segmentToRegionTriCounts=null,this._segments.destroy(),this._segments=null}addPaintPropertiesData(n,l,d,_,f,g){this.hasData()&&this.programConfigurations.populatePaintArrays(this.vertexArray.length,n,l,d,_,f,g)}upload(n){this.hasData()&&(this.vertexBuffer=n.createVertexBuffer(this.vertexArray,XB.members),this.indexBuffer=n.createIndexBuffer(this.indexArray))}uploadPaintProperties(n){this.hasData()&&this.programConfigurations.upload(n)}update(n,l,d,_,f,g,w){this.hasData()&&this.programConfigurations.updatePaintArrays(n,l,d,_,f,g,w)}updateHiddenByLandmark(n){if(!this.hasData())return;const l=n.groundVertexCount+n.groundVertexArrayOffset;if(n.groundVertexCount===0)return;const d=n.flags&zl?1:0;for(let _=n.groundVertexArrayOffset;_<l;++_)this.hiddenByLandmarkVertexArray.emplace(_,d);this._needsHiddenByLandmarkUpdate=!0}uploadHiddenByLandmark(n){this.hasData()&&this._needsHiddenByLandmarkUpdate&&(!this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexArray.length>0?this.hiddenByLandmarkVertexBuffer=n.createVertexBuffer(this.hiddenByLandmarkVertexArray,KB.members,!0):this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.updateData(this.hiddenByLandmarkVertexArray),this._needsHiddenByLandmarkUpdate=!1)}destroy(){if(this.vertexBuffer){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.destroy(),this._segments&&this._segments.destroy(),this.programConfigurations.destroy();for(let n=0;n<=4;n++){const l=this.regionSegments[n];l&&l.destroy()}}}}class z_{constructor(n){this.zoom=n.zoom,this.canonical=n.canonical,this.overscaling=n.overscaling,this.layers=n.layers,this.pixelRatio=n.pixelRatio,this.layerIds=this.layers.map(l=>l.fqid),this.index=n.index,this.hasPattern=!1,this.edgeRadius=0,this.projection=n.projection,this.activeReplacements=[],this.replacementUpdateTime=0,this.centroidData=[],this.footprintIndices=new on,this.footprintVertices=new Do,this.footprintSegments=[],this.layoutVertexArray=new Oo,this.centroidVertexArray=new Qn,this.wallVertexArray=new w_,this.indexArray=new on,this.programConfigurations=new ua(n.layers,{zoom:n.zoom,lut:n.lut},l=>tD.includes(l)),this.segments=new Ar,this.stateDependentLayerIds=this.layers.filter(l=>l.isStateDependent()).map(l=>l.id),this.groundEffect=new fT(n),this.maxHeight=0,this.partLookup={},this.triangleSubSegments=[],this.polygonSegments=[]}updateFootprints(n,l){}populate(n,l,d,_){this.features=[],this.hasPattern=dv("fill-extrusion",this.layers,this.pixelRatio,l),this.featuresOnBorder=[],this.borderFeatureIndices=[[],[],[],[]],this.borderDoneWithNeighborZ=[-1,-1,-1,-1],this.selfDEMTileTimestamp=Number.MAX_VALUE,this.borderDEMTileTimestamp=[Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE],this.tileToMeter=o(d),this.edgeRadius=this.layers[0].layout.get("fill-extrusion-edge-radius")/this.tileToMeter,this.wallMode=this.layers[0].paint.get("fill-extrusion-line-width").constantOr(1)!==0;for(const{feature:f,id:g,index:w,sourceLayerIndex:S}of n){const P=this.layers[0]._featureFilter.needGeometry,x=U(f,P);if(!this.layers[0]._featureFilter.filter(new tr(this.zoom),x,d))continue;const I={id:g,sourceLayerIndex:S,index:w,geometry:P?x.geometry:L(f,d,_),properties:f.properties,type:f.type,patterns:{}},R=this.layoutVertexArray.length,E=wv[I.type]==="Polygon";if(this.hasPattern)this.features.push(fv("fill-extrusion",this.layers,I,this.zoom,this.pixelRatio,l));else if(this.wallMode)for(const C of I.geometry)for(const D of aT(C,E))this.addFeature(I,[D],w,d,{},l.availableImages,_,l.brightness);else this.addFeature(I,I.geometry,w,d,{},l.availableImages,_,l.brightness);l.featureIndex.insert(f,I.geometry,w,S,this.index,R)}this.sortBorders(),this.projection.name==="mercator"&&this.splitToSubtiles(),this.groundEffect.prepareBorderSegments(),this.polygonSegments.length=0}addFeatures(n,l,d,_,f,g){for(const w of this.features){const S=wv[w.type]==="Polygon",{geometry:P}=w;if(this.wallMode)for(const x of P)for(const I of aT(x,S))this.addFeature(w,[I],w.index,l,d,_,f,g);else this.addFeature(w,P,w.index,l,d,_,f,g)}this.sortBorders(),this.projection.name==="mercator"&&this.splitToSubtiles()}update(n,l,d,_,f,g,w){this.programConfigurations.updatePaintArrays(n,l,f,d,_,g,w),this.groundEffect.update(n,l,f,d,_,g,w)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(n){this.uploaded||(this.layoutVertexBuffer=n.createVertexBuffer(this.layoutVertexArray,QB),this.indexBuffer=n.createIndexBuffer(this.indexArray),this.wallVertexBuffer=n.createVertexBuffer(this.wallVertexArray,YB.members),this.layoutVertexExtArray&&(this.layoutVertexExtBuffer=n.createVertexBuffer(this.layoutVertexExtArray,JB.members,!0)),this.groundEffect.upload(n)),this.groundEffect.uploadPaintProperties(n),this.programConfigurations.upload(n),this.uploaded=!0}uploadCentroid(n){this.groundEffect.uploadHiddenByLandmark(n),this.needsCentroidUpdate&&(!this.centroidVertexBuffer&&this.centroidVertexArray.length>0?this.centroidVertexBuffer=n.createVertexBuffer(this.centroidVertexArray,ZB.members,!0):this.centroidVertexBuffer&&this.centroidVertexBuffer.updateData(this.centroidVertexArray),this.needsCentroidUpdate=!1)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.centroidVertexBuffer&&this.centroidVertexBuffer.destroy(),this.layoutVertexExtBuffer&&this.layoutVertexExtBuffer.destroy(),this.groundEffect.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(n,l,d,_,f,g,w,S){const P=this.layers[0].paint.get("fill-extrusion-flood-light-ground-radius").evaluate(n,{})/this.tileToMeter,x=[new At(0,0),new At(Rt,Rt)],I=w.projection,R=I.name==="globe",E=this.wallMode||wv[n.type]==="Polygon",C=new hT;C.centroidDataIndex=this.centroidData.length;const D=new uT,N=this.layers[0].paint.get("fill-extrusion-base").evaluate(n,{},_)<=0,z=this.layers[0].paint.get("fill-extrusion-height").evaluate(n,{},_);let G;if(D.height=z,D.vertexArrayOffset=this.layoutVertexArray.length,D.groundVertexArrayOffset=this.groundEffect.vertexArray.length,R&&!this.layoutVertexExtArray&&(this.layoutVertexExtArray=new Hc),this.wallMode){if(R)return void mi("Non zero fill-extrusion-line-width is not yet supported on globe.");if(l.length!==1)return;G=function(le){const Te=le[0].x===le[le.length-1].x&&le[0].y===le[le.length-1].y;(function(bt){let _t=0;const Ht=bt.length;for(let Ft=0;Ft<Ht;Ft++)_t+=(bt[(Ft+1)%Ht].x-bt[Ft].x)*(bt[(Ft+1)%Ht].y+bt[Ft].y);return _t>=0})(le)||(le=le.reverse());const Se={geometry:[],joinNormals:[],indices:[]},Pe=[],Me=[],Oe=[];let Ue=le.length;for(;Ue>=2&&le[Ue-1].equals(le[Ue-2]);)Ue--;if(Ue<(Te?3:2))return Se;let Ge,Ne,rt,mt,it,Bt=0;for(;Bt<Ue-1&&le[Bt].equals(le[Bt+1]);)Bt++;Te&&(Ge=le[Ue-2],it=le[Bt].sub(Ge)._unit()._perp());for(let bt=Bt;bt<Ue;bt++){if(rt=bt===Ue-1?Te?le[Bt+1]:void 0:le[bt+1],rt&&le[bt].equals(rt))continue;it&&(mt=it),Ge&&(Ne=Ge),Ge=le[bt],it=rt?rt.sub(Ge)._unit()._perp():mt,mt=mt||it;let _t=mt.add(it);_t.x===0&&_t.y===0||_t._unit();const Ht=_t.x*it.x+_t.y*it.y,Ft=Ht!==0?1/Ht:1/0,zt=mt.x*it.y-mt.y*it.x>0;let ai="miter";const fi=2;ai==="miter"&&Ft>fi&&(ai="bevel"),ai==="bevel"&&(Ft>100&&(ai="flipbevel"),Ft<fi&&(ai="miter"));const _i=(gi,wi,Ai,er)=>{const Yi=new At(gi.x,gi.y),ui=new At(gi.x,gi.y);Yi.x+=wi.x*er,Yi.y+=wi.y*er,ui.x-=wi.x*Math.max(Ai,1),ui.y-=wi.y*Math.max(Ai,1),Oe.push(wi),Pe.push(Yi),Me.push(ui)};if(ai==="miter")_t._mult(Ft),_i(Ge,_t,0,0);else if(ai==="flipbevel")_t=it.mult(-1),_i(Ge,_t,0,0),_i(Ge,_t.mult(-1),0,0);else{const gi=-Math.sqrt(Ft*Ft-1),wi=zt?gi:0,Ai=zt?0:gi;Ne&&_i(Ge,mt,wi,Ai),rt&&_i(Ge,it,wi,Ai)}}Se.geometry=[...Pe,...Me.reverse(),Pe[0]],Se.joinNormals=[...Oe,...Oe.reverse(),Oe[Oe.length-1]];const Mt=Se.geometry.length-1;for(let bt=0;bt<Mt/2;bt++)if(bt+1<Mt/2){let _t=bt,Ht=bt+1,Ft=Mt-1-bt,zt=Mt-2-bt;_t=_t===0?Mt-1:_t-1,Ht=Ht===0?Mt-1:Ht-1,Ft=Ft===0?Mt-1:Ft-1,zt=zt===0?Mt-1:zt-1,Se.indices.push(Ft),Se.indices.push(Ht),Se.indices.push(_t),Se.indices.push(Ft),Se.indices.push(zt),Se.indices.push(Ht)}return Se}(l[0]),l=[G.geometry]}const W=(le,Te)=>le<(Te.length-1)/2||le===Te.length-1,H=this.wallMode?[l]:D_(l,500);for(let le=H.length-1;le>=0;le--){const Te=H[le];(Te.length===0||(q=Te[0]).every(de=>de.x<=0)||q.every(de=>de.x>=Rt)||q.every(de=>de.y<=0)||q.every(de=>de.y>=Rt))&&H.splice(le,1)}var q;let Y;if(R)Y=xT(H,x,_);else{Y=[];for(const le of H)Y.push({polygon:le,bounds:x})}const ie=E?this.edgeRadius:0,he=ie>0&&this.zoom<17,ce=(le,Te)=>{if(le.length===0)return!1;const de=le[le.length-1];return Te.x===de.x&&Te.y===de.y};for(const{polygon:le,bounds:Te}of Y){let de=0,Se=0;for(const Ue of le)E&&!Ue[0].equals(Ue[Ue.length-1])&&Ue.push(Ue[0]),Se+=E?Ue.length-1:Ue.length;const Pe=this.segments.prepareSegment((E?5:4)*Se,this.layoutVertexArray,this.indexArray);D.footprintSegIdx<0&&(D.footprintSegIdx=this.footprintSegments.length),D.polygonSegIdx<0&&(D.polygonSegIdx=this.polygonSegments.length);const Me={triangleArrayOffset:this.indexArray.length,triangleCount:0,triangleSegIdx:this.segments.segments.length-1},Oe=new cT;if(Oe.vertexOffset=this.footprintVertices.length,Oe.indexOffset=3*this.footprintIndices.length,Oe.ringIndices=[],E){const Ue=[],Ge=[];de=Pe.vertexLength;for(let rt=0;rt<le.length;rt++){const mt=le[rt];mt.length&&rt!==0&&Ge.push(Ue.length/2);const it=[];let Bt,Mt;Bt=mt[1].sub(mt[0])._perp()._unit(),Oe.ringIndices.push(mt.length-1);for(let bt=1;bt<mt.length;bt++){const _t=mt[bt],Ht=mt[bt===mt.length-1?1:bt+1],Ft=_t.clone();if(ie){Mt=Ht.sub(_t)._perp()._unit();const zt=Bt.add(Mt)._unit(),ai=ie*Math.min(4,1/(Bt.x*zt.x+Bt.y*zt.y));Ft.x+=ai*zt.x,Ft.y+=ai*zt.y,Ft.x=Math.round(Ft.x),Ft.y=Math.round(Ft.y),Bt=Mt}if(!N||ie!==0&&!he||ce(it,Ft)||it.push(Ft),rp(this.layoutVertexArray,Ft.x,Ft.y,0,0,1,1,0),this.wallMode){const zt=W(bt,mt);np(this.wallVertexArray,G.joinNormals[bt],!zt)}Pe.vertexLength++,this.footprintVertices.emplaceBack(_t.x,_t.y),Ue.push(_t.x,_t.y),R&&sp(this.layoutVertexExtArray,I.projectTilePoint(Ft.x,Ft.y,_),I.upVector(_,Ft.x,Ft.y))}N&&(ie===0||he)&&(it.length!==0&&ce(it,it[0])&&it.pop(),this.groundEffect.addData(it,Te,P))}const Ne=this.wallMode?G.indices:Qf(Ue,Ge);for(let rt=0;rt<Ne.length;rt+=3)this.footprintIndices.emplaceBack(Oe.vertexOffset+Ne[rt+0],Oe.vertexOffset+Ne[rt+1],Oe.vertexOffset+Ne[rt+2]),this.indexArray.emplaceBack(de+Ne[rt],de+Ne[rt+2],de+Ne[rt+1]),Pe.primitiveLength++;Oe.indexCount+=Ne.length,Oe.vertexCount+=this.footprintVertices.length-Oe.vertexOffset}for(let Ue=0;Ue<le.length;Ue++){const Ge=le[Ue];C.startRing(D,Ge[0]);let Ne=Ge.length>4&&gT(Ge[Ge.length-2],Ge[0],Ge[1]),rt=ie?aD(Ge[Ge.length-2],Ge[0],Ge[1],ie):0;const mt=[];let it,Bt,Mt;Bt=Ge[1].sub(Ge[0])._perp()._unit();let bt=!0;for(let _t=1,Ht=0;_t<Ge.length;_t++){let Ft=Ge[_t-1],zt=Ge[_t];const ai=Ge[_t===Ge.length-1?1:_t+1];if(C.appendEdge(D,zt,Ft),Av(zt,Ft,Te)){ie&&(Bt=ai.sub(zt)._perp()._unit(),bt=!bt);continue}const fi=zt.sub(Ft)._perp(),_i=fi.x/(Math.abs(fi.x)+Math.abs(fi.y)),gi=fi.y>0?1:0,wi=Ft.dist(zt);if(Ht+wi>32768&&(Ht=0),ie){Mt=ai.sub(zt)._perp()._unit();let ui=mT(Ft,zt,ai,pT(Bt,Mt),ie);isNaN(ui)&&(ui=0);const Wi=zt.sub(Ft)._unit();Ft=Ft.add(Wi.mult(rt))._round(),zt=zt.add(Wi.mult(-ui))._round(),rt=ui,Bt=Mt,N&&this.zoom>=17&&(ce(mt,Ft)||mt.push(Ft),ce(mt,zt)||mt.push(zt))}const Ai=Pe.vertexLength,er=Ge.length>4&&gT(Ft,zt,ai);let Yi=yT(Ht,Ne,bt);if(rp(this.layoutVertexArray,Ft.x,Ft.y,_i,gi,0,0,Yi),rp(this.layoutVertexArray,Ft.x,Ft.y,_i,gi,0,1,Yi),this.wallMode){const ui=W(_t-1,Ge),Wi=G.joinNormals[_t-1];np(this.wallVertexArray,Wi,ui),np(this.wallVertexArray,Wi,ui)}if(Ht+=wi,Yi=yT(Ht,er,!bt),Ne=er,rp(this.layoutVertexArray,zt.x,zt.y,_i,gi,0,0,Yi),rp(this.layoutVertexArray,zt.x,zt.y,_i,gi,0,1,Yi),this.wallMode){const ui=W(_t,Ge),Wi=G.joinNormals[_t];np(this.wallVertexArray,Wi,ui),np(this.wallVertexArray,Wi,ui)}if(Pe.vertexLength+=4,this.indexArray.emplaceBack(Ai+0,Ai+1,Ai+2),this.indexArray.emplaceBack(Ai+1,Ai+3,Ai+2),Pe.primitiveLength+=2,ie){const ui=de+(_t===1?Ge.length-2:_t-2),Wi=_t===1?de:ui+1;if(this.indexArray.emplaceBack(Ai+1,ui,Ai+3),this.indexArray.emplaceBack(ui,Wi,Ai+3),Pe.primitiveLength+=2,it===void 0&&(it=Ai),!Av(ai,Ge[_t],Te)){const Zi=_t===Ge.length-1?it:Pe.vertexLength;this.indexArray.emplaceBack(Ai+2,Ai+3,Zi),this.indexArray.emplaceBack(Ai+3,Zi+1,Zi),this.indexArray.emplaceBack(Ai+3,Wi,Zi+1),Pe.primitiveLength+=3}bt=!bt}if(R){const ui=this.layoutVertexExtArray,Wi=I.projectTilePoint(Ft.x,Ft.y,_),Zi=I.projectTilePoint(zt.x,zt.y,_),ar=I.upVector(_,Ft.x,Ft.y),Cr=I.upVector(_,zt.x,zt.y);sp(ui,Wi,ar),sp(ui,Wi,ar),sp(ui,Zi,Cr),sp(ui,Zi,Cr)}}E&&(de+=Ge.length-1),N&&ie&&this.zoom>=17&&(mt.length!==0&&ce(mt,mt[0])&&mt.pop(),this.groundEffect.addData(mt,Te,P,ie>0))}this.footprintSegments.push(Oe),Me.triangleCount=this.indexArray.length-Me.triangleArrayOffset,this.polygonSegments.push(Me),++D.footprintSegLen,++D.polygonSegLen}if(D.vertexCount=this.layoutVertexArray.length-D.vertexArrayOffset,D.groundVertexCount=this.groundEffect.vertexArray.length-D.groundVertexArrayOffset,D.vertexCount!==0){if(D.centroidXY=C.borders?lT:this.encodeCentroid(C,D),this.centroidData.push(D),C.borders){this.featuresOnBorder.push(C);const le=this.featuresOnBorder.length-1;for(let Te=0;Te<C.borders.length;Te++)C.borders[Te][0]!==Number.MAX_VALUE&&this.borderFeatureIndices[Te].push(le)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,n,d,f,g,_,S),this.groundEffect.addPaintPropertiesData(n,d,f,g,_,S),this.maxHeight=Math.max(this.maxHeight,z)}}sortBorders(){for(let n=0;n<this.borderFeatureIndices.length;n++)this.borderFeatureIndices[n].sort((l,d)=>this.featuresOnBorder[l].borders[n][0]-this.featuresOnBorder[d].borders[n][0])}splitToSubtiles(){const n=[];for(let w=0;w<this.centroidData.length;w++){const S=this.centroidData[w],P=+(S.min.y+S.max.y>Rt),x=2*P+(+(S.min.x+S.max.x>Rt)^P);for(let I=0;I<S.polygonSegLen;I++){const R=S.polygonSegIdx+I;n.push({centroidIdx:w,subtile:x,polygonSegmentIdx:R,triangleSegmentIdx:this.polygonSegments[R].triangleSegIdx})}}const l=new on;n.sort((w,S)=>w.triangleSegmentIdx===S.triangleSegmentIdx?w.subtile-S.subtile:w.triangleSegmentIdx-S.triangleSegmentIdx);let d=0,_=0,f=0;for(const w of n){if(w.triangleSegmentIdx!==d)break;f++}const g=n.length;for(;_!==n.length;){d=n[_].triangleSegmentIdx;let w=0,S=_,P=_;for(let x=S;x<f&&n[x].subtile===w;x++)P++;for(;S!==f;){const x=n[S];w=x.subtile;const I=this.centroidData[x.centroidIdx].min.clone(),R=this.centroidData[x.centroidIdx].max.clone(),E={vertexOffset:this.segments.segments[d].vertexOffset,primitiveOffset:l.length,vertexLength:this.segments.segments[d].vertexLength,primitiveLength:0,sortKey:void 0,vaos:{}};for(let C=S;C<P;C++){const D=n[C],N=this.polygonSegments[D.polygonSegmentIdx],z=this.centroidData[D.centroidIdx].min,G=this.centroidData[D.centroidIdx].max,W=this.indexArray.uint16;for(let H=N.triangleArrayOffset;H<N.triangleArrayOffset+N.triangleCount;H++)l.emplaceBack(W[3*H],W[3*H+1],W[3*H+2]);E.primitiveLength+=N.triangleCount,I.x=Math.min(I.x,z.x),I.y=Math.min(I.y,z.y),R.x=Math.max(R.x,G.x),R.y=Math.max(R.y,G.y)}E.primitiveLength>0&&this.triangleSubSegments.push({segment:E,min:I,max:R}),S=P;for(let C=S;C<f&&n[C].subtile===n[S].subtile;C++)P++}_=f;for(let x=_;x<g&&n[x].triangleSegmentIdx===n[_].triangleSegmentIdx;x++)f++}l._trim(),this.indexArray=l}getVisibleSegments(n,l,d){const _=new Ar;if(this.wallMode){for(const D of this.triangleSubSegments)_.segments.push(D.segment);return _}let f=0,g=0;const w=1<<n.canonical.z;if(l){const D=l.getMinMaxForTile(n);D&&(f=D.min,g=D.max)}g+=this.maxHeight;const S=n.toUnwrapped();let P;const x=[S.canonical.x/w+S.wrap,S.canonical.y/w],I=[(S.canonical.x+1)/w+S.wrap,(S.canonical.y+1)/w],R=(D,N,z)=>[D[0]*(1-z[0])+N[0]*z[0],D[1]*(1-z[1])+N[1]*z[1]],E=[],C=[];for(const D of this.triangleSubSegments){E[0]=D.min.x/Rt,E[1]=D.min.y/Rt,C[0]=D.max.x/Rt,C[1]=D.max.y/Rt;const N=R(x,I,E),z=R(x,I,C);if(new Wt([N[0],N[1],f],[z[0],z[1],g]).intersectsPrecise(d)===0){P&&(_.segments.push(P),P=void 0);continue}const G=D.segment;P&&P.vertexOffset!==G.vertexOffset&&(_.segments.push(P),P=void 0),P?(P.vertexLength+=G.vertexLength,P.primitiveLength+=G.primitiveLength):P={vertexOffset:G.vertexOffset,primitiveLength:G.primitiveLength,vertexLength:G.vertexLength,primitiveOffset:G.primitiveOffset,sortKey:void 0,vaos:{}}}return P&&_.segments.push(P),_}encodeCentroid(n,l){const d=n.centroid(),_=l.span(),f=Math.min(7,Math.round(_.x*this.tileToMeter/10)),g=Math.min(7,Math.round(_.y*this.tileToMeter/10));return new At(yi(d.x,1,Rt-1)<<3|f,yi(d.y,1,Rt-1)<<3|g)}encodeBorderCentroid(n){if(!n.borders)return new At(0,0);const l=n.borders,d=Number.MAX_VALUE;if(l[0][0]!==d||l[1][0]!==d){const _=l[0][0]!==d?0:1;return new At(6|(l[0][0]!==d?0:65528),(l[_][0]+l[_][1])/2<<3|6)}{const _=l[2][0]!==d?2:3;return new At((l[_][0]+l[_][1])/2<<3|6,6|(l[2][0]!==d?0:65528))}}showCentroid(n){const l=this.centroidData[n.centroidDataIndex];l.flags&=zl,l.centroidXY.x=0,l.centroidXY.y=0,this.writeCentroidToBuffer(l)}writeCentroidToBuffer(n){this.groundEffect.updateHiddenByLandmark(n);const l=n.vertexArrayOffset,d=n.vertexCount+n.vertexArrayOffset,_=n.flags&zl?lT:n.centroidXY,f=this.centroidVertexArray.geta_centroid_pos0(l);if(this.centroidVertexArray.geta_centroid_pos1(l)!==_.y||f!==_.x){for(let g=l;g<d;++g)this.centroidVertexArray.emplace(g,_.x,_.y);this.needsCentroidUpdate=!0}}createCentroidsBuffer(){this.centroidVertexArray.resize(this.layoutVertexArray.length),this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(const n of this.centroidData)this.writeCentroidToBuffer(n)}updateReplacement(n,l,d){if(l.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=l.updateTime;const _=l.getReplacementRegionsForTile(n.toUnwrapped());if(xv(this.activeReplacements,_))return;if(this.activeReplacements=_,this.centroidVertexArray.length===0)this.createCentroidsBuffer();else for(const g of this.centroidData)g.flags&=2147483647;const f=[];for(const g of this.activeReplacements){if(g.order<d)continue;const w=Math.max(1,Math.pow(2,g.footprintTileId.canonical.z-n.canonical.z));for(const S of this.centroidData)if(!(S.flags&zl||g.min.x>S.max.x||S.min.x>g.max.x||g.min.y>S.max.y||S.min.y>g.max.y))for(let P=0;P<S.footprintSegLen;P++){const x=this.footprintSegments[S.footprintSegIdx+P];if(f.length=0,lD(this.footprintVertices,x.vertexOffset,x.vertexCount,g.footprintTileId.canonical,n.canonical,f),rT(g.footprint,f,this.footprintIndices.uint16,x.indexOffset,x.indexCount,-x.vertexOffset,-w)){S.flags|=zl;break}}}for(const g of this.centroidData)this.writeCentroidToBuffer(g);this.borderDoneWithNeighborZ=[-1,-1,-1,-1]}footprintContainsPoint(n,l,d){let _=!1;for(let f=0;f<d.footprintSegLen;f++){const g=this.footprintSegments[d.footprintSegIdx+f];let w=0;for(const S of g.ringIndices){for(let P=w,x=S+w-1;P<S+w;x=P++){const I=this.footprintVertices.int16[2*(P+g.vertexOffset)+0],R=this.footprintVertices.int16[2*(P+g.vertexOffset)+1],E=this.footprintVertices.int16[2*(x+g.vertexOffset)+1];R>l!=E>l&&n<(this.footprintVertices.int16[2*(x+g.vertexOffset)+0]-I)*(l-R)/(E-R)+I&&(_=!_)}w=S}}return _}getHeightAtTileCoord(n,l){let d=Number.NEGATIVE_INFINITY,_=!0;const f=4*(n+Rt)*Rt+(l+Rt);if(this.partLookup.hasOwnProperty(f)){const g=this.partLookup[f];return g?{height:g.height,hidden:!!(g.flags&zl)}:void 0}for(const g of this.centroidData)n>g.max.x||g.min.x>n||l>g.max.y||g.min.y>l||this.footprintContainsPoint(n,l,g)&&g&&g.height>d&&(d=g.height,this.partLookup[f]=g,_=!!(g.flags&zl));if(d!==Number.NEGATIVE_INFINITY)return{height:d,hidden:_};this.partLookup[f]=void 0}}function pT(u,n){const l=u.add(n)._unit();return u.x*l.x+u.y*l.y}function aD(u,n,l,d){const _=n.sub(u)._perp()._unit(),f=l.sub(n)._perp()._unit();return mT(u,n,l,pT(_,f),d)}function mT(u,n,l,d,_){const f=Math.sqrt(1-d*d);return Math.min(u.dist(n)/3,n.dist(l)/3,_*f/d)}function Av(u,n,l){return u.x<l[0].x&&n.x<l[0].x||u.x>l[1].x&&n.x>l[1].x||u.y<l[0].y&&n.y<l[0].y||u.y>l[1].y&&n.y>l[1].y}function _T(u,n){return u.x<n[0].x||u.x>n[1].x||u.y<n[0].y||u.y>n[1].y}function gT(u,n,l){if(u.x<0||u.x>=Rt||n.x<0||n.x>=Rt||l.x<0||l.x>=Rt)return!1;const d=l.sub(n),_=d.perp(),f=u.sub(n);return(d.x*f.x+d.y*f.y)/Math.sqrt((d.x*d.x+d.y*d.y)*(f.x*f.x+f.y*f.y))>-.866&&_.x*f.x+_.y*f.y<0}function yT(u,n,l){const d=n?2|u:-3&u;return l?1|d:-2&d}function vT(){const u=Math.PI/32,n=Math.tan(u),l=$a;return l*Math.sqrt(1+2*n*n)-l}function xT(u,n,l){const d=1<<l.z,_=es(l.x/d),f=es((l.x+1)/d),g=an(l.y/d),w=an((l.y+1)/d);return function(S,P,x,I,R=0,E){const C=[];if(!S.length||!x||!I)return C;const D=(Y,ie)=>{for(const he of Y)C.push({polygon:he,bounds:ie})},N=Math.ceil(Math.log2(x)),z=Math.ceil(Math.log2(I)),G=N-z,W=[];for(let Y=0;Y<Math.abs(G);Y++)W.push(G>0?0:1);for(let Y=0;Y<Math.min(N,z);Y++)W.push(0),W.push(1);let H=S;if(H=F_(H,P[0].y-R,P[1].y+R,1),H=F_(H,P[0].x-R,P[1].x+R,0),!H.length)return C;const q=[];for(W.length?q.push({polygons:H,bounds:P,depth:0}):D(H,P);q.length;){const Y=q.pop(),ie=Y.depth,he=W[ie],ce=Y.bounds[0],le=Y.bounds[1],Te=he===0?ce.x:ce.y,de=he===0?le.x:le.y,Se=E?E(he,Te,de):.5*(Te+de),Pe=F_(Y.polygons,Te-R,Se+R,he),Me=F_(Y.polygons,Se-R,de+R,he);if(Pe.length){const Oe=[ce,new At(he===0?Se:le.x,he===1?Se:le.y)];W.length>ie+1?q.push({polygons:Pe,bounds:Oe,depth:ie+1}):D(Pe,Oe)}if(Me.length){const Oe=[new At(he===0?Se:ce.x,he===1?Se:ce.y),le];W.length>ie+1?q.push({polygons:Me,bounds:Oe,depth:ie+1}):D(Me,Oe)}}return C}(u,n,Math.ceil((f-_)/11.25),Math.ceil((g-w)/11.25),1,(S,P,x)=>{if(S===0)return .5*(P+x);{const I=an((l.y+P/Rt)/d);return(ks(.5*(an((l.y+x/Rt)/d)+I))*d-l.y)*Rt}})}function lD(u,n,l,d,_,f){const g=Math.pow(2,d.z-_.z);for(let w=0;w<l;w++){let S=u.int16[2*(w+n)+0],P=u.int16[2*(w+n)+1];S=(S+_.x*Rt)*g-d.x*Rt,P=(P+_.y*Rt)*g-d.y*Rt,f.push(new At(S,P))}}let bT,wT;function op(u,n){return u.x*n.x+u.y*n.y}function AT(u,n){if(u.length===1){let l=0;const d=n[l++];let _;for(;!_||d.equals(_);)if(_=n[l++],!_)return 1/0;for(;l<n.length;l++){const f=n[l],g=u[0],w=_.sub(d),S=f.sub(d),P=g.sub(d),x=op(w,w),I=op(w,S),R=op(S,S),E=op(P,w),C=op(P,S),D=x*R-I*I,N=(R*E-I*C)/D,z=(x*C-I*E)/D,G=d.z*(1-N-z)+_.z*N+f.z*z;if(isFinite(G))return G}return 1/0}{let l=1/0;for(const d of n)l=Math.min(l,d.z);return l}}function TT(u,n,l,d,_,f,g,w){const S=g*_.getElevationAt(u,n,!0,!0),P=f[0]!==0,x=P?f[1]===0?g*(f[0]/7-450):g*function(I,R,E){const C=Math.floor(R[0]/8),D=Math.floor(R[1]/8),N=10*(R[0]-8*C),z=10*(R[1]-8*D),G=I.getElevationAt(C,D,!0,!0),W=I.getMeterToDEM(E),H=Math.floor(.5*(N*W-1)),q=Math.floor(.5*(z*W-1)),Y=I.tileCoordToPixel(C,D),ie=2*H+1,he=2*q+1,ce=function(Me,Oe,Ue,Ge,Ne){return[Me.getElevationAtPixel(Oe,Ue,!0),Me.getElevationAtPixel(Oe+Ne,Ue,!0),Me.getElevationAtPixel(Oe,Ue+Ne,!0),Me.getElevationAtPixel(Oe+Ge,Ue+Ne,!0)]}(I,Y.x-H,Y.y-q,ie,he),le=Math.abs(ce[0]-ce[1]),Te=Math.abs(ce[2]-ce[3]),de=Math.abs(ce[0]-ce[2])+Math.abs(ce[1]-ce[3]),Se=Math.min(.25,.5*W*(le+Te)/ie),Pe=Math.min(.25,.5*W*de/he);return G+Math.max(Se*N,Pe*z)}(_,f,w):S;return{base:S+(l===0?-1:l),top:P?Math.max(x+d,S+l+2):S+d}}Vt(z_,"FillExtrusionBucket",{omit:["layers","features"]}),Vt(uT,"PartData"),Vt(cT,"FootprintSegment"),Vt(hT,"BorderCentroidData"),Vt(fT,"GroundEffect");const cD=ji([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"},{name:"a_linesofar",components:1,type:"Float32"}],4),uD=ji([{name:"a_z_offset_width",components:3,type:"Float32"}],4),{members:hD}=cD,dD=ji([{name:"a_packed",components:3,type:"Float32"}]),{members:fD}=dD,pD=ji([{name:"a_pattern_data",components:3,type:"Float32"}]),{members:mD}=pD;class ET{constructor(n,l){this.width=n,this.height=l,this.nextRow=0,this.image=new Nl({width:n,height:l}),this.positions={},this.uploaded=!1}getDash(n,l){const d=this.getKey(n,l);return this.positions[d]}trim(){const n=this.width,l=this.height=nl(this.nextRow);this.image.resize({width:n,height:l})}getKey(n,l){return n.join(",")+l}getDashRanges(n,l,d){const _=[];let f=n.length%2==1?-n[n.length-1]*d:0,g=n[0]*d,w=!0;_.push({left:f,right:g,isDash:w,zeroLength:n[0]===0});let S=n[0];for(let P=1;P<n.length;P++){w=!w;const x=n[P];f=S*d,S+=x,g=S*d,_.push({left:f,right:g,isDash:w,zeroLength:x===0})}return _}addRoundDash(n,l,d){const _=l/2;for(let f=-d;f<=d;f++){const g=this.width*(this.nextRow+d+f);let w=0,S=n[w];for(let P=0;P<this.width;P++){P/S.right>1&&(S=n[++w]);const x=Math.abs(P-S.left),I=Math.abs(P-S.right),R=Math.min(x,I);let E;const C=f/d*(_+1);if(S.isDash){const D=_-Math.abs(C);E=Math.sqrt(R*R+D*D)}else E=_-Math.sqrt(R*R+C*C);this.image.data[g+P]=Math.max(0,Math.min(255,E+128))}}}addRegularDash(n,l){for(let S=n.length-1;S>=0;--S){const P=n[S],x=n[S+1];P.zeroLength?n.splice(S,1):x&&x.isDash===P.isDash&&(x.left=P.left,n.splice(S,1))}const d=n[0],_=n[n.length-1];d.isDash===_.isDash&&(d.left=_.left-this.width,_.right=d.right+this.width);const f=this.width*this.nextRow;let g=0,w=n[g];for(let S=0;S<this.width;S++){S/w.right>1&&(w=n[++g]);const P=Math.abs(S-w.left),x=Math.abs(S-w.right),I=Math.min(P,x);this.image.data[f+S]=Math.max(0,Math.min(255,(w.isDash?I:-I)+l+128))}}addDash(n,l){const d=this.getKey(n,l);if(this.positions[d])return this.positions[d];const _=l==="round",f=_?7:0,g=2*f+1;if(this.nextRow+g>this.height)return mi("LineAtlas out of space"),null;n.length===0&&n.push(1);let w=0;for(let x=0;x<n.length;x++)n[x]<0&&(mi("Negative value is found in line dasharray, replacing values with 0"),n[x]=0),w+=n[x];if(w!==0){const x=this.width/w,I=this.getDashRanges(n,this.width,x);_?this.addRoundDash(I,x,f):this.addRegularDash(I,l==="square"?.5*x:0)}const S=this.nextRow+f;this.nextRow+=g;const P={tl:[S,f],br:[w,0]};return this.positions[d]=P,P}}Vt(ET,"LineAtlas");const _D=Oh.VectorTileFeature.types,gD=Math.cos(Math.PI/180*37.5),yD=Math.cos(Math.PI/180*5);class Tv{constructor(n){this.evaluationGlobals={zoom:0,lineProgress:void 0},this.zoom=n.zoom,this.evaluationGlobals.zoom=this.zoom,this.overscaling=n.overscaling,this.pixelRatio=n.pixelRatio,this.layers=n.layers,this.layerIds=this.layers.map(l=>l.fqid),this.index=n.index,this.projection=n.projection,this.hasPattern=!1,this.hasZOffset=!1,this.hasCrossSlope=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach(l=>{this.gradients[l.id]={}}),this.layoutVertexArray=new jc,this.layoutVertexArray2=new io,this.patternVertexArray=new io,this.indexArray=new on,this.programConfigurations=new ua(n.layers,{zoom:n.zoom,lut:n.lut}),this.segments=new Ar,this.maxLineLength=0,this.zOffsetVertexArray=new io,this.stateDependentLayerIds=this.layers.filter(l=>l.isStateDependent()).map(l=>l.id),this.tessellationStep=n.tessellationStep?n.tessellationStep:Rt/64}updateFootprints(n,l){}populate(n,l,d,_){this.hasPattern=dv("line",this.layers,this.pixelRatio,l);const f=this.layers[0].layout.get("line-sort-key");this.tileToMeter=o(d);const g=this.layers[0].layout.get("line-z-offset"),w=g.isConstant()&&!g.constantOr(0),S=this.layers[0].layout.get("line-elevation-reference");this.hasZOffset=S==="sea"||S==="ground"||!w&&S==="none",this.hasZOffset&&S==="none"&&mi(`line-elevation-reference: ground is used for the layer ${this.layerIds[0]} because non-zero line-z-offset value was found.`);const P=this.layers[0].layout.get("line-cross-slope");this.hasCrossSlope=this.hasZOffset&&P!==void 0;const x=[];for(const{feature:C,id:D,index:N,sourceLayerIndex:z}of n){const G=this.layers[0]._featureFilter.needGeometry,W=U(C,G);if(!this.layers[0]._featureFilter.filter(new tr(this.zoom),W,d))continue;const H=f?f.evaluate(W,{},d):void 0,q={id:D,properties:C.properties,type:C.type,sourceLayerIndex:z,index:N,geometry:G?W.geometry:L(C,d,_),patterns:{},sortKey:H};x.push(q)}f&&x.sort((C,D)=>C.sortKey-D.sortKey);const{lineAtlas:I,featureIndex:R}=l,E=this.addConstantDashes(I);for(const C of x){const{geometry:D,index:N,sourceLayerIndex:z}=C;if(E&&this.addFeatureDashes(C,I),this.hasPattern){const G=fv("line",this.layers,C,this.zoom,this.pixelRatio,l);this.patternFeatures.push(G)}else this.addFeature(C,D,N,d,I.positions,l.availableImages,l.brightness);R.insert(n[N].feature,D,N,z,this.index)}}addConstantDashes(n){let l=!1;for(const d of this.layers){const _=d.paint.get("line-dasharray").value,f=d.layout.get("line-cap").value;if(_.kind!=="constant"||f.kind!=="constant")l=!0;else{const g=f.value,w=_.value;if(!w)continue;n.addDash(w,g)}}return l}addFeatureDashes(n,l){const d=this.zoom;for(const _ of this.layers){const f=_.paint.get("line-dasharray").value,g=_.layout.get("line-cap").value;if(f.kind==="constant"&&g.kind==="constant")continue;let w,S;if(f.kind==="constant"){if(w=f.value,!w)continue}else w=f.evaluate({zoom:d},n);S=g.kind==="constant"?g.value:g.evaluate({zoom:d},n),l.addDash(w,S),n.patterns[_.id]=l.getKey(w,S)}}update(n,l,d,_,f,g,w){this.programConfigurations.updatePaintArrays(n,l,f,d,_,g,w)}addFeatures(n,l,d,_,f,g){for(const w of this.patternFeatures)this.addFeature(w,w.geometry,w.index,l,d,_,g)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(n){this.uploaded||(this.layoutVertexArray2.length!==0&&(this.layoutVertexBuffer2=n.createVertexBuffer(this.layoutVertexArray2,fD)),this.patternVertexArray.length!==0&&(this.patternVertexBuffer=n.createVertexBuffer(this.patternVertexArray,mD)),!this.zOffsetVertexBuffer&&this.zOffsetVertexArray.length>0&&(this.zOffsetVertexBuffer=n.createVertexBuffer(this.zOffsetVertexArray,uD.members,!0)),this.layoutVertexBuffer=n.createVertexBuffer(this.layoutVertexArray,hD),this.indexBuffer=n.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(n),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy(),this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(n){if(n.properties&&n.properties.hasOwnProperty("mapbox_clip_start")&&n.properties.hasOwnProperty("mapbox_clip_end"))return{start:+n.properties.mapbox_clip_start,end:+n.properties.mapbox_clip_end}}addFeature(n,l,d,_,f,g,w){const S=this.layers[0].layout,P=S.get("line-join").evaluate(n,{}),x=S.get("line-cap").evaluate(n,{}),I=S.get("line-miter-limit"),R=S.get("line-round-limit");this.lineClips=this.lineFeatureClips(n),this.lineFeature=n,this.zOffsetValue=S.get("line-z-offset").value;const E=this.layers[0].paint.get("line-width").value;E.kind!=="constant"&&E.isLineProgressConstant===!1&&(this.variableWidthValue=E);for(const C of l)this.addLine(C,n,_,P,x,I,R);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,n,d,f,g,_,w)}addLine(n,l,d,_,f,g,w){this.distance=0,this.prevDistance=0,this.scaledDistance=0,this.totalDistance=0,this.totalFeatureLength=0,this.lineSoFar=0,this.currentVertex=void 0;const S=_==="none";if(this.patternJoinNone=this.hasPattern&&S,this.segmentStart=0,this.segmentStartf32=0,this.segmentPoints=[],this.lineClips){this.lineClipsArray.push(this.lineClips);for(let W=0;W<n.length-1;W++)this.totalDistance+=n[W].dist(n[W+1]);this.totalFeatureLength=this.totalDistance/(this.lineClips.end-this.lineClips.start),this.updateScaledDistance(),this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}const P=_D[l.type]==="Polygon";let x=n.length;for(;x>=2&&n[x-1].equals(n[x-2]);)x--;let I=0;for(;I<x-1&&n[I].equals(n[I+1]);)I++;if(x<(P?3:2))return;_==="bevel"&&(g=1.05);const R=this.segments.prepareSegment(10*x,this.layoutVertexArray,this.indexArray);let E,C,D,N,z,G;this.e1=this.e2=-1,P&&(E=n[x-2],z=n[I].sub(E)._unit()._perp());for(let W=I;W<x;W++){if(D=W===x-1?P?n[I+1]:void 0:n[W+1],D&&n[W].equals(D))continue;z&&(N=z),E&&(C=E),E=n[W],G=this.evaluateLineProgressFeatures(C?C.dist(E):0),z=D?D.sub(E)._unit()._perp():N,N=N||z;const H=C&&D;let q=H?_:P||S?"butt":f;const Y=N.x*z.x+N.y*z.y;if(S){const Pe=function(Me){if(Me.patternJoinNone){const Oe=Me.segmentPoints.length/2,Ue=Me.lineSoFar-Me.segmentStart;for(let Ge=0;Ge<Oe;++Ge){const Ne=Me.segmentPoints[2*Ge+1],rt=Math.round(Me.segmentPoints[2*Ge])+.5+.25*Ne;Me.patternVertexArray.emplaceBack(rt,Ue,Me.segmentStart),Me.patternVertexArray.emplaceBack(rt,Ue,Me.segmentStart)}Me.segmentPoints.length=0}Me.e1=Me.e2=-1};if(H&&Y<yD){this.updateDistance(C,E),this.addCurrentVertex(E,N,1,1,R,G),Pe(this),this.addCurrentVertex(E,z,-1,-1,R,G);continue}if(C){if(!D){this.updateDistance(C,E),this.addCurrentVertex(E,N,1,1,R,G),Pe(this);continue}q="miter"}}let ie=N.add(z);ie.x===0&&ie.y===0||ie._unit();const he=ie.x*z.x+ie.y*z.y,ce=he!==0?1/he:1/0,le=2*Math.sqrt(2-2*he),Te=he<gD&&C&&D,de=N.x*z.y-N.y*z.x>0,Se=this.overscaling<=16?15*Rt/(512*this.overscaling):0;if(H&&q==="round"){if(ce<w)q="miter";else if(ce<=2){const Pe=Ev(E,-10,Rt+10);q=this.hasZOffset&&(Pe||this.hasCrossSlope)?"miter":"fakeround"}}if(q==="miter"&&ce>g&&(q="bevel"),q==="bevel"&&(ce>2&&(q="flipbevel"),ce<g&&(q="miter")),C&&!(q==="miter"&&Te)&&this.updateDistance(C,E),q==="miter")if(Te){const Pe=E.dist(C);if(Pe>2*Se){const Oe=E.sub(E.sub(C)._mult(Se/Pe)._round());this.updateDistance(C,Oe),this.addCurrentVertex(Oe,N,0,0,R,G),C=Oe}this.updateDistance(C,E),ie._mult(ce),this.addCurrentVertex(E,ie,0,0,R,G);const Me=E.dist(D);if(Me>2*Se){const Oe=E.add(D.sub(E)._mult(Se/Me)._round());this.updateDistance(E,Oe),this.addCurrentVertex(Oe,z,0,0,R,G),E=Oe}}else ie._mult(ce),this.addCurrentVertex(E,ie,0,0,R,G);else if(q==="flipbevel"){if(ce>100)ie=z.mult(-1);else{const Pe=ce*N.add(z).mag()/N.sub(z).mag();ie._perp()._mult(Pe*(de?-1:1))}this.addCurrentVertex(E,ie,0,0,R,G),this.addCurrentVertex(E,ie.mult(-1),0,0,R,G)}else if(q==="bevel"||q==="fakeround"){G!=null&&C&&this.addCurrentVertex(E,N,-1,-1,R,G);const Pe=E.dist(C)<=2*Se&&q!=="bevel",Me=ie.mult(de?1:-1);Me._mult(ce);const Oe=z.mult(de?-1:1),Ue=N.mult(de?-1:1),Ge=this.evaluateLineProgressFeatures(this.distance);if(G==null&&(this.addHalfVertex(E,Me.x,Me.y,!1,!de,0,R,Ge),Pe||this.addHalfVertex(E,Me.x+2*Ue.x,Me.y+2*Ue.y,!1,de,0,R,Ge)),q==="fakeround"){const Ne=Math.round(180*le/Math.PI/20);this.addHalfVertex(E,Ue.x,Ue.y,!1,de,0,R,Ge);for(let rt=0;rt<Ne;rt++){let mt=rt/Ne;if(mt!==.5){const Bt=mt-.5;mt+=mt*Bt*(mt-1)*((1.0904+Y*(Y*(3.55645-1.43519*Y)-3.2452))*Bt*Bt+(.848013+Y*(.215638*Y-1.06021)))}const it=Oe.sub(Ue)._mult(mt)._add(Ue)._unit();this.addHalfVertex(E,it.x,it.y,!1,de,0,R,Ge)}this.addHalfVertex(E,Oe.x,Oe.y,!1,de,0,R,Ge)}Pe||G!=null||this.addHalfVertex(E,Me.x+2*Oe.x,Me.y+2*Oe.y,!1,de,0,R,Ge),G!=null&&D&&this.addCurrentVertex(E,z,1,1,R,G)}else q==="butt"?this.addCurrentVertex(E,ie,0,0,R,G):q==="square"?(C||this.addCurrentVertex(E,ie,-1,-1,R,G),this.addCurrentVertex(E,ie,0,0,R,G),C&&this.addCurrentVertex(E,ie,1,1,R,G)):q==="round"&&(C&&(this.addCurrentVertex(E,N,0,0,R,G),this.addCurrentVertex(E,N,1,1,R,G,!0)),D&&(this.addCurrentVertex(E,z,-1,-1,R,G,!0),this.addCurrentVertex(E,z,0,0,R,G)))}}addVerticesTo(n,l,d,_,f,g,w,S,P,x){const I=(l.w-n.w)/this.tessellationStep|0;let R=0;const E=this.scaledDistance;if(I>1){this.lineSoFar=n.w;const D=(l.x-n.x)/I,N=(l.y-n.y)/I,z=(l.z-n.z)/I,G=(l.w-n.w)/I;for(let W=1;W<I;++W){n.x+=D,n.y+=N,n.z+=z,this.lineSoFar+=G,R+=G;const H=this.evaluateLineProgressFeatures(this.prevDistance+R);this.scaledDistance=(this.prevDistance+R)/this.totalDistance,this.addHalfVertex(n,d,_,x,!1,w,P,H),this.addHalfVertex(n,f,g,x,!0,-S,P,H)}}this.lineSoFar=l.w,this.scaledDistance=E;const C=this.evaluateLineProgressFeatures(this.distance);this.addHalfVertex(l,d,_,x,!1,w,P,C),this.addHalfVertex(l,f,g,x,!0,-S,P,C)}evaluateLineProgressFeatures(n){if(!this.variableWidthValue&&!this.hasZOffset)return null;this.evaluationGlobals.lineProgress=0,this.lineClips?this.evaluationGlobals.lineProgress=Math.min(1,(this.totalFeatureLength*this.lineClips.start+n)/this.totalFeatureLength):mi(`line-progress evaluation for ${this.layerIds[0]} requires enabling 'lineMetrics' for the source.`);let l=0;return this.variableWidthValue&&this.variableWidthValue.kind!=="constant"&&(l=this.variableWidthValue.evaluate(this.evaluationGlobals,this.lineFeature)||0),this.hasZOffset?this.zOffsetValue.kind==="constant"?{zOffset:this.zOffsetValue.value,variableWidth:l}:{zOffset:this.zOffsetValue.evaluate(this.evaluationGlobals,this.lineFeature)||0,variableWidth:l}:{zOffset:0,variableWidth:l}}addCurrentVertex(n,l,d,_,f,g,w=!1){const S=l.x+l.y*d,P=l.y-l.x*d,x=l.y*_-l.x,I=-l.y-l.x*_;if(g!=null){const R=this.hasZOffset,E=-10,C=Rt+10,D=g.zOffset,N=new KA(n.x,n.y,D,this.lineSoFar),z=!!R&&Ev(n,E,C),G=this.lineSoFar,W=this.distance;if(this.currentVertex)if(z){const H=this.currentVertexIsOutside,q=this.currentVertex,Y=new KA(n.x,n.y,D,this.lineSoFar);if(QA(q,Y,E,C),!Ev(Y,E,C)){if(H){this.e1=this.e2=-1,this.distance-=q.dist(N),this.lineSoFar=q.w;const ie=this.evaluateLineProgressFeatures(q.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(q,S,P,w,!1,d,f,ie),this.addHalfVertex(q,x,I,w,!0,-_,f,ie),this.prevDistance=this.distance}this.distance=this.prevDistance+q.dist(Y),this.scaledDistance=this.distance/this.totalDistance,this.addVerticesTo(q,Y,S,P,x,I,d,_,f,w),this.distance=W,this.scaledDistance=this.distance/this.totalDistance}}else{const H=this.currentVertex;if(this.currentVertexIsOutside){QA(H,N,E,C),this.e1=this.e2=-1,this.distance-=H.dist(N),this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=H.w;const q=this.evaluateLineProgressFeatures(H.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(H,S,P,w,!1,d,f,q),this.addHalfVertex(H,x,I,w,!0,-_,f,q),this.prevDistance=this.distance,this.distance=W,this.scaledDistance=this.distance/this.totalDistance}this.addVerticesTo(H,N,S,P,x,I,d,_,f,w)}else z||(this.addHalfVertex(n,S,P,w,!1,d,f,g),this.addHalfVertex(n,x,I,w,!0,-_,f,g));this.currentVertex=N,this.currentVertexIsOutside=z,this.lineSoFar=G}else this.addHalfVertex(n,S,P,w,!1,d,f,g),this.addHalfVertex(n,x,I,w,!0,-_,f,g)}addHalfVertex({x:n,y:l},d,_,f,g,w,S,P){if(this.patternJoinNone&&(this.segmentPoints.length===0&&(this.segmentStart=this.lineSoFar,this.segmentStartf32=Math.fround(this.lineSoFar)),g||this.segmentPoints.push(this.lineSoFar-this.segmentStart,w)),this.layoutVertexArray.emplaceBack((n<<1)+(f?1:0),(l<<1)+(g?1:0),Math.round(63*d)+128,Math.round(63*_)+128,1+(w===0?0:w<0?-1:1),0,this.lineSoFar-this.segmentStartf32),this.lineClips){const I=ii(this.lineClips.start,this.lineClips.end,this.scaledDistance);this.layoutVertexArray2.emplaceBack(this.scaledDistance,this.lineClipsArray.length,I)}const x=S.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,x),S.primitiveLength++),g?this.e2=x:this.e1=x,P!=null&&this.zOffsetVertexArray.emplaceBack(P.zOffset,P.variableWidth,P.variableWidth)}updateScaledDistance(){this.lineClips?(this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=this.totalFeatureLength*this.lineClips.start+this.distance):this.lineSoFar=this.distance}updateDistance(n,l){this.prevDistance=this.distance,this.distance+=n.dist(l),this.updateScaledDistance()}}function Ev(u,n,l){return u.x<n||u.x>l||u.y<n||u.y>l}let ST,IT;function CT(u,n,l){return n*(Rt/(u.tileSize*Math.pow(2,l-u.tileID.overscaledZ)))}Vt(Tv,"LineBucket",{omit:["layers","patternFeatures","currentVertex","currentVertexIsOutside"]});const MT=(u,n,l)=>(1-l)*u+l*n;function RT(u,n){return 1/CT(u,1,n.tileZoom)}function PT(u,n,l,d){return u.translatePosMatrix(d||n.tileID.projMatrix,n,l.paint.get("line-translate"),l.paint.get("line-translate-anchor"))}const BT=u=>{const n=[];DT(u)&&n.push("RENDER_LINE_DASH"),u.paint.get("line-gradient")&&n.push("RENDER_LINE_GRADIENT");const l=u.paint.get("line-trim-offset");l[0]===0&&l[1]===0||n.push("RENDER_LINE_TRIM_OFFSET"),u.paint.get("line-border-width").constantOr(1)!==0&&n.push("RENDER_LINE_BORDER");const d=u.layout.get("line-join").constantOr("miter")==="none",_=!!u.paint.get("line-pattern").constantOr(1);return d&&_&&n.push("LINE_JOIN_NONE"),n};function DT(u){const n=u.paint.get("line-dasharray").value;return n.value||n.kind!=="constant"}let Sv;const OT=()=>Sv||(Sv={layout:ST||(ST=new cr({"line-cap":new Nt(qe.layout_line["line-cap"]),"line-join":new Nt(qe.layout_line["line-join"]),"line-miter-limit":new wt(qe.layout_line["line-miter-limit"]),"line-round-limit":new wt(qe.layout_line["line-round-limit"]),"line-sort-key":new Nt(qe.layout_line["line-sort-key"]),"line-z-offset":new Nt(qe.layout_line["line-z-offset"]),"line-elevation-reference":new wt(qe.layout_line["line-elevation-reference"]),"line-cross-slope":new wt(qe.layout_line["line-cross-slope"]),visibility:new wt(qe.layout_line.visibility),"line-width-unit":new wt(qe.layout_line["line-width-unit"])})),paint:IT||(IT=new cr({"line-opacity":new Nt(qe.paint_line["line-opacity"]),"line-color":new Nt(qe.paint_line["line-color"]),"line-translate":new wt(qe.paint_line["line-translate"]),"line-translate-anchor":new wt(qe.paint_line["line-translate-anchor"]),"line-width":new Nt(qe.paint_line["line-width"]),"line-gap-width":new Nt(qe.paint_line["line-gap-width"]),"line-offset":new Nt(qe.paint_line["line-offset"]),"line-blur":new Nt(qe.paint_line["line-blur"]),"line-dasharray":new Nt(qe.paint_line["line-dasharray"]),"line-pattern":new Nt(qe.paint_line["line-pattern"]),"line-gradient":new Cl(qe.paint_line["line-gradient"]),"line-trim-offset":new wt(qe.paint_line["line-trim-offset"]),"line-trim-fade-range":new wt(qe.paint_line["line-trim-fade-range"]),"line-trim-color":new wt(qe.paint_line["line-trim-color"]),"line-emissive-strength":new wt(qe.paint_line["line-emissive-strength"]),"line-border-width":new Nt(qe.paint_line["line-border-width"]),"line-border-color":new Nt(qe.paint_line["line-border-color"]),"line-occlusion-opacity":new wt(qe.paint_line["line-occlusion-opacity"]),"line-color-use-theme":new Nt({type:"string",default:"default","property-type":"data-driven"}),"line-gradient-use-theme":new Nt({type:"string",default:"default","property-type":"data-driven"}),"line-trim-color-use-theme":new Nt({type:"string",default:"default","property-type":"data-driven"}),"line-border-color-use-theme":new Nt({type:"string",default:"default","property-type":"data-driven"})}))},Sv);class vD extends Nt{possiblyEvaluate(n,l){return l=new tr(Math.floor(l.zoom),{now:l.now,fadeDuration:l.fadeDuration,transition:l.transition}),super.possiblyEvaluate(n,l)}evaluate(n,l,d,_){return l=Mn({},l,{zoom:Math.floor(l.zoom)}),super.evaluate(n,l,d,_)}}let ap;function FT(u,n){return n>0?n+2*u:u}const xD=ji([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_tex_size",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),bD=ji([{name:"a_globe_anchor",components:3,type:"Int16"},{name:"a_globe_normal",components:3,type:"Float32"}],4),wD=ji([{name:"a_projected_pos",components:4,type:"Float32"}],4);ji([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const AD=ji([{name:"a_auto_z_offset",components:1,type:"Float32"}],4),TD=ji([{name:"a_texb",components:2,type:"Uint16"}]),ED=ji([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"},{name:"a_elevation_from_sea",components:2,type:"Float32"}]),SD=ji([{name:"a_size_scale",components:1,type:"Float32"},{name:"a_padding",components:2,type:"Float32"},{name:"a_auto_z_offset",components:1,type:"Float32"}]);ji([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"tileAnchorX"},{type:"Int16",name:"tileAnchorY"},{type:"Float32",name:"x1"},{type:"Float32",name:"y1"},{type:"Float32",name:"x2"},{type:"Float32",name:"y2"},{type:"Int16",name:"padding"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const kT=ji([{name:"a_pos",components:3,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),ID=ji([{name:"a_pos_2f",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);ji([{name:"triangle",components:3,type:"Uint16"}]),ji([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"},{type:"Uint8",name:"flipState"}]),ji([{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",components:2,name:"textOffset"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Float32",name:"zOffset"},{type:"Uint8",name:"hasIconTextFit"}]),ji([{type:"Float32",name:"offsetX"}]),ji([{type:"Int16",name:"x"},{type:"Int16",name:"y"}]);var An=24;const ko=128;function Iv(u,n,l,d,_){if(u.kind==="camera")return u.maxSize;if(u.kind==="composite"){const f=n.possiblyEvaluate(new tr(u.maxZoom),l).evaluate(_,{},l),g=n.possiblyEvaluate(new tr(u.minZoom),l).evaluate(_,{},l);return Math.max(f,g)}return n.possiblyEvaluate(new tr(d)).evaluate(_,{},l)}function Cv(u,n){const{expression:l}=n;if(l.kind==="constant")return{kind:"constant",layoutSize:l.evaluate(new tr(u+1))};if(l.kind==="source")return{kind:"source"};{const{zoomStops:d,interpolationType:_}=l;let f=0;for(;f<d.length&&d[f]<=u;)f++;f=Math.max(0,f-1);let g=f;for(;g<d.length&&d[g]<u+1;)g++;g=Math.min(d.length-1,g);const w=d[f],S=d[g];return l.kind==="composite"?{kind:"composite",minZoom:w,maxZoom:S,interpolationType:_}:{kind:"camera",minZoom:w,maxZoom:S,minSize:l.evaluate(new tr(w)),maxSize:l.evaluate(new tr(S)),interpolationType:_}}}function U_(u,{uSize:n,uSizeT:l},{lowerSize:d,upperSize:_}){return u.kind==="source"?d/ko:u.kind==="composite"?ii(d/ko,_/ko,l):n}function Fh(u,n,l=1){let d=0,_=0;if(u.kind==="constant")_=u.layoutSize*l;else if(u.kind!=="source"){const{interpolationType:f,minZoom:g,maxZoom:w}=u,S=f?yi(Kn.interpolationFactor(f,n,g,w),0,1):0;u.kind==="camera"?_=ii(u.minSize,u.maxSize,S)*l:d=S*l}return{uSizeT:d,uSize:_}}var CD=Object.freeze({__proto__:null,SIZE_PACK_FACTOR:ko,evaluateSizeForFeature:U_,evaluateSizeForZoom:Fh,getRasterizedIconSize:Iv,getSizeData:Cv});function MD(u,n,l){return u.sections.forEach(d=>{d.text=function(_,f,g){const w=f.layout.get("text-transform").evaluate(g,{});return w==="uppercase"?_=_.toLocaleUpperCase():w==="lowercase"&&(_=_.toLocaleLowerCase()),fs.applyArabicShaping&&(_=fs.applyArabicShaping(_)),_}(d.text,n,l)}),u}const lp={"!":"","#":"",$:"","%":"","&":"","(":"",")":"","*":"","+":"",",":"","-":"",".":"","/":"",":":"",";":"","<":"","=":"",">":"","?":"","@":"","[":"","\\":"","]":"","^":"",_:"","`":"","{":"","|":"","}":"","~":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":""};function RD(u){return u===""||u===""||u===""||u===""||u===""||u===""||u===""||u===""||u===""||u===""||u===""||u===""||u===""||u===""||u===""||u===""||u===""}function PD(u){return u===""||u===""||u===""||u===""||u===""||u===""||u===""||u===""||u===""||u===""}var LT,Mv,NT,Rv={};/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */function BD(){return LT||(LT=1,Rv.read=function(u,n,l,d,_){var f,g,w=8*_-d-1,S=(1<<w)-1,P=S>>1,x=-7,I=l?_-1:0,R=l?-1:1,E=u[n+I];for(I+=R,f=E&(1<<-x)-1,E>>=-x,x+=w;x>0;f=256*f+u[n+I],I+=R,x-=8);for(g=f&(1<<-x)-1,f>>=-x,x+=d;x>0;g=256*g+u[n+I],I+=R,x-=8);if(f===0)f=1-P;else{if(f===S)return g?NaN:1/0*(E?-1:1);g+=Math.pow(2,d),f-=P}return(E?-1:1)*g*Math.pow(2,f-d)},Rv.write=function(u,n,l,d,_,f){var g,w,S,P=8*f-_-1,x=(1<<P)-1,I=x>>1,R=_===23?Math.pow(2,-24)-Math.pow(2,-77):0,E=d?0:f-1,C=d?1:-1,D=n<0||n===0&&1/n<0?1:0;for(n=Math.abs(n),isNaN(n)||n===1/0?(w=isNaN(n)?1:0,g=x):(g=Math.floor(Math.log(n)/Math.LN2),n*(S=Math.pow(2,-g))<1&&(g--,S*=2),(n+=g+I>=1?R/S:R*Math.pow(2,1-I))*S>=2&&(g++,S/=2),g+I>=x?(w=0,g=x):g+I>=1?(w=(n*S-1)*Math.pow(2,_),g+=I):(w=n*Math.pow(2,I-1)*Math.pow(2,_),g=0));_>=8;u[l+E]=255&w,E+=C,w/=256,_-=8);for(g=g<<_|w,P+=_;P>0;u[l+E]=255&g,E+=C,g/=256,P-=8);u[l+E-C]|=128*D}),Rv}function zT(){if(NT)return Mv;NT=1,Mv=n;var u=BD();function n(H){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(H)?H:new Uint8Array(H||0),this.pos=0,this.type=0,this.length=this.buf.length}n.Varint=0,n.Fixed64=1,n.Bytes=2,n.Fixed32=5;var l=4294967296,d=1/l,_=typeof TextDecoder>"u"?null:new TextDecoder("utf8");function f(H){return H.type===n.Bytes?H.readVarint()+H.pos:H.pos+1}function g(H,q,Y){return Y?4294967296*q+(H>>>0):4294967296*(q>>>0)+(H>>>0)}function w(H,q,Y){var ie=q<=16383?1:q<=2097151?2:q<=268435455?3:Math.floor(Math.log(q)/(7*Math.LN2));Y.realloc(ie);for(var he=Y.pos-1;he>=H;he--)Y.buf[he+ie]=Y.buf[he]}function S(H,q){for(var Y=0;Y<H.length;Y++)q.writeVarint(H[Y])}function P(H,q){for(var Y=0;Y<H.length;Y++)q.writeSVarint(H[Y])}function x(H,q){for(var Y=0;Y<H.length;Y++)q.writeFloat(H[Y])}function I(H,q){for(var Y=0;Y<H.length;Y++)q.writeDouble(H[Y])}function R(H,q){for(var Y=0;Y<H.length;Y++)q.writeBoolean(H[Y])}function E(H,q){for(var Y=0;Y<H.length;Y++)q.writeFixed32(H[Y])}function C(H,q){for(var Y=0;Y<H.length;Y++)q.writeSFixed32(H[Y])}function D(H,q){for(var Y=0;Y<H.length;Y++)q.writeFixed64(H[Y])}function N(H,q){for(var Y=0;Y<H.length;Y++)q.writeSFixed64(H[Y])}function z(H,q){return(H[q]|H[q+1]<<8|H[q+2]<<16)+16777216*H[q+3]}function G(H,q,Y){H[Y]=q,H[Y+1]=q>>>8,H[Y+2]=q>>>16,H[Y+3]=q>>>24}function W(H,q){return(H[q]|H[q+1]<<8|H[q+2]<<16)+(H[q+3]<<24)}return n.prototype={destroy:function(){this.buf=null},readFields:function(H,q,Y){for(Y=Y||this.length;this.pos<Y;){var ie=this.readVarint(),he=ie>>3,ce=this.pos;this.type=7&ie,H(he,q,this),this.pos===ce&&this.skip(ie)}return q},readMessage:function(H,q){return this.readFields(H,q,this.readVarint()+this.pos)},readFixed32:function(){var H=z(this.buf,this.pos);return this.pos+=4,H},readSFixed32:function(){var H=W(this.buf,this.pos);return this.pos+=4,H},readFixed64:function(){var H=z(this.buf,this.pos)+z(this.buf,this.pos+4)*l;return this.pos+=8,H},readSFixed64:function(){var H=z(this.buf,this.pos)+W(this.buf,this.pos+4)*l;return this.pos+=8,H},readFloat:function(){var H=u.read(this.buf,this.pos,!0,23,4);return this.pos+=4,H},readDouble:function(){var H=u.read(this.buf,this.pos,!0,52,8);return this.pos+=8,H},readVarint:function(H){var q,Y,ie=this.buf;return q=127&(Y=ie[this.pos++]),Y<128?q:(q|=(127&(Y=ie[this.pos++]))<<7,Y<128?q:(q|=(127&(Y=ie[this.pos++]))<<14,Y<128?q:(q|=(127&(Y=ie[this.pos++]))<<21,Y<128?q:function(he,ce,le){var Te,de,Se=le.buf;if(Te=(112&(de=Se[le.pos++]))>>4,de<128||(Te|=(127&(de=Se[le.pos++]))<<3,de<128)||(Te|=(127&(de=Se[le.pos++]))<<10,de<128)||(Te|=(127&(de=Se[le.pos++]))<<17,de<128)||(Te|=(127&(de=Se[le.pos++]))<<24,de<128)||(Te|=(1&(de=Se[le.pos++]))<<31,de<128))return g(he,Te,ce);throw new Error("Expected varint not more than 10 bytes")}(q|=(15&(Y=ie[this.pos]))<<28,H,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var H=this.readVarint();return H%2==1?(H+1)/-2:H/2},readBoolean:function(){return!!this.readVarint()},readString:function(){var H=this.readVarint()+this.pos,q=this.pos;return this.pos=H,H-q>=12&&_?function(Y,ie,he){return _.decode(Y.subarray(ie,he))}(this.buf,q,H):function(Y,ie,he){for(var ce="",le=ie;le<he;){var Te,de,Se,Pe=Y[le],Me=null,Oe=Pe>239?4:Pe>223?3:Pe>191?2:1;if(le+Oe>he)break;Oe===1?Pe<128&&(Me=Pe):Oe===2?(192&(Te=Y[le+1]))==128&&(Me=(31&Pe)<<6|63&Te)<=127&&(Me=null):Oe===3?(de=Y[le+2],(192&(Te=Y[le+1]))==128&&(192&de)==128&&((Me=(15&Pe)<<12|(63&Te)<<6|63&de)<=2047||Me>=55296&&Me<=57343)&&(Me=null)):Oe===4&&(de=Y[le+2],Se=Y[le+3],(192&(Te=Y[le+1]))==128&&(192&de)==128&&(192&Se)==128&&((Me=(15&Pe)<<18|(63&Te)<<12|(63&de)<<6|63&Se)<=65535||Me>=1114112)&&(Me=null)),Me===null?(Me=65533,Oe=1):Me>65535&&(Me-=65536,ce+=String.fromCharCode(Me>>>10&1023|55296),Me=56320|1023&Me),ce+=String.fromCharCode(Me),le+=Oe}return ce}(this.buf,q,H)},readBytes:function(){var H=this.readVarint()+this.pos,q=this.buf.subarray(this.pos,H);return this.pos=H,q},readPackedVarint:function(H,q){if(this.type!==n.Bytes)return H.push(this.readVarint(q));var Y=f(this);for(H=H||[];this.pos<Y;)H.push(this.readVarint(q));return H},readPackedSVarint:function(H){if(this.type!==n.Bytes)return H.push(this.readSVarint());var q=f(this);for(H=H||[];this.pos<q;)H.push(this.readSVarint());return H},readPackedBoolean:function(H){if(this.type!==n.Bytes)return H.push(this.readBoolean());var q=f(this);for(H=H||[];this.pos<q;)H.push(this.readBoolean());return H},readPackedFloat:function(H){if(this.type!==n.Bytes)return H.push(this.readFloat());var q=f(this);for(H=H||[];this.pos<q;)H.push(this.readFloat());return H},readPackedDouble:function(H){if(this.type!==n.Bytes)return H.push(this.readDouble());var q=f(this);for(H=H||[];this.pos<q;)H.push(this.readDouble());return H},readPackedFixed32:function(H){if(this.type!==n.Bytes)return H.push(this.readFixed32());var q=f(this);for(H=H||[];this.pos<q;)H.push(this.readFixed32());return H},readPackedSFixed32:function(H){if(this.type!==n.Bytes)return H.push(this.readSFixed32());var q=f(this);for(H=H||[];this.pos<q;)H.push(this.readSFixed32());return H},readPackedFixed64:function(H){if(this.type!==n.Bytes)return H.push(this.readFixed64());var q=f(this);for(H=H||[];this.pos<q;)H.push(this.readFixed64());return H},readPackedSFixed64:function(H){if(this.type!==n.Bytes)return H.push(this.readSFixed64());var q=f(this);for(H=H||[];this.pos<q;)H.push(this.readSFixed64());return H},skip:function(H){var q=7&H;if(q===n.Varint)for(;this.buf[this.pos++]>127;);else if(q===n.Bytes)this.pos=this.readVarint()+this.pos;else if(q===n.Fixed32)this.pos+=4;else{if(q!==n.Fixed64)throw new Error("Unimplemented type: "+q);this.pos+=8}},writeTag:function(H,q){this.writeVarint(H<<3|q)},realloc:function(H){for(var q=this.length||16;q<this.pos+H;)q*=2;if(q!==this.length){var Y=new Uint8Array(q);Y.set(this.buf),this.buf=Y,this.length=q}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(H){this.realloc(4),G(this.buf,H,this.pos),this.pos+=4},writeSFixed32:function(H){this.realloc(4),G(this.buf,H,this.pos),this.pos+=4},writeFixed64:function(H){this.realloc(8),G(this.buf,-1&H,this.pos),G(this.buf,Math.floor(H*d),this.pos+4),this.pos+=8},writeSFixed64:function(H){this.realloc(8),G(this.buf,-1&H,this.pos),G(this.buf,Math.floor(H*d),this.pos+4),this.pos+=8},writeVarint:function(H){(H=+H||0)>268435455||H<0?function(q,Y){var ie,he;if(q>=0?(ie=q%4294967296|0,he=q/4294967296|0):(he=~(-q/4294967296),4294967295^(ie=~(-q%4294967296))?ie=ie+1|0:(ie=0,he=he+1|0)),q>=18446744073709552e3||q<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");Y.realloc(10),function(ce,le,Te){Te.buf[Te.pos++]=127&ce|128,ce>>>=7,Te.buf[Te.pos++]=127&ce|128,ce>>>=7,Te.buf[Te.pos++]=127&ce|128,ce>>>=7,Te.buf[Te.pos++]=127&ce|128,Te.buf[Te.pos]=127&(ce>>>=7)}(ie,0,Y),function(ce,le){var Te=(7&ce)<<4;le.buf[le.pos++]|=Te|((ce>>>=3)?128:0),ce&&(le.buf[le.pos++]=127&ce|((ce>>>=7)?128:0),ce&&(le.buf[le.pos++]=127&ce|((ce>>>=7)?128:0),ce&&(le.buf[le.pos++]=127&ce|((ce>>>=7)?128:0),ce&&(le.buf[le.pos++]=127&ce|((ce>>>=7)?128:0),ce&&(le.buf[le.pos++]=127&ce)))))}(he,Y)}(H,this):(this.realloc(4),this.buf[this.pos++]=127&H|(H>127?128:0),H<=127||(this.buf[this.pos++]=127&(H>>>=7)|(H>127?128:0),H<=127||(this.buf[this.pos++]=127&(H>>>=7)|(H>127?128:0),H<=127||(this.buf[this.pos++]=H>>>7&127))))},writeSVarint:function(H){this.writeVarint(H<0?2*-H-1:2*H)},writeBoolean:function(H){this.writeVarint(!!H)},writeString:function(H){H=String(H),this.realloc(4*H.length),this.pos++;var q=this.pos;this.pos=function(ie,he,ce){for(var le,Te,de=0;de<he.length;de++){if((le=he.charCodeAt(de))>55295&&le<57344){if(!Te){le>56319||de+1===he.length?(ie[ce++]=239,ie[ce++]=191,ie[ce++]=189):Te=le;continue}if(le<56320){ie[ce++]=239,ie[ce++]=191,ie[ce++]=189,Te=le;continue}le=Te-55296<<10|le-56320|65536,Te=null}else Te&&(ie[ce++]=239,ie[ce++]=191,ie[ce++]=189,Te=null);le<128?ie[ce++]=le:(le<2048?ie[ce++]=le>>6|192:(le<65536?ie[ce++]=le>>12|224:(ie[ce++]=le>>18|240,ie[ce++]=le>>12&63|128),ie[ce++]=le>>6&63|128),ie[ce++]=63&le|128)}return ce}(this.buf,H,this.pos);var Y=this.pos-q;Y>=128&&w(q,Y,this),this.pos=q-1,this.writeVarint(Y),this.pos+=Y},writeFloat:function(H){this.realloc(4),u.write(this.buf,H,this.pos,!0,23,4),this.pos+=4},writeDouble:function(H){this.realloc(8),u.write(this.buf,H,this.pos,!0,52,8),this.pos+=8},writeBytes:function(H){var q=H.length;this.writeVarint(q),this.realloc(q);for(var Y=0;Y<q;Y++)this.buf[this.pos++]=H[Y]},writeRawMessage:function(H,q){this.pos++;var Y=this.pos;H(q,this);var ie=this.pos-Y;ie>=128&&w(Y,ie,this),this.pos=Y-1,this.writeVarint(ie),this.pos+=ie},writeMessage:function(H,q,Y){this.writeTag(H,n.Bytes),this.writeRawMessage(q,Y)},writePackedVarint:function(H,q){q.length&&this.writeMessage(H,S,q)},writePackedSVarint:function(H,q){q.length&&this.writeMessage(H,P,q)},writePackedBoolean:function(H,q){q.length&&this.writeMessage(H,R,q)},writePackedFloat:function(H,q){q.length&&this.writeMessage(H,x,q)},writePackedDouble:function(H,q){q.length&&this.writeMessage(H,I,q)},writePackedFixed32:function(H,q){q.length&&this.writeMessage(H,E,q)},writePackedSFixed32:function(H,q){q.length&&this.writeMessage(H,C,q)},writePackedFixed64:function(H,q){q.length&&this.writeMessage(H,D,q)},writePackedSFixed64:function(H,q){q.length&&this.writeMessage(H,N,q)},writeBytesField:function(H,q){this.writeTag(H,n.Bytes),this.writeBytes(q)},writeFixed32Field:function(H,q){this.writeTag(H,n.Fixed32),this.writeFixed32(q)},writeSFixed32Field:function(H,q){this.writeTag(H,n.Fixed32),this.writeSFixed32(q)},writeFixed64Field:function(H,q){this.writeTag(H,n.Fixed64),this.writeFixed64(q)},writeSFixed64Field:function(H,q){this.writeTag(H,n.Fixed64),this.writeSFixed64(q)},writeVarintField:function(H,q){this.writeTag(H,n.Varint),this.writeVarint(q)},writeSVarintField:function(H,q){this.writeTag(H,n.Varint),this.writeSVarint(q)},writeStringField:function(H,q){this.writeTag(H,n.Bytes),this.writeString(q)},writeFloatField:function(H,q){this.writeTag(H,n.Fixed32),this.writeFloat(q)},writeDoubleField:function(H,q){this.writeTag(H,n.Fixed64),this.writeDouble(q)},writeBooleanField:function(H,q){this.writeVarintField(H,!!q)}},Mv}var V_=T(zT());const Pv=3;function DD(u,n,l){n.glyphs=[],u===1&&l.readMessage(OD,n)}function OD(u,n,l){if(u===3){const{id:d,bitmap:_,width:f,height:g,left:w,top:S,advance:P}=l.readMessage(FD,{});n.glyphs.push({id:d,bitmap:new Nl({width:f+2*Pv,height:g+2*Pv},_),metrics:{width:f,height:g,left:w,top:S,advance:P}})}else u===4?n.ascender=l.readSVarint():u===5&&(n.descender=l.readSVarint())}function FD(u,n,l){u===1?n.id=l.readVarint():u===2?n.bitmap=l.readBytes():u===3?n.width=l.readVarint():u===4?n.height=l.readVarint():u===5?n.left=l.readSVarint():u===6?n.top=l.readSVarint():u===7&&(n.advance=l.readVarint())}const kD=Pv,Ls={horizontal:1,vertical:2,horizontalOnly:3};class cp{constructor(){this.scale=1,this.fontStack="",this.image=null}static forText(n,l){const d=new cp;return d.scale=n||1,d.fontStack=l,d}static forImage(n){const l=new cp;return l.image=n,l}}class kh{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(n,l){const d=new kh;for(let _=0;_<n.sections.length;_++){const f=n.sections[_];f.image?d.addImageSection(f):d.addTextSection(f,l)}return d}length(){return this.text.length}getSection(n){return this.sections[this.sectionIndex[n]]}getSections(){return this.sections}getSectionIndex(n){return this.sectionIndex[n]}getCodePoint(n){return this.text.codePointAt(n)}verticalizePunctuation(n){this.text=function(l,d){let _="";for(let f=0;f<l.length;f++){const g=l.charCodeAt(f+1)||null,w=l.charCodeAt(f-1)||null;_+=!d&&(g&&Af(g)&&!lp[l[f+1]]||w&&Af(w)&&!lp[l[f-1]])||!lp[l[f]]?l[f]:lp[l[f]]}return _}(this.text,n)}trim(){let n=0;for(let d=0;d<this.text.length&&j_[this.text.charCodeAt(d)];d++)n++;let l=this.text.length;for(let d=this.text.length-1;d>=0&&d>=n&&j_[this.text.charCodeAt(d)];d--)l--;this.text=this.text.substring(n,l),this.sectionIndex=this.sectionIndex.slice(n,l)}substring(n,l){const d=new kh;return d.text=this.text.substring(n,l),d.sectionIndex=this.sectionIndex.slice(n,l),d.sections=this.sections,d}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce((n,l)=>Math.max(n,this.sections[l].scale),0)}addTextSection(n,l){this.text+=n.text,this.sections.push(cp.forText(n.scale,n.fontStack||l));const d=this.sections.length-1;for(let _=0;_<n.text.length;++_)this.sectionIndex.push(d)}addImageSection(n){const l=n.image&&n.image.namePrimary?n.image.getPrimary():null;if(!l)return void mi("Can't add FormattedSection with an empty image.");const d=this.getNextImageSectionCharCode();d?(this.text+=String.fromCodePoint(d),this.sections.push(cp.forImage(l)),this.sectionIndex.push(this.sections.length-1)):mi("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function Bv(u,n,l,d,_,f,g,w,S,P,x,I,R,E,C){const D=kh.fromFeature(u,_);I===Ls.vertical&&D.verticalizePunctuation(R);let N=[];const z=function(Y,ie,he,ce,le,Te){if(!Y)return[];const de=[],Se=function(Ue,Ge,Ne,rt,mt,it){let Bt=0;for(let Mt=0;Mt<Ue.length();Mt++){const bt=Ue.getSection(Mt);Bt+=UT(Ue.getCodePoint(Mt),bt,rt,mt,Ge,it)}return Bt/Math.max(1,Math.ceil(Bt/Ne))}(Y,ie,he,ce,le,Te),Pe=Y.text.indexOf("")>=0;let Me=0;for(let Ue=0;Ue<Y.length();Ue++){const Ge=Y.getSection(Ue),Ne=Y.getCodePoint(Ue);if(j_[Ne]||(Me+=UT(Ne,Ge,ce,le,ie,Te)),Ue<Y.length()-1){const rt=!((Oe=Ne)<11904||!($t["Bopomofo Extended"](Oe)||$t.Bopomofo(Oe)||$t["CJK Compatibility Forms"](Oe)||$t["CJK Compatibility Ideographs"](Oe)||$t["CJK Compatibility"](Oe)||$t["CJK Radicals Supplement"](Oe)||$t["CJK Strokes"](Oe)||$t["CJK Symbols and Punctuation"](Oe)||$t["CJK Unified Ideographs Extension A"](Oe)||$t["CJK Unified Ideographs"](Oe)||$t["Enclosed CJK Letters and Months"](Oe)||$t["Halfwidth and Fullwidth Forms"](Oe)||$t.Hiragana(Oe)||$t["Ideographic Description Characters"](Oe)||$t["Kangxi Radicals"](Oe)||$t["Katakana Phonetic Extensions"](Oe)||$t.Katakana(Oe)||$t["Vertical Forms"](Oe)||$t["Yi Radicals"](Oe)||$t["Yi Syllables"](Oe)));(LD[Ne]||rt||Ge.image)&&de.push(jT(Ue+1,Me,Se,de,ND(Ne,Y.getCodePoint(Ue+1),rt&&Pe),!1))}}var Oe;return HT(jT(Y.length(),Me,Se,de,0,!0))}(D,P,f,n,d,E),{processBidirectionalText:G,processStyledBidirectionalText:W}=fs;if(G&&D.sections.length===1){const Y=G(D.toString(),z);for(const ie of Y){const he=new kh;he.text=ie,he.sections=D.sections;for(let ce=0;ce<ie.length;ce++)he.sectionIndex.push(0);N.push(he)}}else if(W){const Y=W(D.text,D.sectionIndex,z);for(const ie of Y){const he=new kh;he.text=ie[0],he.sectionIndex=ie[1],he.sections=D.sections,N.push(he)}}else N=function(Y,ie){const he=[],ce=Y.text;let le=0;for(const Te of ie)he.push(Y.substring(le,Te)),le=Te;return le<ce.length&&he.push(Y.substring(le,ce.length)),he}(D,z);const H=[],q={positionedLines:H,text:D.toString(),top:x[1],bottom:x[1],left:x[0],right:x[0],writingMode:I,iconsInText:!1,verticalizable:!1,hasBaseline:!1};return function(Y,ie,he,ce,le,Te,de,Se,Pe,Me,Oe,Ue){let Ge=0,Ne=0,rt=0;const mt=Se==="right"?1:Se==="left"?0:.5;let it=!1;for(const Ft of le){const zt=Ft.getSections();for(const ai of zt){if(ai.image)continue;const fi=ie[ai.fontStack];if(fi&&(it=fi.ascender!==void 0&&fi.descender!==void 0,!it))break}if(!it)break}let Bt=0;for(const Ft of le){Ft.trim();const zt=Ft.getMaxScale(),ai=(zt-1)*An,fi={positionedGlyphs:[],lineOffset:0};Y.positionedLines[Bt]=fi;const _i=fi.positionedGlyphs;let gi=0;if(!Ft.length()){Ne+=Te,++Bt;continue}let wi=0,Ai=0;for(let Yi=0;Yi<Ft.length();Yi++){const ui=Ft.getSection(Yi),Wi=Ft.getSectionIndex(Yi),Zi=Ft.getCodePoint(Yi);let ar=ui.scale,Cr=null,Ur=null,Mr=null,vr=An,Fr=0;const Hr=!(Pe===Ls.horizontal||!Oe&&!fh(Zi)||Oe&&(j_[Zi]||(Mt=Zi,$t.Arabic(Mt)||$t["Arabic Supplement"](Mt)||$t["Arabic Extended-A"](Mt)||$t["Arabic Presentation Forms-A"](Mt)||$t["Arabic Presentation Forms-B"](Mt))));if(ui.image){const Tn=ce[ui.image.serialize()];if(!Tn)continue;Mr=ui.image.id,Y.iconsInText=Y.iconsInText||!0,Ur=Tn.paddedRect;const nr=Tn.displaySize;ar=ar*An/Ue,Cr={width:nr[0],height:nr[1],left:0,top:-3,advance:Hr?nr[1]:nr[0],localGlyph:!1},Fr=it?-Cr.height*ar:zt*An-17-nr[1]*ar,vr=Cr.advance;const ys=(Hr?nr[0]:nr[1])*ar-An*zt;ys>0&&ys>gi&&(gi=ys)}else{const Tn=he[ui.fontStack];if(!Tn)continue;Tn[Zi]&&(Ur=Tn[Zi]);const nr=ie[ui.fontStack];if(!nr)continue;const ys=nr.glyphs[Zi];if(!ys)continue;if(Cr=ys.metrics,vr=Zi!==8203?An:0,it){const Vo=nr.ascender!==void 0?Math.abs(nr.ascender):0,co=nr.descender!==void 0?Math.abs(nr.descender):0,uo=(Vo+co)*ar;wi<uo&&(wi=uo,Ai=(Vo-co)/2*ar),Fr=-Vo*ar}else Fr=(zt-ar)*An-17}Hr?(Y.verticalizable=!0,_i.push({glyph:Zi,imageName:Mr,x:Ge,y:Ne+Fr,vertical:Hr,scale:ar,localGlyph:Cr.localGlyph,fontStack:ui.fontStack,sectionIndex:Wi,metrics:Cr,rect:Ur}),Ge+=vr*ar+Me):(_i.push({glyph:Zi,imageName:Mr,x:Ge,y:Ne+Fr,vertical:Hr,scale:ar,localGlyph:Cr.localGlyph,fontStack:ui.fontStack,sectionIndex:Wi,metrics:Cr,rect:Ur}),Ge+=Cr.advance*ar+Me)}_i.length!==0&&(rt=Math.max(Ge-Me,rt),it?GT(_i,mt,gi,Ai,Te*zt/2):GT(_i,mt,gi,0,Te/2)),Ge=0;const er=Te*zt+gi;fi.lineOffset=Math.max(gi,ai),Ne+=er,++Bt}var Mt;const bt=Ne,{horizontalAlign:_t,verticalAlign:Ht}=Dv(de);(function(Ft,zt,ai,fi,_i,gi){const wi=(zt-ai)*_i,Ai=-gi*fi;for(const er of Ft)for(const Yi of er.positionedGlyphs)Yi.x+=wi,Yi.y+=Ai})(Y.positionedLines,mt,_t,Ht,rt,bt),Y.top+=-Ht*bt,Y.bottom=Y.top+bt,Y.left+=-_t*rt,Y.right=Y.left+rt,Y.hasBaseline=it}(q,n,l,d,N,g,w,S,I,P,R,C),!function(Y){for(const ie of Y)if(ie.positionedGlyphs.length!==0)return!1;return!0}(H)&&q}const j_={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},LD={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function UT(u,n,l,d,_,f){if(n.image){const g=d[n.image.serialize()];return g?g.displaySize[0]*n.scale*An/f+_:0}{const g=l[n.fontStack],w=g&&g.glyphs[u];return w?w.metrics.advance*n.scale+_:0}}function VT(u,n,l,d){const _=Math.pow(u-n,2);return d?u<n?_/2:2*_:_+Math.abs(l)*l}function ND(u,n,l){let d=0;return u===10&&(d-=1e4),l&&(d+=150),u!==40&&u!==65288||(d+=50),n!==41&&n!==65289||(d+=50),d}function jT(u,n,l,d,_,f){let g=null,w=VT(n,l,_,f);for(const S of d){const P=VT(n-S.x,l,_,f)+S.badness;P<=w&&(g=S,w=P)}return{index:u,x:n,priorBreak:g,badness:w}}function HT(u){return u?HT(u.priorBreak).concat(u.index):[]}function Dv(u){let n=.5,l=.5;switch(u){case"right":case"top-right":case"bottom-right":n=1;break;case"left":case"top-left":case"bottom-left":n=0}switch(u){case"bottom":case"bottom-right":case"bottom-left":l=1;break;case"top":case"top-right":case"top-left":l=0}return{horizontalAlign:n,verticalAlign:l}}function GT(u,n,l,d,_){if(!(n||l||d||_))return;const f=u.length-1,g=u[f],w=(g.x+g.metrics.advance*g.scale)*n;for(let S=0;S<=f;S++)u[S].x-=w,u[S].y+=l+d+_}function zD(u,n,l,d){const{horizontalAlign:_,verticalAlign:f}=Dv(d),g=l[0]-u.displaySize[0]*_,w=l[1]-u.displaySize[1]*f;return{imagePrimary:u,imageSecondary:n,top:w,bottom:w+u.displaySize[1],left:g,right:g+u.displaySize[0]}}function $T(u,n,l,d,_,f){const g=u.imagePrimary;let w;if(g.content){const N=g.content,z=g.pixelRatio||1;w=[N[0]/z,N[1]/z,g.displaySize[0]-N[2]/z,g.displaySize[1]-N[3]/z]}const S=n.left*f,P=n.right*f;let x,I,R,E;l==="width"||l==="both"?(E=_[0]+S-d[3],I=_[0]+P+d[1]):(E=_[0]+(S+P-g.displaySize[0])/2,I=E+g.displaySize[0]);const C=n.top*f,D=n.bottom*f;return l==="height"||l==="both"?(x=_[1]+C-d[0],R=_[1]+D+d[2]):(x=_[1]+(C+D-g.displaySize[1])/2,R=x+g.displaySize[1]),{imagePrimary:g,imageSecondary:void 0,top:x,right:I,bottom:R,left:E,collisionPadding:w}}class Xa extends At{constructor(n,l,d,_,f){super(n,l),this.angle=_,this.z=d,f!==void 0&&(this.segment=f)}clone(){return new Xa(this.x,this.y,this.z,this.angle,this.segment)}}function WT(u,n,l,d,_){if(n.segment===void 0)return!0;let f=n,g=n.segment+1,w=0;for(;w>-l/2;){if(g--,g<0)return!1;w-=u[g].dist(f),f=u[g]}w+=u[g].dist(u[g+1]),g++;const S=[];let P=0;for(;w<l/2;){const x=u[g],I=u[g+1];if(!I)return!1;let R=u[g-1].angleTo(x)-x.angleTo(I);for(R=Math.abs((R+3*Math.PI)%(2*Math.PI)-Math.PI),S.push({distance:w,angleDelta:R}),P+=R;w-S[0].distance>d;)P-=S.shift().angleDelta;if(P>_)return!1;g++,w+=x.dist(I)}return!0}function qT(u){let n=0;for(let l=0;l<u.length-1;l++)n+=u[l].dist(u[l+1]);return n}function XT(u,n,l){return u?.6*n*l:0}function ZT(u,n){return Math.max(u?u.right-u.left:0,n?n.right-n.left:0)}function UD(u,n,l,d,_,f){const g=XT(l,_,f),w=ZT(l,d)*f;let S=0;const P=qT(u)/2;for(let x=0;x<u.length-1;x++){const I=u[x],R=u[x+1],E=I.dist(R);if(S+E>P){const C=(P-S)/E,D=ii(I.x,R.x,C),N=ii(I.y,R.y,C),z=new Xa(D,N,0,R.angleTo(I),x);return!g||WT(u,z,w,g,n)?z:void 0}S+=E}}function VD(u,n,l,d,_,f,g,w,S){const P=XT(d,f,g),x=ZT(d,_),I=x*g,R=u[0].x===0||u[0].x===S||u[0].y===0||u[0].y===S;return n-I<n/4&&(n=I+n/4),YT(u,R?n/2*w%n:(x/2+2*f)*g*w%n,n,P,l,I,R,!1,S)}function YT(u,n,l,d,_,f,g,w,S){const P=f/2,x=qT(u);let I=0,R=n-l,E=[];for(let C=0;C<u.length-1;C++){const D=u[C],N=u[C+1],z=D.dist(N),G=N.angleTo(D);for(;R+l<I+z;){R+=l;const W=(R-I)/z,H=ii(D.x,N.x,W),q=ii(D.y,N.y,W);if(H>=0&&H<S&&q>=0&&q<S&&R-P>=0&&R+P<=x){const Y=new Xa(H,q,0,G,C);d&&!WT(u,Y,f,d,_)||E.push(Y)}}I+=z}return w||E.length||g||(E=YT(u,I/2,l,d,_,f,g,!0,S)),E}function KT(u,n,l,d,_){const f=[];for(let g=0;g<u.length;g++){const w=u[g];let S;for(let P=0;P<w.length-1;P++){let x=w[P],I=w[P+1];x.x<n&&I.x<n||(x.x<n?x=new At(n,x.y+(n-x.x)/(I.x-x.x)*(I.y-x.y))._round():I.x<n&&(I=new At(n,x.y+(n-x.x)/(I.x-x.x)*(I.y-x.y))._round()),x.y<l&&I.y<l||(x.y<l?x=new At(x.x+(l-x.y)/(I.y-x.y)*(I.x-x.x),l)._round():I.y<l&&(I=new At(x.x+(l-x.y)/(I.y-x.y)*(I.x-x.x),l)._round()),x.x>=d&&I.x>=d||(x.x>=d?x=new At(d,x.y+(d-x.x)/(I.x-x.x)*(I.y-x.y))._round():I.x>=d&&(I=new At(d,x.y+(d-x.x)/(I.x-x.x)*(I.y-x.y))._round()),x.y>=_&&I.y>=_||(x.y>=_?x=new At(x.x+(_-x.y)/(I.y-x.y)*(I.x-x.x),_)._round():I.y>=_&&(I=new At(x.x+(_-x.y)/(I.y-x.y)*(I.x-x.x),_)._round()),S&&x.equals(S[S.length-1])||(S=[x],f.push(S)),S.push(I)))))}}return f}function JT(u){let n=0,l=0;for(const g of u)n+=g.w*g.h,l=Math.max(l,g.w);u.sort((g,w)=>w.h-g.h);const d=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(n/.95)),l),h:1/0}];let _=0,f=0;for(const g of u)for(let w=d.length-1;w>=0;w--){const S=d[w];if(!(g.w>S.w||g.h>S.h)){if(g.x=S.x,g.y=S.y,f=Math.max(f,g.y+g.h),_=Math.max(_,g.x+g.w),g.w===S.w&&g.h===S.h){const P=d.pop();w<d.length&&(d[w]=P)}else g.h===S.h?(S.x+=g.w,S.w-=g.w):g.w===S.w?(S.y+=g.h,S.h-=g.h):(d.push({x:S.x+g.w,y:S.y,w:S.w-g.w,h:g.h}),S.y+=g.h,S.h-=g.h);break}}return{w:_,h:f,fill:n/(_*f)||0}}Vt(Xa,"Anchor");const up=1;class hp{static getImagePositionScale(n,l,d){return l&&n&&n.options&&n.options.transform?{x:n.options.transform.a,y:n.options.transform.d}:{x:d,y:d}}constructor(n,{pixelRatio:l,version:d,stretchX:_,stretchY:f,content:g,sdf:w,usvg:S},P,x){this.paddedRect=n,this.pixelRatio=l,this.stretchX=_,this.stretchY=f,this.content=g,this.version=d,this.padding=P,this.sdf=w,this.scale=hp.getImagePositionScale(x,S,l)}get tl(){return[this.paddedRect.x+this.padding,this.paddedRect.y+this.padding]}get br(){return[this.paddedRect.x+this.paddedRect.w-this.padding,this.paddedRect.y+this.paddedRect.h-this.padding]}get displaySize(){return[(this.paddedRect.w-2*this.padding)/this.scale.x,(this.paddedRect.h-2*this.padding)/this.scale.y]}}class QT{constructor(n,l,d){const _={},f={};this.haveRenderCallbacks=[];const g=[];this.addImages(n,_,up,g),this.addImages(l,f,2,g);const{w,h:S}=JT(g),P=new hn({width:w||1,height:S||1});for(const x in n){const I=n[x],R=_[x].paddedRect;hn.copy(I.data,P,{x:0,y:0},{x:R.x+up,y:R.y+up},I.data,d,I.sdf)}for(const x in l){const I=l[x],R=f[x].paddedRect;let E=f[x].padding;const C=R.x+E,D=R.y+E,N=I.data.width,z=I.data.height;E=E>1?E-1:E,hn.copy(I.data,P,{x:0,y:0},{x:C,y:D},I.data,d),hn.copy(I.data,P,{x:0,y:z-E},{x:C,y:D-E},{width:N,height:E},d),hn.copy(I.data,P,{x:0,y:0},{x:C,y:D+z},{width:N,height:E},d),hn.copy(I.data,P,{x:N-E,y:0},{x:C-E,y:D},{width:E,height:z},d),hn.copy(I.data,P,{x:0,y:0},{x:C+N,y:D},{width:E,height:z},d),hn.copy(I.data,P,{x:N-E,y:z-E},{x:C-E,y:D-E},{width:E,height:E},d),hn.copy(I.data,P,{x:0,y:z-E},{x:C+N,y:D-E},{width:E,height:E},d),hn.copy(I.data,P,{x:0,y:0},{x:C+N,y:D+z},{width:E,height:E},d),hn.copy(I.data,P,{x:N-E,y:0},{x:C-E,y:D+z},{width:E,height:E},d)}this.lut=d,this.image=P,this.iconPositions=_,this.patternPositions=f}addImages(n,l,d,_){for(const f in n){const g=n[f],w={x:0,y:0,w:g.data.width+2*d,h:g.data.height+2*d};_.push(w);const S=Qs.deserializeFromString(f);l[f]=new hp(w,g,d,S),g.hasRenderCallback&&this.haveRenderCallbacks.push(S.id)}}patchUpdatedImages(n,l,d){this.haveRenderCallbacks=this.haveRenderCallbacks.filter(_=>n.hasImage(_,d)),n.dispatchRenderCallbacks(this.haveRenderCallbacks,d);for(const _ in n.getUpdatedImages(d)){for(const f of Object.keys(this.iconPositions))Qs.deserializeId(f)===_&&this.patchUpdatedImage(this.iconPositions[f],n.getImage(_,d),l);for(const f of Object.keys(this.patternPositions))Qs.deserializeId(f)===_&&this.patchUpdatedImage(this.patternPositions[f],n.getImage(_,d),l)}}patchUpdatedImage(n,l,d){if(!n||!l||n.version===l.version)return;n.version=l.version;const[_,f]=n.tl,g=n.sdf;if(this.lut||g){const w={width:l.data.width,height:l.data.height},S=new hn(w);hn.copy(l.data,S,{x:0,y:0},{x:0,y:0},w,this.lut,g),d.update(S,{position:{x:_,y:f}})}else d.update(l.data,{position:{x:_,y:f}})}}Vt(hp,"ImagePosition"),Vt(QT,"ImageAtlas");const H_=1e20;function e2(u,n,l,d,_,f,g,w,S){for(let P=n;P<n+d;P++)t2(u,l*f+P,f,_,g,w,S);for(let P=l;P<l+_;P++)t2(u,P*f+n,1,d,g,w,S)}function t2(u,n,l,d,_,f,g){f[0]=0,g[0]=-1e20,g[1]=H_,_[0]=u[n];for(let w=1,S=0,P=0;w<d;w++){_[w]=u[n+w*l];const x=w*w;do{const I=f[S];P=(_[w]-_[I]+x-I*I)/(w-I)/2}while(P<=g[S]&&--S>-1);S++,f[S]=w,g[S]=P,g[S+1]=H_}for(let w=0,S=0;w<d;w++){for(;g[S+1]<w;)S++;const P=f[S],x=w-P;u[n+w*l]=_[P]+x*x}}const Lo=2,Ov={none:0,ideographs:1,all:2};class Lh{constructor(n,l,d){this.requestManager=n,this.localGlyphMode=l,this.localFontFamily=d,this.urls={},this.entries={},this.localGlyphs={200:{},400:{},500:{},900:{}}}setURL(n,l){this.urls[l]=n}getGlyphs(n,l,d){const _=[],f=this.urls[l]||Vr.GLYPHS_URL;for(const g in n)for(const w of n[g])_.push({stack:g,id:w});Cn(_,({stack:g,id:w},S)=>{let P=this.entries[g];P||(P=this.entries[g]={glyphs:{},requests:{},ranges:{},ascender:void 0,descender:void 0});let x=P.glyphs[w];if(x!==void 0)return void S(null,{stack:g,id:w,glyph:x});if(x=this._tinySDF(P,g,w),x)return P.glyphs[w]=x,void S(null,{stack:g,id:w,glyph:x});const I=Math.floor(w/256);if(256*I>65535)return mi("glyphs > 65535 not supported"),void S(null,{stack:g,id:w,glyph:x});if(P.ranges[I])return void S(null,{stack:g,id:w,glyph:x});let R=P.requests[I];R||(R=P.requests[I]=[],Lh.loadGlyphRange(g,I,f,this.requestManager,(E,C)=>{if(C){P.ascender=C.ascender,P.descender=C.descender;for(const D in C.glyphs)this._doesCharSupportLocalGlyph(+D)||(P.glyphs[+D]=C.glyphs[+D]);P.ranges[I]=!0}for(const D of R)D(E,C);delete P.requests[I]})),R.push((E,C)=>{E?S(E):C&&S(null,{stack:g,id:w,glyph:C.glyphs[w]||null})})},(g,w)=>{if(g)d(g);else if(w){const S={};for(const{stack:P,id:x,glyph:I}of w)S[P]===void 0&&(S[P]={}),S[P].glyphs===void 0&&(S[P].glyphs={}),S[P].glyphs[x]=I&&{id:I.id,bitmap:I.bitmap.clone(),metrics:I.metrics},S[P].ascender=this.entries[P].ascender,S[P].descender=this.entries[P].descender;d(null,S)}})}_doesCharSupportLocalGlyph(n){return this.localGlyphMode!==Ov.none&&(this.localGlyphMode===Ov.all?!!this.localFontFamily:!!this.localFontFamily&&($t["CJK Unified Ideographs"](n)||$t["Hangul Syllables"](n)||$t.Hiragana(n)||$t.Katakana(n)||$t["CJK Symbols and Punctuation"](n)||$t["CJK Unified Ideographs Extension A"](n)||$t["CJK Unified Ideographs Extension B"](n)||$t.Osage(n)))}_tinySDF(n,l,d){const _=this.localFontFamily;if(!_||!this._doesCharSupportLocalGlyph(d))return;let f=n.tinySDF;if(!f){let D="400";/bold/i.test(l)?D="900":/medium/i.test(l)?D="500":/light/i.test(l)&&(D="200"),f=n.tinySDF=new Lh.TinySDF({fontFamily:_,fontWeight:D,fontSize:24*Lo,buffer:3*Lo,radius:8*Lo}),f.fontWeight=D}if(this.localGlyphs[f.fontWeight][d])return this.localGlyphs[f.fontWeight][d];const g=String.fromCodePoint(d),{data:w,width:S,height:P,glyphWidth:x,glyphHeight:I,glyphLeft:R,glyphTop:E,glyphAdvance:C}=f.draw(g);return this.localGlyphs[f.fontWeight][d]={id:d,bitmap:new Nl({width:S,height:P},w),metrics:{width:x/Lo,height:I/Lo,left:R/Lo,top:E/Lo-27,advance:C/Lo,localGlyph:!0}}}}Lh.loadGlyphRange=function(u,n,l,d,_){const f=256*n,g=f+255,w=d.transformRequest(d.normalizeGlyphsURL(l).replace("{fontstack}",u).replace("{range}",`${f}-${g}`),zi.Glyphs);qr(w,(S,P)=>{if(S)_(S);else if(P){const x={},I=function(R){return new V_(R).readFields(DD,{})}(P);for(const R of I.glyphs)x[R.id]=R;_(null,{glyphs:x,ascender:I.ascender,descender:I.descender})}})},Lh.TinySDF=class{constructor({fontSize:u=24,buffer:n=3,radius:l=8,cutoff:d=.25,fontFamily:_="sans-serif",fontWeight:f="normal",fontStyle:g="normal"}={}){this.buffer=n,this.cutoff=d,this.radius=l;const w=this.size=u+4*n,S=this._createCanvas(w),P=this.ctx=S.getContext("2d",{willReadFrequently:!0});P.font=`${g} ${f} ${u}px ${_}`,P.textBaseline="alphabetic",P.textAlign="left",P.fillStyle="black",this.gridOuter=new Float64Array(w*w),this.gridInner=new Float64Array(w*w),this.f=new Float64Array(w),this.z=new Float64Array(w+1),this.v=new Uint16Array(w)}_createCanvas(u){const n=document.createElement("canvas");return n.width=n.height=u,n}draw(u){const{width:n,actualBoundingBoxAscent:l,actualBoundingBoxDescent:d,actualBoundingBoxLeft:_,actualBoundingBoxRight:f}=this.ctx.measureText(u),g=Math.ceil(l),w=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(f-_))),S=Math.min(this.size-this.buffer,g+Math.ceil(d)),P=w+2*this.buffer,x=S+2*this.buffer,I=Math.max(P*x,0),R=new Uint8ClampedArray(I),E={data:R,width:P,height:x,glyphWidth:w,glyphHeight:S,glyphTop:g,glyphLeft:0,glyphAdvance:n};if(w===0||S===0)return E;const{ctx:C,buffer:D,gridInner:N,gridOuter:z}=this;C.clearRect(D,D,w,S),C.fillText(u,D,D+g);const G=C.getImageData(D,D,w,S);z.fill(H_,0,I),N.fill(0,0,I);for(let W=0;W<S;W++)for(let H=0;H<w;H++){const q=G.data[4*(W*w+H)+3]/255;if(q===0)continue;const Y=(W+D)*P+H+D;if(q===1)z[Y]=0,N[Y]=H_;else{const ie=.5-q;z[Y]=ie>0?ie*ie:0,N[Y]=ie<0?ie*ie:0}}e2(z,0,0,P,x,P,this.f,this.v,this.z),e2(N,D,D,w,S,P,this.f,this.v,this.z);for(let W=0;W<I;W++){const H=Math.sqrt(z[W])-Math.sqrt(N[W]);R[W]=Math.round(255-255*(H/this.radius+this.cutoff))}return E}};const nu=up;function i2(u,n){return u+n[1]-n[0]}function r2(u,n,l,d,_=1){const f=[],g=u.imagePrimary,w=g.pixelRatio,S=g.paddedRect.w-2*nu,P=g.paddedRect.h-2*nu,x=(u.right-u.left)*_,I=(u.bottom-u.top)*_,R=g.stretchX||[[0,S]],E=g.stretchY||[[0,P]],C=R.reduce(i2,0),D=E.reduce(i2,0),N=S-C,z=P-D;let G=0,W=C,H=0,q=D,Y=0,ie=N,he=0,ce=z;if(g.content&&d){const Te=g.content;G=G_(R,0,Te[0]),H=G_(E,0,Te[1]),W=G_(R,Te[0],Te[2]),q=G_(E,Te[1],Te[3]),Y=Te[0]-G,he=Te[1]-H,ie=Te[2]-Te[0]-W,ce=Te[3]-Te[1]-q}const le=(Te,de,Se,Pe)=>{const Me=$_(Te.stretch-G,W,x,u.left*_),Oe=W_(Te.fixed-Y,ie,Te.stretch,C),Ue=$_(de.stretch-H,q,I,u.top*_),Ge=W_(de.fixed-he,ce,de.stretch,D),Ne=$_(Se.stretch-G,W,x,u.left*_),rt=W_(Se.fixed-Y,ie,Se.stretch,C),mt=$_(Pe.stretch-H,q,I,u.top*_),it=W_(Pe.fixed-he,ce,Pe.stretch,D),Bt=new At(Me,Ue),Mt=new At(Ne,Ue),bt=new At(Ne,mt),_t=new At(Me,mt),Ht=new At(Oe/w,Ge/w),Ft=new At(rt/w,it/w),zt=n*Math.PI/180;if(zt){const Ai=Math.sin(zt),er=Math.cos(zt),Yi=[er,-Ai,Ai,er];Bt._matMult(Yi),Mt._matMult(Yi),_t._matMult(Yi),bt._matMult(Yi)}const ai=Te.stretch+Te.fixed,fi=Se.stretch+Se.fixed,_i=de.stretch+de.fixed,gi=Pe.stretch+Pe.fixed,wi=u.imageSecondary;return{tl:Bt,tr:Mt,bl:_t,br:bt,texPrimary:{x:g.paddedRect.x+nu+ai,y:g.paddedRect.y+nu+_i,w:fi-ai,h:gi-_i},texSecondary:wi?{x:wi.paddedRect.x+nu+ai,y:wi.paddedRect.y+nu+_i,w:fi-ai,h:gi-_i}:void 0,writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:Ht,pixelOffsetBR:Ft,minFontScaleX:ie/w/x,minFontScaleY:ce/w/I,isSDF:l}};if(d&&(g.stretchX||g.stretchY)){const Te=n2(R,N,C),de=n2(E,z,D);for(let Se=0;Se<Te.length-1;Se++){const Pe=Te[Se],Me=Te[Se+1];for(let Oe=0;Oe<de.length-1;Oe++)f.push(le(Pe,de[Oe],Me,de[Oe+1]))}}else f.push(le({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:S+1},{fixed:0,stretch:P+1}));return f}function G_(u,n,l){let d=0;for(const _ of u)d+=Math.max(n,Math.min(l,_[1]))-Math.max(n,Math.min(l,_[0]));return d}function n2(u,n,l){const d=[{fixed:-1,stretch:0}];for(const[_,f]of u){const g=d[d.length-1];d.push({fixed:_-g.stretch,stretch:g.stretch}),d.push({fixed:_-g.stretch,stretch:g.stretch+(f-_)})}return d.push({fixed:n+nu,stretch:l}),d}function $_(u,n,l,d){return u/n*l+d}function W_(u,n,l,d){return u-n*l/d}function jD(u,n,l,d){const _=n+u.positionedLines[d].lineOffset;return d===0?l+_/2:l+(_+(n+u.positionedLines[d-1].lineOffset))/2}function HD(u,n=1,l=!1){let d=1/0,_=1/0,f=-1/0,g=-1/0;const w=u[0];for(let E=0;E<w.length;E++){const C=w[E];(!E||C.x<d)&&(d=C.x),(!E||C.y<_)&&(_=C.y),(!E||C.x>f)&&(f=C.x),(!E||C.y>g)&&(g=C.y)}const S=Math.min(f-d,g-_);let P=S/2;const x=new un([],GD);if(S===0)return new At(d,_);for(let E=d;E<f;E+=S)for(let C=_;C<g;C+=S)x.push(new Nh(E+P,C+P,P,u));let I=function(E){let C=0,D=0,N=0;const z=E[0];for(let G=0,W=z.length,H=W-1;G<W;H=G++){const q=z[G],Y=z[H],ie=q.x*Y.y-Y.x*q.y;D+=(q.x+Y.x)*ie,N+=(q.y+Y.y)*ie,C+=3*ie}return new Nh(D/C,N/C,0,E)}(u),R=x.length;for(;x.length;){const E=x.pop();(E.d>I.d||!I.d)&&(I=E,l&&console.log("found best %d after %d probes",Math.round(1e4*E.d)/1e4,R)),E.max-I.d<=n||(P=E.h/2,x.push(new Nh(E.p.x-P,E.p.y-P,P,u)),x.push(new Nh(E.p.x+P,E.p.y-P,P,u)),x.push(new Nh(E.p.x-P,E.p.y+P,P,u)),x.push(new Nh(E.p.x+P,E.p.y+P,P,u)),R+=4)}return l&&(console.log(`num probes: ${R}`),console.log(`best distance: ${I.d}`)),I.p}function GD(u,n){return n.max-u.max}class Nh{constructor(n,l,d,_){this.p=new At(n,l),this.h=d,this.d=function(f,g){let w=!1,S=1/0;for(let P=0;P<g.length;P++){const x=g[P];for(let I=0,R=x.length,E=R-1;I<R;E=I++){const C=x[I],D=x[E];C.y>f.y!=D.y>f.y&&f.x<(D.x-C.x)*(f.y-C.y)/(D.y-C.y)+C.x&&(w=!w),S=Math.min(S,ve(f,C,D))}}return(w?1:-1)*Math.sqrt(S)}(this.p,_),this.max=this.d+this.h*Math.SQRT2}}const Fv=Number.POSITIVE_INFINITY,$D=Math.sqrt(2);function s2(u,[n,l]){let d=0,_=0;if(l===Fv){n<0&&(n=0);const f=n/$D;switch(u){case"top-right":case"top-left":_=f-7;break;case"bottom-right":case"bottom-left":_=7-f;break;case"bottom":_=7-n;break;case"top":_=n-7}switch(u){case"top-right":case"bottom-right":d=-f;break;case"top-left":case"bottom-left":d=f;break;case"left":d=n;break;case"right":d=-n}}else{switch(n=Math.abs(n),l=Math.abs(l),u){case"top-right":case"top-left":case"top":_=l-7;break;case"bottom-right":case"bottom-left":case"bottom":_=7-l}switch(u){case"top-right":case"bottom-right":case"right":d=-n;break;case"top-left":case"bottom-left":case"left":d=n}}return[d,_]}function kv(u){switch(u){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function WD(u,n,l,d,_,f,g,w,S,P,x,I,R,E,C){let D=f.textMaxSize.evaluate(n,{},I);D===void 0?D=g*f.textScaleFactor:D*=f.textScaleFactor;const N=u.layers[0].layout,z=N.get("icon-offset").evaluate(n,{},I),G=a2(l.horizontal)||l.vertical,W=R.name==="globe",H=An,q=g*f.textScaleFactor/H,Y=u.tilePixelRatio*D/H,ie=(Me=u.overscaling,u.zoom>18&&Me>2&&(Me>>=1),Math.max(Rt/(512*Me),1)*N.get("symbol-spacing")),he=N.get("text-padding")*u.tilePixelRatio,ce=N.get("icon-padding")*u.tilePixelRatio,le=Ti(N.get("text-max-angle")),Te=N.get("text-rotation-alignment")==="map"&&N.get("symbol-placement")!=="point",de=N.get("icon-rotation-alignment")==="map"&&N.get("symbol-placement")!=="point",Se=N.get("symbol-placement"),Pe=ie/2;var Me;const Oe=N.get("icon-text-fit").evaluate(n,{},I),Ue=N.get("icon-text-fit-padding").evaluate(n,{},I),Ge=Oe!=="none";let Ne;u.hasAnyIconTextFit===!1&&Ge&&(u.hasAnyIconTextFit=!0),d&&Ge&&(u.allowVerticalPlacement&&l.vertical&&(Ne=$T(d,l.vertical,Oe,Ue,z,q)),G&&(d=$T(d,G,Oe,Ue,z,q)));const rt=(mt,it,Bt)=>{if(it.x<0||it.x>=Rt||it.y<0||it.y>=Rt)return;let Mt=null;if(W){const{x:bt,y:_t,z:Ht}=R.projectTilePoint(it.x,it.y,Bt);Mt={anchor:new Xa(bt,_t,Ht,0,void 0),up:R.upVector(Bt,it.x,it.y)}}(function(bt,_t,Ht,Ft,zt,ai,fi,_i,gi,wi,Ai,er,Yi,ui,Wi,Zi,ar,Cr,Ur,Mr,vr,Fr,Hr,Tn,nr,ys,Vo){const co=bt.addToLineVertexArray(_t,Ft);let uo,cu,Gl,uu,Rp,VE,jE,HE=0,GE=0,$E=0,WE=0,gx=-1,yx=-1;const fa={};let qE=Bs("");const hu=Ht?Ht.anchor:_t,vx=gi.layout.get("icon-text-fit").evaluate(vr,{},nr)!=="none";let xx=0,bx=0;if(gi._unevaluatedLayout.getValue("text-radial-offset")===void 0?[xx,bx]=gi.layout.get("text-offset").evaluate(vr,{},nr).map(zs=>zs*An):(xx=gi.layout.get("text-radial-offset").evaluate(vr,{},nr)*An,bx=Fv),bt.allowVerticalPlacement&&zt.vertical){const zs=zt.vertical;if(Wi)VE=Lv(zs),_i&&(jE=Lv(_i));else{const vs=gi.layout.get("text-rotate").evaluate(vr,{},nr)+90;Gl=q_(wi,hu,_t,Ai,er,Yi,zs,ui,vs,Zi),_i&&(uu=q_(wi,hu,_t,Ai,er,Yi,_i,Cr,vs))}}if(ai){const zs=bt.iconSizeData,vs=gi.layout.get("icon-rotate").evaluate(vr,{},nr),Pp=r2(ai,vs,Hr,vx,Fr.iconScaleFactor),Ax=_i?r2(_i,vs,Hr,vx,Fr.iconScaleFactor):void 0;cu=q_(wi,hu,_t,Ai,er,Yi,ai,Cr,vs,null),HE=4*Pp.length;let du=null;zs.kind==="source"?(du=[ko*gi.layout.get("icon-size").evaluate(vr,{},nr)*Fr.iconScaleFactor],du[0]>Ul&&mi(`${bt.layerIds[0]}: Value for "icon-size" is >= ${dp}. Reduce your "icon-size".`)):zs.kind==="composite"&&(du=[ko*Fr.compositeIconSizes[0].evaluate(vr,{},nr)*Fr.iconScaleFactor,ko*Fr.compositeIconSizes[1].evaluate(vr,{},nr)*Fr.iconScaleFactor],(du[0]>Ul||du[1]>Ul)&&mi(`${bt.layerIds[0]}: Value for "icon-size" is >= ${dp}. Reduce your "icon-size".`)),bt.addSymbols(bt.icon,Pp,du,Mr,Ur,vr,!1,Ht,_t,co.lineStartIndex,co.lineLength,-1,Tn,nr,ys,Vo),gx=bt.icon.placedSymbolArray.length-1,Ax&&(GE=4*Ax.length,bt.addSymbols(bt.icon,Ax,du,Mr,Ur,vr,Ls.vertical,Ht,_t,co.lineStartIndex,co.lineLength,-1,Tn,nr,ys,Vo),yx=bt.icon.placedSymbolArray.length-1)}for(const zs in zt.horizontal){const vs=zt.horizontal[zs];uo||(qE=Bs(vs.text),Wi?Rp=Lv(vs):uo=q_(wi,hu,_t,Ai,er,Yi,vs,ui,gi.layout.get("text-rotate").evaluate(vr,{},nr),Zi));const Pp=vs.positionedLines.length===1;if($E+=o2(bt,Ht,_t,vs,fi,gi,Wi,vr,Zi,co,zt.vertical?Ls.horizontal:Ls.horizontalOnly,Pp?Object.keys(zt.horizontal):[zs],fa,gx,Fr,Tn,nr,ys),Pp)break}zt.vertical&&(WE+=o2(bt,Ht,_t,zt.vertical,fi,gi,Wi,vr,Zi,co,Ls.vertical,["vertical"],fa,yx,Fr,Tn,nr,ys));let $l=-1;const wx=(zs,vs)=>zs?Math.max(zs,vs):vs;$l=wx(Rp,$l),$l=wx(VE,$l),$l=wx(jE,$l);const EF=$l>-1?1:0;bt.glyphOffsetArray.length>=65535&&mi("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),vr.sortKey!==void 0&&bt.addToSortKeyRanges(bt.symbolInstances.length,vr.sortKey),bt.symbolInstances.emplaceBack(_t.x,_t.y,hu.x,hu.y,hu.z,fa.right>=0?fa.right:-1,fa.center>=0?fa.center:-1,fa.left>=0?fa.left:-1,fa.vertical>=0?fa.vertical:-1,gx,yx,qE,uo!==void 0?uo:bt.collisionBoxArray.length,uo!==void 0?uo+1:bt.collisionBoxArray.length,Gl!==void 0?Gl:bt.collisionBoxArray.length,Gl!==void 0?Gl+1:bt.collisionBoxArray.length,cu!==void 0?cu:bt.collisionBoxArray.length,cu!==void 0?cu+1:bt.collisionBoxArray.length,uu||bt.collisionBoxArray.length,uu?uu+1:bt.collisionBoxArray.length,Ai,$E,WE,HE,GE,EF,0,xx,bx,$l,0,vx?1:0)})(u,it,Mt,mt,l,d,_,Ne,u.layers[0],u.collisionBoxArray,n.index,n.sourceLayerIndex,u.index,he,Te,S,0,ce,de,z,n,f,P,x,I,E,C)};if(Se==="line")for(const mt of KT(n.geometry,0,0,Rt,Rt)){const it=VD(mt,ie,le,l.vertical||G,d,H,Y,u.overscaling,Rt);for(const Bt of it)G&&qD(u,G.text,Pe,Bt)||rt(mt,Bt,I)}else if(Se==="line-center"){for(const mt of n.geometry)if(mt.length>1){const it=UD(mt,le,l.vertical||G,d,H,Y);it&&rt(mt,it,I)}}else if(n.type==="Polygon")for(const mt of D_(n.geometry,0)){const it=HD(mt,16);rt(mt[0],new Xa(it.x,it.y,0,0,void 0),I)}else if(n.type==="LineString")for(const mt of n.geometry)rt(mt,new Xa(mt[0].x,mt[0].y,0,0,void 0),I);else if(n.type==="Point")for(const mt of n.geometry)for(const it of mt)rt([it],new Xa(it.x,it.y,0,0,void 0),I)}const dp=255,Ul=dp*ko;function o2(u,n,l,d,_,f,g,w,S,P,x,I,R,E,C,D,N,z){const G=function(q,Y,ie,he,ce,le,Te,de){const Se=[];if(Y.positionedLines.length===0)return Se;const Pe=he.layout.get("text-rotate").evaluate(le,{})*Math.PI/180,Me=function(rt){const mt=rt[0],it=rt[1],Bt=mt*it;return Bt>0?[mt,-it]:Bt<0?[-mt,it]:mt===0?[it,mt]:[it,-mt]}(ie);let Oe=Math.abs(Y.top-Y.bottom);for(const rt of Y.positionedLines)Oe-=rt.lineOffset;const Ue=Y.positionedLines.length,Ge=Oe/Ue;let Ne=Y.top-ie[1];for(let rt=0;rt<Ue;++rt){const mt=Y.positionedLines[rt];Ne=jD(Y,Ge,Ne,rt);for(const it of mt.positionedGlyphs){if(!it.rect)continue;const Bt=it.rect||{};let Mt=kD+1,bt=!0,_t=1,Ht=0;if(it.imageName){const Mr=Te[cn.build(it.imageName).getSerializedPrimary()];if(!Mr)continue;if(Mr.sdf){mi("SDF images are not supported in formatted text and will be ignored.");continue}bt=!1,_t=Mr.pixelRatio,Mt=up/_t}const Ft=(ce||de)&&it.vertical,zt=it.metrics.advance*it.scale/2,ai=it.metrics,fi=it.rect;if(fi===null)continue;de&&Y.verticalizable&&(Ht=it.imageName?zt-it.metrics.width*it.scale/2:0);const _i=ce?[it.x+zt,it.y]:[0,0];let gi=[0,0],wi=[0,0],Ai=!1;ce||(Ft?(wi=[it.x+zt+Me[0],it.y+Me[1]-Ht],Ai=!0):gi=[it.x+zt+ie[0],it.y+ie[1]-Ht]);const er=fi.w*it.scale/(_t*(it.localGlyph?Lo:1)),Yi=fi.h*it.scale/(_t*(it.localGlyph?Lo:1));let ui,Wi,Zi,ar;if(Ft){const Mr=it.y-Ne,vr=new At(-zt,zt-Mr),Fr=-Math.PI/2,Hr=new At(...wi);ui=new At(-zt+gi[0],gi[1]),ui._rotateAround(Fr,vr)._add(Hr),ui.x+=-Mr+zt,ui.y-=(ai.left-Mt)*it.scale;const Tn=it.imageName?ai.advance*it.scale:An*it.scale,nr=String.fromCodePoint(it.glyph);RD(nr)?ui.x+=(1-Mt)*it.scale:PD(nr)?ui.x+=Tn-ai.height*it.scale+(-Mt-1)*it.scale:ui.x+=it.imageName||ai.width+2*Mt===fi.w&&ai.height+2*Mt===fi.h?(Tn-Yi)/2:(Tn-(ai.height+2*Mt)*it.scale)/2,Wi=new At(ui.x,ui.y-er),Zi=new At(ui.x+Yi,ui.y),ar=new At(ui.x+Yi,ui.y-er)}else{const Mr=(ai.left-Mt)*it.scale-zt+gi[0],vr=(-ai.top-Mt)*it.scale+gi[1],Fr=Mr+er,Hr=vr+Yi;ui=new At(Mr,vr),Wi=new At(Fr,vr),Zi=new At(Mr,Hr),ar=new At(Fr,Hr)}if(Pe){let Mr;Mr=ce?new At(0,0):Ai?new At(Me[0],Me[1]):new At(ie[0],ie[1]),ui._rotateAround(Pe,Mr),Wi._rotateAround(Pe,Mr),Zi._rotateAround(Pe,Mr),ar._rotateAround(Pe,Mr)}const Cr=new At(0,0),Ur=new At(0,0);Se.push({tl:ui,tr:Wi,bl:Zi,br:ar,texPrimary:Bt,texSecondary:void 0,writingMode:Y.writingMode,glyphOffset:_i,sectionIndex:it.sectionIndex,isSDF:bt,pixelOffsetTL:Cr,pixelOffsetBR:Ur,minFontScaleX:0,minFontScaleY:0})}}return Se}(0,d,S,f,g,w,_,u.allowVerticalPlacement),W=u.textSizeData;let H=null;W.kind==="source"?(H=[ko*f.layout.get("text-size").evaluate(w,{},N)*C.textScaleFactor],H[0]>Ul&&mi(`${u.layerIds[0]}: Value for "text-size" is >= ${dp}. Reduce your "text-size".`)):W.kind==="composite"&&(H=[ko*C.compositeTextSizes[0].evaluate(w,{},N)*C.textScaleFactor,ko*C.compositeTextSizes[1].evaluate(w,{},N)*C.textScaleFactor],(H[0]>Ul||H[1]>Ul)&&mi(`${u.layerIds[0]}: Value for "text-size" is >= ${dp}. Reduce your "text-size".`)),u.addSymbols(u.text,G,H,S,g,w,x,n,l,P.lineStartIndex,P.lineLength,E,D,N,z,!1);for(const q of I)R[q]=u.text.placedSymbolArray.length-1;return 4*G.length}function a2(u){for(const n in u)return u[n];return null}function q_(u,n,l,d,_,f,g,w,S,P){let x=g.top,I=g.bottom,R=g.left,E=g.right;const C=g.collisionPadding;if(C&&(R-=C[0],x-=C[1],E+=C[2],I+=C[3]),S){const D=new At(R,x),N=new At(E,x),z=new At(R,I),G=new At(E,I),W=Ti(S);let H=new At(0,0);P&&(H=new At(P[0],P[1])),D._rotateAround(W,H),N._rotateAround(W,H),z._rotateAround(W,H),G._rotateAround(W,H),R=Math.min(D.x,N.x,z.x,G.x),E=Math.max(D.x,N.x,z.x,G.x),x=Math.min(D.y,N.y,z.y,G.y),I=Math.max(D.y,N.y,z.y,G.y)}return u.emplaceBack(n.x,n.y,n.z,l.x,l.y,R,x,E,I,w,d,_,f),u.length-1}function Lv(u){u.collisionPadding&&(u.top-=u.collisionPadding[1],u.bottom+=u.collisionPadding[3]);const n=u.bottom-u.top;return n>0?Math.max(10,n):null}function qD(u,n,l,d){const _=u.compareText;if(n in _){const f=_[n];for(let g=f.length-1;g>=0;g--)if(d.dist(f[g])<l)return!0}else _[n]=[];return _[n].push(d),!1}function l2(u,n){const l=u.fovAboveCenter,d=u.elevation?u.elevation.getMinElevationBelowMSL()*n:0,_=(u._camera.position[2]*u.worldSize-d)/Math.cos(u._pitch),f=Math.sin(l)*_/Math.sin(Math.max(Math.PI/2-u._pitch-l,.01));let g=Math.sin(u._pitch)*f+_;const w=_*(1/u._horizonShift);if(!u.elevation||u.elevation.exaggeration()===0){let S=Math.max(u.zoom-17,0);u.isOrthographic&&(S/=10),g*=1+S}return Math.min(1.01*g,w)}function fp(u,n){if(!n.isReprojectedInTileSpace)return{scale:1<<u.z,x:u.x,y:u.y,x2:u.x+1,y2:u.y+1,projection:n};const l=Math.pow(2,-u.z),d=u.x*l,_=(u.x+1)*l,f=u.y*l,g=(u.y+1)*l,w=es(d),S=es(_),P=an(f),x=an(g),I=n.project(w,P),R=n.project(S,P),E=n.project(S,x),C=n.project(w,x);let D=Math.min(I.x,R.x,E.x,C.x),N=Math.min(I.y,R.y,E.y,C.y),z=Math.max(I.x,R.x,E.x,C.x),G=Math.max(I.y,R.y,E.y,C.y);const W=l/16;function H(Y,ie,he,ce,le,Te){const de=(he+le)/2,Se=(ce+Te)/2,Pe=n.project(es(de),an(Se)),Me=Math.max(0,D-Pe.x,N-Pe.y,Pe.x-z,Pe.y-G);D=Math.min(D,Pe.x),z=Math.max(z,Pe.x),N=Math.min(N,Pe.y),G=Math.max(G,Pe.y),Me>W&&(H(Y,Pe,he,ce,de,Se),H(Pe,ie,de,Se,le,Te))}H(I,R,d,f,_,f),H(R,E,_,f,_,g),H(E,C,_,g,d,g),H(C,I,d,g,d,f),D-=W,N-=W,z+=W,G+=W;const q=1/Math.max(z-D,G-N);return{scale:q,x:D*q,y:N*q,x2:z*q,y2:G*q,projection:n}}function c2(u,{x:n,y:l},d=0){return new At(((n-d)*u.scale-u.x)*Rt,(l*u.scale-u.y)*Rt)}const XD=Re.mat4.identity(new Float32Array(16));class Vl{constructor(n){this.spec=n,this.name=n.name,this.wrap=!1,this.requiresDraping=!1,this.supportsWorldCopies=!1,this.supportsTerrain=!1,this.supportsFog=!1,this.supportsFreeCamera=!1,this.zAxisUnit="meters",this.isReprojectedInTileSpace=!0,this.unsupportedLayers=["custom"],this.center=[0,0],this.range=[3.5,7]}project(n,l){return{x:0,y:0,z:0}}unproject(n,l){return new Li(0,0)}projectTilePoint(n,l,d){return{x:n,y:l,z:0}}locationPoint(n,l,d=!0){return n._coordinatePoint(n.locationCoordinate(l),d)}pixelsPerMeter(n,l){return Dn(1,n)*l}pixelSpaceConversion(n,l,d){return 1}farthestPixelDistance(n){return l2(n,n.pixelsPerMeter)}pointCoordinate(n,l,d,_){const f=n.horizonLineFromTop(!1),g=new At(l,Math.max(f,d));return n.rayIntersectionCoordinate(n.pointRayIntersection(g,_))}pointCoordinate3D(n,l,d){const _=new At(l,d);if(n.elevation)return n.elevation.pointCoordinate(_);{const f=this.pointCoordinate(n,_.x,_.y,0);return[f.x,f.y,f.z]}}isPointAboveHorizon(n,l){if(n.elevation&&n.elevation.visibleDemTiles.length)return!this.pointCoordinate3D(n,l.x,l.y);const d=n.horizonLineFromTop();return l.y<d}createInversionMatrix(n,l){return XD}createTileMatrix(n,l,d){let _,f,g;const w=d.canonical,S=Re.mat4.identity(new Float64Array(16));if(this.isReprojectedInTileSpace){const P=fp(w,this);_=1,f=P.x+d.wrap*P.scale,g=P.y,Re.mat4.scale(S,S,[_/P.scale,_/P.scale,n.pixelsPerMeter/l])}else _=l/n.zoomScale(w.z),f=(w.x+Math.pow(2,w.z)*d.wrap)*_,g=w.y*_;return Re.mat4.translate(S,S,[f,g,0]),Re.mat4.scale(S,S,[_/Rt,_/Rt,1]),S}upVector(n,l,d){return[0,0,1]}upVectorScale(n,l,d){return{metersToTile:1}}}class ZD extends Vl{constructor(n){super(n),this.range=[4,7],this.center=n.center||[-96,37.5];const[l,d]=this.parallels=n.parallels||[29.5,45.5],_=Math.sin(Ti(l));this.n=(_+Math.sin(Ti(d)))/2,this.c=1+_*(2*this.n-_),this.r0=Math.sqrt(this.c)/this.n}project(n,l){const{n:d,c:_,r0:f}=this,g=Ti(n-this.center[0]),w=Ti(l),S=Math.sqrt(_-2*d*Math.sin(w))/d;return{x:S*Math.sin(g*d),y:S*Math.cos(g*d)-f,z:0}}unproject(n,l){const{n:d,c:_,r0:f}=this,g=f+l;let w=Math.atan2(n,Math.abs(g))*Math.sign(g);g*d<0&&(w-=Math.PI*Math.sign(n)*Math.sign(g));const S=Ti(this.center[0])*d;w=us(w,-Math.PI-S,Math.PI-S);const P=yi(kr(w/d)+this.center[0],-180,180),x=Math.asin(yi((_-(n*n+g*g)*d*d)/(2*d),-1,1)),I=yi(kr(x),-85.051129,jn);return new Li(P,I)}}const pp=1.340264,mp=-.081106,_p=893e-6,gp=.003796,X_=Math.sqrt(3)/2;class YD extends Vl{project(n,l){l=l/180*Math.PI,n=n/180*Math.PI;const d=Math.asin(X_*Math.sin(l)),_=d*d,f=_*_*_;return{x:.5*(n*Math.cos(d)/(X_*(pp+3*mp*_+f*(7*_p+9*gp*_)))/Math.PI+.5),y:1-.5*(d*(pp+mp*_+f*(_p+gp*_))/Math.PI+1),z:0}}unproject(n,l){n=(2*n-.5)*Math.PI;let d=l=(2*(1-l)-1)*Math.PI,_=d*d,f=_*_*_;for(let x,I,R,E=0;E<12&&(I=d*(pp+mp*_+f*(_p+gp*_))-l,R=pp+3*mp*_+f*(7*_p+9*gp*_),x=I/R,d=yi(d-x,-Math.PI/3,Math.PI/3),_=d*d,f=_*_*_,!(Math.abs(x)<1e-12));++E);const g=X_*n*(pp+3*mp*_+f*(7*_p+9*gp*_))/Math.cos(d),w=Math.asin(Math.sin(d)/X_),S=yi(180*g/Math.PI,-180,180),P=yi(180*w/Math.PI,-85.051129,jn);return new Li(S,P)}}class KD extends Vl{constructor(n){super(n),this.wrap=!0,this.supportsWorldCopies=!0}project(n,l){return{x:.5+n/360,y:.5-l/360,z:0}}unproject(n,l){const d=360*(n-.5),_=yi(360*(.5-l),-85.051129,jn);return new Li(d,_)}}const zh=Math.PI/2;function Z_(u){return Math.tan((zh+u)/2)}class JD extends Vl{constructor(n){super(n),this.center=n.center||[0,30];const[l,d]=this.parallels=n.parallels||[30,30];let _=Ti(l),f=Ti(d);this.southernCenter=_+f<0,this.southernCenter&&(_=-_,f=-f);const g=Math.cos(_),w=Z_(_);this.n=_===f?Math.sin(_):Math.log(g/Math.cos(f))/Math.log(Z_(f)/w),this.f=g*Math.pow(Z_(_),this.n)/this.n}project(n,l){l=Ti(l),this.southernCenter&&(l=-l),n=Ti(n-this.center[0]);const d=1e-6,{n:_,f}=this;f>0?l<-zh+d&&(l=-zh+d):l>zh-d&&(l=zh-d);const g=f/Math.pow(Z_(l),_);let w=g*Math.sin(_*n),S=f-g*Math.cos(_*n);return w=.5*(w/Math.PI+.5),S=.5*(S/Math.PI+.5),{x:w,y:this.southernCenter?S:1-S,z:0}}unproject(n,l){n=(2*n-.5)*Math.PI,this.southernCenter&&(l=1-l),l=(2*(1-l)-.5)*Math.PI;const{n:d,f:_}=this,f=_-l,g=Math.sign(f),w=Math.sign(d)*Math.sqrt(n*n+f*f);let S=Math.atan2(n,Math.abs(f))*g;f*d<0&&(S-=Math.PI*Math.sign(n)*g);const P=yi(kr(S/d)+this.center[0],-180,180),x=yi(kr(2*Math.atan(Math.pow(_/w,1/d))-zh),-85.051129,jn);return new Li(P,this.southernCenter?-x:x)}}class u2 extends Vl{constructor(n){super(n),this.wrap=!0,this.supportsWorldCopies=!0,this.supportsTerrain=!0,this.supportsFog=!0,this.supportsFreeCamera=!0,this.isReprojectedInTileSpace=!1,this.unsupportedLayers=[],this.range=null}project(n,l){return{x:so(n),y:ks(l),z:0}}unproject(n,l){const d=es(n),_=an(l);return new Li(d,_)}}const h2=Ti(jn);class QD extends Vl{project(n,l){const d=(l=Ti(l))*l,_=d*d;return{x:.5*((n=Ti(n))*(.8707-.131979*d+_*(_*(.003971*d-.001529*_)-.013791))/Math.PI+.5),y:1-.5*(l*(1.007226+d*(.015085+_*(.028874*d-.044475-.005916*_)))/Math.PI+1),z:0}}unproject(n,l){n=(2*n-.5)*Math.PI;let d=l=(2*(1-l)-1)*Math.PI,_=25,f=0,g=d*d;do{g=d*d;const P=g*g;f=(d*(1.007226+g*(.015085+P*(.028874*g-.044475-.005916*P)))-l)/(1.007226+g*(.045255+P*(.259866*g-.311325-.005916*11*P))),d=yi(d-f,-h2,h2)}while(Math.abs(f)>1e-6&&--_>0);g=d*d;const w=yi(kr(n/(.8707+g*(g*(g*g*g*(.003971-.001529*g)-.013791)-.131979))),-180,180),S=kr(d);return new Li(w,S)}}const d2=Ti(jn);class eO extends Vl{project(n,l){l=Ti(l),n=Ti(n);const d=Math.cos(l),_=2/Math.PI,f=Math.acos(d*Math.cos(n/2)),g=Math.sin(f)/f,w=.5*(n*_+2*d*Math.sin(n/2)/g)||0,S=.5*(l+Math.sin(l)/g)||0;return{x:.5*(w/Math.PI+.5),y:1-.5*(S/Math.PI+1),z:0}}unproject(n,l){let d=n=(2*n-.5)*Math.PI,_=l=(2*(1-l)-1)*Math.PI,f=25;const g=1e-6;let w=0,S=0;do{const P=Math.cos(_),x=Math.sin(_),I=2*x*P,R=x*x,E=P*P,C=Math.cos(d/2),D=Math.sin(d/2),N=2*C*D,z=D*D,G=1-E*C*C,W=G?1/G:0,H=G?Math.acos(P*C)*Math.sqrt(1/G):0,q=.5*(2*H*P*D+2*d/Math.PI)-n,Y=.5*(H*x+_)-l,ie=.5*W*(E*z+H*P*C*R)+1/Math.PI,he=W*(N*I/4-H*x*D),ce=.125*W*(I*D-H*x*E*N),le=.5*W*(R*C+H*z*P)+.5,Te=he*ce-le*ie;w=(Y*he-q*le)/Te,S=(q*ce-Y*ie)/Te,d=yi(d-w,-Math.PI,Math.PI),_=yi(_-S,-d2,d2)}while((Math.abs(w)>g||Math.abs(S)>g)&&--f>0);return new Li(kr(d),kr(_))}}class f2 extends Vl{constructor(n){super(n),this.center=n.center||[0,0],this.parallels=n.parallels||[0,0],this.cosPhi=Math.max(.01,Math.cos(Ti(this.parallels[0]))),this.scale=1/(2*Math.max(Math.PI*this.cosPhi,1/this.cosPhi)),this.wrap=!0,this.supportsWorldCopies=!0}project(n,l){const{scale:d,cosPhi:_}=this;return{x:Ti(n)*_*d+.5,y:-Math.sin(Ti(l))/_*d+.5,z:0}}unproject(n,l){const{scale:d,cosPhi:_}=this,f=-(l-.5)/d,g=yi(kr((n-.5)/d)/_,-180,180),w=Math.asin(yi(f*_,-1,1)),S=yi(kr(w),-85.051129,jn);return new Li(g,S)}}class tO extends u2{constructor(n){super(n),this.requiresDraping=!0,this.supportsWorldCopies=!1,this.supportsFog=!0,this.zAxisUnit="pixels",this.unsupportedLayers=["debug"],this.range=[3,5]}projectTilePoint(n,l,d){const _=Ki(n,l,d),f=Zr(Lr(d));return Re.vec3.transformMat4(_,_,f),{x:_[0],y:_[1],z:_[2]}}locationPoint(n,l){const d=Ga(l.lat,l.lng),_=Re.vec3.normalize([],d),f=n.elevation?n.elevation.getAtPointOrZero(n.locationCoordinate(l),n._centerAltitude):n._centerAltitude,g=Dn(1,0)*Rt*f;Re.vec3.scaleAndAdd(d,d,_,g);const w=Re.mat4.identity(new Float64Array(16));return Re.mat4.multiply(w,n.pixelMatrix,n.globeMatrix),Re.vec3.transformMat4(d,d,w),new At(d[0],d[1])}pixelsPerMeter(n,l){return Dn(1,0)*l}pixelSpaceConversion(n,l,d){const _=Dn(1,n)*l,f=ii(Dn(1,45)*l,_,d);return this.pixelsPerMeter(n,l)/f}createTileMatrix(n,l,d){const _=Ji(Lr(d.canonical));return Re.mat4.multiply(new Float64Array(16),n.globeMatrix,_)}createInversionMatrix(n,l){const{center:d}=n,_=Zr(Lr(l));return Re.mat4.rotateY(_,_,Ti(d.lng)),Re.mat4.rotateX(_,_,Ti(d.lat)),Re.mat4.scale(_,_,[n._pixelsPerMercatorPixel,n._pixelsPerMercatorPixel,1]),Float32Array.from(_)}pointCoordinate(n,l,d,_){return Hi(n,l,d,!0)||new c(0,0)}pointCoordinate3D(n,l,d){const _=this.pointCoordinate(n,l,d,0);return[_.x,_.y,_.z]}isPointAboveHorizon(n,l){return!Hi(n,l.x,l.y,!1)}farthestPixelDistance(n){const l=function(_,f){const g=_.cameraToCenterDistance,w=_._centerAltitude*f,S=_._camera,P=_._camera.forward(),x=Re.vec3.add([],Re.vec3.scale([],P,-g),[0,0,w]),I=_.worldSize/(2*Math.PI),R=[0,0,-I],E=_.width/_.height,C=Math.tan(_.fovAboveCenter),D=Re.vec3.scale([],S.up(),C),N=Re.vec3.scale([],S.right(),C*E),z=Re.vec3.normalize([],Re.vec3.add([],Re.vec3.add([],P,D),N)),G=[];let W;if(new ci(x,z).closestPointOnSphere(R,I,G)){const H=Re.vec3.add([],G,R),q=Re.vec3.sub([],H,x);W=Math.cos(_.fovAboveCenter)*Re.vec3.length(q)}else{const H=Re.vec3.sub([],x,R),q=Re.vec3.sub([],R,x);Re.vec3.normalize(q,q);const Y=Re.vec3.length(H)-I;W=Math.sqrt(Y*(Y+2*I));const ie=Math.acos(W/(I+Y))-Math.acos(Re.vec3.dot(P,q));W*=Math.cos(ie)}return 1.01*W}(n,this.pixelsPerMeter(n.center.lat,n.worldSize)),d=Hn(n.zoom);if(d>0){const _=l2(n,Dn(1,n.center.lat)*n.worldSize),f=n.worldSize/(2*Math.PI),g=Math.max(n.width,n.height)/n.worldSize*Math.PI;return ii(l,_+f*(1-Math.cos(g)),Math.pow(d,10))}return l}upVector(n,l,d){return Ki(l,d,n,1)}upVectorScale(n){return{metersToTile:Ei(Ri(Lr(n)))}}}function p2(u){const n=u.parallels,l=!!n&&Math.abs(n[0]+n[1])<.01;switch(u.name){case"mercator":return new u2(u);case"equirectangular":return new KD(u);case"naturalEarth":return new QD(u);case"equalEarth":return new YD(u);case"winkelTripel":return new eO(u);case"albers":return l?new f2(u):new ZD(u);case"lambertConformalConic":return l?new f2(u):new JD(u);case"globe":return new tO(u)}throw new Error(`Invalid projection name: ${u.name}`)}const iO=Oh.VectorTileFeature.types,rO=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function Y_(u,n,l,d,_,f,g,w,S,P,x,I,R){const E=w?Math.min(Ul,Math.round(w[0])):0,C=w?Math.min(Ul,Math.round(w[1])):0;u.emplaceBack(n,l,Math.round(32*d),Math.round(32*_),f,g,(E<<1)+(S?1:0),C,16*P,16*x,256*I,256*R)}function K_(u,n,l){u.emplaceBack(n,l)}function J_(u,n,l,d,_,f,g){u.emplaceBack(n,l,d,_,f,g)}function Q_(u,n,l,d,_){u.emplaceBack(n,l,d,_),u.emplaceBack(n,l,d,_),u.emplaceBack(n,l,d,_),u.emplaceBack(n,l,d,_)}function nO(u){for(const n of u.sections)if(Ef(n.text))return!0;return!1}class Nv{constructor(n){this.layoutVertexArray=new Df,this.indexArray=new on,this.programConfigurations=n,this.segments=new Ar,this.dynamicLayoutVertexArray=new Ua,this.opacityVertexArray=new Ff,this.placedSymbolArray=new g_,this.iconTransitioningVertexArray=new aa,this.globeExtVertexArray=new Of,this.zOffsetVertexArray=new Gc}isEmpty(){return this.layoutVertexArray.length===0&&this.indexArray.length===0&&this.dynamicLayoutVertexArray.length===0&&this.opacityVertexArray.length===0&&this.iconTransitioningVertexArray.length===0}upload(n,l,d,_,f){this.isEmpty()||(d&&(this.layoutVertexBuffer=n.createVertexBuffer(this.layoutVertexArray,xD.members),this.indexBuffer=n.createIndexBuffer(this.indexArray,l),this.dynamicLayoutVertexBuffer=n.createVertexBuffer(this.dynamicLayoutVertexArray,wD.members,!0),this.opacityVertexBuffer=n.createVertexBuffer(this.opacityVertexArray,rO,!0),this.iconTransitioningVertexArray.length>0&&(this.iconTransitioningVertexBuffer=n.createVertexBuffer(this.iconTransitioningVertexArray,TD.members,!0)),this.globeExtVertexArray.length>0&&(this.globeExtVertexBuffer=n.createVertexBuffer(this.globeExtVertexArray,bD.members,!0)),!this.zOffsetVertexBuffer&&(this.zOffsetVertexArray.length>0||f)&&(this.zOffsetVertexBuffer=n.createVertexBuffer(this.zOffsetVertexArray,AD.members,!0)),this.opacityVertexBuffer.itemSize=1),(d||_)&&this.programConfigurations.upload(n))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy(),this.iconTransitioningVertexBuffer&&this.iconTransitioningVertexBuffer.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy())}}Vt(Nv,"SymbolBuffers");class zv{constructor(n,l,d){this.layoutVertexArray=new n,this.layoutAttributes=l,this.indexArray=new d,this.segments=new Ar,this.collisionVertexArray=new Nf,this.collisionVertexArrayExt=new Ua}upload(n){this.layoutVertexBuffer=n.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=n.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=n.createVertexBuffer(this.collisionVertexArray,ED.members,!0),this.collisionVertexBufferExt=n.createVertexBuffer(this.collisionVertexArrayExt,SD.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy(),this.collisionVertexBufferExt.destroy())}}Vt(zv,"CollisionBuffers");class eg{constructor(n){this.collisionBoxArray=n.collisionBoxArray,this.zoom=n.zoom,this.lut=n.lut,this.overscaling=n.overscaling,this.layers=n.layers,this.layerIds=this.layers.map(g=>g.fqid),this.index=n.index,this.pixelRatio=n.pixelRatio,this.sourceLayerIndex=n.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.fullyClipped=!1,this.hasAnyIconTextFit=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=Re.mat4.identity([]),this.placementViewportMatrix=Re.mat4.identity([]);const l=this.layers[0]._unevaluatedLayout._values;this.textSizeData=Cv(this.zoom,l["text-size"]),this.iconSizeData=Cv(this.zoom,l["icon-size"]);const d=this.layers[0].layout,_=d.get("symbol-sort-key"),f=d.get("symbol-z-order");this.canOverlap=d.get("text-allow-overlap")||d.get("icon-allow-overlap")||d.get("text-ignore-placement")||d.get("icon-ignore-placement"),this.sortFeaturesByKey=f!=="viewport-y"&&_.constantOr(1)!==void 0,this.sortFeaturesByY=(f==="viewport-y"||f==="auto"&&!this.sortFeaturesByKey)&&this.canOverlap,this.writingModes=d.get("text-writing-mode").map(g=>Ls[g]),this.stateDependentLayerIds=this.layers.filter(g=>g.isStateDependent()).map(g=>g.id),this.sourceID=n.sourceID,this.projection=n.projection,this.hasAnyZOffset=!1,this.zOffsetSortDirty=!1,this.zOffsetBuffersNeedUpload=d.get("symbol-z-elevate"),this.activeReplacements=[],this.replacementUpdateTime=0}createArrays(){this.text=new Nv(new ua(this.layers,{zoom:this.zoom,lut:this.lut},n=>n.startsWith("text")||n.startsWith("symbol"))),this.icon=new Nv(new ua(this.layers,{zoom:this.zoom,lut:this.lut},n=>n.startsWith("icon")||n.startsWith("symbol"))),this.glyphOffsetArray=new x_,this.lineVertexArray=new b_,this.symbolInstances=new v_}calculateGlyphDependencies(n,l,d,_,f){for(const g of n){const w=g.codePointAt(0);if(w===void 0)break;if(l[w]=!0,_&&f&&w<=65535){const S=lp[g];S&&(l[S.charCodeAt(0)]=!0)}}}updateFootprints(n,l){}updateReplacement(n,l){if(l.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=l.updateTime;const d=l.getReplacementRegionsForTile(n.toUnwrapped(),!0);return!xv(this.activeReplacements,d)&&(this.activeReplacements=d,!0)}populate(n,l,d,_){const f=this.layers[0],g=f.layout,w=this.projection.name==="globe",S=g.get("text-font"),P=g.get("text-field"),x=g.get("icon-image"),[I,R]=g.get("icon-size-scale-range"),E=yi(l.scaleFactor||1,I,R),C=(P.value.kind!=="constant"||P.value.value instanceof vn&&!P.value.value.isEmpty()||P.value.value.toString().length>0)&&(S.value.kind!=="constant"||S.value.value.length>0),D=x.value.kind!=="constant"||!!x.value.value||Object.keys(x.parameters).length>0,N=g.get("symbol-sort-key");if(this.features=[],!C&&!D)return;const z=l.iconDependencies,G=l.glyphDependencies,W=l.availableImages,H=new tr(this.zoom);for(const{feature:q,id:Y,index:ie,sourceLayerIndex:he}of n){const ce=f._featureFilter.needGeometry,le=U(q,ce);if(!f._featureFilter.filter(H,le,d))continue;if(ce||(le.geometry=L(q,d,_)),w&&q.type!==1&&d.z<=5){const Me=le.geometry,Oe=.98078528056,Ue=(Ge,Ne)=>{const rt=Ki(Ge.x,Ge.y,d,1),mt=Ki(Ne.x,Ne.y,d,1);return Re.vec3.dot(rt,mt)<Oe};for(let Ge=0;Ge<Me.length;Ge++)Me[Ge]=A(Me[Ge],Ue)}let Te,de;if(C){const Me=f.getValueAndResolveTokens("text-field",le,d,W),Oe=vn.factory(Me);nO(Oe)&&(this.hasRTLText=!0),(!this.hasRTLText||mh()==="unavailable"||this.hasRTLText&&fs.isParsed())&&(Te=MD(Oe,f,le))}if(D){const Me=f.getValueAndResolveTokens("icon-image",le,d,W);de=Me instanceof cn?Me:cn.build(Me)}if(!Te&&!de)continue;const Se=this.sortFeaturesByKey?N.evaluate(le,{},d):void 0,Pe={id:Y,text:Te,icon:de,index:ie,sourceLayerIndex:he,geometry:le.geometry,properties:q.properties,type:iO[q.type],sortKey:Se};if(this.features.push(Pe),de){const Me=Iv(this.iconSizeData,this.layers[0]._unevaluatedLayout._values["icon-size"],d,this.zoom,Pe)*E*this.pixelRatio,Oe=de.getPrimary().scaleSelf(Me);if(z[Oe.id]=z[Oe.id]||[],z[Oe.id].push(Oe),de.nameSecondary){const Ue=de.getSecondary().scaleSelf(Me);z[Ue.id]=z[Ue.id]||[],z[Ue.id].push(Ue)}}if(Te){const Me=S.evaluate(le,{},d).join(","),Oe=g.get("text-rotation-alignment")==="map"&&g.get("symbol-placement")!=="point";this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(Ls.vertical)>=0;for(const Ue of Te.sections)if(Ue.image){const Ge=Ue.image.getPrimary().scaleSelf(this.pixelRatio);z[Ge.id]=z[Ge.id]||[],z[Ge.id].push(Ge)}else{const Ge=wf(Te.toString()),Ne=Ue.fontStack||Me,rt=G[Ne]=G[Ne]||{};this.calculateGlyphDependencies(Ue.text,rt,Oe,this.allowVerticalPlacement,Ge)}}}g.get("symbol-placement")==="line"&&(this.features=function(q){const Y={},ie={},he=[];let ce=0;function le(Pe){he.push(q[Pe]),ce++}function Te(Pe,Me,Oe){const Ue=ie[Pe];return delete ie[Pe],ie[Me]=Ue,he[Ue].geometry[0].pop(),he[Ue].geometry[0]=he[Ue].geometry[0].concat(Oe[0]),Ue}function de(Pe,Me,Oe){const Ue=Y[Me];return delete Y[Me],Y[Pe]=Ue,he[Ue].geometry[0].shift(),he[Ue].geometry[0]=Oe[0].concat(he[Ue].geometry[0]),Ue}function Se(Pe,Me,Oe){const Ue=Oe?Me[0][Me[0].length-1]:Me[0][0];return`${Pe}:${Ue.x}:${Ue.y}`}for(let Pe=0;Pe<q.length;Pe++){const Me=q[Pe],Oe=Me.geometry,Ue=Me.text?Me.text.toString():null;if(!Ue){le(Pe);continue}const Ge=Se(Ue,Oe),Ne=Se(Ue,Oe,!0);if(Ge in ie&&Ne in Y&&ie[Ge]!==Y[Ne]){const rt=de(Ge,Ne,Oe),mt=Te(Ge,Ne,he[rt].geometry);delete Y[Ge],delete ie[Ne],ie[Se(Ue,he[mt].geometry,!0)]=mt,he[rt].geometry=null}else Ge in ie?Te(Ge,Ne,Oe):Ne in Y?de(Ge,Ne,Oe):(le(Pe),Y[Ge]=ce-1,ie[Ne]=ce-1)}return he.filter(Pe=>Pe.geometry)}(this.features)),this.sortFeaturesByKey&&this.features.sort((q,Y)=>q.sortKey-Y.sortKey)}update(n,l,d,_,f,g,w){this.text.programConfigurations.updatePaintArrays(n,l,f,d,_,g,w),this.icon.programConfigurations.updatePaintArrays(n,l,f,d,_,g,w)}updateZOffset(){const n=(f,g,w)=>{d+=g,d>f.length&&f.resize(d);for(let S=-g;S<0;S++)f.emplace(S+d,w)},l=(f,g,w)=>{_+=g,_>f.length&&f.resize(_);for(let S=-g;S<0;S++)f.emplace(S+_,w)};if(!this.zOffsetBuffersNeedUpload)return;this.zOffsetBuffersNeedUpload=!1;let d=0,_=0;for(let f=0;f<this.symbolInstances.length;f++){const g=this.symbolInstances.get(f),{numHorizontalGlyphVertices:w,numVerticalGlyphVertices:S,numIconVertices:P}=g,x=g.zOffset,I=P>0;if((w>0||S>0)&&(n(this.text.zOffsetVertexArray,w,x),n(this.text.zOffsetVertexArray,S,x)),I){const{placedIconSymbolIndex:R,verticalPlacedIconSymbolIndex:E}=g;R>=0&&l(this.icon.zOffsetVertexArray,P,x),E>=0&&l(this.icon.zOffsetVertexArray,g.numVerticalIconVertices,x)}}this.text.zOffsetVertexBuffer&&this.text.zOffsetVertexBuffer.updateData(this.text.zOffsetVertexArray),this.icon.zOffsetVertexBuffer&&this.icon.zOffsetVertexBuffer.updateData(this.icon.zOffsetVertexArray)}isEmpty(){return this.symbolInstances.length===0&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(n){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(n),this.iconCollisionBox.upload(n)),this.text.upload(n,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.icon.upload(n,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}getProjection(){return this.projectionInstance||(this.projectionInstance=p2(this.projection)),this.projectionInstance}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(n,l){const d=this.lineVertexArray.length;if(n.segment!==void 0)for(const{x:_,y:f}of l)this.lineVertexArray.emplaceBack(_,f);return{lineStartIndex:d,lineLength:this.lineVertexArray.length-d}}addSymbols(n,l,d,_,f,g,w,S,P,x,I,R,E,C,D,N){const z=n.indexArray,G=n.layoutVertexArray,W=n.globeExtVertexArray,H=n.segments.prepareSegment(4*l.length,G,z,this.canOverlap?g.sortKey:void 0),q=this.glyphOffsetArray.length,Y=H.vertexLength,ie=this.allowVerticalPlacement&&w===Ls.vertical?Math.PI/2:0,he=g.text&&g.text.sections;for(let le=0;le<l.length;le++){const{tl:Te,tr:de,bl:Se,br:Pe,texPrimary:Me,texSecondary:Oe,pixelOffsetTL:Ue,pixelOffsetBR:Ge,minFontScaleX:Ne,minFontScaleY:rt,glyphOffset:mt,isSDF:it,sectionIndex:Bt}=l[le],Mt=H.vertexLength,bt=mt[1];if(Y_(G,P.x,P.y,Te.x,bt+Te.y,Me.x,Me.y,d,it,Ue.x,Ue.y,Ne,rt),Y_(G,P.x,P.y,de.x,bt+de.y,Me.x+Me.w,Me.y,d,it,Ge.x,Ue.y,Ne,rt),Y_(G,P.x,P.y,Se.x,bt+Se.y,Me.x,Me.y+Me.h,d,it,Ue.x,Ge.y,Ne,rt),Y_(G,P.x,P.y,Pe.x,bt+Pe.y,Me.x+Me.w,Me.y+Me.h,d,it,Ge.x,Ge.y,Ne,rt),S){const{x:_t,y:Ht,z:Ft}=S.anchor,[zt,ai,fi]=S.up;J_(W,_t,Ht,Ft,zt,ai,fi),J_(W,_t,Ht,Ft,zt,ai,fi),J_(W,_t,Ht,Ft,zt,ai,fi),J_(W,_t,Ht,Ft,zt,ai,fi),Q_(n.dynamicLayoutVertexArray,_t,Ht,Ft,ie)}else Q_(n.dynamicLayoutVertexArray,P.x,P.y,P.z,ie);if(N){const _t=Oe||Me;K_(n.iconTransitioningVertexArray,_t.x,_t.y),K_(n.iconTransitioningVertexArray,_t.x+_t.w,_t.y),K_(n.iconTransitioningVertexArray,_t.x,_t.y+_t.h),K_(n.iconTransitioningVertexArray,_t.x+_t.w,_t.y+_t.h)}z.emplaceBack(Mt,Mt+1,Mt+2),z.emplaceBack(Mt+1,Mt+2,Mt+3),H.vertexLength+=4,H.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(mt[0]),le!==l.length-1&&Bt===l[le+1].sectionIndex||n.programConfigurations.populatePaintArrays(G.length,g,g.index,{},E,C,D,he&&he[Bt])}const ce=S?S.anchor:P;n.placedSymbolArray.emplaceBack(ce.x,ce.y,ce.z,P.x,P.y,q,this.glyphOffsetArray.length-q,Y,x,I,P.segment,d?d[0]:0,d?d[1]:0,_[0],_[1],w,0,!1,0,R,0)}_commitLayoutVertex(n,l,d,_,f,g,w){n.emplaceBack(l,d,_,f,g,Math.round(w.x),Math.round(w.y))}_addCollisionDebugVertices(n,l,d,_,f,g,w){const S=d.segments.prepareSegment(4,d.layoutVertexArray,d.indexArray),P=S.vertexLength,x=w.tileAnchorX,I=w.tileAnchorY;for(let E=0;E<4;E++)d.collisionVertexArray.emplaceBack(0,0,0,0,0,0);this._commitDebugCollisionVertexUpdate(d.collisionVertexArrayExt,l,n.padding,w.zOffset),this._commitLayoutVertex(d.layoutVertexArray,_,f,g,x,I,new At(n.x1,n.y1)),this._commitLayoutVertex(d.layoutVertexArray,_,f,g,x,I,new At(n.x2,n.y1)),this._commitLayoutVertex(d.layoutVertexArray,_,f,g,x,I,new At(n.x2,n.y2)),this._commitLayoutVertex(d.layoutVertexArray,_,f,g,x,I,new At(n.x1,n.y2)),S.vertexLength+=4;const R=d.indexArray;R.emplaceBack(P,P+1),R.emplaceBack(P+1,P+2),R.emplaceBack(P+2,P+3),R.emplaceBack(P+3,P),S.primitiveLength+=4}_addTextDebugCollisionBoxes(n,l,d,_,f,g){for(let w=_;w<f;w++){const S=d.get(w),P=this.getSymbolInstanceTextSize(n,g,l,w);this._addCollisionDebugVertices(S,P,this.textCollisionBox,S.projectedAnchorX,S.projectedAnchorY,S.projectedAnchorZ,g)}}_addIconDebugCollisionBoxes(n,l,d,_,f,g){for(let w=_;w<f;w++){const S=d.get(w),P=this.getSymbolInstanceIconSize(n,l,g.placedIconSymbolIndex);this._addCollisionDebugVertices(S,P,this.iconCollisionBox,S.projectedAnchorX,S.projectedAnchorY,S.projectedAnchorZ,g)}}generateCollisionDebugBuffers(n,l,d){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new zv(Ah,kT.members,aa),this.iconCollisionBox=new zv(Ah,kT.members,aa);const _=Fh(this.iconSizeData,n),f=Fh(this.textSizeData,n,d);for(let g=0;g<this.symbolInstances.length;g++){const w=this.symbolInstances.get(g);this._addTextDebugCollisionBoxes(f,n,l,w.textBoxStartIndex,w.textBoxEndIndex,w),this._addTextDebugCollisionBoxes(f,n,l,w.verticalTextBoxStartIndex,w.verticalTextBoxEndIndex,w),this._addIconDebugCollisionBoxes(_,n,l,w.iconBoxStartIndex,w.iconBoxEndIndex,w),this._addIconDebugCollisionBoxes(_,n,l,w.verticalIconBoxStartIndex,w.verticalIconBoxEndIndex,w)}}getSymbolInstanceTextSize(n,l,d,_){const f=this.text.placedSymbolArray.get(l.rightJustifiedTextSymbolIndex>=0?l.rightJustifiedTextSymbolIndex:l.centerJustifiedTextSymbolIndex>=0?l.centerJustifiedTextSymbolIndex:l.leftJustifiedTextSymbolIndex>=0?l.leftJustifiedTextSymbolIndex:l.verticalPlacedTextSymbolIndex>=0?l.verticalPlacedTextSymbolIndex:_),g=U_(this.textSizeData,n,f)/An;return this.tilePixelRatio*g}getSymbolInstanceIconSize(n,l,d){const _=this.icon.placedSymbolArray.get(d),f=U_(this.iconSizeData,n,_);return this.tilePixelRatio*f}_commitDebugCollisionVertexUpdate(n,l,d,_){n.emplaceBack(l,-d,-d,_),n.emplaceBack(l,d,-d,_),n.emplaceBack(l,d,d,_),n.emplaceBack(l,-d,d,_)}_updateTextDebugCollisionBoxes(n,l,d,_,f,g,w){for(let S=_;S<f;S++){const P=d.get(S),x=this.getSymbolInstanceTextSize(n,g,l,S);this._commitDebugCollisionVertexUpdate(this.textCollisionBox.collisionVertexArrayExt,x,P.padding,g.zOffset)}}_updateIconDebugCollisionBoxes(n,l,d,_,f,g,w){for(let S=_;S<f;S++){const P=d.get(S),x=this.getSymbolInstanceIconSize(n,l,g.placedIconSymbolIndex);this._commitDebugCollisionVertexUpdate(this.iconCollisionBox.collisionVertexArrayExt,x,P.padding,g.zOffset)}}updateCollisionDebugBuffers(n,l,d,_){if(!this.hasDebugData())return;this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexArrayExt.clear(),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexArrayExt.clear();const f=Fh(this.iconSizeData,n,_),g=Fh(this.textSizeData,n,d);for(let w=0;w<this.symbolInstances.length;w++){const S=this.symbolInstances.get(w);this._updateTextDebugCollisionBoxes(g,n,l,S.textBoxStartIndex,S.textBoxEndIndex,S,d),this._updateTextDebugCollisionBoxes(g,n,l,S.verticalTextBoxStartIndex,S.verticalTextBoxEndIndex,S,d),this._updateIconDebugCollisionBoxes(f,n,l,S.iconBoxStartIndex,S.iconBoxEndIndex,S,_),this._updateIconDebugCollisionBoxes(f,n,l,S.verticalIconBoxStartIndex,S.verticalIconBoxEndIndex,S,_)}this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexBufferExt&&this.textCollisionBox.collisionVertexBufferExt.updateData(this.textCollisionBox.collisionVertexArrayExt),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexBufferExt&&this.iconCollisionBox.collisionVertexBufferExt.updateData(this.iconCollisionBox.collisionVertexArrayExt)}_deserializeCollisionBoxesForSymbol(n,l,d,_,f,g,w,S,P){const x={};if(l<d){const{x1:I,y1:R,x2:E,y2:C,padding:D,projectedAnchorX:N,projectedAnchorY:z,projectedAnchorZ:G,tileAnchorX:W,tileAnchorY:H,featureIndex:q}=n.get(l);x.textBox={x1:I,y1:R,x2:E,y2:C,padding:D,projectedAnchorX:N,projectedAnchorY:z,projectedAnchorZ:G,tileAnchorX:W,tileAnchorY:H},x.textFeatureIndex=q}if(_<f){const{x1:I,y1:R,x2:E,y2:C,padding:D,projectedAnchorX:N,projectedAnchorY:z,projectedAnchorZ:G,tileAnchorX:W,tileAnchorY:H,featureIndex:q}=n.get(_);x.verticalTextBox={x1:I,y1:R,x2:E,y2:C,padding:D,projectedAnchorX:N,projectedAnchorY:z,projectedAnchorZ:G,tileAnchorX:W,tileAnchorY:H},x.verticalTextFeatureIndex=q}if(g<w){const{x1:I,y1:R,x2:E,y2:C,padding:D,projectedAnchorX:N,projectedAnchorY:z,projectedAnchorZ:G,tileAnchorX:W,tileAnchorY:H,featureIndex:q}=n.get(g);x.iconBox={x1:I,y1:R,x2:E,y2:C,padding:D,projectedAnchorX:N,projectedAnchorY:z,projectedAnchorZ:G,tileAnchorX:W,tileAnchorY:H},x.iconFeatureIndex=q}if(S<P){const{x1:I,y1:R,x2:E,y2:C,padding:D,projectedAnchorX:N,projectedAnchorY:z,projectedAnchorZ:G,tileAnchorX:W,tileAnchorY:H,featureIndex:q}=n.get(S);x.verticalIconBox={x1:I,y1:R,x2:E,y2:C,padding:D,projectedAnchorX:N,projectedAnchorY:z,projectedAnchorZ:G,tileAnchorX:W,tileAnchorY:H},x.verticalIconFeatureIndex=q}return x}deserializeCollisionBoxes(n){this.collisionArrays=[];for(let l=0;l<this.symbolInstances.length;l++){const d=this.symbolInstances.get(l);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(n,d.textBoxStartIndex,d.textBoxEndIndex,d.verticalTextBoxStartIndex,d.verticalTextBoxEndIndex,d.iconBoxStartIndex,d.iconBoxEndIndex,d.verticalIconBoxStartIndex,d.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}hasIconTextFit(){return this.hasAnyIconTextFit}addIndicesForPlacedSymbol(n,l){const d=n.placedSymbolArray.get(l),_=d.vertexStartIndex+4*d.numGlyphs;for(let f=d.vertexStartIndex;f<_;f+=4)n.indexArray.emplaceBack(f,f+1,f+2),n.indexArray.emplaceBack(f+1,f+2,f+3)}getSortedSymbolIndexes(n){if(this.sortedAngle===n&&this.symbolInstanceIndexes!==void 0)return this.symbolInstanceIndexes;const l=Math.sin(n),d=Math.cos(n),_=[],f=[],g=[];for(let w=0;w<this.symbolInstances.length;++w){g.push(w);const S=this.symbolInstances.get(w);_.push(0|Math.round(l*S.tileAnchorX+d*S.tileAnchorY)),f.push(S.featureIndex)}return g.sort((w,S)=>_[w]-_[S]||f[S]-f[w]),g}getSortedIndexesByZOffset(){if(!this.zOffsetSortDirty)return this.symbolInstanceIndexesSortedZOffset;if(!this.symbolInstanceIndexesSortedZOffset){this.symbolInstanceIndexesSortedZOffset=[];for(let n=0;n<this.symbolInstances.length;++n)this.symbolInstanceIndexesSortedZOffset.push(n)}return this.zOffsetSortDirty=!1,this.symbolInstanceIndexesSortedZOffset.sort((n,l)=>this.symbolInstances.get(l).zOffset-this.symbolInstances.get(n).zOffset)}addToSortKeyRanges(n,l){const d=this.sortKeyRanges[this.sortKeyRanges.length-1];d&&d.sortKey===l?d.symbolInstanceEnd=n+1:this.sortKeyRanges.push({sortKey:l,symbolInstanceStart:n,symbolInstanceEnd:n+1})}sortFeatures(n){if(this.sortFeaturesByY&&this.sortedAngle!==n&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(n),this.sortedAngle=n,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const l of this.symbolInstanceIndexes){const d=this.symbolInstances.get(l);this.featureSortOrder.push(d.featureIndex);const{rightJustifiedTextSymbolIndex:_,centerJustifiedTextSymbolIndex:f,leftJustifiedTextSymbolIndex:g,verticalPlacedTextSymbolIndex:w,placedIconSymbolIndex:S,verticalPlacedIconSymbolIndex:P}=d;_>=0&&this.addIndicesForPlacedSymbol(this.text,_),f>=0&&f!==_&&this.addIndicesForPlacedSymbol(this.text,f),g>=0&&g!==f&&g!==_&&this.addIndicesForPlacedSymbol(this.text,g),w>=0&&this.addIndicesForPlacedSymbol(this.text,w),S>=0&&this.addIndicesForPlacedSymbol(this.icon,S),P>=0&&this.addIndicesForPlacedSymbol(this.icon,P)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}let m2,_2,Uv;Vt(eg,"SymbolBucket",{omit:["layers","collisionBoxArray","features","compareText"]}),eg.addDynamicAttributes=Q_;class g2{constructor(n){this.type=n.property.overrides?n.property.overrides.runtimeType:Ea,this.defaultValue=n}evaluate(n){if(n.formattedSection){const l=this.defaultValue.property.overrides;if(l&&l.hasOverride(n.formattedSection))return l.getOverride(n.formattedSection)}return n.feature&&n.featureState?this.defaultValue.evaluate(n.feature,n.featureState):this.defaultValue.property.specification.default}eachChild(n){this.defaultValue.isConstant()||n(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}Vt(g2,"FormatSectionOverride",{omit:["defaultValue"]});const Vv=()=>Uv||(Uv={layout:m2||(m2=new cr({"symbol-placement":new wt(qe.layout_symbol["symbol-placement"]),"symbol-spacing":new wt(qe.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new wt(qe.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new Nt(qe.layout_symbol["symbol-sort-key"]),"symbol-z-order":new wt(qe.layout_symbol["symbol-z-order"]),"symbol-z-elevate":new wt(qe.layout_symbol["symbol-z-elevate"]),"symbol-elevation-reference":new wt(qe.layout_symbol["symbol-elevation-reference"]),"icon-allow-overlap":new wt(qe.layout_symbol["icon-allow-overlap"]),"icon-ignore-placement":new wt(qe.layout_symbol["icon-ignore-placement"]),"icon-optional":new wt(qe.layout_symbol["icon-optional"]),"icon-rotation-alignment":new wt(qe.layout_symbol["icon-rotation-alignment"]),"icon-size":new Nt(qe.layout_symbol["icon-size"]),"icon-size-scale-range":new wt(qe.layout_symbol["icon-size-scale-range"]),"icon-text-fit":new Nt(qe.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new Nt(qe.layout_symbol["icon-text-fit-padding"]),"icon-image":new Nt(qe.layout_symbol["icon-image"]),"icon-rotate":new Nt(qe.layout_symbol["icon-rotate"]),"icon-padding":new wt(qe.layout_symbol["icon-padding"]),"icon-keep-upright":new wt(qe.layout_symbol["icon-keep-upright"]),"icon-offset":new Nt(qe.layout_symbol["icon-offset"]),"icon-anchor":new Nt(qe.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new wt(qe.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new wt(qe.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new wt(qe.layout_symbol["text-rotation-alignment"]),"text-field":new Nt(qe.layout_symbol["text-field"]),"text-font":new Nt(qe.layout_symbol["text-font"]),"text-size":new Nt(qe.layout_symbol["text-size"]),"text-size-scale-range":new wt(qe.layout_symbol["text-size-scale-range"]),"text-max-width":new Nt(qe.layout_symbol["text-max-width"]),"text-line-height":new Nt(qe.layout_symbol["text-line-height"]),"text-letter-spacing":new Nt(qe.layout_symbol["text-letter-spacing"]),"text-justify":new Nt(qe.layout_symbol["text-justify"]),"text-radial-offset":new Nt(qe.layout_symbol["text-radial-offset"]),"text-variable-anchor":new wt(qe.layout_symbol["text-variable-anchor"]),"text-anchor":new Nt(qe.layout_symbol["text-anchor"]),"text-max-angle":new wt(qe.layout_symbol["text-max-angle"]),"text-writing-mode":new wt(qe.layout_symbol["text-writing-mode"]),"text-rotate":new Nt(qe.layout_symbol["text-rotate"]),"text-padding":new wt(qe.layout_symbol["text-padding"]),"text-keep-upright":new wt(qe.layout_symbol["text-keep-upright"]),"text-transform":new Nt(qe.layout_symbol["text-transform"]),"text-offset":new Nt(qe.layout_symbol["text-offset"]),"text-allow-overlap":new wt(qe.layout_symbol["text-allow-overlap"]),"text-ignore-placement":new wt(qe.layout_symbol["text-ignore-placement"]),"text-optional":new wt(qe.layout_symbol["text-optional"]),visibility:new wt(qe.layout_symbol.visibility)})),paint:_2||(_2=new cr({"icon-opacity":new Nt(qe.paint_symbol["icon-opacity"]),"icon-occlusion-opacity":new Nt(qe.paint_symbol["icon-occlusion-opacity"]),"icon-emissive-strength":new Nt(qe.paint_symbol["icon-emissive-strength"]),"text-emissive-strength":new Nt(qe.paint_symbol["text-emissive-strength"]),"icon-color":new Nt(qe.paint_symbol["icon-color"]),"icon-halo-color":new Nt(qe.paint_symbol["icon-halo-color"]),"icon-halo-width":new Nt(qe.paint_symbol["icon-halo-width"]),"icon-halo-blur":new Nt(qe.paint_symbol["icon-halo-blur"]),"icon-translate":new wt(qe.paint_symbol["icon-translate"]),"icon-translate-anchor":new wt(qe.paint_symbol["icon-translate-anchor"]),"icon-image-cross-fade":new Nt(qe.paint_symbol["icon-image-cross-fade"]),"text-opacity":new Nt(qe.paint_symbol["text-opacity"]),"text-occlusion-opacity":new Nt(qe.paint_symbol["text-occlusion-opacity"]),"text-color":new Nt(qe.paint_symbol["text-color"],{runtimeType:yn,getOverride:u=>u.textColor,hasOverride:u=>!!u.textColor}),"text-halo-color":new Nt(qe.paint_symbol["text-halo-color"]),"text-halo-width":new Nt(qe.paint_symbol["text-halo-width"]),"text-halo-blur":new Nt(qe.paint_symbol["text-halo-blur"]),"text-translate":new wt(qe.paint_symbol["text-translate"]),"text-translate-anchor":new wt(qe.paint_symbol["text-translate-anchor"]),"icon-color-saturation":new wt(qe.paint_symbol["icon-color-saturation"]),"icon-color-contrast":new wt(qe.paint_symbol["icon-color-contrast"]),"icon-color-brightness-min":new wt(qe.paint_symbol["icon-color-brightness-min"]),"icon-color-brightness-max":new wt(qe.paint_symbol["icon-color-brightness-max"]),"symbol-z-offset":new Nt(qe.paint_symbol["symbol-z-offset"]),"icon-color-use-theme":new Nt({type:"string",default:"default","property-type":"data-driven"}),"icon-halo-color-use-theme":new Nt({type:"string",default:"default","property-type":"data-driven"}),"text-color-use-theme":new Nt({type:"string",default:"default","property-type":"data-driven"}),"text-halo-color-use-theme":new Nt({type:"string",default:"default","property-type":"data-driven"})}))},Uv);class tg extends Jr{constructor(n,l,d,_){super(n,Vv(),l,d,_),this._colorAdjustmentMatrix=Re.mat4.identity([]),this.hasInitialOcclusionOpacityProperties=n.paint!==void 0&&("icon-occlusion-opacity"in n.paint||"text-occlusion-opacity"in n.paint)}recalculate(n,l){super.recalculate(n,l),this.layout.get("icon-rotation-alignment")==="auto"&&(this.layout._values["icon-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-rotation-alignment")==="auto"&&(this.layout._values["text-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-pitch-alignment")==="auto"&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")),this.layout.get("icon-pitch-alignment")==="auto"&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment"));const d=this.layout.get("text-writing-mode");if(d){const _=[];for(const f of d)_.indexOf(f)<0&&_.push(f);this.layout._values["text-writing-mode"]=_}else this.layout._values["text-writing-mode"]=this.layout.get("symbol-placement")==="point"?["horizontal"]:["horizontal","vertical"];this._setPaintOverrides()}getColorAdjustmentMatrix(n,l,d,_){return this._saturation===n&&this._contrast===l&&this._brightnessMin===d&&this._brightnessMax===_||(this._colorAdjustmentMatrix=function(f,g,w,S){f=Uu(f),g=zu(g);const P=Re.mat4.create(),x=f/3,I=1-2*x,R=[I,x,x,0,x,I,x,0,x,x,I,0,0,0,0,1],E=.5-.5*g,C=S-w;return Re.mat4.multiply(P,[C,0,0,0,0,C,0,0,0,0,C,0,w,w,w,1],[g,0,0,0,0,g,0,0,0,0,g,0,E,E,E,1]),Re.mat4.multiply(P,P,R),P}(n,l,d,_),this._saturation=n,this._contrast=l,this._brightnessMin=d,this._brightnessMax=_),this._colorAdjustmentMatrix}getValueAndResolveTokens(n,l,d,_){const f=this.layout.get(n).evaluate(l,{},d,_),g=this._unevaluatedLayout._values[n];return g.isDataDriven()||wl(g.value)||!f?f:function(w,S){return S.replace(/{([^{}]+)}/g,(P,x)=>x in w?String(w[x]):"")}(l.properties,f)}createBucket(n){return new eg(n)}queryRadius(){return 0}queryIntersectsFeature(){return!1}_setPaintOverrides(){for(const n of Vv().paint.overridableProperties){if(!tg.hasPaintOverride(this.layout,n))continue;const l=this.paint.get(n),d=new g2(l),_=new uh(d,l.property.specification,this.scope,this.options);let f=null;f=l.value.kind==="constant"||l.value.kind==="source"?new hh("source",_):new Oc("composite",_,l.value.zoomStops,l.value._interpolationType),this.paint._values[n]=new Sl(l.property,f,l.parameters)}}_handleOverridablePaintPropertyUpdate(n,l,d){return!(!this.layout||l.isDataDriven()||d.isDataDriven())&&tg.hasPaintOverride(this.layout,n)}static hasPaintOverride(n,l){const d=n.get("text-field"),_=Vv().paint.properties[l];let f=!1;const g=w=>{for(const S of w)if(_.overrides&&_.overrides.hasOverride(S))return void(f=!0)};if(d.value.kind==="constant"&&d.value.value instanceof vn)g(d.value.value.sections);else if(d.value.kind==="source"){const w=P=>{f||(P instanceof nn&&yr(P.value)===Js?g(P.value.sections):P instanceof Sa?g(P.sections):P.eachChild(w))},S=d.value;S._styleExpression&&w(S._styleExpression.expression)}return f}getProgramIds(){return["symbol"]}getDefaultProgramParams(n,l,d){return{config:new Ha(this,{zoom:l,lut:d}),overrideFog:!1}}}let y2,v2,x2,b2;var jv=ji([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);function Hv(u){switch(u){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.RGBA;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.DEPTH_COMPONENT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.DEPTH_STENCIL;case WebGL2RenderingContext.R8:case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.RED}}function Gv(u){switch(u){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.UNSIGNED_SHORT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.UNSIGNED_INT_24_8;case WebGL2RenderingContext.R8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.FLOAT}}class $v{constructor(n,l,d,_){this.context=n,this.format=d,this.useMipmap=_&&_.useMipmap,this.texture=n.gl.createTexture(),this.update(l,{premultiply:_&&_.premultiply})}update(n,l){const d=n&&n instanceof HTMLVideoElement&&n.width===0?n.videoWidth:n.width,_=n&&n instanceof HTMLVideoElement&&n.height===0?n.videoHeight:n.height,{context:f}=this,{gl:g}=f,{x:w,y:S}=l&&l.position?l.position:{x:0,y:0},P=w+d,x=S+_;!this.size||this.size[0]===P&&this.size[1]===x||(g.bindTexture(g.TEXTURE_2D,null),g.deleteTexture(this.texture),this.texture=g.createTexture(),this.size=null),g.bindTexture(g.TEXTURE_2D,this.texture),f.pixelStoreUnpackFlipY.set(!1),f.pixelStoreUnpack.set(1),f.pixelStoreUnpackPremultiplyAlpha.set(this.format===g.RGBA8&&(!l||l.premultiply!==!1));const I=n instanceof HTMLImageElement||n instanceof HTMLCanvasElement||n instanceof HTMLVideoElement||n instanceof ImageData||ImageBitmap&&n instanceof ImageBitmap;if(!this.size&&P>0&&x>0){const R=this.useMipmap?Math.floor(Math.log2(Math.max(P,x)))+1:1;g.texStorage2D(g.TEXTURE_2D,R,this.format,P,x),this.size=[P,x]}if(this.size)if(I)g.texSubImage2D(g.TEXTURE_2D,0,w,S,Hv(this.format),Gv(this.format),n);else{const R=n.data;R&&g.texSubImage2D(g.TEXTURE_2D,0,w,S,d,_,Hv(this.format),Gv(this.format),R)}this.useMipmap&&g.generateMipmap(g.TEXTURE_2D)}bind(n,l,d=!1){const{context:_}=this,{gl:f}=_;f.bindTexture(f.TEXTURE_2D,this.texture),n!==this.minFilter&&(f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,n),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,this.useMipmap&&!d?n===f.NEAREST?f.NEAREST_MIPMAP_NEAREST:f.LINEAR_MIPMAP_LINEAR:n),this.minFilter=n),l!==this.wrapS&&(f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,l),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,l),this.wrapS=l)}bindExtraParam(n,l,d,_){const{context:f}=this,{gl:g}=f;g.bindTexture(g.TEXTURE_2D,this.texture),l!==this.magFilter&&(g.texParameteri(g.TEXTURE_2D,g.TEXTURE_MAG_FILTER,l),this.magFilter=l),n!==this.minFilter&&(g.texParameteri(g.TEXTURE_2D,g.TEXTURE_MIN_FILTER,this.useMipmap?n===g.NEAREST?g.NEAREST_MIPMAP_NEAREST:g.LINEAR_MIPMAP_LINEAR:n),this.minFilter=n),d!==this.wrapS&&(g.texParameteri(g.TEXTURE_2D,g.TEXTURE_WRAP_S,d),this.wrapS=d),_!==this.wrapT&&(g.texParameteri(g.TEXTURE_2D,g.TEXTURE_WRAP_T,_),this.wrapT=_)}destroy(){const{gl:n}=this.context;n.deleteTexture(this.texture),this.texture=null}}class ig{constructor(n,l){this.context=n,this.texture=l}bind(n,l){const{context:d}=this,{gl:_}=d;_.bindTexture(_.TEXTURE_2D,this.texture),n!==this.minFilter&&(_.texParameteri(_.TEXTURE_2D,_.TEXTURE_MAG_FILTER,n),_.texParameteri(_.TEXTURE_2D,_.TEXTURE_MIN_FILTER,n),this.minFilter=n),l!==this.wrapS&&(_.texParameteri(_.TEXTURE_2D,_.TEXTURE_WRAP_S,l),_.texParameteri(_.TEXTURE_2D,_.TEXTURE_WRAP_T,l),this.wrapS=l)}}function rg(u,n,l,d,_,f,g,w){const S=[u,n,1,l,d,1,_,f,1],P=[g,w,1],x=Re.mat3.adjoint([],S),[I,R,E]=Re.vec3.transformMat3(P,P,x);return Re.mat3.multiply(S,S,[I,0,0,0,R,0,0,0,E])}function w2(u,n,l,d,_,f,g,w){const S=function(P,x,I,R,E,C,D,N){const z=rg(0,0,1,0,1,1,0,1),G=rg(P,x,I,R,E,C,D,N),W=Re.mat3.adjoint([],z);return Re.mat3.multiply(G,G,W)}(u,n,l,d,_,f,g,w);return[S[2]/S[8]/Rt,S[5]/S[8]/Rt]}function ng(u){return[u[0],Math.min(Math.max(u[1],-85.051129),jn)]}class A2 extends Qo{constructor(n,l,d,_){super(),this.id=n,this.dispatcher=d,this.coordinates=l.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.onNorthPole=!1,this.onSouthPole=!1,this.setEventedParent(_),this.options=l,this._dirty=!1}load(n,l){if(this._loaded=l||!1,this.fire(new Ks("dataloading",{dataType:"source"})),this.url=this.options.url,!this.url)return n&&(this.coordinates=n),this._loaded=!0,void this._finishLoading();this._imageRequest=Dd(this.map._requestManager.transformRequest(this.url,zi.Image),(d,_)=>{this._imageRequest=null,this._loaded=!0,d?this.fire(new ju(d)):_&&(this.image=_ instanceof HTMLImageElement?xe.getImageData(_):_,this._dirty=!0,this.width=this.image.width,this.height=this.image.height,n&&(this.coordinates=n),this._finishLoading())})}loaded(){return this._loaded}updateImage(n){return n.url?(this._imageRequest&&n.url!==this.options.url&&(this._imageRequest.cancel(),this._imageRequest=null),this.options.url=n.url,this.load(n.coordinates,this._loaded),this):this}setTexture(n){if(!(n.handle instanceof WebGLTexture))throw new Error("The provided handle is not a WebGLTexture instance");return this.texture=new ig(this.map.painter.context,n.handle),this.width=n.dimensions[0],this.height=n.dimensions[1],this._dirty=!1,this._loaded=!0,this._finishLoading(),this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new Ks("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(n){this.map=n,this.load()}onRemove(n){this._imageRequest&&(this._imageRequest.cancel(),this._imageRequest=null),!this.texture||this.texture instanceof ig||this.texture.destroy(),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy())}setCoordinates(n){if(this.coordinates=n,this._boundsArray=void 0,this._unsupportedCoords=!1,!n.length)return this;this.onNorthPole=!1,this.onSouthPole=!1;let l=n[0][1],d=n[0][1];for(const f of n)f[1]>d&&(d=f[1]),f[1]<l&&(l=f[1]);const _=(d+l)/2;if(_>jn?this.onNorthPole=!0:_<-85.051129&&(this.onSouthPole=!0),!this.onNorthPole&&!this.onSouthPole){const f=n.map(c.fromLngLat);this.tileID=function(g){let w=1/0,S=1/0,P=-1/0,x=-1/0;for(const D of g)w=Math.min(w,D.x),S=Math.min(S,D.y),P=Math.max(P,D.x),x=Math.max(x,D.y);const I=Math.max(P-w,x-S),R=Math.max(0,Math.floor(-Math.log(I)/Math.LN2)),E=Math.pow(2,R);let C=Math.floor((w+P)/2*E);return C>1&&(C-=1),new ft(R,C,Math.floor((S+x)/2*E))}(f),this.minzoom=this.maxzoom=this.tileID.z}return this.fire(new Ks("data",{dataType:"source",sourceDataType:"content"})),this}_clear(){this._boundsArray=void 0,this._unsupportedCoords=!1}_prepareData(n){for(const z in this.tiles){const G=this.tiles[z];G.state!=="loaded"&&(G.state="loaded",G.texture=this.texture)}if(this._boundsArray||this.onNorthPole||this.onSouthPole||this._unsupportedCoords)return;const l=fp(new ft(0,0,0),this.map.transform.projection),d=[l.projection.project(this.coordinates[0][0],this.coordinates[0][1]),l.projection.project(this.coordinates[1][0],this.coordinates[1][1]),l.projection.project(this.coordinates[2][0],this.coordinates[2][1]),l.projection.project(this.coordinates[3][0],this.coordinates[3][1])];if(!function(z){const G=z[1].x-z[0].x,W=z[1].y-z[0].y,H=z[2].x-z[1].x,q=z[2].y-z[1].y,Y=z[3].x-z[2].x,ie=z[3].y-z[2].y,he=z[0].x-z[3].x,ce=z[0].y-z[3].y,le=G*q-H*W,Te=H*ie-Y*q,de=Y*ce-he*ie,Se=he*W-G*ce;return le>0&&Te>0&&de>0&&Se>0||le<0&&Te<0&&de<0&&Se<0}(d))return console.warn("Image source coordinates are defining non-convex area in the Mercator projection"),void(this._unsupportedCoords=!0);const _=fp(this.tileID,this.map.transform.projection),[f,g,w,S]=this.coordinates.map(z=>{const G=_.projection.project(z[0],z[1]);return c2(_,G)._round()});this.perspectiveTransform=w2(f.x,f.y,g.x,g.y,w.x,w.y,S.x,S.y);const P=this._boundsArray=new Oo;P.emplaceBack(f.x,f.y,0,0),P.emplaceBack(g.x,g.y,Rt,0),P.emplaceBack(S.x,S.y,0,Rt),P.emplaceBack(w.x,w.y,Rt,Rt),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy()),this.boundsBuffer=n.createVertexBuffer(P,jv.members),this.boundsSegments=Ar.simpleSegment(0,0,4,2);const x=[],I=[ng((R=this.coordinates)[0]),ng(R[1]),ng(R[2]),ng(R[3])];var R;const[E,C,D,N]=function(z){let G=z[0][0],W=G,H=z[0][1],q=H;for(let Y=1;Y<z.length;Y++)z[Y][0]<G?G=z[Y][0]:z[Y][0]>W&&(W=z[Y][0]),z[Y][1]<H?H=z[Y][1]:z[Y][1]>q&&(q=z[Y][1]);return[G,H,W-G,q-H]}(I);{const z=new Oo,[G,W,H,q]=function(Ue){let Ge=Ue[0].x,Ne=Ge,rt=Ue[0].y,mt=rt;for(let it=1;it<Ue.length;it++)Ue[it].x<Ge?Ge=Ue[it].x:Ue[it].x>Ne&&(Ne=Ue[it].x),Ue[it].y<rt?rt=Ue[it].y:Ue[it].y>mt&&(mt=Ue[it].y);return[Ge,rt,Ne-Ge,mt-rt]}(d),Y=Ue=>[(Ue.x-G)/H,(Ue.y-W)/q],[ie,he,ce,le]=d.map(Y),Te=function(Ue,Ge,Ne,rt,mt,it,Bt,Mt){const bt=rg(0,0,1,0,1,1,0,1),_t=rg(Ue,Ge,Ne,rt,mt,it,Bt,Mt),Ht=Re.mat3.adjoint([],_t);return Re.mat3.multiply(bt,bt,Ht)}(ie[0],ie[1],he[0],he[1],ce[0],ce[1],le[0],le[1]);this.elevatedGlobePerspectiveTransform=w2(ie[0],ie[1],he[0],he[1],ce[0],ce[1],le[0],le[1]);const de=(Ue,Ge)=>{x.push(Ue.lng);const Ne=Math.round((Ue.lng-E)/D*Rt),rt=Math.round((Ue.lat-C)/N*Rt),mt=Y(Ge),it=Re.vec3.transformMat3([],[mt[0],mt[1],1],Te),Bt=Math.round(it[0]/it[2]*Rt),Mt=Math.round(it[1]/it[2]*Rt);z.emplaceBack(Ne,rt,Bt,Mt)},Se=d[3].x-d[0].x,Pe=d[3].y-d[0].y,Me=d[2].x-d[1].x,Oe=d[2].y-d[1].y;for(let Ue=0;Ue<65;Ue++){const Ge=Ue/64,Ne=[d[0].x+Ge*Se,d[0].y+Ge*Pe],rt=[d[1].x+Ge*Me,d[1].y+Ge*Oe],mt=rt[0]-Ne[0],it=rt[1]-Ne[1];for(let Bt=0;Bt<65;Bt++){const Mt=Bt/64,bt={x:Ne[0]+mt*Mt,y:Ne[1]+it*Mt};de(l.projection.unproject(bt.x,bt.y),bt)}}this.elevatedGlobeVertexBuffer=n.createVertexBuffer(z,jv.members)}{this.maxLongitudeTriangleSize=0;let z=[],G=new on;const W=(H,q,Y)=>{G.emplaceBack(H,q,Y);const ie=x[H],he=x[q],ce=x[Y],le=Math.min(Math.min(ie,he),ce),Te=Math.max(Math.max(ie,he),ce)-le;Te>this.maxLongitudeTriangleSize&&(this.maxLongitudeTriangleSize=Te),z.push(le+Te/2)};for(let H=0;H<64;H++)for(let q=0;q<64;q++){const Y=65*H+q,ie=Y+1,he=Y+65,ce=he+1;W(Y,he,ie),W(ie,he,ce)}[z,G]=function(H,q){const Y=Array.from({length:H.length},(ce,le)=>le);Y.sort((ce,le)=>H[ce]-H[le]);const ie=[],he=new on;for(let ce=0;ce<Y.length;ce++){const le=Y[ce];ie.push(H[le]);const Te=3*le,de=Te+1;he.emplaceBack(q.uint16[Te],q.uint16[de],q.uint16[de+1])}return[ie,he]}(z,G),this.elevatedGlobeTrianglesCenterLongitudes=z,this.elevatedGlobeIndexBuffer=n.createIndexBuffer(G)}this.elevatedGlobeSegments=Ar.simpleSegment(0,0,4225,8192),this.elevatedGlobeGridMatrix=new Float32Array([0,D/Rt,0,N/Rt,0,0,C,E,0])}prepare(){const n=Object.keys(this.tiles).length!==0;if(this.tileID&&!n)return;const l=this.map.painter.context,d=l.gl;!this._dirty||this.texture instanceof ig||(this.texture?this.texture.update(this.image):(this.texture=new $v(l,this.image,d.RGBA8),this.texture.bind(d.LINEAR,d.CLAMP_TO_EDGE)),this._dirty=!1),n&&this._prepareData(l)}loadTile(n,l){this.tileID&&this.tileID.equals(n.tileID.canonical)?(this.tiles[String(n.tileID.wrap)]=n,n.buckets={},l(null)):(n.state="errored",l(null))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}getSegmentsForLongitude(n){const l=this.elevatedGlobeSegments;if(!this.elevatedGlobeTrianglesCenterLongitudes||!l)return null;const d=this.elevatedGlobeTrianglesCenterLongitudes;let _=(f=n+180)+360*Math.round((d[0]-f)/360);var f;const g=new Ar,w=(I,R)=>{g.segments.push({vertexOffset:0,primitiveOffset:I,vertexLength:l.segments[0].vertexLength,primitiveLength:R,sortKey:void 0,vaos:{}})},S=.51*this.maxLongitudeTriangleSize;if(Math.abs(d[0]-_)<=S){const I=hl(d,0,d.length,_+S);return I===d.length||w(I,Nu(d,I+1,d.length,_+360-S)-I),g}_<d[0]&&(_+=360);const P=Nu(d,0,d.length,_-S);if(P===d.length)return w(0,d.length),g;w(0,P-0);const x=hl(d,P+1,d.length,_+S);return x!==d.length&&w(x,d.length-x),g}}const sO=(Math.pow(256,2)-1)/16907520;class T2 extends Jr{constructor(n,l,d,_){super(n,{layout:x2||(x2=new cr({visibility:new wt(qe.layout_raster.visibility)})),paint:b2||(b2=new cr({"raster-opacity":new wt(qe.paint_raster["raster-opacity"]),"raster-color":new Cl(qe.paint_raster["raster-color"]),"raster-color-mix":new wt(qe.paint_raster["raster-color-mix"]),"raster-color-range":new wt(qe.paint_raster["raster-color-range"]),"raster-hue-rotate":new wt(qe.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new wt(qe.paint_raster["raster-brightness-min"]),"raster-brightness-max":new wt(qe.paint_raster["raster-brightness-max"]),"raster-saturation":new wt(qe.paint_raster["raster-saturation"]),"raster-contrast":new wt(qe.paint_raster["raster-contrast"]),"raster-resampling":new wt(qe.paint_raster["raster-resampling"]),"raster-fade-duration":new wt(qe.paint_raster["raster-fade-duration"]),"raster-emissive-strength":new wt(qe.paint_raster["raster-emissive-strength"]),"raster-array-band":new wt(qe.paint_raster["raster-array-band"]),"raster-elevation":new wt(qe.paint_raster["raster-elevation"]),"raster-color-use-theme":new Nt({type:"string",default:"default","property-type":"data-driven"})}))},l,d,_),this.updateColorRamp(),this._curRampRange=[NaN,NaN]}getProgramIds(){return["raster"]}hasColorMap(){return!!this._transitionablePaint._values["raster-color"].value.value}tileCoverLift(){return this.paint.get("raster-elevation")}isDraped(n){return!(n&&n._source instanceof A2&&(n._source.onNorthPole||n._source.onSouthPole))&&this.paint.get("raster-elevation")===0}_handleSpecialPaintPropertyUpdate(n){n!=="raster-color"&&n!=="raster-color-range"||(this._curRampRange=[NaN,NaN],this.updateColorRamp())}updateColorRamp(n){if(!this.hasColorMap()||!this._curRampRange)return;const l=this._transitionablePaint._values["raster-color"].value.expression,[d,_]=n||this._transitionablePaint._values["raster-color-range"].value.expression.evaluate({zoom:0})||[NaN,NaN];isNaN(d)&&isNaN(_)||d===this._curRampRange[0]&&_===this._curRampRange[1]||(this.colorRamp=Jf({expression:l,evaluationKey:"rasterValue",image:this.colorRamp,clips:[{start:d,end:_}],resolution:256}),this.colorRampTexture=null,this._curRampRange=[d,_])}}let E2,S2,I2,C2,M2;class R2 extends Jr{constructor(n,l,d,_){super(n,{layout:E2||(E2=new cr({visibility:new wt(qe["layout_raster-particle"].visibility)})),paint:S2||(S2=new cr({"raster-particle-array-band":new wt(qe["paint_raster-particle"]["raster-particle-array-band"]),"raster-particle-count":new wt(qe["paint_raster-particle"]["raster-particle-count"]),"raster-particle-color":new Cl(qe["paint_raster-particle"]["raster-particle-color"]),"raster-particle-max-speed":new wt(qe["paint_raster-particle"]["raster-particle-max-speed"]),"raster-particle-speed-factor":new wt(qe["paint_raster-particle"]["raster-particle-speed-factor"]),"raster-particle-fade-opacity-factor":new wt(qe["paint_raster-particle"]["raster-particle-fade-opacity-factor"]),"raster-particle-reset-rate-factor":new wt(qe["paint_raster-particle"]["raster-particle-reset-rate-factor"]),"raster-particle-elevation":new wt(qe["paint_raster-particle"]["raster-particle-elevation"]),"raster-particle-color-use-theme":new Nt({type:"string",default:"default","property-type":"data-driven"})}))},l,d,_),this._updateColorRamp(),this.lastInvalidatedAt=xe.now()}onRemove(n){this.colorRampTexture&&this.colorRampTexture.destroy(),this.tileFramebuffer&&this.tileFramebuffer.destroy(),this.particleFramebuffer&&this.particleFramebuffer.destroy()}hasColorMap(){return!!this._transitionablePaint._values["raster-particle-color"].value.value}getProgramIds(){return["rasterParticle"]}hasOffscreenPass(){return this.visibility!=="none"}isDraped(n){return!1}_handleSpecialPaintPropertyUpdate(n){n!=="raster-particle-color"&&n!=="raster-particle-max-speed"||(this._updateColorRamp(),this._invalidateAnimationState()),n==="raster-particle-count"&&this._invalidateAnimationState()}_updateColorRamp(){if(!this.hasColorMap())return;const n=this._transitionablePaint._values["raster-particle-color"].value.expression,l=this._transitionablePaint._values["raster-particle-max-speed"].value.expression.evaluate({zoom:0});this.colorRamp=Jf({expression:n,evaluationKey:"rasterParticleSpeed",image:this.colorRamp,clips:[{start:0,end:l}],resolution:256}),this.colorRampTexture=null}_invalidateAnimationState(){this.lastInvalidatedAt=xe.now()}tileCoverLift(){return this.paint.get("raster-particle-elevation")}}class oO extends Jr{constructor(n,l){super(n,{},l,null),this.implementation=n,n.slot&&(this.slot=n.slot)}is3D(){return this.implementation.renderingMode==="3d"}hasOffscreenPass(){return this.implementation.prerender!==void 0}isDraped(n){return this.implementation.renderToTile!==void 0}shouldRedrape(){return!!this.implementation.shouldRerenderTiles&&this.implementation.shouldRerenderTiles()}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){}onAdd(n){this.implementation.onAdd&&this.implementation.onAdd(n,n.painter.context.gl)}onRemove(n){this.implementation.onRemove&&this.implementation.onRemove(n,n.painter.context.gl)}}function Wv(u,n,l){const d=[0,0,1],_=Re.quat.identity([]);return Re.quat.rotateY(_,_,l?-Ti(u)+Math.PI:Ti(u)),Re.quat.rotateX(_,_,-Ti(n)),Re.vec3.transformQuat(d,d,_),Re.vec3.normalize(d,d)}function P2(u,n){const l=sg(u.projection,u.zoom,u.width,u.height),d=function(f,g,w,S,P){const x=new Li(w.lng-180*jl,w.lat),I=new Li(w.lng+180*jl,w.lat),R=f.project(x.lng,x.lat),E=f.project(I.lng,I.lat),C=-Math.atan2(E.y-R.y,E.x-R.x),D=c.fromLngLat(w);D.y=yi(D.y,-1+jl,1-jl);const N=D.toLngLat(),z=f.project(N.lng,N.lat),G=c.fromLngLat(N);G.x+=jl;const W=G.toLngLat(),H=f.project(W.lng,W.lat),q=D2(H.x-z.x,H.y-z.y,C),Y=c.fromLngLat(N);Y.y+=jl;const ie=Y.toLngLat(),he=f.project(ie.lng,ie.lat),ce=D2(he.x-z.x,he.y-z.y,C),le=Math.abs(q.x)/Math.abs(ce.y),Te=Re.mat4.identity([]);Re.mat4.rotateZ(Te,Te,-C*(1-(P?0:S)));const de=Re.mat4.identity([]);return Re.mat4.scale(de,de,[1,1-(1-le)*S,1]),de[4]=-ce.x/ce.y*S,Re.mat4.rotateZ(de,de,C),Re.mat4.multiply(de,Te,de),de}(u.projection,0,u.center,l,n),_=B2(u);return Re.mat4.scale(d,d,[_,_,1]),d}function B2(u){const n=u.projection,l=sg(u.projection,u.zoom,u.width,u.height),d=qv(n,u.center),_=qv(n,Li.convert(n.center));return Math.pow(2,d*l+(1-l)*_)}function sg(u,n,l,d,_=1/0){const f=u.range;if(!f)return 0;const g=Math.min(_,Math.max(l,d)),w=Math.log(g/1024)/Math.LN2;return ws(f[0]+w,f[1]+w,n)}const jl=1/4e4;function qv(u,n){const l=yi(n.lat,-85.051129,jn),d=new Li(n.lng-180*jl,l),_=new Li(n.lng+180*jl,l),f=u.project(d.lng,l),g=u.project(_.lng,l),w=c.fromLngLat(d),S=c.fromLngLat(_),P=g.x-f.x,x=g.y-f.y,I=S.x-w.x,R=S.y-w.y,E=Math.sqrt((I*I+R*R)/(P*P+x*x));return Math.log(E)/Math.LN2}function D2(u,n,l){const d=Math.cos(l),_=Math.sin(l);return{x:u*d-n*_,y:u*_+n*d}}function O2(u,n,l){Re.mat4.identity(u),Re.mat4.rotateZ(u,u,Ti(n[2])),Re.mat4.rotateX(u,u,Ti(n[0])),Re.mat4.rotateY(u,u,Ti(n[1])),Re.mat4.scale(u,u,l),Re.mat4.multiply(u,u,[1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1])}function og(u,n,l,d,_,f,g,w){const S=[l[0]-n[0],l[1]-n[1],0],P=[d[0]-n[0],d[1]-n[1],0];if(Re.vec3.length(S)<1e-12||Re.vec3.length(P)<1e-12)return Re.quat.identity(u);const x=Re.vec3.cross([],S,P);Re.vec3.normalize(x,x),Re.vec3.subtract(P,d,n),S[2]=(f-_)*w,P[2]=(g-_)*w;const I=S;return Re.vec3.cross(I,S,P),Re.vec3.normalize(I,I),Re.quat.rotationTo(u,x,I)}function Xv(u,n,l=!1){const d=Hn(n.zoom),_=function(f,g,w){const S=g.worldSize,P=[f[12],f[13],f[14]],x=an(P[1]/S),I=es(P[0]/S),R=Re.mat4.identity([]),E=Dn(1,x)*S,C=Dn(1,0)*S*kl(x,g.zoom),D=1/wn(S);let N=C*D;if(w){const H=sg(g.projection,g.zoom,g.width,g.height,1024);N=D*g.projection.pixelSpaceConversion(g.center.lat,S,H)}const z=Ga(x,I);Re.vec3.add(z,z,Re.vec3.scale([],Re.vec3.normalize([],z),E*N*P[2]));const G=function(H){const q=[H[0],H[1],H[2]];let Y=[0,1,0];const ie=Re.vec3.cross([],Y,q);return Re.vec3.cross(Y,q,ie),Re.vec3.squaredLength(Y)===0&&(Y=[0,1,0],Re.vec3.cross(ie,q,Y)),Re.vec3.normalize(ie,ie),Re.vec3.normalize(Y,Y),Re.vec3.normalize(q,q),[ie[0],ie[1],ie[2],0,Y[0],Y[1],Y[2],0,q[0],q[1],q[2],0,H[0],H[1],H[2],1]}(z);Re.mat4.scale(R,R,[N,N,N*E]),Re.mat4.translate(R,R,[-P[0],-P[1],-P[2]]);const W=Re.mat4.multiply([],g.globeMatrix,G);return Re.mat4.multiply(W,W,R),Re.mat4.multiply(W,W,f),W}(u,n,l);if(d>0){const f=function(g,w){const S=w.worldSize,P=Dn(1,0)*S*kl(w.center.lat,w.zoom)/wn(S),x=Dn(1,w.center.lat)*S,I=Re.mat4.identity([]);return Re.mat4.rotateY(I,I,Ti(w.center.lng)),Re.mat4.rotateX(I,I,Ti(w.center.lat)),Re.mat4.translate(I,I,[0,0,Bn]),Re.mat4.scale(I,I,[P,P,P*x]),Re.mat4.translate(I,I,[w.point.x-.5*S,w.point.y-.5*S,0]),Re.mat4.multiply(I,I,g),Re.mat4.multiply(I,w.globeMatrix,I)}(u,n);return function(g,w,S){const P=(C,D,N)=>{const z=Re.vec3.length(C),G=Re.vec3.length(D),W=Nr(C,D,N);return Re.vec3.scale(W,W,1/Re.vec3.length(W)*ii(z,G,N))},x=P([g[0],g[1],g[2]],[w[0],w[1],w[2]],S),I=P([g[4],g[5],g[6]],[w[4],w[5],w[6]],S),R=P([g[8],g[9],g[10]],[w[8],w[9],w[10]],S),E=Nr([g[12],g[13],g[14]],[w[12],w[13],w[14]],S);return[x[0],x[1],x[2],0,I[0],I[1],I[2],0,R[0],R[1],R[2],0,E[0],E[1],E[2],1]}(_,f,d)}return _}function F2(u,n,l,d){const _=Wt.projectAabbCorners(d,l);let f=Number.MAX_VALUE,g=-1;for(let P=0;P<_.length;++P){const x=_[P];x[0]=(.5*x[0]+.5)*n.width,x[1]=(.5-.5*x[1])*n.height,x[2]<f&&(g=P,f=x[2])}const w=P=>new At(_[P][0],_[P][1]);let S;switch(g){case 0:case 6:S=[w(1),w(5),w(4),w(7),w(3),w(2),w(1)];break;case 1:case 7:S=[w(0),w(4),w(5),w(6),w(2),w(3),w(0)];break;case 3:case 5:S=[w(1),w(0),w(4),w(7),w(6),w(2),w(1)];break;default:S=[w(1),w(5),w(6),w(7),w(3),w(0),w(1)]}if(Z(u,S))return f}const aO=ji([{name:"a_pos_3f",components:3,type:"Float32"}]),lO=ji([{name:"a_color_3f",components:3,type:"Float32"}]),cO=ji([{name:"a_color_4f",components:4,type:"Float32"}]),uO=ji([{name:"a_uv_2f",components:2,type:"Float32"}]),hO=ji([{name:"a_normal_3f",components:3,type:"Float32"}]),dO=ji([{name:"a_normal_matrix0",components:4,type:"Float32"},{name:"a_normal_matrix1",components:4,type:"Float32"},{name:"a_normal_matrix2",components:4,type:"Float32"},{name:"a_normal_matrix3",components:4,type:"Float32"}]),fO=ji([{name:"a_pbr",components:4,type:"Uint16"},{name:"a_heightBasedEmissiveStrength",components:3,type:"Float32"}]),k2={None:0,Model:1,Symbol:2,FillExtrusion:4,All:7};class ag{constructor(n,l,d,_){this.message=(n?`${n}: `:"")+d,_&&(this.identifier=_),l!=null&&l.__line__&&(this.line=l.__line__)}}function L2(u,n){const l=u.indexOf("://")===-1;try{return new URL(u,l&&n?"http://example.com":void 0),!0}catch{return!1}}class N2{constructor(n,l){this.feature=n,this.instancedDataOffset=l,this.instancedDataCount=0,this.rotation=[0,0,0],this.scale=[1,1,1],this.translation=[0,0,0]}}class z2{constructor(){this.instancedDataArray=new $c,this.instancesEvaluatedElevation=[],this.features=[],this.idToFeaturesIndex={}}}class Zv{constructor(n){this.zoom=n.zoom,this.canonical=n.canonical,this.layers=n.layers,this.layerIds=this.layers.map(l=>l.fqid),this.projection=n.projection,this.index=n.index,this.hasZoomDependentProperties=this.layers[0].isZoomDependent(),this.stateDependentLayerIds=this.layers.filter(l=>l.isStateDependent()).map(l=>l.id),this.hasPattern=!1,this.instancesPerModel={},this.validForExaggeration=0,this.maxVerticalOffset=0,this.maxScale=0,this.maxHeight=0,this.lookupDim=this.zoom>this.canonical.z?256:this.zoom>15?75:100,this.instanceCount=0,this.terrainElevationMin=0,this.terrainElevationMax=0,this.validForDEMTile={id:null,timestamp:0},this.modelUris=[],this.modelsRequested=!1,this.activeReplacements=[],this.replacementUpdateTime=0}updateFootprints(n,l){}populate(n,l,d,_){this.tileToMeter=o(d);const f=this.layers[0]._featureFilter.needGeometry;this.lookup=new Uint8Array(this.lookupDim*this.lookupDim);for(const{feature:g,id:w,index:S,sourceLayerIndex:P}of n){const x=w??(g.properties&&g.properties.hasOwnProperty("id")?g.properties.id:void 0),I=U(g,f);if(!this.layers[0]._featureFilter.filter(new tr(this.zoom),I,d))continue;const R={id:x,sourceLayerIndex:P,index:S,geometry:f?I.geometry:L(g,d,_),properties:g.properties,type:g.type,patterns:{}},E=this.addFeature(R,R.geometry,I);E&&l.featureIndex.insert(g,R.geometry,S,P,this.index,this.instancesPerModel[E].instancedDataArray.length,Rt/32)}this.lookup=null}update(n,l,d,_){for(const f in this.instancesPerModel){const g=this.instancesPerModel[f];for(const w in n)g.idToFeaturesIndex.hasOwnProperty(w)&&(this.evaluate(g.features[g.idToFeaturesIndex[w]],n[w],g,!0),this.uploaded=!1)}this.maxHeight=0}updateZoomBasedPaintProperties(){if(!this.hasZoomDependentProperties)return!1;let n=!1;for(const l in this.instancesPerModel){const d=this.instancesPerModel[l];for(const _ of d.features){const f=this.layers[0],g=_.feature,w=this.canonical,S=f.paint.get("model-rotation").evaluate(g,{},w),P=f.paint.get("model-scale").evaluate(g,{},w),x=f.paint.get("model-translation").evaluate(g,{},w);Re.vec3.exactEquals(_.rotation,S)&&Re.vec3.exactEquals(_.scale,P)&&Re.vec3.exactEquals(_.translation,x)||(this.evaluate(_,_.featureStates,d,!0),n=!0)}}return n}updateReplacement(n,l,d,_){if(l.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=l.updateTime;const f=l.getReplacementRegionsForTile(n.toUnwrapped(),!0);if(xv(this.activeReplacements,f))return!1;this.activeReplacements=f;let g=!1;for(const w in this.instancesPerModel){const S=this.instancesPerModel[w],P=S.instancedDataArray;for(const x of S.features){const I=x.instancedDataOffset,R=x.instancedDataCount;for(let E=0;E<R;E++){const C=16*(E+I);let D=P.float32[C+0];const N=D>Rt;D=N?D-Rt:D;const z=Math.floor(D),G=P.float32[C+1];let W=!1;for(const H of this.activeReplacements)if(!eT(H,d,k2.Model,_)&&!(H.min.x>z||z>H.max.x||H.min.y>G||G>H.max.y)&&(W=oT(sT(z,G,n.canonical,H.footprintTileId.canonical),H.footprint),W))break;P.float32[C]=W?D+Rt:D,g=g||W!==N}}}return g}isEmpty(){for(const n in this.instancesPerModel)if(this.instancesPerModel[n].instancedDataArray.length!==0)return!1;return!0}uploadPending(){return!this.uploaded}upload(n){if(!this.uploaded)for(const l in this.instancesPerModel){const d=this.instancesPerModel[l];d.instancedDataArray.length<0||d.instancedDataArray.length===0||(d.instancedDataBuffer?d.instancedDataBuffer.updateData(d.instancedDataArray):d.instancedDataBuffer=n.createVertexBuffer(d.instancedDataArray,dO.members,!0,void 0,this.instanceCount))}this.uploaded=!0}destroy(){for(const l in this.instancesPerModel){const d=this.instancesPerModel[l];d.instancedDataArray.length!==0&&d.instancedDataBuffer&&d.instancedDataBuffer.destroy()}const n=this.layers[0].modelManager;if(n&&this.modelUris)for(const l of this.modelUris)n.removeModel(l,"")}addFeature(n,l,d){const _=this.layers[0],f=_.layout.get("model-id").evaluate(d,{},this.canonical);if(!f)return mi(`modelId is not evaluated for layer ${_.id} and it is not going to get rendered.`),f;L2(f,!1)&&(this.modelUris.includes(f)||this.modelUris.push(f)),this.instancesPerModel[f]||(this.instancesPerModel[f]=new z2);const g=this.instancesPerModel[f],w=g.instancedDataArray,S=new N2(d,w.length);for(const P of l)for(const x of P){if(x.x<0||x.x>=Rt||x.y<0||x.y>=Rt)continue;const I=(this.lookupDim-1)/Rt,R=this.lookupDim*(x.y*I|0)+x.x*I|0;if(this.lookup){if(this.lookup[R]!==0)continue;this.lookup[R]=1}this.instanceCount++;const E=w.length;w.resize(E+1),g.instancesEvaluatedElevation.push(0),w.float32[16*E]=x.x,w.float32[16*E+1]=x.y}return S.instancedDataCount=g.instancedDataArray.length-S.instancedDataOffset,S.instancedDataCount>0&&(n.id&&(g.idToFeaturesIndex[n.id]=g.features.length),g.features.push(S),this.evaluate(S,{},g,!1)),f}getModelUris(){return this.modelUris}evaluate(n,l,d,_){const f=this.layers[0],g=n.feature,w=this.canonical,S=n.rotation=f.paint.get("model-rotation").evaluate(g,l,w),P=n.scale=f.paint.get("model-scale").evaluate(g,l,w),x=n.translation=f.paint.get("model-translation").evaluate(g,l,w),I=f.paint.get("model-color").evaluate(g,l,w);I.a=f.paint.get("model-color-mix-intensity").evaluate(g,l,w);const R=[];this.maxVerticalOffset<x[2]&&(this.maxVerticalOffset=x[2]),this.maxScale=Math.max(Math.max(this.maxScale,P[0]),Math.max(P[1],P[2])),O2(R,S,P);const E=Math.round(100*I.a)+I.b/1.05;for(let C=0;C<n.instancedDataCount;++C){const D=n.instancedDataOffset+C,N=16*D,z=d.instancedDataArray.float32;let G=0;_&&(G=z[N+6]-d.instancesEvaluatedElevation[D]);const W=0|z[N+1];z[N]=(0|z[N])+I.r/1.05,z[N+1]=W+I.g/1.05,z[N+2]=E,z[N+3]=1/(w.z>10?this.tileToMeter:o(w,W)),z[N+4]=x[0],z[N+5]=x[1],z[N+6]=x[2]+G,z[N+7]=R[0],z[N+8]=R[1],z[N+9]=R[2],z[N+10]=R[4],z[N+11]=R[5],z[N+12]=R[6],z[N+13]=R[8],z[N+14]=R[9],z[N+15]=R[10],d.instancesEvaluatedElevation[D]=x[2]}}}let U2,V2;Vt(Zv,"ModelBucket",{omit:["layers"]}),Vt(z2,"PerModelAttributes"),Vt(N2,"ModelFeature");const su=64,Uh={CoordinateSpaceTile:1,CoordinateSpaceYUp:2,HasMapboxMeshFeatures:4,HasMeshoptCompression:8};function j2(u,n,l,d,_,f,g,w,S,P=!1){const x=l.zoom,I=l.project(d),R=kl(d.lat,x),E=1/R;Re.mat4.identity(u),Re.mat4.translate(u,u,[I.x+g[0]*E,I.y+g[1]*E,g[2]]);let C=1,D=1;const N=l.worldSize;if(P){if(l.projection.name==="mercator"){let H=0;l.elevation&&(H=l.elevation.getAtPointOrZero(new c(I.x/N,I.y/N),0));const q=Re.vec4.transformMat4([],[I.x,I.y,H,1],l.projMatrix)[3]/l.cameraToCenterDistance;C=q,D=q*kl(l.center.lat,x)}else if(l.projection.name==="globe"){const H=Xv(u,l),q=Re.mat4.multiply([],l.projMatrix,H),Y=[0,0,0,1];Re.vec4.transformMat4(Y,Y,q);const ie=Y[3]/l.cameraToCenterDistance,he=Hn(x),ce=l.projection.pixelsPerMeter(d.lat,N)*kl(d.lat,x),le=l.projection.pixelsPerMeter(l.center.lat,N)*kl(l.center.lat,x);C=ie/ii(ce,Yf(l.center.lat),he),D=ie*R/ce,C*=le,D*=le}}else C=E;Re.mat4.scale(u,u,[C,C,D]);const z=[...u],G=n.orientation,W=[];if(O2(W,[G[0]+_[0],G[1]+_[1],G[2]+_[2]],f),Re.mat4.multiply(u,z,W),w&&l.elevation){let H=0;const q=[];if(S&&l.elevation){H=function(he,ce,le,Te,de){const Se=ce.elevation;if(!Se)return 0;const Pe=Wt.projectAabbCorners(le,Te),Me=Dn(1,de.lat)*ce.worldSize,Oe=function(Ht,Ft){const zt=[0,0,1],ai=[{corners:[0,1,3,2],dotProductWithUp:0},{corners:[1,5,2,6],dotProductWithUp:0},{corners:[0,4,1,5],dotProductWithUp:0},{corners:[2,6,3,7],dotProductWithUp:0},{corners:[4,7,5,6],dotProductWithUp:0},{corners:[0,3,4,7],dotProductWithUp:0}];for(const fi of ai){const _i=Ht[fi.corners[0]],gi=Ht[fi.corners[1]],wi=Ht[fi.corners[2]],Ai=[gi[0]-_i[0],gi[1]-_i[1],Ft*(gi[2]-_i[2])],er=Re.vec3.cross(Ai,Ai,[wi[0]-_i[0],wi[1]-_i[1],Ft*(wi[2]-_i[2])]);Re.vec3.normalize(er,er),fi.dotProductWithUp=Re.vec3.dot(er,zt)}return ai.sort((fi,_i)=>fi.dotProductWithUp-_i.dotProductWithUp),ai[0].corners}(Pe,Me),Ue=Pe[Oe[0]],Ge=Pe[Oe[1]],Ne=Pe[Oe[2]],rt=Pe[Oe[3]],mt=Se.getAtPointOrZero(new c(Ue[0]/ce.worldSize,Ue[1]/ce.worldSize),0),it=Se.getAtPointOrZero(new c(Ge[0]/ce.worldSize,Ge[1]/ce.worldSize),0),Bt=Se.getAtPointOrZero(new c(Ne[0]/ce.worldSize,Ne[1]/ce.worldSize),0),Mt=Se.getAtPointOrZero(new c(rt[0]/ce.worldSize,rt[1]/ce.worldSize),0),bt=(mt+Mt)/2,_t=(it+Bt)/2;return bt>_t?it<Bt?og(he,Ge,rt,Ue,it,Mt,mt,Me):og(he,Ne,Ue,rt,Bt,mt,Mt,Me):mt<Mt?og(he,Ue,Ge,Ne,mt,it,Bt,Me):og(he,rt,Ne,Ge,Mt,Bt,it,Me),Math.max(bt,_t)}(q,l,n.aabb,u,d);const Y=Re.mat4.fromQuat([],q),ie=Re.mat4.multiply([],Y,W);Re.mat4.multiply(u,z,ie)}else H=l.elevation.getAtPointOrZero(new c(I.x/N,I.y/N),0);H!==0&&(u[14]+=H)}}function yp(u,n,l=!1){u.uploaded||(u.gfxTexture=new $v(n,u.image,l?n.gl.R8:n.gl.RGBA8,{useMipmap:u.sampler.minFilter>=n.gl.NEAREST_MIPMAP_NEAREST}),u.uploaded=!0,u.image=null)}function pO(u,n,l){u.indexBuffer=n.createIndexBuffer(u.indexArray,!1,!0),u.vertexBuffer=n.createVertexBuffer(u.vertexArray,aO.members,!1,!0),u.normalArray&&(u.normalBuffer=n.createVertexBuffer(u.normalArray,hO.members,!1,!0)),u.texcoordArray&&(u.texcoordBuffer=n.createVertexBuffer(u.texcoordArray,uO.members,!1,!0)),u.colorArray&&(u.colorBuffer=n.createVertexBuffer(u.colorArray,(u.colorArray.bytesPerElement===12?lO:cO).members,!1,!0)),u.featureArray&&(u.pbrBuffer=n.createVertexBuffer(u.featureArray,fO.members,!0)),u.segments=Ar.simpleSegment(0,0,u.vertexArray.length,u.indexArray.length);const d=u.material;d.pbrMetallicRoughness.baseColorTexture&&yp(d.pbrMetallicRoughness.baseColorTexture,n),d.pbrMetallicRoughness.metallicRoughnessTexture&&yp(d.pbrMetallicRoughness.metallicRoughnessTexture,n),d.normalTexture&&yp(d.normalTexture,n),d.occlusionTexture&&yp(d.occlusionTexture,n,l),d.emissionTexture&&yp(d.emissionTexture,n)}function Yv(u,n,l){if(u.meshes)for(const d of u.meshes)pO(d,n,l);if(u.children)for(const d of u.children)Yv(d,n,l)}function lg(u){if(u.meshes)for(const n of u.meshes)n.indexArray.destroy(),n.vertexArray.destroy(),n.colorArray&&n.colorArray.destroy(),n.normalArray&&n.normalArray.destroy(),n.texcoordArray&&n.texcoordArray.destroy(),n.featureArray&&n.featureArray.destroy();if(u.children)for(const n of u.children)lg(n)}function Kv(u){if(u.meshes)for(const l of u.meshes)l.vertexBuffer&&(l.vertexBuffer.destroy(),l.indexBuffer.destroy(),l.normalBuffer&&l.normalBuffer.destroy(),l.texcoordBuffer&&l.texcoordBuffer.destroy(),l.colorBuffer&&l.colorBuffer.destroy(),l.pbrBuffer&&l.pbrBuffer.destroy(),l.segments.destroy(),l.material&&((n=l.material).pbrMetallicRoughness.baseColorTexture&&n.pbrMetallicRoughness.baseColorTexture.gfxTexture&&n.pbrMetallicRoughness.baseColorTexture.gfxTexture.destroy(),n.pbrMetallicRoughness.metallicRoughnessTexture&&n.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture&&n.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture.destroy(),n.normalTexture&&n.normalTexture.gfxTexture&&n.normalTexture.gfxTexture.destroy(),n.emissionTexture&&n.emissionTexture.gfxTexture&&n.emissionTexture.gfxTexture.destroy(),n.occlusionTexture&&n.occlusionTexture.gfxTexture&&n.occlusionTexture.gfxTexture.destroy()));var n;if(u.children)for(const l of u.children)Kv(l)}class Vh{constructor(n,l,d){this._demTile=n,this._dem=this._demTile.dem,this._scale=l,this._offset=d}static create(n,l,d){const _=d||n.findDEMTileFor(l);if(!_||!_.dem)return;const f=_.dem,g=_.tileID,w=1<<l.canonical.z-g.canonical.z;return new Vh(_,f.dim/Rt/w,[(l.canonical.x/w-g.canonical.x)*f.dim,(l.canonical.y/w-g.canonical.y)*f.dim])}tileCoordToPixel(n,l){const d=l*this._scale+this._offset[1],_=Math.floor(n*this._scale+this._offset[0]),f=Math.floor(d);return new At(_,f)}getElevationAt(n,l,d,_){const f=n*this._scale+this._offset[0],g=l*this._scale+this._offset[1],w=Math.floor(f),S=Math.floor(g),P=this._dem;return _=!!_,d?ii(ii(P.get(w,S,_),P.get(w,S+1,_),g-S),ii(P.get(w+1,S,_),P.get(w+1,S+1,_),g-S),f-w):P.get(w,S,_)}getElevationAtPixel(n,l,d){return this._dem.get(n,l,!!d)}getMeterToDEM(n){return(1<<this._demTile.tileID.canonical.z)*Dn(1,n)*this._dem.stride}}const Jv=new Float32Array(262144),ou=new Uint8Array(262144);function H2(u){let n=0;if(u.meshes)for(const l of u.meshes)n=Math.max(n,l.aabb.max[2]);if(u.children)for(const l of u.children)n=Math.max(n,H2(l));return n}function G2(u,n,l){if(u.meshes)for(const d of u.meshes){if(d.aabb.min[0]===1/0)continue;const _=Wt.applyTransform(d.aabb,u.matrix);l.insert(n,_.min[0],_.min[1],_.max[0],_.max[1])}if(u.children)for(const d of u.children)G2(d,n,l)}const $2=["","wall","door","roof","window","lamp","logo"];class W2{constructor(n){this.node=n,this.evaluatedRMEA=[[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,0,0,1],[.4,1,0,1],[1,0,0,1],[1,0,0,1]],this.hiddenByReplacement=!1,this.evaluatedScale=[1,1,1],this.evaluatedColor=[],this.emissionHeightBasedParams=[],this.cameraCollisionOpacity=1,this.feature={type:"Point",id:n.id,geometry:[],properties:{height:H2(n)}},this.aabb=this._getLocalBounds(),this.state=null}_getLocalBounds(){if(!this.node.meshes)return new Wt([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);if(!this.aabb){let n=0;const l=new Wt([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);for(const d of this.node.meshes)this.node.lightMeshIndex!==n&&(d.transformedAabb=Wt.applyTransformFast(d.aabb,this.node.matrix),l.encapsulate(d.transformedAabb)),n++;this.aabb=l}return this.aabb}}class cg{constructor(n,l,d,_,f,g,w){this.id=d,this.layers=n,this.layerIds=this.layers.map(S=>S.fqid),this.stateDependentLayerIds=this.layers.filter(S=>S.isStateDependent()).map(S=>S.id),this.modelTraits|=Uh.CoordinateSpaceTile,this.uploaded=!1,this.hasPattern=!1,_&&(this.modelTraits|=Uh.HasMapboxMeshFeatures),f&&(this.modelTraits|=Uh.HasMeshoptCompression),this.zoom=-1,this.terrainExaggeration=1,this.projection={name:"mercator"},this.replacementUpdateTime=0,this.elevationReadFromZ=255,this.brightness=g,this.dirty=!0,this.needsUpload=!1,this.nodesInfo=[];for(const S of l)this.nodesInfo.push(new W2(S)),G2(S,w.featureIndexArray.length,w.grid),w.featureIndexArray.emplaceBack(this.nodesInfo.length-1,0,w.bucketLayerIDs.length-1,0);this.states={}}updateFootprints(n,l){for(const d of this.getNodesInfo()){const _=d.node;_.footprint&&l.push({footprint:_.footprint,id:n})}}update(n){const l=Object.keys(n).length!==0;if(l&&!this.stateDependentLayers.length)return;const d=l?this.stateDependentLayers:this.layers;if(!Wr(n,this.states))for(const _ of d)this.evaluate(_,n);this.states=structuredClone(n)}populate(){console.log("populate 3D model bucket")}uploadPending(){return!this.uploaded||this.needsUpload}upload(n){if(!this.needsUpload)return;const l=this.getNodesInfo();for(const d of l){const _=d.node;this.uploaded?this.updatePbrBuffer(_):Yv(_,n,!0)}for(const d of l)lg(d.node);this.uploaded=!0,this.needsUpload=!1}updatePbrBuffer(n){let l=!1;if(!n.meshes)return l;for(const d of n.meshes)d.pbrBuffer&&(d.pbrBuffer.updateData(d.featureArray),l=!0);return l}needsReEvaluation(n,l,d){const _=n.transform.projectionOptions,f=n.style.getBrightness(),g=this.brightness!==f;if(!this.uploaded||this.dirty||_.name!==this.projection.name||vp(d.paint.get("model-color").value,g)||vp(d.paint.get("model-color-mix-intensity").value,g)||vp(d.paint.get("model-roughness").value,g)||vp(d.paint.get("model-emissive-strength").value,g)||vp(d.paint.get("model-height-based-emissive-strength-multiplier").value,g)){this.projection=_,this.brightness=f;const w=this.getNodesInfo();for(const S of w)S.state=null;return!0}return!1}evaluateScale(n,l){if(n.transform.zoom===this.zoom)return;this.zoom=n.transform.zoom;const d=this.getNodesInfo(),_=this.id.canonical;for(const f of d){const g=f.feature;f.evaluatedScale=l.paint.get("model-scale").evaluate(g,{},_)}}evaluate(n,l){const d=this.getNodesInfo();for(const _ of d){if(!_.node.meshes)continue;const f=_.feature,g=l&&l[f.id];if(Wr(g,_.state))continue;_.state=structuredClone(g);const w=_.node.meshes&&_.node.meshes[0].featureData,S=_.evaluatedColor[2],P=_.evaluatedRMEA[2],x=this.id.canonical;if(_.hasTranslucentParts=!1,w){for(let I=0;I<$2.length;I++){const R=$2[I];R.length&&(f.properties.part=R);const E=n.paint.get("model-color").evaluate(f,g,x).toRenderColor(null),C=n.paint.get("model-color-mix-intensity").evaluate(f,g,x);_.evaluatedColor[I]=[E.r,E.g,E.b,C],_.evaluatedRMEA[I][0]=n.paint.get("model-roughness").evaluate(f,g,x),_.evaluatedRMEA[I][2]=n.paint.get("model-emissive-strength").evaluate(f,g,x),_.evaluatedRMEA[I][3]=E.a,_.emissionHeightBasedParams[I]=n.paint.get("model-height-based-emissive-strength-multiplier").evaluate(f,g,x),!_.hasTranslucentParts&&E.a<1&&(_.hasTranslucentParts=!0)}delete f.properties.part,_O(_,S!==_.evaluatedColor[2]||P!==_.evaluatedRMEA[2],this.modelTraits)}else _.evaluatedRMEA[0][2]=n.paint.get("model-emissive-strength").evaluate(f,g,x);_.evaluatedScale=n.paint.get("model-scale").evaluate(f,g,x),this.updatePbrBuffer(_.node)||(this.needsUpload=!0)}this.dirty=!1}elevationUpdate(n,l,d,_){const f=n.findDEMTileFor(d);if(f&&(f.tileID.canonical!==this.terrainTile||l!==this.terrainExaggeration)){if(f.dem&&f.tileID.overscaledZ!==this.elevationReadFromZ){this.elevationReadFromZ=f.tileID.overscaledZ;const g=Vh.create(n,d,f);if(!g)return;this.modelTraits&Uh.HasMapboxMeshFeatures&&this.updateDEM(n,g,d,_);for(const w of this.getNodesInfo()){const S=w.node;if(!S.footprint||!S.footprint.vertices||!S.footprint.vertices.length)continue;const P=S.footprint.vertices;let x=g.getElevationAt(P[0].x,P[0].y,!0,!0);for(let I=1;I<P.length;I++)x=Math.min(x,g.getElevationAt(P[I].x,P[I].y,!0,!0));S.elevation=x}}this.terrainTile=f.tileID.canonical,this.terrainExaggeration=l}}updateDEM(n,l,d,_){let f=l._dem._modifiedForSources[_];if(f===void 0&&(l._dem._modifiedForSources[_]=[],f=l._dem._modifiedForSources[_]),f.includes(d.canonical))return;const g=l._dem.dim;f.push(d.canonical);let w=!1;for(const S of this.getNodesInfo()){const P=S.node;if(!P.footprint||!P.footprint.grid)continue;const x=P.footprint.grid,I=l.tileCoordToPixel(x.min.x,x.min.y),R=l.tileCoordToPixel(x.max.x,x.max.y),E=Math.min(Math.min(g-R.y,I.x),Math.min(I.y,g-R.x));if(E<0)continue;const C=yi(E,2,5);let D=Math.max(0,I.x-C),N=Math.max(0,I.y-C),z=Math.min(R.x+C,g-1),G=Math.min(R.y+C,g-1);for(let Y=N;Y<=G;++Y)for(let ie=D;ie<=z;++ie)ou[Y*g+ie]=255;let W=0,H=0;for(let Y=0;Y<x.cellsY;++Y)for(let ie=0;ie<x.cellsX;++ie){if(!x.cells[Y*x.cellsX+ie])continue;const he=l.tileCoordToPixel(x.min.x+ie/x.xScale,x.min.y+Y/x.yScale),ce=l.tileCoordToPixel(x.min.x+(ie+1)/x.xScale,x.min.y+(Y+1)/x.yScale);for(let le=he.y;le<=Math.min(ce.y+1,g-1);++le)for(let Te=he.x;Te<=Math.min(ce.x+1,g-1);++Te)ou[le*g+Te]===255&&(ou[le*g+Te]=0,W+=l.getElevationAtPixel(Te,le),H++)}const q=W/H;D=Math.max(1,I.x-C),N=Math.max(1,I.y-C),z=Math.min(R.x+C,g-2),G=Math.min(R.y+C,g-2),w=!0;for(let Y=N;Y<=G;++Y)for(let ie=D;ie<=z;++ie)ou[Y*g+ie]===0&&(Jv[Y*g+ie]=l._dem.set(ie,Y,q));for(let Y=1;Y<C;++Y){D=Math.max(1,I.x-Y),N=Math.max(1,I.y-Y),z=Math.min(R.x+Y,g-2),G=Math.min(R.y+Y,g-2);for(let ie=N;ie<=G;++ie)for(let he=D;he<=z;++he){const ce=ie*g+he;if(ou[ce]===255){let le=0,Te=0,de=-1,Se=-1;for(let Pe=-1;Pe<=1;++Pe)for(let Me=-1;Me<=1;++Me){const Oe=(ie+Pe)*g+he+Me;if(ou[Oe]>=Y)continue;const Ue=Jv[Oe],Ge=Math.abs(Ue);Ge>Te&&(le=Ue,Te=Ge,de=Me,Se=Pe)}if(Te>.1){const Pe=1-(Y+.5*Math.abs(de*Se))/C;let Me=l._dem.get(he,ie)+le*Pe;const Oe=l._dem.get(he+de,ie+Se),Ue=l._dem.get(he-de,ie-Se,!0);(Me-Oe)*(Me-Ue)>0&&(Me=(Oe+Ue)/2),Jv[ce]=l._dem.set(he,ie,Me),ou[ce]=Y}}}}}w&&(l._demTile.needsDEMTextureUpload=!0,l._dem._timestamp=xe.now())}getNodesInfo(){return this.nodesInfo}destroy(){const n=this.getNodesInfo();for(const l of n)lg(l.node),Kv(l.node)}isEmpty(){return!this.nodesInfo.length}updateReplacement(n,l){if(l.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=l.updateTime;const d=l.getReplacementRegionsForTile(n.toUnwrapped()),_=this.getNodesInfo();for(let f=0;f<this.nodesInfo.length;f++){const g=_[f].node;_[f].hiddenByReplacement=!!g.footprint&&!d.find(w=>w.footprint===g.footprint)}}getHeightAtTileCoord(n,l){const d=this.getNodesInfo(),_=[],f=[0,0,0],g=Re.mat4.identity([]);for(let w=0;w<this.nodesInfo.length;w++){const S=d[w],P=S.node.meshes[0],x=P.transformedAabb;if(n<x.min[0]||l<x.min[1]||n>x.max[0]||l>x.max[1])continue;if(S.node.hidden===!0)return{height:1/0,maxHeight:S.feature.properties.height,hidden:!1,verticalScale:S.evaluatedScale[2]};Re.mat4.invert(g,S.node.matrix),f[0]=n,f[1]=l,Re.vec3.transformMat4(f,f,g);const I=(f[0]-P.aabb.min[0])/(P.aabb.max[0]-P.aabb.min[0])*su|0,R=Math.min(63,(f[1]-P.aabb.min[1])/(P.aabb.max[1]-P.aabb.min[1])*su|0)*su+Math.min(63,I),E=P.heightmap[R];if(!(E<0&&S.node.footprint))return S.hiddenByReplacement?void 0:{height:E,maxHeight:S.feature.properties.height,hidden:!1,verticalScale:S.evaluatedScale[2]};if(S.node.footprint.grid.query(new At(n,l),new At(n,l),_),_.length>0)return{height:void 0,maxHeight:S.feature.properties.height,hidden:S.hiddenByReplacement,verticalScale:S.evaluatedScale[2]}}}}function vp(u,n){return!u.isLightConstant&&n}function mO(u,n,l,d,_,f,g,w){let S=(61440&n|(61440&n)>>4)>>8,P=(3840&n|(3840&n)>>4)>>4,x=240&n|(240&n)>>4;l[3]>0&&(S=ii(S,255*l[0],l[3]),P=ii(P,255*l[1],l[3]),x=ii(x,255*l[2],l[3]));const I=S<<8|P,R=x<<8|Math.floor(255*d[3]),E=function(Y){const ie=yi(Y,0,2);return Math.min(Math.round(.5*ie*255),255)}(d[2])<<8|15*d[0]<<4|15*d[1],C=yi(_[0],0,1),D=yi(_[1],0,1),N=yi(_[2],0,1),z=yi(_[3],0,1);let G,W,H,q;if(C!==D&&g!==f&&D!==C){const Y=g-f;W=1/(Y*(D-C)),H=-(f+Y*C)/(Y*(D-C));const ie=yi(_[4],-1,1);q=Math.pow(10,ie),G=255*N<<8|255*z}else G=65535,W=0,H=1,q=1;if(u.emplaceBack(I,R,E,G,W,H,q),w){const Y=w.length;w.clear();for(let ie=0;ie<Y;ie++)w.emplaceBack(I,R,E,G,W,H,q)}}function _O(u,n,l){const d=u.node;let _=0;const f=l&Uh.HasMeshoptCompression;for(const g of d.meshes){if(d.lights&&d.lightMeshIndex===_||!g.featureData)continue;g.featureArray=new Wc,g.featureArray.reserve(g.featureData.length);let w=n;for(const S of g.featureData){const P=f?65535&S:S>>16&65535,x=f?S>>16&65535:65535&S,I=(15&x)<8?15&x:0,R=u.evaluatedRMEA[I],E=u.evaluatedColor[I],C=u.emissionHeightBasedParams[I];let D;if(w&&I===2&&d.lights&&(D=new Wc,D.resize(10*d.lights.length)),mO(g.featureArray,P,E,R,C,g.aabb.min[2],g.aabb.max[2],D),D&&w){w=!1;const N=d.meshes[d.lightMeshIndex];N.featureArray=D,N.featureArray._trim()}}g.featureArray._trim(),_++}}function q2(u,n,l,d){const _=1<<u.z;n.lat=an((d/Rt+u.y)/_),n.lng=es((l/Rt+u.x)/_)}Vt(cg,"Tiled3dModelBucket",{omit:["layers"]}),Vt(W2,"Tiled3dModelFeature");const gO={circle:class extends Jr{constructor(u,n,l,d){super(u,{layout:gt||(gt=new cr({"circle-sort-key":new Nt(qe.layout_circle["circle-sort-key"]),"circle-elevation-reference":new wt(qe.layout_circle["circle-elevation-reference"]),visibility:new wt(qe.layout_circle.visibility)})),paint:Ve||(Ve=new cr({"circle-radius":new Nt(qe.paint_circle["circle-radius"]),"circle-color":new Nt(qe.paint_circle["circle-color"]),"circle-blur":new Nt(qe.paint_circle["circle-blur"]),"circle-opacity":new Nt(qe.paint_circle["circle-opacity"]),"circle-translate":new wt(qe.paint_circle["circle-translate"]),"circle-translate-anchor":new wt(qe.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new wt(qe.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new wt(qe.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new Nt(qe.paint_circle["circle-stroke-width"]),"circle-stroke-color":new Nt(qe.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new Nt(qe.paint_circle["circle-stroke-opacity"]),"circle-emissive-strength":new wt(qe.paint_circle["circle-emissive-strength"]),"circle-color-use-theme":new Nt({type:"string",default:"default","property-type":"data-driven"}),"circle-stroke-color-use-theme":new Nt({type:"string",default:"default","property-type":"data-driven"})}))},n,l,d)}createBucket(u){return new Q(u)}queryRadius(u){const n=u;return at("circle-radius",this,n)+at("circle-stroke-width",this,n)+nt(this.paint.get("circle-translate"))}queryIntersectsFeature(u,n,l,d,_,f,g,w){const S=et(this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),f.angle,u.pixelToTileUnitsFactor),P=this.paint.get("circle-radius").evaluate(n,l)+this.paint.get("circle-stroke-width").evaluate(n,l);return Bh(u,d,f,g,w,this.paint.get("circle-pitch-alignment")==="map",this.paint.get("circle-pitch-scale")==="map",S,P)}getProgramIds(){return["circle"]}getDefaultProgramParams(u,n,l){const d=Ll(this);return{config:new Ha(this,{zoom:n,lut:l}),defines:d,overrideFog:!1}}},heatmap:class extends Jr{createBucket(u){return new SA(u)}constructor(u,n,l,d){super(u,{layout:IA||(IA=new cr({visibility:new wt(qe.layout_heatmap.visibility)})),paint:CA||(CA=new cr({"heatmap-radius":new Nt(qe.paint_heatmap["heatmap-radius"]),"heatmap-weight":new Nt(qe.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new wt(qe.paint_heatmap["heatmap-intensity"]),"heatmap-color":new Cl(qe.paint_heatmap["heatmap-color"]),"heatmap-opacity":new wt(qe.paint_heatmap["heatmap-opacity"]),"heatmap-color-use-theme":new Nt({type:"string",default:"default","property-type":"data-driven"})}))},n,l,d),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(u){u==="heatmap-color"&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=Jf({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}queryRadius(u){return at("heatmap-radius",this,u)}queryIntersectsFeature(u,n,l,d,_,f,g,w){const S=this.paint.get("heatmap-radius").evaluate(n,l);return Bh(u,d,f,g,w,!0,!0,new At(0,0),S)}hasOffscreenPass(){return this.paint.get("heatmap-opacity")!==0&&this.visibility!=="none"}getProgramIds(){return["heatmap","heatmapTexture"]}getDefaultProgramParams(u,n,l){return u==="heatmap"?{config:new Ha(this,{zoom:n,lut:l}),overrideFog:!1}:{}}},hillshade:class extends Jr{constructor(u,n,l,d){super(u,{layout:MA||(MA=new cr({visibility:new wt(qe.layout_hillshade.visibility)})),paint:RA||(RA=new cr({"hillshade-illumination-direction":new wt(qe.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new wt(qe.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new wt(qe.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new wt(qe.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new wt(qe.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new wt(qe.paint_hillshade["hillshade-accent-color"]),"hillshade-emissive-strength":new wt(qe.paint_hillshade["hillshade-emissive-strength"]),"hillshade-shadow-color-use-theme":new Nt({type:"string",default:"default","property-type":"data-driven"}),"hillshade-highlight-color-use-theme":new Nt({type:"string",default:"default","property-type":"data-driven"}),"hillshade-accent-color-use-theme":new Nt({type:"string",default:"default","property-type":"data-driven"})}))},n,l,d)}shouldRedrape(){return this.hasOffscreenPass()&&this.paint.get("hillshade-illumination-anchor")==="viewport"}hasOffscreenPass(){return this.paint.get("hillshade-exaggeration")!==0&&this.visibility!=="none"}getProgramIds(){return["hillshade","hillshadePrepare"]}getDefaultProgramParams(u,n,l){return{overrideFog:!1}}},fill:class extends Jr{constructor(u,n,l,d){super(u,{layout:zA||(zA=new cr({"fill-sort-key":new Nt(qe.layout_fill["fill-sort-key"]),visibility:new wt(qe.layout_fill.visibility),"fill-elevation-reference":new wt(qe.layout_fill["fill-elevation-reference"])})),paint:UA||(UA=new cr({"fill-antialias":new wt(qe.paint_fill["fill-antialias"]),"fill-opacity":new Nt(qe.paint_fill["fill-opacity"]),"fill-color":new Nt(qe.paint_fill["fill-color"]),"fill-outline-color":new Nt(qe.paint_fill["fill-outline-color"]),"fill-translate":new wt(qe.paint_fill["fill-translate"]),"fill-translate-anchor":new wt(qe.paint_fill["fill-translate-anchor"]),"fill-pattern":new Nt(qe.paint_fill["fill-pattern"]),"fill-emissive-strength":new wt(qe.paint_fill["fill-emissive-strength"]),"fill-z-offset":new Nt(qe.paint_fill["fill-z-offset"]),"fill-color-use-theme":new Nt({type:"string",default:"default","property-type":"data-driven"}),"fill-outline-color-use-theme":new Nt({type:"string",default:"default","property-type":"data-driven"})}))},n,l,d)}getProgramIds(){const u=this.paint.get("fill-pattern"),n=u&&u.constantOr(1),l=[n?"fillPattern":"fill"];return this.paint.get("fill-antialias")&&l.push(n&&!this.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline"),l}getDefaultProgramParams(u,n,l){return{config:new Ha(this,{zoom:n,lut:l}),overrideFog:!1}}recalculate(u,n){super.recalculate(u,n);const l=this.paint._values["fill-outline-color"];l.value.kind==="constant"&&l.value.value===void 0&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(u){return new pv(u)}queryRadius(){return nt(this.paint.get("fill-translate"))}queryIntersectsFeature(u,n,l,d,_,f){return!u.queryGeometry.isAboveHorizon&&ee(je(u.tilespaceGeometry,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),f.angle,u.pixelToTileUnitsFactor),d)}isTileClipped(){return!0}is3D(){return this.paint.get("fill-z-offset").constantOr(1)!==0}},"fill-extrusion":class extends Jr{constructor(u,n,l,d){super(u,{layout:bT||(bT=new cr({visibility:new wt(qe["layout_fill-extrusion"].visibility),"fill-extrusion-edge-radius":new wt(qe["layout_fill-extrusion"]["fill-extrusion-edge-radius"])})),paint:wT||(wT=new cr({"fill-extrusion-opacity":new wt(qe["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new Nt(qe["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new wt(qe["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new wt(qe["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new Nt(qe["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-height":new Nt(qe["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new Nt(qe["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-height-alignment":new wt(qe["paint_fill-extrusion"]["fill-extrusion-height-alignment"]),"fill-extrusion-base-alignment":new wt(qe["paint_fill-extrusion"]["fill-extrusion-base-alignment"]),"fill-extrusion-vertical-gradient":new wt(qe["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"]),"fill-extrusion-ambient-occlusion-intensity":new wt(qe["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-intensity"]),"fill-extrusion-ambient-occlusion-radius":new wt(qe["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-radius"]),"fill-extrusion-ambient-occlusion-wall-radius":new wt(qe["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-wall-radius"]),"fill-extrusion-ambient-occlusion-ground-radius":new wt(qe["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-radius"]),"fill-extrusion-ambient-occlusion-ground-attenuation":new wt(qe["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-attenuation"]),"fill-extrusion-flood-light-color":new wt(qe["paint_fill-extrusion"]["fill-extrusion-flood-light-color"]),"fill-extrusion-flood-light-intensity":new wt(qe["paint_fill-extrusion"]["fill-extrusion-flood-light-intensity"]),"fill-extrusion-flood-light-wall-radius":new Nt(qe["paint_fill-extrusion"]["fill-extrusion-flood-light-wall-radius"]),"fill-extrusion-flood-light-ground-radius":new Nt(qe["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-radius"]),"fill-extrusion-flood-light-ground-attenuation":new wt(qe["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-attenuation"]),"fill-extrusion-vertical-scale":new wt(qe["paint_fill-extrusion"]["fill-extrusion-vertical-scale"]),"fill-extrusion-rounded-roof":new wt(qe["paint_fill-extrusion"]["fill-extrusion-rounded-roof"]),"fill-extrusion-cutoff-fade-range":new wt(qe["paint_fill-extrusion"]["fill-extrusion-cutoff-fade-range"]),"fill-extrusion-emissive-strength":new Nt(qe["paint_fill-extrusion"]["fill-extrusion-emissive-strength"]),"fill-extrusion-line-width":new Nt(qe["paint_fill-extrusion"]["fill-extrusion-line-width"]),"fill-extrusion-cast-shadows":new wt(qe["paint_fill-extrusion"]["fill-extrusion-cast-shadows"]),"fill-extrusion-color-use-theme":new Nt({type:"string",default:"default","property-type":"data-driven"}),"fill-extrusion-flood-light-color-use-theme":new Nt({type:"string",default:"default","property-type":"data-driven"})}))},n,l,d),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(u){return new z_(u)}queryRadius(){return nt(this.paint.get("fill-extrusion-translate"))}is3D(){return!0}hasShadowPass(){return this.paint.get("fill-extrusion-cast-shadows")}cutoffRange(){return this.paint.get("fill-extrusion-cutoff-fade-range")}canCastShadows(){return!0}getProgramIds(){return[this.paint.get("fill-extrusion-pattern").constantOr(1)?"fillExtrusionPattern":"fillExtrusion"]}queryIntersectsFeature(u,n,l,d,_,f,g,w,S){const P=et(this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),f.angle,u.pixelToTileUnitsFactor),x=this.paint.get("fill-extrusion-height").evaluate(n,l),I=this.paint.get("fill-extrusion-base").evaluate(n,l),R=[0,0],E=w&&f.elevation,C=f.elevation?f.elevation.exaggeration():1,D=u.tile.getBucket(this);if(E&&D instanceof z_){const H=D.centroidVertexArray,q=S+1;q<H.length&&(R[0]=H.geta_centroid_pos0(q),R[1]=H.geta_centroid_pos1(q))}if(R[0]===0&&R[1]===1)return!1;f.projection.name==="globe"&&(d=xT([d],[new At(0,0),new At(Rt,Rt)],u.tileID.canonical).map(H=>H.polygon).flat());const N=E?w:null,[z,G]=function(H,q,Y,ie,he,ce,le,Te,de,Se,Pe){return H.projection.name==="globe"?function(Me,Oe,Ue,Ge,Ne,rt,mt,it,Bt,Mt,bt){const _t=[],Ht=[],Ft=Me.projection.upVectorScale(bt,Me.center.lat,Me.worldSize).metersToTile,zt=[0,0,0,1],ai=[0,0,0,1],fi=(gi,wi,Ai,er)=>{gi[0]=wi,gi[1]=Ai,gi[2]=er,gi[3]=1},_i=vT();Ue>0&&(Ue+=_i),Ge+=_i;for(const gi of Oe){const wi=[],Ai=[];for(const er of gi){const Yi=er.x+Ne.x,ui=er.y+Ne.y,Wi=Me.projection.projectTilePoint(Yi,ui,bt),Zi=Me.projection.upVector(bt,er.x,er.y);let ar=Ue,Cr=Ge;if(mt){const Ur=TT(Yi,ui,Ue,Ge,mt,it,Bt,Mt);ar+=Ur.base,Cr+=Ur.top}Ue!==0?fi(zt,Wi.x+Zi[0]*Ft*ar,Wi.y+Zi[1]*Ft*ar,Wi.z+Zi[2]*Ft*ar):fi(zt,Wi.x,Wi.y,Wi.z),fi(ai,Wi.x+Zi[0]*Ft*Cr,Wi.y+Zi[1]*Ft*Cr,Wi.z+Zi[2]*Ft*Cr),Re.vec3.transformMat4(zt,zt,rt),Re.vec3.transformMat4(ai,ai,rt),wi.push(new ru(zt[0],zt[1],zt[2])),Ai.push(new ru(ai[0],ai[1],ai[2]))}_t.push(wi),Ht.push(Ai)}return[_t,Ht]}(H,q,Y,ie,he,ce,le,Te,de,Se,Pe):le?function(Me,Oe,Ue,Ge,Ne,rt,mt,it,Bt){const Mt=[],bt=[],_t=[0,0,0,1];for(const Ht of Me){const Ft=[],zt=[];for(const ai of Ht){const fi=ai.x+Ge.x,_i=ai.y+Ge.y,gi=TT(fi,_i,Oe,Ue,rt,mt,it,Bt);_t[0]=fi,_t[1]=_i,_t[2]=gi.base,_t[3]=1,Re.vec4.transformMat4(_t,_t,Ne),_t[3]=Math.max(_t[3],1e-5);const wi=new ru(_t[0]/_t[3],_t[1]/_t[3],_t[2]/_t[3]);_t[0]=fi,_t[1]=_i,_t[2]=gi.top,_t[3]=1,Re.vec4.transformMat4(_t,_t,Ne),_t[3]=Math.max(_t[3],1e-5);const Ai=new ru(_t[0]/_t[3],_t[1]/_t[3],_t[2]/_t[3]);Ft.push(wi),zt.push(Ai)}Mt.push(Ft),bt.push(zt)}return[Mt,bt]}(q,Y,ie,he,ce,le,Te,de,Se):function(Me,Oe,Ue,Ge,Ne){const rt=[],mt=[],it=Ne[8]*Oe,Bt=Ne[9]*Oe,Mt=Ne[10]*Oe,bt=Ne[11]*Oe,_t=Ne[8]*Ue,Ht=Ne[9]*Ue,Ft=Ne[10]*Ue,zt=Ne[11]*Ue;for(const ai of Me){const fi=[],_i=[];for(const gi of ai){const wi=gi.x+Ge.x,Ai=gi.y+Ge.y,er=Ne[0]*wi+Ne[4]*Ai+Ne[12],Yi=Ne[1]*wi+Ne[5]*Ai+Ne[13],ui=Ne[2]*wi+Ne[6]*Ai+Ne[14],Wi=Ne[3]*wi+Ne[7]*Ai+Ne[15],Zi=er+it,ar=Yi+Bt,Cr=ui+Mt,Ur=Math.max(Wi+bt,1e-5),Mr=er+_t,vr=Yi+Ht,Fr=ui+Ft,Hr=Math.max(Wi+zt,1e-5);fi.push(new ru(Zi/Ur,ar/Ur,Cr/Ur)),_i.push(new ru(Mr/Hr,vr/Hr,Fr/Hr))}rt.push(fi),mt.push(_i)}return[rt,mt]}(q,Y,ie,he,ce)}(f,d,I,x,P,g,N,R,C,f.center.lat,u.tileID.canonical),W=u.queryGeometry;return function(H,q,Y){let ie=1/0;ee(Y,q)&&(ie=AT(Y,q[0]));for(let he=0;he<q.length;he++){const ce=q[he],le=H[he];for(let Te=0;Te<ce.length-1;Te++){const de=ce[Te],Se=[de,ce[Te+1],le[Te+1],le[Te],de];Z(Y,Se)&&(ie=Math.min(ie,AT(Y,Se)))}}return ie!==1/0&&ie}(z,G,W.isPointQuery()?W.screenBounds:W.screenGeometry)}},line:class extends Jr{constructor(u,n,l,d){const _=OT();super(u,_,n,l,d),_.layout&&(this.layout=new Il(_.layout)),this.gradientVersion=0,this.hasElevatedBuckets=!1,this.hasNonElevatedBuckets=!1}_handleSpecialPaintPropertyUpdate(u){if(u==="line-gradient"){const n=this._transitionablePaint._values["line-gradient"].value.expression;this.stepInterpolant=n._styleExpression&&n._styleExpression.expression instanceof gl,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}widthExpression(){return this._transitionablePaint._values["line-width"].value.expression}recalculate(u,n){super.recalculate(u,n),this.paint._values["line-floorwidth"]=(()=>{if(ap)return ap;const l=OT();return ap=new vD(l.paint.properties["line-width"].specification),ap.useIntegerZoom=!0,ap})().possiblyEvaluate(this._transitioningPaint._values["line-width"].value,u)}createBucket(u){return new Tv(u)}getProgramIds(){return[this.paint.get("line-pattern").constantOr(1)?"linePattern":"line"]}getDefaultProgramParams(u,n,l){const d=BT(this);return{config:new Ha(this,{zoom:n,lut:l}),defines:d,overrideFog:!1}}queryRadius(u){const n=u,l=FT(at("line-width",this,n),at("line-gap-width",this,n)),d=at("line-offset",this,n);return l/2+Math.abs(d)+nt(this.paint.get("line-translate"))}queryIntersectsFeature(u,n,l,d,_,f){if(u.queryGeometry.isAboveHorizon)return!1;const g=je(u.tilespaceGeometry,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),f.angle,u.pixelToTileUnitsFactor),w=u.pixelToTileUnitsFactor/2*FT(this.paint.get("line-width").evaluate(n,l),this.paint.get("line-gap-width").evaluate(n,l)),S=this.paint.get("line-offset").evaluate(n,l);return S&&(d=function(P,x){const I=[],R=new At(0,0);for(let E=0;E<P.length;E++){const C=P[E],D=[];for(let N=0;N<C.length;N++){const z=C[N],G=C[N+1],W=N===0?R:z.sub(C[N-1])._unit()._perp(),H=N===C.length-1?R:G.sub(z)._unit()._perp(),q=W._add(H)._unit();q._mult(1/(q.x*H.x+q.y*H.y)),D.push(q._mult(x)._add(z))}I.push(D)}return I}(d,S*u.pixelToTileUnitsFactor)),function(P,x,I){for(let R=0;R<x.length;R++){const E=x[R];if(P.length>=3){for(let C=0;C<E.length;C++)if(ye(P,E[C]))return!0}if(ae(P,E,I))return!0}return!1}(g,d,w)}isTileClipped(){return!0}isDraped(u){return!this.hasElevatedBuckets}},symbol:tg,background:class extends Jr{constructor(u,n,l,d){super(u,{layout:y2||(y2=new cr({visibility:new wt(qe.layout_background.visibility)})),paint:v2||(v2=new cr({"background-pitch-alignment":new wt(qe.paint_background["background-pitch-alignment"]),"background-color":new wt(qe.paint_background["background-color"]),"background-pattern":new wt(qe.paint_background["background-pattern"]),"background-opacity":new wt(qe.paint_background["background-opacity"]),"background-emissive-strength":new wt(qe.paint_background["background-emissive-strength"]),"background-color-use-theme":new Nt({type:"string",default:"default","property-type":"data-driven"})}))},n,l,d)}getProgramIds(){return[this.paint.get("background-pattern")?"backgroundPattern":"background"]}getDefaultProgramParams(u,n,l){return{overrideFog:!1}}is3D(){return this.paint.get("background-pitch-alignment")==="viewport"}},raster:T2,"raster-particle":R2,sky:class extends Jr{constructor(u,n,l,d){super(u,{layout:I2||(I2=new cr({visibility:new wt(qe.layout_sky.visibility)})),paint:C2||(C2=new cr({"sky-type":new wt(qe.paint_sky["sky-type"]),"sky-atmosphere-sun":new wt(qe.paint_sky["sky-atmosphere-sun"]),"sky-atmosphere-sun-intensity":new wt(qe.paint_sky["sky-atmosphere-sun-intensity"]),"sky-gradient-center":new wt(qe.paint_sky["sky-gradient-center"]),"sky-gradient-radius":new wt(qe.paint_sky["sky-gradient-radius"]),"sky-gradient":new Cl(qe.paint_sky["sky-gradient"]),"sky-atmosphere-halo-color":new wt(qe.paint_sky["sky-atmosphere-halo-color"]),"sky-atmosphere-color":new wt(qe.paint_sky["sky-atmosphere-color"]),"sky-opacity":new wt(qe.paint_sky["sky-opacity"]),"sky-gradient-use-theme":new Nt({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-halo-color-use-theme":new Nt({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-color-use-theme":new Nt({type:"string",default:"default","property-type":"data-driven"})}))},n,l,d),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(u){u==="sky-gradient"?this._updateColorRamp():u!=="sky-atmosphere-sun"&&u!=="sky-atmosphere-halo-color"&&u!=="sky-atmosphere-color"&&u!=="sky-atmosphere-sun-intensity"||(this._skyboxInvalidated=!0)}_updateColorRamp(){this.colorRamp=Jf({expression:this._transitionablePaint._values["sky-gradient"].value.expression,evaluationKey:"skyRadialProgress"}),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}needsSkyboxCapture(u){if(this._skyboxInvalidated||!this.skyboxTexture||!this.skyboxGeometry)return!0;if(!this.paint.get("sky-atmosphere-sun")){const n=u.style.light.properties.get("position");return this._lightPosition.azimuthal!==n.azimuthal||this._lightPosition.polar!==n.polar}return!1}getCenter(u,n){if(this.paint.get("sky-type")==="atmosphere"){const d=this.paint.get("sky-atmosphere-sun"),_=!d,f=u.style.light,g=f.properties.get("position");return _&&f.properties.get("anchor")==="viewport"&&mi("The sun direction is attached to a light with viewport anchor, lighting may behave unexpectedly."),_?Wv(g.azimuthal,90-g.polar,n):Wv(d[0],90-d[1],n)}const l=this.paint.get("sky-gradient-center");return Wv(l[0],90-l[1],n)}isSky(){return!0}markSkyboxValid(u){this._skyboxInvalidated=!1,this._lightPosition=u.style.light.properties.get("position")}hasOffscreenPass(){return!0}getProgramIds(){const u=this.paint.get("sky-type");return u==="atmosphere"?["skyboxCapture","skybox"]:u==="gradient"?["skyboxGradient"]:null}},slot:class extends Jr{constructor(u,n,l,d){super(u,{paint:M2||(M2=new cr({}))},n,null)}},model:class extends Jr{constructor(u,n,l,d){super(u,{layout:U2||(U2=new cr({visibility:new wt(qe.layout_model.visibility),"model-id":new Nt(qe.layout_model["model-id"])})),paint:V2||(V2=new cr({"model-opacity":new Nt(qe.paint_model["model-opacity"]),"model-rotation":new Nt(qe.paint_model["model-rotation"]),"model-scale":new Nt(qe.paint_model["model-scale"]),"model-translation":new Nt(qe.paint_model["model-translation"]),"model-color":new Nt(qe.paint_model["model-color"]),"model-color-mix-intensity":new Nt(qe.paint_model["model-color-mix-intensity"]),"model-type":new wt(qe.paint_model["model-type"]),"model-cast-shadows":new wt(qe.paint_model["model-cast-shadows"]),"model-receive-shadows":new wt(qe.paint_model["model-receive-shadows"]),"model-ambient-occlusion-intensity":new wt(qe.paint_model["model-ambient-occlusion-intensity"]),"model-emissive-strength":new Nt(qe.paint_model["model-emissive-strength"]),"model-roughness":new Nt(qe.paint_model["model-roughness"]),"model-height-based-emissive-strength-multiplier":new Nt(qe.paint_model["model-height-based-emissive-strength-multiplier"]),"model-cutoff-fade-range":new wt(qe.paint_model["model-cutoff-fade-range"]),"model-front-cutoff":new wt(qe.paint_model["model-front-cutoff"]),"model-color-use-theme":new Nt({type:"string",default:"default","property-type":"data-driven"})}))},n,l,d),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(u){return new Zv(u)}getProgramIds(){return["model"]}is3D(){return!0}hasShadowPass(){return!0}canCastShadows(){return!0}hasLightBeamPass(){return!0}cutoffRange(){return this.paint.get("model-cutoff-fade-range")}queryRadius(u){return u instanceof cg?Rt-1:0}queryIntersectsFeature(u,n,l,d,_,f){if(!this.modelManager)return!1;const g=this.modelManager,w=u.tile.getBucket(this);if(!(w&&w instanceof Zv))return!1;for(const S in w.instancesPerModel){const P=w.instancesPerModel[S],x=n.id!==void 0?n.id:n.properties&&n.properties.hasOwnProperty("id")?n.properties.id:void 0;if(P.idToFeaturesIndex.hasOwnProperty(x)){const I=P.features[P.idToFeaturesIndex[x]],R=g.getModel(S,this.scope);if(!R)return!1;let E=Re.mat4.create();const C=new Li(0,0),D=w.canonical;let N=Number.MAX_VALUE;for(let z=0;z<I.instancedDataCount;++z){const G=16*(I.instancedDataOffset+z),W=P.instancedDataArray.float32,H=[W[G+4],W[G+5],W[G+6]];q2(D,C,W[G],0|W[G+1]),j2(E,R,f,C,I.rotation,I.scale,H,!1,!1,!1),f.projection.name==="globe"&&(E=Xv(E,f));const q=Re.mat4.multiply([],f.projMatrix,E),Y=u.queryGeometry,ie=F2(Y.isPointQuery()?Y.screenBounds:Y.screenGeometry,f,q,R.aabb);ie!=null&&(N=Math.min(ie,N))}return N!==Number.MAX_VALUE&&N}}return!1}_handleOverridablePaintPropertyUpdate(u,n,l){return!(!this.layout||n.isDataDriven()||l.isDataDriven()||u!=="model-color"&&u!=="model-color-mix-intensity"&&u!=="model-rotation"&&u!=="model-scale"&&u!=="model-translation"&&u!=="model-emissive-strength")}_isPropertyZoomDependent(u){const n=this._transitionablePaint._values[u];return n!=null&&n.value!=null&&n.value.expression!=null&&n.value.expression instanceof Oc}isZoomDependent(){return this._isPropertyZoomDependent("model-scale")||this._isPropertyZoomDependent("model-rotation")||this._isPropertyZoomDependent("model-translation")}},clip:class extends Jr{constructor(u,n,l,d){super(u,{layout:VA||(VA=new cr({"clip-layer-types":new wt(qe.layout_clip["clip-layer-types"]),"clip-layer-scope":new wt(qe.layout_clip["clip-layer-scope"])})),paint:jA||(jA=new cr({}))},n,l,d)}recalculate(u,n){super.recalculate(u,n)}createBucket(u){return new HA(u)}isTileClipped(){return!0}is3D(){return!0}}};class yO{constructor(n){this._callback=n,this._triggered=!1,typeof MessageChannel<"u"&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._callback()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout(()=>{this._triggered=!1,this._callback()},0))}remove(){this._channel=void 0,this._callback=()=>{}}}class vO{constructor(){this.tasks={},this.taskQueue=[],sl(["process"],this),this.invoker=new yO(this.process),this.nextId=0}add(n,l){const d=this.nextId++,_=function({type:f,isSymbolTile:g,zoom:w}){return w=w||0,f==="message"?0:f!=="maybePrepare"||g?f!=="parseTile"||g?f==="parseTile"&&g?300-w:f==="maybePrepare"&&g?400-w:500:200-w:100-w}(l);if(_===0){try{n()}finally{}return null}return this.tasks[d]={fn:n,metadata:l,priority:_,id:d},this.taskQueue.push(d),this.invoker.trigger(),{cancel:()=>{delete this.tasks[d]}}}process(){try{if(this.taskQueue=this.taskQueue.filter(d=>!!this.tasks[d]),!this.taskQueue.length)return;const n=this.pick();if(n===null)return;const l=this.tasks[n];if(delete this.tasks[n],this.taskQueue.length&&this.invoker.trigger(),!l)return;l.fn()}finally{}}pick(){let n=null,l=1/0;for(let _=0;_<this.taskQueue.length;_++){const f=this.tasks[this.taskQueue[_]];f.priority<l&&(l=f.priority,n=_)}if(n===null)return null;const d=this.taskQueue[n];return this.taskQueue.splice(n,1),d}remove(){this.invoker.remove()}}class X2{constructor(n,l,d){this.target=n,this.parent=l,this.mapId=d,this.callbacks={},this.cancelCallbacks={},sl(["receive"],this),this.target.addEventListener("message",this.receive,!1),this.scheduler=new vO}send(n,l,d,_,f=!1,g){const w=Math.round(1e18*Math.random()).toString(36).substring(0,10);d&&(d.metadata=g,this.callbacks[w]=d);const S=new Set;return this.target.postMessage({id:w,type:n,hasCallback:!!d,targetMapId:_,mustQueue:f,sourceMapId:this.mapId,data:na(l,S)},S),{cancel:()=>{d&&delete this.callbacks[w],this.target.postMessage({id:w,type:"<cancel>",targetMapId:_,sourceMapId:this.mapId})}}}receive(n){const l=n.data,d=l.id;if(d&&(!l.targetMapId||this.mapId===l.targetMapId))if(l.type==="<cancel>"){const _=this.cancelCallbacks[d];delete this.cancelCallbacks[d],_&&_.cancel()}else if(l.mustQueue||To()){const _=this.callbacks[d],f=this.scheduler.add(()=>this.processTask(d,l),_&&_.metadata||{type:"message"});f&&(this.cancelCallbacks[d]=f)}else this.processTask(d,l)}processTask(n,l){if(delete this.cancelCallbacks[n],l.type==="<response>"){const d=this.callbacks[n];delete this.callbacks[n],d&&(l.error?d(Na(l.error)):d(null,Na(l.data)))}else{const d=new Set,_=l.hasCallback?(g,w)=>{this.target.postMessage({id:n,type:"<response>",sourceMapId:this.mapId,error:g?na(g):null,data:na(w,d)},d)}:()=>{},f=Na(l.data);if(this.parent[l.type])this.parent[l.type](l.sourceMapId,f,_);else if(this.parent.getWorkerSource){const g=l.type.split(".");this.parent.getWorkerSource(l.sourceMapId,g[0],f.source,f.scope)[g[1]](f,_)}else _(new Error(`Could not find function ${l.type}`))}}remove(){this.scheduler.remove(),this.target.removeEventListener("message",this.receive,!1)}}var xp={workerUrl:"",workerClass:null,workerParams:void 0};const Qv="mapboxgl_preloaded_worker_pool";class au{constructor(){this.active={}}acquire(n,l=au.workerCount){if(!this.workers)for(this.workers=[];this.workers.length<l;)this.workers.push(xp.workerClass!=null?new xp.workerClass:new self.Worker(xp.workerUrl,xp.workerParams));return this.active[n]=!0,this.workers.slice()}release(n){delete this.active[n],this.workers&&this.numActive()===0&&(this.workers.forEach(l=>{l.terminate()}),this.workers=null)}isPreloaded(){return!!this.active[Qv]}numActive(){return Object.keys(this.active).length}}au.workerCount=2;class jh{constructor(n,l,d="Worker",_=au.workerCount){this.workerPool=n,this.actors=[],this.currentActor=0,this.id=Aa();const f=this.workerPool.acquire(this.id,_);for(let g=0;g<f.length;g++){const w=new jh.Actor(f[g],l,this.id);w.name=`${d} ${g}`,this.actors.push(w)}this.ready=!1,this.broadcast("checkIfReady",null,()=>{this.ready=!0})}broadcast(n,l,d){Cn(this.actors,(_,f)=>{_.send(n,l,f)},d=d||function(){})}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(){this.actors.forEach(n=>{n.remove()}),this.actors=[],this.workerPool.release(this.id)}}let bp,ex;function ug(){return bp||(bp=new au),bp}jh.Actor=X2;const tx=new Vi(0,0,0);var ix=(u=>(u[u.PATH_RULE_UNSPECIFIED=0]="PATH_RULE_UNSPECIFIED",u[u.PATH_RULE_NON_ZERO=1]="PATH_RULE_NON_ZERO",u[u.PATH_RULE_EVEN_ODD=2]="PATH_RULE_EVEN_ODD",u))(ix||{}),hg=(u=>(u[u.LINE_CAP_UNSPECIFIED=0]="LINE_CAP_UNSPECIFIED",u[u.LINE_CAP_BUTT=1]="LINE_CAP_BUTT",u[u.LINE_CAP_ROUND=2]="LINE_CAP_ROUND",u[u.LINE_CAP_SQUARE=3]="LINE_CAP_SQUARE",u))(hg||{}),wp=(u=>(u[u.LINE_JOIN_UNSPECIFIED=0]="LINE_JOIN_UNSPECIFIED",u[u.LINE_JOIN_MITER=1]="LINE_JOIN_MITER",u[u.LINE_JOIN_MITER_CLIP=2]="LINE_JOIN_MITER_CLIP",u[u.LINE_JOIN_ROUND=3]="LINE_JOIN_ROUND",u[u.LINE_JOIN_BEVEL=4]="LINE_JOIN_BEVEL",u))(wp||{}),Z2=(u=>(u[u.PAINT_ORDER_UNSPECIFIED=0]="PAINT_ORDER_UNSPECIFIED",u[u.PAINT_ORDER_FILL_AND_STROKE=1]="PAINT_ORDER_FILL_AND_STROKE",u[u.PAINT_ORDER_STROKE_AND_FILL=2]="PAINT_ORDER_STROKE_AND_FILL",u))(Z2||{}),Hh=(u=>(u[u.PATH_COMMAND_UNSPECIFIED=0]="PATH_COMMAND_UNSPECIFIED",u[u.PATH_COMMAND_MOVE=1]="PATH_COMMAND_MOVE",u[u.PATH_COMMAND_LINE=2]="PATH_COMMAND_LINE",u[u.PATH_COMMAND_QUAD=3]="PATH_COMMAND_QUAD",u[u.PATH_COMMAND_CUBIC=4]="PATH_COMMAND_CUBIC",u[u.PATH_COMMAND_CLOSE=5]="PATH_COMMAND_CLOSE",u))(Hh||{}),Y2=(u=>(u[u.MASK_TYPE_UNSPECIFIED=0]="MASK_TYPE_UNSPECIFIED",u[u.MASK_TYPE_LUMINANCE=1]="MASK_TYPE_LUMINANCE",u[u.MASK_TYPE_ALPHA=2]="MASK_TYPE_ALPHA",u))(Y2||{});function xO(u,n,l){u===1&&n.icons.push(function(d,_){return function(f){if(f.usvg_tree.height||(f.usvg_tree.height=f.usvg_tree.width),!f.metadata)return f;const{metadata:g}=f;if(g.content_area){const{content_area:w}=g;w.top==null&&(w.top=w.left),w.width==null&&(w.width=f.usvg_tree.width),w.height==null&&(w.height=w.width)}return g.stretch_x&&g.stretch_x.length&&K2(g,"x"),g.stretch_y&&g.stretch_y.length&&K2(g,"y"),f}(d.readFields(bO,{name:void 0},_))}(l,l.readVarint()+l.pos))}function K2(u,n){const l=[],d=u[`stretch_${n}`];let _=null;for(let f=0;f<d.length;f++)_===null?_=l.length===0?d[0]:l[l.length-1][1]+d[f]:(l.push([_,_+d[f]]),_=null);u[`stretch_${n}_areas`]=l}function bO(u,n,l){u===1?n.name=l.readString():u===2?n.metadata=function(d,_){return d.readFields(wO,{stretch_x:null,stretch_y:null,stretch_x_areas:null,stretch_y_areas:null,variables:[]},_)}(l,l.readVarint()+l.pos):u===3&&(n.usvg_tree=function(d,_){return d.readFields(EO,{width:20,children:[],linear_gradients:[],radial_gradients:[],clip_paths:[],masks:[]},_)}(l,l.readVarint()+l.pos),n.data="usvg_tree")}function wO(u,n,l){u===1?n.stretch_x=l.readPackedVarint():u===2?n.stretch_y=l.readPackedVarint():u===3?n.content_area=function(d,_){return d.readFields(AO,{left:0},_)}(l,l.readVarint()+l.pos):u===4&&n.variables.push(function(d,_){return d.readFields(TO,{name:void 0},_)}(l,l.readVarint()+l.pos))}function AO(u,n,l){u===1?n.left=l.readVarint():u===2?n.width=l.readVarint():u===3?n.top=l.readVarint():u===4&&(n.height=l.readVarint())}function TO(u,n,l){u===1?n.name=l.readString():u===2&&(n.rgb_color=pg(l.readVarint()),n.value="rgb_color")}function EO(u,n,l){u===1?n.width=n.height=l.readVarint():u===2?n.height=l.readVarint():u===3?n.children.push(dg(l,l.readVarint()+l.pos)):u===4?n.linear_gradients.push(function(d,_){return d.readFields(BO,{spread_method:1,stops:[],x1:0,y1:0,x2:1,y2:0},_)}(l,l.readVarint()+l.pos)):u===5?n.radial_gradients.push(function(d,_){return d.readFields(OO,{spread_method:1,stops:[],cx:.5,cy:.5,r:.5,fx:.5,fy:.5,fr:0},_)}(l,l.readVarint()+l.pos)):u===7?n.clip_paths.push(function(d,_){return d.readFields(FO,{children:[]},_)}(l,l.readVarint()+l.pos)):u===8&&n.masks.push(function(d,_){const f=d.readFields(kO,{left:0,width:20,mask_type:1,children:[]},_);return f.height==null&&(f.height=f.width),f.top==null&&(f.top=f.left),f}(l,l.readVarint()+l.pos))}function dg(u,n){return u.readFields(SO,{},n)}function SO(u,n,l){u===1?(n.group=function(d,_){return d.readFields(IO,{opacity:255,children:[]},_)}(l,l.readVarint()+l.pos),n.node="group"):u===2&&(n.path=function(d,_){return d.readFields(MO,{paint_order:1,commands:[],step:1,diffs:[],rule:1},_)}(l,l.readVarint()+l.pos),n.node="path")}function IO(u,n,l){u===1?n.transform=fg(l,l.readVarint()+l.pos):u===2?n.opacity=l.readVarint():u===5?n.clip_path_idx=l.readVarint():u===6?n.mask_idx=l.readVarint():u===7&&n.children.push(dg(l,l.readVarint()+l.pos))}function fg(u,n){return u.readFields(CO,{sx:1,ky:0,kx:0,sy:1,tx:0,ty:0},n)}function CO(u,n,l){u===1?n.sx=l.readFloat():u===2?n.ky=l.readFloat():u===3?n.kx=l.readFloat():u===4?n.sy=l.readFloat():u===5?n.tx=l.readFloat():u===6&&(n.ty=l.readFloat())}function MO(u,n,l){u===1?n.fill=function(d,_){return d.readFields(RO,{rgb_color:tx,paint:"rgb_color",opacity:255},_)}(l,l.readVarint()+l.pos):u===2?n.stroke=function(d,_){return d.readFields(PO,{rgb_color:tx,paint:"rgb_color",dasharray:[],dashoffset:0,miterlimit:4,opacity:255,width:1,linecap:1,linejoin:1},_)}(l,l.readVarint()+l.pos):u===3?n.paint_order=l.readVarint():u===5?l.readPackedVarint(n.commands):u===6?n.step=l.readFloat():u===7?l.readPackedSVarint(n.diffs):u===8&&(n.rule=l.readVarint())}function RO(u,n,l){u===1?(n.rgb_color=pg(l.readVarint()),n.paint="rgb_color"):u===2?(n.linear_gradient_idx=l.readVarint(),n.paint="linear_gradient_idx"):u===3?(n.radial_gradient_idx=l.readVarint(),n.paint="radial_gradient_idx"):u===5&&(n.opacity=l.readVarint())}function pg(u){return new Vi((u>>16&255)/255,(u>>8&255)/255,(255&u)/255,1)}function PO(u,n,l){u===1?(n.rgb_color=pg(l.readVarint()),n.paint="rgb_color"):u===2?(n.linear_gradient_idx=l.readVarint(),n.paint="linear_gradient_idx"):u===3?(n.radial_gradient_idx=l.readVarint(),n.paint="radial_gradient_idx"):u===5?l.readPackedFloat(n.dasharray):u===6?n.dashoffset=l.readFloat():u===7?n.miterlimit=l.readFloat():u===8?n.opacity=l.readVarint():u===9?n.width=l.readFloat():u===10?n.linecap=l.readVarint():u===11&&(n.linejoin=l.readVarint())}function BO(u,n,l){u===1?n.transform=fg(l,l.readVarint()+l.pos):u===2?n.spread_method=l.readVarint():u===3?n.stops.push(J2(l,l.readVarint()+l.pos)):u===4?n.x1=l.readFloat():u===5?n.y1=l.readFloat():u===6?n.x2=l.readFloat():u===7&&(n.y2=l.readFloat())}function J2(u,n){return u.readFields(DO,{offset:0,opacity:255,rgb_color:tx},n)}function DO(u,n,l){u===1?n.offset=l.readFloat():u===2?n.opacity=l.readVarint():u===3&&(n.rgb_color=pg(l.readVarint()))}function OO(u,n,l){u===1?n.transform=fg(l,l.readVarint()+l.pos):u===2?n.spread_method=l.readVarint():u===3?n.stops.push(J2(l,l.readVarint()+l.pos)):u===4?n.cx=l.readFloat():u===5?n.cy=l.readFloat():u===6?n.r=l.readFloat():u===7?n.fx=l.readFloat():u===8?n.fy=l.readFloat():u===9&&(n.fr=l.readFloat())}function FO(u,n,l){u===1?n.transform=fg(l,l.readVarint()+l.pos):u===2?n.clip_path_idx=l.readVarint():u===3&&n.children.push(dg(l,l.readVarint()+l.pos))}function kO(u,n,l){u===1?n.left=n.top=l.readFloat():u===2?n.width=n.height=l.readFloat():u===3?n.top=l.readFloat():u===4?n.height=l.readFloat():u===5?n.mask_type=l.readVarint():u===6?n.mask_idx=l.readVarint():u===7&&n.children.push(dg(l,l.readVarint()+l.pos))}class LO{static calculate(n,l){const d=new Map,_=new Map;if(Object.keys(n).length===0)return d;l.forEach(f=>{_.set(f.name,f.rgb_color||new Vi(0,0,0))});for(const[f,g]of Object.entries(n))_.has(f)?d.set(_.get(f).toStringPremultipliedAlpha(),g):console.warn(`Ignoring unknown image variable "${f}"`);return d}}function Gh(u,n=255,l){const d=n/255,_=u.toStringPremultipliedAlpha(),f=l.has(_)?l.get(_).clone():u.clone();return f.a=d,f.toString()}function Ap(u,n){if(!oe()){const l=document.createElement("canvas");return l.width=u,l.height=n,l}return new OffscreenCanvas(u,n)}function NO(u,n){const l=LO.calculate(n.params,u.metadata?u.metadata.variables:[]),d=u.usvg_tree,_=d.width,f=d.height,g=n.transform?n.transform:new DOMMatrix,w=Math.max(1,Math.round(_*g.a)),S=Math.max(1,Math.round(f*g.d)),P=new DOMMatrix([w/_,0,0,S/f,0,0]),x=Ap(w,S).getContext("2d");return rx(x,P,d,d,l),x.getImageData(0,0,w,S)}function rx(u,n,l,d,_){for(const f of d.children)Q2(u,n,l,f,_)}function Q2(u,n,l,d,_){d.group?(u.save(),function(f,g,w,S,P){const x=S.mask_idx!=null?w.masks[S.mask_idx]:null,I=S.clip_path_idx!=null?w.clip_paths[S.clip_path_idx]:null;if(S.transform&&(g=mg(S.transform).preMultiplySelf(g)),!function(C,D,N){return C.opacity!==255||D||N}(S,I!=null,x!=null))return void rx(f,g,w,S,P);const R=Ap(f.canvas.width,f.canvas.height),E=R.getContext("2d");rx(E,g,w,S,P),I&&oE(E,g,w,I),x&&aE(E,g,w,x,P),f.globalAlpha=S.opacity/255,f.drawImage(R,0,0)}(u,n,l,d.group,_),u.restore()):d.path&&(u.save(),function(f,g,w,S,P){const x=lE(S);f.setTransform(g),S.paint_order===Z2.PAINT_ORDER_FILL_AND_STROKE?(eE(f,w,S,x,P),iE(f,w,S,x,P)):(iE(f,w,S,x,P),eE(f,w,S,x,P))}(u,n,l,d.path,_),u.restore())}function eE(u,n,l,d,_){const f=l.fill;if(!f)return;const g=f.opacity/255;switch(f.paint){case"rgb_color":u.fillStyle=Gh(f.rgb_color,f.opacity,_);break;case"linear_gradient_idx":u.fillStyle=rE(u,n.linear_gradients[f.linear_gradient_idx],g,_);break;case"radial_gradient_idx":u.fillStyle=nE(u,n.radial_gradients[f.radial_gradient_idx],g,_)}u.fill(d,tE(l))}function tE(u){return u.rule===ix.PATH_RULE_NON_ZERO?"nonzero":u.rule===ix.PATH_RULE_EVEN_ODD?"evenodd":void 0}function iE(u,n,l,d,_){const f=l.stroke;if(!f)return;u.lineWidth=f.width,u.miterLimit=f.miterlimit,u.setLineDash(f.dasharray),u.lineDashOffset=f.dashoffset;const g=f.opacity/255;switch(f.paint){case"rgb_color":u.strokeStyle=Gh(f.rgb_color,f.opacity,_);break;case"linear_gradient_idx":u.strokeStyle=rE(u,n.linear_gradients[f.linear_gradient_idx],g,_);break;case"radial_gradient_idx":u.strokeStyle=nE(u,n.radial_gradients[f.radial_gradient_idx],g,_)}switch(f.linejoin){case wp.LINE_JOIN_MITER_CLIP:case wp.LINE_JOIN_MITER:u.lineJoin="miter";break;case wp.LINE_JOIN_ROUND:u.lineJoin="round";break;case wp.LINE_JOIN_BEVEL:u.lineJoin="bevel"}switch(f.linecap){case hg.LINE_CAP_BUTT:u.lineCap="butt";break;case hg.LINE_CAP_ROUND:u.lineCap="round";break;case hg.LINE_CAP_SQUARE:u.lineCap="square"}u.stroke(d)}function rE(u,n,l,d){if(n.stops.length===1){const R=n.stops[0];return Gh(R.rgb_color,R.opacity*l,d)}const _=mg(n.transform),{x1:f,y1:g,x2:w,y2:S}=n,P=_.transformPoint(new DOMPoint(f,g)),x=_.transformPoint(new DOMPoint(w,S)),I=u.createLinearGradient(P.x,P.y,x.x,x.y);for(const R of n.stops)I.addColorStop(R.offset,Gh(R.rgb_color,R.opacity*l,d));return I}function nE(u,n,l,d){if(n.stops.length===1){const R=n.stops[0];return Gh(R.rgb_color,R.opacity*l,d)}const _=mg(n.transform),{fx:f,fy:g,cx:w,cy:S}=n,P=_.transformPoint(new DOMPoint(f,g)),x=_.transformPoint(new DOMPoint(w,S)),I=u.createRadialGradient(P.x,P.y,0,x.x,x.y,n.r*((_.a+_.d)/2));for(const R of n.stops)I.addColorStop(R.offset,Gh(R.rgb_color,R.opacity*l,d));return I}function sE(u,n,l,d){const _=d.transform?mg(d.transform).preMultiplySelf(n):n,f=Ap(u.canvas.width,u.canvas.height),g=f.getContext("2d");for(const S of d.children)if(S.group)sE(g,_,l,S.group);else if(S.path){const P=S.path,x=new Path2D;x.addPath(lE(P),_),g.fill(x,tE(P))}const w=d.clip_path_idx!=null?l.clip_paths[d.clip_path_idx]:null;w&&oE(g,_,l,w),u.globalCompositeOperation="source-over",u.drawImage(f,0,0)}function oE(u,n,l,d){const _=Ap(u.canvas.width,u.canvas.height);sE(_.getContext("2d"),n,l,d),u.globalCompositeOperation="destination-in",u.drawImage(_,0,0)}function aE(u,n,l,d,_){if(d.children.length===0)return;const f=d.mask_idx!=null?l.masks[d.mask_idx]:null;f&&aE(u,n,l,f,_);const g=u.canvas.width,w=u.canvas.height,S=Ap(g,w),P=S.getContext("2d"),x=d.width,I=d.height,R=d.left,E=d.top,C=new Path2D,D=new Path2D;D.rect(R,E,x,I),C.addPath(D,n),P.clip(C);for(const G of d.children)Q2(P,n,l,G,_);const N=P.getImageData(0,0,g,w),z=N.data;if(d.mask_type===Y2.MASK_TYPE_LUMINANCE)for(let G=0;G<z.length;G+=4)z[G+3]=z[G+3]/255*(.2126*z[G]+.7152*z[G+1]+.0722*z[G+2]);P.putImageData(N,0,0),u.globalCompositeOperation="destination-in",u.drawImage(S,0,0)}function mg(u){return u?new DOMMatrix([u.sx,u.ky,u.kx,u.sy,u.tx,u.ty]):new DOMMatrix}function lE(u){const n=new Path2D,l=u.step;let d=u.diffs[0]*l,_=u.diffs[1]*l;n.moveTo(d,_);for(let f=0,g=2;f<u.commands.length;f++)switch(u.commands[f]){case Hh.PATH_COMMAND_MOVE:d+=u.diffs[g++]*l,_+=u.diffs[g++]*l,n.moveTo(d,_);break;case Hh.PATH_COMMAND_LINE:d+=u.diffs[g++]*l,_+=u.diffs[g++]*l,n.lineTo(d,_);break;case Hh.PATH_COMMAND_QUAD:{const w=d+u.diffs[g++]*l,S=_+u.diffs[g++]*l;d=w+u.diffs[g++]*l,_=S+u.diffs[g++]*l,n.quadraticCurveTo(w,S,d,_);break}case Hh.PATH_COMMAND_CUBIC:{const w=d+u.diffs[g++]*l,S=_+u.diffs[g++]*l,P=w+u.diffs[g++]*l,x=S+u.diffs[g++]*l;d=P+u.diffs[g++]*l,_=x+u.diffs[g++]*l,n.bezierCurveTo(w,S,P,x,d,_);break}case Hh.PATH_COMMAND_CLOSE:n.closePath()}return n}class nx{constructor(n){this.capacity=n,this.cache=new Map}get(n){if(!this.cache.has(n))return;const l=this.cache.get(n);return this.cache.delete(n),this.cache.set(n,l),l}put(n,l){this.cache.has(n)?this.cache.delete(n):this.cache.size===this.capacity&&this.cache.delete(this.cache.keys().next().value),this.cache.set(n,l)}delete(n){this.cache.delete(n)}}class sx{constructor(){this.cacheMap=new Map,this.cacheDependenciesMap=new Map}static _getImage(n){return new hn(n,n.data)}getFromCache(n,l,d){return this.cacheMap.has(d)||this.cacheMap.set(d,new nx(150)),this.cacheMap.get(d).get(to(n.serialize(),l))}setInCache(n,l,d,_){this.cacheDependenciesMap.has(_)||this.cacheDependenciesMap.set(_,new Map),this.cacheMap.has(_)||this.cacheMap.set(_,new nx(150));const f=this.cacheDependenciesMap.get(_);f.get(to(n.id,d))||f.set(to(n.id,d),new Set);const g=this.cacheMap.get(_),w=n.serialize();f.get(to(n.id,d)).add(w),g.put(to(n.serialize(),d),l)}removeImagesFromCacheByIds(n,l,d=""){if(!this.cacheMap.has(d)||!this.cacheDependenciesMap.has(d))return;const _=this.cacheMap.get(d),f=this.cacheDependenciesMap.get(d);for(const g of n)if(f.has(to(g,l))){for(const w of f.get(to(g,l)))_.delete(w);f.delete(to(g,l))}}rasterize(n,l,d,_,f=NO){const g=this.getFromCache(n,d,_);if(g)return g.clone();const w=f(l.icon,n.options),S=sx._getImage(w);return this.setInCache(n,S,d,_),S.clone()}}class cE{constructor(n){this.size=n,this.minimums=[],this.maximums=[],this.leaves=[]}getElevation(n,l){const d=this.toIdx(n,l);return{min:this.minimums[d],max:this.maximums[d]}}isLeaf(n,l){return this.leaves[this.toIdx(n,l)]}toIdx(n,l){return l*this.size+n}}function uE(u,n,l,d){let _=0,f=Number.MAX_VALUE;for(let g=0;g<3;g++)if(Math.abs(d[g])<1e-15){if(l[g]<u[g]||l[g]>n[g])return null}else{const w=1/d[g];let S=(u[g]-l[g])*w,P=(n[g]-l[g])*w;if(S>P){const x=S;S=P,P=x}if(S>_&&(_=S),P<f&&(f=P),_>f)return null}return _}function hE(u,n,l,d,_,f,g,w,S,P,x){const I=d-u,R=_-n,E=f-l,C=g-u,D=w-n,N=S-l,z=x[1]*N-x[2]*D,G=x[2]*C-x[0]*N,W=x[0]*D-x[1]*C,H=I*z+R*G+E*W;if(Math.abs(H)<1e-15)return null;const q=1/H,Y=P[0]-u,ie=P[1]-n,he=P[2]-l,ce=(Y*z+ie*G+he*W)*q;if(ce<0||ce>1)return null;const le=ie*E-he*R,Te=he*I-Y*E,de=Y*R-ie*I,Se=(x[0]*le+x[1]*Te+x[2]*de)*q;return Se<0||ce+Se>1?null:(C*le+D*Te+N*de)*q}function dE(u,n,l){return(u-n)/(l-n)}function fE(u,n,l,d,_,f,g,w,S){const P=1<<l,x=f-d,I=g-_,R=(u+1)/P*x+d,E=(n+0)/P*I+_,C=(n+1)/P*I+_;w[0]=(u+0)/P*x+d,w[1]=E,S[0]=R,S[1]=C}class pE{constructor(n){if(this.maximums=[],this.minimums=[],this.leaves=[],this.childOffsets=[],this.nodeCount=0,this.dem=n,this._siblingOffset=[[0,0],[1,0],[0,1],[1,1]],!this.dem)return;const l=function(f){const g=Math.ceil(Math.log2(f.dim/8)),w=[];let S=Math.ceil(Math.pow(2,g));const P=1/S,x=(E,C,D,N,z)=>{const G=N?1:0,W=(E+1)*D-G,H=C*D,q=(C+1)*D-G;z[0]=E*D,z[1]=H,z[2]=W,z[3]=q};let I=new cE(S);const R=[];for(let E=0;E<S*S;E++){x(E%S,Math.floor(E/S),P,!1,R);const C=Hl(R[0],R[1],f),D=Hl(R[2],R[1],f),N=Hl(R[2],R[3],f),z=Hl(R[0],R[3],f);I.minimums.push(Math.min(C,D,N,z)),I.maximums.push(Math.max(C,D,N,z)),I.leaves.push(1)}for(w.push(I),S/=2;S>=1;S/=2){const E=w[w.length-1];I=new cE(S);for(let C=0;C<S*S;C++){x(C%S,Math.floor(C/S),2,!0,R);const D=E.getElevation(R[0],R[1]),N=E.getElevation(R[2],R[1]),z=E.getElevation(R[2],R[3]),G=E.getElevation(R[0],R[3]),W=E.isLeaf(R[0],R[1]),H=E.isLeaf(R[2],R[1]),q=E.isLeaf(R[2],R[3]),Y=E.isLeaf(R[0],R[3]),ie=Math.min(D.min,N.min,z.min,G.min),he=Math.max(D.max,N.max,z.max,G.max),ce=W&&H&&q&&Y;I.maximums.push(he),I.minimums.push(ie),I.leaves.push(he-ie<=5&&ce?1:0)}w.push(I)}return w}(this.dem),d=l.length-1,_=l[d];this._addNode(_.minimums[0],_.maximums[0],_.leaves[0]),this._construct(l,0,0,d,0)}raycastRoot(n,l,d,_,f,g,w=1){return uE([n,l,-100],[d,_,this.maximums[0]*w],f,g)}raycast(n,l,d,_,f,g,w=1){if(!this.nodeCount)return null;const S=this.raycastRoot(n,l,d,_,f,g,w);if(S==null)return null;const P=[],x=[],I=[],R=[],E=[{idx:0,t:S,nodex:0,nodey:0,depth:0}];for(;E.length>0;){const{idx:C,t:D,nodex:N,nodey:z,depth:G}=E.pop();if(this.leaves[C]){fE(N,z,G,n,l,d,_,I,R);const H=1<<G,q=(N+0)/H,Y=(N+1)/H,ie=(z+0)/H,he=(z+1)/H,ce=Hl(q,ie,this.dem)*w,le=Hl(Y,ie,this.dem)*w,Te=Hl(Y,he,this.dem)*w,de=Hl(q,he,this.dem)*w,Se=hE(I[0],I[1],ce,R[0],I[1],le,R[0],R[1],Te,f,g),Pe=hE(R[0],R[1],Te,I[0],R[1],de,I[0],I[1],ce,f,g),Me=Math.min(Se!==null?Se:Number.MAX_VALUE,Pe!==null?Pe:Number.MAX_VALUE);if(Me!==Number.MAX_VALUE)return Me;{const Oe=Re.vec3.scaleAndAdd([],f,g,D);if(mE(ce,le,de,Te,dE(Oe[0],I[0],R[0]),dE(Oe[1],I[1],R[1]))>=Oe[2])return D}continue}let W=0;for(let H=0;H<this._siblingOffset.length;H++){fE((N<<1)+this._siblingOffset[H][0],(z<<1)+this._siblingOffset[H][1],G+1,n,l,d,_,I,R),I[2]=-100,R[2]=this.maximums[this.childOffsets[C]+H]*w;const q=uE(I,R,f,g);if(q!=null){const Y=q;P[H]=Y;let ie=!1;for(let he=0;he<W&&!ie;he++)Y>=P[x[he]]&&(x.splice(he,0,H),ie=!0);ie||(x[W]=H),W++}}for(let H=0;H<W;H++){const q=x[H];E.push({idx:this.childOffsets[C]+q,t:P[q],nodex:(N<<1)+this._siblingOffset[q][0],nodey:(z<<1)+this._siblingOffset[q][1],depth:G+1})}}return null}_addNode(n,l,d){return this.minimums.push(n),this.maximums.push(l),this.leaves.push(d),this.childOffsets.push(0),this.nodeCount++}_construct(n,l,d,_,f){if(n[_].isLeaf(l,d)===1)return;this.childOffsets[f]||(this.childOffsets[f]=this.nodeCount);const g=_-1,w=n[g];let S=0,P=0;for(let x=0;x<this._siblingOffset.length;x++){const I=2*l+this._siblingOffset[x][0],R=2*d+this._siblingOffset[x][1],E=w.getElevation(I,R),C=w.isLeaf(I,R),D=this._addNode(E.min,E.max,C);C&&(S|=1<<x),P||(P=D)}for(let x=0;x<this._siblingOffset.length;x++)S&1<<x||this._construct(n,2*l+this._siblingOffset[x][0],2*d+this._siblingOffset[x][1],g,P+x)}}function mE(u,n,l,d,_,f){return ii(ii(u,l,f),ii(n,d,f),_)}function Hl(u,n,l){const d=l.dim,_=yi(u*d-.5,0,d-1),f=yi(n*d-.5,0,d-1),g=Math.floor(_),w=Math.floor(f),S=Math.min(g+1,d-1),P=Math.min(w+1,d-1);return mE(l.get(g,w),l.get(S,w),l.get(g,P),l.get(S,P),_-g,f-w)}const zO={mapbox:[6553.6,25.6,.1,1e4],terrarium:[256,1,1/256,32768]};function UO(u,n,l){return(256*u*256+256*n+l)/10-1e4}function VO(u,n,l){return 256*u+n+l/256-32768}class _g{get tree(){return this._tree||this._buildQuadTree(),this._tree}constructor(n,l,d,_=!1){if(this.uid=n,l.height!==l.width)throw new RangeError("DEM tiles must be square");if(d&&d!=="mapbox"&&d!=="terrarium")return void mi(`"${d}" is not a valid encoding type. Valid types include "mapbox" and "terrarium".`);this.stride=l.height;const f=this.dim=l.height-2,g=new Uint32Array(l.data.buffer);if(this.pixels=new Uint8Array(l.data.buffer),this.floatView=new Float32Array(l.data.buffer),this.borderReady=_,this._modifiedForSources={},!_){for(let S=0;S<f;S++)g[this._idx(-1,S)]=g[this._idx(0,S)],g[this._idx(f,S)]=g[this._idx(f-1,S)],g[this._idx(S,-1)]=g[this._idx(S,0)],g[this._idx(S,f)]=g[this._idx(S,f-1)];g[this._idx(-1,-1)]=g[this._idx(0,0)],g[this._idx(f,-1)]=g[this._idx(f-1,0)],g[this._idx(-1,f)]=g[this._idx(0,f-1)],g[this._idx(f,f)]=g[this._idx(f-1,f-1)]}const w=d==="terrarium"?VO:UO;for(let S=0;S<g.length;++S){const P=4*S;this.floatView[S]=w(this.pixels[P],this.pixels[P+1],this.pixels[P+2])}this._timestamp=xe.now()}_buildQuadTree(){this._tree=new pE(this)}get(n,l,d=!1){d&&(n=yi(n,-1,this.dim),l=yi(l,-1,this.dim));const _=this._idx(n,l);return this.floatView[_]}set(n,l,d){const _=this._idx(n,l),f=this.floatView[_];return this.floatView[_]=d,d-f}static getUnpackVector(n){return zO[n]}_idx(n,l){if(n<-1||n>=this.dim+1||l<-1||l>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(l+1)*this.stride+(n+1)}static pack(n,l){const d=[0,0,0,0],_=_g.getUnpackVector(l);let f=Math.floor((n+_[3])/_[2]);return d[2]=f%256,f=Math.floor(f/256),d[1]=f%256,f=Math.floor(f/256),d[0]=f,d}getPixels(){return new DA({width:this.stride,height:this.stride},this.pixels)}backfillBorder(n,l,d){if(this.dim!==n.dim)throw new Error("dem dimension mismatch");let _=l*this.dim,f=l*this.dim+this.dim,g=d*this.dim,w=d*this.dim+this.dim;switch(l){case-1:_=f-1;break;case 1:f=_+1}switch(d){case-1:g=w-1;break;case 1:w=g+1}const S=-l*this.dim,P=-d*this.dim;for(let x=g;x<w;x++)for(let I=_;I<f;I++){const R=4*this._idx(I,x),E=4*this._idx(I+S,x+P);this.pixels[R+0]=n.pixels[E+0],this.pixels[R+1]=n.pixels[E+1],this.pixels[R+2]=n.pixels[E+2],this.pixels[R+3]=n.pixels[E+3]}}onDeserialize(){this._tree&&(this._tree.dem=this)}}function jO(u,n,l){u===1?n.headerLength=l.readFixed32():u===2?n.x=l.readVarint():u===3?n.y=l.readVarint():u===4?n.z=l.readVarint():u===5&&n.layers.push(function(d,_){return d.readFields(qO,{version:0,name:"",units:"",tileSize:0,buffer:0,pixelFormat:0,dataIndex:[]},_)}(l,l.readVarint()+l.pos))}function HO(u,n,l){u===1?(n.delta_filter=function(d,_){return d.readFields(GO,{blockSize:0},_)}(l,l.readVarint()+l.pos),n.filter="delta_filter"):u===2?(l.readVarint(),n.filter="zigzag_filter"):u===3?(l.readVarint(),n.filter="bitshuffle_filter"):u===4&&(l.readVarint(),n.filter="byteshuffle_filter")}function GO(u,n,l){u===1&&(n.blockSize=l.readVarint())}function $O(u,n,l){u===1?(l.readVarint(),n.codec="gzip_data"):u===2?(l.readVarint(),n.codec="jpeg_image"):u===3?(l.readVarint(),n.codec="webp_image"):u===4&&(l.readVarint(),n.codec="png_image")}function WO(u,n,l){let d=0,_=0;u===1?n.firstByte=l.readFixed64():u===2?n.lastByte=l.readFixed64():u===3?n.filters.push(function(f,g){return f.readFields(HO,{},g)}(l,l.readVarint()+l.pos)):u===4?n.codec=function(f,g){return f.readFields($O,{},g)}(l,l.readVarint()+l.pos):u===5?_=l.readFloat():u===6?d=l.readFloat():u===7?n.bands.push(l.readString()):u===8?n.offset=l.readDouble():u===9&&(n.scale=l.readDouble()),n.offset===0&&(n.offset=_),n.scale===0&&(n.scale=d)}function qO(u,n,l){u===1?n.version=l.readVarint():u===2?n.name=l.readString():u===3?n.units=l.readString():u===4?n.tileSize=l.readVarint():u===5?n.buffer=l.readVarint():u===6?n.pixelFormat=l.readVarint():u===7&&n.dataIndex.push(function(d,_){return d.readFields(WO,{firstByte:0,lastByte:0,filters:[],codec:null,offset:0,scale:0,bands:[]},_)}(l,l.readVarint()+l.pos))}function XO(u,n,l){if(u===2)(function(d,_,f){d.readFields(ZO,f,_)})(l,l.readVarint()+l.pos,n);else if(u===3)throw new Error("Not implemented")}function ZO(u,n,l){if(u===1){let d=0;const _=l.readVarint()+l.pos;for(;l.pos<_;)n[d++]=l.readVarint()}}function YO(u,n){if(n.length!==4)throw new Error(`Expected data of dimension 4 but got ${n.length}.`);let l=n[3];for(let d=2;d>=1;d--){const _=d===1?1:0,f=d===2?1:0;for(let g=0;g<n[0];g++){const w=n[1]*g;for(let S=_;S<n[1];S++){const P=n[2]*(S+w);for(let x=f;x<n[2];x++){const I=n[3]*(x+P);for(let R=0;R<n[3];R++){const E=I+R;u[E]+=u[E-l]}}}}l*=n[d]}return u}function KO(u){for(let n=0,l=u.length;n<l;n++)u[n]=u[n]>>>1^-(1&u[n]);return u}function JO(u,n){switch(n){case"uint32":return u;case"uint16":for(let l=0;l<u.length;l+=2){const d=u[l],_=u[l+1];u[l]=(240&d)>>4|(61440&d)>>8|(240&_)<<4|61440&_,u[l+1]=15&d|(3840&d)>>4|(15&_)<<8|(3840&_)<<4}return u;case"uint8":for(let l=0;l<u.length;l+=4){const d=u[l],_=u[l+1],f=u[l+2],g=u[l+3];u[l+0]=(192&d)>>6|(192&_)>>4|(192&f)>>2|192&g,u[l+1]=(48&d)>>4|(48&_)>>2|48&f|(48&g)<<2,u[l+2]=(12&d)>>2|12&_|(12&f)<<2|(12&g)<<4,u[l+3]=3&d|(3&_)<<2|(3&f)<<4|(3&g)<<6}return u;default:throw new Error(`Invalid pixel format, "${n}"`)}}Vt(_g,"DEMData"),Vt(pE,"DemMinMaxQuadTree",{omit:["dem"]});var Ns=Uint8Array,Tp=Uint16Array,QO=Int32Array,_E=new Ns([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),gE=new Ns([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),eF=new Ns([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),yE=function(u,n){for(var l=new Tp(31),d=0;d<31;++d)l[d]=n+=1<<u[d-1];var _=new QO(l[30]);for(d=1;d<30;++d)for(var f=l[d];f<l[d+1];++f)_[f]=f-l[d]<<5|d;return{b:l,r:_}},vE=yE(_E,2),xE=vE.b,tF=vE.r;xE[28]=258,tF[258]=28;for(var iF=yE(gE,0).b,bE=new Tp(32768),zr=0;zr<32768;++zr){var $h=(43690&zr)>>1|(21845&zr)<<1;bE[zr]=((65280&($h=(61680&($h=(52428&$h)>>2|(13107&$h)<<2))>>4|(3855&$h)<<4))>>8|(255&$h)<<8)>>1}var Ep=function(u,n,l){for(var d=u.length,_=0,f=new Tp(n);_<d;++_)u[_]&&++f[u[_]-1];var g,w=new Tp(n);for(_=1;_<n;++_)w[_]=w[_-1]+f[_-1]<<1;g=new Tp(1<<n);var S=15-n;for(_=0;_<d;++_)if(u[_])for(var P=_<<4|u[_],x=n-u[_],I=w[u[_]-1]++<<x,R=I|(1<<x)-1;I<=R;++I)g[bE[I]>>S]=P;return g},Sp=new Ns(288);for(zr=0;zr<144;++zr)Sp[zr]=8;for(zr=144;zr<256;++zr)Sp[zr]=9;for(zr=256;zr<280;++zr)Sp[zr]=7;for(zr=280;zr<288;++zr)Sp[zr]=8;var wE=new Ns(32);for(zr=0;zr<32;++zr)wE[zr]=5;var rF=Ep(Sp,9),nF=Ep(wE,5),ox=function(u){for(var n=u[0],l=1;l<u.length;++l)u[l]>n&&(n=u[l]);return n},No=function(u,n,l){var d=n/8|0;return(u[d]|u[d+1]<<8)>>(7&n)&l},ax=function(u,n){var l=n/8|0;return(u[l]|u[l+1]<<8|u[l+2]<<16)>>(7&n)},sF=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],zo=function(u,n,l){var d=new Error(n||sF[u]);if(d.code=u,Error.captureStackTrace&&Error.captureStackTrace(d,zo),!l)throw d;return d},oF=new Ns(0),aF=typeof TextDecoder<"u"&&new TextDecoder;try{aF.decode(oF,{stream:!0})}catch{}const lF={gzip_data:"gzip"};class lo extends Error{constructor(n){super(n),this.name="MRTError"}}const cF={0:"uint32",1:"uint32",2:"uint16",3:"uint8"},AE={uint32:1,uint16:2,uint8:4},uF={uint32:Uint32Array,uint16:Uint16Array,uint8:Uint8Array};let lx;class cx{constructor(n=5){this.x=NaN,this.y=NaN,this.z=NaN,this.layers={},this._cacheSize=n}getLayer(n){const l=this.layers[n];if(!l)throw new lo(`Layer '${n}' not found`);return l}getHeaderLength(n){const l=new Uint8Array(n),d=new DataView(n);if(l[0]!==13)throw new lo("File is not a valid MRT.");return d.getUint32(1,!0)}parseHeader(n){const l=new Uint8Array(n),d=this.getHeaderLength(n);if(l.length<d)throw new lo(`Expected header with length >= ${d} but got buffer of length ${l.length}`);const _=function(f,g){return f.readFields(jO,{headerLength:0,x:0,y:0,z:0,layers:[]},void 0)}(new lx(l.subarray(0,d)));if(!isNaN(this.x)&&(this.x!==_.x||this.y!==_.y||this.z!==_.z))throw new lo(`Invalid attempt to parse header ${_.z}/${_.x}/${_.y} for tile ${this.z}/${this.x}/${this.y}`);this.x=_.x,this.y=_.y,this.z=_.z;for(const f of _.layers)this.layers[f.name]=new hF(f,{cacheSize:this._cacheSize});return this}createDecodingTask(n){const l=[],d=this.getLayer(n.layerName);for(let _ of n.blockIndices){const f=d.dataIndex[_],g=f.firstByte-n.firstByte,w=f.lastByte-n.firstByte;if(d._blocksInProgress.has(_))continue;const S={layerName:d.name,firstByte:g,lastByte:w,pixelFormat:d.pixelFormat,blockIndex:_,blockShape:[f.bands.length].concat(d.bandShape),buffer:d.buffer,codec:f.codec.codec,filters:f.filters.map(P=>P.filter)};d._blocksInProgress.add(_),l.push(S)}return new TE(l,()=>{l.forEach(_=>d._blocksInProgress.delete(_.blockIndex))},(_,f)=>{if(l.forEach(g=>d._blocksInProgress.delete(g.blockIndex)),_)throw _;f.forEach(g=>{this.getLayer(g.layerName).processDecodedData(g)})})}}class hF{constructor({version:n,name:l,units:d,tileSize:_,pixelFormat:f,buffer:g,dataIndex:w},S){if(this.version=n,this.version!==1)throw new lo(`Cannot parse raster layer encoded with MRT version ${n}`);this.name=l,this.units=d,this.tileSize=_,this.buffer=g,this.pixelFormat=cF[f],this.dataIndex=w,this.bandShape=[_+2*g,_+2*g,AE[this.pixelFormat]],this._decodedBlocks=new nx(S?S.cacheSize:5),this._blocksInProgress=new Set}get dimension(){return AE[this.pixelFormat]}get cacheSize(){return this._decodedBlocks.capacity}getBandList(){return this.dataIndex.map(({bands:n})=>n).flat()}processDecodedData(n){const l=n.blockIndex.toString();this._decodedBlocks.get(l)||this._decodedBlocks.put(l,n.data)}getBlockForBand(n){let l=0;switch(typeof n){case"string":for(const[d,_]of this.dataIndex.entries()){for(const[f,g]of _.bands.entries())if(g===n)return{bandIndex:l+f,blockIndex:d,blockBandIndex:f};l+=_.bands.length}break;case"number":for(const[d,_]of this.dataIndex.entries()){if(n>=l&&n<l+_.bands.length)return{bandIndex:n,blockIndex:d,blockBandIndex:n-l};l+=_.bands.length}break;default:throw new lo(`Invalid band \`${JSON.stringify(n)}\`. Expected string or integer.`)}throw new lo(`Band not found: ${JSON.stringify(n)}`)}getDataRange(n){let l=1/0,d=-1/0;const _=[],f=new Set;for(const g of n){const{blockIndex:w}=this.getBlockForBand(g);if(w<0)throw new lo(`Invalid band: ${JSON.stringify(g)}`);const S=this.dataIndex[w];_.includes(w)||_.push(w),f.add(w),l=Math.min(l,S.firstByte),d=Math.max(d,S.lastByte)}if(f.size>this.cacheSize)throw new lo(`Number of blocks to decode (${f.size}) exceeds cache size (${this.cacheSize}).`);return{layerName:this.name,firstByte:l,lastByte:d,blockIndices:_}}hasBand(n){const{blockIndex:l}=this.getBlockForBand(n);return l>=0}hasDataForBand(n){const{blockIndex:l}=this.getBlockForBand(n);return l>=0&&!!this._decodedBlocks.get(l.toString())}getBandView(n){const{blockIndex:l,blockBandIndex:d}=this.getBlockForBand(n),_=this._decodedBlocks.get(l.toString());if(!_)throw new lo(`Data for band ${JSON.stringify(n)} of layer "${this.name}" not decoded.`);const f=this.dataIndex[l],g=this.bandShape.reduce((P,x)=>P*x,1),w=d*g,S=_.subarray(w,w+g);return{data:S,bytes:new Uint8Array(S.buffer).subarray(S.byteOffset,S.byteOffset+S.byteLength),tileSize:this.tileSize,buffer:this.buffer,pixelFormat:this.pixelFormat,dimension:this.dimension,offset:f.offset,scale:f.scale}}}cx.setPbf=function(u){lx=u};class TE{constructor(n,l,d){this.tasks=n,this._onCancel=l,this._onComplete=d,this._finalized=!1}cancel(){this._finalized||(this._onCancel(),this._finalized=!0)}complete(n,l){this._finalized||(this._onComplete(n,l),this._finalized=!0)}}cx.performDecoding=function(u,n){const l=new Uint8Array(u);return Promise.all(n.tasks.map(d=>{const{layerName:_,firstByte:f,lastByte:g,pixelFormat:w,blockShape:S,blockIndex:P,filters:x,codec:I}=d,R=l.subarray(f,g+1),E=new Uint32Array(S[0]*S[1]*S[2]);let C;if(I!=="gzip_data")throw new lo(`Unhandled codec: ${I}`);return C=function(D,N){if(!globalThis.DecompressionStream&&N==="gzip_data")return Promise.resolve(((H=function(ie){ie[0]==31&&ie[1]==139&&ie[2]==8||zo(6,"invalid gzip data");var he=ie[3],ce=10;4&he&&(ce+=2+(ie[10]|ie[11]<<8));for(var le=(he>>3&1)+(he>>4&1);le>0;le-=!ie[ce++]);return ce+(2&he)}(W=D))+8>W.length&&zo(6,"invalid gzip data"),function(ie,he,ce,le){var Te=ie.length;if(!Te||he.f&&!he.l)return ce||new Ns(0);var de=!ce,Se=de||he.i!=2,Pe=he.i;de&&(ce=new Ns(3*Te));var Me,Oe,Ue=function(Gl){var uu=ce.length;if(Gl>uu){var Rp=new Ns(Math.max(2*uu,Gl));Rp.set(ce),ce=Rp}},Ge=he.f||0,Ne=he.p||0,rt=he.b||0,mt=he.l,it=he.d,Bt=he.m,Mt=he.n,bt=8*Te;do{if(!mt){Ge=No(ie,Ne,1);var _t=No(ie,Ne+1,3);if(Ne+=3,!_t){var Ht=ie[(ui=4+((Ne+7)/8|0))-4]|ie[ui-3]<<8,Ft=ui+Ht;if(Ft>Te){Pe&&zo(0);break}Se&&Ue(rt+Ht),ce.set(ie.subarray(ui,Ft),rt),he.b=rt+=Ht,he.p=Ne=8*Ft,he.f=Ge;continue}if(_t==1)mt=rF,it=nF,Bt=9,Mt=5;else if(_t==2){var zt=No(ie,Ne,31)+257,ai=No(ie,Ne+10,15)+4,fi=zt+No(ie,Ne+5,31)+1;Ne+=14;for(var _i=new Ns(fi),gi=new Ns(19),wi=0;wi<ai;++wi)gi[eF[wi]]=No(ie,Ne+3*wi,7);Ne+=3*ai;var Ai=ox(gi),er=(1<<Ai)-1,Yi=Ep(gi,Ai);for(wi=0;wi<fi;){var ui,Wi=Yi[No(ie,Ne,er)];if(Ne+=15&Wi,(ui=Wi>>4)<16)_i[wi++]=ui;else{var Zi=0,ar=0;for(ui==16?(ar=3+No(ie,Ne,3),Ne+=2,Zi=_i[wi-1]):ui==17?(ar=3+No(ie,Ne,7),Ne+=3):ui==18&&(ar=11+No(ie,Ne,127),Ne+=7);ar--;)_i[wi++]=Zi}}var Cr=_i.subarray(0,zt),Ur=_i.subarray(zt);Bt=ox(Cr),Mt=ox(Ur),mt=Ep(Cr,Bt),it=Ep(Ur,Mt)}else zo(1);if(Ne>bt){Pe&&zo(0);break}}Se&&Ue(rt+131072);for(var Mr=(1<<Bt)-1,vr=(1<<Mt)-1,Fr=Ne;;Fr=Ne){var Hr=(Zi=mt[ax(ie,Ne)&Mr])>>4;if((Ne+=15&Zi)>bt){Pe&&zo(0);break}if(Zi||zo(2),Hr<256)ce[rt++]=Hr;else{if(Hr==256){Fr=Ne,mt=null;break}var Tn=Hr-254;Hr>264&&(Tn=No(ie,Ne,(1<<(Vo=_E[wi=Hr-257]))-1)+xE[wi],Ne+=Vo);var nr=it[ax(ie,Ne)&vr],ys=nr>>4;if(nr||zo(3),Ne+=15&nr,Ur=iF[ys],ys>3){var Vo=gE[ys];Ur+=ax(ie,Ne)&(1<<Vo)-1,Ne+=Vo}if(Ne>bt){Pe&&zo(0);break}Se&&Ue(rt+131072);var co=rt+Tn;if(rt<Ur){var uo=0-Ur,cu=Math.min(Ur,co);for(uo+rt<0&&zo(3);rt<cu;++rt)ce[rt]=(void 0)[uo+rt]}for(;rt<co;++rt)ce[rt]=ce[rt-Ur]}}he.l=mt,he.p=Fr,he.b=rt,he.f=Ge,mt&&(Ge=1,he.m=Bt,he.d=it,he.n=Mt)}while(!Ge);return rt!=ce.length&&de?(Me=ce,((Oe=rt)==null||Oe>Me.length)&&(Oe=Me.length),new Ns(Me.subarray(0,Oe))):ce.subarray(0,rt)}(W.subarray(H,-8),{i:2},new Ns(((z=W)[(G=z.length)-4]|z[G-3]<<8|z[G-2]<<16|z[G-1]<<24)>>>0))));var z,G,W,H;const q=lF[N];if(!q)throw new Error(`Unhandled codec: ${N}`);const Y=new globalThis.DecompressionStream(q);return new Response(new Blob([D]).stream().pipeThrough(Y)).arrayBuffer().then(ie=>new Uint8Array(ie))}(R,I).then(D=>(function(N,z){N.readFields(XO,z)}(new lx(D),E),new uF[w](E.buffer))),C.then(D=>{for(let N=x.length-1;N>=0;N--)switch(x[N]){case"delta_filter":YO(D,S);break;case"zigzag_filter":KO(D);break;case"bitshuffle_filter":JO(D,w);break;default:throw new lo(`Unhandled filter "${x[N]}"`)}return{layerName:_,blockIndex:P,data:D}}).catch(D=>{throw D})}))},Vt(TE,"MRTDecodingBatch",{omit:["_onCancel","_onComplete"]});let Ip,ux,Uo,Wh,hx,qh=null;function EE(){return To()&&self.worker&&self.worker.dracoUrl?self.worker.dracoUrl:ux||Vr.DRACO_URL}function SE(){if(To()&&self.worker&&self.worker.meshoptUrl)return self.worker.meshoptUrl;if(Wh)return Wh;const u=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]);if(typeof WebAssembly!="object")throw new Error("WebAssembly not supported, cannot instantiate meshoptimizer");return Wh=WebAssembly.validate(u)?Vr.MESHOPT_SIMD_URL:Vr.MESHOPT_URL,Wh}const gg={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},dF={5120:"DT_INT8",5121:"DT_UINT8",5122:"DT_INT16",5123:"DT_UINT16",5125:"DT_UINT32",5126:"DT_FLOAT32"},Cp={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};function IE(u,n,l){const d=l.json.bufferViews.length,_=l.buffers.length;n.bufferView=d,l.json.bufferViews[d]={buffer:_,byteLength:u.byteLength},l.buffers[_]=u}const dx="KHR_draco_mesh_compression";function fF(u,n){const l=u.extensions&&u.extensions[dx];if(!l)return;const d=new Uo.Decoder,_=PE(n,l.bufferView),f=new Uo.Mesh;if(!d.DecodeArrayToMesh(_,_.byteLength,f))throw new Error("Failed to decode Draco mesh");const g=n.json.accessors[u.indices],w=gg[g.componentType],S=g.count*w.BYTES_PER_ELEMENT,P=Uo._malloc(S);w===Uint16Array?d.GetTrianglesUInt16Array(f,S,P):d.GetTrianglesUInt32Array(f,S,P),IE(Uo.memory.buffer.slice(P,P+S),g,n),Uo._free(P);for(const x of Object.keys(l.attributes)){const I=d.GetAttributeByUniqueId(f,l.attributes[x]),R=n.json.accessors[u.attributes[x]],E=dF[R.componentType],C=R.count*Cp[R.type]*gg[R.componentType].BYTES_PER_ELEMENT,D=Uo._malloc(C);d.GetAttributeDataArrayForAllPoints(f,I,Uo[E],C,D),IE(Uo.memory.buffer.slice(D,D+C),R,n),Uo._free(D)}d.destroy(),f.destroy(),delete u.extensions[dx]}const yg="EXT_meshopt_compression";function pF(u,n){if(!u.extensions||!u.extensions[yg])return;const l=u.extensions[yg],d=new Uint8Array(n.buffers[l.buffer],l.byteOffset||0,l.byteLength||0),_=new Uint8Array(l.count*l.byteStride);hx.decodeGltfBuffer(_,l.count,l.byteStride,d,l.mode,l.filter),u.buffer=n.buffers.length,u.byteOffset=0,n.buffers[u.buffer]=_.buffer,delete u.extensions[yg]}const CE=1179937895,ME=new TextDecoder("utf8");function RE(u,n){return new URL(u,n).href}function mF(u,n,l,d){return fetch(RE(u.uri,d)).then(_=>_.arrayBuffer()).then(_=>{n.buffers[l]=_})}function PE(u,n){const l=u.json.bufferViews[n];return new Uint8Array(u.buffers[l.buffer],l.byteOffset||0,l.byteLength)}function _F(u,n,l,d){if(u.uri){const _=RE(u.uri,d);return fetch(_).then(f=>f.blob()).then(f=>createImageBitmap(f)).then(f=>{n.images[l]=f})}if(u.bufferView!==void 0){const _=PE(n,u.bufferView),f=new Blob([_],{type:u.mimeType});return createImageBitmap(f).then(g=>{n.images[l]=g})}}function BE(u,n=0,l){const d={json:null,images:[],buffers:[]};if(new Uint32Array(u,n,1)[0]===CE){const x=new Uint32Array(u,n);let I=2;const R=(x[I++]>>2)-3,E=x[I++]>>2;if(I++,d.json=JSON.parse(ME.decode(x.subarray(I,I+E))),I+=E,I<R){const C=x[I++];I++;const D=n+(I<<2);d.buffers[0]=u.slice(D,D+C)}}else d.json=JSON.parse(ME.decode(new Uint8Array(u,n)));const{buffers:_,images:f,meshes:g,extensionsUsed:w,bufferViews:S}=d.json;let P=Promise.resolve();if(_){const x=[];for(let I=0;I<_.length;I++){const R=_[I];R.uri?x.push(mF(R,d,I,l)):d.buffers[I]||(d.buffers[I]=null)}P=Promise.all(x)}return P.then(()=>{const x=[],I=w&&w.includes(dx),R=w&&w.includes(yg);if(I&&x.push(function(){if(!Uo)return Ip??(Ip=function(E){let C,D=null;function N(){C=new Uint8Array(D.buffer)}function z(){throw new Error("Unexpected Draco error.")}const G={a:{a:z,d:function(W,H,q){return C.copyWithin(W,H,H+q)},c:function(W){const H=C.length,q=Math.max(W>>>0,Math.ceil(1.2*H)),Y=Math.ceil((q-H)/65536);try{return D.grow(Y),N(),!0}catch{return!1}},b:z}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(E,G):E.then(W=>W.arrayBuffer()).then(W=>WebAssembly.instantiate(W,G))).then(W=>{const{Rb:H,Qb:q,P:Y,T:ie,X:he,Ja:ce,La:le,Qa:Te,Va:de,Wa:Se,eb:Pe,jb:Me,f:Oe,e:Ue,yb:Ge,zb:Ne,Ab:rt,Bb:mt,Db:it,Gb:Bt}=W.instance.exports;D=Ue;const Mt=(()=>{let bt=0,_t=0,Ht=0,Ft=0;return zt=>{Ht&&(H(Ft),H(bt),_t+=Ht,Ht=bt=0),bt||(_t+=128,bt=q(_t));const ai=zt.length+7&-8;let fi=bt;ai>=_t&&(Ht=ai,fi=Ft=q(ai));for(let _i=0;_i<zt.length;_i++)C[fi+_i]=zt[_i];return fi}})();return N(),Oe(),{memory:Ue,_free:H,_malloc:q,Mesh:class{constructor(){this.ptr=Y()}destroy(){ie(this.ptr)}},Decoder:class{constructor(){this.ptr=ce()}destroy(){Me(this.ptr)}DecodeArrayToMesh(bt,_t,Ht){const Ft=Mt(bt),zt=le(this.ptr,Ft,_t,Ht.ptr);return!!he(zt)}GetAttributeByUniqueId(bt,_t){return{ptr:Te(this.ptr,bt.ptr,_t)}}GetTrianglesUInt16Array(bt,_t,Ht){de(this.ptr,bt.ptr,_t,Ht)}GetTrianglesUInt32Array(bt,_t,Ht){Se(this.ptr,bt.ptr,_t,Ht)}GetAttributeDataArrayForAllPoints(bt,_t,Ht,Ft,zt){Pe(this.ptr,bt.ptr,_t.ptr,Ht,Ft,zt)}},DT_INT8:Ge(),DT_UINT8:Ne(),DT_INT16:rt(),DT_UINT16:mt(),DT_UINT32:it(),DT_FLOAT32:Bt()}})}(fetch(EE())),Ip.then(E=>{Uo=E,Ip=void 0}))}()),R&&x.push(function(){if(hx)return;const E=function(C){let D;const N=WebAssembly.instantiateStreaming(C,{}).then(W=>{D=W.instance,D.exports.__wasm_call_ctors()}),z={NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},G={ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"};return{ready:N,supported:!0,decodeGltfBuffer(W,H,q,Y,ie,he){(function(ce,le,Te,de,Se,Pe,Me){const Oe=ce.exports.sbrk,Ue=de+3&-4,Ge=Oe(Ue*Se),Ne=Oe(Pe.length),rt=new Uint8Array(ce.exports.memory.buffer);rt.set(Pe,Ne);const mt=le(Ge,de,Se,Ne,Pe.length);if(mt===0&&Me&&Me(Ge,Ue,Se),Te.set(rt.subarray(Ge,Ge+de*Se)),Oe(Ge-Oe(0)),mt!==0)throw new Error(`Malformed buffer data: ${mt}`)})(D,D.exports[G[ie]],W,H,q,Y,D.exports[z[he]])}}}(fetch(SE()));return E.ready.then(()=>{hx=E})}()),f)for(let E=0;E<f.length;E++)x.push(_F(f[E],d,E,l));return(x.length?Promise.all(x):Promise.resolve()).then(()=>{if(I&&g)for(const{primitives:E}of g)for(const C of E)fF(C,d);if(R&&g&&S)for(const E of S)pF(E,d);return d})})}function lu(u,n){const l=u.json.bufferViews[n.bufferView],d=gg[n.componentType];return new d(u.buffers[l.buffer],(n.byteOffset||0)+(l.byteOffset||0),n.count*(l.byteStride&&l.byteStride!==Cp[n.type]*d.BYTES_PER_ELEMENT?l.byteStride/d.BYTES_PER_ELEMENT:Cp[n.type]))}function fx(u,n,l,d){const _=gg[n.componentType],f=function(x){switch(x){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:return 1}}(_),g=u.json.bufferViews[n.bufferView],w=g.byteStride?g.byteStride/_.BYTES_PER_ELEMENT:Cp[n.type],S=l.float32,P=S.length/l.capacity;for(let x=0,I=0;x<n.count*w;x+=w,I+=P)for(let R=0;R<P;R++)S[I+R]=d[x+R]*f;l._trim()}function gF(u,n,l){const d=u.indices,_=u.attributes,f={};f.indexArray=new on;const g=n.json.accessors[d],w=g.count/3;f.indexArray.reserve(w);const S=lu(n,g);for(let R=0;R<w;R++)f.indexArray.emplaceBack(S[3*R],S[3*R+1],S[3*R+2]);f.indexArray._trim(),f.vertexArray=new io;const P=n.json.accessors[_.POSITION];f.vertexArray.reserve(P.count);const x=lu(n,P);for(let R=0;R<P.count;R++)f.vertexArray.emplaceBack(x[3*R],x[3*R+1],x[3*R+2]);if(f.vertexArray._trim(),f.aabb=new Wt(P.min,P.max),f.centroid=function(R,E){const C=[0,0,0],D=R.length;if(D>0){for(let N=0;N<D;N++){const z=3*R[N];C[0]+=E[z],C[1]+=E[z+1],C[2]+=E[z+2]}C[0]/=D,C[1]/=D,C[2]/=D}return C}(S,x),_.COLOR_0!==void 0){const R=n.json.accessors[_.COLOR_0],E=Cp[R.type],C=lu(n,R);f.colorArray=E===3?new io:new Ua,f.colorArray.resize(R.count),fx(n,R,f.colorArray,C)}if(_.NORMAL!==void 0){f.normalArray=new io;const R=n.json.accessors[_.NORMAL];f.normalArray.resize(R.count);const E=lu(n,R);fx(n,R,f.normalArray,E)}if(_.TEXCOORD_0!==void 0&&l.length>0){f.texcoordArray=new Pl;const R=n.json.accessors[_.TEXCOORD_0];f.texcoordArray.resize(R.count);const E=lu(n,R);fx(n,R,f.texcoordArray,E)}if(_._FEATURE_ID_RGBA4444!==void 0){const R=n.json.accessors[_._FEATURE_ID_RGBA4444];n.json.extensionsUsed&&n.json.extensionsUsed.includes("EXT_meshopt_compression")&&(f.featureData=lu(n,R))}_._FEATURE_RGBA4444!==void 0&&(f.featureData=new Uint32Array(lu(n,n.json.accessors[_._FEATURE_RGBA4444]).buffer));const I=u.material;return f.material=function(R,E){const{emissiveFactor:C=[0,0,0],alphaMode:D="OPAQUE",alphaCutoff:N=.5,normalTexture:z,occlusionTexture:G,emissiveTexture:W,doubleSided:H}=R,{baseColorFactor:q=[1,1,1,1],metallicFactor:Y=1,roughnessFactor:ie=1,baseColorTexture:he,metallicRoughnessTexture:ce}=R.pbrMetallicRoughness||{},le=G?E[G.index]:void 0;if(G&&G.extensions&&G.extensions.KHR_texture_transform&&le){const Te=G.extensions.KHR_texture_transform;le.offsetScale=[Te.offset[0],Te.offset[1],Te.scale[0],Te.scale[1]]}return{pbrMetallicRoughness:{baseColorFactor:new Vi(...q),metallicFactor:Y,roughnessFactor:ie,baseColorTexture:he?E[he.index]:void 0,metallicRoughnessTexture:ce?E[ce.index]:void 0},doubleSided:H,emissiveFactor:C,alphaMode:D,alphaCutoff:N,normalTexture:z?E[z.index]:void 0,occlusionTexture:le,emissionTexture:W?E[W.index]:void 0,defined:R.defined===void 0}}(I!==void 0?n.json.materials[I]:{defined:!1},l),f}function DE(u,n,l){const{matrix:d,rotation:_,translation:f,scale:g,mesh:w,extras:S,children:P}=u,x={};if(x.matrix=d||Re.mat4.fromRotationTranslationScale([],_||[0,0,0,1],f||[0,0,0],g||[1,1,1]),w!==void 0){x.meshes=l[w];const I=x.anchor=[0,0];for(const R of x.meshes){const{min:E,max:C}=R.aabb;I[0]+=E[0]+C[0],I[1]+=E[1]+C[1]}I[0]=Math.floor(I[0]/x.meshes.length/2),I[1]=Math.floor(I[1]/x.meshes.length/2)}if(S&&(S.id&&(x.id=S.id),S.lights&&(x.lights=function(I){if(!I.length)return[];const R=function(z){const G=atob(z),W=new Uint8Array(G.length);for(let H=0;H<G.length;H++)W[H]=G.codePointAt(H);return W}(I),E=[],C=R.length/24,D=new Uint16Array(R.buffer),N=new Float32Array(R.buffer);for(let z=0;z<C;z++){const G=D[2*z*6]/30,W=D[2*z*6+1]/30,H=D[2*z*6+10]/100,q=N[6*z+1],Y=N[6*z+2],ie=N[6*z+3],he=N[6*z+4],ce=ie-q,le=he-Y,Te=Math.hypot(ce,le);E.push({pos:[q+.5*ce,Y+.5*le,W],normal:[le/Te,-ce/Te,0],width:Te,height:G,depth:H,points:[q,Y,ie,he]})}return E}(S.lights))),P){const I=[];for(const R of P)I.push(DE(n.json.nodes[R],n,l));x.children=I}return x}function yF(u){if(u.vertices.length===0||u.indices.length===0)return null;const n=new mv(u.vertices,u.indices,8,256),[l,d]=[n.min.clone(),n.max.clone()];return{vertices:u.vertices,indices:u.indices,grid:n,min:l,max:d}}function vF(u){if(!u.extras||!u.extras.ground)return null;const n=u.extras.ground;if(!n||!Array.isArray(n)||n.length===0)return null;const l=n[0];if(!l||!Array.isArray(l)||l.length===0)return null;const d=[];for(const g of l){if(!Array.isArray(g)||g.length!==2)continue;const w=g[0],S=g[1];typeof w=="number"&&typeof S=="number"&&d.push(new At(w,S))}if(d.length<3)return null;d.length>1&&d[d.length-1].equals(d[0])&&d.pop();let _=0;for(let g=0;g<d.length;g++){const w=d[g],S=d[(g+1)%d.length],P=d[(g+2)%d.length];_+=(w.x-S.x)*(P.y-S.y)-(P.x-S.x)*(w.y-S.y)}_>0&&d.reverse();const f=Qf(d.flatMap(g=>[g.x,g.y]),[]);return f.length===0?null:{vertices:d,indices:f}}function xF(u,n){const l=[],d=[];let _=0;const f=[];for(const g of u){_=l.length;const w=g.vertexArray.float32,S=g.indexArray.uint16;for(let P=0;P<g.vertexArray.length;P++)f[0]=w[3*P+0],f[1]=w[3*P+1],f[2]=w[3*P+2],Re.vec3.transformMat4(f,f,n),l.push(new At(f[0],f[1]));for(let P=0;P<3*g.indexArray.length;P++)d.push(S[P]+_)}if(d.length%3!=0)return null;for(let g=0;g<d.length;g+=3){const w=l[d[g+0]],S=l[d[g+1]],P=l[d[g+2]];(w.x-S.x)*(P.y-S.y)-(P.x-S.x)*(w.y-S.y)>0&&([d[g+1],d[g+2]]=[d[g+2],d[g+1]])}return{vertices:l,indices:d}}function OE(u){const n=function(S,P){const x=[],I=WebGL2RenderingContext;if(S.json.textures)for(const R of S.json.textures){const E={magFilter:I.LINEAR,minFilter:I.NEAREST,wrapS:I.REPEAT,wrapT:I.REPEAT};R.sampler!==void 0&&Object.assign(E,S.json.samplers[R.sampler]),x.push({image:P[R.source],sampler:E,uploaded:!1})}return x}(u,u.images),l=function(S,P){const x=[];for(const I of S.json.meshes){const R=[];for(const E of I.primitives)R.push(gF(E,S,P));x.push(R)}return x}(u,n),{scenes:d,scene:_,nodes:f}=u.json,g=d?d[_||0].nodes:f,w=[];for(const S of g)w.push(DE(f[S],u,l));return function(S,P,x){const I={},R=new Set;for(let E=0;E<S.length;E++){const C=x[P[E]];if(!C.extras)continue;const D=C.extras["mapbox:footprint:version"],N=C.extras["mapbox:footprint:id"];(D||N)&&R.add(E),D==="1.0.0"&&N&&(I[N]=E)}for(let E=0;E<S.length;E++){if(R.has(E))continue;const C=S[E],D=x[P[E]];if(!D.extras)continue;let N=null;C.id in I&&(N=xF(S[I[C.id]].meshes,C.matrix)),N||(N=vF(D)),N&&(C.footprint=yF(N))}if(R.size>0){const E=Array.from(R.values()).sort((C,D)=>C-D);for(let C=E.length-1;C>=0;C--)S.splice(E[C],1)}}(w,g,u.json.nodes),w}function bF(u){u.heightmap=new Float32Array(4096),u.heightmap.fill(-1);const n=u.vertexArray.float32,l=u.aabb.min[0]-1,d=u.aabb.min[1]-1,_=su/(u.aabb.max[0]-l+2),f=su/(u.aabb.max[1]-d+2);for(let g=0;g<n.length;g+=3){const w=n[g+2],S=(n[g+0]-l)*_|0,P=(n[g+1]-d)*f|0;w>u.heightmap[P*su+S]&&(u.heightmap[P*su+S]=w)}}function wF(u,n){const l={};l.indexArray=new on,l.indexArray.reserve(4*u.length),l.vertexArray=new io,l.vertexArray.reserve(10*u.length),l.colorArray=new Ua,l.vertexArray.reserve(10*u.length);let d=0;for(const g of u){const w=Math.min(10,Math.max(4,1.3*g.height))*n,S=[-g.normal[1],g.normal[0],0],P=Math.min(.29,.1*g.width/g.depth),x=g.width-2*g.depth*n*(P+.01),I=Re.vec3.scaleAndAdd([],g.pos,S,x/2),R=Re.vec3.scaleAndAdd([],g.pos,S,-x/2),E=[I[0],I[1],I[2]+g.height],C=[R[0],R[1],R[2]+g.height],D=Re.vec3.scaleAndAdd([],g.normal,S,P);Re.vec3.scale(D,D,w);const N=Re.vec3.scaleAndAdd([],g.normal,S,-P);Re.vec3.scale(N,N,w),Re.vec3.add(D,I,D),Re.vec3.add(N,R,N),I[2]+=.1,R[2]+=.1,l.vertexArray.emplaceBack(D[0],D[1],D[2]),l.vertexArray.emplaceBack(N[0],N[1],N[2]),l.vertexArray.emplaceBack(I[0],I[1],I[2]),l.vertexArray.emplaceBack(R[0],R[1],R[2]),l.vertexArray.emplaceBack(E[0],E[1],E[2]),l.vertexArray.emplaceBack(C[0],C[1],C[2]),l.vertexArray.emplaceBack(I[0],I[1],I[2]),l.vertexArray.emplaceBack(R[0],R[1],R[2]),l.vertexArray.emplaceBack(D[0],D[1],D[2]),l.vertexArray.emplaceBack(N[0],N[1],N[2]);const z=x/w/2;l.colorArray.emplaceBack(-z-P,-1,z,.8),l.colorArray.emplaceBack(z+P,-1,z,.8),l.colorArray.emplaceBack(-z,0,z,1.3),l.colorArray.emplaceBack(z,0,z,1.3),l.colorArray.emplaceBack(z+P,-.8,z,.7),l.colorArray.emplaceBack(z+P,-.8,z,.7),l.colorArray.emplaceBack(0,0,z,1.3),l.colorArray.emplaceBack(0,0,z,1.3),l.colorArray.emplaceBack(z+P,-1.2,z,.8),l.colorArray.emplaceBack(z+P,-1.2,z,.8),l.indexArray.emplaceBack(6+d,4+d,8+d),l.indexArray.emplaceBack(7+d,9+d,5+d),l.indexArray.emplaceBack(0+d,1+d,2+d),l.indexArray.emplaceBack(1+d,3+d,2+d),d+=10}const _={defined:!0,emissiveFactor:[0,0,0]},f={};return f.baseColorFactor=Vi.white,_.pbrMetallicRoughness=f,l.material=_,l.aabb=new Wt([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),l}class FE{constructor(n){this._stringToNumber={},this._numberToString=[];for(let l=0;l<n.length;l++){const d=n[l];this._stringToNumber[d]=l,this._numberToString[l]=d}}encode(n){return this._stringToNumber[n]}decode(n){return this._numberToString[n]}}const AF=["id","tile","layer","source","sourceLayer","state"];class Xh{constructor(n,l,d,_,f){this.type="Feature",this._vectorTileFeature=n,this._z=l,this._x=d,this._y=_,this.properties=n.properties,this.id=f}clone(){const n=new Xh(this._vectorTileFeature,this._z,this._x,this._y,this.id);return this.state&&(n.state=Object.assign({},this.state)),this.layer&&(n.layer=Object.assign({},this.layer)),this.source&&(n.source=this.source),this.sourceLayer&&(n.sourceLayer=this.sourceLayer),n}get geometry(){return this._geometry===void 0&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._x,this._y,this._z).geometry),this._geometry}set geometry(n){this._geometry=n}toJSON(){const n={type:"Feature",state:void 0,geometry:this.geometry,properties:this.properties};for(const l of AF)this[l]!==void 0&&(n[l]=this[l]);return n}}class kE{constructor(n,l){this.tileID=n,this.x=n.canonical.x,this.y=n.canonical.y,this.z=n.canonical.z,this.grid=new La(Rt,16,0),this.featureIndexArray=new Zc,this.promoteId=l,this.is3DTile=!1,this.serializedLayersCache=new Map}insert(n,l,d,_,f,g=0,w=0){const S=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(d,_,f,g);const P=this.grid;for(let x=0;x<l.length;x++){const I=l[x],R=[1/0,1/0,-1/0,-1/0];for(let E=0;E<I.length;E++){const C=I[E];R[0]=Math.min(R[0],C.x),R[1]=Math.min(R[1],C.y),R[2]=Math.max(R[2],C.x),R[3]=Math.max(R[3],C.y)}w!==0&&(R[0]-=w,R[1]-=w,R[2]+=w,R[3]+=w),R[0]<Rt&&R[1]<Rt&&R[2]>=0&&R[3]>=0&&P.insert(S,R[0],R[1],R[2],R[3])}}loadVTLayers(){if(!this.vtLayers){this.vtLayers=new Oh.VectorTile(new V_(this.rawTileData)).layers,this.sourceLayerCoder=new FE(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"]),this.vtFeatures={};for(const n in this.vtLayers)this.vtFeatures[n]=[]}return this.vtLayers}query(n,l){const{tilespaceGeometry:d,transform:_,tileTransform:f,pixelPosMatrix:g,availableImages:w}=l;this.loadVTLayers(),this.serializedLayersCache.clear();const S=d.bufferedTilespaceBounds,P=this.grid.query(S.min.x,S.min.y,S.max.x,S.max.y,(E,C,D,N)=>Ie(d.bufferedTilespaceGeometry,E,C,D,N));P.sort(TF);let x=null;_.elevation&&P.length>0&&(x=Vh.create(_.elevation,this.tileID));const I={};let R;for(let E=0;E<P.length;E++){const C=P[E];if(C===R)continue;R=C;const D=this.featureIndexArray.get(C);let N=null;this.is3DTile?this.loadMatchingModelFeature(I,D,n,d,_):this.loadMatchingFeature(I,D,n,w,(z,G,W,H=0)=>(N||(N=L(z,this.tileID.canonical,f)),G.queryIntersectsFeature(d,z,W,N,this.z,_,g,x,H)))}return I}loadMatchingFeature(n,l,d,_,f){const{featureIndex:g,bucketIndex:w,sourceLayerIndex:S,layoutVertexArrayOffset:P}=l,x=this.bucketLayerIDs[w],I=d.layers,R=Object.keys(I);if(R.length&&!function(z,G){for(let W=0;W<z.length;W++)if(G.indexOf(z[W])>=0)return!0;return!1}(R,x))return;const E=d.sourceCache,C=this.sourceLayerCoder.decode(S),D=this.vtLayers[C].feature(g),N=this.getId(D,C);for(let z=0;z<x.length;z++){const G=x[z];if(!I[G])continue;const{styleLayer:W,targets:H}=I[G];let q={};N!==void 0&&(q=E.getFeatureState(W.sourceLayer,N));const Y=!f||f(D,W,q,P);if(!Y)continue;const ie=new Xh(D,this.z,this.x,this.y,N);ie.tile=this.tileID.canonical,ie.state=q;let he=this.serializedLayersCache.get(G);he||(he=W.serialize(),he.id=G,this.serializedLayersCache.set(G,he)),ie.source=he.source,ie.sourceLayer=he["source-layer"],ie.layer=Mn({},he),ie.layer.paint=LE(he.paint,W.paint,D,q,_),ie.layer.layout=LE(he.layout,W.layout,D,q,_);let ce=!1;for(const le of H){this.updateFeatureProperties(ie,le);const{filter:Te}=le;if(Te){if(D.properties=ie.properties,Te.needGeometry){const de=U(D,!0);if(!Te.filter(new tr(this.tileID.overscaledZ),de,this.tileID.canonical))continue}else if(!Te.filter(new tr(this.tileID.overscaledZ),D))continue}ce=!0,le.targetId&&this.addFeatureVariant(ie,le)}ce&&this.appendToResult(n,G,g,ie,Y)}}loadMatchingModelFeature(n,l,d,_,f){const g=this.bucketLayerIDs[0][0],w=d.layers;if(!w[g])return;const{styleLayer:S,targets:P}=w[g];if(S.type!=="model")return;const x=_.tile,I=l.featureIndex,R=x.getBucket(S);if(!(R&&R instanceof cg))return;const E=function(he,ce,le,Te){const de=he.getNodesInfo()[ce];if(de.hiddenByReplacement||!de.node.meshes)return;let Se=Number.MAX_VALUE;const Pe=de.node,Me=le.tile,Oe=Te.calculatePosMatrix(Me.tileID.toUnwrapped(),Te.worldSize),Ue=de.evaluatedScale;let Ge=0;Te.elevation&&Pe.elevation&&(Ge=Pe.elevation*Te.elevation.exaggeration()),Re.mat4.translate(Oe,Oe,[(Pe.anchor?Pe.anchor[0]:0)*(Ue[0]-1),(Pe.anchor?Pe.anchor[1]:0)*(Ue[1]-1),Ge]),Re.mat4.scale(Oe,Oe,Ue);const Ne=le.queryGeometry,rt=Ne.isPointQuery()?Ne.screenBounds:Ne.screenGeometry,mt=function(Bt){const Mt=Re.mat4.multiply([],Oe,Bt.matrix);Re.mat4.multiply(Mt,Te.expandedFarZProjMatrix,Mt);for(let bt=0;bt<Bt.meshes.length;++bt){const _t=Bt.meshes[bt];if(bt===Bt.lightMeshIndex)continue;const Ht=F2(rt,Te,Mt,_t.aabb);Ht!=null&&(Se=Math.min(Ht,Se))}if(Bt.children)for(const bt of Bt.children)mt(bt)};if(mt(Pe),Se===Number.MAX_VALUE)return;const it=new Li(0,0);return q2(Me.tileID.canonical,it,de.node.anchor[0],de.node.anchor[1]),{intersectionZ:Se,position:it,feature:de.feature}}(R,I,_,f);if(!E)return;const{z:C,x:D,y:N}=x.tileID.canonical,{feature:z,intersectionZ:G,position:W}=E;let H={};z.id!==void 0&&(H=d.sourceCache.getFeatureState(S.sourceLayer,z.id));const q=new Xh({},C,D,N,z.id);q.tile=this.tileID.canonical,q.state=H,q.properties=z.properties,q.geometry={type:"Point",coordinates:[W.lng,W.lat]};let Y=this.serializedLayersCache.get(g);Y||(Y=S.serialize(),Y.id=g,this.serializedLayersCache.set(g,Y)),q.source=Y.source,q.sourceLayer=Y["source-layer"],q.layer=Mn({},Y);let ie=!1;for(const he of P){this.updateFeatureProperties(q,he);const{filter:ce}=he;if(ce){if(z.properties=q.properties,ce.needGeometry){if(!ce.filter(new tr(this.tileID.overscaledZ),z,this.tileID.canonical))continue}else if(!ce.filter(new tr(this.tileID.overscaledZ),z))continue}ie=!0,he.targetId&&this.addFeatureVariant(q,he)}ie&&this.appendToResult(n,g,I,q,G)}updateFeatureProperties(n,l,d){if(l.properties){const _={};for(const f in l.properties){const g=l.properties[f].evaluate({zoom:this.z},n._vectorTileFeature,n.state,n.tile,d);g!=null&&(_[f]=g)}n.properties=_}}addFeatureVariant(n,l,d){const _={target:l.target,namespace:l.namespace,uniqueFeatureID:l.uniqueFeatureID};l.properties&&(_.properties=n.properties),n.variants=n.variants||{},n.variants[l.targetId]=n.variants[l.targetId]||[],n.variants[l.targetId].push(_)}appendToResult(n,l,d,_,f){let g=n[l];g===void 0&&(g=n[l]=[]),g.push({featureIndex:d,feature:_,intersectionZ:f})}lookupSymbolFeatures(n,l,d,_,f){const g={};this.loadVTLayers();for(const w of n)this.loadMatchingFeature(g,{bucketIndex:l,sourceLayerIndex:d,featureIndex:w,layoutVertexArrayOffset:0},_,f);return g}loadFeature(n){const{featureIndex:l,sourceLayerIndex:d}=n;this.loadVTLayers();const _=this.sourceLayerCoder.decode(d),f=this.vtFeatures[_];if(f[l])return f[l];const g=this.vtLayers[_].feature(l);return f[l]=g,g}hasLayer(n){for(const l of this.bucketLayerIDs)for(const d of l)if(n===d)return!0;return!1}getId(n,l){let d=n.id;if(this.promoteId){const _=Array.isArray(this.promoteId)||typeof this.promoteId!="object"?this.promoteId:this.promoteId[l];if(_!=null)if(Array.isArray(_)){if(!this.promoteIdExpression){const f=Al(_);if(f.result!=="success"){const g=f.value.map(w=>`${w.key}: ${w.message}`).join(", ");return void mi(`Failed to create expression for promoteId: ${g}`)}this.promoteIdExpression=f.value}this.promoteIdExpression._evaluator||(this.promoteIdExpression._evaluator=new jd),d=this.promoteIdExpression.evaluate({zoom:0},n)}else d=n.properties[_];typeof d=="boolean"&&(d=Number(d))}return d}}function LE(u,n,l,d,_){return ol(u,(f,g)=>{const w=n instanceof Il?n.get(g):null;return w&&w.evaluate?w.evaluate(l,d,_):w})}function TF(u,n){return n-u}Vt(kE,"FeatureIndex",{omit:["rawTileData","sourceLayerCoder"]});const NE=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class px{static from(n){if(!(n instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[l,d]=new Uint8Array(n,0,2);if(l!==219)throw new Error("Data does not appear to be in a KDBush format.");const _=d>>4;if(_!==1)throw new Error(`Got v${_} data when expected v1.`);const f=NE[15&d];if(!f)throw new Error("Unrecognized array type.");const[g]=new Uint16Array(n,2,1),[w]=new Uint32Array(n,4,1);return new px(w,g,f,n)}constructor(n,l=64,d=Float64Array,_){if(isNaN(n)||n<0)throw new Error(`Unpexpected numItems value: ${n}.`);this.numItems=+n,this.nodeSize=Math.min(Math.max(+l,2),65535),this.ArrayType=d,this.IndexArrayType=n<65536?Uint16Array:Uint32Array;const f=NE.indexOf(this.ArrayType),g=2*n*this.ArrayType.BYTES_PER_ELEMENT,w=n*this.IndexArrayType.BYTES_PER_ELEMENT,S=(8-w%8)%8;if(f<0)throw new Error(`Unexpected typed array class: ${d}.`);_&&_ instanceof ArrayBuffer?(this.data=_,this.ids=new this.IndexArrayType(this.data,8,n),this.coords=new this.ArrayType(this.data,8+w+S,2*n),this._pos=2*n,this._finished=!0):(this.data=new ArrayBuffer(8+g+w+S),this.ids=new this.IndexArrayType(this.data,8,n),this.coords=new this.ArrayType(this.data,8+w+S,2*n),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+f]),new Uint16Array(this.data,2,1)[0]=l,new Uint32Array(this.data,4,1)[0]=n)}add(n,l){const d=this._pos>>1;return this.ids[d]=d,this.coords[this._pos++]=n,this.coords[this._pos++]=l,d}finish(){const n=this._pos>>1;if(n!==this.numItems)throw new Error(`Added ${n} items when expected ${this.numItems}.`);return mx(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(n,l,d,_){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:f,coords:g,nodeSize:w}=this,S=[0,f.length-1,0],P=[];for(;S.length;){const x=S.pop()||0,I=S.pop()||0,R=S.pop()||0;if(I-R<=w){for(let N=R;N<=I;N++){const z=g[2*N],G=g[2*N+1];z>=n&&z<=d&&G>=l&&G<=_&&P.push(f[N])}continue}const E=R+I>>1,C=g[2*E],D=g[2*E+1];C>=n&&C<=d&&D>=l&&D<=_&&P.push(f[E]),(x===0?n<=C:l<=D)&&(S.push(R),S.push(E-1),S.push(1-x)),(x===0?d>=C:_>=D)&&(S.push(E+1),S.push(I),S.push(1-x))}return P}within(n,l,d){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:_,coords:f,nodeSize:g}=this,w=[0,_.length-1,0],S=[],P=d*d;for(;w.length;){const x=w.pop()||0,I=w.pop()||0,R=w.pop()||0;if(I-R<=g){for(let N=R;N<=I;N++)UE(f[2*N],f[2*N+1],n,l)<=P&&S.push(_[N]);continue}const E=R+I>>1,C=f[2*E],D=f[2*E+1];UE(C,D,n,l)<=P&&S.push(_[E]),(x===0?n-d<=C:l-d<=D)&&(w.push(R),w.push(E-1),w.push(1-x)),(x===0?n+d>=C:l+d>=D)&&(w.push(E+1),w.push(I),w.push(1-x))}return S}}function mx(u,n,l,d,_,f){if(_-d<=l)return;const g=d+_>>1;zE(u,n,g,d,_,f),mx(u,n,l,d,g-1,1-f),mx(u,n,l,g+1,_,1-f)}function zE(u,n,l,d,_,f){for(;_>d;){if(_-d>600){const P=_-d+1,x=l-d+1,I=Math.log(P),R=.5*Math.exp(2*I/3),E=.5*Math.sqrt(I*R*(P-R)/P)*(x-P/2<0?-1:1);zE(u,n,l,Math.max(d,Math.floor(l-x*R/P+E)),Math.min(_,Math.floor(l+(P-x)*R/P+E)),f)}const g=n[2*l+f];let w=d,S=_;for(Mp(u,n,d,l),n[2*_+f]>g&&Mp(u,n,d,_);w<S;){for(Mp(u,n,w,S),w++,S--;n[2*w+f]<g;)w++;for(;n[2*S+f]>g;)S--}n[2*d+f]===g?Mp(u,n,d,S):(S++,Mp(u,n,S,_)),S<=l&&(d=S+1),l<=S&&(_=S-1)}}function Mp(u,n,l,d){_x(u,l,d),_x(n,2*l,2*d),_x(n,2*l+1,2*d+1)}function _x(u,n,l){const d=u[n];u[n]=u[l],u[l]=d}function UE(u,n,l,d){const _=u-l,f=n-d;return _*_+f*f}s.$=Rf,s.A=cn,s.B=2,s.C=hp,s.D=jh,s.E=Qo,s.F=JT,s.G=class extends ag{},s.H=Os,s.I=sx,s.J=Gu,s.K=c_,s.L=Dc,s.M=Bc,s.N=ch,s.O=wl,s.P=At,s.Q=yh,s.R=zi,s.S=o_,s.T=$v,s.U=Al,s.V=ag,s.W=Sc,s.X=Oa,s.Y=ml,s.Z=Un,s._=As,s.a=function(u){return Vr.API_CDN_URL_REGEX.test(u)},s.a$=Xh,s.a0=gf,s.a1=r_,s.a2=function(u){const n=u.value;let l=[];if(!n)return l;const d=Os(n);return d!=="string"?(l=l.concat([new ag(u.key,n,`string expected, "${d}" found`)]),l):(L2(n,!0)||(l=l.concat([new ag(u.key,n,`invalid url "${n}"`)])),l)},s.a3=qe,s.a4=gh,s.a5=cr,s.a6=wt,s.a7=class{constructor(u){this.specification=u}possiblyEvaluate(u,n){return Yn(u.expression.evaluate(n))}interpolate(u,n,l){return{x:ii(u.x,n.x,l),y:ii(u.y,n.y,l),z:ii(u.z,n.z,l),azimuthal:ii(u.azimuthal,n.azimuthal,l),polar:ii(u.polar,n.polar,l)}}},s.a8=tr,s.a9=Oc,s.aA=ks,s.aB=class{constructor(u){this.entries={},this.scheduler=u}request(u,n,l,d){const _=this.entries[u]=this.entries[u]||{callbacks:[]};if(_.result){const[f,g]=_.result;return this.scheduler?this.scheduler.add(()=>{d(f,g)},n):d(f,g),()=>{}}return _.callbacks.push(d),_.cancel||(_.cancel=l((f,g)=>{_.result=[f,g];for(const w of _.callbacks)this.scheduler?this.scheduler.add(()=>{w(f,g)},n):w(f,g);setTimeout(()=>delete this.entries[u],3e3)})),()=>{_.result||(_.callbacks=_.callbacks.filter(f=>f!==d),_.callbacks.length||(_.cancel(),delete this.entries[u]))}}},s.aC=to,s.aD=function(u,n,l){const d=JSON.stringify(u.request);return u.data&&(this.deduped.entries[d]={result:[null,u.data]}),this.deduped.request(d,{type:"parseTile",isSymbolTile:u.isSymbolTile,zoom:u.tileZoom},_=>{const f=qr(u.request,(g,w,S,P)=>{g?_(g):w&&_(null,{vectorTile:l?void 0:new Oh.VectorTile(new V_(w)),rawData:w,cacheControl:S,expires:P})});return()=>{f.cancel(),_()}},n)},s.aE=function(u){Zt++,Zt>Ze&&(u.getActor().send("enforceCacheSizeLimit",De),Zt=0)},s.aF=function(u){return u<=1?1:Math.pow(2,Math.floor(Math.log(u)/Math.LN2))},s.aG=xt,s.aH=T2,s.aI=R2,s.aJ=A2,s.aK=function(u,n){const l=document.createElement("video");l.muted=!0,l.onloadstart=function(){n(null,l)};for(let d=0;d<u.length;d++){const _=document.createElement("source");Rn(u[d])||(l.crossOrigin="Anonymous"),_.src=u[d],l.appendChild(_)}return{cancel:()=>{}}},s.aL=ig,s.aM=function(u){return fetch(u).then(n=>n.arrayBuffer()).then(n=>BE(n,0,u))},s.aN=OE,s.aO=class{constructor(u,n,l,d){this.id=u,this.position=n!=null?new Li(n[0],n[1]):new Li(0,0),this.orientation=l??[0,0,0],this.nodes=d,this.uploaded=!1,this.aabb=new Wt([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),this.matrix=[]}_applyTransformations(u,n){if(Re.mat4.multiply(u.matrix,n,u.matrix),u.meshes)for(const l of u.meshes){const d=Wt.applyTransformFast(l.aabb,u.matrix);this.aabb.encapsulate(d)}if(u.children)for(const l of u.children)this._applyTransformations(l,u.matrix)}computeBoundsAndApplyParent(){const u=Re.mat4.identity([]);for(const n of this.nodes)this._applyTransformations(n,u)}computeModelMatrix(u,n,l,d,_,f,g=!1){j2(this.matrix,this,u.transform,this.position,n,l,d,_,f,g)}upload(u){if(!this.uploaded){for(const n of this.nodes)Yv(n,u);for(const n of this.nodes)lg(n);this.uploaded=!0}}destroy(){for(const u of this.nodes)Kv(u)}},s.aP=sl,s.aQ=fp,s.aR=es,s.aS=an,s.aT=Oo,s.aU=on,s.aV=Aa,s.aW=Gf,s.aX=eg,s.aY=function(){fs.isLoading()||fs.isLoaded()||mh()!=="deferred"||Nc()},s.aZ=u_,s.a_=U,s.aa=c,s.ab=Re,s.ac=ws,s.ad=Il,s.ae=Hn,s.af=ii,s.ag=Rt,s.ah=Vm,s.ai=Ti,s.aj=Vi,s.ak=class{constructor(u){this.specification=u}possiblyEvaluate(u,n){return function([l,d]){const _=Yn([1,l,d]);return{x:_.x,y:_.y,z:_.z}}(u.expression.evaluate(n))}interpolate(u,n,l){return{x:ii(u.x,n.x,l),y:ii(u.y,n.y,l),z:ii(u.z,n.z,l)}}},s.al=function(u,n,l=0,d=!0){const _=new At(l,l),f=u.sub(_),g=n.add(_),w=[f,new At(g.x,f.y),g,new At(f.x,g.y)];return d&&w.push(f.clone()),w},s.am=function(u,n){const l=[];for(let d=0;d<u.length;d++){const _=us(d-1,-1,u.length-1),f=us(d+1,-1,u.length-1),g=u[d],w=u[f],S=u[_].sub(g).unit(),P=w.sub(g).unit(),x=P.angleWithSep(S.x,S.y),I=S.add(P).unit().mult(-1*n/Math.sin(x/2));l.push(g.add(I))}return l},s.an=c2,s.ao=Ie,s.ap=function(u,n,l=0){return Re.vec3.fromValues(((n.x-l)*u.scale-u.x)*Rt,(n.y*u.scale-u.y)*Rt,M_(n.z,n.y))},s.aq=ci,s.ar=CT,s.as=function(u){let n=1/0,l=1/0,d=-1/0,_=-1/0;for(const f of u)n=Math.min(n,f.x),l=Math.min(l,f.y),d=Math.max(d,f.x),_=Math.max(_,f.y);return{min:new At(n,l),max:new At(d,_)}},s.at=so,s.au=ye,s.av=v,s.aw=yi,s.ax=Bn,s.ay=function(u,n){const l={};for(let d=0;d<n.length;d++){const _=n[d];_ in u&&(l[_]=u[_])}return l},s.az=ha,s.b=function(u){return Vr.API_FONTS_REGEX.test(u)},s.b$=sg,s.b0=ll,s.b1=Tv,s.b2=pv,s.b3=L,s.b4=Do,s.b5=jf,s.b6=Kt,s.b7=Ar,s.b8=Qf,s.b9=jv,s.bA=oT,s.bB=kv,s.bC=s2,s.bD=Dv,s.bE=px,s.bF=us,s.bG=ul,s.bH=Dn,s.bI=function(u,n,l){u[4*n+0]=l[0],u[4*n+1]=l[1],u[4*n+2]=l[2],u[4*n+3]=l[3]},s.bJ=tu,s.bK=Ss,s.bL=Bl,s.bM=Sr,s.bN=Qc,s.bO=Li,s.bP=p2,s.bQ=ct,s.bR=Fi,s.bS=B2,s.bT=ft,s.bU=bn,s.bV=function(u,n,l,d,_,f,g,w,S){if(S.name==="globe")return bn(u,n,new ft(l,d,_),!1);const P=fp({z:l,x:d,y:_},S);return new Wt([(f+P.x/P.scale)*n,n*(P.y/P.scale),g],[(f+P.x2/P.scale)*n,n*(P.y2/P.scale),w])},s.bW=function(u,n,l){let d=0;for(let _=0;_<2;++_)u[_]>0&&(d+=(u[_]-0)*(u[_]-0)),n[_]<0&&(d+=(0-n[_])*(0-n[_]));return d},s.bX=jn,s.bY=I_,s.bZ=function(u){const n=Re.mat4.identity(new Float64Array(16));Re.mat4.multiply(n,u.pixelMatrix,u.globeMatrix);const l=[0,ps,0],d=[0,ms,0];return Re.vec3.transformMat4(l,l,n),Re.vec3.transformMat4(d,d,n),[l[0]>0&&l[0]<=u.width&&l[1]>0&&l[1]<=u.height&&!Cs(u,new Li(u.center.lat,90)),d[0]>0&&d[0]<=u.width&&d[1]>0&&d[1]<=u.height&&!Cs(u,new Li(u.center.lat,-90))]},s.b_=function(u,n){const{scale:l}=u.tileTransform,d=l*Rt/(u.tileSize*Math.pow(2,n.zoom-u.tileID.overscaledZ+u.tileID.canonical.z));return Re.mat2.scale(new Float32Array(4),n.inverseAdjustmentMatrix,[d,d])},s.ba=function(u,n){const l=Hn(n.zoom);if(l===0)return Lr(u);const d=hr(u),_=Qi(d),f=so(d.getWest())*n.worldSize,g=so(d.getEast())*n.worldSize,w=ks(d.getNorth())*n.worldSize,S=ks(d.getSouth())*n.worldSize,P=[f,w,0],x=[g,w,0],I=[f,S,0],R=[g,S,0],E=Re.mat4.invert([],n.globeMatrix);return Re.vec3.transformMat4(P,P,E),Re.vec3.transformMat4(x,x,E),Re.vec3.transformMat4(I,I,E),Re.vec3.transformMat4(R,R,E),_[0]=Nr(_[0],I,l),_[1]=Nr(_[1],R,l),_[2]=Nr(_[2],x,l),_[3]=Nr(_[3],P,l),Wt.fromPoints(_)},s.bb=Zr,s.bc=Ki,s.bd=Nr,s.be=Rl,s.bf=Xt,s.bg=cx,s.bh=V_,s.bi=qr,s.bj=function(u){const n=[];for(const l in u)n.push(u[l]);return n},s.bk=function(u,n){const l=[];for(const d in u)d in n||l.push(d);return l},s.bl=Cn,s.bm=["type","source","source-layer","minzoom","maxzoom","filter","layout"],s.bn=Wr,s.bo=function(u,n){const{x:l,y:d}=u.point,_=ts(l,d,u.worldSize/u._pixelsPerMercatorPixel,0,0);return Re.mat4.multiply(_,_,Ji(Lr(n)))},s.bp=Fh,s.bq=Ls,s.br=U_,s.bs=function(u,n,l,d,_){const f=5*n+2;u.float32[f+0]=l,u.float32[f+1]=d,u.float32[f+2]=_},s.bt=Q_,s.bu=KT,s.bv=Z,s.bw=An,s.bx=eT,s.by=k2,s.bz=sT,s.c=Vu,s.c$=(u,n,l,d,_,f,g,w)=>{const S=u.transform,P=S.pitch<15?MT(.07,.7,yi((14-S.zoom)/5,0,1)):.07,x=l.paint.get("line-trim-color-use-theme").constantOr("default")==="none";return{u_matrix:PT(u,n,l,d),u_texsize:n.imageAtlasTexture?n.imageAtlasTexture.size:[0,0],u_pixels_to_tile_units:S.calculatePixelsToTileUnitsMatrix(n),u_device_pixel_ratio:_,u_width_scale:f,u_floor_width_scale:g,u_image:0,u_tile_units_to_pixels:RT(n,S),u_units_to_pixels:[1/S.pixelsToGLUnits[0],1/S.pixelsToGLUnits[1]],u_alpha_discard_threshold:0,u_trim_offset:w,u_trim_fade_range:l.paint.get("line-trim-fade-range"),u_trim_color:l.paint.get("line-trim-color").toRenderColor(x?null:l.lut).toArray01(),u_emissive_strength:l.paint.get("line-emissive-strength"),u_zbias_factor:P,u_tile_to_meter:o(n.tileID.canonical,0)}},s.c0=P2,s.c1=function(u){const n=P2(u,!0);return Re.mat2.invert([],[n[0],n[1],n[4],n[5]])},s.c2=Ci,s.c3=function(u){const{x:n,y:l}=u.point,{lng:d,lat:_}=u._center;return ts(n,l,u.worldSize,d,_)},s.c4=kr,s.c5=Tt,s.c6=Dl,s.c7=function(u){const n=Math.round((u+45+360)%360/90)%4;return Ln[n]},s.c8=45,s.c9=Ph,s.cA=class extends no{constructor(u){super(u),this.current=Wf}set(u,n,l){if(this.fetchUniformLocation(u,n)){for(let d=0;d<9;d++)if(l[d]!==this.current[d]){this.current=l,this.gl.uniformMatrix3fv(this.location,!1,l);break}}}},s.cB=Ws,s.cC=function(u,n,l){const d=Hn(l.zoom),_=u.style.map._antialias,f=u.terrain&&u.terrain.exaggeration()>0;return d===0&&!_&&!f},s.cD=function(u){const n=u.pixelsPerMeter,l=n/Dn(1,u.center.lat),d=Re.mat4.identity(new Float64Array(16));return Re.mat4.translate(d,d,[u.point.x,u.point.y,0]),Re.mat4.scale(d,d,[l,l,n]),Float32Array.from(d)},s.cE=hr,s.cF=function(u){const n=jn-5;u=yi(u,-80.051129,n)/n*90;const l=Math.pow(Math.abs(Math.sin(Ti(u))),3);return Math.round(l*(Rh.length-1))},s.cG=function(u,n,l,d){const _=n.getNorth(),f=n.getSouth(),g=n.getWest(),w=n.getEast(),S=1<<u.z,P=w-g,x=_-f,I=P/Ol,R=-x/Rh[l],E=[0,I,0,R,0,0,_,g,0];if(u.z>0){const C=180/d;Re.mat3.multiply(E,E,[C/P+1,0,0,0,C/x+1,0,-.5*C/I,.5*C/R,1])}return E[2]=S,E[5]=u.x,E[8]=u.y,E},s.cH=Lr,s.cI=function(u,n,l){const d=Re.mat4.identity(new Float64Array(16)),_=(n/(1<<u)-.5)*Math.PI*2;return Re.mat4.rotateY(d,l.globeMatrix,_),Float32Array.from(d)},s.cJ=class{isDataAvailableAtPoint(u){const n=this._source();if(this.isUsingMockSource()||!n||u.y<0||u.y>1)return!1;const l=n.getSource().maxzoom,d=1<<l,_=Math.floor(u.x),f=Math.floor((u.x-_)*d),g=Math.floor(u.y*d),w=this.findDEMTileFor(new xt(l,_,l,f,g));return!(!w||!w.dem)}getAtPointOrZero(u,n=0){return this.getAtPoint(u,n)||0}getAtPoint(u,n,l=!0){if(this.isUsingMockSource())return null;n==null&&(n=null);const d=this._source();if(!d||u.y<0||u.y>1)return n;const _=d.getSource().maxzoom,f=1<<_,g=Math.floor(u.x),w=u.x-g,S=new xt(_,g,_,Math.floor(w*f),Math.floor(u.y*f)),P=this.findDEMTileFor(S);if(!P||!P.dem)return n;const x=P.dem,I=1<<P.tileID.canonical.z,R=(w*I-P.tileID.canonical.x)*x.dim,E=(u.y*I-P.tileID.canonical.y)*x.dim,C=Math.floor(R),D=Math.floor(E);return(l?this.exaggeration():1)*ii(ii(x.get(C,D),x.get(C,D+1),E-D),ii(x.get(C+1,D),x.get(C+1,D+1),E-D),R-C)}getAtTileOffset(u,n,l){const d=1<<u.canonical.z;return this.getAtPointOrZero(new c(u.wrap+(u.canonical.x+n/Rt)/d,(u.canonical.y+l/Rt)/d))}getAtTileOffsetFunc(u,n,l,d){return _=>{const f=this.getAtTileOffset(u,_.x,_.y),g=d.upVector(u.canonical,_.x,_.y),w=d.upVectorScale(u.canonical,n,l).metersToTile;return Re.vec3.scale(g,g,f*w),g}}getForTilePoints(u,n,l,d){if(this.isUsingMockSource())return!1;const _=Vh.create(this,u,d);return!!_&&(n.forEach(f=>{f[2]=this.exaggeration()*_.getElevationAt(f[0],f[1],l)}),!0)}getMinMaxForTile(u){if(this.isUsingMockSource())return null;const n=this.findDEMTileFor(u);if(!n||!n.dem)return null;const l=n.dem.tree,d=n.tileID,_=1<<u.canonical.z-d.canonical.z;let f=u.canonical.x/_-d.canonical.x,g=u.canonical.y/_-d.canonical.y,w=0;for(let S=0;S<u.canonical.z-d.canonical.z&&!l.leaves[w];S++){f*=2,g*=2;const P=2*Math.floor(g)+Math.floor(f);w=l.childOffsets[w]+P,f%=1,g%=1}return{min:this.exaggeration()*l.minimums[w],max:this.exaggeration()*l.maximums[w]}}getMinElevationBelowMSL(){throw new Error("Pure virtual method called.")}raycast(u,n,l){throw new Error("Pure virtual method called.")}pointCoordinate(u){throw new Error("Pure virtual method called.")}_source(){throw new Error("Pure virtual method called.")}isUsingMockSource(){throw new Error("Pure virtual method called.")}exaggeration(){throw new Error("Pure virtual method called.")}findDEMTileFor(u){throw new Error("Pure virtual method called.")}get visibleDemTiles(){throw new Error("Getter must be implemented in subclass.")}getMinMaxForVisibleTiles(){const u=this.visibleDemTiles;if(u.length===0)return null;let n=!1,l=Number.MAX_VALUE,d=Number.MIN_VALUE;for(const _ of u){const f=this.getMinMaxForTile(_.tileID);f&&(l=Math.min(l,f.min),d=Math.max(d,f.max),n=!0)}return n?{min:l,max:d}:null}},s.cK=DA,s.cL=Ei,s.cM=function(u,n){return[Math.pow(u[0],2.2)*n,Math.pow(u[1],2.2)*n,Math.pow(u[2],2.2)*n]},s.cN=Is,s.cO=Uu,s.cP=zu,s.cQ=256,s.cR=function(u,n){const l=[0,0,0],d=Zr(Lr(n.canonical));return Re.vec3.transformMat4(l,l,d),Re.vec3.transformMat4(l,l,u),l},s.cS=u=>({u_camera_to_center_distance:new Sr(u),u_extrude_scale:new qf(u),u_device_pixel_ratio:new Sr(u),u_matrix:new tu(u),u_inv_rot_matrix:new tu(u),u_merc_center:new Ss(u),u_tile_id:new Bl(u),u_zoom_transition:new Sr(u),u_up_dir:new Bl(u),u_emissive_strength:new Sr(u)}),s.cT=u=>({u_matrix:new tu(u),u_pixels_to_tile_units:new qf(u),u_device_pixel_ratio:new Sr(u),u_width_scale:new Sr(u),u_floor_width_scale:new Sr(u),u_units_to_pixels:new Ss(u),u_dash_image:new Qc(u),u_gradient_image:new Qc(u),u_image_height:new Sr(u),u_texsize:new Ss(u),u_tile_units_to_pixels:new Sr(u),u_alpha_discard_threshold:new Sr(u),u_trim_offset:new Ss(u),u_trim_fade_range:new Ss(u),u_trim_color:new eu(u),u_emissive_strength:new Sr(u),u_zbias_factor:new Sr(u),u_tile_to_meter:new Sr(u)}),s.cU=u=>({u_matrix:new tu(u),u_texsize:new Ss(u),u_pixels_to_tile_units:new qf(u),u_device_pixel_ratio:new Sr(u),u_width_scale:new Sr(u),u_floor_width_scale:new Sr(u),u_image:new Qc(u),u_units_to_pixels:new Ss(u),u_tile_units_to_pixels:new Sr(u),u_alpha_discard_threshold:new Sr(u),u_trim_offset:new Ss(u),u_trim_fade_range:new Ss(u),u_trim_color:new eu(u),u_emissive_strength:new Sr(u),u_zbias_factor:new Sr(u),u_tile_to_meter:new Sr(u)}),s.cV=Lf,s.cW=ID,s.cX=CD,s.cY=Ll,s.cZ=(u,n,l,d,_,f)=>{const g=u.transform,w=g.projection.name==="globe";let S;if(f.paint.get("circle-pitch-alignment")==="map")if(w){const x=Is(g.zoom,n.canonical)*g._pixelsPerMercatorPixel;S=Float32Array.from([x,0,0,x])}else S=g.calculatePixelsToTileUnitsMatrix(l);else S=new Float32Array([g.pixelsToGLUnits[0],0,0,g.pixelsToGLUnits[1]]);const P={u_camera_to_center_distance:u.transform.getCameraToCenterDistance(g.projection),u_matrix:u.translatePosMatrix(n.projMatrix,l,f.paint.get("circle-translate"),f.paint.get("circle-translate-anchor")),u_device_pixel_ratio:xe.devicePixelRatio,u_extrude_scale:S,u_inv_rot_matrix:qa,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0],u_emissive_strength:f.paint.get("circle-emissive-strength")};if(w){P.u_inv_rot_matrix=d,P.u_merc_center=_,P.u_tile_id=[n.canonical.x,n.canonical.y,1<<n.canonical.z],P.u_zoom_transition=Hn(g.zoom);const x=_[0]*Rt,I=_[1]*Rt;P.u_up_dir=g.projection.upVector(new ft(0,0,0),x,I)}return P},s.c_=BT,s.ca=eu,s.cb=function(u,n,l){const d=Math.sqrt(u*u+n*n+l*l),_=d>0?Math.acos(l/d)*Zn:0;let f=u!==0||n!==0?Math.atan2(-n,-u)*Zn+90:0;return f<0&&(f+=360),[d,f,_]},s.cc=o,s.cd=Wt,s.ce=Yn,s.cf=function(u){return[Math.pow(u[0],1/2.2),Math.pow(u[1],1/2.2),Math.pow(u[2],1/2.2)]},s.cg=function(u,n){return u.readFields(xO,{icons:[]},n)},s.ch=function(u){return u({pluginStatus:Jn,pluginURL:sa}),Tl.on("pluginStateChange",u),u},s.ci=ug,s.cj=Lh,s.ck=Ov,s.cl=Zs,s.cm=If,s.cn=Be,s.co=Bs,s.cp=hs,s.cq=function(u){const n=u.indexOf(xh);return n>=0?u.slice(0,n):u},s.cr=function(u){return u.indexOf(xh)>=0},s.cs=function(u){const n=u.indexOf(xh);return n>=0?u.slice(n+1):""},s.ct=function(u){const n=[],l=u.id;return l===void 0&&n.push({message:`layers.${l}: missing required property "id"`}),u.render===void 0&&n.push({message:`layers.${l}: missing required method "render"`}),u.renderingMode&&u.renderingMode!=="2d"&&u.renderingMode!=="3d"&&n.push({message:`layers.${l}: property "renderingMode" must be either "2d" or "3d"`}),n},s.cu=function(u,n,l,d){return u.type==="custom"?new oO(u,n):new gO[u.type](u,n,l,d)},s.cv=al,s.cw=class extends Xh{constructor(u,n){super(u._vectorTileFeature,u._z,u._x,u._y,u.id),u.state&&(this.state=Object.assign({},u.state)),this.target=n.target,this.namespace=n.namespace,n.properties&&(this.properties=n.properties),this.target&&("featuresetId"in this.target&&!this.target.importId||"layerId"in this.target)&&(this.source=u.source,this.sourceLayer=u.sourceLayer,this.layer=u.layer)}toJSON(){const u=super.toJSON();return u.target=this.target,u.namespace=this.namespace,u}},s.cx=Tl,s.cy=jr,s.cz=T_,s.d=function(u){return Vr.API_TILEJSON_REGEX.test(u)},s.d$=kE,s.d0=(u,n,l,d,_,f,g,w,S)=>{const P=u.transform,x=P.calculatePixelsToTileUnitsMatrix(n),I=l.paint.get("line-trim-color-use-theme").constantOr("default")==="none",R=P.pitch<15?MT(.07,.7,yi((14-P.zoom)/5,0,1)):.07;return{u_matrix:PT(u,n,l,d),u_pixels_to_tile_units:x,u_device_pixel_ratio:f,u_width_scale:g,u_floor_width_scale:w,u_units_to_pixels:[1/P.pixelsToGLUnits[0],1/P.pixelsToGLUnits[1]],u_dash_image:0,u_gradient_image:1,u_image_height:_,u_texsize:DT(l)&&n.lineAtlasTexture?n.lineAtlasTexture.size:[0,0],u_tile_units_to_pixels:RT(n,u.transform),u_alpha_discard_threshold:0,u_trim_offset:S,u_trim_fade_range:l.paint.get("line-trim-fade-range"),u_trim_color:l.paint.get("line-trim-color").toRenderColor(I?null:l.lut).toArray01(),u_emissive_strength:l.paint.get("line-emissive-strength"),u_zbias_factor:R,u_tile_to_meter:o(n.tileID.canonical,0)}},s.d1=nl,s.d2=Jf,s.d3=vT,s.d4=Lt,s.d5=z_,s.d6=zl,s.d7=450,s.d8=7,s.d9=sO,s.dA=wo,s.dB=p,s.dC=Ga,s.dD=function([u,n,l]){const d=Math.hypot(u,n,l),_=Math.atan2(u,l),f=.5*Math.PI-Math.acos(-n/d);return new Li(kr(_),kr(f))},s.dE=qv,s.dF=function(u){const n=u.navigator?u.navigator.userAgent:null;return!!function(l){if(cl==null){const d=l.navigator?l.navigator.userAgent:null;cl=!!l.safari||!(!d||!(/\b(iPad|iPhone|iPod)\b/.test(d)||d.match("Safari")&&!d.match("Chrome")))}return cl}(u)&&n&&(n.match("Version/15.4")||n.match("Version/15.5")||n.match(/CPU (OS|iPhone OS) (15_4|15_5) like Mac OS X/))},s.dG=function(u,n){De=u,Ze=n},s.dH=Cs,s.dI=oo,s.dJ=function(u){const n=[0,0,0],l=Re.mat4.identity(new Float64Array(16));return Re.mat4.multiply(l,u.pixelMatrix,u.globeMatrix),Re.vec3.transformMat4(n,n,l),new At(n[0],n[1])},s.dK=function(u,n,l=!1){if(Jn===Lc||Jn===ph||Jn===Sf)throw new Error("setRTLTextPlugin cannot be called multiple times.");sa=xe.resolveURL(u),Jn=Lc,eo=n,Cf(),l||Nc()},s.dL=mh,s.dM=function(){ug().acquire(Qv)},s.dN=function(){const u=bp;u&&(u.isPreloaded()&&u.numActive()===1?(u.release(Qv),bp=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},s.dO=au,s.dP=function(u){const n=It();if(!n)return;const l=n.delete(He);u&&l.catch(u).then(()=>u())},s.dQ=xp,s.dR=EE,s.dS=function(u){ux=xe.resolveURL(u),qh||(qh=new jh(ug(),new Qo)),qh.broadcast("setDracoUrl",ux)},s.dT=SE,s.dU=function(u){Wh=xe.resolveURL(u),qh||(qh=new jh(ug(),new Qo)),qh.broadcast("setMeshoptUrl",Wh)},s.dV=Vt,s.dW=Nl,s.dX=Lo,s.dY=Oh,s.dZ=class{constructor(u,n){this.pos=u,this.dir=n}intersectsPlane(u,n,l){const d=Re.vec2.dot(n,this.dir);if(Math.abs(d)<1e-6)return!1;const _=((u[0]-this.pos[0])*n[0]+(u[1]-this.pos[1])*n[1])/d;return l[0]=this.pos[0]+this.dir[0]*_,l[1]=this.pos[1]+this.dir[1]*_,!0}},s.d_=FE,s.da=ji,s.db=Hf,s.dc=256,s.dd=Ji,s.de=io,s.df=la,s.dg=Th,s.dh=function(u,n,l,d,_){return yi((u-n)/(l-n)*(_-d)+d,d,_)},s.di=ah,s.dj=kl,s.dk=class{constructor(u,n,l,d){this.context=u,this.format=d,this.size=l,this.texture=u.gl.createTexture();const[_,f,g]=this.size,{gl:w}=u;w.bindTexture(w.TEXTURE_3D,this.texture),u.pixelStoreUnpackFlipY.set(!1),u.pixelStoreUnpack.set(1),u.pixelStoreUnpackPremultiplyAlpha.set(!1),w.texImage3D(w.TEXTURE_3D,0,this.format,_,f,g,0,Hv(this.format),Gv(this.format),n.data)}bind(u,n){const{context:l}=this,{gl:d}=l;d.bindTexture(d.TEXTURE_3D,this.texture),u!==this.minFilter&&(d.texParameteri(d.TEXTURE_3D,d.TEXTURE_MAG_FILTER,u),d.texParameteri(d.TEXTURE_3D,d.TEXTURE_MIN_FILTER,u),this.minFilter=u),n!==this.wrapS&&(d.texParameteri(d.TEXTURE_3D,d.TEXTURE_WRAP_S,n),d.texParameteri(d.TEXTURE_3D,d.TEXTURE_WRAP_T,n),this.wrapS=n)}destroy(){const{gl:u}=this.context;u.deleteTexture(this.texture),this.texture=null}},s.dl=Xv,s.dm=[1,1,1],s.dn=Vh,s.dp=Uh,s.dq=aa,s.dr=Pl,s.ds=$a,s.dt=Eh,s.du=ro,s.dv=class{constructor(){this._updateTime=0,this._sourceIds=[],this._activeRegions=[],this._prevRegions=[],this._globalClipBounds={min:new At(1/0,1/0),max:new At(-1/0,-1/0)}}clear(){this._activeRegions.length>0&&++this._updateTime,this._activeRegions=[],this._prevRegions=[]}get updateTime(){return this._updateTime}getReplacementRegionsForTile(u,n=!1){const l=iT(new At(0,0),new At(Rt,Rt),u),d=[];if(n&&!vv(l,this._globalClipBounds))return d;for(const _ of this._activeRegions){if(_.hiddenByOverlap||!vv(l,_))continue;const f=eD(_.min,_.max,u);d.push({min:f.min,max:f.max,sourceId:this._sourceIds[_.priority],footprint:_.footprint,footprintTileId:_.tileId,order:_.order,clipMask:_.clipMask,clipScope:_.clipScope})}return d}setSources(u){this._setSources(u.map(n=>({getSourceId:()=>n.cache.id,getFootprints:()=>{const l=[];for(const d of n.cache.getVisibleCoordinates()){const _=n.cache.getTile(d).buckets[n.layer];_&&_.updateFootprints(d.toUnwrapped(),l)}return l},getOrder:()=>n.order,getClipMask:()=>n.clipMask,getClipScope:()=>n.clipScope})))}_addSource(u){const n=u.getFootprints();if(n.length===0)return;const l=u.getOrder(),d=u.getClipMask(),_=u.getClipScope();for(const f of n){if(!f.footprint)continue;const g=iT(f.footprint.min,f.footprint.max,f.id);this._activeRegions.push({min:g.min,max:g.max,hiddenByOverlap:!1,priority:this._sourceIds.length,tileId:f.id,footprint:f.footprint,order:l,clipMask:d,clipScope:_})}this._sourceIds.push(u.getSourceId())}_computeReplacement(){this._activeRegions.sort((n,l)=>n.priority-l.priority||L_(n.min,l.min)||L_(n.max,l.max)||n.order-l.order||n.clipMask-l.clipMask||function(d,_){const f=(g,w)=>g+w;return d.length-_.length||d.reduce(f,"").localeCompare(_.reduce(f,""))}(n.clipScope,l.clipScope));let u=this._activeRegions.length!==this._prevRegions.length;if(!u){let n=0;for(;!u&&n!==this._activeRegions.length;){const l=this._activeRegions[n],d=this._prevRegions[n];u=l.priority!==d.priority||!tT(l,d)||l.order!==d.order||l.clipMask!==d.clipMask||!Wr(l.clipScope,d.clipScope),++n}}if(u){++this._updateTime;for(const l of this._activeRegions)l.order!==k_&&(this._globalClipBounds.min.x=Math.min(this._globalClipBounds.min.x,l.min.x),this._globalClipBounds.min.y=Math.min(this._globalClipBounds.min.y,l.min.y),this._globalClipBounds.max.x=Math.max(this._globalClipBounds.max.x,l.max.x),this._globalClipBounds.max.y=Math.max(this._globalClipBounds.max.y,l.max.y));const n=l=>{const d=this._activeRegions;if(l>=d.length)return l;const _=d[l].priority;for(;l<d.length&&d[l].priority===_;)++l;return l};if(this._sourceIds.length>1){let l=0,d=n(l);for(;l!==d;){let _=l;const f=l;for(;_!==d;){const g=this._activeRegions[_];g.hiddenByOverlap=!1;for(let w=0;w<f;w++){const S=this._activeRegions[w];if(!S.hiddenByOverlap&&g.order===k_&&vv(g,S)&&(g.hiddenByOverlap=nT(g.footprint,g.tileId,S.footprint,S.tileId),g.hiddenByOverlap))break}++_}l=d,d=n(l)}}}}_setSources(u){[this._prevRegions,this._activeRegions]=[this._activeRegions,[]],this._sourceIds=[];for(let n=u.length-1;n>=0;n--)this._addSource(u[n]);this._computeReplacement()}},s.dw=class{constructor(u){this._createGrid(u),this._createPoles(u)}destroy(){this._poleIndexBuffer.destroy(),this._gridBuffer.destroy(),this._gridIndexBuffer.destroy(),this._poleNorthVertexBuffer.destroy(),this._poleSouthVertexBuffer.destroy();for(const u of this._poleSegments)u.destroy();for(const u of this._gridSegments)u.withSkirts.destroy(),u.withoutSkirts.destroy()}_fillGridMeshWithLods(u,n){const l=new Do,d=new on,_=[],f=u+1+2,g=n[0]+1,w=n[0]+1+(1+n.length),S=(P,x,I)=>{let R=P===f-1?P-2:P===0?P:P-1;return R+=I?24575:0,[R,x]};for(let P=0;P<f;++P)l.emplaceBack(...S(P,0,!0));for(let P=0;P<g;++P)for(let x=0;x<f;++x)l.emplaceBack(...S(x,P,(x===0||x===f-1)&&!0));for(let P=0;P<n.length;++P){const x=n[P];for(let I=0;I<f;++I)l.emplaceBack(...S(I,x,!0))}for(let P=0;P<n.length;++P){const x=d.length,I=n[P]+1+2,R=new on;for(let D=0;D<I-1;D++){const N=D===I-2,z=N?f*(w-n.length+P-D):f;for(let G=0;G<f-1;G++){const W=D*f+G;D===0||N||G===0||G===f-2?(R.emplaceBack(W+1,W,W+z),R.emplaceBack(W+z,W+z+1,W+1)):(d.emplaceBack(W+1,W,W+z),d.emplaceBack(W+z,W+z+1,W+1))}}const E=Ar.simpleSegment(0,x,l.length,d.length-x);for(let D=0;D<R.uint16.length;D+=3)d.emplaceBack(R.uint16[D],R.uint16[D+1],R.uint16[D+2]);const C=Ar.simpleSegment(0,x,l.length,d.length-x);_.push({withoutSkirts:E,withSkirts:C})}return{vertices:l,indices:d,segments:_}}_createGrid(u){const n=this._fillGridMeshWithLods(Ol,Rh);this._gridSegments=n.segments,this._gridBuffer=u.createVertexBuffer(n.vertices,Kt.members),this._gridIndexBuffer=u.createIndexBuffer(n.indices,!0)}_createPoles(u){const n=new on;for(let g=0;g<=Ol;g++)n.emplaceBack(0,g+1,g+2);this._poleIndexBuffer=u.createIndexBuffer(n,!0);const l=new la,d=new la,_=new la,f=new la;this._poleSegments=[];for(let g=0,w=0;g<Dl;g++){const S=360/(1<<g);l.emplaceBack(0,-Bn,0,.5,0),d.emplaceBack(0,-Bn,0,.5,1),_.emplaceBack(0,-Bn,0,.5,.5),f.emplaceBack(0,-Bn,0,.5,.5);for(let P=0;P<=Ol;P++){let x=P/Ol,I=0;const R=ii(0,S,x),[E,C,D]=Fl(Wa,ao,R,Bn);l.emplaceBack(E,C,D,x,I),d.emplaceBack(E,C,D,x,1-I);const N=Ti(R);x=.5+.5*Math.sin(N),I=.5+.5*Math.cos(N),_.emplaceBack(E,C,D,x,I),f.emplaceBack(E,C,D,x,1-I)}this._poleSegments.push(Ar.simpleSegment(w,0,66,64)),w+=66}this._poleNorthVertexBuffer=u.createVertexBuffer(l,ni,!1),this._poleSouthVertexBuffer=u.createVertexBuffer(d,ni,!1),this._texturedPoleNorthVertexBuffer=u.createVertexBuffer(_,ni,!1),this._texturedPoleSouthVertexBuffer=u.createVertexBuffer(f,ni,!1)}getGridBuffers(u,n){return[this._gridBuffer,this._gridIndexBuffer,n?this._gridSegments[u].withSkirts:this._gridSegments[u].withoutSkirts]}getPoleBuffers(u,n){return[n?this._texturedPoleNorthVertexBuffer:this._poleNorthVertexBuffer,n?this._texturedPoleSouthVertexBuffer:this._poleSouthVertexBuffer,this._poleIndexBuffer,this._poleSegments[u]]}},s.dx=k_,s.dy=bo,s.dz=function(){return!!document.fullscreenElement||!!document.webkitFullscreenElement},s.e=Vr,s.e0=ET,s.e1=ol,s.e2=Qs,s.e3=QT,s.e4=function(u,n,l,d,_,f,g,w,S,P,x=1,I,R){u.createArrays(),u.tilePixelRatio=Rt/(512*u.overscaling),u.compareText={},u.iconsNeedLinear=!1;const E=u.layers[0].layout,C=u.layers[0]._unevaluatedLayout._values,D={};D.scaleFactor=x,D.textSizeScaleRange=E.get("text-size-scale-range"),D.iconSizeScaleRange=E.get("icon-size-scale-range");const[N,z]=D.textSizeScaleRange,[G,W]=D.iconSizeScaleRange;if(D.textScaleFactor=yi(D.scaleFactor,N,z),D.iconScaleFactor=yi(D.scaleFactor,G,W),u.textSizeData.kind==="composite"){const{minZoom:ie,maxZoom:he}=u.textSizeData;D.compositeTextSizes=[C["text-size"].possiblyEvaluate(new tr(ie),w),C["text-size"].possiblyEvaluate(new tr(he),w)]}if(u.iconSizeData.kind==="composite"){const{minZoom:ie,maxZoom:he}=u.iconSizeData;D.compositeIconSizes=[C["icon-size"].possiblyEvaluate(new tr(ie),w),C["icon-size"].possiblyEvaluate(new tr(he),w)]}D.layoutTextSize=C["text-size"].possiblyEvaluate(new tr(S+1),w),D.layoutIconSize=C["icon-size"].possiblyEvaluate(new tr(S+1),w),D.textMaxSize=C["text-size"].possiblyEvaluate(new tr(18),w);const H=E.get("text-rotation-alignment")==="map"&&E.get("symbol-placement")!=="point",q=E.get("text-size");let Y=!1;for(const ie of u.features)if(ie.icon&&ie.icon.nameSecondary){Y=!0;break}for(const ie of u.features){const he=E.get("text-font").evaluate(ie,{},w).join(","),ce=q.evaluate(ie,{},w)*D.textScaleFactor,le=D.layoutTextSize.evaluate(ie,{},w)*D.textScaleFactor,Te=(D.layoutIconSize.evaluate(ie,{},w),{horizontal:{},vertical:void 0}),de=ie.text;let Se,Pe=[0,0];if(de){const Ue=de.toString(),Ge=E.get("text-letter-spacing").evaluate(ie,{},w)*An,Ne=E.get("text-line-height").evaluate(ie,{},w)*An,rt=Z0(Ue)?Ge:0,mt=E.get("text-anchor").evaluate(ie,{},w),it=E.get("text-variable-anchor");if(!it){const Ht=E.get("text-radial-offset").evaluate(ie,{},w);Pe=Ht?s2(mt,[Ht*An,Fv]):E.get("text-offset").evaluate(ie,{},w).map(Ft=>Ft*An)}let Bt=H?"center":E.get("text-justify").evaluate(ie,{},w);const Mt=E.get("symbol-placement")==="point",bt=Mt?E.get("text-max-width").evaluate(ie,{},w)*An:1/0,_t=Ht=>{u.allowVerticalPlacement&&wf(Ue)&&(Te.vertical=Bv(de,n,l,_,he,bt,Ne,mt,Ht,rt,Pe,Ls.vertical,!0,le,ce))};if(!H&&it){const Ht=Bt==="auto"?it.map(zt=>kv(zt)):[Bt];let Ft=!1;for(let zt=0;zt<Ht.length;zt++){const ai=Ht[zt];if(!Te.horizontal[ai])if(Ft)Te.horizontal[ai]=Te.horizontal[0];else{const fi=Bv(de,n,l,_,he,bt,Ne,"center",ai,rt,Pe,Ls.horizontal,!1,le,ce);fi&&(Te.horizontal[ai]=fi,Ft=fi.positionedLines.length===1)}}_t("left")}else{if(Bt==="auto"&&(Bt=kv(mt)),Mt||E.get("text-writing-mode").indexOf("horizontal")>=0||!wf(Ue)){const Ht=Bv(de,n,l,_,he,bt,Ne,mt,Bt,rt,Pe,Ls.horizontal,!1,le,ce);Ht&&(Te.horizontal[Bt]=Ht)}_t(Mt?"left":Bt)}}let Me=!1;if(ie.icon&&ie.icon.namePrimary){const Ue=Iv(u.iconSizeData,C["icon-size"],w,u.zoom,ie)*D.iconScaleFactor*I,Ge=ie.icon.getPrimary().scaleSelf(Ue).serialize(),Ne=d[Ge];Ne&&(Se=zD(_[Ge],ie.icon.nameSecondary?_[ie.icon.getSecondary().scaleSelf(Ue).serialize()]:void 0,E.get("icon-offset").evaluate(ie,{},w),E.get("icon-anchor").evaluate(ie,{},w)),Me=Ne.sdf,u.sdfIcons===void 0?u.sdfIcons=Ne.sdf:u.sdfIcons!==Ne.sdf&&mi("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(Ne.pixelRatio!==u.pixelRatio||E.get("icon-rotate").constantOr(1)!==0)&&(u.iconsNeedLinear=!0))}const Oe=a2(Te.horizontal)||Te.vertical;u.iconsInText||(u.iconsInText=!!Oe&&Oe.iconsInText),(Oe||Se)&&WD(u,ie,Te,Se,d,D,le,0,Pe,Me,g,w,P,R,Y)}f&&u.generateCollisionDebugBuffers(S,u.collisionBoxArray,D.textScaleFactor)},s.e5=_g,s.e6=_n,s.e7=YA,s.e8=zT,s.e9=T,s.ea=function(u){let n=0;if(new Uint32Array(u,0,1)[0]!==CE){const l=new Uint32Array(u,0,7),[,,d,_,f,g]=l;n=l.byteLength+_+f+g+f,(d!==u.byteLength||n>=u.byteLength)&&mi("Invalid b3dm header information.")}return BE(u,n)},s.eb=function(u,n){const l=OE(u);for(const d of l){for(const _ of d.meshes)bF(_);d.lights&&(d.lightMeshIndex=d.meshes.length,d.meshes.push(wF(d.lights,n)))}return l},s.ec=cg,s.ed=X2,s.ee=fs,s.ef=function(u){Ct(),Ke!=null&&Ke.then(n=>{n.keys().then(l=>{for(let d=0;d<l.length-u;d++)n.delete(l[d])})})},s.f=function(u){return u.indexOf("mapbox:")===0},s.g=function(u,n){return jr(Mn(u,{method:"GET"}),n)},s.h=cc,s.i=function(u){return Vr.API_STYLE_REGEX.test(u)&&!Vu(u)},s.j=function(u){return decodeURIComponent(atob(u).split("").map(n=>"%"+("00"+n.charCodeAt(0).toString(16)).slice(-2)).join(""))},s.k=function(u){return btoa(encodeURIComponent(u).replace(/%([0-9A-F]{2})/g,(n,l)=>String.fromCharCode(+("0x"+l))))},s.l=Mn,s.m=ei,s.n=function(u,n){return jr(Mn(u,{type:"json"}),n)},s.o=Dd,s.p=function(u,n){return jr(Mn(u,{method:"POST"}),n)},s.q=xe,s.r=hn,s.s=function(u){try{const n=self[u];return n.setItem("_mapbox_test_",1),n.removeItem("_mapbox_test_"),!0}catch{return!1}},s.t=oe,s.u=function(){return function u(n){return n?(n^Math.random()*(16>>n/4)).toString(16):([1e7]+-[1e3]+-4e3+-8e3+-1e11).replace(/[018]/g,u)}()},s.v=function(u){return!!u&&/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(u)},s.w=mi,s.x=function(){return ex||(ex=new au),ex},s.y=ju,s.z=Ks}),h(["./shared"],function(s){function T(Je){const J=Je?Je.url.toString():void 0;return J?performance.getEntriesByName(J):[]}function B(Je){if(typeof Je=="number"||typeof Je=="boolean"||typeof Je=="string"||Je==null)return JSON.stringify(Je);if(Array.isArray(Je)){let re="[";for(const oe of Je)re+=`${B(oe)},`;return`${re}]`}let J="{";for(const re of Object.keys(Je).sort())J+=`${re}:${B(Je[re])},`;return`${J}}`}function F(Je){let J="";for(const re of s.bm)(Je.type!=="model"||re!=="minzoom"&&re!=="maxzoom")&&(J+=`/${B(Je[re])}`);return J}class V{constructor(J){this.keyCache={},this._layers={},this._layerConfigs={},J&&this.replace(J)}replace(J,re){this._layerConfigs={},this._layers={},this.update(J,[],re)}update(J,re,oe){this._options=oe;for(const Ee of J)this._layerConfigs[Ee.id]=Ee,(this._layers[Ee.id]=s.cu(Ee,this.scope,null,this._options)).compileFilter(oe),this.keyCache[Ee.id]&&delete this.keyCache[Ee.id];for(const Ee of re)delete this.keyCache[Ee],delete this._layerConfigs[Ee],delete this._layers[Ee];this.familiesBySource={};const xe=function(Ee,Be){const He={};for(let Ze=0;Ze<Ee.length;Ze++){const Xe=Ee[Ze];let Ke=Be&&Be[Xe.id];!Ke&&(Ke=F(Xe),Xe.type==="line"&&Xe.paint)&&function It(Ct){return typeof Ct=="string"&&Ct==="line-progress"||(Array.isArray(Ct)?Ct.some(It):!(!Ct||typeof Ct!="object")&&Object.values(Ct).some(It))}(Xe.paint["line-width"])&&(Ke+=`/${B(Xe.paint["line-width"])}`),Be&&(Be[Xe.id]=Ke);let dt=He[Ke];dt||(dt=He[Ke]=[]),dt.push(Xe)}const De=[];for(const Ze in He)De.push(He[Ze]);return De}(s.bj(this._layerConfigs),this.keyCache);for(const Ee of xe){const Be=Ee.map(dt=>this._layers[dt.id]),He=Be[0];if(He.visibility==="none")continue;const De=He.source||"";let Ze=this.familiesBySource[De];Ze||(Ze=this.familiesBySource[De]={});const Xe=He.sourceLayer||"_geojsonTileLayer";let Ke=Ze[Xe];Ke||(Ke=Ze[Xe]=[]),Ke.push(Be)}}}const X=1*s.dX;class se{constructor(J){const re={},oe=[];for(const He in J){const De=J[He],Ze=re[He]={};for(const Xe in De.glyphs){const Ke=De.glyphs[+Xe];if(!Ke||Ke.bitmap.width===0||Ke.bitmap.height===0)continue;const dt=Ke.metrics.localGlyph?X:1,It={x:0,y:0,w:Ke.bitmap.width+2*dt,h:Ke.bitmap.height+2*dt};oe.push(It),Ze[Xe]=It}}const{w:xe,h:Ee}=s.F(oe),Be=new s.dW({width:xe||1,height:Ee||1});for(const He in J){const De=J[He];for(const Ze in De.glyphs){const Xe=De.glyphs[+Ze];if(!Xe||Xe.bitmap.width===0||Xe.bitmap.height===0)continue;const Ke=re[He][Ze],dt=Xe.metrics.localGlyph?X:1;s.dW.copy(Xe.bitmap,Be,{x:0,y:0},{x:Ke.x+dt,y:Ke.y+dt},Xe.bitmap)}}this.image=Be,this.positions=re}}s.dV(se,"GlyphAtlas");const ne="3d_elevation_id",K="hd_road_elevation";class ue{constructor(){this._valid=!1}reset(J){return this.feature=J,this._valid=!0,this._geometry=J.loadGeometry(),this._geometry.length!==0&&this._geometry[0].length!==0||(this._valid=!1),this}geometry(J,re){return this._valid&&J(re(this._geometry)),this}require(J,re,oe){return this.get(J,!0,re,oe)}optional(J,re,oe){return this.get(J,!1,re,oe)}success(){return this._valid}get(J,re,oe,xe){const Ee=this.feature.properties.hasOwnProperty(J)?+this.feature.properties[J]:void 0;return this._valid&&Ee!==void 0?oe(xe?xe(Ee):Ee):re&&(this._valid=!1),this}}class _e{constructor(J,re){this.featureFunc=J,this.vertexFunc=re}parseFeature(J,re,oe){return this.featureFunc(J,re,oe)}parseVertex(J,re,oe){return this.vertexFunc(J,re,oe)}}const ke=new _e((Je,J,re)=>Je.reset(J).require(ne,oe=>{re.id=oe}).optional("fixed_height_relative",oe=>{re.constantHeight=oe},ge.decodeRelativeHeight).geometry(oe=>{re.bounds=oe},ge.computeBounds).success(),(Je,J,re)=>Je.reset(J).require(ne,oe=>{re.id=oe}).require("elevation_idx",oe=>{re.idx=oe}).require("extent",oe=>{re.extent=oe}).require("height_relative",oe=>{re.height=oe},ge.decodeRelativeHeight).geometry(oe=>{re.position=oe},ge.getPoint).success()),we=new _e((Je,J,re)=>Je.reset(J).require(ne,oe=>{re.id=oe}).optional("fixed_height",oe=>{re.constantHeight=oe},ge.decodeMetricHeight).geometry(oe=>{re.bounds=oe},ge.computeBounds).success(),(Je,J,re)=>Je.reset(J).require(ne,oe=>{re.id=oe}).require("elevation_idx",oe=>{re.idx=oe}).require("extent",oe=>{re.extent=oe}).require("height",oe=>{re.height=oe},ge.decodeMetricHeight).geometry(oe=>{re.position=oe},ge.getPoint).success());class ge{static computeBounds(J){const re=new s.P(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),oe=new s.P(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(const xe of J[0])re.x>xe.x&&(re.x=xe.x),re.y>xe.y&&(re.y=xe.y),oe.x<xe.x&&(oe.x=xe.x),oe.y<xe.y&&(oe.y=xe.y);return{min:re,max:oe}}static getPoint(J){return s.ab.vec2.fromValues(J[0][0].x,J[0][0].y)}static decodeRelativeHeight(J){return 1e-4*J*5}static decodeMetricHeight(J){return 1e-4*J}static parse(J){const re=[],oe=[],xe=J.length,Ee=new ue;for(let He=0;He<xe;He++){const De=J.feature(He),Ze=De.properties.hasOwnProperty("version")?String(De.properties.version):void 0,Xe=(Be=Ze)?Be==="1.0.1"?we:void 0:ke;if(Xe===void 0){s.w(`Unknown elevation feature version number ${Ze||"(unknown)"}`);continue}const Ke=De.properties.hasOwnProperty("type")?De.properties.type:void 0;if(Ke){if(s.dY.VectorTileFeature.types[De.type]==="Point"&&Ke==="curve_point"){const dt={};Xe.parseVertex(Ee,De,dt)&&re.push(dt)}else if(s.dY.VectorTileFeature.types[De.type]==="Polygon"&&Ke==="curve_meta"){const dt={};Xe.parseFeature(Ee,De,dt)&&oe.push(dt)}}}var Be;return{vertices:re,features:oe}}}class Le{constructor(J,re,oe,xe,Ee,Be){if(this.vertices=new Array,this.vertexProps=new Array,this.edges=new Array,this.edgeProps=new Array,this.id=J,this.heightRange={min:oe,max:oe},this.safeArea=re,this.constantHeight=oe,this.constantHeight==null&&(this.constantHeight!=null||xe.length!==0)){this.vertices=xe,this.edges=Ee,this.edges=this.edges.filter(He=>He.a<this.vertices.length&&He.b<this.vertices.length&&!s.ab.vec2.exactEquals(this.vertices[He.a].position,this.vertices[He.b].position)),this.heightRange={min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY};for(const He of this.vertices)this.vertexProps.push({dir:s.ab.vec2.fromValues(0,0)}),this.heightRange.min=Math.min(this.heightRange.min,He.height),this.heightRange.max=Math.max(this.heightRange.max,He.height);for(const He of this.edges){const De=this.vertices[He.a].position,Ze=this.vertices[He.b].position,Xe=s.ab.vec2.subtract(s.ab.vec2.create(),Ze,De),Ke=s.ab.vec2.length(Xe),dt=s.ab.vec2.scale(s.ab.vec2.create(),Xe,1/Ke);this.edgeProps.push({vec:Xe,dir:dt,len:Ke});const It=this.vertexProps[He.a].dir,Ct=this.vertexProps[He.b].dir;s.ab.vec2.add(It,It,dt),s.ab.vec2.add(Ct,Ct,dt)}for(const He of this.vertexProps)He.dir[0]===0&&He.dir[1]===0||s.ab.vec2.normalize(He.dir,He.dir);this.tessellate(Be)}}pointElevation(J){if(this.constantHeight!=null)return this.constantHeight;const re=this.getClosestEdge(J);if(re==null)return 0;const[oe,xe]=re;return(1-(Ee=xe))*this.vertices[this.edges[oe].a].height+Ee*this.vertices[this.edges[oe].b].height;var Ee}getClosestEdge(J){if(this.edges.length===0)return;let re=0,oe=Number.POSITIVE_INFINITY,xe=0;const Ee=s.ab.vec2.fromValues(J.x,J.y);for(let Be=0;Be<this.edges.length;Be++){const He=this.edges[Be],De=this.edgeProps[Be].dir,Ze=new s.dZ(Ee,this.edgeProps[Be].dir),Xe=this.vertices[He.a].position,Ke=this.vertices[He.b].position,dt=s.ab.vec2.create(),It=s.ab.vec2.create(),Ct=Ze.intersectsPlane(Xe,this.vertexProps[He.a].dir,dt),Zt=Ze.intersectsPlane(Ke,this.vertexProps[He.b].dir,It);if(!Ct||!Zt)continue;const ei=s.ab.vec2.subtract(s.ab.vec2.create(),It,dt),ti=s.ab.vec2.subtract(s.ab.vec2.create(),Ee,dt),Jt=s.ab.vec2.dot(ei,ei),Ii=Jt>0?s.ab.vec2.dot(ti,ei)/Jt:0,Di=s.aw(Ii,0,1),vi=Math.abs((Ii-Di)*this.edgeProps[Be].len),ki=s.ab.vec2.subtract(s.ab.vec2.create(),Ee,Xe),zi=vi+Math.abs(s.ab.vec2.dot(ki,s.ab.vec2.fromValues(De[1],-De[0])));zi<oe&&(re=Be,oe=zi,xe=Di)}return[re,xe]}tessellate(J){for(let re=this.edges.length-1;re>=0;--re){const oe=this.edges[re].a,xe=this.edges[re].b,{position:Ee,height:Be,extent:He}=this.vertices[oe],{position:De,height:Ze,extent:Xe}=this.vertices[xe],Ke=this.vertexProps[oe].dir,dt=this.vertexProps[xe].dir,It=s.ab.vec3.fromValues(Ee[0]/J,Ee[1]/J,Be),Ct=s.ab.vec3.fromValues(De[0]/J,De[1]/J,Ze),Zt=s.ab.vec3.fromValues(Ke[1],-Ke[0],0);s.ab.vec3.scale(Zt,Zt,He);const ei=s.ab.vec3.fromValues(dt[1],-dt[0],0);if(s.ab.vec3.scale(ei,ei,Xe),this.distSqLines(s.ab.vec3.fromValues(It[0]+.5*Zt[0],It[1]+.5*Zt[1],It[2]+.5*Zt[2]),s.ab.vec3.fromValues(Ct[0]-.5*ei[0],Ct[1]-.5*ei[1],Ct[2]-.5*ei[2]),s.ab.vec3.fromValues(It[0]-.5*Zt[0],It[1]-.5*Zt[1],It[2]-.5*Zt[2]),s.ab.vec3.fromValues(Ct[0]+.5*ei[0],Ct[1]+.5*ei[1],Ct[2]+.5*ei[2]))<=.05*.05)continue;const ti=this.vertices.length,Jt=s.ab.vec2.add(s.ab.vec2.create(),Ee,De);this.vertices.push({position:s.ab.vec2.scale(Jt,Jt,.5),height:.5*(Be+Ze),extent:.5*(He+Xe)});const Ii=s.ab.vec2.add(s.ab.vec2.create(),Ke,dt);this.vertexProps.push({dir:s.ab.vec2.normalize(Ii,Ii)}),this.edges.splice(re,1),this.edgeProps.splice(re,1),this.edges.push({a:oe,b:ti}),this.edges.push({a:ti,b:xe});const Di=s.ab.vec2.subtract(s.ab.vec2.create(),this.vertices[ti].position,Ee),vi=s.ab.vec2.length(Di),ki={vec:Di,dir:s.ab.vec2.scale(s.ab.vec2.create(),Di,1/vi),len:vi};this.edgeProps.push(ki),this.edgeProps.push(ki)}}distSqLines(J,re,oe,xe){const Ee=s.ab.vec3.subtract(s.ab.vec3.create(),re,J),Be=s.ab.vec3.subtract(s.ab.vec3.create(),xe,oe),He=s.ab.vec3.subtract(s.ab.vec3.create(),J,oe),De=s.ab.vec3.dot(Ee,Ee),Ze=s.ab.vec3.dot(Ee,Be),Xe=s.ab.vec3.dot(Ee,He),Ke=s.ab.vec3.dot(Be,Be),dt=s.ab.vec3.dot(Be,He),It=De*Ke-Ze*Ze;if(It===0){const Jt=s.ab.vec3.dot(He,Be)/s.ab.vec3.dot(Be,Be),Ii=s.ab.vec3.lerp(s.ab.vec3.create(),oe,xe,Jt);return s.ab.vec3.squaredDistance(Ii,J)}const Ct=(Ze*dt-Xe*Ke)/It,Zt=(De*dt-Ze*Xe)/It,ei=s.ab.vec3.lerp(s.ab.vec3.create(),J,re,Ct),ti=s.ab.vec3.lerp(s.ab.vec3.create(),oe,xe,Zt);return s.ab.vec3.squaredDistance(ei,ti)}}class $e{static parseFrom(J,re){const oe=ge.parse(J);if(!oe)return[];let{vertices:xe,features:Ee}=oe;const Be=1/s.cc(re);Ee.sort((Xe,Ke)=>Xe.id-Ke.id),xe.sort((Xe,Ke)=>Xe.id-Ke.id||Xe.idx-Ke.idx),xe=xe.filter((Xe,Ke,dt)=>Ke===dt.findIndex(It=>It.id===Xe.id&&It.idx===Xe.idx));const He=new Array;let De=0;const Ze=xe.length;for(const Xe of Ee){if(Xe.constantHeight){He.push(new Le(Xe.id,Xe.bounds,Xe.constantHeight));continue}for(;De!==Ze&&xe[De].id<Xe.id;)De++;if(De===Ze||xe[De].id!==Xe.id)continue;const Ke=new Array,dt=new Array,It=De;for(;De!==Ze&&xe[De].id===Xe.id;){const Ct=xe[De];if(Ke.push({position:Ct.position,height:Ct.height,extent:Ct.extent}),De!==It&&xe[De-1].idx===Ct.idx-1){const Zt=De-It;dt.push({a:Zt-1,b:Zt})}De++}He.push(new Le(Xe.id,Xe.bounds,void 0,Ke,dt,Be))}return He}}s.dV(Le,"ElevationFeature");class Ye{constructor(J){this.tileID=new s.aG(J.tileID.overscaledZ,J.tileID.wrap,J.tileID.canonical.z,J.tileID.canonical.x,J.tileID.canonical.y),this.tileZoom=J.tileZoom,this.uid=J.uid,this.zoom=J.zoom,this.lut=J.lut,this.canonical=J.tileID.canonical,this.pixelRatio=J.pixelRatio,this.tileSize=J.tileSize,this.source=J.source,this.scope=J.scope,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=J.showCollisionBoxes,this.collectResourceTiming=!!J.request&&J.request.collectResourceTiming,this.promoteId=J.promoteId,this.isSymbolTile=J.isSymbolTile,this.tileTransform=s.aQ(J.tileID.canonical,J.projection),this.projection=J.projection,this.worldview=J.worldview,this.localizableLayerIds=J.localizableLayerIds,this.brightness=J.brightness,this.extraShadowCaster=!!J.extraShadowCaster,this.tessellationStep=J.tessellationStep,this.scaleFactor=J.scaleFactor}parse(J,re,oe,xe,Ee){this.status="parsing",this.data=J,this.collisionBoxArray=new s.aW;const Be=new s.d_(Object.keys(J.layers).sort()),He=new s.d$(this.tileID,this.promoteId);He.bucketLayerIDs=[];const De={},Ze=new s.e0(256,256),Xe={featureIndex:He,iconDependencies:{},patternDependencies:{},glyphDependencies:{},lineAtlas:Ze,availableImages:oe,brightness:this.brightness,scaleFactor:this.scaleFactor,elevationFeatures:void 0},Ke=re.familiesBySource[this.source];for(const Jt in Ke){const Ii=J.layers[Jt];if(!Ii)continue;let Di=!1,vi=!1,ki=!1;for(const jr of Ke[Jt])jr[0].type==="symbol"?Di=!0:vi=!0,jr[0].is3D()&&jr[0].type!=="model"&&(ki=!0);if(this.extraShadowCaster&&!ki||this.isSymbolTile===!0&&!Di||this.isSymbolTile===!1&&!vi)continue;Ii.version===1&&s.w(`Vector tile source "${this.source}" layer "${Jt}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const zi=Be.encode(Jt),Dr=[];let Zs=!1;for(let jr=0,qr=0;jr<Ii.length;jr++){const Rn=Ii.feature(jr),hc=He.getId(Rn,Jt);if(this.localizableLayerIds&&this.localizableLayerIds.has(Jt)){const Eo=Rn.properties?Rn.properties.worldview:null;if(this.worldview&&typeof Eo=="string")if(Eo==="all")Rn.properties.$localized=!0;else{if(!Eo.split(",").includes(this.worldview))continue;Rn.properties.$localized=!0,Rn.properties.worldview=this.worldview}}!Zs&&Rn.properties&&Rn.properties.hasOwnProperty(ne)&&(Zs=!0),Dr.push({feature:Rn,id:hc,index:qr,sourceLayerIndex:zi}),qr++}Zs&&J.layers.hasOwnProperty(K)&&(Xe.elevationFeatures=$e.parseFrom(J.layers[K],this.canonical));for(const jr of Ke[Jt]){const qr=jr[0];(!this.extraShadowCaster||qr.is3D()&&qr.type!=="model")&&(this.isSymbolTile!==void 0&&qr.type==="symbol"!==this.isSymbolTile||qr.minzoom&&this.zoom<Math.floor(qr.minzoom)||qr.maxzoom&&this.zoom>=qr.maxzoom||qr.visibility!=="none"&&(St(jr,this.zoom,Xe.brightness,oe),(De[qr.id]=qr.createBucket({index:He.bucketLayerIDs.length,layers:jr,zoom:this.zoom,lut:this.lut,canonical:this.canonical,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:zi,sourceID:this.source,projection:this.projection.spec,tessellationStep:this.tessellationStep})).populate(Dr,Xe,this.tileID.canonical,this.tileTransform),He.bucketLayerIDs.push(jr.map(Rn=>s.aC(Rn.id,Rn.scope)))))}}let dt,It,Ct,Zt;Ze.trim();const ei={type:"maybePrepare",isSymbolTile:this.isSymbolTile,zoom:this.zoom},ti=()=>{if(dt)return this.status="done",Ee(dt);if(this.extraShadowCaster)this.status="done",Ee(null,{buckets:s.bj(De).filter(Jt=>!Jt.isEmpty()),featureIndex:He,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:Xe.brightness,glyphMap:null,iconMap:null,glyphPositions:null});else if(It&&Ct&&Zt){const Jt=new se(It),Ii=new s.e3(Ct,Zt,this.lut);for(const Di in De){const vi=De[Di];vi instanceof s.aX?(St(vi.layers,this.zoom,Xe.brightness,oe),s.e4(vi,It,Jt.positions,Ct,Ii.iconPositions,this.showCollisionBoxes,oe,this.tileID.canonical,this.tileZoom,this.projection,this.scaleFactor,this.pixelRatio,this.brightness)):vi.hasPattern&&(vi instanceof s.b1||vi instanceof s.b2||vi instanceof s.d5)&&(St(vi.layers,this.zoom,Xe.brightness,oe),vi.addFeatures(Xe,this.tileID.canonical,Ii.patternPositions,oe,this.tileTransform,this.brightness))}this.status="done",Ee(null,{buckets:s.bj(De).filter(Di=>!Di.isEmpty()),featureIndex:He,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:Jt.image,lineAtlas:Ze,imageAtlas:Ii,brightness:Xe.brightness})}};if(!this.extraShadowCaster){const Jt=s.e1(Xe.glyphDependencies,vi=>Object.keys(vi).map(Number));Object.keys(Jt).length?xe.send("getGlyphs",{uid:this.uid,stacks:Jt,scope:this.scope},(vi,ki)=>{dt||(dt=vi,It=ki,ti())},void 0,!1,ei):It={};const Ii=Object.keys(Xe.iconDependencies);Ii.length?xe.send("getImages",{icons:Ii,source:this.source,scope:this.scope,tileID:this.tileID,type:"icons"},(vi,ki)=>{if(dt)return;dt=vi;const zi={};Object.values(ki).some(Dr=>Dr.usvg)?this.rasterize(xe,zi,ki,Xe.iconDependencies,()=>{Ct=zi,ti()}):(this.fillImageMap(zi,Xe.iconDependencies,ki),Ct=zi,ti())},void 0,!1,ei):Ct={};const Di=Object.keys(Xe.patternDependencies);Di.length?xe.send("getImages",{icons:Di,source:this.source,scope:this.scope,tileID:this.tileID,type:"patterns"},(vi,ki)=>{if(!dt){dt=vi;const zi={};Object.values(ki).some(Dr=>Dr.usvg)?this.rasterize(xe,zi,ki,Xe.patternDependencies,()=>{Zt=zi,ti()}):(this.fillImageMap(zi,Xe.patternDependencies,ki),Zt=zi,ti())}},void 0,!1,ei):Zt={}}ti()}fillImageMap(J,re,oe){for(const xe in oe){const Ee=re[xe]||[];for(const Be of Ee)oe[Be.id].usvg||(J[Be.serialize()]=oe[Be.id])}}getImageTaskQueue(J,re,oe){const xe={};for(const Ee in re){const Be=oe[Ee]||[];for(const He of Be){const De=He.serialize();re[He.id].usvg?xe[De]||(xe[De]=He):J[De]=re[He.id]}}return xe}rasterize(J,re,oe,xe,Ee){const Be=this.getImageTaskQueue(re,oe,xe);this.rasterizeTask=J.send("rasterizeImages",{scope:this.scope,imageTasks:Be},(He,De)=>{if(!He)for(const Ze in De){const{id:Xe}=s.e2.deserializeFromString(Ze);re[Ze]=Object.assign({},oe[Xe],{data:De[Ze]})}Ee()})}cancelRasterize(){this.rasterizeTask&&this.rasterizeTask.cancel()}}function St(Je,J,re,oe){const xe=new s.a8(J,{brightness:re});for(const Ee of Je)Ee.recalculate(xe,oe)}class Pt extends s.E{constructor(J,re,oe,xe,Ee,Be){super(),this.actor=J,this.layerIndex=re,this.availableImages=oe,this.loadVectorData=Ee||s.aD,this.loading={},this.loaded={},this.deduped=new s.aB(J.scheduler),this.isSpriteLoaded=xe,this.scheduler=J.scheduler,this.brightness=Be}loadTile(J,re){const oe=J.uid,xe=J&&J.request,Ee=xe&&xe.collectResourceTiming,Be=this.loading[oe]=new Ye(J);Be.abort=this.loadVectorData(J,(He,De)=>{const Ze=!this.loading[oe];if(delete this.loading[oe],Be.cancelRasterize(),Ze||He||!De)return Be.status="done",Ze||(this.loaded[oe]=Be),re(He);const Xe=De.rawData,Ke={};De.expires&&(Ke.expires=De.expires),De.cacheControl&&(Ke.cacheControl=De.cacheControl),Be.vectorTile=De.vectorTile||new s.dY.VectorTile(new s.bh(Xe));const dt=()=>{Be.parse(Be.vectorTile,this.layerIndex,this.availableImages,this.actor,(It,Ct)=>{if(It||!Ct)return re(It);const Zt={};if(Ee){const ei=T(xe);ei.length>0&&(Zt.resourceTiming=JSON.parse(JSON.stringify(ei)))}re(null,s.l({rawTileData:Xe.slice(0)},Ct,Ke,Zt))})};this.isSpriteLoaded?dt():this.once("isSpriteLoaded",()=>{this.scheduler?this.scheduler.add(dt,{type:"parseTile",isSymbolTile:J.isSymbolTile,zoom:J.tileZoom}):dt()}),this.loaded=this.loaded||{},this.loaded[oe]=Be})}reloadTile(J,re){const oe=this.loaded,xe=J.uid;if(oe&&oe[xe]){const Ee=oe[xe];Ee.scaleFactor=J.scaleFactor,Ee.showCollisionBoxes=J.showCollisionBoxes,Ee.projection=J.projection,Ee.brightness=J.brightness,Ee.tileTransform=s.aQ(J.tileID.canonical,J.projection),Ee.extraShadowCaster=J.extraShadowCaster,Ee.lut=J.lut;const Be=(He,De)=>{const Ze=Ee.reloadCallback;Ze&&(delete Ee.reloadCallback,Ee.parse(Ee.vectorTile,this.layerIndex,this.availableImages,this.actor,Ze)),re(He,De)};Ee.status==="parsing"?Ee.reloadCallback=Be:Ee.status==="done"&&(Ee.vectorTile?Ee.parse(Ee.vectorTile,this.layerIndex,this.availableImages,this.actor,Be):Be())}else re(null,void 0)}abortTile(J,re){const oe=J.uid,xe=this.loading[oe];xe&&(xe.abort&&xe.abort(),delete this.loading[oe]),re()}removeTile(J,re){const oe=this.loaded,xe=J.uid;oe&&oe[xe]&&delete oe[xe],re()}}class vt{loadTile(J,re){const{uid:oe,encoding:xe,rawImageData:Ee,padding:Be}=J,He=ImageBitmap&&Ee instanceof ImageBitmap?this.getImageData(Ee,Be):Ee;re(null,new s.e5(oe,He,xe,Be<1))}getImageData(J,re){this.offscreenCanvas&&this.offscreenCanvasContext||(this.offscreenCanvas=new OffscreenCanvas(J.width,J.height),this.offscreenCanvasContext=this.offscreenCanvas.getContext("2d",{willReadFrequently:!0})),this.offscreenCanvas.width=J.width,this.offscreenCanvas.height=J.height,this.offscreenCanvasContext.drawImage(J,0,0,J.width,J.height);const oe=this.offscreenCanvasContext.getImageData(-re,-re,J.width+2*re,J.height+2*re);return this.offscreenCanvasContext.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),oe}}s.bg.setPbf(s.bh);class yt{decodeRasterArray({task:J,buffer:re},oe){s.bg.performDecoding(re,J).then(xe=>{oe(null,xe)},xe=>{oe(xe)})}}const hi=s.dY.VectorTileFeature.prototype.toGeoJSON;class Pi{constructor(J){this._feature=J,this.extent=s.ag,this.type=J.type,this.properties=J.tags,"id"in J&&!isNaN(J.id)&&(this.id=parseInt(J.id,10))}loadGeometry(){if(this._feature.type===1){const J=[];for(const re of this._feature.geometry)J.push([new s.P(re[0],re[1])]);return J}{const J=[];for(const re of this._feature.geometry){const oe=[];for(const xe of re)oe.push(new s.P(xe[0],xe[1]));J.push(oe)}return J}}toGeoJSON(J,re,oe){return hi.call(this,J,re,oe)}}class Si{constructor(J){this.layers={_geojsonTileLayer:this},this.name="_geojsonTileLayer",this.extent=s.ag,this.length=J.length,this._features=J}feature(J){return new Pi(this._features[J])}}const qt=64/4096,Br=128;class xr{constructor(){this.features=new Map}clear(){this.features.clear()}load(J=[],re){for(const oe of J){const xe=oe.id;if(xe==null)continue;let Ee=this.features.get(xe);Ee&&this.updateCache(Ee,re),oe.geometry?(Ee=pi(oe),this.updateCache(Ee,re),this.features.set(xe,Ee)):this.features.delete(xe),this.updateCache(Ee,re)}}updateCache(J,re){for(const{canonical:oe,uid:xe}of Object.values(re)){const{z:Ee,x:Be,y:He}=oe;os(J,Math.pow(2,Ee),Be,He)&&delete re[xe]}}getTile(J,re,oe){const xe=Math.pow(2,J),Ee=[];for(const Be of this.features.values())os(Be,xe,re,oe)&&Ee.push(si(Be,xe,re,oe));return{features:Ee}}getFeatures(){return[...this.features.values()]}}function os({minX:Je,minY:J,maxX:re,maxY:oe},xe,Ee,Be){return Je<(Ee+1+qt)/xe&&J<(Be+1+qt)/xe&&re>(Ee-qt)/xe&&oe>(Be-qt)/xe}function pi(Je){const{id:J,geometry:re,properties:oe}=Je;if(!re)return;if(re.type==="GeometryCollection")throw new Error("GeometryCollection not supported in dynamic mode.");const{type:xe,coordinates:Ee}=re,Be={id:J,type:1,geometry:[],tags:oe,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0},He=Be.geometry;if(xe==="Point")mn(Ee,He,Be);else if(xe==="MultiPoint")for(const De of Ee)mn(De,He,Be);else if(xe==="LineString")Be.type=2,as(Ee,He,Be);else if(xe==="MultiLineString")Be.type=2,Kr(Ee,He,Be);else if(xe==="Polygon")Be.type=3,Kr(Ee,He,Be,!0);else{if(xe!=="MultiPolygon")throw new Error("Input data is not a valid GeoJSON object.");Be.type=3;for(const De of Ee)Kr(De,He,Be,!0)}return Be}function mn([Je,J],re,oe){const xe=s.at(Je);let Ee=s.aA(J);Ee=Ee<0?0:Ee>1?1:Ee,re.push(xe,Ee),oe.minX=Math.min(oe.minX,xe),oe.minY=Math.min(oe.minY,Ee),oe.maxX=Math.max(oe.maxX,xe),oe.maxY=Math.max(oe.maxY,Ee)}function as(Je,J,re,oe=!1,xe=!1){const Ee=[];for(const Be of Je)mn(Be,Ee,re);J.push(Ee),oe&&function(Be,He){let De=0;for(let Ze=0,Xe=Be.length,Ke=Xe-2;Ze<Xe;Ke=Ze,Ze+=2)De+=(Be[Ze]-Be[Ke])*(Be[Ze+1]+Be[Ke+1]);if(De>0===He)for(let Ze=0,Xe=Be.length;Ze<Xe/2;Ze+=2){const Ke=Be[Ze],dt=Be[Ze+1];Be[Ze]=Be[Xe-2-Ze],Be[Ze+1]=Be[Xe-1-Ze],Be[Xe-2-Ze]=Ke,Be[Xe-1-Ze]=dt}}(Ee,xe)}function Kr(Je,J,re,oe=!1){for(let xe=0;xe<Je.length;xe++)as(Je[xe],J,re,oe,xe===0)}function si(Je,J,re,oe){const{id:xe,type:Ee,geometry:Be,tags:He}=Je,De=[];if(Ee===1)(function(Ze,Xe,Ke,dt,It){for(let Ct=0;Ct<Ze.length;Ct+=2){const Zt=Math.round(s.ag*(Ze[Ct+0]*Xe-Ke)),ei=Math.round(s.ag*(Ze[Ct+1]*Xe-dt));It.push([Zt,ei])}})(Be,J,re,oe,De);else for(const Ze of Be)$s(Ze,J,re,oe,De);return{id:xe,type:Ee,geometry:De,tags:He}}function $s(Je,J,re,oe,xe){const Be=s.ag+Br;let He;for(let De=0;De<Je.length-2;De+=2){let Ze=Math.round(s.ag*(Je[De+0]*J-re)),Xe=Math.round(s.ag*(Je[De+1]*J-oe)),Ke=Math.round(s.ag*(Je[De+2]*J-re)),dt=Math.round(s.ag*(Je[De+3]*J-oe));const It=Ke-Ze,Ct=dt-Xe;Ze<-128&&Ke<-128||(Ze<-128?(Xe+=Math.round(Ct*((-128-Ze)/It)),Ze=-128):Ke<-128&&(dt=Xe+Math.round(Ct*((-128-Ze)/It)),Ke=-128),Xe<-128&&dt<-128||(Xe<-128?(Ze+=Math.round(It*((-128-Xe)/Ct)),Xe=-128):dt<-128&&(Ke=Ze+Math.round(It*((-128-Xe)/Ct)),dt=-128),Ze>=Be&&Ke>=Be||(Ze>=Be?(Xe+=Math.round(Ct*((Be-Ze)/It)),Ze=Be):Ke>=Be&&(dt=Xe+Math.round(Ct*((Be-Ze)/It)),Ke=Be),Xe>=Be&&dt>=Be||(Xe>=Be?(Ze+=Math.round(It*((Be-Xe)/Ct)),Xe=Be):dt>=Be&&(Ke=Ze+Math.round(It*((Be-Xe)/Ct)),dt=Be),He&&Ze===He[He.length-1][0]&&Xe===He[He.length-1][1]||(He=[[Ze,Xe]],xe.push(He)),He.push([Ke,dt])))))}}var ls,cs,fr,br={exports:{}},kn=function(){if(fr)return br.exports;fr=1;var Je=s.e8(),J=function(){if(cs)return ls;cs=1;var Xe=s.e6(),Ke=s.e7().VectorTileFeature;function dt(Ct,Zt){this.options=Zt||{},this.features=Ct,this.length=Ct.length}function It(Ct,Zt){this.id=typeof Ct.id=="number"?Ct.id:void 0,this.type=Ct.type,this.rawGeometry=Ct.type===1?[Ct.geometry]:Ct.geometry,this.properties=Ct.tags,this.extent=Zt||4096}return ls=dt,dt.prototype.feature=function(Ct){return new It(this.features[Ct],this.options.extent)},It.prototype.loadGeometry=function(){var Ct=this.rawGeometry;this.geometry=[];for(var Zt=0;Zt<Ct.length;Zt++){for(var ei=Ct[Zt],ti=[],Jt=0;Jt<ei.length;Jt++)ti.push(new Xe(ei[Jt][0],ei[Jt][1]));this.geometry.push(ti)}return this.geometry},It.prototype.bbox=function(){this.geometry||this.loadGeometry();for(var Ct=this.geometry,Zt=1/0,ei=-1/0,ti=1/0,Jt=-1/0,Ii=0;Ii<Ct.length;Ii++)for(var Di=Ct[Ii],vi=0;vi<Di.length;vi++){var ki=Di[vi];Zt=Math.min(Zt,ki.x),ei=Math.max(ei,ki.x),ti=Math.min(ti,ki.y),Jt=Math.max(Jt,ki.y)}return[Zt,ti,ei,Jt]},It.prototype.toGeoJSON=Ke.prototype.toGeoJSON,ls}();function re(Xe){var Ke=new Je;return function(dt,It){for(var Ct in dt.layers)It.writeMessage(3,oe,dt.layers[Ct])}(Xe,Ke),Ke.finish()}function oe(Xe,Ke){var dt;Ke.writeVarintField(15,Xe.version||1),Ke.writeStringField(1,Xe.name||""),Ke.writeVarintField(5,Xe.extent||4096);var It={keys:[],values:[],keycache:{},valuecache:{}};for(dt=0;dt<Xe.length;dt++)It.feature=Xe.feature(dt),Ke.writeMessage(2,xe,It);var Ct=It.keys;for(dt=0;dt<Ct.length;dt++)Ke.writeStringField(3,Ct[dt]);var Zt=It.values;for(dt=0;dt<Zt.length;dt++)Ke.writeMessage(4,Ze,Zt[dt])}function xe(Xe,Ke){var dt=Xe.feature;dt.id!==void 0&&Ke.writeVarintField(1,dt.id),Ke.writeMessage(2,Ee,Xe),Ke.writeVarintField(3,dt.type),Ke.writeMessage(4,De,dt)}function Ee(Xe,Ke){var dt=Xe.feature,It=Xe.keys,Ct=Xe.values,Zt=Xe.keycache,ei=Xe.valuecache;for(var ti in dt.properties){var Jt=dt.properties[ti],Ii=Zt[ti];if(Jt!==null){Ii===void 0&&(It.push(ti),Zt[ti]=Ii=It.length-1),Ke.writeVarint(Ii);var Di=typeof Jt;Di!=="string"&&Di!=="boolean"&&Di!=="number"&&(Jt=JSON.stringify(Jt));var vi=Di+":"+Jt,ki=ei[vi];ki===void 0&&(Ct.push(Jt),ei[vi]=ki=Ct.length-1),Ke.writeVarint(ki)}}}function Be(Xe,Ke){return(Ke<<3)+(7&Xe)}function He(Xe){return Xe<<1^Xe>>31}function De(Xe,Ke){for(var dt=Xe.loadGeometry(),It=Xe.type,Ct=0,Zt=0,ei=dt.length,ti=0;ti<ei;ti++){var Jt=dt[ti],Ii=1;It===1&&(Ii=Jt.length),Ke.writeVarint(Be(1,Ii));for(var Di=It===3?Jt.length-1:Jt.length,vi=0;vi<Di;vi++){vi===1&&It!==1&&Ke.writeVarint(Be(2,Di-1));var ki=Jt[vi].x-Ct,zi=Jt[vi].y-Zt;Ke.writeVarint(He(ki)),Ke.writeVarint(He(zi)),Ct+=ki,Zt+=zi}It===3&&Ke.writeVarint(Be(7,1))}}function Ze(Xe,Ke){var dt=typeof Xe;dt==="string"?Ke.writeStringField(1,Xe):dt==="boolean"?Ke.writeBooleanField(7,Xe):dt==="number"&&(Xe%1!=0?Ke.writeDoubleField(3,Xe):Xe<0?Ke.writeSVarintField(6,Xe):Ke.writeVarintField(5,Xe))}return br.exports=re,br.exports.fromVectorTileJs=re,br.exports.fromGeojsonVt=function(Xe,Ke){Ke=Ke||{};var dt={};for(var It in Xe)dt[It]=new J(Xe[It].features,Ke),dt[It].name=It,dt[It].version=Ke.version,dt[It].extent=Ke.extent;return re({layers:dt})},br.exports.GeoJSONWrapper=J,br.exports}(),Re=s.e9(kn);const sr={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:Je=>Je},Xn=Math.fround||(_n=new Float32Array(1),Je=>(_n[0]=+Je,_n[0]));var _n;const At=3,Wr=5,gn=6;class Zn{constructor(J){this.options=Object.assign(Object.create(sr),J),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(J){const{log:re,minZoom:oe,maxZoom:xe}=this.options;re&&console.time("total time");const Ee=`prepare ${J.length} points`;re&&console.time(Ee),this.points=J;const Be=[];for(let De=0;De<J.length;De++){const Ze=J[De];if(!Ze.geometry)continue;const[Xe,Ke]=Ze.geometry.coordinates,dt=Xn(Ln(Xe)),It=Xn(Ws(Ke));Be.push(dt,It,1/0,De,-1,1),this.options.reduce&&Be.push(0)}let He=this.trees[xe+1]=this._createTree(Be);re&&console.timeEnd(Ee);for(let De=xe;De>=oe;De--){const Ze=+Date.now();He=this.trees[De]=this._createTree(this._cluster(He,De)),re&&console.log("z%d: %d clusters in %dms",De,He.numItems,+Date.now()-Ze)}return re&&console.timeEnd("total time"),this}getClusters(J,re){let oe=((J[0]+180)%360+360)%360-180;const xe=Math.max(-90,Math.min(90,J[1]));let Ee=J[2]===180?180:((J[2]+180)%360+360)%360-180;const Be=Math.max(-90,Math.min(90,J[3]));if(J[2]-J[0]>=360)oe=-180,Ee=180;else if(oe>Ee){const Ke=this.getClusters([oe,xe,180,Be],re),dt=this.getClusters([-180,xe,Ee,Be],re);return Ke.concat(dt)}const He=this.trees[this._limitZoom(re)],De=He.range(Ln(oe),Ws(Be),Ln(Ee),Ws(xe)),Ze=He.data,Xe=[];for(const Ke of De){const dt=this.stride*Ke;Xe.push(Ze[dt+Wr]>1?Ti(Ze,dt,this.clusterProps):this.points[Ze[dt+At]])}return Xe}getChildren(J){const re=this._getOriginId(J),oe=this._getOriginZoom(J),xe="No cluster with the specified id.",Ee=this.trees[oe];if(!Ee)throw new Error(xe);const Be=Ee.data;if(re*this.stride>=Be.length)throw new Error(xe);const He=this.options.radius/(this.options.extent*Math.pow(2,oe-1)),De=Ee.within(Be[re*this.stride],Be[re*this.stride+1],He),Ze=[];for(const Xe of De){const Ke=Xe*this.stride;Be[Ke+4]===J&&Ze.push(Be[Ke+Wr]>1?Ti(Be,Ke,this.clusterProps):this.points[Be[Ke+At]])}if(Ze.length===0)throw new Error(xe);return Ze}getLeaves(J,re,oe){const xe=[];return this._appendLeaves(xe,J,re=re||10,oe=oe||0,0),xe}getTile(J,re,oe){const xe=this.trees[this._limitZoom(J)],Ee=Math.pow(2,J),{extent:Be,radius:He}=this.options,De=He/Be,Ze=(oe-De)/Ee,Xe=(oe+1+De)/Ee,Ke={features:[]};return this._addTileFeatures(xe.range((re-De)/Ee,Ze,(re+1+De)/Ee,Xe),xe.data,re,oe,Ee,Ke),re===0&&this._addTileFeatures(xe.range(1-De/Ee,Ze,1,Xe),xe.data,Ee,oe,Ee,Ke),re===Ee-1&&this._addTileFeatures(xe.range(0,Ze,De/Ee,Xe),xe.data,-1,oe,Ee,Ke),Ke.features.length?Ke:null}getClusterExpansionZoom(J){let re=this._getOriginZoom(J)-1;for(;re<=this.options.maxZoom;){const oe=this.getChildren(J);if(re++,oe.length!==1)break;J=oe[0].properties.cluster_id}return re}_appendLeaves(J,re,oe,xe,Ee){const Be=this.getChildren(re);for(const He of Be){const De=He.properties;if(De&&De.cluster?Ee+De.point_count<=xe?Ee+=De.point_count:Ee=this._appendLeaves(J,De.cluster_id,oe,xe,Ee):Ee<xe?Ee++:J.push(He),J.length===oe)break}return Ee}_createTree(J){const re=new s.bE(J.length/this.stride|0,this.options.nodeSize,Float32Array);for(let oe=0;oe<J.length;oe+=this.stride)re.add(J[oe],J[oe+1]);return re.finish(),re.data=J,re}_addTileFeatures(J,re,oe,xe,Ee,Be){for(const He of J){const De=He*this.stride,Ze=re[De+Wr]>1;let Xe,Ke,dt;if(Ze)Xe=kr(re,De,this.clusterProps),Ke=re[De],dt=re[De+1];else{const Zt=this.points[re[De+At]];Xe=Zt.properties;const[ei,ti]=Zt.geometry.coordinates;Ke=Ln(ei),dt=Ws(ti)}const It={type:1,geometry:[[Math.round(this.options.extent*(Ke*Ee-oe)),Math.round(this.options.extent*(dt*Ee-xe))]],tags:Xe};let Ct;Ct=Ze||this.options.generateId?re[De+At]:this.points[re[De+At]].id,Ct!==void 0&&(It.id=Ct),Be.features.push(It)}}_limitZoom(J){return Math.max(this.options.minZoom,Math.min(Math.floor(+J),this.options.maxZoom+1))}_cluster(J,re){const{radius:oe,extent:xe,reduce:Ee,minPoints:Be}=this.options,He=oe/(xe*Math.pow(2,re)),De=J.data,Ze=[],Xe=this.stride;for(let Ke=0;Ke<De.length;Ke+=Xe){if(De[Ke+2]<=re)continue;De[Ke+2]=re;const dt=De[Ke],It=De[Ke+1],Ct=J.within(De[Ke],De[Ke+1],He),Zt=De[Ke+Wr];let ei=Zt;for(const ti of Ct){const Jt=ti*Xe;De[Jt+2]>re&&(ei+=De[Jt+Wr])}if(ei>Zt&&ei>=Be){let ti,Jt=dt*Zt,Ii=It*Zt,Di=-1;const vi=(Ke/Xe<<5)+(re+1)+this.points.length;for(const ki of Ct){const zi=ki*Xe;if(De[zi+2]<=re)continue;De[zi+2]=re;const Dr=De[zi+Wr];Jt+=De[zi]*Dr,Ii+=De[zi+1]*Dr,De[zi+4]=vi,Ee&&(ti||(ti=this._map(De,Ke,!0),Di=this.clusterProps.length,this.clusterProps.push(ti)),Ee(ti,this._map(De,zi)))}De[Ke+4]=vi,Ze.push(Jt/ei,Ii/ei,1/0,vi,-1,ei),Ee&&Ze.push(Di)}else{for(let ti=0;ti<Xe;ti++)Ze.push(De[Ke+ti]);if(ei>1)for(const ti of Ct){const Jt=ti*Xe;if(!(De[Jt+2]<=re)){De[Jt+2]=re;for(let Ii=0;Ii<Xe;Ii++)Ze.push(De[Jt+Ii])}}}}return Ze}_getOriginId(J){return J-this.points.length>>5}_getOriginZoom(J){return(J-this.points.length)%32}_map(J,re,oe){if(J[re+Wr]>1){const Be=this.clusterProps[J[re+gn]];return oe?Object.assign({},Be):Be}const xe=this.points[J[re+At]].properties,Ee=this.options.map(xe);return oe&&Ee===xe?Object.assign({},Ee):Ee}}function Ti(Je,J,re){return{type:"Feature",id:Je[J+At],properties:kr(Je,J,re),geometry:{type:"Point",coordinates:[(oe=Je[J],360*(oe-.5)),bo(Je[J+1])]}};var oe}function kr(Je,J,re){const oe=Je[J+Wr],xe=oe>=1e4?`${Math.round(oe/1e3)}k`:oe>=1e3?Math.round(oe/100)/10+"k":oe,Ee=Je[J+gn],Be=Ee===-1?{}:Object.assign({},re[Ee]);return Object.assign(Be,{cluster:!0,cluster_id:Je[J+At],point_count:oe,point_count_abbreviated:xe})}function Ln(Je){return Je/360+.5}function Ws(Je){const J=Math.sin(Je*Math.PI/180),re=.5-.25*Math.log((1+J)/(1-J))/Math.PI;return re<0?0:re>1?1:re}function bo(Je){const J=(180-360*Je)*Math.PI/180;return 360*Math.atan(Math.exp(J))/Math.PI-90}function wo(Je,J,re,oe){let xe=oe;const Ee=J+(re-J>>1);let Be,He=re-J;const De=Je[J],Ze=Je[J+1],Xe=Je[re],Ke=Je[re+1];for(let dt=J+3;dt<re;dt+=3){const It=yi(Je[dt],Je[dt+1],De,Ze,Xe,Ke);if(It>xe)Be=dt,xe=It;else if(It===xe){const Ct=Math.abs(dt-Ee);Ct<He&&(Be=dt,He=Ct)}}xe>oe&&(Be-J>3&&wo(Je,J,Be,oe),Je[Be+2]=xe,re-Be>3&&wo(Je,Be,re,oe))}function yi(Je,J,re,oe,xe,Ee){let Be=xe-re,He=Ee-oe;if(Be!==0||He!==0){const De=((Je-re)*Be+(J-oe)*He)/(Be*Be+He*He);De>1?(re=xe,oe=Ee):De>0&&(re+=Be*De,oe+=He*De)}return Be=Je-re,He=J-oe,Be*Be+He*He}function ws(Je,J,re,oe){const xe={id:Je??null,type:J,geometry:re,tags:oe,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};if(J==="Point"||J==="MultiPoint"||J==="LineString")us(xe,re);else if(J==="Polygon")us(xe,re[0]);else if(J==="MultiLineString")for(const Ee of re)us(xe,Ee);else if(J==="MultiPolygon")for(const Ee of re)us(xe,Ee[0]);return xe}function us(Je,J){for(let re=0;re<J.length;re+=3)Je.minX=Math.min(Je.minX,J[re]),Je.minY=Math.min(Je.minY,J[re+1]),Je.maxX=Math.max(Je.maxX,J[re]),Je.maxY=Math.max(Je.maxY,J[re+1])}function Cn(Je,J,re,oe){if(!J.geometry)return;const xe=J.geometry.coordinates;if(xe&&xe.length===0)return;const Ee=J.geometry.type,Be=Math.pow(re.tolerance/((1<<re.maxZoom)*re.extent),2);let He=[],De=J.id;if(re.promoteId?De=J.properties[re.promoteId]:re.generateId&&(De=oe||0),Ee==="Point")Mn(xe,He);else if(Ee==="MultiPoint")for(const Ze of xe)Mn(Ze,He);else if(Ee==="LineString")Ao(xe,He,Be,!1);else if(Ee==="MultiLineString"){if(re.lineMetrics){for(const Ze of xe)He=[],Ao(Ze,He,Be,!1),Je.push(ws(De,"LineString",He,J.properties));return}Aa(xe,He,Be,!1)}else if(Ee==="Polygon")Aa(xe,He,Be,!0);else{if(Ee!=="MultiPolygon"){if(Ee==="GeometryCollection"){for(const Ze of J.geometry.geometries)Cn(Je,{id:De,geometry:Ze,properties:J.properties},re,oe);return}throw new Error("Input data is not a valid GeoJSON object.")}for(const Ze of xe){const Xe=[];Aa(Ze,Xe,Be,!0),He.push(Xe)}}Je.push(ws(De,Ee,He,J.properties))}function Mn(Je,J){J.push(nl(Je[0]),sl(Je[1]),0)}function Ao(Je,J,re,oe){let xe,Ee,Be=0;for(let De=0;De<Je.length;De++){const Ze=nl(Je[De][0]),Xe=sl(Je[De][1]);J.push(Ze,Xe,0),De>0&&(Be+=oe?(xe*Xe-Ze*Ee)/2:Math.sqrt(Math.pow(Ze-xe,2)+Math.pow(Xe-Ee,2))),xe=Ze,Ee=Xe}const He=J.length-3;J[2]=1,wo(J,0,He,re),J[He+2]=1,J.size=Math.abs(Be),J.start=0,J.end=J.size}function Aa(Je,J,re,oe){for(let xe=0;xe<Je.length;xe++){const Ee=[];Ao(Je[xe],Ee,re,oe),J.push(Ee)}}function nl(Je){return Je/360+.5}function sl(Je){const J=Math.sin(Je*Math.PI/180),re=.5-.25*Math.log((1+J)/(1-J))/Math.PI;return re<0?0:re>1?1:re}function Nn(Je,J,re,oe,xe,Ee,Be,He){if(oe/=J,Ee>=(re/=J)&&Be<oe)return Je;if(Be<re||Ee>=oe)return null;const De=[];for(const Ze of Je){const Xe=Ze.geometry;let Ke=Ze.type;const dt=xe===0?Ze.minX:Ze.minY,It=xe===0?Ze.maxX:Ze.maxY;if(dt>=re&&It<oe){De.push(Ze);continue}if(It<re||dt>=oe)continue;let Ct=[];if(Ke==="Point"||Ke==="MultiPoint")ol(Xe,Ct,re,oe,xe);else if(Ke==="LineString")al(Xe,Ct,re,oe,xe,!1,He.lineMetrics);else if(Ke==="MultiLineString")Ta(Xe,Ct,re,oe,xe,!1);else if(Ke==="Polygon")Ta(Xe,Ct,re,oe,xe,!0);else if(Ke==="MultiPolygon")for(const Zt of Xe){const ei=[];Ta(Zt,ei,re,oe,xe,!0),ei.length&&Ct.push(ei)}if(Ct.length){if(He.lineMetrics&&Ke==="LineString"){for(const Zt of Ct)De.push(ws(Ze.id,Ke,Zt,Ze.tags));continue}Ke!=="LineString"&&Ke!=="MultiLineString"||(Ct.length===1?(Ke="LineString",Ct=Ct[0]):Ke="MultiLineString"),Ke!=="Point"&&Ke!=="MultiPoint"||(Ke=Ct.length===3?"Point":"MultiPoint"),De.push(ws(Ze.id,Ke,Ct,Ze.tags))}}return De.length?De:null}function ol(Je,J,re,oe,xe){for(let Ee=0;Ee<Je.length;Ee+=3){const Be=Je[Ee+xe];Be>=re&&Be<=oe&&mi(J,Je[Ee],Je[Ee+1],Je[Ee+2])}}function al(Je,J,re,oe,xe,Ee,Be){let He=hs(Je);const De=xe===0?qs:Lu;let Ze,Xe,Ke=Je.start;for(let ei=0;ei<Je.length-3;ei+=3){const ti=Je[ei],Jt=Je[ei+1],Ii=Je[ei+2],Di=Je[ei+3],vi=Je[ei+4],ki=xe===0?ti:Jt,zi=xe===0?Di:vi;let Dr=!1;Be&&(Ze=Math.sqrt(Math.pow(ti-Di,2)+Math.pow(Jt-vi,2))),ki<re?zi>re&&(Xe=De(He,ti,Jt,Di,vi,re),Be&&(He.start=Ke+Ze*Xe)):ki>oe?zi<oe&&(Xe=De(He,ti,Jt,Di,vi,oe),Be&&(He.start=Ke+Ze*Xe)):mi(He,ti,Jt,Ii),zi<re&&ki>=re&&(Xe=De(He,ti,Jt,Di,vi,re),Dr=!0),zi>oe&&ki<=oe&&(Xe=De(He,ti,Jt,Di,vi,oe),Dr=!0),!Ee&&Dr&&(Be&&(He.end=Ke+Ze*Xe),J.push(He),He=hs(Je)),Be&&(Ke+=Ze)}let dt=Je.length-3;const It=Je[dt],Ct=Je[dt+1],Zt=xe===0?It:Ct;Zt>=re&&Zt<=oe&&mi(He,It,Ct,Je[dt+2]),dt=He.length-3,Ee&&dt>=3&&(He[dt]!==He[0]||He[dt+1]!==He[1])&&mi(He,He[0],He[1],He[2]),He.length&&J.push(He)}function hs(Je){const J=[];return J.size=Je.size,J.start=Je.start,J.end=Je.end,J}function Ta(Je,J,re,oe,xe,Ee){for(const Be of Je)al(Be,J,re,oe,xe,Ee,!1)}function mi(Je,J,re,oe){Je.push(J,re,oe)}function qs(Je,J,re,oe,xe,Ee){const Be=(Ee-J)/(oe-J);return mi(Je,Ee,re+(xe-re)*Be,1),Be}function Lu(Je,J,re,oe,xe,Ee){const Be=(Ee-re)/(xe-re);return mi(Je,J+(oe-J)*Be,Ee,1),Be}function Yn(Je,J){const re=[];for(let oe=0;oe<Je.length;oe++){const xe=Je[oe],Ee=xe.type;let Be;if(Ee==="Point"||Ee==="MultiPoint"||Ee==="LineString")Be=To(xe.geometry,J);else if(Ee==="MultiLineString"||Ee==="Polygon"){Be=[];for(const He of xe.geometry)Be.push(To(He,J))}else if(Ee==="MultiPolygon"){Be=[];for(const He of xe.geometry){const De=[];for(const Ze of He)De.push(To(Ze,J));Be.push(De)}}re.push(ws(xe.id,Ee,Be,xe.tags))}return re}function To(Je,J){const re=[];re.size=Je.size,Je.start!==void 0&&(re.start=Je.start,re.end=Je.end);for(let oe=0;oe<Je.length;oe+=3)re.push(Je[oe]+J,Je[oe+1],Je[oe+2]);return re}function ll(Je,J){if(Je.transformed)return Je;const re=1<<Je.z,oe=Je.x,xe=Je.y;for(const Ee of Je.features){const Be=Ee.geometry,He=Ee.type;if(Ee.geometry=[],He===1)for(let De=0;De<Be.length;De+=2)Ee.geometry.push(cl(Be[De],Be[De+1],J,re,oe,xe));else for(let De=0;De<Be.length;De++){const Ze=[];for(let Xe=0;Xe<Be[De].length;Xe+=2)Ze.push(cl(Be[De][Xe],Be[De][Xe+1],J,re,oe,xe));Ee.geometry.push(Ze)}}return Je.transformed=!0,Je}function cl(Je,J,re,oe,xe,Ee){return[Math.round(re*(Je*oe-xe)),Math.round(re*(J*oe-Ee))]}function ul(Je,J,re,oe,xe){const Ee=J===xe.maxZoom?0:xe.tolerance/((1<<J)*xe.extent),Be={features:[],numPoints:0,numSimplified:0,numFeatures:Je.length,source:null,x:re,y:oe,z:J,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0};for(const He of Je)Nu(Be,He,Ee,xe);return Be}function Nu(Je,J,re,oe){const xe=J.geometry,Ee=J.type,Be=[];if(Je.minX=Math.min(Je.minX,J.minX),Je.minY=Math.min(Je.minY,J.minY),Je.maxX=Math.max(Je.maxX,J.maxX),Je.maxY=Math.max(Je.maxY,J.maxY),Ee==="Point"||Ee==="MultiPoint")for(let He=0;He<xe.length;He+=3)Be.push(xe[He],xe[He+1]),Je.numPoints++,Je.numSimplified++;else if(Ee==="LineString")hl(Be,xe,Je,re,!1,!1);else if(Ee==="MultiLineString"||Ee==="Polygon")for(let He=0;He<xe.length;He++)hl(Be,xe[He],Je,re,Ee==="Polygon",He===0);else if(Ee==="MultiPolygon")for(let He=0;He<xe.length;He++){const De=xe[He];for(let Ze=0;Ze<De.length;Ze++)hl(Be,De[Ze],Je,re,!0,Ze===0)}if(Be.length){let He=J.tags||null;if(Ee==="LineString"&&oe.lineMetrics){He={};for(const Ze in J.tags)He[Ze]=J.tags[Ze];He.mapbox_clip_start=xe.start/xe.size,He.mapbox_clip_end=xe.end/xe.size}const De={geometry:Be,type:Ee==="Polygon"||Ee==="MultiPolygon"?3:Ee==="LineString"||Ee==="MultiLineString"?2:1,tags:He};J.id!==null&&(De.id=J.id),Je.features.push(De)}}function hl(Je,J,re,oe,xe,Ee){const Be=oe*oe;if(oe>0&&J.size<(xe?Be:oe))return void(re.numPoints+=J.length/3);const He=[];for(let De=0;De<J.length;De+=3)(oe===0||J[De+2]>Be)&&(re.numSimplified++,He.push(J[De],J[De+1])),re.numPoints++;xe&&function(De,Ze){let Xe=0;for(let Ke=0,dt=De.length,It=dt-2;Ke<dt;It=Ke,Ke+=2)Xe+=(De[Ke]-De[It])*(De[Ke+1]+De[It+1]);if(Xe>0===Ze)for(let Ke=0,dt=De.length;Ke<dt/2;Ke+=2){const It=De[Ke],Ct=De[Ke+1];De[Ke]=De[dt-2-Ke],De[Ke+1]=De[dt-1-Ke],De[dt-2-Ke]=It,De[dt-1-Ke]=Ct}}(He,Ee),Je.push(He)}const zu={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0};class Uu{constructor(J,re){const oe=(re=this.options=function(Ee,Be){for(const He in Be)Ee[He]=Be[He];return Ee}(Object.create(zu),re)).debug;if(oe&&console.time("preprocess data"),re.maxZoom<0||re.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(re.promoteId&&re.generateId)throw new Error("promoteId and generateId cannot be used together.");let xe=function(Ee,Be){const He=[];if(Ee.type==="FeatureCollection")for(let De=0;De<Ee.features.length;De++)Cn(He,Ee.features[De],Be,De);else Cn(He,Ee.type==="Feature"?Ee:{geometry:Ee},Be);return He}(J,re);this.tiles={},this.tileCoords=[],oe&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",re.indexMaxZoom,re.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),xe=function(Ee,Be){const He=Be.buffer/Be.extent;let De=Ee;const Ze=Nn(Ee,1,-1-He,He,0,-1,2,Be),Xe=Nn(Ee,1,1-He,2+He,0,-1,2,Be);return(Ze||Xe)&&(De=Nn(Ee,1,-He,1+He,0,-1,2,Be)||[],Ze&&(De=Yn(Ze,1).concat(De)),Xe&&(De=De.concat(Yn(Xe,-1)))),De}(xe,re),xe.length&&this.splitTile(xe,0,0,0),oe&&(xe.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}splitTile(J,re,oe,xe,Ee,Be,He){const De=[J,re,oe,xe],Ze=this.options,Xe=Ze.debug;for(;De.length;){xe=De.pop(),oe=De.pop(),re=De.pop(),J=De.pop();const Ke=1<<re,dt=Vr(re,oe,xe);let It=this.tiles[dt];if(!It&&(Xe>1&&console.time("creation"),It=this.tiles[dt]=ul(J,re,oe,xe,Ze),this.tileCoords.push({z:re,x:oe,y:xe}),Xe)){Xe>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",re,oe,xe,It.numFeatures,It.numPoints,It.numSimplified),console.timeEnd("creation"));const Dr=`z${re}`;this.stats[Dr]=(this.stats[Dr]||0)+1,this.total++}if(It.source=J,Ee==null){if(re===Ze.indexMaxZoom||It.numPoints<=Ze.indexMaxPoints)continue}else{if(re===Ze.maxZoom||re===Ee)continue;if(Ee!=null){const Dr=Ee-re;if(oe!==Be>>Dr||xe!==He>>Dr)continue}}if(It.source=null,J.length===0)continue;Xe>1&&console.time("clipping");const Ct=.5*Ze.buffer/Ze.extent,Zt=.5-Ct,ei=.5+Ct,ti=1+Ct;let Jt=null,Ii=null,Di=null,vi=null,ki=Nn(J,Ke,oe-Ct,oe+ei,0,It.minX,It.maxX,Ze),zi=Nn(J,Ke,oe+Zt,oe+ti,0,It.minX,It.maxX,Ze);J=null,ki&&(Jt=Nn(ki,Ke,xe-Ct,xe+ei,1,It.minY,It.maxY,Ze),Ii=Nn(ki,Ke,xe+Zt,xe+ti,1,It.minY,It.maxY,Ze),ki=null),zi&&(Di=Nn(zi,Ke,xe-Ct,xe+ei,1,It.minY,It.maxY,Ze),vi=Nn(zi,Ke,xe+Zt,xe+ti,1,It.minY,It.maxY,Ze),zi=null),Xe>1&&console.timeEnd("clipping"),De.push(Jt||[],re+1,2*oe,2*xe),De.push(Ii||[],re+1,2*oe,2*xe+1),De.push(Di||[],re+1,2*oe+1,2*xe),De.push(vi||[],re+1,2*oe+1,2*xe+1)}}getTile(J,re,oe){J=+J,re=+re,oe=+oe;const xe=this.options,{extent:Ee,debug:Be}=xe;if(J<0||J>24)return null;const He=1<<J,De=Vr(J,re=re+He&He-1,oe);if(this.tiles[De])return ll(this.tiles[De],Ee);Be>1&&console.log("drilling down to z%d-%d-%d",J,re,oe);let Ze,Xe=J,Ke=re,dt=oe;for(;!Ze&&Xe>0;)Xe--,Ke>>=1,dt>>=1,Ze=this.tiles[Vr(Xe,Ke,dt)];return Ze&&Ze.source?(Be>1&&(console.log("found parent tile z%d-%d-%d",Xe,Ke,dt),console.time("drilling down")),this.splitTile(Ze.source,Xe,Ke,dt,J,re,oe),Be>1&&console.timeEnd("drilling down"),this.tiles[De]?ll(this.tiles[De],Ee):null):null}}function Vr(Je,J,re){return 32*((1<<Je)*re+J)+Je}function cc(Je,J){const re=Je.tileID.canonical;if(!this._geoJSONIndex)return void J(null,null);const oe=this._geoJSONIndex.getTile(re.z,re.x,re.y);if(!oe)return void J(null,null);const xe=new Si(oe.features);let Ee=Re(xe);Ee.byteOffset===0&&Ee.byteLength===Ee.buffer.byteLength||(Ee=new Uint8Array(Ee)),J(null,{vectorTile:xe,rawData:Ee.buffer})}class Vu extends Pt{constructor(J,re,oe,xe,Ee,Be){super(J,re,oe,xe,cc,Be),Ee&&(this.loadGeoJSON=Ee),this._dynamicIndex=new xr}loadData(J,re){const oe=J&&J.request,xe=oe&&oe.collectResourceTiming;this.loadGeoJSON(J,(Ee,Be)=>{if(Ee||!Be)return re(Ee);if(typeof Be!="object")return re(new Error(`Input data given to '${J.source}' is not a valid GeoJSON object.`));{try{if(J.filter){const De=s.U(J.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if(De.result==="error")throw new Error(De.value.map(Ze=>`${Ze.key}: ${Ze.message}`).join(", "));Be.features=Be.features.filter(Ze=>De.value.evaluate({zoom:0},Ze))}J.dynamic?(Be.type==="Feature"&&(Be={type:"FeatureCollection",features:[Be]}),J.append||(this._dynamicIndex.clear(),this.loaded={}),this._dynamicIndex.load(Be.features,this.loaded),J.cluster&&(Be.features=this._dynamicIndex.getFeatures())):this.loaded={},this._geoJSONIndex=J.cluster?new Zn(function({superclusterOptions:De,clusterProperties:Ze}){if(!Ze||!De)return De;const Xe={},Ke={},dt={accumulated:null,zoom:0},It={properties:null},Ct=Object.keys(Ze);for(const Zt of Ct){const[ei,ti]=Ze[Zt],Jt=s.U(ti),Ii=s.U(typeof ei=="string"?[ei,["accumulated"],["get",Zt]]:ei);Xe[Zt]=Jt.value,Ke[Zt]=Ii.value}return De.map=Zt=>{It.properties=Zt;const ei={};for(const ti of Ct)ei[ti]=Xe[ti].evaluate(dt,It);return ei},De.reduce=(Zt,ei)=>{It.properties=ei;for(const ti of Ct)dt.accumulated=Zt[ti],Zt[ti]=Ke[ti].evaluate(dt,It)},De}(J)).load(Be.features):J.dynamic?this._dynamicIndex:function(De,Ze){return new Uu(De,Ze)}(Be,J.geojsonVtOptions)}catch(De){return re(De)}const He={};if(xe){const De=T(oe);De&&(He.resourceTiming={},He.resourceTiming[J.source]=JSON.parse(JSON.stringify(De)))}re(null,He)}})}reloadTile(J,re){const oe=this.loaded;return oe&&oe[J.uid]?J.partial?re(null,void 0):super.reloadTile(J,re):this.loadTile(J,re)}loadGeoJSON(J,re){if(J.request)s.n(J.request,re);else{if(typeof J.data!="string")return re(new Error(`Input data given to '${J.source}' is not a valid GeoJSON object.`));try{return re(null,JSON.parse(J.data))}catch{return re(new Error(`Input data given to '${J.source}' is not a valid GeoJSON object.`))}}}getClusterExpansionZoom(J,re){try{re(null,this._geoJSONIndex.getClusterExpansionZoom(J.clusterId))}catch(oe){re(oe)}}getClusterChildren(J,re){try{re(null,this._geoJSONIndex.getChildren(J.clusterId))}catch(oe){re(oe)}}getClusterLeaves(J,re){try{re(null,this._geoJSONIndex.getLeaves(J.clusterId,J.limit,J.offset))}catch(oe){re(oe)}}}class uc{constructor(J,re){this.tileID=new s.aG(J.tileID.overscaledZ,J.tileID.wrap,J.tileID.canonical.z,J.tileID.canonical.x,J.tileID.canonical.y),this.tileZoom=J.tileZoom,this.uid=J.uid,this.zoom=J.zoom,this.canonical=J.tileID.canonical,this.pixelRatio=J.pixelRatio,this.tileSize=J.tileSize,this.source=J.source,this.overscaling=this.tileID.overscaleFactor(),this.projection=J.projection,this.brightness=re}parse(J,re,oe,xe){this.status="parsing";const Ee=new s.aG(oe.tileID.overscaledZ,oe.tileID.wrap,oe.tileID.canonical.z,oe.tileID.canonical.x,oe.tileID.canonical.y),Be=[],He=re.familiesBySource[oe.source],De=new s.d$(Ee,oe.promoteId);return De.bucketLayerIDs=[],De.is3DTile=!0,s.ea(J).then(Ze=>{if(!Ze)return xe(new Error("Could not parse tile"));const Xe=s.eb(Ze,1/s.cc(oe.tileID.canonical)),Ke=Ze.json.extensionsUsed&&Ze.json.extensionsUsed.includes("MAPBOX_mesh_features")||Ze.json.asset.extras&&Ze.json.asset.extras.MAPBOX_mesh_features,dt=Ze.json.extensionsUsed&&Ze.json.extensionsUsed.includes("EXT_meshopt_compression"),It=new s.a8(this.zoom,{brightness:this.brightness});for(const Ct in He)for(const Zt of He[Ct]){const ei=Zt[0];De.bucketLayerIDs.push(Zt.map(Jt=>s.aC(Jt.id,Jt.scope))),ei.recalculate(It,[]);const ti=new s.ec(Zt,Xe,Ee,Ke,dt,this.brightness,De);Ke||(ti.needsUpload=!0),Be.push(ti),ti.evaluate(ei)}this.status="done",xe(null,{buckets:Be,featureIndex:De,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:null})}).catch(Ze=>xe(new Error(Ze.message)))}}class ln{constructor(J,re,oe,xe,Ee,Be){this.actor=J,this.layerIndex=re,this.availableImages=oe,this.brightness=Be,this.loading={},this.loaded={}}loadTile(J,re){const oe=J.uid,xe=this.loading[oe]=new uc(J,this.brightness);s.bi(J.request,(Ee,Be)=>{const He=!this.loading[oe];return delete this.loading[oe],He||Ee?(xe.status="done",He||(this.loaded[oe]=xe),re(Ee)):Be&&Be.byteLength!==0?void xe.parse(Be,this.layerIndex,J,(De,Ze)=>{xe.status="done",this.loaded=this.loaded||{},this.loaded[oe]=xe,De||!Ze?re(De):re(null,Ze)}):(xe.status="done",this.loaded[oe]=xe,re())})}reloadTile(J,re){const oe=this.loaded,xe=J.uid;if(oe&&oe[xe]){const Ee=oe[xe];Ee.projection=J.projection,Ee.brightness=J.brightness;const Be=(He,De)=>{Ee.reloadCallback&&(delete Ee.reloadCallback,this.loadTile(J,re)),re(He,De)};Ee.status==="parsing"?Ee.reloadCallback=Be:Ee.status==="done"&&this.loadTile(J,re)}}abortTile(J,re){const oe=J.uid;this.loading[oe]&&delete this.loading[oe],re()}removeTile(J,re){const oe=this.loaded,xe=J.uid;oe&&oe[xe]&&delete oe[xe],re()}}class Xs{constructor(J){this.self=J,this.actor=new s.ed(J,this),this.layerIndexes={},this.availableImages={},this.isSpriteLoaded={},this.imageRasterizer=new s.I,this.projections={},this.defaultProjection=s.bP({name:"mercator"}),this.workerSourceTypes={vector:Pt,geojson:Vu,"batched-model":ln},this.workerSources={},this.demWorkerSources={},this.self.registerWorkerSource=(re,oe)=>{if(this.workerSourceTypes[re])throw new Error(`Worker source with name "${re}" already registered.`);this.workerSourceTypes[re]=oe},this.self.registerRTLTextPlugin=re=>{if(s.ee.isParsed())throw new Error("RTL text plugin already registered.");s.ee.applyArabicShaping=re.applyArabicShaping,s.ee.processBidirectionalText=re.processBidirectionalText,s.ee.processStyledBidirectionalText=re.processStyledBidirectionalText}}clearCaches(J,re,oe){delete this.layerIndexes[J],delete this.availableImages[J],delete this.workerSources[J],delete this.demWorkerSources[J],delete this.rasterArrayWorkerSource,oe()}checkIfReady(J,re,oe){oe()}setReferrer(J,re){this.referrer=re}spriteLoaded(J,{scope:re,isLoaded:oe}){if(this.isSpriteLoaded[J]||(this.isSpriteLoaded[J]={}),this.isSpriteLoaded[J][re]=oe,this.workerSources[J]&&this.workerSources[J][re])for(const xe in this.workerSources[J][re]){const Ee=this.workerSources[J][re][xe];for(const Be in Ee){const He=Ee[Be];He instanceof Pt&&(He.isSpriteLoaded=oe,He.fire(new s.z("isSpriteLoaded")))}}}setImages(J,{scope:re,images:oe},xe){if(this.availableImages[J]||(this.availableImages[J]={}),this.availableImages[J][re]=oe,this.workerSources[J]&&this.workerSources[J][re]){for(const Ee in this.workerSources[J][re]){const Be=this.workerSources[J][re][Ee];for(const He in Be)Be[He].availableImages=oe}xe()}else xe()}setProjection(J,re){this.projections[J]=s.bP(re)}setBrightness(J,re,oe){this.brightness=re,oe()}setLayers(J,re,oe){this.getLayerIndex(J,re.scope).replace(re.layers,re.options),oe()}updateLayers(J,re,oe){this.getLayerIndex(J,re.scope).update(re.layers,re.removedIds,re.options),oe()}loadTile(J,re,oe){re.projection=this.projections[J]||this.defaultProjection,this.getWorkerSource(J,re.type,re.source,re.scope).loadTile(re,oe)}loadDEMTile(J,re,oe){this.getDEMWorkerSource(J,re.source,re.scope).loadTile(re,oe)}decodeRasterArray(J,re,oe){this.getRasterArrayWorkerSource().decodeRasterArray(re,oe)}reloadTile(J,re,oe){re.projection=this.projections[J]||this.defaultProjection,this.getWorkerSource(J,re.type,re.source,re.scope).reloadTile(re,oe)}abortTile(J,re,oe){this.getWorkerSource(J,re.type,re.source,re.scope).abortTile(re,oe)}removeTile(J,re,oe){this.getWorkerSource(J,re.type,re.source,re.scope).removeTile(re,oe)}removeSource(J,re,oe){if(!(this.workerSources[J]&&this.workerSources[J][re.scope]&&this.workerSources[J][re.scope][re.type]&&this.workerSources[J][re.scope][re.type][re.source]))return;const xe=this.workerSources[J][re.scope][re.type][re.source];delete this.workerSources[J][re.scope][re.type][re.source],xe.removeSource!==void 0?xe.removeSource(re,oe):oe()}loadWorkerSource(J,re,oe){try{this.self.importScripts(re.url),oe()}catch(xe){oe(xe.toString())}}syncRTLPluginState(J,re,oe){try{s.ee.setState(re);const xe=s.ee.getPluginURL();if(s.ee.isLoaded()&&!s.ee.isParsed()&&xe!=null){this.self.importScripts(xe);const Ee=s.ee.isParsed();oe(Ee?void 0:new Error(`RTL Text Plugin failed to import scripts from ${xe}`),Ee)}}catch(xe){oe(xe.toString())}}setDracoUrl(J,re){this.dracoUrl=re}getAvailableImages(J,re){this.availableImages[J]||(this.availableImages[J]={});let oe=this.availableImages[J][re];return oe||(oe=[]),oe}getLayerIndex(J,re){this.layerIndexes[J]||(this.layerIndexes[J]={});let oe=this.layerIndexes[J][re];return oe||(oe=this.layerIndexes[J][re]=new V,oe.scope=re),oe}getWorkerSource(J,re,oe,xe){return this.workerSources[J]||(this.workerSources[J]={}),this.workerSources[J][xe]||(this.workerSources[J][xe]={}),this.workerSources[J][xe][re]||(this.workerSources[J][xe][re]={}),this.isSpriteLoaded[J]||(this.isSpriteLoaded[J]={}),this.workerSources[J][xe][re][oe]||(this.workerSources[J][xe][re][oe]=new this.workerSourceTypes[re]({send:(Ee,Be,He,De,Ze,Xe)=>{this.actor.send(Ee,Be,He,J,Ze,Xe)},scheduler:this.actor.scheduler},this.getLayerIndex(J,xe),this.getAvailableImages(J,xe),this.isSpriteLoaded[J][xe],void 0,this.brightness)),this.workerSources[J][xe][re][oe]}rasterizeImages(J,re,oe){const{imageTasks:xe,scope:Ee}=re,Be={};for(const He in xe){const{image:De,imageIdWithOptions:Ze}=xe[He];Be[He]=this.imageRasterizer.rasterize(Ze,De,Ee,J)}oe(void 0,Be)}removeRasterizedImages(J,re,oe){const{imageIds:xe,scope:Ee}=re;this.imageRasterizer.removeImagesFromCacheByIds(xe,Ee,J),oe()}getDEMWorkerSource(J,re,oe){return this.demWorkerSources[J]||(this.demWorkerSources[J]={}),this.demWorkerSources[J][oe]||(this.demWorkerSources[J][oe]={}),this.demWorkerSources[J][oe][re]||(this.demWorkerSources[J][oe][re]=new vt),this.demWorkerSources[J][oe][re]}getRasterArrayWorkerSource(){return this.rasterArrayWorkerSource||(this.rasterArrayWorkerSource=new yt),this.rasterArrayWorkerSource}enforceCacheSizeLimit(J,re){s.ef(re)}getWorkerPerformanceMetrics(J,re,oe){oe(void 0,void 0)}}return typeof WorkerGlobalScope<"u"&&typeof self<"u"&&self instanceof WorkerGlobalScope&&(self.worker=new Xs(self)),Xs}),h(["./shared"],function(s){var T="3.10.0";const B={create:"create",load:"load",fullLoad:"fullLoad"},F={mark(p){performance.mark(p)},measure(p,o,c){performance.measure(p,o,c)}};function V(p){const o=p.name.split("?")[0];return s.a(o)&&o.includes("mapbox-gl.js")?"javascript":s.a(o)&&o.includes("mapbox-gl.css")?"css":s.b(o)?"fontRange":s.c(o)?"sprite":s.i(o)?"style":s.d(o)?"tilejson":"other"}var X,se={},ne=function(){if(X)return se;function p(m){return!o(m)}function o(m){return typeof window>"u"||typeof document>"u"?"not a browser":function(){if(!("Worker"in window&&"Blob"in window&&"URL"in window))return!1;var b,A,M=new Blob([""],{type:"text/javascript"}),O=URL.createObjectURL(M);try{A=new Worker(O),b=!0}catch{b=!1}return A&&A.terminate(),URL.revokeObjectURL(O),b}()?function(){var b=document.createElement("canvas");b.width=b.height=1;var A=b.getContext("2d");if(!A)return!1;var M=A.getImageData(0,0,1,1);return M&&M.width===b.width}()?(c[v=m&&m.failIfMajorPerformanceCaveat]===void 0&&(c[v]=function(b){var A,M=function(O){var k=document.createElement("canvas"),L=Object.create(p.webGLContextAttributes);return L.failIfMajorPerformanceCaveat=O,k.getContext("webgl2",L)}(b);if(!M)return!1;try{A=M.createShader(M.VERTEX_SHADER)}catch{return!1}return!(!A||M.isContextLost())&&(M.shaderSource(A,"void main() {}"),M.compileShader(A),M.getShaderParameter(A,M.COMPILE_STATUS)===!0)}(v)),c[v]?document.documentMode?"insufficient ECMAScript 6 support":void 0:"insufficient WebGL2 support"):"insufficient Canvas/getImageData support":"insufficient worker support";var v}X=1,se.supported=p,se.notSupportedReason=o;var c={};return p.webGLContextAttributes={antialias:!1,alpha:!0,stencil:!0,depth:!0},se}();function K(p,o,c){const m=document.createElement(p);return o!=null&&(m.className=o),c&&c.appendChild(m),m}function ue(p,o,c){const m=document.createElementNS("http://www.w3.org/2000/svg",p);for(const v of Object.keys(o))m.setAttributeNS(null,v,String(o[v]));return c&&c.appendChild(m),m}const _e=typeof document<"u"?document.documentElement&&document.documentElement.style:null,ke=_e&&_e.userSelect!==void 0?"userSelect":"WebkitUserSelect";let we;function ge(){_e&&ke&&(we=_e[ke],_e[ke]="none")}function Le(){_e&&ke&&(_e[ke]=we)}function $e(p){p.preventDefault(),p.stopPropagation(),window.removeEventListener("click",$e,!0)}function Ye(){window.addEventListener("click",$e,!0),window.setTimeout(()=>{window.removeEventListener("click",$e,!0)},0)}function St(p,o){const c=p.getBoundingClientRect();return yt(p,c,o)}function Pt(p,o){const c=p.getBoundingClientRect(),m=[];for(let v=0;v<o.length;v++)m.push(yt(p,c,o[v]));return m}function vt(p){return/firefox/i.test(navigator.userAgent)&&/macintosh/i.test(navigator.userAgent)&&p.button===2&&p.ctrlKey?0:p.button}function yt(p,o,c){const m=p.offsetWidth===o.width?1:p.offsetWidth/o.width;return new s.P((c.clientX-o.left)*m,(c.clientY-o.top)*m)}const hi="01",Pi="NO_ACCESS_TOKEN";class Si{constructor(o,c,m){this._transformRequestFn=o,this._customAccessToken=c,this._silenceAuthErrors=!!m,this._createSkuToken()}_createSkuToken(){const o=function(){let c="";for(let m=0;m<10;m++)c+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return{token:["1",hi,c].join(""),tokenExpiresAt:Date.now()+432e5}}();this._skuToken=o.token,this._skuTokenExpiresAt=o.tokenExpiresAt}_isSkuTokenExpired(){return Date.now()>this._skuTokenExpiresAt}transformRequest(o,c){return this._transformRequestFn&&this._transformRequestFn(o,c)||{url:o}}normalizeStyleURL(o,c){if(!s.f(o))return o;const m=Br(o);return m.params.push(`sdk=js-${T}`),m.path=`/styles/v1${m.path}`,this._makeAPIURL(m,this._customAccessToken||c)}normalizeGlyphsURL(o,c){if(!s.f(o))return o;const m=Br(o);return m.path=`/fonts/v1${m.path}`,this._makeAPIURL(m,this._customAccessToken||c)}normalizeModelURL(o,c){if(!s.f(o))return o;const m=Br(o);return m.path=`/models/v1${m.path}`,this._makeAPIURL(m,this._customAccessToken||c)}normalizeSourceURL(o,c,m,v){if(!s.f(o))return o;const b=Br(o);return b.path=`/v4/${b.authority}.json`,b.params.push("secure"),m&&b.params.push(`language=${m}`),v&&b.params.push(`worldview=${v}`),this._makeAPIURL(b,this._customAccessToken||c)}normalizeIconsetURL(o,c){const m=Br(o);return s.f(o)?(m.path=`/styles/v1${m.path}/iconset.pbf`,this._makeAPIURL(m,this._customAccessToken||c)):xr(m)}normalizeSpriteURL(o,c,m,v){const b=Br(o);return s.f(o)?(b.path=`/styles/v1${b.path}/sprite${c}${m}`,this._makeAPIURL(b,this._customAccessToken||v)):(b.path+=`${c}${m}`,xr(b))}normalizeTileURL(o,c,m){if(this._isSkuTokenExpired()&&this._createSkuToken(),o&&!s.f(o))return o;const v=Br(o);v.path=v.path.replace(/(\.(png|jpg)\d*)(?=$)/,`${c||m&&v.authority!=="raster"&&m===512?"@2x":""}${s.m.supported?".webp":"$1"}`),v.authority==="raster"?v.path=`/${s.e.RASTER_URL_PREFIX}${v.path}`:v.authority==="rasterarrays"?v.path=`/${s.e.RASTERARRAYS_URL_PREFIX}${v.path}`:v.authority==="3dtiles"?v.path=`/${s.e.TILES3D_URL_PREFIX}${v.path}`:(v.path=v.path.replace(/^.+\/v4\//,"/"),v.path=`/${s.e.TILE_URL_VERSION}${v.path}`);const b=this._customAccessToken||function(A){for(const M of A){const O=M.match(/^access_token=(.*)$/);if(O)return O[1]}return null}(v.params)||s.e.ACCESS_TOKEN;return s.e.REQUIRE_ACCESS_TOKEN&&b&&this._skuToken&&v.params.push(`sku=${this._skuToken}`),this._makeAPIURL(v,b)}canonicalizeTileURL(o,c){const m=Br(o);if(!m.path.match(/^(\/v4\/|\/(raster|rasterarrays)\/v1\/)/)||!m.path.match(/\.[\w]+$/))return o;let v="mapbox://";m.path.match(/^\/raster\/v1\//)?v+=`raster/${m.path.replace(`/${s.e.RASTER_URL_PREFIX}/`,"")}`:m.path.match(/^\/rasterarrays\/v1\//)?v+=`rasterarrays/${m.path.replace(`/${s.e.RASTERARRAYS_URL_PREFIX}/`,"")}`:v+=`tiles/${m.path.replace(`/${s.e.TILE_URL_VERSION}/`,"")}`;let b=m.params;return c&&(b=b.filter(A=>!A.match(/^access_token=/))),b.length&&(v+=`?${b.join("&")}`),v}canonicalizeTileset(o,c){const m=!!c&&s.f(c),v=[];for(const b of o.tiles||[])s.h(b)?v.push(this.canonicalizeTileURL(b,m)):v.push(b);return v}_makeAPIURL(o,c){const m="See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes",v=Br(s.e.API_URL);if(o.protocol=v.protocol,o.authority=v.authority,o.protocol==="http"){const b=o.params.indexOf("secure");b>=0&&o.params.splice(b,1)}if(v.path!=="/"&&(o.path=`${v.path}${o.path}`),!s.e.REQUIRE_ACCESS_TOKEN)return xr(o);if(c=c||s.e.ACCESS_TOKEN,!this._silenceAuthErrors){if(!c)throw new Error(`An API access token is required to use Mapbox GL. ${m}`);if(c[0]==="s")throw new Error(`Use a public access token (pk.*) with Mapbox GL, not a secret access token (sk.*). ${m}`)}return o.params=o.params.filter(b=>b.indexOf("access_token")===-1),o.params.push(`access_token=${c||""}`),xr(o)}}const qt=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;function Br(p){const o=p.match(qt);if(!o)throw new Error("Unable to parse URL object");return{protocol:o[1],authority:o[2],path:o[3]||"/",params:o[4]?o[4].split("&"):[]}}function xr(p){const o=p.params.length?`?${p.params.join("&")}`:"";return`${p.protocol}://${p.authority}${p.path}${o}`}const os="mapbox.eventData";function pi(p){if(!p)return null;const o=p.split(".");if(!o||o.length!==3)return null;try{return JSON.parse(s.j(o[1]))}catch{return null}}class mn{constructor(o){this.type=o,this.anonId=null,this.eventData={},this.queue=[],this.pendingRequest=null}getStorageKey(o){const c=pi(s.e.ACCESS_TOKEN);let m="";return m=c&&c.u?s.k(c.u):s.e.ACCESS_TOKEN||"",o?`${os}.${o}:${m}`:`${os}:${m}`}fetchEventData(){const o=s.s("localStorage"),c=this.getStorageKey(),m=this.getStorageKey("uuid");if(o)try{const v=localStorage.getItem(c);v&&(this.eventData=JSON.parse(v));const b=localStorage.getItem(m);b&&(this.anonId=b)}catch{s.w("Unable to read from LocalStorage")}}saveEventData(){const o=s.s("localStorage"),c=this.getStorageKey(),m=this.getStorageKey("uuid"),v=this.anonId;if(o&&v)try{localStorage.setItem(m,v),Object.keys(this.eventData).length>=1&&localStorage.setItem(c,JSON.stringify(this.eventData))}catch{s.w("Unable to write to LocalStorage")}}processRequests(o){}postEvent(o,c,m,v){if(!s.e.EVENTS_URL)return;const b=Br(s.e.EVENTS_URL);b.params.push(`access_token=${v||s.e.ACCESS_TOKEN||""}`);const A={event:this.type,created:new Date(o).toISOString()},M=c?s.l(A,c):A,O={url:xr(b),headers:{"Content-Type":"text/plain"},body:JSON.stringify([M])};this.pendingRequest=s.p(O,k=>{this.pendingRequest=null,m(k),this.saveEventData(),this.processRequests(v)})}queueRequest(o,c){this.queue.push(o),this.processRequests(c)}}const as=new class extends mn{constructor(p){super("appUserTurnstile"),this._customAccessToken=p}postTurnstileEvent(p,o){s.e.EVENTS_URL&&s.e.ACCESS_TOKEN&&Array.isArray(p)&&p.some(c=>s.f(c)||s.h(c))&&this.queueRequest(Date.now(),o)}processRequests(p){if(this.pendingRequest||this.queue.length===0)return;this.anonId&&this.eventData.lastSuccess&&this.eventData.tokenU||this.fetchEventData();const o=pi(s.e.ACCESS_TOKEN),c=o?o.u:s.e.ACCESS_TOKEN;let m=c!==this.eventData.tokenU;s.v(this.anonId)||(this.anonId=s.u(),m=!0);const v=this.queue.shift();if(this.eventData.lastSuccess){const b=new Date(this.eventData.lastSuccess),A=new Date(v),M=(v-this.eventData.lastSuccess)/864e5;m=m||M>=1||M<-1||b.getDate()!==A.getDate()}else m=!0;m?this.postEvent(v,{sdkIdentifier:"mapbox-gl-js",sdkVersion:T,skuId:hi,"enabled.telemetry":!1,userId:this.anonId},b=>{b||(this.eventData.lastSuccess=v,this.eventData.tokenU=c)},p):this.processRequests()}},Kr=as.postTurnstileEvent.bind(as),si=new class extends mn{constructor(){super("map.load"),this.success={},this.skuToken=""}postMapLoadEvent(p,o,c,m){this.skuToken=o,this.errorCb=m,s.e.EVENTS_URL&&(c||s.e.ACCESS_TOKEN?this.queueRequest({id:p,timestamp:Date.now()},c):this.errorCb(new Error(Pi)))}processRequests(p){if(this.pendingRequest||this.queue.length===0)return;const{id:o,timestamp:c}=this.queue.shift();o&&this.success[o]||(this.anonId||this.fetchEventData(),s.v(this.anonId)||(this.anonId=s.u()),this.postEvent(c,{sdkIdentifier:"mapbox-gl-js",sdkVersion:T,skuId:hi,skuToken:this.skuToken,userId:this.anonId},m=>{m?this.errorCb(m):o&&(this.success[o]=!0)},p))}remove(){this.errorCb=null}},$s=si.postMapLoadEvent.bind(si),ls=new class extends mn{constructor(){super("style.load"),this.eventIdPerMapInstanceMap=new Map,this.mapInstanceIdMap=new WeakMap}getMapInstanceId(p){let o=this.mapInstanceIdMap.get(p);return o||(o=s.u(),this.mapInstanceIdMap.set(p,o)),o}getEventId(p){const o=this.eventIdPerMapInstanceMap.get(p)||0;return this.eventIdPerMapInstanceMap.set(p,o+1),o}postStyleLoadEvent(p,o){const{map:c,style:m,importedStyles:v}=o;if(!s.e.EVENTS_URL||!p&&!s.e.ACCESS_TOKEN)return;const b=this.getMapInstanceId(c),A={mapInstanceId:b,eventId:this.getEventId(b),style:m};v.length&&(A.importedStyles=v),this.queueRequest({timestamp:Date.now(),payload:A},p)}processRequests(p){if(this.pendingRequest||this.queue.length===0)return;const{timestamp:o,payload:c}=this.queue.shift();this.postEvent(o,c,()=>{},p)}},cs=ls.postStyleLoadEvent.bind(ls),fr=new class extends mn{constructor(){super("gljs.performance")}postPerformanceEvent(p,o){s.e.EVENTS_URL&&(p||s.e.ACCESS_TOKEN)&&this.queueRequest({timestamp:Date.now(),performanceData:o},p)}processRequests(p){if(this.pendingRequest||this.queue.length===0)return;const{timestamp:o,performanceData:c}=this.queue.shift(),m=function(v){const b=performance.getEntriesByType("resource"),A=performance.getEntriesByType("mark"),M=function($){const Q={};if($){for(const Z in $)if(Z!=="other")for(const te of $[Z]){const ee=`${Z}ResolveRangeMin`,ae=`${Z}ResolveRangeMax`,me=`${Z}RequestCount`,fe=`${Z}RequestCachedCount`;Q[ee]=Math.min(Q[ee]||1/0,te.startTime),Q[ae]=Math.max(Q[ae]||-1/0,te.responseEnd);const Ae=ve=>{Q[ve]===void 0&&(Q[ve]=0),++Q[ve]};te.transferSize!==void 0&&te.transferSize===0&&Ae(fe),Ae(me)}}return Q}(function($,Q){const Z={};if($)for(const te of $){const ee=Q(te);Z[ee]===void 0&&(Z[ee]=[]),Z[ee].push(te)}return Z}(b,V)),O=window.devicePixelRatio,k=navigator.connection||navigator.mozConnection||navigator.webkitConnection,L=k?k.effectiveType:void 0,U={counters:[],metadata:[],attributes:[]},j=($,Q,Z)=>{Z!=null&&$.push({name:Q,value:Z.toString()})};for(const $ in M)j(U.counters,$,M[$]);if(v.interactionRange[0]!==1/0&&v.interactionRange[1]!==-1/0&&(j(U.counters,"interactionRangeMin",v.interactionRange[0]),j(U.counters,"interactionRangeMax",v.interactionRange[1])),A)for(const $ of Object.keys(B)){const Q=B[$],Z=A.find(te=>te.name===Q);Z&&j(U.counters,Q,Z.startTime)}return j(U.counters,"visibilityHidden",v.visibilityHidden),j(U.attributes,"style",function($){if($)for(const Q of $){const Z=Q.name.split("?")[0];if(s.i(Z)){const te=Z.split("/").slice(-2);if(te.length===2)return`mapbox://styles/${te[0]}/${te[1]}`}}}(b)),j(U.attributes,"terrainEnabled",v.terrainEnabled?"true":"false"),j(U.attributes,"fogEnabled",v.fogEnabled?"true":"false"),j(U.attributes,"projection",v.projection),j(U.attributes,"zoom",v.zoom),j(U.metadata,"devicePixelRatio",O),j(U.metadata,"connectionEffectiveType",L),j(U.metadata,"navigatorUserAgent",navigator.userAgent),j(U.metadata,"screenWidth",window.screen.width),j(U.metadata,"screenHeight",window.screen.height),j(U.metadata,"windowWidth",window.innerWidth),j(U.metadata,"windowHeight",window.innerHeight),j(U.metadata,"mapWidth",v.width/O),j(U.metadata,"mapHeight",v.height/O),j(U.metadata,"webglRenderer",v.renderer),j(U.metadata,"webglVendor",v.vendor),j(U.metadata,"sdkVersion",T),j(U.metadata,"sdkIdentifier","mapbox-gl-js"),U}(c);for(const v of m.metadata);for(const v of m.counters);for(const v of m.attributes);this.postEvent(o,m,()=>{},p)}},br=fr.postPerformanceEvent.bind(fr),kn=new class extends mn{constructor(){super("map.auth"),this.success={},this.skuToken=""}getSession(p,o,c,m){if(!s.e.API_URL||!s.e.SESSION_PATH)return;const v=Br(s.e.API_URL+s.e.SESSION_PATH);v.params.push(`sku=${o||""}`),v.params.push(`access_token=${m||s.e.ACCESS_TOKEN||""}`);const b={url:xr(v),headers:{"Content-Type":"text/plain"}};this.pendingRequest=s.g(b,A=>{this.pendingRequest=null,c(A),this.saveEventData(),this.processRequests(m)})}getSessionAPI(p,o,c,m){this.skuToken=o,this.errorCb=m,s.e.SESSION_PATH&&s.e.API_URL&&(c||s.e.ACCESS_TOKEN?this.queueRequest({id:p,timestamp:Date.now()},c):this.errorCb(new Error(Pi)))}processRequests(p){if(this.pendingRequest||this.queue.length===0)return;const{id:o,timestamp:c}=this.queue.shift();o&&this.success[o]||this.getSession(c,this.skuToken,m=>{m?this.errorCb(m):o&&(this.success[o]=!0)},p)}remove(){this.errorCb=null}},Re=kn.getSessionAPI.bind(kn),sr=new Set;function Xn(p,o){o?sr.add(p):sr.delete(p)}class _n{constructor(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps=new Set,this._updatedImages=new Set}isDirty(){return this._changed}setDirty(){this._changed=!0}getUpdatedSourceCaches(){return this._updatedSourceCaches}updateSourceCache(o,c){this._updatedSourceCaches[o]=c,this.setDirty()}discardSourceCacheUpdate(o){delete this._updatedSourceCaches[o]}updateLayer(o){const c=o.scope;this._updatedLayers[c]=this._updatedLayers[c]||new Set,this._updatedLayers[c].add(o.id),this.setDirty()}removeLayer(o){const c=o.scope;this._removedLayers[c]=this._removedLayers[c]||{},this._updatedLayers[c]=this._updatedLayers[c]||new Set,this._removedLayers[c][o.id]=o,this._updatedLayers[c].delete(o.id),this._updatedPaintProps.delete(o.fqid),this.setDirty()}getRemovedLayer(o){return this._removedLayers[o.scope]?this._removedLayers[o.scope][o.id]:null}discardLayerRemoval(o){this._removedLayers[o.scope]&&delete this._removedLayers[o.scope][o.id]}getLayerUpdatesByScope(){const o={};for(const c in this._updatedLayers)o[c]=o[c]||{},o[c].updatedIds=Array.from(this._updatedLayers[c].values());for(const c in this._removedLayers)o[c]=o[c]||{},o[c].removedIds=Object.keys(this._removedLayers[c]);return o}getUpdatedPaintProperties(){return this._updatedPaintProps}updatePaintProperties(o){this._updatedPaintProps.add(o.fqid),this.setDirty()}getUpdatedImages(){return Array.from(this._updatedImages.values())}updateImage(o){this._updatedImages.add(o),this.setDirty()}resetUpdatedImages(){this._updatedImages.clear()}reset(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps.clear(),this._updatedImages.clear()}}function At(p){const{userImage:o}=p;return!!(o&&o.render&&o.render())&&(p.data.replace(new Uint8Array(o.data.buffer)),!0)}class Wr extends s.E{constructor(o){super(),this.images={},this.updatedImages={},this.callbackDispatchedThisFrame={},this.loaded={},this.requestors=[],this.patterns={},this.atlasImage={},this.atlasTexture={},this.dirty=!0,this.spriteFormat=o,o!=="raster"&&s.t()&&(this.imageRasterizerDispatcher=new s.D(s.x(),this,"Image Rasterizer Worker",1))}get imageRasterizer(){return this._imageRasterizer||(this._imageRasterizer=new s.I),this._imageRasterizer}createScope(o){this.images[o]={},this.loaded[o]=!1,this.updatedImages[o]={},this.patterns[o]={},this.callbackDispatchedThisFrame[o]={},this.atlasImage[o]=new s.r({width:1,height:1})}isLoaded(){for(const o in this.loaded)if(!this.loaded[o])return!1;return!0}setLoaded(o,c){if(this.loaded[c]!==o&&(this.loaded[c]=o,o)){for(const{ids:m,callback:v}of this.requestors)this._notify(m,c,v);this.requestors=[]}}hasImage(o,c){return!!this.getImage(o,c)}getImage(o,c){return this.images[c][o]}addImage(o,c,m){this._validate(o,m)&&(this.images[c][o]=m)}_validate(o,c){let m=!0;return this._validateStretch(c.stretchX,c.data&&c.data.width)||(this.fire(new s.y(new Error(`Image "${o}" has invalid "stretchX" value`))),m=!1),this._validateStretch(c.stretchY,c.data&&c.data.height)||(this.fire(new s.y(new Error(`Image "${o}" has invalid "stretchY" value`))),m=!1),this._validateContent(c.content,c)||(this.fire(new s.y(new Error(`Image "${o}" has invalid "content" value`))),m=!1),m}_validateStretch(o,c){if(!o)return!0;let m=0;for(const v of o){if(v[0]<m||v[1]<v[0]||c<v[1])return!1;m=v[1]}return!0}_validateContent(o,c){return o?o.length!==4||!c.usvg&&(o[0]<0||c.data.width<o[0]||o[1]<0||c.data.height<o[1]||o[2]<0||c.data.width<o[2]||o[3]<0||c.data.height<o[3])?!1:!(o[2]<o[0]||o[3]<o[1]):!0}updateImage(o,c,m){m.version=this.images[c][o].version+1,this.images[c][o]=m,this.updatedImages[c][o]=!0,this.removeFromImageRasterizerCache(o,c)}removeFromImageRasterizerCache(o,c){this.spriteFormat!=="raster"&&(s.t()?this.imageRasterizerDispatcher.getActor().send("removeRasterizedImages",{imageIds:[o],scope:c}):this.imageRasterizer.removeImagesFromCacheByIds([o],c))}removeImage(o,c){const m=this.images[c][o];delete this.images[c][o],delete this.patterns[c][o],this.removeFromImageRasterizerCache(o,c),m.userImage&&m.userImage.onRemove&&m.userImage.onRemove()}listImages(o){return Object.keys(this.images[o])}getImages(o,c,m){let v=!0;const b=!!this.loaded[c];if(!b)for(const A of o)this.images[c][A]||(v=!1);b||v?this._notify(o,c,m):this.requestors.push({ids:o,scope:c,callback:m})}rasterizeImages({scope:o,imageTasks:c},m){const v={};for(const b in c){const A=c[b],M=this.getImage(A.id,o);M&&(v[b]={image:M,imageIdWithOptions:A})}s.t()?this.imageRasterizerDispatcher.getActor().send("rasterizeImages",{imageTasks:v,scope:o},m):this.rasterizeImagesInMainThread({imageTasks:v,scope:o},m)}rasterizeImagesInMainThread(o,c){const{imageTasks:m,scope:v}=o,b={};for(const A in m){const{image:M,imageIdWithOptions:O}=m[A];b[A]=this.imageRasterizer.rasterize(O,M,v,"")}c(void 0,b)}getUpdatedImages(o){return this.updatedImages[o]}_notify(o,c,m){const v={};for(const b of o){this.images[c][b]||this.fire(new s.z("styleimagemissing",{id:b}));const A=this.images[c][b];A?v[b]={data:A.usvg?null:A.data.clone(),pixelRatio:A.pixelRatio,sdf:A.sdf,usvg:A.usvg,version:A.version,stretchX:A.stretchX,stretchY:A.stretchY,content:A.content,hasRenderCallback:!!(A.userImage&&A.userImage.render)}:s.w(`Image "${b}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`)}m(null,v)}getPixelSize(o){const{width:c,height:m}=this.atlasImage[o];return{width:c,height:m}}getPattern(o,c,m){const v=this.patterns[c][o],b=this.getImage(o,c);if(!b)return null;if(v&&v.position.version===b.version)return v.position;if(v)v.position.version=b.version;else{b.usvg&&!b.data&&(b.data=this.imageRasterizer.rasterize(s.A.from(o).getPrimary(),b,c,""));const A={w:b.data.width+2*s.B,h:b.data.height+2*s.B,x:0,y:0},M=new s.C(A,b,s.B);this.patterns[c][o]={bin:A,position:M}}return this._updatePatternAtlas(c,m),this.patterns[c][o].position}bind(o,c){const m=o.gl;let v=this.atlasTexture[c];v?this.dirty&&(v.update(this.atlasImage[c]),this.dirty=!1):(v=new s.T(o,this.atlasImage[c],m.RGBA8),this.atlasTexture[c]=v),v.bind(m.LINEAR,m.CLAMP_TO_EDGE)}_updatePatternAtlas(o,c){const m=[];for(const M in this.patterns[o])m.push(this.patterns[o][M].bin);const{w:v,h:b}=s.F(m),A=this.atlasImage[o];A.resize({width:v||1,height:b||1});for(const M in this.patterns[o]){const{bin:O,position:k}=this.patterns[o][M];let L=k.padding;const U=O.x+L,j=O.y+L,$=this.images[o][M].data,Q=$.width,Z=$.height;L=L>1?L-1:L,s.r.copy($,A,{x:0,y:0},{x:U,y:j},{width:Q,height:Z},c),s.r.copy($,A,{x:0,y:Z-L},{x:U,y:j-L},{width:Q,height:L},c),s.r.copy($,A,{x:0,y:0},{x:U,y:j+Z},{width:Q,height:L},c),s.r.copy($,A,{x:Q-L,y:0},{x:U-L,y:j},{width:L,height:Z},c),s.r.copy($,A,{x:0,y:0},{x:U+Q,y:j},{width:L,height:Z},c),s.r.copy($,A,{x:Q-L,y:Z-L},{x:U-L,y:j-L},{width:L,height:L},c),s.r.copy($,A,{x:0,y:Z-L},{x:U+Q,y:j-L},{width:L,height:L},c),s.r.copy($,A,{x:0,y:0},{x:U+Q,y:j+Z},{width:L,height:L},c),s.r.copy($,A,{x:Q-L,y:0},{x:U-L,y:j+Z},{width:L,height:L},c)}this.dirty=!0}beginFrame(){for(const o in this.images)this.callbackDispatchedThisFrame[o]={}}dispatchRenderCallbacks(o,c){for(const m of o){if(this.callbackDispatchedThisFrame[c][m])continue;this.callbackDispatchedThisFrame[c][m]=!0;const v=this.images[c][m];At(v)&&this.updateImage(m,c,v)}}}function gn(p){const o=p.key,c=p.value,m=p.valueSpec||{},v=p.objectElementValidators||{},b=p.style,A=p.styleSpec;let M=[];const O=s.H(c);if(O!=="object")return[new s.V(o,c,`object expected, ${O} found`)];for(const k in c){const L=k.split(".")[0];let U;v[L]?U=v[L]:m[L]?U=mi:v["*"]?U=v["*"]:m["*"]&&(U=mi),U?M=M.concat(U({key:(o&&`${o}.`)+k,value:c[k],valueSpec:m[L]||m["*"],style:b,styleSpec:A,object:c,objectKey:k},c)):M.push(new s.G(o,c[k],`unknown property "${k}"`))}for(const k in m)v[k]||m[k].required&&m[k].default===void 0&&c[k]===void 0&&M.push(new s.V(o,c,`missing required property "${k}"`));return M}function Zn(p){const o=p.value,c=p.valueSpec,m=p.style,v=p.styleSpec,b=p.key,A=p.arrayElementValidator||mi;if(s.H(o)!=="array")return[new s.V(b,o,`array expected, ${s.H(o)} found`)];if(c.length&&o.length!==c.length)return[new s.V(b,o,`array length ${c.length} expected, length ${o.length} found`)];if(c["min-length"]&&o.length<c["min-length"])return[new s.V(b,o,`array length at least ${c["min-length"]} expected, length ${o.length} found`)];let M={type:c.value,values:c.values,minimum:c.minimum,maximum:c.maximum,function:void 0};v.$version<7&&(M.function=c.function),s.H(c.value)==="object"&&(M=c.value);let O=[];for(let k=0;k<o.length;k++)O=O.concat(A({array:o,arrayIndex:k,value:o[k],valueSpec:M,style:m,styleSpec:v,key:`${b}[${k}]`},!0));return O}function Ti(p){const o=p.key,c=p.value,m=p.valueSpec;let v=s.H(c);if(v==="number"&&c!=c&&(v="NaN"),v!=="number")return[new s.V(o,c,`number expected, ${v} found`)];if("minimum"in m){let b=m.minimum;if(s.H(m.minimum)==="array"&&(b=m.minimum[p.arrayIndex]),c<b)return[new s.V(o,c,`${c} is less than the minimum value ${b}`)]}if("maximum"in m){let b=m.maximum;if(s.H(m.maximum)==="array"&&(b=m.maximum[p.arrayIndex]),c>b)return[new s.V(o,c,`${c} is greater than the maximum value ${b}`)]}return[]}function kr(p){const o=p.valueSpec,c=s.K(p.value.type);let m,v,b,A={};const M=c!=="categorical"&&p.value.property===void 0,O=!M,k=s.H(p.value.stops)==="array"&&s.H(p.value.stops[0])==="array"&&s.H(p.value.stops[0][0])==="object",L=gn({key:p.key,value:p.value,valueSpec:p.styleSpec.function,style:p.style,styleSpec:p.styleSpec,objectElementValidators:{stops:function($){if(c==="identity")return[new s.V($.key,$.value,'identity function may not have a "stops" property')];let Q=[];const Z=$.value;return Q=Q.concat(Zn({key:$.key,value:Z,valueSpec:$.valueSpec,style:$.style,styleSpec:$.styleSpec,arrayElementValidator:U})),s.H(Z)==="array"&&Z.length===0&&Q.push(new s.V($.key,Z,"array must have at least one stop")),Q},default:function($){return mi({key:$.key,value:$.value,valueSpec:o,style:$.style,styleSpec:$.styleSpec})}}});return c==="identity"&&M&&L.push(new s.V(p.key,p.value,'missing required property "property"')),c==="identity"||p.value.stops||L.push(new s.V(p.key,p.value,'missing required property "stops"')),c==="exponential"&&p.valueSpec.expression&&!s.L(p.valueSpec)&&L.push(new s.V(p.key,p.value,"exponential functions not supported")),p.styleSpec.$version>=8&&(O&&!s.M(p.valueSpec)?L.push(new s.V(p.key,p.value,"property functions not supported")):M&&!s.N(p.valueSpec)&&L.push(new s.V(p.key,p.value,"zoom functions not supported"))),c!=="categorical"&&!k||p.value.property!==void 0||L.push(new s.V(p.key,p.value,'"property" property is required')),L;function U($){let Q=[];const Z=$.value,te=$.key;if(s.H(Z)!=="array")return[new s.V(te,Z,`array expected, ${s.H(Z)} found`)];if(Z.length!==2)return[new s.V(te,Z,`array length 2 expected, length ${Z.length} found`)];if(k){if(s.H(Z[0])!=="object")return[new s.V(te,Z,`object expected, ${s.H(Z[0])} found`)];if(Z[0].zoom===void 0)return[new s.V(te,Z,"object stop key must have zoom")];if(Z[0].value===void 0)return[new s.V(te,Z,"object stop key must have value")];const ee=s.K(Z[0].zoom);if(typeof ee!="number")return[new s.V(te,Z[0].zoom,"stop zoom values must be numbers")];if(b&&b>ee)return[new s.V(te,Z[0].zoom,"stop zoom values must appear in ascending order")];ee!==b&&(b=ee,v=void 0,A={}),Q=Q.concat(gn({key:`${te}[0]`,value:Z[0],valueSpec:{zoom:{}},style:$.style,styleSpec:$.styleSpec,objectElementValidators:{zoom:Ti,value:j}}))}else Q=Q.concat(j({key:`${te}[0]`,value:Z[0],style:$.style,styleSpec:$.styleSpec},Z));return s.O(s.Q(Z[1]))?Q.concat([new s.V(`${te}[1]`,Z[1],"expressions are not allowed in function stops.")]):Q.concat(mi({key:`${te}[1]`,value:Z[1],valueSpec:o,style:$.style,styleSpec:$.styleSpec}))}function j($,Q){const Z=s.H($.value),te=s.K($.value),ee=$.value!==null?$.value:Q;if(m){if(Z!==m)return[new s.V($.key,ee,`${Z} stop domain type must match previous stop domain type ${m}`)]}else m=Z;if(Z!=="number"&&Z!=="string"&&Z!=="boolean"&&typeof te!="number"&&typeof te!="string"&&typeof te!="boolean")return[new s.V($.key,ee,"stop domain value must be a number, string, or boolean")];if(Z!=="number"&&c!=="categorical"){let ae=`number expected, ${Z} found`;return s.M(o)&&c===void 0&&(ae+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new s.V($.key,ee,ae)]}return c!=="categorical"||Z!=="number"||typeof te=="number"&&isFinite(te)&&Math.floor(te)===te?c!=="categorical"&&Z==="number"&&typeof te=="number"&&typeof v=="number"&&v!==void 0&&te<v?[new s.V($.key,ee,"stop domain values must appear in ascending order")]:(v=te,c==="categorical"&&te in A?[new s.V($.key,ee,"stop domain values must be unique")]:(A[te]=!0,[])):[new s.V($.key,ee,`integer expected, found ${String(te)}`)]}}function Ln(p){const o=(p.expressionContext==="property"?s.S:s.U)(s.Q(p.value),p.valueSpec);if(o.result==="error")return o.value.map(m=>new s.V(`${p.key}${m.key}`,p.value,m.message));const c=o.value.expression||o.value._styleExpression.expression;if(p.expressionContext==="property"&&p.propertyKey==="text-font"&&!c.outputDefined())return[new s.V(p.key,p.value,`Invalid data expression for "${p.propertyKey}". Output values must be contained as literals within the expression.`)];if(p.expressionContext==="property"&&p.propertyType==="layout"&&!s.W(c))return[new s.V(p.key,p.value,'"feature-state" data expressions are not supported with layout properties.')];if(p.expressionContext==="filter")return Ws(c,p);if(p.expressionContext&&p.expressionContext.indexOf("cluster")===0){if(!s.X(c,["zoom","feature-state"]))return[new s.V(p.key,p.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if(p.expressionContext==="cluster-initial"&&!s.Y(c))return[new s.V(p.key,p.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function Ws(p,o){const c=new Set(["zoom","feature-state","pitch","distance-from-center"]);if(o.valueSpec&&o.valueSpec.expression)for(const v of o.valueSpec.expression.parameters)c.delete(v);if(c.size===0)return[];const m=[];return p instanceof s.Z&&c.has(p.name)?[new s.V(o.key,o.value,`["${p.name}"] expression is not supported in a filter for a ${o.object.type} layer with id: ${o.object.id}`)]:(p.eachChild(v=>{m.push(...Ws(v,o))}),m)}function bo(p){const o=p.key,c=p.value,m=p.valueSpec,v=[];return Array.isArray(m.values)?m.values.indexOf(s.K(c))===-1&&v.push(new s.V(o,c,`expected one of [${m.values.join(", ")}], ${JSON.stringify(c)} found`)):Object.keys(m.values).indexOf(s.K(c))===-1&&v.push(new s.V(o,c,`expected one of [${Object.keys(m.values).join(", ")}], ${JSON.stringify(c)} found`)),v}function wo(p){return s.$(s.Q(p.value))?Ln(s.J({},p,{expressionContext:"filter",valueSpec:p.styleSpec[`filter_${p.layerType||"fill"}`]})):yi(p)}function yi(p){const o=p.value,c=p.key;if(s.H(o)!=="array")return[new s.V(c,o,`array expected, ${s.H(o)} found`)];const m=p.styleSpec;let v,b=[];if(o.length<1)return[new s.V(c,o,"filter array must have at least 1 element")];switch(b=b.concat(bo({key:`${c}[0]`,value:o[0],valueSpec:m.filter_operator,style:p.style,styleSpec:p.styleSpec})),s.K(o[0])){case"<":case"<=":case">":case">=":o.length>=2&&s.K(o[1])==="$type"&&b.push(new s.V(c,o,`"$type" cannot be use with operator "${o[0]}"`));case"==":case"!=":o.length!==3&&b.push(new s.V(c,o,`filter array for operator "${o[0]}" must have 3 elements`));case"in":case"!in":o.length>=2&&(v=s.H(o[1]),v!=="string"&&b.push(new s.V(`${c}[1]`,o[1],`string expected, ${v} found`)));for(let A=2;A<o.length;A++)v=s.H(o[A]),s.K(o[1])==="$type"?b=b.concat(bo({key:`${c}[${A}]`,value:o[A],valueSpec:m.geometry_type,style:p.style,styleSpec:p.styleSpec})):v!=="string"&&v!=="number"&&v!=="boolean"&&b.push(new s.V(`${c}[${A}]`,o[A],`string, number, or boolean expected, ${v} found`));break;case"any":case"all":case"none":for(let A=1;A<o.length;A++)b=b.concat(yi({key:`${c}[${A}]`,value:o[A],style:p.style,styleSpec:p.styleSpec}));break;case"has":case"!has":v=s.H(o[1]),o.length!==2?b.push(new s.V(c,o,`filter array for "${o[0]}" operator must have 2 elements`)):v!=="string"&&b.push(new s.V(`${c}[1]`,o[1],`string expected, ${v} found`))}return b}function ws(p,o){const c=p.key,m=p.style,v=p.layer,b=p.styleSpec,A=p.value,M=p.objectKey,O=b[`${o}_${p.layerType}`];if(!O)return[];const k=M.match(/^(.*)-use-theme$/);if(o==="paint"&&k&&O[k[1]])return s.O(A)?[].concat(mi({key:p.key,value:A,valueSpec:{type:"string",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},style:m,styleSpec:b,expressionContext:"property",propertyType:o,propertyKey:M})):mi({key:c,value:A,valueSpec:{type:"string"},style:m,styleSpec:b});const L=M.match(/^(.*)-transition$/);if(o==="paint"&&L&&O[L[1]]&&O[L[1]].transition)return mi({key:c,value:A,valueSpec:b.transition,style:m,styleSpec:b});const U=p.valueSpec||O[M];if(!U)return[new s.G(c,A,`unknown property "${M}"`)];let j;if(s.H(A)==="string"&&s.M(U)&&!U.tokens&&(j=/^{([^}]+)}$/.exec(A))){const Q=`\`{ "type": "identity", "property": ${j?JSON.stringify(j[1]):'"_"'} }\``;return[new s.V(c,A,`"${M}" does not support interpolation syntax
Use an identity property function instead: ${Q}.`)]}const $=[];if(p.layerType==="symbol")M!=="text-field"||!m||m.glyphs||m.imports||$.push(new s.V(c,A,'use of "text-field" requires a style "glyphs" property')),M==="text-font"&&s.a0(s.Q(A))&&s.K(A.type)==="identity"&&$.push(new s.V(c,A,'"text-font" does not support identity functions'));else if(p.layerType==="model"&&o==="paint"&&v&&v.layout&&v.layout.hasOwnProperty("model-id")&&s.M(U)&&(s.a1(U)||s.N(U))){const Q=s.S(s.Q(A),U),Z=Q.value.expression||Q.value._styleExpression.expression;Z&&!s.X(Z,["measure-light"])&&(M==="model-emissive-strength"&&s.Y(Z)&&s.W(Z)||$.push(new s.V(c,A,`${M} does not support measure-light expressions when the model layer source is vector tile or GeoJSON.`)))}return $.concat(mi({key:p.key,value:A,valueSpec:U,style:m,styleSpec:b,expressionContext:"property",propertyType:o,propertyKey:M}))}function us(p){return ws(p,"paint")}function Cn(p){return ws(p,"layout")}function Mn(p){let o=[];const c=p.value,m=p.key,v=p.style,b=p.styleSpec;c.type||c.ref||o.push(new s.V(m,c,'either "type" or "ref" is required'));let A=s.K(c.type);const M=s.K(c.ref);if(c.id){const O=s.K(c.id);for(let k=0;k<p.arrayIndex;k++){const L=v.layers[k];s.K(L.id)===O&&o.push(new s.V(m,c.id,`duplicate layer id "${c.id}", previously used at line ${L.id.__line__}`))}}if("ref"in c){let O;["type","source","source-layer","filter","layout"].forEach(k=>{k in c&&o.push(new s.V(m,c[k],`"${k}" is prohibited for ref layers`))}),v.layers.forEach(k=>{s.K(k.id)===M&&(O=k)}),O?O.ref?o.push(new s.V(m,c.ref,"ref cannot reference another ref layer")):A=s.K(O.type):typeof M=="string"&&o.push(new s.V(m,c.ref,`ref layer "${M}" not found`))}else if(A!=="background"&&A!=="sky"&&A!=="slot")if(c.source){const O=v.sources&&v.sources[c.source],k=O&&s.K(O.type);O?k==="vector"&&A==="raster"?o.push(new s.V(m,c.source,`layer "${c.id}" requires a raster source`)):k==="raster"&&A!=="raster"?o.push(new s.V(m,c.source,`layer "${c.id}" requires a vector source`)):k!=="vector"||c["source-layer"]?k==="raster-dem"&&A!=="hillshade"?o.push(new s.V(m,c.source,"raster-dem source can only be used with layer type 'hillshade'.")):k!=="raster-array"||["raster","raster-particle"].includes(A)?A!=="line"||!c.paint||!c.paint["line-gradient"]&&!c.paint["line-trim-offset"]||k==="geojson"&&O.lineMetrics?A==="raster-particle"&&k!=="raster-array"&&o.push(new s.V(m,c.source,`layer "${c.id}" requires a 'raster-array' source.`)):o.push(new s.V(m,c,`layer "${c.id}" specifies a line-gradient, which requires a GeoJSON source with \`lineMetrics\` enabled.`)):o.push(new s.V(m,c.source,"raster-array source can only be used with layer type 'raster'.")):o.push(new s.V(m,c,`layer "${c.id}" must specify a "source-layer"`)):o.push(new s.V(m,c.source,`source "${c.source}" not found`))}else o.push(new s.V(m,c,'missing required property "source"'));return o=o.concat(gn({key:m,value:c,valueSpec:b.layer,style:p.style,styleSpec:p.styleSpec,objectElementValidators:{"*":()=>[],type:()=>mi({key:`${m}.type`,value:c.type,valueSpec:b.layer.type,style:p.style,styleSpec:p.styleSpec,object:c,objectKey:"type"}),filter:O=>wo(s.J({layerType:A},O)),layout:O=>gn({layer:c,key:O.key,value:O.value,valueSpec:{},style:O.style,styleSpec:O.styleSpec,objectElementValidators:{"*":k=>Cn(s.J({layerType:A},k))}}),paint:O=>gn({layer:c,key:O.key,value:O.value,valueSpec:{},style:O.style,styleSpec:O.styleSpec,objectElementValidators:{"*":k=>us(s.J({layerType:A,layer:c},k))}})}})),o}function Ao(p){const o=p.value,c=p.key,m=s.H(o);return m!=="string"?[new s.V(c,o,`string expected, ${m} found`)]:[]}const Aa={promoteId:function p({key:o,value:c}){if(s.H(c)==="string")return Ao({key:o,value:c});if(Array.isArray(c)){const m=[],v=s.Q(c),b=s.U(v);return b.result==="error"&&b.value.forEach(A=>{m.push(new s.V(`${o}${A.key}`,null,`${A.message}`))}),s.X(b.value.expression,["zoom","heatmap-density","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])||m.push(new s.V(`${o}`,null,"promoteId expression should be only feature dependent")),m}{const m=[];for(const v in c)m.push(...p({key:`${o}.${v}`,value:c[v]}));return m}}};function nl(p){const o=p.value,c=p.key,m=p.styleSpec,v=p.style;if(!o.type)return[new s.V(c,o,'"type" is required')];const b=s.K(o.type);let A=[];switch(["vector","raster","raster-dem","raster-array"].includes(b)&&(o.url||o.tiles||A.push(new s.G(c,o,'Either "url" or "tiles" is required.'))),b){case"vector":case"raster":case"raster-dem":case"raster-array":return A=A.concat(gn({key:c,value:o,valueSpec:m[`source_${b.replace("-","_")}`],style:p.style,styleSpec:m,objectElementValidators:Aa})),A;case"geojson":if(A=gn({key:c,value:o,valueSpec:m.source_geojson,style:v,styleSpec:m,objectElementValidators:Aa}),o.cluster)for(const M in o.clusterProperties){const[O,k]=o.clusterProperties[M],L=typeof O=="string"?[O,["accumulated"],["get",M]]:O;A.push(...Ln({key:`${c}.${M}.map`,value:k,expressionContext:"cluster-map"})),A.push(...Ln({key:`${c}.${M}.reduce`,value:L,expressionContext:"cluster-reduce"}))}return A;case"video":return gn({key:c,value:o,valueSpec:m.source_video,style:v,styleSpec:m});case"image":return gn({key:c,value:o,valueSpec:m.source_image,style:v,styleSpec:m});case"canvas":return[new s.V(c,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return bo({key:`${c}.type`,value:o.type,valueSpec:{values:sl(m)}})}}function sl(p){return p.source.reduce((o,c)=>{const m=p[c];return m.type.type==="enum"&&(o=o.concat(Object.keys(m.type.values))),o},[])}function Nn(p){const o=p.value,c=p.styleSpec,m=c.light,v=p.style;let b=[];const A=s.H(o);if(o===void 0)return b;if(A!=="object")return b=b.concat([new s.V("light",o,`object expected, ${A} found`)]),b;for(const M in o){const O=M.match(/^(.*)-transition$/),k=M.match(/^(.*)-use-theme$/);b=b.concat(k&&m[k[1]]?mi({key:M,value:o[M],valueSpec:{type:"string"},style:v,styleSpec:c}):O&&m[O[1]]&&m[O[1]].transition?mi({key:M,value:o[M],valueSpec:c.transition,style:v,styleSpec:c}):m[M]?mi({key:M,value:o[M],valueSpec:m[M],style:v,styleSpec:c}):[new s.V(M,o[M],`unknown property "${M}"`)])}return b}function ol(p){const o=p.value;let c=[];if(!o)return c;const m=s.H(o);if(m!=="object")return c=c.concat([new s.V("light-3d",o,`object expected, ${m} found`)]),c;const v=p.styleSpec,b=v["light-3d"],A=p.key,M=p.style,O=p.style.lights;for(const U of["type","id"])if(!(U in o))return c=c.concat([new s.V("light-3d",o,`missing property ${U} on light`)]),c;if(o.type&&O)for(let U=0;U<p.arrayIndex;U++){const j=s.K(o.type),$=O[U];s.K($.type)===j&&c.push(new s.V(A,o.id,`duplicate light type "${o.type}", previously defined at line ${$.id.__line__}`))}const k=`properties_light_${o.type}`;if(!(k in v))return c=c.concat([new s.V("light-3d",o,`Invalid light type ${o.type}`)]),c;const L=v[k];for(const U in o)if(U==="properties"){const j=o[U],$=s.H(j);if($!=="object")return c=c.concat([new s.V("properties",j,`object expected, ${$} found`)]),c;for(const Q in j)c=c.concat(L[Q]?mi({key:Q,value:j[Q],valueSpec:L[Q],style:M,styleSpec:v}):[new s.G(p.key,j[Q],`unknown property "${Q}"`)])}else{const j=U.match(/^(.*)-transition$/),$=U.match(/^(.*)-use-theme$/);c=c.concat($&&b[$[1]]?mi({key:U,value:o[U],valueSpec:{type:"string"},style:M,styleSpec:v}):j&&b[j[1]]&&b[j[1]].transition?mi({key:U,value:o[U],valueSpec:v.transition,style:M,styleSpec:v}):b[U]?mi({key:U,value:o[U],valueSpec:b[U],style:M,styleSpec:v}):[new s.G(U,o[U],`unknown property "${U}"`)])}return c}function al(p){const o=p.value,c=p.key,m=p.style,v=p.styleSpec,b=v.terrain;let A=[];const M=s.H(o);if(o===void 0||M==="null")return A;if(M!=="object")return A=A.concat([new s.V("terrain",o,`object expected, ${M} found`)]),A;for(const O in o){const k=O.match(/^(.*)-transition$/),L=O.match(/^(.*)-use-theme$/);A=A.concat(L&&b[L[1]]?mi({key:O,value:o[O],valueSpec:{type:"string"},style:m,styleSpec:v}):k&&b[k[1]]&&b[k[1]].transition?mi({key:O,value:o[O],valueSpec:v.transition,style:m,styleSpec:v}):b[O]?mi({key:O,value:o[O],valueSpec:b[O],style:m,styleSpec:v}):[new s.G(O,o[O],`unknown property "${O}"`)])}if(o.source){const O=m.sources&&m.sources[o.source],k=O&&s.K(O.type);O?k!=="raster-dem"&&A.push(new s.V(c,o.source,`terrain cannot be used with a source of type ${String(k)}, it only be used with a "raster-dem" source type`)):A.push(new s.V(c,o.source,`source "${o.source}" not found`))}else A.push(new s.V(c,o,'terrain is missing required property "source"'));return A}function hs(p){const o=p.value,c=p.style,m=p.styleSpec,v=m.fog;let b=[];const A=s.H(o);if(o===void 0)return b;if(A!=="object")return b=b.concat([new s.V("fog",o,`object expected, ${A} found`)]),b;for(const M in o){const O=M.match(/^(.*)-transition$/),k=M.match(/^(.*)-use-theme$/);b=b.concat(k&&v[k[1]]?mi({key:M,value:o[M],valueSpec:{type:"string"},style:c,styleSpec:m}):O&&v[O[1]]&&v[O[1]].transition?mi({key:M,value:o[M],valueSpec:m.transition,style:c,styleSpec:m}):v[M]?mi({key:M,value:o[M],valueSpec:v[M],style:c,styleSpec:m}):[new s.G(M,o[M],`unknown property "${M}"`)])}return b}const Ta={"*":()=>[],array:Zn,boolean:function(p){const o=p.value,c=p.key,m=s.H(o);return m!=="boolean"?[new s.V(c,o,`boolean expected, ${m} found`)]:[]},number:Ti,color:function(p){const o=p.key,c=p.value,m=s.H(c);return m!=="string"?[new s.V(o,c,`color expected, ${m} found`)]:s._.parseCSSColor(c)===null?[new s.V(o,c,`color expected, "${c}" found`)]:[]},enum:bo,filter:wo,function:kr,layer:Mn,object:gn,source:nl,model:s.a2,light:Nn,"light-3d":ol,terrain:al,fog:hs,string:Ao,formatted:function(p){return Ao(p).length===0?[]:Ln(p)},resolvedImage:function(p){return Ao(p).length===0?[]:Ln(p)},projection:function(p){const o=p.value,c=p.styleSpec,m=c.projection,v=p.style;let b=[];const A=s.H(o);if(A==="object")for(const M in o)b=b.concat(mi({key:M,value:o[M],valueSpec:m[M],style:v,styleSpec:c}));else A!=="string"&&(b=b.concat([new s.V("projection",o,`object or string expected, ${A} found`)]));return b},import:function(p){const{value:o,styleSpec:c}=p,{data:m,...v}=o;Object.defineProperty(v,"__line__",{value:o.__line__,enumerable:!1});let b=gn(s.J({},p,{value:v,valueSpec:c.import}));return s.K(v.id)===""&&b.push(new s.V(`${p.key}.id`,v,"import id can't be an empty string")),m&&(b=b.concat(Lu(m,c,{key:`${p.key}.data`}))),b}};function mi(p,o=!1){const c=p.value,m=p.valueSpec,v=p.styleSpec;if(m.expression&&s.a0(s.K(c)))return kr(p);if(m.expression&&s.O(s.Q(c)))return Ln(p);if(m.type&&Ta[m.type]){const b=Ta[m.type](p);return o===!0&&b.length>0&&s.H(p.value)==="array"?Ln(p):b}return gn(s.J({},p,{valueSpec:m.type?v[m.type]:m}))}function qs(p){const o=p.value,c=p.key,m=Ao(p);return m.length||(o.indexOf("{fontstack}")===-1&&m.push(new s.V(c,o,'"glyphs" url must include a "{fontstack}" token')),o.indexOf("{range}")===-1&&m.push(new s.V(c,o,'"glyphs" url must include a "{range}" token'))),m}function Lu(p,o=s.a3,c={}){return mi({key:c.key||"",value:p,valueSpec:o.$root,styleSpec:o,style:p,objectElementValidators:{glyphs:qs,"*":()=>[]}})}function Yn(p,o=s.a3){return ln(Lu(p,o))}const To=p=>ln(nl(p)),ll=p=>ln(Nn(p)),cl=p=>ln(ol(p)),ul=p=>ln(al(p)),Nu=p=>ln(hs(p)),hl=p=>ln(function(o){const c=o.value,m=o.style,v=o.styleSpec,b=v.snow;let A=[];const M=s.H(c);if(c===void 0)return A;if(M!=="object")return A=A.concat([new s.V("snow",c,`object expected, ${M} found`)]),A;for(const O in c){const k=O.match(/^(.*)-transition$/);A=A.concat(k&&b[k[1]]&&b[k[1]].transition?mi({key:O,value:c[O],valueSpec:v.transition,style:m,styleSpec:v}):b[O]?mi({key:O,value:c[O],valueSpec:b[O],style:m,styleSpec:v}):[new s.G(O,c[O],`unknown property "${O}"`)])}return A}(p)),zu=p=>ln(function(o){const c=o.value,m=o.style,v=o.styleSpec,b=v.rain;let A=[];const M=s.H(c);if(c===void 0)return A;if(M!=="object")return A=A.concat([new s.V("rain",c,`object expected, ${M} found`)]),A;for(const O in c){const k=O.match(/^(.*)-transition$/);A=A.concat(k&&b[k[1]]&&b[k[1]].transition?mi({key:O,value:c[O],valueSpec:v.transition,style:m,styleSpec:v}):b[O]?mi({key:O,value:c[O],valueSpec:b[O],style:m,styleSpec:v}):[new s.G(O,c[O],`unknown property "${O}"`)])}return A}(p)),Uu=p=>ln(Mn(p)),Vr=p=>ln(wo(p)),cc=p=>ln(us(p)),Vu=p=>ln(Cn(p)),uc=p=>ln(s.a2(p));function ln(p){return p.slice().sort((o,c)=>o.line&&c.line?o.line-c.line:0)}function Xs(p,o){let c=!1;if(o&&o.length)for(const m of o)m instanceof s.G?s.w(m.message):(p.fire(new s.y(new Error(m.message))),c=!0);return c}let Je;class J extends s.E{constructor(o,c="flat"){super(),this._transitionable=new s.a4(Je||(Je=new s.a5({anchor:new s.a6(s.a3.light.anchor),position:new s.a7(s.a3.light.position),color:new s.a6(s.a3.light.color),intensity:new s.a6(s.a3.light.intensity)}))),this.setLight(o,c),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(o,c,m={}){this._validate(ll,o,m)||(this._transitionable.setTransitionOrValue(o),this.id=c)}updateTransitions(o){this._transitioning=this._transitionable.transitioned(o,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(o){this.properties=this._transitioning.possiblyEvaluate(o)}_validate(o,c,m){return(!m||m.validate!==!1)&&Xs(this,o.call(Yn,s.l({value:c,style:{glyphs:!0,sprite:!0},styleSpec:s.a3})))}}let re=class extends s.E{constructor(p,o,c,m){super(),this.scope=c,this._transitionable=new s.a4(new s.a5({source:new s.a6(s.a3.terrain.source),exaggeration:new s.a6(s.a3.terrain.exaggeration)}),c,m),this._transitionable.setTransitionOrValue(p,m),this._transitioning=this._transitionable.untransitioned(),this.drapeRenderMode=o}get(){return this._transitionable.serialize()}set(p,o){this._transitionable.setTransitionOrValue(p,o)}updateTransitions(p){this._transitioning=this._transitionable.transitioned(p,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(p){this.properties=this._transitioning.possiblyEvaluate(p)}getExaggeration(p){return this._transitioning.possiblyEvaluate(new s.a8(p)).get("exaggeration")}getAttenuationRange(){if(!this.isZoomDependent())return null;const p=this._transitionable._values.exaggeration;if(!p)return null;const o=p.value.expression;if(!o)return null;let c=-1,m=-1,v=1;for(const b of o.zoomStops)v=o.evaluate(new s.a8(b)),v>.01?(c=b,m=-1):m=b;return v<.01&&c>0&&m>c?[c,m]:null}isZoomDependent(){const p=this._transitionable._values.exaggeration;return p!=null&&p.value!=null&&p.value.expression!=null&&p.value.expression instanceof s.a9}};const oe=45,xe=65,Ee=.05;function Be(p,o,c,m){const v=s.ac(oe,xe,c),[b,A]=He(p,m);let M=1-Math.min(1,Math.exp((o-b)/(A-b)*-6));return M*=M*M,M=Math.min(1,1.00747*M),M*v*p.alpha}function He(p,o){const c=.5/Math.tan(.5*o);return[p.range[0]+c,p.range[1]+c]}function De(p,o,c,m,v){const b=s.ab.vec3.transformMat4([],[o,c,m],v.mercatorFogMatrix);return Be(p,s.ab.vec3.length(b),v.pitch,v._fov)}function Ze(p,o,c,m,v,b,A){const M=[[c,m,0],[v,m,0],[v,b,0],[c,b,0]];let O=Number.MAX_VALUE,k=-Number.MAX_VALUE;for(const L of M){const U=s.ab.vec3.transformMat4([],L,o),j=s.ab.vec3.length(U);O=Math.min(O,j),k=Math.max(k,j)}return[Be(p,O,A.pitch,A._fov),Be(p,k,A.pitch,A._fov)]}class Xe extends s.E{constructor(o,c,m,v){super();const b=new s.a5({range:new s.a6(s.a3.fog.range),color:new s.a6(s.a3.fog.color),"color-use-theme":new s.a6({type:"string","property-type":"data-constant",default:"default"}),"high-color":new s.a6(s.a3.fog["high-color"]),"high-color-use-theme":new s.a6({type:"string","property-type":"data-constant",default:"default"}),"space-color":new s.a6(s.a3.fog["space-color"]),"space-color-use-theme":new s.a6({type:"string","property-type":"data-constant",default:"default"}),"horizon-blend":new s.a6(s.a3.fog["horizon-blend"]),"star-intensity":new s.a6(s.a3.fog["star-intensity"]),"vertical-range":new s.a6(s.a3.fog["vertical-range"])});this._transitionable=new s.a4(b,m,new Map(v)),this.set(o,v),this._transitioning=this._transitionable.untransitioned(),this._transform=c,this.properties=new s.ad(b),this.scope=m}get state(){const o=this._transform,c=o.projection.name==="globe",m=s.ae(o.zoom),v=this.properties.get("range"),b=[.5,3];return{range:c?[s.af(b[0],v[0],m),s.af(b[1],v[1],m)]:v,horizonBlend:this.properties.get("horizon-blend"),alpha:this.properties.get("color").a}}get(){return this._transitionable.serialize()}set(o,c,m={}){if(this._validate(Nu,o,m))return;const v=s.l({},o);for(const b of Object.keys(s.a3.fog))v[b]===void 0&&(v[b]=s.a3.fog[b].default);this._options=v,this._transitionable.setTransitionOrValue(this._options,c)}getOpacity(o){if(!this._transform.projection.supportsFog)return 0;const c=this.properties&&this.properties.get("color")||1;return(this._transform.projection.name==="globe"?1:s.ac(oe,xe,o))*c.a}getOpacityAtLatLng(o,c){return this._transform.projection.supportsFog?function(m,v,b){const A=s.aa.fromLngLat(v),M=b.elevation?b.elevation.getAtPointOrZero(A):0;return De(m,A.x,A.y,M,b)}(this.state,o,c):0}getOpacityForTile(o){if(!this._transform.projection.supportsFog)return[1,1];const c=this._transform.calculateFogTileMatrix(o.toUnwrapped());return Ze(this.state,c,0,0,s.ag,s.ag,this._transform)}getOpacityForBounds(o,c,m,v,b){return this._transform.projection.supportsFog?Ze(this.state,o,c,m,v,b,this._transform):[1,1]}getFovAdjustedRange(o){return this._transform.projection.supportsFog?He(this.state,o):[0,1]}isVisibleOnFrustum(o){if(!this._transform.projection.supportsFog)return!1;const c=[4,5,6,7];for(const m of c){const v=o.points[m];let b;if(v[2]>=0)b=v;else{const A=o.points[m-4];b=s.ah(A,v,A[2]/(A[2]-v[2]))}if(De(this.state,b[0],b[1],0,this._transform)>=Ee)return!0}return!1}updateConfig(o){this._transitionable.setTransitionOrValue(this._options,new Map(o))}updateTransitions(o){this._transitioning=this._transitionable.transitioned(o,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(o){this.properties=this._transitioning.possiblyEvaluate(o)}_validate(o,c,m){return(!m||m.validate!==!1)&&Xs(this,o.call(Yn,s.l({value:c,style:{glyphs:!0,sprite:!0},styleSpec:s.a3})))}}let Ke,dt,It,Ct,Zt=class extends s.E{constructor(p,o,c,m){super();const v=Ke||(Ke=new s.a5({density:new s.a6(s.a3.snow.density),intensity:new s.a6(s.a3.snow.intensity),color:new s.a6(s.a3.snow.color),opacity:new s.a6(s.a3.snow.opacity),vignette:new s.a6(s.a3.snow.vignette),"vignette-color":new s.a6(s.a3.snow["vignette-color"]),"center-thinning":new s.a6(s.a3.snow["center-thinning"]),direction:new s.a6(s.a3.snow.direction),"flake-size":new s.a6(s.a3.snow["flake-size"])}));this._transitionable=new s.a4(v,c,new Map(m)),this.set(p,m),this._transitioning=this._transitionable.untransitioned(),this.properties=new s.ad(v),this.scope=c}get state(){const p=this.properties.get("opacity"),o=this.properties.get("color"),c=this.properties.get("direction"),m=s.ai(c[0]),v=-Math.max(s.ai(c[1]),.01),b=[Math.cos(m)*Math.cos(v),Math.sin(m)*Math.cos(v),Math.sin(v)],A=this.properties.get("vignette"),M=this.properties.get("vignette-color");return M.a=A,{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new s.aj(o.r,o.g,o.b,o.a*p),direction:b,centerThinning:this.properties.get("center-thinning"),flakeSize:this.properties.get("flake-size"),vignetteColor:M}}get(){return this._transitionable.serialize()}set(p,o,c={}){if(this._validate(hl,p,c))return;const m=s.l({},p);for(const v of Object.keys(s.a3.snow))m[v]===void 0&&(m[v]=s.a3.snow[v].default);this._options=m,this._transitionable.setTransitionOrValue(this._options,o)}updateConfig(p){this._transitionable.setTransitionOrValue(this._options,new Map(p))}updateTransitions(p){this._transitioning=this._transitionable.transitioned(p,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(p){this.properties=this._transitioning.possiblyEvaluate(p)}_validate(p,o,c){return(!c||c.validate!==!1)&&Xs(this,p.call(Yn,s.l({value:o,style:{glyphs:!0,sprite:!0},styleSpec:s.a3})))}},ei=class extends s.E{constructor(p,o,c,m){super();const v=dt||(dt=new s.a5({density:new s.a6(s.a3.rain.density),intensity:new s.a6(s.a3.rain.intensity),color:new s.a6(s.a3.rain.color),opacity:new s.a6(s.a3.rain.opacity),vignette:new s.a6(s.a3.rain.vignette),"vignette-color":new s.a6(s.a3.rain["vignette-color"]),"center-thinning":new s.a6(s.a3.rain["center-thinning"]),direction:new s.a6(s.a3.rain.direction),"droplet-size":new s.a6(s.a3.rain["droplet-size"]),"distortion-strength":new s.a6(s.a3.rain["distortion-strength"])}));this._transitionable=new s.a4(v,c,new Map(m)),this.set(p,m),this._transitioning=this._transitionable.untransitioned(),this.properties=new s.ad(v),this.scope=c}get state(){const p=this.properties.get("opacity"),o=this.properties.get("color"),c=this.properties.get("direction"),m=s.ai(c[0]),v=-Math.max(s.ai(c[1]),.01),b=[Math.cos(m)*Math.cos(v),Math.sin(m)*Math.cos(v),Math.sin(v)],A=this.properties.get("vignette-color");return A.a=this.properties.get("vignette"),{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new s.aj(o.r,o.g,o.b,o.a*p),direction:b,centerThinning:this.properties.get("center-thinning"),dropletSize:this.properties.get("droplet-size"),distortionStrength:this.properties.get("distortion-strength"),vignetteColor:A}}get(){return this._transitionable.serialize()}set(p,o,c={}){if(this._validate(zu,p,c))return;const m=s.l({},p);for(const v of Object.keys(s.a3.rain))m[v]===void 0&&(m[v]=s.a3.rain[v].default);this._options=m,this._transitionable.setTransitionOrValue(this._options,o)}updateConfig(p){this._transitionable.setTransitionOrValue(this._options,new Map(p))}updateTransitions(p){this._transitioning=this._transitionable.transitioned(p,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(p){this.properties=this._transitioning.possiblyEvaluate(p)}_validate(p,o,c){return(!c||c.validate!==!1)&&Xs(this,p.call(Yn,s.l({value:o,style:{glyphs:!0,sprite:!0},styleSpec:s.a3})))}};class ti extends s.E{constructor(o,c,m,v){super(),this.scope=m,this._options=o,this.properties=new s.ad(c),this._transitionable=new s.a4(c,m,new Map(v)),this._transitionable.setTransitionOrValue(o.properties),this._transitioning=this._transitionable.untransitioned()}updateConfig(o){this._transitionable.setTransitionOrValue(this._options.properties,new Map(o))}updateTransitions(o){this._transitioning=this._transitionable.transitioned(o,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(o){this.properties=this._transitioning.possiblyEvaluate(o)}get(){return this._options.properties=this._transitionable.serialize(),this._options}set(o,c){this._options=o,this._transitionable.setTransitionOrValue(o.properties,c)}shadowsEnabled(){return!!this.properties&&this.properties.get("cast-shadows")===!0}}class Jt{constructor(o,c,m,v){this.screenBounds=o,this.cameraPoint=c,this._screenRaycastCache={},this._cameraRaycastCache={},this.isAboveHorizon=m,this.screenGeometry=this.bufferedScreenGeometry(0),this.screenGeometryMercator=this._bufferedScreenMercator(0,v)}static createFromScreenPoints(o,c){let m,v;if(o instanceof s.P||typeof o[0]=="number"){const b=s.P.convert(o);m=[b],v=c.isPointAboveHorizon(b)}else{const b=s.P.convert(o[0]),A=s.P.convert(o[1]);m=[b,A],v=s.al(b,A).every(M=>c.isPointAboveHorizon(M))}return new Jt(m,c.getCameraPoint(),v,c)}isPointQuery(){return this.screenBounds.length===1}bufferedScreenGeometry(o){return s.al(this.screenBounds[0],this.screenBounds.length===1?this.screenBounds[0]:this.screenBounds[1],o)}bufferedCameraGeometry(o){const c=this.screenBounds[0],m=this.screenBounds.length===1?this.screenBounds[0].add(new s.P(1,1)):this.screenBounds[1],v=s.al(c,m,0,!1);return this.cameraPoint.y>m.y&&(this.cameraPoint.x>c.x&&this.cameraPoint.x<m.x?v.splice(3,0,this.cameraPoint):this.cameraPoint.x>=m.x?v[2]=this.cameraPoint:this.cameraPoint.x<=c.x&&(v[3]=this.cameraPoint)),s.am(v,o)}bufferedCameraGeometryGlobe(o){const c=this.screenBounds[0],m=this.screenBounds.length===1?this.screenBounds[0].add(new s.P(1,1)):this.screenBounds[1],v=s.al(c,m,o),b=this.cameraPoint.clone();switch(3*((b.y>c.y)+(b.y>m.y))+((b.x>c.x)+(b.x>m.x))){case 0:v[0]=b,v[4]=b.clone();break;case 1:v.splice(1,0,b);break;case 2:v[1]=b;break;case 3:v.splice(4,0,b);break;case 5:v.splice(2,0,b);break;case 6:v[3]=b;break;case 7:v.splice(3,0,b);break;case 8:v[2]=b}return v}containsTile(o,c,m,v=0){const b=o.queryPadding/c._pixelsPerMercatorPixel+1,A=m?this._bufferedCameraMercator(b,c):this._bufferedScreenMercator(b,c);let M=o.tileID.wrap+(A.unwrapped?v:0);const O=A.polygon.map(te=>s.an(o.tileTransform,te,M));if(!s.ao(O,0,0,s.ag,s.ag))return;M=o.tileID.wrap+(this.screenGeometryMercator.unwrapped?v:0);const k=this.screenGeometryMercator.polygon.map(te=>s.ap(o.tileTransform,te,M)),L=k.map(te=>new s.P(te[0],te[1])),U=c.getFreeCameraOptions().position||new s.aa(0,0,0),j=s.ap(o.tileTransform,U,M),$=k.map(te=>{const ee=s.ab.vec3.sub(te,te,j);return s.ab.vec3.normalize(ee,ee),new s.aq(j,ee)}),Q=s.ar(o,1,c.zoom)*c._pixelsPerMercatorPixel;return{queryGeometry:this,tilespaceGeometry:L,tilespaceRays:$,bufferedTilespaceGeometry:O,bufferedTilespaceBounds:(Z=s.as(O),Z.min.x=s.aw(Z.min.x,0,s.ag),Z.min.y=s.aw(Z.min.y,0,s.ag),Z.max.x=s.aw(Z.max.x,0,s.ag),Z.max.y=s.aw(Z.max.y,0,s.ag),Z),tile:o,tileID:o.tileID,pixelToTileUnitsFactor:Q};var Z}_bufferedScreenMercator(o,c){const m=vi(o);if(this._screenRaycastCache[m])return this._screenRaycastCache[m];{let v;return v=c.projection.name==="globe"?this._projectAndResample(this.bufferedScreenGeometry(o),c):{polygon:this.bufferedScreenGeometry(o).map(b=>c.pointCoordinate3D(b)),unwrapped:!0},this._screenRaycastCache[m]=v,v}}_bufferedCameraMercator(o,c){const m=vi(o);if(this._cameraRaycastCache[m])return this._cameraRaycastCache[m];{let v;return v=c.projection.name==="globe"?this._projectAndResample(this.bufferedCameraGeometryGlobe(o),c):{polygon:this.bufferedCameraGeometry(o).map(b=>c.pointCoordinate3D(b)),unwrapped:!0},this._cameraRaycastCache[m]=v,v}}_projectAndResample(o,c){const m=function(b,A){const M=s.ab.mat4.multiply([],A.pixelMatrix,A.globeMatrix),O=[0,-s.ax,0,1],k=[0,s.ax,0,1],L=[0,0,0,1];s.ab.vec4.transformMat4(O,O,M),s.ab.vec4.transformMat4(k,k,M),s.ab.vec4.transformMat4(L,L,M);const U=new s.P(O[0]/O[3],O[1]/O[3]),j=new s.P(k[0]/k[3],k[1]/k[3]),$=s.au(b,U)&&O[3]<L[3],Q=s.au(b,j)&&k[3]<L[3];if(!$&&!Q)return null;const Z=function(be,ye,Ie){for(let Fe=1;Fe<be.length;Fe++){const Qe=Di(ye.pointCoordinate3D(be[Fe-1]).x),We=Di(ye.pointCoordinate3D(be[Fe]).x);if(Ie<0){if(Qe<We)return{idx:Fe,t:-Qe/(We-1-Qe)}}else if(We<Qe)return{idx:Fe,t:(1-Qe)/(We+1-Qe)}}return null}(b,A,$?-1:1);if(!Z)return null;const{idx:te,t:ee}=Z;let ae=te>1?Ii(b.slice(0,te),A):[],me=te<b.length?Ii(b.slice(te),A):[];ae=ae.map(be=>new s.P(Di(be.x),be.y)),me=me.map(be=>new s.P(Di(be.x),be.y));const fe=[...ae];fe.length===0&&fe.push(me[me.length-1]);const Ae=s.af(fe[fe.length-1].y,(me.length===0?ae[0]:me[0]).y,ee);let ve;return ve=$?[new s.P(0,Ae),new s.P(0,0),new s.P(1,0),new s.P(1,Ae)]:[new s.P(1,Ae),new s.P(1,1),new s.P(0,1),new s.P(0,Ae)],fe.push(...ve),me.length===0?fe.push(ae[0]):fe.push(...me),{polygon:fe.map(be=>new s.aa(be.x,be.y)),unwrapped:!1}}(o,c);if(m)return m;const v=function(b,A){let M=!1,O=-1/0,k=0;for(let U=0;U<b.length-1;U++)b[U].x>O&&(O=b[U].x,k=U);for(let U=0;U<b.length-1;U++){const j=(k+U)%(b.length-1),$=b[j],Q=b[j+1];Math.abs($.x-Q.x)>.5&&($.x<Q.x?($.x+=1,j===0&&(b[b.length-1].x+=1)):(Q.x+=1,j+1===b.length-1&&(b[0].x+=1)),M=!0)}const L=s.at(A.center.lng);return M&&L<Math.abs(L-1)&&b.forEach(U=>{U.x-=1}),{polygon:b,unwrapped:M}}(Ii(o,c).map(b=>new s.P(Di(b.x),b.y)),c);return{polygon:v.polygon.map(b=>new s.aa(b.x,b.y)),unwrapped:v.unwrapped}}}function Ii(p,o){return s.av(p,c=>{const m=o.pointCoordinate3D(c);c.x=m.x,c.y=m.y},1/256)}function Di(p){return p<0?1+p%1:p%1}function vi(p){return 100*p|0}function ki(p,o,c,m,v){const b=function(M,O){if(M)return v(M);if(O){if(p.url&&O.tiles&&p.tiles&&delete p.tiles,O.variants){if(!Array.isArray(O.variants))return v(new Error("variants must be an array"));for(const L of O.variants){if(L==null||typeof L!="object"||L.constructor!==Object)return v(new Error("variant must be an object"));if(!Array.isArray(L.capabilities))return v(new Error("capabilities must be an array"));if(L.capabilities.length===1&&L.capabilities[0]==="meshopt"){O=s.l(O,L);break}}}const k=s.ay(s.l({},O,p),["tilejson","tiles","minzoom","maxzoom","attribution","mapbox_logo","bounds","scheme","tileSize","encoding","vector_layers","raster_layers","worldview_options","worldview_default","worldview"]);k.tiles=o.canonicalizeTileset(k,p.url),v(null,k)}},A=function(M,O,k){if(!M)return null;if(!O&&!k)return M;k=k||M.worldview_default;const L=Object.values(M.language||{});if(L.length===0)return null;const U=Object.values(M.worldview||{});if(U.length===0)return null;const j=L.every(Q=>Q===O),$=U.every(Q=>Q===k);return j&&$?M:O in(M.language_options||{})||k in(M.worldview_options||{})?null:M.language_options&&M.worldview_options?M:null}(p.data,c,m);return A?s.q.frame(()=>b(null,A)):p.url?s.n(o.transformRequest(o.normalizeSourceURL(p.url,null,c,m),s.R.Source),b):s.q.frame(()=>{const{data:M,...O}=p;b(null,O)})}class zi{constructor(o,c,m){this.bounds=s.az.convert(this.validateBounds(o)),this.minzoom=c||0,this.maxzoom=m||24}validateBounds(o){return Array.isArray(o)&&o.length===4?[Math.max(-180,o[0]),Math.max(-90,o[1]),Math.min(180,o[2]),Math.min(90,o[3])]:[-180,-90,180,90]}contains(o){const c=Math.pow(2,o.z),m=Math.floor(s.at(this.bounds.getWest())*c),v=Math.floor(s.aA(this.bounds.getNorth())*c),b=Math.ceil(s.at(this.bounds.getEast())*c),A=Math.ceil(s.aA(this.bounds.getSouth())*c);return o.x>=m&&o.x<b&&o.y>=v&&o.y<A}}class Dr extends s.E{constructor(o,c,m,v){if(super(),this.id=o,this.dispatcher=m,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,s.l(this,s.ay(c,["url","scheme","tileSize","promoteId"])),this._options=s.l({type:"vector"},c),this._collectResourceTiming=!!c.collectResourceTiming,this.tileSize!==512)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(v),this._tileWorkers={},this._deduped=new s.aB}load(o){this._loaded=!1,this.fire(new s.z("dataloading",{dataType:"source"}));const c=Array.isArray(this.map._language)?this.map._language.join():this.map._language,m=this.map.getWorldview();this._tileJSONRequest=ki(this._options,this.map._requestManager,c,m,(v,b)=>{if(this._tileJSONRequest=null,this._loaded=!0,v)c&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${c}`),m&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${m}`),this.fire(new s.y(v));else if(b){if(s.l(this,b),this.hasWorldviews=!!b.worldview_options,b.worldview_default&&(this.worldviewDefault=b.worldview_default),b.vector_layers){this.vectorLayers=b.vector_layers,this.vectorLayerIds=[],this.localizableLayerIds=new Set;for(const A of b.vector_layers)this.vectorLayerIds.push(A.id),b.worldview&&b.worldview[A.source]&&this.localizableLayerIds.add(A.id)}b.bounds&&(this.tileBounds=new zi(b.bounds,this.minzoom,this.maxzoom)),Kr(b.tiles,this.map._requestManager._customAccessToken),this.fire(new s.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new s.z("data",{dataType:"source",sourceDataType:"content"}))}o&&o(v)})}loaded(){return this._loaded}hasTile(o){return!this.tileBounds||this.tileBounds.contains(o.canonical)}onAdd(o){this.map=o,this.load()}reload(){this.cancelTileJSONRequest();const o=s.aC(this.id,this.scope);this.load(()=>this.map.style.clearSource(o))}setTiles(o){return this._options.tiles=o,this.reload(),this}setUrl(o){return this.url=o,this._options.url=o,this.reload(),this}onRemove(o){this.cancelTileJSONRequest()}serialize(){return s.l({},this._options)}loadTile(o,c){const m=o.tileID.canonical.url(this.tiles,this.scheme),v=this.map._requestManager.normalizeTileURL(m),b=this.map._requestManager.transformRequest(v,s.R.Tile),A=this.map.style?this.map.style.getLut(this.scope):null,M=A?{image:A.image.clone()}:null,O={request:b,data:void 0,uid:o.uid,tileID:o.tileID,tileZoom:o.tileZoom,zoom:o.tileID.overscaledZ,maxZoom:this.maxzoom,lut:M,tileSize:this.tileSize*o.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,pixelRatio:s.q.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,isSymbolTile:o.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:o.isExtraShadowCaster,tessellationStep:this.map._tessellationStep,scaleFactor:this.map.getScaleFactor()};if(this.hasWorldviews&&s.f(m)&&(O.worldview=this.map.getWorldview()||this.worldviewDefault,O.localizableLayerIds=this.localizableLayerIds),O.request.collectResourceTiming=this._collectResourceTiming,o.actor&&o.state!=="expired")o.state==="loading"?o.reloadCallback=c:o.request=o.actor.send("reloadTile",O,k.bind(this));else if(o.actor=this._tileWorkers[v]=this._tileWorkers[v]||this.dispatcher.getActor(),this.dispatcher.ready)o.request=o.actor.send("loadTile",O,k.bind(this),void 0,!0);else{const L=s.aD.call({deduped:this._deduped},O,(U,j)=>{U||!j?k.call(this,U):(O.data={cacheControl:j.cacheControl,expires:j.expires,rawData:j.rawData.slice(0)},o.actor&&o.actor.send("loadTile",O,k.bind(this),void 0,!0))},!0);o.request={cancel:L}}function k(L,U){return delete o.request,o.aborted?c(null):L&&L.status!==404?c(L):(U&&U.resourceTiming&&(o.resourceTiming=U.resourceTiming),this.map._refreshExpiredTiles&&U&&o.setExpiryData(U),o.loadVectorData(U,this.map.painter),s.aE(this.dispatcher),c(null),void(o.reloadCallback&&(this.loadTile(o,o.reloadCallback),o.reloadCallback=null)))}}abortTile(o){o.request&&(o.request.cancel(),delete o.request),o.actor&&o.actor.send("abortTile",{uid:o.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(o,c){o.actor&&o.actor.send("removeTile",{uid:o.uid,type:this.type,source:this.id,scope:this.scope}),o.destroy()}hasTransition(){return!1}afterUpdate(){this._tileWorkers={}}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class Zs extends s.E{constructor(o,c,m,v){super(),this.id=o,this.dispatcher=m,this.setEventedParent(v),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=s.l({type:"raster"},c),s.l(this,s.ay(c,["url","scheme","tileSize"]))}load(o){this._loaded=!1,this.fire(new s.z("dataloading",{dataType:"source"})),this._tileJSONRequest=ki(this._options,this.map._requestManager,null,null,(c,m)=>{this._tileJSONRequest=null,this._loaded=!0,c?this.fire(new s.y(c)):m&&(s.l(this,m),m.raster_layers&&(this.rasterLayers=m.raster_layers,this.rasterLayerIds=this.rasterLayers.map(v=>v.id)),m.bounds&&(this.tileBounds=new zi(m.bounds,this.minzoom,this.maxzoom)),Kr(m.tiles),this.fire(new s.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new s.z("data",{dataType:"source",sourceDataType:"content"}))),o&&o(c)})}loaded(){return this._loaded}onAdd(o){this.map=o,this.load()}reload(){this.cancelTileJSONRequest();const o=s.aC(this.id,this.scope);this.load(()=>this.map.style.clearSource(o))}setTiles(o){return this._options.tiles=o,this.reload(),this}setUrl(o){return this.url=o,this._options.url=o,this.reload(),this}onRemove(o){this.cancelTileJSONRequest()}serialize(){return s.l({},this._options)}hasTile(o){return!this.tileBounds||this.tileBounds.contains(o.canonical)}loadTile(o,c){const m=s.q.devicePixelRatio>=2,v=this.map._requestManager.normalizeTileURL(o.tileID.canonical.url(this.tiles,this.scheme),m,this.tileSize);o.request=s.o(this.map._requestManager.transformRequest(v,s.R.Tile),(b,A,M,O)=>(delete o.request,o.aborted?(o.state="unloaded",c(null)):b?(o.state="errored",c(b)):A?(this.map._refreshExpiredTiles&&o.setExpiryData({cacheControl:M,expires:O}),o.setTexture(A,this.map.painter),o.state="loaded",s.aE(this.dispatcher),void c(null)):c(null)))}abortTile(o,c){o.request&&(o.request.cancel(),delete o.request),c&&c()}unloadTile(o,c){o.texture&&o.texture instanceof s.T?(o.destroy(!0),o.texture&&o.texture instanceof s.T&&this.map.painter.saveTileTexture(o.texture)):o.destroy(),c&&c()}hasTransition(){return!1}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class jr extends Zs{constructor(o,c,m,v){super(o,c,m,v),this.type="raster-array",this.maxzoom=22,this._options=s.l({type:"raster-array"},c)}triggerRepaint(o){const c=this.map.painter._terrain,m=this.map.style.getSourceCache(this.id);c&&c.enabled&&m&&c._clearRenderCacheForTile(m.id,o.tileID),this.map.triggerRepaint()}loadTile(o,c){const m=this.map._requestManager.normalizeTileURL(o.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize),v=this.map._requestManager.transformRequest(m,s.R.Tile);o.requestParams=v,o.actor||(o.actor=this.dispatcher.getActor()),o.request=o.fetchHeader(void 0,(b,A,M,O)=>{if(delete o.request,o.aborted)return o.state="unloaded",c(null);if(b)return b.code===20?void 0:(o.state="errored",c(b));this.map._refreshExpiredTiles&&o.setExpiryData({cacheControl:M,expires:O}),o.state="empty",c(null)})}unloadTile(o,c){const m=o.texture;m&&m instanceof s.T?(o.destroy(!0),this.map.painter.saveTileTexture(m)):(o.destroy(),o.flushQueues(),o._isHeaderLoaded=!1,delete o._mrt,delete o.textureDescriptor),o.fbo&&(o.fbo.destroy(),delete o.fbo),delete o.request,delete o.requestParams,delete o.neighboringTiles,o.state="unloaded"}prepareTile(o,c,m){o._isHeaderLoaded&&(o.state!=="empty"&&(o.state="reloading"),o.fetchBand(c,m,(v,b)=>{if(v)return o.state="errored",this.fire(new s.y(v)),void this.triggerRepaint(o);b&&(o.setTexture(b,this.map.painter),o.state="loaded",this.triggerRepaint(o))}))}getInitialBand(o){if(!this.rasterLayers)return 0;const c=this.rasterLayers.find(({id:b})=>b===o),m=c&&c.fields,v=m&&m.bands&&m.bands;return v?v[0]:0}getTextureDescriptor(o,c,m){if(!o)return;const v=c.sourceLayer||this.rasterLayerIds&&this.rasterLayerIds[0];if(!v)return;let b=null;c instanceof s.aH?b=c.paint.get("raster-array-band"):c instanceof s.aI&&(b=c.paint.get("raster-particle-array-band"));const A=b||this.getInitialBand(v);if(A!=null)if(o.textureDescriptor){if(!o.updateNeeded(v,A)||m)return Object.assign({},o.textureDescriptor,{texture:o.texture})}else this.prepareTile(o,v,A)}}const qr={vector:Dr,raster:Zs,"raster-dem":class extends Zs{constructor(p,o,c,m){super(p,o,c,m),this.type="raster-dem",this.maxzoom=22,this._options=s.l({type:"raster-dem"},o),this.encoding=o.encoding||"mapbox"}loadTile(p,o){const c=this.map._requestManager.normalizeTileURL(p.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize);function m(v,b){v&&(p.state="errored",o(v)),b&&(p.dem=b,p.dem.onDeserialize(),p.needsHillshadePrepare=!0,p.needsDEMTextureUpload=!0,p.state="loaded",o(null))}p.request=s.o(this.map._requestManager.transformRequest(c,s.R.Tile),(function(v,b,A,M){if(delete p.request,p.aborted)p.state="unloaded",o(null);else if(v)p.state="errored",o(v);else if(b){this.map._refreshExpiredTiles&&p.setExpiryData({cacheControl:A,expires:M});const O=ImageBitmap&&b instanceof ImageBitmap&&s.t(),k=1-(b.width-s.aF(b.width))/2;k<1||p.neighboringTiles||(p.neighboringTiles=this._getNeighboringTiles(p.tileID));const L=O?b:s.q.getImageData(b,k),U={uid:p.uid,coord:p.tileID,source:this.id,scope:this.scope,rawImageData:L,encoding:this.encoding,padding:k};p.actor&&p.state!=="expired"||(p.actor=this.dispatcher.getActor(),p.actor.send("loadDEMTile",U,m.bind(this),void 0,!0))}}).bind(this))}_getNeighboringTiles(p){const o=p.canonical,c=Math.pow(2,o.z),m=(o.x-1+c)%c,v=o.x===0?p.wrap-1:p.wrap,b=(o.x+1+c)%c,A=o.x+1===c?p.wrap+1:p.wrap,M={};return M[new s.aG(p.overscaledZ,v,o.z,m,o.y).key]={backfilled:!1},M[new s.aG(p.overscaledZ,A,o.z,b,o.y).key]={backfilled:!1},o.y>0&&(M[new s.aG(p.overscaledZ,v,o.z,m,o.y-1).key]={backfilled:!1},M[new s.aG(p.overscaledZ,p.wrap,o.z,o.x,o.y-1).key]={backfilled:!1},M[new s.aG(p.overscaledZ,A,o.z,b,o.y-1).key]={backfilled:!1}),o.y+1<c&&(M[new s.aG(p.overscaledZ,v,o.z,m,o.y+1).key]={backfilled:!1},M[new s.aG(p.overscaledZ,p.wrap,o.z,o.x,o.y+1).key]={backfilled:!1},M[new s.aG(p.overscaledZ,A,o.z,b,o.y+1).key]={backfilled:!1}),M}},"raster-array":jr,geojson:class extends s.E{constructor(p,o,c,m){super(),this.id=p,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._loaded=!1,this.actor=c.getActor(),this.setEventedParent(m),this._data=o.data,this._options=s.l({},o),this._collectResourceTiming=o.collectResourceTiming,o.maxzoom!==void 0&&(this.maxzoom=o.maxzoom),o.minzoom!==void 0&&(this.minzoom=o.minzoom),o.type&&(this.type=o.type),o.attribution&&(this.attribution=o.attribution),this.promoteId=o.promoteId;const v=s.ag/this.tileSize;this.workerOptions=s.l({source:this.id,scope:this.scope,cluster:o.cluster||!1,geojsonVtOptions:{buffer:(o.buffer!==void 0?o.buffer:128)*v,tolerance:(o.tolerance!==void 0?o.tolerance:.375)*v,extent:s.ag,maxZoom:this.maxzoom,lineMetrics:o.lineMetrics||!1,generateId:o.generateId||!1},superclusterOptions:{maxZoom:o.clusterMaxZoom!==void 0?o.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,o.clusterMinPoints||2),extent:s.ag,radius:(o.clusterRadius!==void 0?o.clusterRadius:50)*v,log:!1,generateId:o.generateId||!1},clusterProperties:o.clusterProperties,filter:o.filter,dynamic:o.dynamic},o.workerOptions)}onAdd(p){this.map=p,this.setData(this._data)}setData(p){return this._data=p,this._updateWorkerData(),this}updateData(p){if(!this._options.dynamic)return this.fire(new s.y(new Error("Can't call updateData on a GeoJSON source with dynamic set to false.")));if(typeof p!="string"&&(p.type==="Feature"&&(p={type:"FeatureCollection",features:[p]}),p.type!=="FeatureCollection"))return this.fire(new s.y(new Error("Data to update should be a feature or a feature collection.")));if(this._coalesce&&typeof p!="string"&&typeof this._data!="string"&&this._data.type==="FeatureCollection"){const o=new Map;for(const c of this._data.features)o.set(c.id,c);for(const c of p.features)o.set(c.id,c);this._data.features=[...o.values()]}else this._data=p;return this._updateWorkerData(!0),this}getClusterExpansionZoom(p,o){return this.actor.send("geojson.getClusterExpansionZoom",{clusterId:p,source:this.id,scope:this.scope},o),this}getClusterChildren(p,o){return this.actor.send("geojson.getClusterChildren",{clusterId:p,source:this.id,scope:this.scope},o),this}getClusterLeaves(p,o,c,m){return this.actor.send("geojson.getClusterLeaves",{source:this.id,scope:this.scope,clusterId:p,limit:o,offset:c},m),this}_updateWorkerData(p=!1){if(this._pendingLoad)return void(this._coalesce=!0);this.fire(new s.z("dataloading",{dataType:"source"})),this._loaded=!1;const o=s.l({append:p},this.workerOptions);o.scope=this.scope;const c=this._data;typeof c=="string"?(o.request=this.map._requestManager.transformRequest(s.q.resolveURL(c),s.R.Source),o.request.collectResourceTiming=this._collectResourceTiming):o.data=JSON.stringify(c),this._pendingLoad=this.actor.send(`${this.type}.loadData`,o,(m,v)=>{if(this._loaded=!0,this._pendingLoad=null,m)this.fire(new s.y(m));else{const b={dataType:"source",sourceDataType:this._metadataFired?"content":"metadata"};this._collectResourceTiming&&v&&v.resourceTiming&&v.resourceTiming[this.id]&&(b.resourceTiming=v.resourceTiming[this.id]),p&&(this._partialReload=!0),this.fire(new s.z("data",b)),this._partialReload=!1,this._metadataFired=!0}this._coalesce&&(this._updateWorkerData(p),this._coalesce=!1)})}loaded(){return this._loaded}reload(){const p=s.aC(this.id,this.scope);this.map.style.clearSource(p),this._updateWorkerData()}loadTile(p,o){const c=p.actor?"reloadTile":"loadTile";p.actor=this.actor;const m=this.map.style?this.map.style.getLut(this.scope):null,v=m?{image:m.image.clone()}:null,b=this._partialReload,A={type:this.type,uid:p.uid,tileID:p.tileID,tileZoom:p.tileZoom,zoom:p.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,lut:v,scope:this.scope,pixelRatio:s.q.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,brightness:this.map.style&&this.map.style.getBrightness()||0,scaleFactor:this.map.getScaleFactor(),partial:b};p.request=this.actor.send(c,A,(M,O)=>b&&!O?(p.state="loaded",o(null)):(delete p.request,p.destroy(),p.aborted?o(null):M?o(M):(p.loadVectorData(O,this.map.painter,c==="reloadTile"),o(null))),void 0,c==="loadTile")}abortTile(p){p.request&&(p.request.cancel(),delete p.request),p.aborted=!0}unloadTile(p,o){this.actor.send("removeTile",{uid:p.uid,type:this.type,source:this.id,scope:this.scope}),p.destroy()}onRemove(p){this._pendingLoad&&this._pendingLoad.cancel()}serialize(){return s.l({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}},video:class extends s.aJ{constructor(p,o,c,m){super(p,o,c,m),this.roundZoom=!0,this.type="video",this.options=o}load(){this._loaded=!1;const p=this.options;this.urls=[];for(const o of p.urls)this.urls.push(this.map._requestManager.transformRequest(o,s.R.Source).url);s.aK(this.urls,(o,c)=>{this._loaded=!0,o?this.fire(new s.y(o)):c&&(this.video=c,this.video.loop=!0,this.video.setAttribute("playsinline",""),this.video.addEventListener("playing",()=>{this.map.triggerRepaint()}),this.map&&this.video.play(),this._finishLoading())})}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(p){if(this.video){const o=this.video.seekable;p<o.start(0)||p>o.end(0)?this.fire(new s.y(new s.V(`sources.${this.id}`,null,`Playback for this video can be set only between the ${o.start(0)} and ${o.end(0)}-second mark.`))):this.video.currentTime=p}}getVideo(){return this.video}onAdd(p){this.map||(this.map=p,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(Object.keys(this.tiles).length===0||this.video.readyState<2)return;const p=this.map.painter.context,o=p.gl;this.texture?this.video.paused||(this.texture.bind(o.LINEAR,o.CLAMP_TO_EDGE),o.texSubImage2D(o.TEXTURE_2D,0,0,0,o.RGBA,o.UNSIGNED_BYTE,this.video)):(this.texture=new s.T(p,this.video,o.RGBA8),this.texture.bind(o.LINEAR,o.CLAMP_TO_EDGE),this.width=this.video.videoWidth,this.height=this.video.videoHeight),this._prepareData(p)}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}},image:s.aJ,model:class extends s.E{constructor(p,o,c,m){super(),this.id=p,this.type="model",this.models=[],this._loaded=!1,this._options=o}load(){const p=[];for(const o in this._options.models){const c=this._options.models[o],m=s.aM(this.map._requestManager.transformRequest(c.uri,s.R.Model).url).then(v=>{if(!v)return;const b=s.aN(v),A=new s.aO(o,c.position,c.orientation,b);A.computeBoundsAndApplyParent(),this.models.push(A)}).catch(v=>{this.fire(new s.y(new Error(`Could not load model ${o} from ${c.uri}: ${v.message}`)))});p.push(m)}return Promise.allSettled(p).then(()=>{this._loaded=!0,this.fire(new s.z("data",{dataType:"source",sourceDataType:"metadata"}))}).catch(o=>{this.fire(new s.y(new Error(`Could not load models: ${o.message}`)))})}onAdd(p){this.map=p,this.load()}hasTransition(){return!1}loaded(){return this._loaded}getModels(){return this.models}loadTile(p,o){}serialize(){return{type:"model"}}},"batched-model":class extends s.E{constructor(p,o,c,m){super(),this.type="batched-model",this.id=p,this.tileSize=512,this._options=o,this.tiles=this._options.tiles,this.maxzoom=o.maxzoom||19,this.minzoom=o.minzoom||0,this.roundZoom=!0,this.usedInConflation=!0,this.dispatcher=c,this.reparseOverscaled=!1,this.scheme="xyz",this._loaded=!1,this.setEventedParent(m)}onAdd(p){this.map=p,this.load()}reload(){this.cancelTileJSONRequest();const p=s.aC(this.id,this.scope);this.load(()=>this.map.style.clearSource(p))}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}load(p){this._loaded=!1,this.fire(new s.z("dataloading",{dataType:"source"}));const o=Array.isArray(this.map._language)?this.map._language.join():this.map._language,c=this.map.getWorldview();this._tileJSONRequest=ki(this._options,this.map._requestManager,o,c,(m,v)=>{this._tileJSONRequest=null,this._loaded=!0,m?(o&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${o}`),c&&c.length!==2&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${c}`),this.fire(new s.y(m))):v&&(s.l(this,v),v.bounds&&(this.tileBounds=new zi(v.bounds,this.minzoom,this.maxzoom)),Kr(v.tiles,this.map._requestManager._customAccessToken),this.fire(new s.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new s.z("data",{dataType:"source",sourceDataType:"content"}))),p&&p(m)})}hasTransition(){return!1}hasTile(p){return!this.tileBounds||this.tileBounds.contains(p.canonical)}loaded(){return this._loaded}loadTile(p,o){const c=this.map._requestManager.normalizeTileURL(p.tileID.canonical.url(this.tiles,this.scheme)),m={request:this.map._requestManager.transformRequest(c,s.R.Tile),data:void 0,uid:p.uid,tileID:p.tileID,tileZoom:p.tileZoom,zoom:p.tileID.overscaledZ,tileSize:this.tileSize*p.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,showCollisionBoxes:this.map.showCollisionBoxes,isSymbolTile:p.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,lut:null,maxZoom:null,promoteId:null,pixelRatio:null,scaleFactor:null};if(p.actor&&p.state!=="expired")if(p.state==="loading")p.reloadCallback=o;else{if(p.buckets){const b=Object.values(p.buckets);for(const A of b)A.dirty=!0;return void(p.state="loaded")}p.request=p.actor.send("reloadTile",m,v.bind(this))}else p.actor=this.dispatcher.getActor(),p.request=p.actor.send("loadTile",m,v.bind(this),void 0,!0);function v(b,A){return p.aborted?o(null):b&&b.status!==404?o(b):(this.map._refreshExpiredTiles&&A&&p.setExpiryData(A),p.loadModelData(A,this.map.painter),p.state="loaded",void o(null))}}serialize(){return s.l({},this._options)}},canvas:class extends s.aJ{constructor(p,o,c,m){super(p,o,c,m),o.coordinates?Array.isArray(o.coordinates)&&o.coordinates.length===4&&!o.coordinates.some(v=>!Array.isArray(v)||v.length!==2||v.some(b=>typeof b!="number"))||this.fire(new s.y(new s.V(`sources.${p}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new s.y(new s.V(`sources.${p}`,null,'missing required property "coordinates"'))),o.animate&&typeof o.animate!="boolean"&&this.fire(new s.y(new s.V(`sources.${p}`,null,'optional "animate" property must be a boolean value'))),o.canvas?typeof o.canvas=="string"||o.canvas instanceof HTMLCanvasElement||this.fire(new s.y(new s.V(`sources.${p}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new s.y(new s.V(`sources.${p}`,null,'missing required property "canvas"'))),this.options=o,this.animate=o.animate===void 0||o.animate}load(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof HTMLCanvasElement?this.options.canvas:document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new s.y(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}getCanvas(){return this.canvas}onAdd(p){this.map=p,this.load(),this.canvas&&this.animate&&this.play()}onRemove(p){this.pause()}prepare(){let p=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,p=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,p=!0),this._hasInvalidDimensions()||Object.keys(this.tiles).length===0)return;const o=this.map.painter.context;this.texture?!p&&!this._playing||this.texture instanceof s.aL||this.texture.update(this.canvas,{premultiply:!0}):this.texture=new s.T(o,this.canvas,o.gl.RGBA8,{premultiply:!0}),this._prepareData(o)}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const p of[this.canvas.width,this.canvas.height])if(isNaN(p)||p<=0)return!0;return!1}},custom:class extends s.E{constructor(p,o,c,m){super(),this.id=p,this.type="custom",this._dataType="raster",this._dispatcher=c,this._implementation=o,this.setEventedParent(m),this.scheme="xyz",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this._loaded=!1,this.roundZoom=!0,this._implementation||this.fire(new s.y(new Error(`Missing implementation for ${this.id} custom source`))),this._implementation.loadTile||this.fire(new s.y(new Error(`Missing loadTile implementation for ${this.id} custom source`))),this._implementation.bounds&&(this.tileBounds=new zi(this._implementation.bounds,this.minzoom,this.maxzoom)),o.update=this._update.bind(this),o.clearTiles=this._clearTiles.bind(this),o.coveringTiles=this._coveringTiles.bind(this),s.l(this,s.ay(o,["dataType","scheme","minzoom","maxzoom","tileSize","attribution","minTileCacheSize","maxTileCacheSize"]))}serialize(){return s.ay(this,["type","scheme","minzoom","maxzoom","tileSize","attribution"])}load(){this._loaded=!0,this.fire(new s.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new s.z("data",{dataType:"source",sourceDataType:"content"}))}loaded(){return this._loaded}onAdd(p){this.map=p,this._loaded=!1,this.fire(new s.z("dataloading",{dataType:"source"})),this._implementation.onAdd&&this._implementation.onAdd(p),this.load()}onRemove(p){this._implementation.onRemove&&this._implementation.onRemove(p)}hasTile(p){if(this._implementation.hasTile){const{x:o,y:c,z:m}=p.canonical;return this._implementation.hasTile({x:o,y:c,z:m})}return!this.tileBounds||this.tileBounds.contains(p.canonical)}loadTile(p,o){const{x:c,y:m,z:v}=p.tileID.canonical,b=new AbortController;p.request=Promise.resolve(this._implementation.loadTile({x:c,y:m,z:v},{signal:b.signal})).then((function(A){return delete p.request,p.aborted?(p.state="unloaded",o(null)):A===void 0?(p.state="errored",o(null)):A===null?(this.loadTileData(p,{width:this.tileSize,height:this.tileSize,data:null}),p.state="loaded",o(null)):function(M){return M instanceof ImageData||M instanceof HTMLCanvasElement||M instanceof ImageBitmap||M instanceof HTMLImageElement}(A)?(this.loadTileData(p,A),p.state="loaded",void o(null)):(p.state="errored",o(new Error(`Can't infer data type for ${this.id}, only raster data supported at the moment`)))}).bind(this)).catch(A=>{A.code!==20&&(p.state="errored",o(A))}),p.request.cancel=()=>b.abort()}loadTileData(p,o){p.setTexture(o,this.map.painter)}unloadTile(p,o){if(p.texture&&p.texture instanceof s.T?(p.destroy(!0),p.texture&&p.texture instanceof s.T&&this.map.painter.saveTileTexture(p.texture)):p.destroy(),this._implementation.unloadTile){const{x:c,y:m,z:v}=p.tileID.canonical;this._implementation.unloadTile({x:c,y:m,z:v})}o&&o()}abortTile(p,o){p.request&&p.request.cancel&&(p.request.cancel(),delete p.request),o&&o()}hasTransition(){return!1}_coveringTiles(){return this.map.transform.coveringTiles({tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,roundZoom:this.roundZoom}).map(p=>({x:p.canonical.x,y:p.canonical.y,z:p.canonical.z}))}_clearTiles(){const p=s.aC(this.id,this.scope);this.map.style.clearSource(p)}_update(){this.fire(new s.z("data",{dataType:"source",sourceDataType:"content"}))}}},Rn=function(p,o,c,m){const v=new qr[o.type](p,o,c,m);if(v.id!==p)throw new Error(`Expected Source id to be ${p} instead of ${v.id}`);return s.aP(["load","abort","unload","serialize","prepare"],v),v};function hc(p,o,c=""){return`${c}:${o.id||""}:${o.layer.id}:${function(m){if("layerId"in m)return`layer:${m.layerId}`;{const{featuresetId:v,importId:b}=m;return`featureset:${v}${b?`:import:${b}`:""}`}}(p.target)}`}function Eo(p,o,c,m=""){if(p.uniqueFeatureID){const v=hc(p,o,m);if(c.has(v))return!0;c.add(v)}return!1}function dc(p,o,c,m,v=!1){const b=o.sourceCache.transform,A=o.sourceCache.tilesIn(p,o.has3DLayers,v);A.sort(Od);const M=[];for(const O of A){const k=O.tile.queryRenderedFeatures(o,O,c,m,b,v);Object.keys(k).length&&M.push({wrappedTileID:O.tile.tileID.wrapped().key,queryResults:k})}return M.length===0?{}:function(O){const k={},L={};for(const U of O){const j=U.queryResults,$=U.wrappedTileID,Q=L[$]=L[$]||{};for(const Z in j){const te=j[Z],ee=Q[Z]=Q[Z]||{},ae=k[Z]=k[Z]||[];for(const me of te)ee[me.featureIndex]||(ee[me.featureIndex]=!0,ae.push(me))}}return k}(M)}function Dd(p,o,c,m,v){const b={},A=m.queryRenderedSymbols(p),M=[];for(const O of Object.keys(A).map(Number))M.push(v[O]);M.sort(Od);for(const O of M){const k=O.featureIndex.lookupSymbolFeatures(A[O.bucketInstanceId],O.bucketIndex,O.sourceLayerIndex,o,c);for(const L in k){const U=b[L]=b[L]||[],j=k[L];j.sort(($,Q)=>{const Z=O.featureSortOrder;if(Z){const te=Z.indexOf($.featureIndex);return Z.indexOf(Q.featureIndex)-te}return Q.featureIndex-$.featureIndex});for(const $ of j)U.push($)}}return b}function zm(p,o){const c=p.getRenderableIds().map(b=>p.getTileByID(b)),m=[],v={};for(let b=0;b<c.length;b++){const A=c[b],M=A.tileID.canonical.key;v[M]||(v[M]=!0,A.querySourceFeatures(m,o))}return m}function Od(p,o){const c=p.tileID,m=o.tileID;return c.overscaledZ-m.overscaledZ||c.canonical.y-m.canonical.y||c.wrap-m.wrap||c.canonical.x-m.canonical.x}function Fd(p,o){const c={};if(!o)return c;for(const m of p){const v=m.layerIds.map(b=>o.getLayer(b)).filter(Boolean);if(v.length!==0){m.layers=v,m.stateDependentLayerIds&&(m.stateDependentLayers=m.stateDependentLayerIds.map(b=>v.filter(A=>A.id===b)[0]));for(const b of v)c[b.fqid]=m}}return c}const Pn=32,Ps=33,So=new Uint16Array(8184);for(let p=0;p<2046;p++){let o=p+2,c=0,m=0,v=0,b=0,A=0,M=0;for(1&o?v=b=A=Pn:c=m=M=Pn;(o>>=1)>1;){const k=c+v>>1,L=m+b>>1;1&o?(v=c,b=m,c=A,m=M):(c=v,m=b,v=A,b=M),A=k,M=L}const O=4*p;So[O+0]=c,So[O+1]=m,So[O+2]=v,So[O+3]=b}const Ys=new Uint16Array(2178),Bs=new Uint8Array(1089),Ks=new Uint16Array(1089);function ju(p){return p===0?-.03125:p===32?.03125:0}const kd={type:2,extent:s.ag,loadGeometry:()=>[[new s.P(0,0),new s.P(s.ag+1,0),new s.P(s.ag+1,s.ag+1),new s.P(0,s.ag+1),new s.P(0,0)]]};class Jo{constructor(o,c,m,v,b){this.tileID=o,this.uid=s.aV(),this.uses=0,this.tileSize=c,this.tileZoom=m,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.isRaster=b,v&&v.style&&(this._lastUpdatedBrightness=v.style.getBrightness()),this.expiredRequestCount=0,this.state="loading",v&&v.transform&&(this.projection=v.transform.projection)}registerFadeDuration(o){const c=o+this.timeAdded;c<s.q.now()||this.fadeEndTime&&c<this.fadeEndTime||(this.fadeEndTime=c)}wasRequested(){return this.state==="errored"||this.state==="loaded"||this.state==="reloading"}get tileTransform(){return this._tileTransform||(this._tileTransform=s.aQ(this.tileID.canonical,this.projection)),this._tileTransform}loadVectorData(o,c,m){if(this.unloadVectorData(),this.state="loaded",o){o.featureIndex&&(this.latestFeatureIndex=o.featureIndex,o.rawTileData?(this.latestRawTileData=o.rawTileData,this.latestFeatureIndex.rawTileData=o.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=o.collisionBoxArray,this.buckets=Fd(o.buckets,c.style),this.hasSymbolBuckets=!1;for(const v in this.buckets){const b=this.buckets[v];if(b instanceof s.aX){if(this.hasSymbolBuckets=!0,!m)break;b.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const v in this.buckets){const b=this.buckets[v];if(b instanceof s.aX&&b.hasRTLText){this.hasRTLText=!0,s.aY();break}}this.queryPadding=0;for(const v in this.buckets){const b=this.buckets[v],A=c.style.getOwnLayer(v);if(!A)continue;const M=A.queryRadius(b);this.queryPadding=Math.max(this.queryPadding,M)}o.imageAtlas&&(this.imageAtlas=o.imageAtlas),o.glyphAtlasImage&&(this.glyphAtlasImage=o.glyphAtlasImage),o.lineAtlas&&(this.lineAtlas=o.lineAtlas),this._lastUpdatedBrightness=o.brightness}else this.collisionBoxArray=new s.aW}unloadVectorData(){if(this.hasData()){for(const o in this.buckets)this.buckets[o].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.lineAtlasTexture&&this.lineAtlasTexture.destroy(),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),this.latestFeatureIndex=null,this.state="unloaded"}}loadModelData(o,c,m){o&&(o.resourceTiming&&(this.resourceTiming=o.resourceTiming),this.buckets=Object.assign({},this.buckets,Fd(o.buckets,c.style)),o.featureIndex&&(this.latestFeatureIndex=o.featureIndex))}getBucket(o){return this.buckets[o.fqid]}upload(o){for(const v in this.buckets){const b=this.buckets[v];b.uploadPending()&&b.upload(o)}const c=o.gl,m=this.imageAtlas;if(m&&!m.uploaded){const v=!!Object.keys(m.patternPositions).length;this.imageAtlasTexture=new s.T(o,m.image,c.RGBA8,{useMipmap:v}),this.imageAtlas.uploaded=!0}this.glyphAtlasImage&&(this.glyphAtlasTexture=new s.T(o,this.glyphAtlasImage,c.R8),this.glyphAtlasImage=null),this.lineAtlas&&!this.lineAtlas.uploaded&&(this.lineAtlasTexture=new s.T(o,this.lineAtlas.image,c.R8),this.lineAtlas.uploaded=!0)}prepare(o,c,m){if(this.imageAtlas&&this.imageAtlasTexture&&this.imageAtlas.patchUpdatedImages(o,this.imageAtlasTexture,m),!c||!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData)return;const v=c.style.getBrightness();(this._lastUpdatedBrightness||v)&&(this._lastUpdatedBrightness&&v&&Math.abs(this._lastUpdatedBrightness-v)<.001||(this.updateBuckets(c,this._lastUpdatedBrightness!==v),this._lastUpdatedBrightness=v))}queryRenderedFeatures(o,c,m,v,b,A){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData&&!this.latestFeatureIndex.is3DTile)return{};const M=function(O,k){const L=s.ab.mat4.fromScaling([],[.5*O.width,.5*-O.height,1]);return s.ab.mat4.translate(L,L,[1,-1,0]),s.ab.mat4.multiply(L,L,O.calculateProjMatrix(k.toUnwrapped())),Float32Array.from(L)}(b,this.tileID);return this.latestFeatureIndex.query(o,{tilespaceGeometry:c,pixelPosMatrix:M,transform:v,availableImages:m,tileTransform:this.tileTransform})}querySourceFeatures(o,c){const m=this.latestFeatureIndex;if(!m||!m.rawTileData)return;const v=m.loadVTLayers(),b=c?c.sourceLayer:"",A=v._geojsonTileLayer||v[b];if(!A)return;const M=s.aZ(c&&c.filter),{z:O,x:k,y:L}=this.tileID.canonical,U={z:O,x:k,y:L};for(let j=0;j<A.length;j++){const $=A.feature(j);if(M.needGeometry){const te=s.a_($,!0);if(!M.filter(new s.a8(this.tileID.overscaledZ),te,this.tileID.canonical))continue}else if(!M.filter(new s.a8(this.tileID.overscaledZ),$))continue;const Q=m.getId($,b),Z=new s.a$($,O,k,L,Q);Z.tile=U,o.push(Z)}}hasData(){return this.state==="loaded"||this.state==="reloading"||this.state==="expired"}patternsLoaded(){return!!this.imageAtlas&&!!Object.keys(this.imageAtlas.patternPositions).length}setExpiryData(o){const c=this.expirationTime;if(o.cacheControl){const m=s.b0(o.cacheControl);m["max-age"]&&(this.expirationTime=Date.now()+1e3*m["max-age"])}else o.expires&&(this.expirationTime=new Date(o.expires).getTime());if(this.expirationTime){const m=Date.now();let v=!1;if(this.expirationTime>m)v=!1;else if(c)if(this.expirationTime<c)v=!0;else{const b=this.expirationTime-c;b?this.expirationTime=m+Math.max(b,3e4):v=!0}else v=!0;v?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-new Date().getTime(),Math.pow(2,31)-1)}refreshFeatureState(o){this.latestFeatureIndex&&(this.latestFeatureIndex.rawTileData||this.latestFeatureIndex.is3DTile)&&o&&this.updateBuckets(o)}updateBuckets(o,c){if(!this.latestFeatureIndex||!o.style)return;const m=this.latestFeatureIndex.loadVTLayers(),v=o.style.listImages(),b=o.style.getBrightness();for(const A in this.buckets){if(!o.style.hasLayer(A))continue;const M=this.buckets[A],O=M.layers[0],k=O.sourceLayer||"_geojsonTileLayer",L=m[k],U=o.style.getLayerSourceCache(O);let j={};U&&(j=U._state.getState(k,void 0));const $=this.imageAtlas&&this.imageAtlas.patternPositions||{},Q=Object.keys(j).length>0&&!c;Q&&!M.stateDependentLayers.length&&!c||M.update(j,L,v,$,Q?M.stateDependentLayers:M.layers,c,b),(M instanceof s.b1||M instanceof s.b2)&&o._terrain&&o._terrain.enabled&&U&&M.programConfigurations.needsUpload&&o._terrain._clearRenderCacheForTile(U.id,this.tileID);const Z=o&&o.style&&o.style.getOwnLayer(A);Z&&(this.queryPadding=Math.max(this.queryPadding,Z.queryRadius(M)))}}holdingForFade(){return this.symbolFadeHoldUntil!==void 0}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<s.q.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(o){this.symbolFadeHoldUntil=s.q.now()+o}setTexture(o,c){const m=c.context,v=m.gl;this.texture=this.texture||c.getTileTexture(o.width),this.texture&&this.texture instanceof s.T?this.texture.update(o):(this.texture=new s.T(m,o,v.RGBA8,{useMipmap:!0}),this.texture.bind(v.LINEAR,v.CLAMP_TO_EDGE))}setDependencies(o,c){const m={};for(const v of c)m[v]=!0;this.dependencies[o]=m}hasDependency(o,c){for(const m of o){const v=this.dependencies[m];if(v){for(const b of c)if(v[b])return!0}}return!1}clearQueryDebugViz(){}_makeDebugTileBoundsBuffers(o,c){if(!c||c.name==="mercator"||this._tileDebugBuffer)return;const m=s.b3(kd,this.tileID.canonical,this.tileTransform)[0],v=new s.b4,b=new s.b5;for(let A=0;A<m.length;A++){const{x:M,y:O}=m[A];v.emplaceBack(M,O),b.emplaceBack(A)}b.emplaceBack(0),this._tileDebugIndexBuffer=o.createIndexBuffer(b),this._tileDebugBuffer=o.createVertexBuffer(v,s.b6.members),this._tileDebugSegments=s.b7.simpleSegment(0,0,v.length,b.length)}_makeTileBoundsBuffers(o,c){if(this._tileBoundsBuffer||!c||c.name==="mercator")return;const m=s.b3(kd,this.tileID.canonical,this.tileTransform)[0];let v,b;if(this.isRaster){const A=function(M,O){const k=s.aQ(M,O),L=Math.pow(2,M.z);for(let te=0;te<Ps;te++)for(let ee=0;ee<Ps;ee++){const ae=s.aR((M.x+(ee+ju(ee))/Pn)/L),me=s.aS((M.y+(te+ju(te))/Pn)/L),fe=O.project(ae,me),Ae=te*Ps+ee;Ys[2*Ae+0]=Math.round((fe.x*k.scale-k.x)*s.ag),Ys[2*Ae+1]=Math.round((fe.y*k.scale-k.y)*s.ag)}Bs.fill(0),Ks.fill(0);for(let te=2045;te>=0;te--){const ee=4*te,ae=So[ee+0],me=So[ee+1],fe=So[ee+2],Ae=So[ee+3],ve=ae+fe>>1,be=me+Ae>>1,ye=ve+be-me,Ie=be+ae-ve,Fe=me*Ps+ae,Qe=Ae*Ps+fe,We=be*Ps+ve,at=Math.hypot((Ys[2*Fe+0]+Ys[2*Qe+0])/2-Ys[2*We+0],(Ys[2*Fe+1]+Ys[2*Qe+1])/2-Ys[2*We+1])>=16;Bs[We]=Bs[We]||(at?1:0),te<1022&&(Bs[We]=Bs[We]||Bs[(me+Ie>>1)*Ps+(ae+ye>>1)]||Bs[(Ae+Ie>>1)*Ps+(fe+ye>>1)])}const U=new s.aT,j=new s.aU;let $=0;function Q(te,ee){const ae=ee*Ps+te;return Ks[ae]===0&&(U.emplaceBack(Ys[2*ae+0],Ys[2*ae+1],te*s.ag/Pn,ee*s.ag/Pn),Ks[ae]=++$),Ks[ae]-1}function Z(te,ee,ae,me,fe,Ae){const ve=te+ae>>1,be=ee+me>>1;if(Math.abs(te-fe)+Math.abs(ee-Ae)>1&&Bs[be*Ps+ve])Z(fe,Ae,te,ee,ve,be),Z(ae,me,fe,Ae,ve,be);else{const ye=Q(te,ee),Ie=Q(ae,me),Fe=Q(fe,Ae);j.emplaceBack(ye,Ie,Fe)}}return Z(0,0,Pn,Pn,Pn,0),Z(Pn,Pn,0,0,0,Pn),{vertices:U,indices:j}}(this.tileID.canonical,c);v=A.vertices,b=A.indices}else{v=new s.aT,b=new s.aU;for(const{x:M,y:O}of m)v.emplaceBack(M,O,0,0);const A=s.b8(v.int16,void 0,4);for(let M=0;M<A.length;M+=3)b.emplaceBack(A[M],A[M+1],A[M+2])}this._tileBoundsBuffer=o.createVertexBuffer(v,s.b9.members),this._tileBoundsIndexBuffer=o.createIndexBuffer(b),this._tileBoundsSegments=s.b7.simpleSegment(0,0,v.length,b.length)}_makeGlobeTileDebugBuffers(o,c){const m=c.projection;if(!m||m.name!=="globe"||c.freezeTileCoverage)return;const v=this.tileID.canonical,b=s.ba(v,c),A=s.bb(b),M=s.ae(c.zoom);let O;M>0&&(O=s.ab.mat4.invert(new Float64Array(16),c.globeMatrix)),this._makeGlobeTileDebugBorderBuffer(o,v,c,A,O,M),this._makeGlobeTileDebugTextBuffer(o,v,c,A,O,M)}_globePoint(o,c,m,v,b,A,M){let O=s.bc(o,c,m);if(A){const k=1<<m.z,L=s.at(v.center.lng),U=s.aA(v.center.lat),j=(m.x+.5)/k-L;let $=0;j>.5?$=-1:j<-.5&&($=1);let Q=(o/s.ag+m.x)/k+$,Z=(c/s.ag+m.y)/k;Q=(Q-L)*v._pixelsPerMercatorPixel+L,Z=(Z-U)*v._pixelsPerMercatorPixel+U;const te=[Q*v.worldSize,Z*v.worldSize,0];s.ab.vec3.transformMat4(te,te,A),O=s.bd(O,te,M)}return s.ab.vec3.transformMat4(O,O,b)}_makeGlobeTileDebugBorderBuffer(o,c,m,v,b,A){const M=new s.b4,O=new s.b5,k=new s.be,L=(j,$,Q,Z,te)=>{const ee=(Q-j)/(te-1),ae=(Z-$)/(te-1),me=M.length;for(let fe=0;fe<te;fe++){const Ae=j+fe*ee,ve=$+fe*ae;M.emplaceBack(Ae,ve);const be=this._globePoint(Ae,ve,c,m,v,b,A);k.emplaceBack(be[0],be[1],be[2]),O.emplaceBack(me+fe)}},U=s.ag;L(0,0,U,0,16),L(U,0,U,U,16),L(U,U,0,U,16),L(0,U,0,0,16),this._tileDebugIndexBuffer=o.createIndexBuffer(O),this._tileDebugBuffer=o.createVertexBuffer(M,s.b6.members),this._globeTileDebugBorderBuffer=o.createVertexBuffer(k,s.bf.members),this._tileDebugSegments=s.b7.simpleSegment(0,0,M.length,O.length)}_makeGlobeTileDebugTextBuffer(o,c,m,v,b,A){const M=s.ag/4,O=new s.b4,k=new s.aU,L=new s.be,U=25;k.reserve(32),O.reserve(U),L.reserve(U);const j=($,Q)=>U*$+Q;for(let $=0;$<U;$++){const Q=$*M;for(let Z=0;Z<U;Z++){const te=Z*M;O.emplaceBack(te,Q);const ee=this._globePoint(te,Q,c,m,v,b,A);L.emplaceBack(ee[0],ee[1],ee[2])}}for(let $=0;$<4;$++)for(let Q=0;Q<4;Q++){const Z=j($,Q),te=j($,Q+1),ee=j($+1,Q),ae=j($+1,Q+1);k.emplaceBack(Z,te,ee),k.emplaceBack(ee,te,ae)}this._tileDebugTextIndexBuffer=o.createIndexBuffer(k),this._tileDebugTextBuffer=o.createVertexBuffer(O,s.b6.members),this._globeTileDebugTextBuffer=o.createVertexBuffer(L,s.bf.members),this._tileDebugTextSegments=s.b7.simpleSegment(0,0,U,32)}destroy(o=!1){for(const c in this.buckets)this.buckets[c].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&(this.imageAtlasTexture.destroy(),delete this.imageAtlasTexture),this.glyphAtlasTexture&&(this.glyphAtlasTexture.destroy(),delete this.glyphAtlasTexture),this.lineAtlasTexture&&(this.lineAtlasTexture.destroy(),delete this.lineAtlasTexture),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),!o&&this.texture&&this.texture instanceof s.T&&(this.texture.destroy(),delete this.texture),this.hillshadeFBO&&(this.hillshadeFBO.destroy(),delete this.hillshadeFBO),this.dem&&delete this.dem,this.neighboringTiles&&delete this.neighboringTiles,this.demTexture&&(this.demTexture.destroy(),delete this.demTexture),this.rasterParticleState&&(this.rasterParticleState.destroy(),delete this.rasterParticleState),this.latestFeatureIndex=null,this.state="unloaded"}}s.bg.setPbf(s.bh);class Qo extends Jo{constructor(o,c,m,v,b){super(o,c,m,v,b),this._workQueue=[],this._fetchQueue=[],this._isHeaderLoaded=!1}setTexture(o,c){const m=c.context,v=m.gl;this.texture=this.texture||c.getTileTexture(o.width),this.texture&&this.texture instanceof s.T?this.texture.update(o,{premultiply:!1}):this.texture=new s.T(m,o,v.RGBA8,{premultiply:!1})}flushQueues(){for(;this._workQueue.length;)this._workQueue.pop()();for(;this._fetchQueue.length;)this._fetchQueue.pop()()}fetchHeader(o=16384,c){const m=this._mrt=new s.bg(30),v=Object.assign({},this.requestParams,{headers:{Range:"bytes=0-"+(o-1)}});return this.entireBuffer=null,this.request=s.bi(v,(b,A,M,O)=>{if(b)c(b);else try{const k=m.getHeaderLength(A);if(k>o)return void(this.request=this.fetchHeader(k,c));m.parseHeader(A),this._isHeaderLoaded=!0;let L=0;for(const U of Object.values(m.layers))L=Math.max(L,U.dataIndex[U.dataIndex.length-1].last_byte);A.byteLength>=L&&(this.entireBuffer=A),c(null,this.entireBuffer||A,M,O)}catch(k){c(k)}}),this.request}fetchBand(o,c,m){const v=this._mrt;if(!this._isHeaderLoaded||!v)return void m(new Error("Tile header is not ready"));const b=this.actor;if(!b)return void m(new Error("Can't fetch tile band without an actor"));let A;const M=(U,j)=>{A.complete(U,j),U?m(U):(this.updateTextureDescriptor(o,c),m(null,this.textureDescriptor&&this.textureDescriptor.img))},O=(U,j)=>{if(U)return m(U);const $=b.send("decodeRasterArray",{buffer:j,task:A},M,void 0,!0);this._workQueue.push(()=>{$&&$.cancel(),A.cancel()})},k=v.getLayer(o);if(!k)return void m(new Error(`Unknown sourceLayer "${o}"`));if(k.hasDataForBand(c))return this.updateTextureDescriptor(o,c),void m(null,this.textureDescriptor?this.textureDescriptor.img:null);const L=k.getDataRange([c]);if(A=v.createDecodingTask(L),!A||A.tasks.length)if(this.flushQueues(),this.entireBuffer)O(null,this.entireBuffer.slice(L.firstByte,L.lastByte+1));else{const U=Object.assign({},this.requestParams,{headers:{Range:`bytes=${L.firstByte}-${L.lastByte}`}}),j=s.bi(U,O);this._fetchQueue.push(()=>{j.cancel(),A.cancel()})}else m(null)}updateNeeded(o,c){return(!this.textureDescriptor||this.textureDescriptor.band!==c||this.textureDescriptor.layer!==o)&&this.state!=="errored"}updateTextureDescriptor(o,c){if(!this._mrt)return;const m=this._mrt.getLayer(o);if(!m||!m.hasBand(c)||!m.hasDataForBand(c))return;const{bytes:v,tileSize:b,buffer:A,offset:M,scale:O}=m.getBandView(c),k=b+2*A,L={data:v,width:k,height:k},U=this.texture;U&&U instanceof s.T&&U.update(L,{premultiply:!1}),this.textureDescriptor={layer:o,band:c,img:L,buffer:A,offset:M,tileSize:b,format:m.pixelFormat,mix:[O,256*O,65536*O,16777216*O]}}}class Um{constructor(o,c){this.max=o,this.onRemove=c,this.reset()}reset(){for(const o in this.data)for(const c of this.data[o])c.timeout&&clearTimeout(c.timeout),this.onRemove(c.value);return this.data={},this.order=[],this}add(o,c,m){const v=o.wrapped().key;this.data[v]===void 0&&(this.data[v]=[]);const b={value:c,timeout:void 0};if(m!==void 0&&(b.timeout=setTimeout(()=>{this.remove(o,b)},m)),this.data[v].push(b),this.order.push(v),this.order.length>this.max){const A=this._getAndRemoveByKey(this.order[0]);A&&this.onRemove(A)}return this}has(o){return o.wrapped().key in this.data}getAndRemove(o){return this.has(o)?this._getAndRemoveByKey(o.wrapped().key):null}_getAndRemoveByKey(o){const c=this.data[o].shift();return c.timeout&&clearTimeout(c.timeout),this.data[o].length===0&&delete this.data[o],this.order.splice(this.order.indexOf(o),1),c.value}getByKey(o){const c=this.data[o];return c?c[0].value:null}get(o){return this.has(o)?this.data[o.wrapped().key][0].value:null}remove(o,c){if(!this.has(o))return this;const m=o.wrapped().key,v=c===void 0?0:this.data[m].indexOf(c),b=this.data[m][v];return this.data[m].splice(v,1),b.timeout&&clearTimeout(b.timeout),this.data[m].length===0&&delete this.data[m],this.onRemove(b.value),this.order.splice(this.order.indexOf(m),1),this}setMaxSize(o){for(this.max=o;this.order.length>this.max;){const c=this._getAndRemoveByKey(this.order[0]);c&&this.onRemove(c)}return this}filter(o){const c=[];for(const m in this.data)for(const v of this.data[m])o(v.value)||c.push(v);for(const m of c)this.remove(m.value.tileID,m)}}class Ld{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(o,c,m){const v=String(c);if(this.stateChanges[o]=this.stateChanges[o]||{},this.stateChanges[o][v]=this.stateChanges[o][v]||{},s.l(this.stateChanges[o][v],m),this.deletedStates[o]===null){this.deletedStates[o]={};for(const b in this.state[o])b!==v&&(this.deletedStates[o][b]=null)}else if(this.deletedStates[o]&&this.deletedStates[o][v]===null){this.deletedStates[o][v]={};for(const b in this.state[o][v])m[b]||(this.deletedStates[o][v][b]=null)}else for(const b in m)this.deletedStates[o]&&this.deletedStates[o][v]&&this.deletedStates[o][v][b]===null&&delete this.deletedStates[o][v][b]}removeFeatureState(o,c,m){if(this.deletedStates[o]===null)return;const v=String(c);if(this.deletedStates[o]=this.deletedStates[o]||{},m&&c!==void 0)this.deletedStates[o][v]!==null&&(this.deletedStates[o][v]=this.deletedStates[o][v]||{},this.deletedStates[o][v][m]=null);else if(c!==void 0)if(this.stateChanges[o]&&this.stateChanges[o][v])for(m in this.deletedStates[o][v]={},this.stateChanges[o][v])this.deletedStates[o][v][m]=null;else this.deletedStates[o][v]=null;else this.deletedStates[o]=null}getState(o,c){const m=this.state[o]||{},v=this.stateChanges[o]||{},b=this.deletedStates[o];if(b===null)return{};if(c!==void 0){const M=String(c),O=s.l({},m[M],v[M]);if(b){const k=b[c];if(k===null)return{};for(const L in k)delete O[L]}return O}const A=s.l({},m,v);if(b)for(const M in b)delete A[M];return A}initializeTileState(o,c){o.refreshFeatureState(c)}coalesceChanges(o,c){const m={};for(const v in this.stateChanges){this.state[v]=this.state[v]||{};const b={};for(const A in this.stateChanges[v])this.state[v][A]||(this.state[v][A]={}),s.l(this.state[v][A],this.stateChanges[v][A]),b[A]=this.state[v][A];m[v]=b}for(const v in this.deletedStates){this.state[v]=this.state[v]||{};const b={};if(this.deletedStates[v]===null)for(const A in this.state[v])b[A]={},this.state[v][A]={};else for(const A in this.deletedStates[v]){if(this.deletedStates[v][A]===null)this.state[v][A]={};else if(this.state[v][A])for(const M of Object.keys(this.deletedStates[v][A]))delete this.state[v][A][M];b[A]=this.state[v][A]}m[v]=m[v]||{},s.l(m[v],b)}if(this.stateChanges={},this.deletedStates={},Object.keys(m).length!==0)for(const v in o)o[v].refreshFeatureState(c)}}class As extends s.E{constructor(o,c,m){super(),this.id=o,this._onlySymbols=m,c.on("data",v=>{v.dataType==="source"&&v.sourceDataType==="metadata"&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&v.dataType==="source"&&v.sourceDataType==="content"&&(this.reload(),this.transform&&this.update(this.transform))}),c.on("error",()=>{this._sourceErrored=!0}),this._source=c,this._tiles={},this._cache=new Um(0,this._unloadTile.bind(this)),this._timers={},this._cacheTimers={},this._minTileCacheSize=c.minTileCacheSize,this._maxTileCacheSize=c.maxTileCacheSize,this._loadedParentTiles={},this.castsShadows=!1,this.tileCoverLift=0,this._coveredTiles={},this._shadowCasterTiles={},this._state=new Ld,this._isRaster=this._source.type==="raster"||this._source.type==="raster-dem"||this._source.type==="raster-array"||this._source.type==="custom"&&this._source._dataType==="raster"}onAdd(o){this.map=o,this._minTileCacheSize=this._minTileCacheSize===void 0&&o?o._minTileCacheSize:this._minTileCacheSize,this._maxTileCacheSize=this._maxTileCacheSize===void 0&&o?o._maxTileCacheSize:this._maxTileCacheSize}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded||!this._source.loaded())return!1;for(const o in this._tiles){const c=this._tiles[o];if(c.state!=="loaded"&&c.state!=="errored")return!1}return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;const o=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,o&&this.reload(),this.transform&&this.update(this.transform)}_loadTile(o,c){return o.isSymbolTile=this._onlySymbols,o.isExtraShadowCaster=this._shadowCasterTiles[o.tileID.key],this._source.loadTile(o,c)}_unloadTile(o){if(this._source.unloadTile)return this._source.unloadTile(o)}_abortTile(o){if(this._source.abortTile)return this._source.abortTile(o)}serialize(){return this._source.serialize()}prepare(o){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(const c in this._tiles){const m=this._tiles[c];m.upload(o),m.prepare(this.map.style.imageManager,this.map?this.map.painter:null,this._source.scope)}}getIds(){return s.bj(this._tiles).map(o=>o.tileID).sort(Vi).map(o=>o.key)}getRenderableIds(o,c){const m=[];for(const v in this._tiles)this._isIdRenderable(+v,o,c)&&m.push(this._tiles[v]);return o?m.sort((v,b)=>{const A=v.tileID,M=b.tileID,O=new s.P(A.canonical.x,A.canonical.y)._rotate(this.transform.angle),k=new s.P(M.canonical.x,M.canonical.y)._rotate(this.transform.angle);return A.overscaledZ-M.overscaledZ||k.y-O.y||k.x-O.x}).map(v=>v.tileID.key):m.map(v=>v.tileID).sort(Vi).map(v=>v.key)}hasRenderableParent(o){const c=this.findLoadedParent(o,0);return!!c&&this._isIdRenderable(c.tileID.key)}_isIdRenderable(o,c,m){return this._tiles[o]&&this._tiles[o].hasData()&&!this._coveredTiles[o]&&(c||!this._tiles[o].holdingForFade())&&(m||!this._shadowCasterTiles[o])}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(const o in this._tiles)this._tiles[o].state!=="errored"&&this._reloadTile(+o,"reloading")}}_reloadTile(o,c){const m=this._tiles[o];m&&(m.state!=="loading"&&(m.state=c),this._loadTile(m,this._tileLoaded.bind(this,m,o,c)))}_tileLoaded(o,c,m,v){if(v)if(o.state="errored",v.status!==404)this._source.fire(new s.y(v,{tile:o}));else{if(this._source.fire(new s.z("data",{dataType:"source",sourceDataType:"error",sourceId:this._source.id,tile:o})),!(o.tileID.key in this._loadedParentTiles))return;if(this._source.type==="raster-dem"&&this.usedForTerrain&&this.map.painter.terrain){const b=this.map.painter.terrain;this.update(this.transform,b.getScaledDemTileSize(),!0),b.resetTileLookupCache(this.id)}else this.update(this.transform)}else o.timeAdded=s.q.now(),m==="expired"&&(o.refreshedUponExpiration=!0),this._setTileReloadTimer(c,o),this._source.type==="raster-dem"&&o.dem&&this._backfillDEM(o),this._state.initializeTileState(o,this.map?this.map.painter:null),this._source.fire(new s.z("data",{dataType:"source",tile:o,coord:o.tileID,sourceCacheId:this.id}))}_backfillDEM(o){const c=this.getRenderableIds();for(let v=0;v<c.length;v++){const b=c[v];if(o.neighboringTiles&&o.neighboringTiles[b]){const A=this.getTileByID(b);m(o,A),m(A,o)}}function m(v,b){if(!v.dem||v.dem.borderReady)return;v.needsHillshadePrepare=!0,v.needsDEMTextureUpload=!0;let A=b.tileID.canonical.x-v.tileID.canonical.x;const M=b.tileID.canonical.y-v.tileID.canonical.y,O=Math.pow(2,v.tileID.canonical.z),k=b.tileID.key;A===0&&M===0||Math.abs(M)>1||(Math.abs(A)>1&&(Math.abs(A+O)===1?A+=O:Math.abs(A-O)===1&&(A-=O)),b.dem&&v.dem&&(v.dem.backfillBorder(b.dem,A,M),v.neighboringTiles&&v.neighboringTiles[k]&&(v.neighboringTiles[k].backfilled=!0)))}}getTile(o){return this.getTileByID(o.key)}getTileByID(o){return this._tiles[o]}_retainLoadedChildren(o,c,m,v){for(const b in this._tiles){let A=this._tiles[b];if(v[b]||!A.hasData()||A.tileID.overscaledZ<=c||A.tileID.overscaledZ>m)continue;let M=A.tileID;for(;A&&A.tileID.overscaledZ>c+1;){const k=A.tileID.scaledTo(A.tileID.overscaledZ-1);A=this._tiles[k.key],A&&A.hasData()&&(M=k)}let O=M;for(;O.overscaledZ>c;)if(O=O.scaledTo(O.overscaledZ-1),o[O.key]){v[M.key]=M;break}}}findLoadedParent(o,c){if(o.key in this._loadedParentTiles){const m=this._loadedParentTiles[o.key];return m&&m.tileID.overscaledZ>=c?m:null}for(let m=o.overscaledZ-1;m>=c;m--){const v=o.scaledTo(m),b=this._getLoadedTile(v);if(b)return b}}_getLoadedTile(o){const c=this._tiles[o.key];return c&&c.hasData()?c:this._cache.getByKey(this._source.reparseOverscaled?o.wrapped().key:o.canonical.key)}updateCacheSize(o,c){c=c||this._source.tileSize;const m=Math.ceil(o.width/c)+1,v=Math.ceil(o.height/c)+1,b=Math.floor(m*v*5),A=typeof this._minTileCacheSize=="number"?Math.max(this._minTileCacheSize,b):b,M=typeof this._maxTileCacheSize=="number"?Math.min(this._maxTileCacheSize,A):A;this._cache.setMaxSize(M)}handleWrapJump(o){const c=Math.round((o-(this._prevLng===void 0?o:this._prevLng))/360);if(this._prevLng=o,c){const m={};for(const v in this._tiles){const b=this._tiles[v];b.tileID=b.tileID.unwrapTo(b.tileID.wrap+c),m[b.tileID.key]=b}this._tiles=m;for(const v in this._timers)clearTimeout(this._timers[v]),delete this._timers[v];for(const v in this._tiles)this._setTileReloadTimer(+v,this._tiles[v])}}update(o,c,m,v){if(this.transform=o,!this._sourceLoaded||this._paused||this.transform.freezeTileCoverage||this.usedForTerrain&&!m)return;this.updateCacheSize(o,c),this.transform.projection.name!=="globe"&&this.handleWrapJump(this.transform.center.lng),this._shadowCasterTiles={},this._coveredTiles={};const b=this._source.type==="batched-model";let A,M=this._source.maxzoom;const O=this.map&&this.map.painter?this.map.painter._terrain:null;if(O&&O.sourceCache===this&&O.attenuationRange()){const U=O.attenuationRange()[0],j=Math.floor(U)-Math.log2(O.getDemUpscale());M>j&&(M=j)}if(this.used||this.usedForTerrain){if(this._source.tileID)A=o.getVisibleUnwrappedCoordinates(this._source.tileID).map(U=>new s.aG(U.canonical.z,U.wrap,U.canonical.z,U.canonical.x,U.canonical.y));else if(this.tileCoverLift!==0){const U=o.clone();U.tileCoverLift=this.tileCoverLift,A=U.coveringTiles({tileSize:c||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:M,roundZoom:this._source.roundZoom&&!m,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:b}),this._source.minzoom<=1&&o.projection.name==="globe"&&(A.push(new s.aG(1,0,1,0,0)),A.push(new s.aG(1,0,1,1,0)),A.push(new s.aG(1,0,1,0,1)),A.push(new s.aG(1,0,1,1,1)))}else if(A=o.coveringTiles({tileSize:c||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:M,roundZoom:this._source.roundZoom&&!m,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:b}),this._source.hasTile){const U=this._source.hasTile.bind(this._source);A=A.filter(j=>U(j))}}else A=[];if(A.length>0&&this.castsShadows&&v&&this.transform.projection.name!=="globe"&&!this.usedForTerrain&&!Nd(this._source.type)){const U=o.coveringZoomLevel({tileSize:c||this._source.tileSize,roundZoom:this._source.roundZoom&&!m}),j=Math.min(U,this._source.maxzoom);if(b){const $=o.extendTileCover(A,j);for(const Q of $)A.push(Q)}else{const $=o.extendTileCover(A,j,v);for(const Q of $)this._shadowCasterTiles[Q.key]=!0,A.push(Q)}}const k=this._updateRetainedTiles(A);if(Nd(this._source.type)&&A.length!==0){const U={},j={},$=Object.keys(k);for(const Z of $){const te=k[Z],ee=this._tiles[Z];if(!ee||ee.fadeEndTime&&ee.fadeEndTime<=s.q.now())continue;const ae=this.findLoadedParent(te,Math.max(te.overscaledZ-As.maxOverzooming,this._source.minzoom));ae&&(this._addTile(ae.tileID),U[ae.tileID.key]=ae.tileID),j[Z]=te}const Q=A[A.length-1].overscaledZ;for(const Z in this._tiles){const te=this._tiles[Z];if(k[Z]||!te.hasData())continue;let ee=te.tileID;for(;ee.overscaledZ>Q;){ee=ee.scaledTo(ee.overscaledZ-1);const ae=this._tiles[ee.key];if(ae&&ae.hasData()&&j[ee.key]){k[Z]=te.tileID;break}}}for(const Z in U)k[Z]||(this._coveredTiles[Z]=!0,k[Z]=U[Z])}for(const U in k)this._tiles[U].clearFadeHold();const L=s.bk(this._tiles,k);for(const U of L){const j=this._tiles[U];j.hasSymbolBuckets&&!j.holdingForFade()?j.setHoldDuration(this.map._fadeDuration):j.hasSymbolBuckets&&!j.symbolFadeFinished()||this._removeTile(+U)}this._updateLoadedParentTileCache(),this._onlySymbols&&this._source.afterUpdate&&this._source.afterUpdate()}releaseSymbolFadeTiles(){for(const o in this._tiles)this._tiles[o].holdingForFade()&&this._removeTile(+o)}_updateRetainedTiles(o){const c={};if(o.length===0)return c;const m={},v=o.reduce((k,L)=>Math.min(k,L.overscaledZ),1/0),b=o[0].overscaledZ,A=Math.max(b-As.maxOverzooming,this._source.minzoom),M=Math.max(b+As.maxUnderzooming,this._source.minzoom),O={};for(const k of o){const L=this._addTile(k);c[k.key]=k,L.hasData()||v<this._source.maxzoom&&(O[k.key]=k)}this._retainLoadedChildren(O,v,M,c);for(const k of o){let L=this._tiles[k.key];if(L.hasData())continue;if(k.canonical.z>=this._source.maxzoom){const j=k.children(this._source.maxzoom)[0],$=this.getTile(j);if($&&$.hasData()){c[j.key]=j;continue}}else{const j=k.children(this._source.maxzoom);if(c[j[0].key]&&c[j[1].key]&&c[j[2].key]&&c[j[3].key])continue}let U=L.wasRequested();for(let j=k.overscaledZ-1;j>=A;--j){const $=k.scaledTo(j);if(m[$.key]||(m[$.key]=!0,L=this.getTile($),!L&&U&&(L=this._addTile($)),L&&(c[$.key]=$,U=L.wasRequested(),L.hasData())))break}}return c}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(const o in this._tiles){const c=[];let m,v=this._tiles[o].tileID;for(;v.overscaledZ>0;){if(v.key in this._loadedParentTiles){m=this._loadedParentTiles[v.key];break}c.push(v.key);const b=v.scaledTo(v.overscaledZ-1);if(m=this._getLoadedTile(b),m)break;v=b}for(const b of c)this._loadedParentTiles[b]=m}}_addTile(o){let c=this._tiles[o.key];if(c)return c.isExtraShadowCaster!==!0||this._shadowCasterTiles[o.key]||this._reloadTile(o.key,"reloading"),c;c=this._cache.getAndRemove(o),c&&(this._setTileReloadTimer(o.key,c),c.tileID=o,this._state.initializeTileState(c,this.map?this.map.painter:null),this._cacheTimers[o.key]&&(clearTimeout(this._cacheTimers[o.key]),delete this._cacheTimers[o.key],this._setTileReloadTimer(o.key,c)));const m=!!c;if(!m){const v=this.map?this.map.painter:null,b=this._source.tileSize*o.overscaleFactor();c=this._source.type==="raster-array"?new Qo(o,b,this.transform.tileZoom,v,this._isRaster):new Jo(o,b,this.transform.tileZoom,v,this._isRaster),this._loadTile(c,this._tileLoaded.bind(this,c,o.key,c.state))}return c?(c.uses++,this._tiles[o.key]=c,m||this._source.fire(new s.z("dataloading",{tile:c,coord:c.tileID,dataType:"source"})),c):null}_setTileReloadTimer(o,c){o in this._timers&&(clearTimeout(this._timers[o]),delete this._timers[o]);const m=c.getExpiryTimeout();m&&(this._timers[o]=setTimeout(()=>{this._reloadTile(o,"expired"),delete this._timers[o]},m))}_removeTile(o){const c=this._tiles[o];c&&(c.uses--,delete this._tiles[o],this._timers[o]&&(clearTimeout(this._timers[o]),delete this._timers[o]),c.uses>0||(c.hasData()&&c.state!=="reloading"||c.state==="empty"?this._cache.add(c.tileID,c,c.getExpiryTimeout()):(c.aborted=!0,this._abortTile(c),this._unloadTile(c))))}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const o in this._tiles)this._removeTile(+o);this._source._clear&&this._source._clear(),this._cache.reset(),this.map&&this.usedForTerrain&&this.map.painter.terrain&&this.map.painter.terrain.resetTileLookupCache(this.id)}tilesIn(o,c,m){const v=[],b=this.transform;if(!b)return v;const A=b.projection.name==="globe",M=s.at(b.center.lng);for(const O in this._tiles){const k=this._tiles[O];if(m&&k.clearQueryDebugViz(),k.holdingForFade())continue;let L;if(A){const U=k.tileID.canonical;if(U.z===0){const j=[Math.abs(s.aw(M,...ii(U,-1))-M),Math.abs(s.aw(M,...ii(U,1))-M)];L=[0,2*j.indexOf(Math.min(...j))-1]}else{const j=[Math.abs(s.aw(M,...ii(U,-1))-M),Math.abs(s.aw(M,...ii(U,0))-M),Math.abs(s.aw(M,...ii(U,1))-M)];L=[j.indexOf(Math.min(...j))-1]}}else L=[0];for(const U of L){const j=o.containsTile(k,b,c,U);j&&v.push(j)}}return v}getShadowCasterCoordinates(){return this._getRenderableCoordinates(!1,!0)}getVisibleCoordinates(o){return this._getRenderableCoordinates(o)}_getRenderableCoordinates(o,c){const m=this.getRenderableIds(o,c).map(b=>this._tiles[b].tileID),v=this.transform.projection.name==="globe";for(const b of m)b.projMatrix=this.transform.calculateProjMatrix(b.toUnwrapped()),b.expandedProjMatrix=v?this.transform.calculateProjMatrix(b.toUnwrapped(),!1,!0):b.projMatrix;return m}sortCoordinatesByDistance(o){const c=o.slice(),m=this.transform._camera.position,v=this.transform._camera.forward(),b={};for(const A of c){const M=1/(1<<A.canonical.z);b[A.key]=((A.canonical.x+.5)*M+A.wrap-m[0])*v[0]+((A.canonical.y+.5)*M-m[1])*v[1]-m[2]*v[2]}return c.sort((A,M)=>b[A.key]-b[M.key]),c}hasTransition(){if(this._source.hasTransition())return!0;if(Nd(this._source.type))for(const o in this._tiles){const c=this._tiles[o];if(c.fadeEndTime!==void 0&&c.fadeEndTime>=s.q.now())return!0}return!1}setFeatureState(o,c,m){this._state.updateState(o=o||"_geojsonTileLayer",c,m)}removeFeatureState(o,c,m){this._state.removeFeatureState(o=o||"_geojsonTileLayer",c,m)}getFeatureState(o,c){return this._state.getState(o=o||"_geojsonTileLayer",c)}setDependencies(o,c,m){const v=this._tiles[o];v&&v.setDependencies(c,m)}reloadTilesForDependencies(o,c){for(const m in this._tiles)this._tiles[m].hasDependency(o,c)&&this._reloadTile(+m,"reloading");this._cache.filter(m=>!m.hasDependency(o,c))}_preloadTiles(o,c){if(!this._sourceLoaded){const O=()=>{this._sourceLoaded&&(this._source.off("data",O),this._preloadTiles(o,c))};return void this._source.on("data",O)}const m=new Map,v=Array.isArray(o)?o:[o],b=this.map.painter.terrain,A=this.usedForTerrain&&b?b.getScaledDemTileSize():this._source.tileSize;for(const O of v){const k=O.coveringTiles({tileSize:A,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!this.usedForTerrain,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain});for(const L of k)m.set(L.key,L);this.usedForTerrain&&O.updateElevation(!1)}const M=Array.from(m.values());s.bl(M,(O,k)=>{const L=new Jo(O,this._source.tileSize*O.overscaleFactor(),this.transform.tileZoom,this.map.painter,this._isRaster);this._loadTile(L,U=>{this._source.type==="raster-dem"&&L.dem&&this._backfillDEM(L),k(U,L)})},c)}}function Vi(p,o){const c=Math.abs(2*p.wrap)-+(p.wrap<0),m=Math.abs(2*o.wrap)-+(o.wrap<0);return p.overscaledZ-o.overscaledZ||m-c||o.canonical.y-p.canonical.y||o.canonical.x-p.canonical.x}function Nd(p){return p==="raster"||p==="image"||p==="video"||p==="custom"}function ii(p,o){const c=1<<p.z;return[p.x/c+o,(p.x+1)/c+o]}As.maxOverzooming=10,As.maxUnderzooming=3;class Vm{constructor(o){this.style=o,this.layersGotHidden=!1,this.layers=[]}processLayersChanged(){this.layers=[];const o=!1,c=!1;for(const m in this.style._mergedLayers){const v=this.style._mergedLayers[m];if(v.type==="fill-extrusion")this.layers.push({layer:v,visible:o,visibilityChanged:c});else if(v.type==="model"){const b=this.style.getLayerSource(v);b&&b.type==="batched-model"&&this.layers.push({layer:v,visible:o,visibilityChanged:c})}}}onNewFrame(o){this.layersGotHidden=!1;for(const c of this.layers){const m=c.layer;let v=!1;m.type==="fill-extrusion"?v=!m.isHidden(o)&&m.paint.get("fill-extrusion-opacity")>0:m.type==="model"&&(v=!m.isHidden(o)&&m.paint.get("model-opacity").constantOr(1)>0),this.layersGotHidden=this.layersGotHidden||!v&&c.visible,c.visible=v}}updateZOffset(o,c){this.currentBuildingBuckets=[];for(const v of this.layers){const b=v.layer,A=this.style.getLayerSourceCache(b);let M=1;b.type==="fill-extrusion"&&(M=v.visible?b.paint.get("fill-extrusion-vertical-scale"):0);let O=A?A.getTile(c):null;if(!O&&A&&c.canonical.z>A.getSource().minzoom){let k=c.scaledTo(Math.min(A.getSource().maxzoom,c.overscaledZ-1));for(;k.overscaledZ>=A.getSource().minzoom&&(O=A.getTile(k),!O&&k.overscaledZ!==0);)k=k.scaledTo(k.overscaledZ-1)}this.currentBuildingBuckets.push({bucket:O?O.getBucket(b):null,tileID:O?O.tileID:c,verticalScale:M})}o.hasAnyZOffset=!1;let m=!1;for(let v=0;v<o.symbolInstances.length;v++){const b=o.symbolInstances.get(v),A=b.zOffset,M=this._getHeightAtTileOffset(c,b.tileAnchorX,b.tileAnchorY);b.zOffset=M!==Number.NEGATIVE_INFINITY?M:A,m||A===b.zOffset||(m=!0),o.hasAnyZOffset||b.zOffset===0||(o.hasAnyZOffset=!0)}m&&(o.zOffsetBuffersNeedUpload=!0,o.zOffsetSortDirty=!0)}_mapCoordToOverlappingTile(o,c,m,v){let b=c,A=m;if(o.canonical.z!==v.canonical.z){const M=v.canonical,O=1/(1<<o.canonical.z-M.z);b=(c+o.canonical.x*s.ag)*O-M.x*s.ag|0,A=(m+o.canonical.y*s.ag)*O-M.y*s.ag|0}return{tileX:b,tileY:A}}_getHeightAtTileOffset(o,c,m){let v,b;for(let A=0;A<this.layers.length;++A){if(this.layers[A].layer.type!=="fill-extrusion")continue;const{bucket:M,tileID:O,verticalScale:k}=this.currentBuildingBuckets[A];if(!M)continue;const{tileX:L,tileY:U}=this._mapCoordToOverlappingTile(o,c,m,O),j=M.getHeightAtTileCoord(L,U);j&&j.height!==void 0&&(j.hidden?v=j.height:b=Math.max(j.height*k,b||0))}if(b!==void 0)return b;for(let A=0;A<this.layers.length;++A){const M=this.layers[A];if(M.layer.type!=="model"||!M.visible)continue;const{bucket:O,tileID:k}=this.currentBuildingBuckets[A];if(!O)continue;const{tileX:L,tileY:U}=this._mapCoordToOverlappingTile(o,c,m,k),j=O.getHeightAtTileCoord(L,U);if(j&&!j.hidden)return j.height===void 0&&v!==void 0?Math.min(j.maxHeight,v)*j.verticalScale:j.height?j.height*j.verticalScale:Number.NEGATIVE_INFINITY}return this.layersGotHidden?0:Number.NEGATIVE_INFINITY}}function Hu(p,o){const c={};for(const m in p)m!=="ref"&&(c[m]=p[m]);return s.bm.forEach(m=>{m in o&&(c[m]=o[m])}),c}function Gu(p){p=p.slice();const o=Object.create(null);for(let c=0;c<p.length;c++)o[p[c].id]=p[c];for(let c=0;c<p.length;c++)"ref"in p[c]&&(p[c]=Hu(p[c],o[p[c].ref]));return p}const bi={setStyle:"setStyle",addLayer:"addLayer",removeLayer:"removeLayer",setPaintProperty:"setPaintProperty",setLayoutProperty:"setLayoutProperty",setSlot:"setSlot",setFilter:"setFilter",addSource:"addSource",removeSource:"removeSource",setGeoJSONSourceData:"setGeoJSONSourceData",setLayerZoomRange:"setLayerZoomRange",setLayerProperty:"setLayerProperty",setCenter:"setCenter",setZoom:"setZoom",setBearing:"setBearing",setPitch:"setPitch",setSprite:"setSprite",setGlyphs:"setGlyphs",setTransition:"setTransition",setLight:"setLight",setTerrain:"setTerrain",setFog:"setFog",setSnow:"setSnow",setRain:"setRain",setCamera:"setCamera",setLights:"setLights",setProjection:"setProjection",addImport:"addImport",removeImport:"removeImport",updateImport:"updateImport"};function $u(p,o,c){c.push({command:bi.addSource,args:[p,o[p]]})}function Ea(p,o,c){o.push({command:bi.removeSource,args:[p]}),c[p]=!0}function jt(p,o,c,m){Ea(p,c,m),$u(p,o,c)}function $i(p,o,c){let m;for(m in p[c])if(p[c].hasOwnProperty(m)&&m!=="data"&&!s.bn(p[c][m],o[c][m]))return!1;for(m in o[c])if(o[c].hasOwnProperty(m)&&m!=="data"&&!s.bn(p[c][m],o[c][m]))return!1;return!0}function Oi(p,o,c,m,v,b){let A;for(A in o=o||{},p=p||{})p.hasOwnProperty(A)&&(s.bn(p[A],o[A])||c.push({command:b,args:[m,A,o[A],v]}));for(A in o)o.hasOwnProperty(A)&&!p.hasOwnProperty(A)&&(s.bn(p[A],o[A])||c.push({command:b,args:[m,A,o[A],v]}))}function yn(p){return p.id}function Io(p,o){return p[o.id]=o,p}class Ni{constructor(o,c){this.reset(o,c)}reset(o,c){this.points=o||[],this._distances=[0];for(let m=1;m<this.points.length;m++)this._distances[m]=this._distances[m-1]+this.points[m].dist(this.points[m-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(c||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(o){if(this.points.length===1)return this.points[0];o=s.aw(o,0,1);let c=1,m=this._distances[c];const v=o*this.paddedLength+this.padding;for(;m<v&&c<this._distances.length;)m=this._distances[++c];const b=c-1,A=this._distances[b],M=m-A,O=M>0?(v-A)/M:0;return this.points[b].mult(1-O).add(this.points[c].mult(O))}}class fc{constructor(o,c,m){const v=this.boxCells=[],b=this.circleCells=[];this.xCellCount=Math.ceil(o/m),this.yCellCount=Math.ceil(c/m);for(let A=0;A<this.xCellCount*this.yCellCount;A++)v.push([]),b.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=o,this.height=c,this.xScale=this.xCellCount/o,this.yScale=this.yCellCount/c,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(o,c,m,v,b){this._forEachCell(c,m,v,b,this._insertBoxCell,this.boxUid++),this.boxKeys.push(o),this.bboxes.push(c),this.bboxes.push(m),this.bboxes.push(v),this.bboxes.push(b)}insertCircle(o,c,m,v){this._forEachCell(c-v,m-v,c+v,m+v,this._insertCircleCell,this.circleUid++),this.circleKeys.push(o),this.circles.push(c),this.circles.push(m),this.circles.push(v)}_insertBoxCell(o,c,m,v,b,A){this.boxCells[b].push(A)}_insertCircleCell(o,c,m,v,b,A){this.circleCells[b].push(A)}_query(o,c,m,v,b,A){if(m<0||o>this.width||v<0||c>this.height)return!b&&[];const M=[];if(o<=0&&c<=0&&this.width<=m&&this.height<=v){if(b)return!0;for(let O=0;O<this.boxKeys.length;O++)M.push({key:this.boxKeys[O],x1:this.bboxes[4*O],y1:this.bboxes[4*O+1],x2:this.bboxes[4*O+2],y2:this.bboxes[4*O+3]});for(let O=0;O<this.circleKeys.length;O++){const k=this.circles[3*O],L=this.circles[3*O+1],U=this.circles[3*O+2];M.push({key:this.circleKeys[O],x1:k-U,y1:L-U,x2:k+U,y2:L+U})}return A?M.filter(A):M}return this._forEachCell(o,c,m,v,this._queryCell,M,{hitTest:b,seenUids:{box:{},circle:{}}},A),b?M.length>0:M}_queryCircle(o,c,m,v,b){const A=o-m,M=o+m,O=c-m,k=c+m;if(M<0||A>this.width||k<0||O>this.height)return!v&&[];const L=[];return this._forEachCell(A,O,M,k,this._queryCellCircle,L,{hitTest:v,circle:{x:o,y:c,radius:m},seenUids:{box:{},circle:{}}},b),v?L.length>0:L}query(o,c,m,v,b){return this._query(o,c,m,v,!1,b)}hitTest(o,c,m,v,b){return this._query(o,c,m,v,!0,b)}hitTestCircle(o,c,m,v){return this._queryCircle(o,c,m,!0,v)}_queryCell(o,c,m,v,b,A,M,O){const k=M.seenUids,L=this.boxCells[b];if(L!==null){const j=this.bboxes;for(const $ of L)if(!k.box[$]){k.box[$]=!0;const Q=4*$;if(o<=j[Q+2]&&c<=j[Q+3]&&m>=j[Q+0]&&v>=j[Q+1]&&(!O||O(this.boxKeys[$]))){if(M.hitTest)return A.push(!0),!0;A.push({key:this.boxKeys[$],x1:j[Q],y1:j[Q+1],x2:j[Q+2],y2:j[Q+3]})}}}const U=this.circleCells[b];if(U!==null){const j=this.circles;for(const $ of U)if(!k.circle[$]){k.circle[$]=!0;const Q=3*$;if(this._circleAndRectCollide(j[Q],j[Q+1],j[Q+2],o,c,m,v)&&(!O||O(this.circleKeys[$]))){if(M.hitTest)return A.push(!0),!0;{const Z=j[Q],te=j[Q+1],ee=j[Q+2];A.push({key:this.circleKeys[$],x1:Z-ee,y1:te-ee,x2:Z+ee,y2:te+ee})}}}}}_queryCellCircle(o,c,m,v,b,A,M,O){const k=M.circle,L=M.seenUids,U=this.boxCells[b];if(U!==null){const $=this.bboxes;for(const Q of U)if(!L.box[Q]){L.box[Q]=!0;const Z=4*Q;if(this._circleAndRectCollide(k.x,k.y,k.radius,$[Z+0],$[Z+1],$[Z+2],$[Z+3])&&(!O||O(this.boxKeys[Q])))return A.push(!0),!0}}const j=this.circleCells[b];if(j!==null){const $=this.circles;for(const Q of j)if(!L.circle[Q]){L.circle[Q]=!0;const Z=3*Q;if(this._circlesCollide($[Z],$[Z+1],$[Z+2],k.x,k.y,k.radius)&&(!O||O(this.circleKeys[Q])))return A.push(!0),!0}}}_forEachCell(o,c,m,v,b,A,M,O){const k=this._convertToXCellCoord(o),L=this._convertToYCellCoord(c),U=this._convertToXCellCoord(m),j=this._convertToYCellCoord(v);for(let $=k;$<=U;$++)for(let Q=L;Q<=j;Q++)if(b.call(this,o,c,m,v,this.xCellCount*Q+$,A,M,O))return}_convertToXCellCoord(o){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(o*this.xScale)))}_convertToYCellCoord(o){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(o*this.yScale)))}_circlesCollide(o,c,m,v,b,A){const M=v-o,O=b-c,k=m+A;return k*k>M*M+O*O}_circleAndRectCollide(o,c,m,v,b,A,M){const O=(A-v)/2,k=Math.abs(o-(v+O));if(k>O+m)return!1;const L=(M-b)/2,U=Math.abs(c-(b+L));if(U>L+m)return!1;if(k<=O||U<=L)return!0;const j=k-O,$=U-L;return j*j+$*$<=m*m}}const Js={unknown:0,flipRequired:1,flipNotRequired:2},pc=Math.tan(85*Math.PI/180);function rn(p,o,c,m,v,b,A){const M=s.ab.mat4.create();if(c)if(b.name==="globe"){const O=s.bo(v,o);s.ab.mat4.multiply(M,M,O)}else{const O=s.ab.mat2.invert([],A);M[0]=O[0],M[1]=O[1],M[4]=O[2],M[5]=O[3],m||s.ab.mat4.rotateZ(M,M,v.angle)}else s.ab.mat4.multiply(M,v.labelPlaneMatrix,p);return M}function wr(p,o,c,m,v,b,A){const M=rn(p,o,c,m,v,b,A);return b.name==="globe"&&c||(M[2]=M[6]=M[10]=M[14]=0),M}function zd(p,o,c,m,v,b,A){if(c){if(b.name==="globe"){const M=rn(p,o,c,m,v,b,A);return s.ab.mat4.invert(M,M),s.ab.mat4.multiply(M,p,M),M}{const M=s.ab.mat4.clone(p),O=s.ab.mat4.identity([]);return O[0]=A[0],O[1]=A[1],O[4]=A[2],O[5]=A[3],s.ab.mat4.multiply(M,M,O),m||s.ab.mat4.rotateZ(M,M,-v.angle),M}}return v.glCoordMatrix}function zn(p,o,c,m){const v=[p,o,c,1];c?s.ab.vec4.transformMat4(v,v,m):Ts(v,v,m);const b=v[3];return v[0]/=b,v[1]/=b,v[2]/=b,v}function Wu(p,o){return Math.min(.5+p/o*.5,1.5)}function mc(p,o){const c=p[0]/p[3],m=p[1]/p[3];return c>=-o[0]&&c<=o[0]&&m>=-o[1]&&m<=o[1]}function qu(p,o,c,m,v,b,A,M,O,k){const L=c.transform,U=m?p.textSizeData:p.iconSizeData,j=s.bp(U,c.transform.zoom),$=L.projection.name==="globe",Q=[256/c.width*2+1,256/c.height*2+1],Z=m?p.text.dynamicLayoutVertexArray:p.icon.dynamicLayoutVertexArray;Z.clear();let te=null;$&&(te=m?p.text.globeExtVertexArray:p.icon.globeExtVertexArray);const ee=p.lineVertexArray,ae=m?p.text.placedSymbolArray:p.icon.placedSymbolArray,me=c.transform.width/c.transform.height;let fe,Ae=!1;for(let ve=0;ve<ae.length;ve++){const be=ae.get(ve),{numGlyphs:ye,writingMode:Ie}=be;if(Ie!==s.bq.vertical||Ae||fe===s.bq.horizontal||(Ae=!0),fe=Ie,(be.hidden||Ie===s.bq.vertical)&&!Ae){yr(ye,Z);continue}Ae=!1;const Fe=new s.P(be.tileAnchorX,be.tileAnchorY);let{x:Qe,y:We,z:at}=L.projection.projectTilePoint(Fe.x,Fe.y,k.canonical);if(O){const[ct,xt,Tt]=O(Fe);Qe+=ct,We+=xt,at+=Tt}const nt=[Qe,We,at,1];if(s.ab.vec4.transformMat4(nt,nt,o),!mc(nt,Q)){yr(ye,Z);continue}const je=nt[3],et=Wu(c.transform.getCameraToCenterDistance(L.projection),je),gt=s.br(U,j,be),Ve=A?gt/et:gt*et,ut=zn(Qe,We,at,v);if(ut[3]<=0){yr(ye,Z);continue}let tt={};const Et=A?null:O,ft=Qs(be,Ve,!1,M,o,v,b,p.glyphOffsetArray,ee,Z,te,ut,Fe,tt,me,Et,L.projection,k,A);Ae=ft.useVertical,Et&&ft.needsFlipping&&(tt={}),(ft.notEnoughRoom||Ae||ft.needsFlipping&&Qs(be,Ve,!0,M,o,v,b,p.glyphOffsetArray,ee,Z,te,ut,Fe,tt,me,Et,L.projection,k,A).notEnoughRoom)&&yr(ye,Z)}m?(p.text.dynamicLayoutVertexBuffer.updateData(Z),te&&p.text.globeExtVertexBuffer&&p.text.globeExtVertexBuffer.updateData(te)):(p.icon.dynamicLayoutVertexBuffer.updateData(Z),te&&p.icon.globeExtVertexBuffer&&p.icon.globeExtVertexBuffer.updateData(te))}function _c(p,o,c,m,v,b,A,M,O,k,L,U,j,$,Q,Z){const{lineStartIndex:te,glyphStartIndex:ee,segment:ae}=M,me=ee+M.numGlyphs,fe=te+M.lineLength,Ae=o.getoffsetX(ee),ve=o.getoffsetX(me-1),be=Co(p*Ae,c,m,v,b,A,ae,te,fe,O,k,L,U,j,!0,$,Q,Z);if(!be)return null;const ye=Co(p*ve,c,m,v,b,A,ae,te,fe,O,k,L,U,j,!0,$,Q,Z);return ye?{first:be,last:ye}:null}function vn(p,o,c,m){return p===s.bq.horizontal&&Math.abs(m)>Math.abs(c)?{useVertical:!0}:p===s.bq.vertical?m>0?{needsFlipping:!0}:null:o!==Js.unknown&&function(v,b){return v===0||Math.abs(b/v)>pc}(c,m)?o===Js.flipRequired?{needsFlipping:!0}:null:c<0?{needsFlipping:!0}:null}function Qs(p,o,c,m,v,b,A,M,O,k,L,U,j,$,Q,Z,te,ee,ae){const me=o/24,fe=p.lineOffsetX*me,Ae=p.lineOffsetY*me,{lineStartIndex:ve,glyphStartIndex:be,numGlyphs:ye,segment:Ie,writingMode:Fe,flipState:Qe}=p,We=ve+p.lineLength,at=nt=>{if(L){const[Ve,ut,tt]=nt.up,Et=k.length;s.bs(L,Et+0,Ve,ut,tt),s.bs(L,Et+1,Ve,ut,tt),s.bs(L,Et+2,Ve,ut,tt),s.bs(L,Et+3,Ve,ut,tt)}const[je,et,gt]=nt.point;s.bt(k,je,et,gt,nt.angle)};if(ye>1){const nt=_c(me,M,fe,Ae,c,U,j,p,O,b,$,Z,!1,te,ee,ae);if(!nt)return{notEnoughRoom:!0};if(m&&!c){let[je,et,gt]=nt.first.point,[Ve,ut,tt]=nt.last.point;[je,et]=zn(je,et,gt,A),[Ve,ut]=zn(Ve,ut,tt,A);const Et=vn(Fe,Qe,(Ve-je)*Q,ut-et);if(p.flipState=Et&&Et.needsFlipping?Js.flipRequired:Js.flipNotRequired,Et)return Et}at(nt.first);for(let je=be+1;je<be+ye-1;je++){const et=Co(me*M.getoffsetX(je),fe,Ae,c,U,j,Ie,ve,We,O,b,$,Z,!1,!1,te,ee,ae);if(!et)return k.length-=4*(je-be),{notEnoughRoom:!0};at(et)}at(nt.last)}else{if(m&&!c){const je=zn(j.x,j.y,0,v),et=ve+Ie+1,gt=new s.P(O.getx(et),O.gety(et)),Ve=zn(gt.x,gt.y,0,v),ut=Ve[3]>0?Ve:Ud(j,gt,je,1,v,void 0,te,ee.canonical),tt=vn(Fe,Qe,(ut[0]-je[0])*Q,ut[1]-je[1]);if(p.flipState=tt&&tt.needsFlipping?Js.flipRequired:Js.flipNotRequired,tt)return tt}const nt=Co(me*M.getoffsetX(be),fe,Ae,c,U,j,Ie,ve,We,O,b,$,Z,!1,!1,te,ee,ae);if(!nt)return{notEnoughRoom:!0};at(nt)}return{}}function cn(p,o,c,m,v){const{x:b,y:A,z:M}=m.projectTilePoint(p.x,p.y,o);if(!v)return zn(b,A,M,c);const[O,k,L]=v(p);return zn(b+O,A+k,M+L,c)}function Ud(p,o,c,m,v,b,A,M){const O=cn(p.sub(o)._unit()._add(p),M,v,A,b);return s.ab.vec3.sub(O,c,O),s.ab.vec3.normalize(O,O),s.ab.vec3.scaleAndAdd(O,c,O,m)}function Co(p,o,c,m,v,b,A,M,O,k,L,U,j,$,Q,Z,te,ee){const ae=m?p-o:p+o;let me=ae>0?1:-1,fe=0;m&&(me*=-1,fe=Math.PI),me<0&&(fe+=Math.PI);let Ae=M+A+(me>0?0:1)|0,ve=v,be=v,ye=0,Ie=0;const Fe=Math.abs(ae),Qe=[],We=[];let at=b,nt=at;const je=()=>Ud(nt,at,be,Fe-ye+1,L,j,Z,te.canonical);for(;ye+Ie<=Fe;){if(Ae+=me,Ae<M||Ae>=O)return null;if(be=ve,nt=at,Qe.push(be),$&&We.push(nt),at=new s.P(k.getx(Ae),k.gety(Ae)),ve=U[Ae],!ve){const xt=cn(at,te.canonical,L,Z,j);ve=xt[3]>0?U[Ae]=xt:je()}ye+=Ie,Ie=s.ab.vec3.distance(be,ve)}Q&&j&&(U[Ae]&&(ve=je(),Ie=s.ab.vec3.distance(be,ve)),U[Ae]=ve);const et=(Fe-ye)/Ie,gt=at.sub(nt)._mult(et)._add(nt),Ve=s.ab.vec3.sub([],ve,be),ut=s.ab.vec3.scaleAndAdd([],be,Ve,et);let tt=[0,0,1],Et=Ve[0],ft=Ve[1];if(ee&&(tt=Z.upVector(te.canonical,gt.x,gt.y),tt[0]!==0||tt[1]!==0||tt[2]!==1)){const xt=[tt[2],0,-tt[0]],Tt=s.ab.vec3.cross([],tt,xt);s.ab.vec3.normalize(xt,xt),s.ab.vec3.normalize(Tt,Tt),Et=s.ab.vec3.dot(Ve,xt),ft=s.ab.vec3.dot(Ve,Tt)}if(c){const xt=s.ab.vec3.cross([],tt,Ve);s.ab.vec3.normalize(xt,xt),s.ab.vec3.scaleAndAdd(ut,ut,xt,c*me)}const ct=fe+Math.atan2(ft,Et);return Qe.push(ut),$&&We.push(gt),{point:ut,angle:ct,path:Qe,tilePath:We,up:tt}}function yr(p,o){const c=o.length,m=c+4*p;o.resize(m),o.float32.fill(-1/0,4*c,4*m)}function Ts(p,o,c){const m=o[0],v=o[1];return p[0]=c[0]*m+c[4]*v+c[12],p[1]=c[1]*m+c[5]*v+c[13],p[3]=c[3]*m+c[7]*v+c[15],p}const nn=100;class Or{constructor(o,c,m=new fc(o.width+200,o.height+200,25),v=new fc(o.width+200,o.height+200,25)){this.transform=o,this.grid=m,this.ignoredGrid=v,this.pitchfactor=Math.cos(o._pitch)*o.cameraToCenterDistance,this.screenRightBoundary=o.width+nn,this.screenBottomBoundary=o.height+nn,this.gridRightBoundary=o.width+200,this.gridBottomBoundary=o.height+200,this.fogState=c}placeCollisionBox(o,c,m,v,b,A,M,O){let k=m.projectedAnchorX,L=m.projectedAnchorY,U=m.projectedAnchorZ;const j=m.elevation,$=m.tileID,Q=o.getProjection();if(j&&$){const[ve,be,ye]=Q.upVector($.canonical,m.tileAnchorX,m.tileAnchorY),Ie=Q.upVectorScale($.canonical,this.transform.center.lat,this.transform.worldSize).metersToTile;k+=ve*j*Ie,L+=be*j*Ie,U+=ye*j*Ie}const Z=this.projectAndGetPerspectiveRatio(M,k,L,U,m.tileID,Q.name==="globe"||!!j||this.transform.pitch>0,Q),te=A*Z.perspectiveRatio,ee=(m.x1*c+v.x-m.padding)*te+Z.point.x,ae=(m.y1*c+v.y-m.padding)*te+Z.point.y,me=(m.x2*c+v.x+m.padding)*te+Z.point.x,fe=(m.y2*c+v.y+m.padding)*te+Z.point.y,Ae=Z.perspectiveRatio<=.55||Z.occluded;return!this.isInsideGrid(ee,ae,me,fe)||!b&&this.grid.hitTest(ee,ae,me,fe,O)||Ae?{box:[],offscreen:!1,occluded:Z.occluded}:{box:[ee,ae,me,fe],offscreen:this.isOffscreen(ee,ae,me,fe),occluded:!1}}placeCollisionCircles(o,c,m,v,b,A,M,O,k,L,U,j,$,Q,Z){const te=[],ee=this.transform.elevation,ae=o.getProjection(),me=ee?ee.getAtTileOffsetFunc(Z,this.transform.center.lat,this.transform.worldSize,ae):null,fe=new s.P(m.tileAnchorX,m.tileAnchorY);let{x:Ae,y:ve,z:be}=ae.projectTilePoint(fe.x,fe.y,Z.canonical);if(me){const[gt,Ve,ut]=me(fe);Ae+=gt,ve+=Ve,be+=ut}const ye=ae.name==="globe",Ie=this.projectAndGetPerspectiveRatio(M,Ae,ve,be,Z,ye||!!ee||this.transform.pitch>0,ae),{perspectiveRatio:Fe}=Ie,Qe=(U?A/Fe:A*Fe)/s.bw,We=zn(Ae,ve,be,O),at=Ie.signedDistanceFromCamera>0?_c(Qe,b,m.lineOffsetX*Qe,m.lineOffsetY*Qe,!1,We,fe,m,v,O,{},ee&&!U?me:null,U&&!!ee,ae,Z,U):null;let nt=!1,je=!1,et=!0;if(at&&!Ie.occluded){const gt=.5*$*Fe+Q,Ve=new s.P(-100,-100),ut=new s.P(this.screenRightBoundary,this.screenBottomBoundary),tt=new Ni,{first:Et,last:ft}=at,ct=Et.path.length;let xt=[];for(let Ut=ct-1;Ut>=1;Ut--)xt.push(Et.path[Ut]);for(let Ut=1;Ut<ft.path.length;Ut++)xt.push(ft.path[Ut]);const Tt=2.5*gt;k&&(xt=xt.map(([Ut,ni,Xt],Kt)=>(me&&!ye&&(Xt=me(Kt<ct-1?Et.tilePath[ct-1-Kt]:ft.tilePath[Kt-ct+2])[2]),zn(Ut,ni,Xt,k))),xt.some(Ut=>Ut[3]<=0)&&(xt=[]));let Lt=[];if(xt.length>0){let Ut=1/0,ni=-1/0,Xt=1/0,Kt=-1/0;for(const ci of xt)Ut=Math.min(Ut,ci[0]),Xt=Math.min(Xt,ci[1]),ni=Math.max(ni,ci[0]),Kt=Math.max(Kt,ci[1]);ni>=Ve.x&&Ut<=ut.x&&Kt>=Ve.y&&Xt<=ut.y&&(Lt=[xt.map(ci=>new s.P(ci[0],ci[1]))],(Ut<Ve.x||ni>ut.x||Xt<Ve.y||Kt>ut.y)&&(Lt=s.bu(Lt,Ve.x,Ve.y,ut.x,ut.y)))}for(const Ut of Lt){tt.reset(Ut,.25*gt);let ni=0;ni=tt.length<=.5*gt?1:Math.ceil(tt.paddedLength/Tt)+1;for(let Xt=0;Xt<ni;Xt++){const Kt=Xt/Math.max(ni-1,1),ci=tt.lerp(Kt),Ci=ci.x+nn,Xi=ci.y+nn;te.push(Ci,Xi,gt,0);const pr=Ci-gt,rr=Xi-gt,di=Ci+gt,Fi=Xi+gt;if(et=et&&this.isOffscreen(pr,rr,di,Fi),je=je||this.isInsideGrid(pr,rr,di,Fi),!c&&this.grid.hitTestCircle(Ci,Xi,gt,j)&&(nt=!0,!L))return{circles:[],offscreen:!1,collisionDetected:nt,occluded:!1}}}}return{circles:!L&&nt||!je?[]:te,offscreen:et,collisionDetected:nt,occluded:Ie.occluded}}queryRenderedSymbols(o){if(o.length===0||this.grid.keysLength()===0&&this.ignoredGrid.keysLength()===0)return{};const c=[];let m=1/0,v=1/0,b=-1/0,A=-1/0;for(const L of o){const U=new s.P(L.x+nn,L.y+nn);m=Math.min(m,U.x),v=Math.min(v,U.y),b=Math.max(b,U.x),A=Math.max(A,U.y),c.push(U)}const M=this.grid.query(m,v,b,A).concat(this.ignoredGrid.query(m,v,b,A)),O={},k={};for(const L of M){const U=L.key;if(O[U.bucketInstanceId]===void 0&&(O[U.bucketInstanceId]={}),O[U.bucketInstanceId][U.featureIndex])continue;const j=[new s.P(L.x1,L.y1),new s.P(L.x2,L.y1),new s.P(L.x2,L.y2),new s.P(L.x1,L.y2)];s.bv(c,j)&&(O[U.bucketInstanceId][U.featureIndex]=!0,k[U.bucketInstanceId]===void 0&&(k[U.bucketInstanceId]=[]),k[U.bucketInstanceId].push(U.featureIndex))}return k}insertCollisionBox(o,c,m,v,b){(c?this.ignoredGrid:this.grid).insert({bucketInstanceId:m,featureIndex:v,collisionGroupID:b},o[0],o[1],o[2],o[3])}insertCollisionCircles(o,c,m,v,b){const A=c?this.ignoredGrid:this.grid,M={bucketInstanceId:m,featureIndex:v,collisionGroupID:b};for(let O=0;O<o.length;O+=4)A.insertCircle(M,o[O],o[O+1],o[O+2])}projectAndGetPerspectiveRatio(o,c,m,v,b,A,M){const O=[c,m,v,1];let k=!1;v||this.transform.pitch>0?(s.ab.vec4.transformMat4(O,O,o),this.fogState&&b&&M.name!=="globe"&&(k=function(j,$,Q,Z,te,ee){const ae=ee.calculateFogTileMatrix(te),me=[$,Q,Z];return s.ab.vec3.transformMat4(me,me,ae),Be(j,s.ab.vec3.length(me),ee.pitch,ee._fov)}(this.fogState,c,m,v,b.toUnwrapped(),this.transform)>.9)):Ts(O,O,o);const L=O[3];return{point:new s.P((O[0]/L+1)/2*this.transform.width+nn,(-O[1]/L+1)/2*this.transform.height+nn),perspectiveRatio:Math.min(.5+this.transform.getCameraToCenterDistance(M)/L*.5,1.5),signedDistanceFromCamera:L,occluded:A&&O[2]>L||k}}isOffscreen(o,c,m,v){return m<nn||o>=this.screenRightBoundary||v<nn||c>this.screenBottomBoundary}isInsideGrid(o,c,m,v){return m>=0&&o<this.gridRightBoundary&&v>=0&&c<this.gridBottomBoundary}getViewportMatrix(){const o=s.ab.mat4.identity([]);return s.ab.mat4.translate(o,o,[-100,-100,0]),o}}function gc(p,o,c){const m=o.createTileMatrix(p,p.worldSize,c.toUnwrapped());return s.ab.mat4.multiply(new Float32Array(16),p.projMatrix,m)}function Ds(p,o,c){if(o.projection.name===c.projection.name)return p.projMatrix;const m=c.clone();return m.setProjection(o.projection),gc(m,o.getProjection(),p)}function Sa(p,o,c){return o.name===c.projection.name?p.projMatrix:gc(c,o,p)}class yc{constructor(o,c,m,v){this.opacity=o?Math.max(0,Math.min(1,o.opacity+(o.placed?c:-c))):v&&m?1:0,this.placed=m}isHidden(){return this.opacity===0&&!this.placed}}class Os{constructor(o,c,m,v,b,A=!1){this.text=new yc(o?o.text:null,c,m,b),this.icon=new yc(o?o.icon:null,c,v,b),this.clipped=A}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class Vd{constructor(o,c,m,v=!1){this.text=o,this.icon=c,this.skipFade=m,this.clipped=v}}class Mo{constructor(){this.invProjMatrix=s.ab.mat4.create(),this.viewportMatrix=s.ab.mat4.create(),this.circles=[]}}class S0{constructor(o,c,m,v,b){this.bucketInstanceId=o,this.featureIndex=c,this.sourceLayerIndex=m,this.bucketIndex=v,this.tileID=b}}class jd{constructor(o){this.crossSourceCollisions=o,this.maxGroupID=0,this.collisionGroups={}}get(o){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[o]){const c=++this.maxGroupID;this.collisionGroups[o]={ID:c,predicate:m=>m.collisionGroupID===c}}return this.collisionGroups[o]}}function Un(p,o,c,m,v){const{horizontalAlign:b,verticalAlign:A}=s.bD(p),M=-(b-.5)*o,O=-(A-.5)*c,k=s.bC(p,m);return new s.P(M+k[0]*v,O+k[1]*v)}function Hd(p,o,c,m,v){const b=new s.P(p,o);return c&&b._rotate(m?v:-v),b}class Xu{constructor(o,c,m,v,b,A){this.transform=o.clone(),this.projection=o.projection.name,this.collisionIndex=new Or(this.transform,b),this.buildingIndex=A,this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=c,this.retainedQueryData={},this.collisionGroups=new jd(m),this.collisionCircleArrays={},this.prevPlacement=v,v&&(v.prevPlacement=void 0),this.placedOrientations={}}getBucketParts(o,c,m,v,b=1){const A=m.getBucket(c),M=m.latestFeatureIndex;if(!A||!M||c.fqid!==A.layerIds[0])return;const O=A.layers[0].layout,k=A.layers[0].paint,L=m.collisionBoxArray,U=Math.pow(2,this.transform.zoom-m.tileID.overscaledZ),j=m.tileSize/s.ag,$=m.tileID.toUnwrapped();this.transform.setProjection(A.projection);const Q=(Z=m.tileID,te=A.getProjection(),ee=this.transform,te.name===this.projection?ee.calculateProjMatrix(Z.toUnwrapped()):gc(ee,te,Z));var Z,te,ee;const ae=O.get("text-pitch-alignment")==="map",me=O.get("text-rotation-alignment")==="map";c.compileFilter(c.options);const fe=c.dynamicFilter(),Ae=c.dynamicFilterNeedsFeature(),ve=this.transform.calculatePixelsToTileUnitsMatrix(m),be=wr(Q,m.tileID.canonical,ae,me,this.transform,A.getProjection(),ve);let ye=null;if(ae){const gt=zd(Q,m.tileID.canonical,ae,me,this.transform,A.getProjection(),ve);ye=s.ab.mat4.multiply([],this.transform.labelPlaneMatrix,gt)}let Ie=null;fe&&m.latestFeatureIndex&&(Ie={unwrappedTileID:$,dynamicFilter:fe,dynamicFilterNeedsFeature:Ae}),this.retainedQueryData[A.bucketInstanceId]=new S0(A.bucketInstanceId,M,A.sourceLayerIndex,A.index,m.tileID);const[Fe,Qe]=A.layers[0].layout.get("text-size-scale-range"),We=s.aw(b,Fe,Qe),[at,nt]=O.get("icon-size-scale-range"),je=s.aw(b,at,nt),et={bucket:A,layout:O,paint:k,posMatrix:Q,textLabelPlaneMatrix:be,labelToScreenMatrix:ye,clippingData:Ie,scale:U,textPixelRatio:j,holdingForFade:m.holdingForFade(),collisionBoxArray:L,partiallyEvaluatedTextSize:s.bp(A.textSizeData,this.transform.zoom,We),partiallyEvaluatedIconSize:s.bp(A.iconSizeData,this.transform.zoom,je),collisionGroup:this.collisionGroups.get(A.sourceID),latestFeatureIndex:m.latestFeatureIndex};if(v)for(const gt of A.sortKeyRanges){const{sortKey:Ve,symbolInstanceStart:ut,symbolInstanceEnd:tt}=gt;o.push({sortKey:Ve,symbolInstanceStart:ut,symbolInstanceEnd:tt,parameters:et})}else o.push({symbolInstanceStart:0,symbolInstanceEnd:A.symbolInstances.length,parameters:et})}attemptAnchorPlacement(o,c,m,v,b,A,M,O,k,L,U,j,$,Q,Z,te,ee,ae){const{textOffset0:me,textOffset1:fe,crossTileID:Ae}=j,ve=[me,fe],be=Un(o,m,v,ve,b),ye=this.collisionIndex.placeCollisionBox(Q,b,c,Hd(be.x,be.y,A,M,this.transform.angle),U,O,k,L.predicate);if(te){const Ie=Q.getSymbolInstanceIconSize(ae,this.transform.zoom,j.placedIconSymbolIndex);if(this.collisionIndex.placeCollisionBox(Q,Ie,te,Hd(be.x,be.y,A,M,this.transform.angle),U,O,k,L.predicate).box.length===0)return}if(ye.box.length>0){let Ie;return this.prevPlacement&&this.prevPlacement.variableOffsets[Ae]&&this.prevPlacement.placements[Ae]&&this.prevPlacement.placements[Ae].text&&(Ie=this.prevPlacement.variableOffsets[Ae].anchor),this.variableOffsets[Ae]={textOffset:ve,width:m,height:v,anchor:o,textScale:b,prevAnchor:Ie},this.markUsedJustification(Q,o,j,Z),Q.allowVerticalPlacement&&(this.markUsedOrientation(Q,Z,j),this.placedOrientations[Ae]=Z),{shift:be,placedGlyphBoxes:ye}}}placeLayerBucketPart(o,c,m,v,b=1){const{bucket:A,layout:M,paint:O,posMatrix:k,textLabelPlaneMatrix:L,labelToScreenMatrix:U,clippingData:j,textPixelRatio:$,holdingForFade:Q,collisionBoxArray:Z,partiallyEvaluatedTextSize:te,partiallyEvaluatedIconSize:ee,collisionGroup:ae,latestFeatureIndex:me}=o.parameters,fe=M.get("text-optional"),Ae=M.get("icon-optional"),ve=M.get("text-allow-overlap"),be=M.get("icon-allow-overlap"),ye=M.get("text-rotation-alignment")==="map",Ie=M.get("text-pitch-alignment")==="map",Fe=M.get("symbol-z-elevate"),Qe=O.get("symbol-z-offset"),We=M.get("symbol-elevation-reference")==="sea",[at,nt]=M.get("text-size-scale-range"),[je,et]=M.get("icon-size-scale-range"),gt=s.aw(b,at,nt),Ve=s.aw(b,je,et);this.transform.setProjection(A.projection);let ut=ve&&(be||!A.hasIconData()||Ae),tt=be&&(ve||!A.hasTextData()||fe);const Et=!Qe.isConstant();!A.collisionArrays&&Z&&A.deserializeCollisionBoxes(Z),m&&v&&A.updateCollisionDebugBuffers(this.transform.zoom,Z,gt,Ve);const ft=(ct,xt,Tt)=>{const{crossTileID:Lt,numVerticalGlyphVertices:Ut}=ct;let ni=null;if(j&&j.dynamicFilterNeedsFeature||Et){const Qi=this.retainedQueryData[A.bucketInstanceId];ni=me.loadFeature({featureIndex:ct.featureIndex,bucketIndex:Qi.bucketIndex,sourceLayerIndex:Qi.sourceLayerIndex,layoutVertexArrayOffset:0})}if(j&&!(0,j.dynamicFilter)({zoom:this.transform.zoom,pitch:this.transform.pitch},ni,this.retainedQueryData[A.bucketInstanceId].tileID.canonical,new s.P(ct.tileAnchorX,ct.tileAnchorY),this.transform.calculateDistanceTileData(j.unwrappedTileID)))return this.placements[Lt]=new Vd(!1,!1,!1,!0),void c.add(Lt);const Xt=Qe.evaluate(ni,{});if(c.has(Lt))return;if(Q)return void(this.placements[Lt]=new Vd(!1,!1,!1));let Kt=!1,ci=!1,Ci=!0,Xi=!1,pr=!1,rr=null,di={box:null,offscreen:null,occluded:null},Fi={box:null},Wt=null,Ei=null,Ui=null,Hi=0,ur=0,Xr=0;Tt.textFeatureIndex?Hi=Tt.textFeatureIndex:ct.useRuntimeCollisionCircles&&(Hi=ct.featureIndex),Tt.verticalTextFeatureIndex&&(ur=Tt.verticalTextFeatureIndex);const Lr=Qi=>{Qi.tileID=this.retainedQueryData[A.bucketInstanceId].tileID;const Ki=this.transform.elevation;Qi.elevation=We?Xt:Xt+(Ki?Ki.getAtTileOffset(Qi.tileID,Qi.tileAnchorX,Qi.tileAnchorY):0),Qi.elevation+=ct.zOffset},Nr=Tt.textBox;if(Nr){Lr(Nr);const Qi=Ri=>{let Ir=s.bq.horizontal;if(A.allowVerticalPlacement&&!Ri&&this.prevPlacement){const Zr=this.prevPlacement.placedOrientations[Lt];Zr&&(this.placedOrientations[Lt]=Zr,Ir=Zr,this.markUsedOrientation(A,Ir,ct))}return Ir},Ki=(Ri,Ir)=>{if(A.allowVerticalPlacement&&Ut>0&&Tt.verticalTextBox){for(const Zr of A.writingModes)if(Zr===s.bq.vertical?(di=Ir(),Fi=di):di=Ri(),di&&di.box&&di.box.length)break}else di=Ri()};if(M.get("text-variable-anchor")){let Ri=M.get("text-variable-anchor");if(this.prevPlacement&&this.prevPlacement.variableOffsets[Lt]){const Ji=this.prevPlacement.variableOffsets[Lt];Ri.indexOf(Ji.anchor)>0&&(Ri=Ri.filter(wn=>wn!==Ji.anchor),Ri.unshift(Ji.anchor))}const Ir=(Ji,wn,Is)=>{const ts=A.getSymbolInstanceTextSize(te,ct,this.transform.zoom,xt),Hn=(Ji.x2-Ji.x1)*ts+2*Ji.padding,oo=(Ji.y2-Ji.y1)*ts+2*Ji.padding,Cs=ct.hasIconTextFit&&!be?wn:null;Cs&&Lr(Cs);let gs={box:[],offscreen:!1,occluded:!1};const Wa=ve?2*Ri.length:Ri.length;for(let ao=0;ao<Wa;++ao){const qa=this.attemptAnchorPlacement(Ri[ao%Ri.length],Ji,Hn,oo,ts,ye,Ie,$,k,ae,ao>=Ri.length,ct,xt,A,Is,Cs,te,ee);if(qa&&(gs=qa.placedGlyphBoxes,gs&&gs.box&&gs.box.length)){Kt=!0,rr=qa.shift;break}}return gs};Ki(()=>Ir(Nr,Tt.iconBox,s.bq.horizontal),()=>{const Ji=Tt.verticalTextBox;return Ji&&Lr(Ji),A.allowVerticalPlacement&&!(di&&di.box&&di.box.length)&&Ut>0&&Ji?Ir(Ji,Tt.verticalIconBox,s.bq.vertical):{box:null,offscreen:null,occluded:null}}),di&&(Kt=di.box,Ci=di.offscreen,Xi=di.occluded);const Zr=Qi(!(!di||!di.box));if(!Kt&&this.prevPlacement){const Ji=this.prevPlacement.variableOffsets[Lt];Ji&&(this.variableOffsets[Lt]=Ji,this.markUsedJustification(A,Ji.anchor,ct,Zr))}}else{const Ri=(Ir,Zr)=>{const Ji=A.getSymbolInstanceTextSize(te,ct,this.transform.zoom,xt,b),wn=this.collisionIndex.placeCollisionBox(A,Ji,Ir,new s.P(0,0),ve,$,k,ae.predicate);return wn&&wn.box&&wn.box.length&&(this.markUsedOrientation(A,Zr,ct),this.placedOrientations[Lt]=Zr),wn};Ki(()=>Ri(Nr,s.bq.horizontal),()=>{const Ir=Tt.verticalTextBox;return A.allowVerticalPlacement&&Ut>0&&Ir?(Lr(Ir),Ri(Ir,s.bq.vertical)):{box:null,offscreen:null,occluded:null}}),Qi(!!(di&&di.box&&di.box.length))}}if(Wt=di,Kt=Wt&&Wt.box&&Wt.box.length>0,Ci=Wt&&Wt.offscreen,Xi=Wt&&Wt.occluded,ct.useRuntimeCollisionCircles){const Qi=A.text.placedSymbolArray.get(ct.centerJustifiedTextSymbolIndex>=0?ct.centerJustifiedTextSymbolIndex:ct.verticalPlacedTextSymbolIndex),Ki=s.br(A.textSizeData,te,Qi),Ri=M.get("text-padding");Ei=this.collisionIndex.placeCollisionCircles(A,ve,Qi,A.lineVertexArray,A.glyphOffsetArray,Ki,k,L,U,m,Ie,ae.predicate,ct.collisionCircleDiameter*Ki/s.bw,Ri,this.retainedQueryData[A.bucketInstanceId].tileID),Kt=ve||Ei.circles.length>0&&!Ei.collisionDetected,Ci=Ci&&Ei.offscreen,Xi=Ei.occluded}if(Tt.iconFeatureIndex&&(Xr=Tt.iconFeatureIndex),Tt.iconBox){const Qi=Ki=>{Lr(Ki);const Ri=ct.hasIconTextFit&&rr?Hd(rr.x,rr.y,ye,Ie,this.transform.angle):new s.P(0,0),Ir=A.getSymbolInstanceIconSize(ee,this.transform.zoom,ct.placedIconSymbolIndex);return this.collisionIndex.placeCollisionBox(A,Ir,Ki,Ri,be,$,k,ae.predicate)};Fi&&Fi.box&&Fi.box.length&&Tt.verticalIconBox?(Ui=Qi(Tt.verticalIconBox),ci=Ui.box.length>0):(Ui=Qi(Tt.iconBox),ci=Ui.box.length>0),Ci=Ci&&Ui.offscreen,pr=Ui.occluded}const _s=fe||ct.numHorizontalGlyphVertices===0&&Ut===0,bn=Ae||ct.numIconVertices===0;if(_s||bn?bn?_s||(ci=ci&&Kt):Kt=ci&&Kt:ci=Kt=ci&&Kt,Kt&&Wt&&Wt.box&&this.collisionIndex.insertCollisionBox(Wt.box,M.get("text-ignore-placement"),A.bucketInstanceId,Fi&&Fi.box&&ur?ur:Hi,ae.ID),ci&&Ui&&this.collisionIndex.insertCollisionBox(Ui.box,M.get("icon-ignore-placement"),A.bucketInstanceId,Xr,ae.ID),Ei&&(Kt&&this.collisionIndex.insertCollisionCircles(Ei.circles,M.get("text-ignore-placement"),A.bucketInstanceId,Hi,ae.ID),m)){const Qi=A.bucketInstanceId;let Ki=this.collisionCircleArrays[Qi];Ki===void 0&&(Ki=this.collisionCircleArrays[Qi]=new Mo);for(let Ri=0;Ri<Ei.circles.length;Ri+=4)Ki.circles.push(Ei.circles[Ri+0]),Ki.circles.push(Ei.circles[Ri+1]),Ki.circles.push(Ei.circles[Ri+2]),Ki.circles.push(Ei.collisionDetected?1:0)}const hr=A.projection.name!=="globe";ut=ut&&(hr||!Xi),tt=tt&&(hr||!pr),this.placements[Lt]=new Vd(Kt||ut,ci||tt,Ci||A.justReloaded),c.add(Lt)};if(Fe&&this.buildingIndex&&(this.buildingIndex.updateZOffset(A,this.retainedQueryData[A.bucketInstanceId].tileID),A.updateZOffset()),A.sortFeaturesByY){const ct=A.getSortedSymbolIndexes(this.transform.angle);for(let xt=ct.length-1;xt>=0;--xt){const Tt=ct[xt];ft(A.symbolInstances.get(Tt),Tt,A.collisionArrays[Tt])}A.hasAnyZOffset&&s.w(`${A.layerIds[0]} layer symbol-z-elevate: symbols are not sorted by elevation if symbol-z-order is evaluated to viewport-y`)}else if(A.hasAnyZOffset){const ct=A.getSortedIndexesByZOffset();for(let xt=0;xt<ct.length;++xt){const Tt=ct[xt];ft(A.symbolInstances.get(Tt),Tt,A.collisionArrays[Tt])}}else for(let ct=o.symbolInstanceStart;ct<o.symbolInstanceEnd;ct++)ft(A.symbolInstances.get(ct),ct,A.collisionArrays[ct]);if(m&&A.bucketInstanceId in this.collisionCircleArrays){const ct=this.collisionCircleArrays[A.bucketInstanceId];s.ab.mat4.invert(ct.invProjMatrix,k),ct.viewportMatrix=this.collisionIndex.getViewportMatrix()}A.justReloaded=!1}markUsedJustification(o,c,m,v){const{leftJustifiedTextSymbolIndex:b,centerJustifiedTextSymbolIndex:A,rightJustifiedTextSymbolIndex:M,verticalPlacedTextSymbolIndex:O,crossTileID:k}=m,L=s.bB(c),U=v===s.bq.vertical?O:L==="left"?b:L==="center"?A:L==="right"?M:-1;b>=0&&(o.text.placedSymbolArray.get(b).crossTileID=U>=0&&b!==U?0:k),A>=0&&(o.text.placedSymbolArray.get(A).crossTileID=U>=0&&A!==U?0:k),M>=0&&(o.text.placedSymbolArray.get(M).crossTileID=U>=0&&M!==U?0:k),O>=0&&(o.text.placedSymbolArray.get(O).crossTileID=U>=0&&O!==U?0:k)}markUsedOrientation(o,c,m){const v=c===s.bq.horizontal||c===s.bq.horizontalOnly?c:0,b=c===s.bq.vertical?c:0,{leftJustifiedTextSymbolIndex:A,centerJustifiedTextSymbolIndex:M,rightJustifiedTextSymbolIndex:O,verticalPlacedTextSymbolIndex:k}=m,L=o.text.placedSymbolArray;A>=0&&(L.get(A).placedOrientation=v),M>=0&&(L.get(M).placedOrientation=v),O>=0&&(L.get(O).placedOrientation=v),k>=0&&(L.get(k).placedOrientation=b)}commit(o){this.commitTime=o,this.zoomAtLastRecencyCheck=this.transform.zoom;const c=this.prevPlacement;let m=!1;this.prevZoomAdjustment=c?c.zoomAdjustment(this.transform.zoom):0;const v=c?c.symbolFadeChange(o):1,b=c?c.opacities:{},A=c?c.variableOffsets:{},M=c?c.placedOrientations:{};for(const O in this.placements){const k=this.placements[O],L=b[O];L?(this.opacities[O]=new Os(L,v,k.text,k.icon,null,k.clipped),m=m||k.text!==L.text.placed||k.icon!==L.icon.placed):(this.opacities[O]=new Os(null,v,k.text,k.icon,k.skipFade,k.clipped),m=m||k.text||k.icon)}for(const O in b){const k=b[O];if(!this.opacities[O]){const L=new Os(k,v,!1,!1);L.isHidden()||(this.opacities[O]=L,m=m||k.text.placed||k.icon.placed)}}for(const O in A)this.variableOffsets[O]||!this.opacities[O]||this.opacities[O].isHidden()||(this.variableOffsets[O]=A[O]);for(const O in M)this.placedOrientations[O]||!this.opacities[O]||this.opacities[O].isHidden()||(this.placedOrientations[O]=M[O]);m?this.lastPlacementChangeTime=o:typeof this.lastPlacementChangeTime!="number"&&(this.lastPlacementChangeTime=c?c.lastPlacementChangeTime:o)}updateLayerOpacities(o,c,m,v){const b=new Set;for(const A of c){const M=A.getBucket(o);M&&A.latestFeatureIndex&&o.fqid===M.layerIds[0]&&(this.updateBucketOpacities(M,b,A,A.collisionBoxArray,m,v,A.tileID,o.scope),M.layers[0].layout.get("symbol-z-elevate")&&this.buildingIndex&&(this.buildingIndex.updateZOffset(M,A.tileID),M.updateZOffset()))}}updateBucketOpacities(o,c,m,v,b,A,M,O){o.hasTextData()&&o.text.opacityVertexArray.clear(),o.hasIconData()&&o.icon.opacityVertexArray.clear(),o.hasIconCollisionBoxData()&&o.iconCollisionBox.collisionVertexArray.clear(),o.hasTextCollisionBoxData()&&o.textCollisionBox.collisionVertexArray.clear();const k=o.layers[0].layout,L=o.layers[0].paint,U=!!o.layers[0].dynamicFilter(),j=new Os(null,0,!1,!1,!0),$=k.get("text-allow-overlap"),Q=k.get("icon-allow-overlap"),Z=k.get("text-variable-anchor"),te=k.get("text-rotation-alignment")==="map",ee=k.get("text-pitch-alignment")==="map",ae=L.get("symbol-z-offset"),me=k.get("symbol-elevation-reference")==="sea",fe=!ae.isConstant(),Ae=new Os(null,0,$&&(Q||!o.hasIconData()||k.get("icon-optional")),Q&&($||!o.hasTextData()||k.get("text-optional")),!0);!o.collisionArrays&&v&&(o.hasIconCollisionBoxData()||o.hasTextCollisionBoxData())&&o.deserializeCollisionBoxes(v);const ve=(ye,Ie,Fe)=>{for(let Qe=0;Qe<Ie/4;Qe++)ye.opacityVertexArray.emplaceBack(Fe)};let be=0;A&&o.updateReplacement(M,A);for(let ye=0;ye<o.symbolInstances.length;ye++){const Ie=o.symbolInstances.get(ye),{numHorizontalGlyphVertices:Fe,numVerticalGlyphVertices:Qe,crossTileID:We,numIconVertices:at,tileAnchorX:nt,tileAnchorY:je}=Ie;let et=null;const gt=this.retainedQueryData[o.bucketInstanceId];fe&&Ie&&gt&&(et=m.latestFeatureIndex.loadFeature({featureIndex:Ie.featureIndex,bucketIndex:gt.bucketIndex,sourceLayerIndex:gt.sourceLayerIndex,layoutVertexArrayOffset:0}));const Ve=ae.evaluate(et,{}),ut=c.has(We);let tt=this.opacities[We];ut?tt=j:tt||(tt=Ae,this.opacities[We]=tt),c.add(We);const Et=Fe>0||Qe>0,ft=at>0,ct=this.placedOrientations[We],xt=ct===s.bq.vertical,Tt=ct===s.bq.horizontal||ct===s.bq.horizontalOnly;!Et&&!ft||tt.isHidden()||be++;let Lt=!1;if((Et||ft)&&A)for(const Ut of o.activeReplacements){if(s.bx(Ut,b,s.by.Symbol,O)||Ut.min.x>nt||nt>Ut.max.x||Ut.min.y>je||je>Ut.max.y)continue;const ni=s.bz(nt,je,M.canonical,Ut.footprintTileId.canonical);if(Lt=s.bA(ni,Ut.footprint),Lt)break}if(Et){const Ut=Lt?Ro:Gd(tt.text);ve(o.text,Fe,xt?Ro:Ut),ve(o.text,Qe,Tt?Ro:Ut);const ni=tt.text.isHidden(),{leftJustifiedTextSymbolIndex:Xt,centerJustifiedTextSymbolIndex:Kt,rightJustifiedTextSymbolIndex:ci,verticalPlacedTextSymbolIndex:Ci}=Ie,Xi=o.text.placedSymbolArray,pr=ni||xt?1:0;Xt>=0&&(Xi.get(Xt).hidden=pr),Kt>=0&&(Xi.get(Kt).hidden=pr),ci>=0&&(Xi.get(ci).hidden=pr),Ci>=0&&(Xi.get(Ci).hidden=ni||Tt?1:0);const rr=this.variableOffsets[We];rr&&this.markUsedJustification(o,rr.anchor,Ie,ct);const di=this.placedOrientations[We];di&&(this.markUsedJustification(o,"left",Ie,di),this.markUsedOrientation(o,di,Ie))}if(ft){const Ut=Lt?Ro:Gd(tt.icon),{placedIconSymbolIndex:ni,verticalPlacedIconSymbolIndex:Xt}=Ie,Kt=o.icon.placedSymbolArray,ci=tt.icon.isHidden()?1:0;ni>=0&&(ve(o.icon,at,xt?Ro:Ut),Kt.get(ni).hidden=ci),Xt>=0&&(ve(o.icon,Ie.numVerticalIconVertices,Tt?Ro:Ut),Kt.get(Xt).hidden=ci)}if(o.hasIconCollisionBoxData()||o.hasTextCollisionBoxData()){const Ut=o.collisionArrays[ye];if(Ut){let ni=new s.P(0,0),Xt=!0;if(Ut.textBox||Ut.verticalTextBox){if(Z){const ci=this.variableOffsets[We];ci?(ni=Un(ci.anchor,ci.width,ci.height,ci.textOffset,ci.textScale),te&&ni._rotate(ee?this.transform.angle:-this.transform.angle)):Xt=!1}U&&(Xt=!tt.clipped),Ut.textBox&&vc(o.textCollisionBox.collisionVertexArray,tt.text.placed,!Xt||xt,Ve,me,ni.x,ni.y),Ut.verticalTextBox&&vc(o.textCollisionBox.collisionVertexArray,tt.text.placed,!Xt||Tt,Ve,me,ni.x,ni.y)}const Kt=Xt&&!!(!Tt&&Ut.verticalIconBox);Ut.iconBox&&vc(o.iconCollisionBox.collisionVertexArray,tt.icon.placed,Kt,Ve,me,Ie.hasIconTextFit?ni.x:0,Ie.hasIconTextFit?ni.y:0),Ut.verticalIconBox&&vc(o.iconCollisionBox.collisionVertexArray,tt.icon.placed,!Kt,Ve,me,Ie.hasIconTextFit?ni.x:0,Ie.hasIconTextFit?ni.y:0)}}}if(o.fullyClipped=be===0,o.sortFeatures(this.transform.angle),this.retainedQueryData[o.bucketInstanceId]&&(this.retainedQueryData[o.bucketInstanceId].featureSortOrder=o.featureSortOrder),o.hasTextData()&&o.text.opacityVertexBuffer&&o.text.opacityVertexBuffer.updateData(o.text.opacityVertexArray),o.hasIconData()&&o.icon.opacityVertexBuffer&&o.icon.opacityVertexBuffer.updateData(o.icon.opacityVertexArray),o.hasIconCollisionBoxData()&&o.iconCollisionBox.collisionVertexBuffer&&o.iconCollisionBox.collisionVertexBuffer.updateData(o.iconCollisionBox.collisionVertexArray),o.hasTextCollisionBoxData()&&o.textCollisionBox.collisionVertexBuffer&&o.textCollisionBox.collisionVertexBuffer.updateData(o.textCollisionBox.collisionVertexArray),o.bucketInstanceId in this.collisionCircleArrays){const ye=this.collisionCircleArrays[o.bucketInstanceId];o.placementInvProjMatrix=ye.invProjMatrix,o.placementViewportMatrix=ye.viewportMatrix,o.collisionCircleArray=ye.circles,delete this.collisionCircleArrays[o.bucketInstanceId]}}symbolFadeChange(o){return this.fadeDuration===0?1:(o-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(o){return Math.max(0,(this.transform.zoom-o)/1.5)}hasTransitions(o){return this.stale||o-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(o,c){const m=this.zoomAtLastRecencyCheck===c?1-this.zoomAdjustment(c):1;return this.zoomAtLastRecencyCheck=c,this.commitTime+this.fadeDuration*m>o}setStale(){this.stale=!0}}function vc(p,o,c,m,v,b,A){p.emplaceBack(o?1:0,c?1:0,b||0,A||0,m,v?1:0),p.emplaceBack(o?1:0,c?1:0,b||0,A||0,m,v?1:0),p.emplaceBack(o?1:0,c?1:0,b||0,A||0,m,v?1:0),p.emplaceBack(o?1:0,c?1:0,b||0,A||0,m,v?1:0)}const xc=Math.pow(2,25),I0=Math.pow(2,24),C0=Math.pow(2,17),bc=Math.pow(2,16),wc=Math.pow(2,9),M0=Math.pow(2,8),dl=Math.pow(2,1);function Gd(p){if(p.opacity===0&&!p.placed)return 0;if(p.opacity===1&&p.placed)return 4294967295;const o=p.placed?1:0,c=Math.floor(127*p.opacity);return c*xc+o*I0+c*C0+o*bc+c*wc+o*M0+c*dl+o}const Ro=0;class ea{constructor(o){this._sortAcrossTiles=o.layout.get("symbol-z-order")!=="viewport-y"&&o.layout.get("symbol-sort-key").constantOr(1)!==void 0,this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs=new Set,this._bucketParts=[]}continuePlacement(o,c,m,v,b,A){const M=this._bucketParts;for(;this._currentTileIndex<o.length;)if(c.getBucketParts(M,v,o[this._currentTileIndex],this._sortAcrossTiles,A),this._currentTileIndex++,b())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,M.sort((O,k)=>O.sortKey-k.sortKey));this._currentPartIndex<M.length;){const O=M[this._currentPartIndex];if(c.placeLayerBucketPart(O,this._seenCrossTileIDs,m,O.symbolInstanceStart===0,A),this._currentPartIndex++,b())return!0}return!1}}class R0{constructor(o,c,m,v,b,A,M,O,k){this.placement=new Xu(o,b,A,M,O,k),this._currentPlacementIndex=c.length-1,this._forceFullPlacement=m,this._showCollisionBoxes=v,this._done=!1}isDone(){return this._done}continuePlacement(o,c,m,v,b){const A=s.q.now(),M=()=>{const O=s.q.now()-A;return!this._forceFullPlacement&&O>2};for(;this._currentPlacementIndex>=0;){const O=c[o[this._currentPlacementIndex]],k=this.placement.collisionIndex.transform.zoom;if(O.type==="symbol"&&(!O.minzoom||O.minzoom<=k)&&(!O.maxzoom||O.maxzoom>k)){const L=O,U=L.layout.get("symbol-z-elevate"),j=L.layout.get("symbol-sort-key").constantOr(1)!==void 0,$=L.layout.get("symbol-z-order"),Q=$==="viewport-y"||$==="auto"&&!($!=="viewport-y"&&j),Z=L.layout.get("text-allow-overlap")||L.layout.get("icon-allow-overlap")||L.layout.get("text-ignore-placement")||L.layout.get("icon-ignore-placement"),te=Q&&Z,ee=this._inProgressLayer=this._inProgressLayer||new ea(L),ae=s.aC(O.source,O.scope);if(ee.continuePlacement(U||te?v[ae]:m[ae],this.placement,this._showCollisionBoxes,O,M,b))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(o){return this.placement.commit(o),this.placement}}const $d=512/s.ag/2;class P0{constructor(o,c,m){this.tileID=o,this.bucketInstanceId=m,this.index=new s.bE(c.length,16,Int32Array),this.keys=[],this.crossTileIDs=[];const v=o.canonical.x*s.ag,b=o.canonical.y*s.ag;for(let A=0;A<c.length;A++){const{key:M,crossTileID:O,tileAnchorX:k,tileAnchorY:L}=c.get(A),U=Math.floor((v+k)*$d),j=Math.floor((b+L)*$d);this.index.add(U,j),this.keys.push(M),this.crossTileIDs.push(O)}this.index.finish()}findMatches(o,c,m){const v=this.tileID.canonical.z<c.canonical.z?1:Math.pow(2,this.tileID.canonical.z-c.canonical.z),b=$d/Math.pow(2,c.canonical.z-this.tileID.canonical.z),A=c.canonical.x*s.ag,M=c.canonical.y*s.ag;for(let O=0;O<o.length;O++){const k=o.get(O);if(k.crossTileID)continue;const{key:L,tileAnchorX:U,tileAnchorY:j}=k,$=Math.floor((A+U)*b),Q=Math.floor((M+j)*b),Z=this.index.range($-v,Q-v,$+v,Q+v);for(const te of Z){const ee=this.crossTileIDs[te];if(this.keys[te]===L&&!m.has(ee)){m.add(ee),k.crossTileID=ee;break}}}}}class jm{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class B0{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(o){const c=Math.round((o-this.lng)/360);if(c!==0)for(const m in this.indexes){const v=this.indexes[m],b={};for(const A in v){const M=v[A];M.tileID=M.tileID.unwrapTo(M.tileID.wrap+c),b[M.tileID.key]=M}this.indexes[m]=b}this.lng=o}addBucket(o,c,m){if(this.indexes[o.overscaledZ]&&this.indexes[o.overscaledZ][o.key]){if(this.indexes[o.overscaledZ][o.key].bucketInstanceId===c.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(o.overscaledZ,this.indexes[o.overscaledZ][o.key])}for(let b=0;b<c.symbolInstances.length;b++)c.symbolInstances.get(b).crossTileID=0;this.usedCrossTileIDs[o.overscaledZ]||(this.usedCrossTileIDs[o.overscaledZ]=new Set);const v=this.usedCrossTileIDs[o.overscaledZ];for(const b in this.indexes){const A=this.indexes[b];if(Number(b)>o.overscaledZ)for(const M in A){const O=A[M];O.tileID.isChildOf(o)&&O.findMatches(c.symbolInstances,o,v)}else{const M=A[o.scaledTo(Number(b)).key];M&&M.findMatches(c.symbolInstances,o,v)}}for(let b=0;b<c.symbolInstances.length;b++){const A=c.symbolInstances.get(b);A.crossTileID||(A.crossTileID=m.generate(),v.add(A.crossTileID))}return this.indexes[o.overscaledZ]===void 0&&(this.indexes[o.overscaledZ]={}),this.indexes[o.overscaledZ][o.key]=new P0(o,c.symbolInstances,c.bucketInstanceId),!0}removeBucketCrossTileIDs(o,c){for(const m of c.crossTileIDs)this.usedCrossTileIDs[o].delete(m)}removeStaleBuckets(o){let c=!1;for(const m in this.indexes){const v=this.indexes[m];for(const b in v)o[v[b].bucketInstanceId]||(this.removeBucketCrossTileIDs(m,v[b]),delete v[b],c=!0)}return c}}class Wd{constructor(){this.layerIndexes={},this.crossTileIDs=new jm,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(o,c,m,v){let b=this.layerIndexes[o.fqid];b===void 0&&(b=this.layerIndexes[o.fqid]=new B0);let A=!1;const M={};v.name!=="globe"&&b.handleWrapJump(m);for(const O of c){const k=O.getBucket(o);k&&o.fqid===k.layerIds[0]&&(k.bucketInstanceId||(k.bucketInstanceId=++this.maxBucketInstanceId),b.addBucket(O.tileID,k,this.crossTileIDs)&&(A=!0),M[k.bucketInstanceId]=!0)}return b.removeStaleBuckets(M)&&(A=!0),A}pruneUnusedLayers(o){const c={};o.forEach(m=>{c[m]=!0});for(const m in this.layerIndexes)c[m]||delete this.layerIndexes[m]}}const Ia=771;class xi{constructor(o,c,m,v){this.blendFunction=o,this.blendColor=c,this.mask=m,this.blendEquation=v}}xi.Replace=[1,0,1,0],xi.disabled=new xi(xi.Replace,s.aj.transparent,[!1,!1,!1,!1]),xi.unblended=new xi(xi.Replace,s.aj.transparent,[!0,!0,!0,!0]),xi.alphaBlended=new xi([1,Ia,1,Ia],s.aj.transparent,[!0,!0,!0,!0]),xi.alphaBlendedNonPremultiplied=new xi([770,Ia,770,Ia],s.aj.transparent,[!0,!0,!0,!0]),xi.multiply=new xi([774,0,774,0],s.aj.transparent,[!0,!0,!0,!0]);class Yt{constructor(o,c,m){this.func=o,this.mask=c,this.range=m}}Yt.ReadOnly=!1,Yt.ReadWrite=!0,Yt.disabled=new Yt(519,Yt.ReadOnly,[0,1]);const Zu=7680;class oi{constructor(o,c,m,v,b,A){this.test=o,this.ref=c,this.mask=m,this.fail=v,this.depthFail=b,this.pass=A}}oi.disabled=new oi({func:519,mask:0},0,0,Zu,Zu,Zu);const fl=1029,Yu=2305;class li{constructor(o,c,m){this.enable=o,this.mode=c,this.frontFace=m}}function pl(p,o){const c=s.bG(p,3);s.ab.mat4.fromQuat(p,o),s.bI(p,3,c)}function Ca(p,o){const c=s.ab.quat.identity([]);return s.ab.quat.rotateZ(c,c,-o),s.ab.quat.rotateX(c,c,-p),c}function qd(p,o){const c=[p[0],p[1],0],m=[o[0],o[1],0];if(s.ab.vec3.length(c)>=1e-15){const A=s.ab.vec3.normalize([],c);s.ab.vec3.scale(m,A,s.ab.vec3.dot(m,A)),o[0]=m[0],o[1]=m[1]}const v=s.ab.vec3.cross([],o,p);if(s.ab.vec3.len(v)<1e-15)return null;const b=Math.atan2(-v[1],v[0]);return Ca(Math.atan2(Math.sqrt(p[0]*p[0]+p[1]*p[1]),-p[2]),b)}li.disabled=new li(!1,fl,Yu),li.backCCW=new li(!0,fl,Yu),li.backCW=new li(!0,fl,2304),li.frontCW=new li(!0,1028,2304),li.frontCCW=new li(!0,1028,Yu);class Ku{constructor(o,c){this.position=o,this.orientation=c}get position(){return this._position}set position(o){if(o){const c=o instanceof s.aa?o:new s.aa(o[0],o[1],o[2]);this._renderWorldCopies&&(c.x=s.bF(c.x,0,1)),this._position=c}else this._position=null}lookAtPoint(o,c){if(this.orientation=null,!this.position)return;const m=this.position,v=this._elevation?this._elevation.getAtPointOrZero(s.aa.fromLngLat(o)):0,b=s.aa.fromLngLat(o,v),A=[b.x-m.x,b.y-m.y,b.z-m.z];c||(c=[0,0,1]),c[2]=Math.abs(c[2]),this.orientation=qd(A,c)}setPitchBearing(o,c){this.orientation=Ca(s.ai(o),s.ai(-c))}}class Vn{constructor(o,c){this._transform=s.ab.mat4.identity([]),this.orientation=c,this.position=o}get mercatorPosition(){const o=this.position;return new s.aa(o[0],o[1],o[2])}get position(){const o=s.bG(this._transform,3);return[o[0],o[1],o[2]]}set position(o){var c;o&&s.bI(this._transform,3,[(c=o)[0],c[1],c[2],1])}get orientation(){return this._orientation}set orientation(o){this._orientation=o||s.ab.quat.identity([]),o&&pl(this._transform,this._orientation)}getPitchBearing(){const o=this.forward(),c=this.right();return{bearing:Math.atan2(-c[1],c[0]),pitch:Math.atan2(Math.sqrt(o[0]*o[0]+o[1]*o[1]),-o[2])}}setPitchBearing(o,c){this._orientation=Ca(o,c),pl(this._transform,this._orientation)}forward(){const o=s.bG(this._transform,2);return[-o[0],-o[1],-o[2]]}up(){const o=s.bG(this._transform,1);return[-o[0],-o[1],-o[2]]}right(){const o=s.bG(this._transform,0);return[o[0],o[1],o[2]]}getCameraToWorld(o,c){const m=new Float64Array(16);return s.ab.mat4.invert(m,this.getWorldToCamera(o,c)),m}getCameraToWorldMercator(){return this._transform}getWorldToCameraPosition(o,c,m){const v=this.position;s.ab.vec3.scale(v,v,-o);const b=new Float64Array(16);return s.ab.mat4.fromScaling(b,[m,m,m]),s.ab.mat4.translate(b,b,v),b[10]*=c,b}getWorldToCamera(o,c){const m=new Float64Array(16),v=new Float64Array(4),b=this.position;return s.ab.quat.conjugate(v,this._orientation),s.ab.vec3.scale(b,b,-o),s.ab.mat4.fromQuat(m,v),s.ab.mat4.translate(m,m,b),m[1]*=-1,m[5]*=-1,m[9]*=-1,m[13]*=-1,m[8]*=c,m[9]*=c,m[10]*=c,m[11]*=c,m}getCameraToClipPerspective(o,c,m,v){const b=new Float64Array(16);return s.ab.mat4.perspective(b,o,c,m,v),b}getCameraToClipOrthographic(o,c,m,v,b,A){const M=new Float64Array(16);return s.ab.mat4.ortho(M,o,c,m,v,b,A),M}getDistanceToElevation(o,c=!1){const m=o===0?0:s.bH(o,c?s.aS(this.position[1]):this.position[1]),v=this.forward();return(m-this.position[2])/v[2]}clone(){return new Vn([...this.position],[...this.orientation])}}const un={BaseColor:5,MetallicRoughness:6,Normal:7,Occlusion:8,Emission:9,LUT:10,ShadowMap0:11};class Rt{constructor(o=0,c=0,m=0,v=0){if(isNaN(o)||o<0||isNaN(c)||c<0||isNaN(m)||m<0||isNaN(v)||v<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=o,this.bottom=c,this.left=m,this.right=v}interpolate(o,c,m){return c.top!=null&&o.top!=null&&(this.top=s.af(o.top,c.top,m)),c.bottom!=null&&o.bottom!=null&&(this.bottom=s.af(o.bottom,c.bottom,m)),c.left!=null&&o.left!=null&&(this.left=s.af(o.left,c.left,m)),c.right!=null&&o.right!=null&&(this.right=s.af(o.right,c.right,m)),this}getCenter(o,c){const m=s.aw((this.left+o-this.right)/2,0,o),v=s.aw((this.top+c-this.bottom)/2,0,c);return new s.P(m,v)}equals(o){return this.top===o.top&&this.bottom===o.bottom&&this.left===o.left&&this.right===o.right}clone(){return new Rt(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}const Xd=(p,o,c)=>(1-c)*p+c*o,Ju=p=>p*p*p*p*p;class Ac{constructor(o,c,m,v,b,A,M){this.tileSize=512,this._renderWorldCopies=b===void 0||b,this._minZoom=o||0,this._maxZoom=c||22,this._minPitch=m??0,this._maxPitch=v??60,this.setProjection(A),this.setMaxBounds(M),this.width=0,this.height=0,this._center=new s.bO(0,0),this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._nearZ=0,this._farZ=0,this._unmodified=!0,this._edgeInsets=new Rt,this._projMatrixCache={},this._alignedProjMatrixCache={},this._fogTileMatrixCache={},this._expandedProjMatrixCache={},this._distanceTileDataCache={},this._camera=new Vn,this._centerAltitude=0,this._averageElevation=0,this.cameraElevationReference="ground",this._pixelsPerMercatorPixel=1,this.globeRadius=0,this.globeCenterInViewSpace=[0,0,0],this._tileCoverLift=0,this.freezeTileCoverage=!1,this._horizonShift=.1,this._orthographicProjectionAtLowPitch=!1}clone(){const o=new Ac(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies,this.getProjection());return o._elevation=this._elevation,o._centerAltitude=this._centerAltitude,o._centerAltitudeValidForExaggeration=this._centerAltitudeValidForExaggeration,o.tileSize=this.tileSize,o.mercatorFromTransition=this.mercatorFromTransition,o.width=this.width,o.height=this.height,o.cameraElevationReference=this.cameraElevationReference,o._center=this._center,o._setZoom(this.zoom),o._seaLevelZoom=this._seaLevelZoom,o.angle=this.angle,o._fov=this._fov,o._pitch=this._pitch,o._nearZ=this._nearZ,o._farZ=this._farZ,o._averageElevation=this._averageElevation,o._orthographicProjectionAtLowPitch=this._orthographicProjectionAtLowPitch,o._unmodified=this._unmodified,o._edgeInsets=this._edgeInsets.clone(),o._camera=this._camera.clone(),o._calcMatrices(),o.freezeTileCoverage=this.freezeTileCoverage,o.frustumCorners=this.frustumCorners,o}get isOrthographic(){return this.projection.name!=="globe"&&this._orthographicProjectionAtLowPitch&&this.pitch<15}get elevation(){return this._elevation}set elevation(o){this._elevation!==o&&(this._elevation=o,this._updateCameraOnTerrain(),this._calcMatrices())}get depthOcclusionForSymbolsAndCircles(){return this.projection.name!=="globe"&&!this.isOrthographic}updateElevation(o,c=!1){const m=this._elevation&&this._elevation.exaggeration()!==this._centerAltitudeValidForExaggeration;(this._seaLevelZoom==null||m)&&this._updateCameraOnTerrain(),(o||m)&&this._constrainCamera(c),this._calcMatrices()}getProjection(){return s.ay(this.projection,["name","center","parallels"])}setProjection(o){this.projectionOptions=o||{name:"mercator"};const c=this.projection?this.getProjection():void 0;this.projection=s.bP(this.projectionOptions);const m=this.getProjection(),v=!s.bn(c,m);return v&&this._calcMatrices(),this.mercatorFromTransition=!1,v}setOrthographicProjectionAtLowPitch(o){return this._orthographicProjectionAtLowPitch!==o&&(this._orthographicProjectionAtLowPitch=o,this._calcMatrices(),!0)}setMercatorFromTransition(){const o=this.projection.name;this.mercatorFromTransition=!0,this.projectionOptions={name:"mercator"},this.projection=s.bP({name:"mercator"});const c=o!==this.projection.name;return c&&this._calcMatrices(),c}get minZoom(){return this._minZoom}set minZoom(o){this._minZoom!==o&&(this._minZoom=o,this.zoom=Math.max(this.zoom,o))}get maxZoom(){return this._maxZoom}set maxZoom(o){this._maxZoom!==o&&(this._maxZoom=o,this.zoom=Math.min(this.zoom,o))}get minPitch(){return this._minPitch}set minPitch(o){this._minPitch!==o&&(this._minPitch=o,this.pitch=Math.max(this.pitch,o))}get maxPitch(){return this._maxPitch}set maxPitch(o){this._maxPitch!==o&&(this._maxPitch=o,this.pitch=Math.min(this.pitch,o))}get renderWorldCopies(){return this._renderWorldCopies&&this.projection.supportsWorldCopies===!0}set renderWorldCopies(o){o===void 0?o=!0:o===null&&(o=!1),this._renderWorldCopies=o}get worldSize(){return this.tileSize*this.scale}get cameraWorldSizeForFog(){const o=Math.max(this._camera.getDistanceToElevation(this._averageElevation),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(o))}get cameraWorldSize(){const o=Math.max(this._camera.getDistanceToElevation(this._averageElevation,!0),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(o))}get pixelsPerMeter(){return this.projection.pixelsPerMeter(this.center.lat,this.worldSize)}get cameraPixelsPerMeter(){return s.bH(1,this.center.lat)*this.cameraWorldSizeForFog}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new s.P(this.width,this.height)}get bearing(){return s.bF(this.rotation,-180,180)}set bearing(o){this.rotation=o}get rotation(){return-this.angle/Math.PI*180}set rotation(o){const c=-o*Math.PI/180;this.angle!==c&&(this._unmodified=!1,this.angle=c,this._calcMatrices(),this.rotationMatrix=s.ab.mat2.create(),s.ab.mat2.rotate(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(o){const c=s.aw(o,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==c&&(this._unmodified=!1,this._pitch=c,this._calcMatrices())}get aspect(){return this.width/this.height}get fov(){return this._fov/Math.PI*180}get fovX(){return this._fov}get fovY(){const o=1/Math.tan(.5*this.fovX);return 2*Math.atan(1/this.aspect/o)}set fov(o){o=Math.max(.01,Math.min(60,o)),this._fov!==o&&(this._unmodified=!1,this._fov=s.ai(o),this._calcMatrices())}get averageElevation(){return this._averageElevation}set averageElevation(o){this._averageElevation=o,this._calcFogMatrices(),this._distanceTileDataCache={}}get zoom(){return this._zoom}set zoom(o){const c=Math.min(Math.max(o,this.minZoom),this.maxZoom);this._zoom!==c&&(this._unmodified=!1,this._setZoom(c),this._updateSeaLevelZoom(),this._constrain(),this._calcMatrices())}_setZoom(o){this._zoom=o,this.scale=this.zoomScale(o),this.tileZoom=Math.floor(o),this.zoomFraction=o-this.tileZoom}get tileCoverLift(){return this._tileCoverLift}set tileCoverLift(o){this._tileCoverLift!==o&&(this._tileCoverLift=o)}_updateCameraOnTerrain(){const o=this.elevation?this.elevation.getAtPoint(this.locationCoordinate(this.center),Number.NEGATIVE_INFINITY):Number.NEGATIVE_INFINITY,c=this.elevation&&o===Number.NEGATIVE_INFINITY&&this.elevation.visibleDemTiles.length>0&&this.elevation.exaggeration()>0&&this._centerAltitudeValidForExaggeration;if(!this._elevation||o===Number.NEGATIVE_INFINITY&&(!c||!this._centerAltitude))return this._centerAltitude=0,this._seaLevelZoom=null,void(this._centerAltitudeValidForExaggeration=void 0);const m=this._elevation;c||this._centerAltitude&&this._centerAltitudeValidForExaggeration&&m.exaggeration()&&this._centerAltitudeValidForExaggeration!==m.exaggeration()?(this._centerAltitude=this._centerAltitude/this._centerAltitudeValidForExaggeration*m.exaggeration(),this._centerAltitudeValidForExaggeration=m.exaggeration()):(this._centerAltitude=o||0,this._centerAltitudeValidForExaggeration=m.exaggeration()),this._updateSeaLevelZoom()}_updateSeaLevelZoom(){this._centerAltitudeValidForExaggeration!==void 0&&(this._seaLevelZoom=this._zoomFromMercatorZ((this.pixelsPerMeter*this._centerAltitude+this.cameraToCenterDistance)/this.worldSize))}sampleAverageElevation(){if(!this._elevation)return 0;const o=this._elevation,c=[[.5,.2],[.3,.5],[.5,.5],[.7,.5],[.5,.8]],m=this.horizonLineFromTop();let v=0,b=0;for(let A=0;A<c.length;A++){const M=new s.P(c[A][0]*this.width,m+c[A][1]*(this.height-m)),O=o.pointCoordinate(M);if(!O)continue;const k=1/Math.hypot(O[0]-this._camera.position[0],O[1]-this._camera.position[1]);v+=O[3]*k,b+=k}return b===0?NaN:v/b}get center(){return this._center}set center(o){o.lat===this._center.lat&&o.lng===this._center.lng||(this._unmodified=!1,this._center=o,this._terrainEnabled()&&(this.cameraElevationReference==="ground"?this._updateCameraOnTerrain():this._updateZoomFromElevation()),this._constrain(),this._calcMatrices())}_updateZoomFromElevation(){if(this._seaLevelZoom==null||!this._elevation)return;const o=this._seaLevelZoom,c=this._elevation.getAtPointOrZero(this.locationCoordinate(this.center)),m=this.pixelsPerMeter/this.worldSize*c,v=this._mercatorZfromZoom(o),b=this._mercatorZfromZoom(this._maxZoom),A=Math.max(v-m,b);this._setZoom(this._zoomFromMercatorZ(A))}get padding(){return this._edgeInsets.toJSON()}set padding(o){this._edgeInsets.equals(o)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,o,1),this._calcMatrices())}computeZoomRelativeTo(o){const c=this.rayIntersectionCoordinate(this.pointRayIntersection(this.centerPoint,o.toAltitude()));let m;m=o.z<this._camera.position[2]?[c.x,c.y,c.z]:[o.x,o.y,o.z];const v=s.ab.vec3.length(s.ab.vec3.sub([],this._camera.position,m));return s.aw(this._zoomFromMercatorZ(v),this._minZoom,this._maxZoom)}setFreeCameraOptions(o){if(!this.height||!o.position&&!o.orientation)return;this._updateCameraState();let c=!1;if(o.orientation&&!s.ab.quat.exactEquals(o.orientation,this._camera.orientation)&&(c=this._setCameraOrientation(o.orientation)),o.position){const m=[o.position.x,o.position.y,o.position.z];s.ab.vec3.exactEquals(m,this._camera.position)||(this._setCameraPosition(m),c=!0)}c&&(this._updateStateFromCamera(),this.recenterOnTerrain())}getFreeCameraOptions(){this._updateCameraState();const o=this._camera.position,c=new Ku;return c.position=new s.aa(o[0],o[1],o[2]),c.orientation=this._camera.orientation,c._elevation=this.elevation,c._renderWorldCopies=this.renderWorldCopies,c}_setCameraOrientation(o){if(!s.ab.quat.length(o))return!1;s.ab.quat.normalize(o,o);const c=s.ab.vec3.transformQuat([],[0,0,-1],o),m=s.ab.vec3.transformQuat([],[0,-1,0],o);if(m[2]<0)return!1;const v=qd(c,m);return!!v&&(this._camera.orientation=v,!0)}_setCameraPosition(o){const c=this.zoomScale(this.minZoom)*this.tileSize,m=this.zoomScale(this.maxZoom)*this.tileSize,v=this.cameraToCenterDistance;o[2]=s.aw(o[2],v/m,v/c),this._camera.position=o}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}get fovAboveCenter(){return this._fov*(.5+this.centerOffset.y/this.height)}isPaddingEqual(o){return this._edgeInsets.equals(o)}interpolatePadding(o,c,m){this._unmodified=!1,this._edgeInsets.interpolate(o,c,m),this._constrain(),this._calcMatrices()}coveringZoomLevel(o){const c=(o.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/o.tileSize));return Math.max(0,c)}getVisibleUnwrappedCoordinates(o){const c=[new s.bQ(0,o)];if(this.renderWorldCopies){const m=this.pointCoordinate(new s.P(0,0)),v=this.pointCoordinate(new s.P(this.width,0)),b=this.pointCoordinate(new s.P(this.width,this.height)),A=this.pointCoordinate(new s.P(0,this.height)),M=Math.floor(Math.min(m.x,v.x,b.x,A.x)),O=Math.floor(Math.max(m.x,v.x,b.x,A.x)),k=1;for(let L=M-k;L<=O+k;L++)L!==0&&c.push(new s.bQ(L,o))}return c}isLODDisabled(o){return(!o||this.pitch<=60)&&this._edgeInsets.top<=this._edgeInsets.bottom&&!this._elevation&&!this.projection.isReprojectedInTileSpace}extendTileCover(o,c,m){let v=[];const b=m!==void 0,A=!b;if(A&&this.zoom<c||b&&m[0]===0&&m[1]===0)return v;const M=new Set,O=(L,U,j,$,Q)=>{const Z=s.c5(U,L,j,$,Q);M.has(Z)||(v.push(new s.aG(L,U,j,$,Q)),M.add(Z))};for(let L=0;L<o.length;L++){const U=o[L];if(A&&U.canonical.z!==c)continue;const j=U.canonical,$=U.overscaledZ,Q=U.wrap,Z=1<<j.z,te=j.x+1<Z,ee=j.x>0,ae=j.y+1<Z,me=j.y>0,fe=U.wrap-(ee?0:1),Ae=U.wrap+(te?0:1),ve=ee?j.x-1:Z-1,be=te?j.x+1:0;if(b)m[0]<0?(O($,Ae,j.z,be,j.y),m[1]<0&&ae&&(O($,Q,j.z,j.x,j.y+1),O($,Ae,j.z,be,j.y+1)),m[1]>0&&me&&(O($,Q,j.z,j.x,j.y-1),O($,Ae,j.z,be,j.y-1))):m[0]>0?(O($,fe,j.z,ve,j.y),m[1]<0&&ae&&(O($,Q,j.z,j.x,j.y+1),O($,fe,j.z,ve,j.y+1)),m[1]>0&&me&&(O($,Q,j.z,j.x,j.y-1),O($,fe,j.z,ve,j.y-1))):m[1]<0&&ae?O($,Q,j.z,j.x,j.y+1):me&&O($,Q,j.z,j.x,j.y-1);else{const ye=U.visibleQuadrants;1&ye&&(O($,fe,j.z,ve,j.y),me&&(O($,Q,j.z,j.x,j.y-1),O($,fe,j.z,ve,j.y-1))),2&ye&&(O($,Ae,j.z,be,j.y),me&&(O($,Q,j.z,j.x,j.y-1),O($,Ae,j.z,be,j.y-1))),4&ye&&(O($,fe,j.z,ve,j.y),ae&&(O($,Q,j.z,j.x,j.y+1),O($,fe,j.z,ve,j.y+1))),8&ye&&(O($,Ae,j.z,be,j.y),ae&&(O($,Q,j.z,j.x,j.y+1),O($,Ae,j.z,be,j.y+1)))}}const k=[];for(const L of v)v.some(U=>L.isChildOf(U))||k.push(L);if(v=k.filter(L=>!o.some(U=>!!(L.overscaledZ<c&&U.isChildOf(L))||L.equals(U)||L.isChildOf(U))),A){const L=1<<c,U=this.projection.name==="globe"?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),j=[L*U.x,L*U.y],$=4,Q=$*$;v=v.filter(Z=>{const te=Z.canonical.x+.5-j[0],ee=Z.canonical.y+.5-j[1];return te*te+ee*ee<Q})}return v}coveringTiles(o){let c=this.coveringZoomLevel(o);const m=c,v=this.elevation&&this.elevation.exaggeration(),b=v&&!o.isTerrainDEM,A=this.projection.name==="mercator";if(o.minzoom!==void 0&&c<o.minzoom)return[];o.maxzoom!==void 0&&c>o.maxzoom&&(c=o.maxzoom);const M=this.locationCoordinate(this.center),O=this.center.lat,k=1<<c,L=[k*M.x,k*M.y,0],U=this.projection.name==="globe",j=!U,$=s.bR.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,c,j),Q=U?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),Z=k*s.bH(1,this.center.lat),te=this._camera.position[2]/s.bH(1,this.center.lat),ee=[k*Q.x,k*Q.y,te*(j?1:Z)],ae=U||v,me=this.cameraToCenterDistance/o.tileSize*(o.roundZoom?1:.502),fe=this.isLODDisabled(!0)?c:0;let Ae;if(this._elevation&&o.isTerrainDEM)Ae=1e4*this._elevation.exaggeration();else if(this._elevation){const Ve=this._elevation.getMinMaxForVisibleTiles();Ae=Ve?Ve.max:this._centerAltitude}else Ae=this._centerAltitude;const ve=o.isTerrainDEM?-Ae:this._elevation?this._elevation.getMinElevationBelowMSL():0,be=this.projection.isReprojectedInTileSpace?s.bS(this):1,ye=Ve=>{const tt=new s.aa(Ve.x+25e-6,Ve.y,Ve.z),Et=new s.aa(Ve.x,Ve.y+25e-6,Ve.z),ft=Ve.toLngLat(),ct=tt.toLngLat(),xt=Et.toLngLat(),Tt=this.locationCoordinate(ft),Lt=this.locationCoordinate(ct),Ut=this.locationCoordinate(xt),ni=Math.hypot(Lt.x-Tt.x,Lt.y-Tt.y),Xt=Math.hypot(Ut.x-Tt.x,Ut.y-Tt.y);return Math.sqrt(ni*Xt)*be/25e-6},Ie=Ve=>{const ut=Ae,tt=ve;return{aabb:s.bV(this,k,0,0,0,Ve,tt,ut,this.projection),zoom:0,x:0,y:0,minZ:tt,maxZ:ut,wrap:Ve,fullyVisible:!1}},Fe=[];let Qe=[];const We=c,at=o.reparseOverscaled?m:c,nt=(te-this._centerAltitude)*Z,je=Ve=>{if(!this._elevation||!Ve.tileID||!A)return;const ut=this._elevation.getMinMaxForTile(Ve.tileID),tt=Ve.aabb;ut?(tt.min[2]=ut.min,tt.max[2]=ut.max,tt.center[2]=(tt.min[2]+tt.max[2])/2):(Ve.shouldSplit=gt(Ve),Ve.shouldSplit||(tt.min[2]=tt.max[2]=tt.center[2]=this._centerAltitude))},et=(Ve,ut)=>{if(.707*ut<Ve)return 1;const tt=ut/Ve;return tt/(1.4144271570014144+(Math.pow(1.1,tt-1.4144271570014144+1)-1)/(1.1-1)-1)},gt=Ve=>{if(Ve.zoom<fe)return!0;if(Ve.zoom===We)return!1;if(Ve.shouldSplit!=null)return Ve.shouldSplit;const ut=Ve.aabb.distanceX(ee),tt=Ve.aabb.distanceY(ee);let Et=nt,ft=1;if(U){Et=Ve.aabb.distanceZ(ee);const Xt=Math.pow(2,Ve.zoom),Kt=s.aS((Ve.y+1)/Xt),ci=s.aS(Ve.y/Xt),Ci=Math.min(Math.max(O,Kt),ci),Xi=s.c9(Ci)/s.c9(O);if(ft=Ci===O?1/Math.max(1,this._mercatorScaleRatio-.3):Math.min(1,Xi/this._mercatorScaleRatio),this.zoom<=s.c6&&Ve.zoom===We-1&&Xi>=.9)return!0}else if(b&&(Et=Ve.aabb.distanceZ(ee)*Z),this.projection.isReprojectedInTileSpace&&m<=5){const Xt=Math.pow(2,Ve.zoom),Kt=ye(new s.aa((Ve.x+.5)/Xt,(Ve.y+.5)/Xt));ft=Kt>.85?1:Kt}if(!A){const Xt=Math.sqrt(ut*ut+tt*tt+Et*Et);let Kt=(1<<We-Ve.zoom)*me*ft;return Kt*=et(Math.max(Et,nt),Xt),Xt<Kt}let ct=Number.MAX_VALUE,xt=0;const Tt=Ve.aabb.getCorners(),Lt=[];for(const Xt of Tt){s.ab.vec3.sub(Lt,Xt,ee),U||(b?Lt[2]*=Z:Lt[2]=nt);const Kt=s.ab.vec3.dot(Lt,this._camera.forward());Kt<ct&&(ct=Kt,xt=Math.abs(Lt[2]))}let Ut=(1<<We-Ve.zoom)*me*ft;if(Ut*=et(Math.max(xt,nt),ct),ct<Ut)return!0;const ni=Ve.aabb.closestPoint(L);return ni[0]===L[0]&&ni[1]===L[1]};if(this.renderWorldCopies)for(let Ve=1;Ve<=3;Ve++)Fe.push(Ie(-Ve)),Fe.push(Ie(Ve));for(Fe.push(Ie(0));Fe.length>0;){const Ve=Fe.pop(),ut=Ve.x,tt=Ve.y;let Et=Ve.fullyVisible;const ft=()=>this.projection.name==="globe"&&(Ve.y===0||Ve.y===(1<<Ve.zoom)-1);if(!Et){let ct=ae?Ve.aabb.intersects($):Ve.aabb.intersectsFlat($);if(ct===0&&ft()){const xt=new s.bT(Ve.zoom,ut,tt);ct=s.bU(this,k,xt,!0).intersects($)}if(ct===0)continue;Et=ct===2}if(Ve.zoom!==We&&gt(Ve))for(let ct=0;ct<4;ct++){const xt=(ut<<1)+ct%2,Tt=(tt<<1)+(ct>>1),Lt={aabb:A?Ve.aabb.quadrant(ct):s.bV(this,k,Ve.zoom+1,xt,Tt,Ve.wrap,Ve.minZ,Ve.maxZ,this.projection),zoom:Ve.zoom+1,x:xt,y:Tt,wrap:Ve.wrap,fullyVisible:Et,tileID:void 0,shouldSplit:void 0,minZ:Ve.minZ,maxZ:Ve.maxZ};b&&!U&&(Lt.tileID=new s.aG(Ve.zoom+1===We?at:Ve.zoom+1,Ve.wrap,Ve.zoom+1,xt,Tt),je(Lt)),Fe.push(Lt)}else{const ct=Ve.zoom===We?at:Ve.zoom;if(o.minzoom&&o.minzoom>ct)continue;let xt=0;if(!Et){let ni=ae?Ve.aabb.intersectsPrecise($):Ve.aabb.intersectsPreciseFlat($);if(ni===0&&ft()){const Xt=new s.bT(Ve.zoom,ut,tt);ni=s.bU(this,k,Xt,!0).intersectsPrecise($)}if(ni===0)continue;if(o.calculateQuadrantVisibility)if($.containsPoint(Ve.aabb.center))xt=15;else for(let Xt=0;Xt<4;Xt++)Ve.aabb.quadrant(Xt).intersects($)!==0&&(xt|=1<<Xt)}const Tt=L[0]-(.5+ut+(Ve.wrap<<Ve.zoom))*(1<<c-Ve.zoom),Lt=L[1]-.5-tt,Ut=Ve.tileID?Ve.tileID:new s.aG(ct,Ve.wrap,Ve.zoom,ut,tt);o.calculateQuadrantVisibility&&(Ut.visibleQuadrants=xt),Qe.push({tileID:Ut,distanceSq:Tt*Tt+Lt*Lt})}}if(this.fogCullDistSq){const Ve=this.fogCullDistSq,ut=this.horizonLineFromTop();Qe=Qe.filter(tt=>{const Et=[0,0,0,1],ft=[s.ag,s.ag,0,1],ct=this.calculateFogTileMatrix(tt.tileID.toUnwrapped());s.ab.vec4.transformMat4(Et,Et,ct),s.ab.vec4.transformMat4(ft,ft,ct);const xt=s.ab.vec4.min([],Et,ft),Tt=s.ab.vec4.max([],Et,ft),Lt=s.bW(xt,Tt);if(Lt===0)return!0;let Ut=!1;const ni=this._elevation;if(ni&&Lt>Ve&&ut!==0){const Xt=this.calculateProjMatrix(tt.tileID.toUnwrapped());let Kt;o.isTerrainDEM||(Kt=ni.getMinMaxForTile(tt.tileID)),Kt||(Kt={min:ve,max:Ae});const ci=s.c7(this.rotation),Ci=[ci[0]*s.ag,ci[1]*s.ag,Kt.max];s.ab.vec3.transformMat4(Ci,Ci,Xt),Ut=(1-Ci[1])*this.height*.5<ut}return Lt<Ve||Ut})}return Qe.sort((Ve,ut)=>Ve.distanceSq-ut.distanceSq).map(Ve=>Ve.tileID)}resize(o,c){this.width=o,this.height=c,this.pixelsToGLUnits=[2/o,-2/c],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(o){return Math.pow(2,o)}scaleZoom(o){return Math.log(o)/Math.LN2}project(o){const c=s.aw(o.lat,-s.bX,s.bX),m=this.projection.project(o.lng,c);return new s.P(m.x*this.worldSize,m.y*this.worldSize)}unproject(o){return this.projection.unproject(o.x/this.worldSize,o.y/this.worldSize)}get point(){return this.project(this.center)}get pointMerc(){return this.point._div(this.worldSize)}get pixelsPerMeterRatio(){return this.pixelsPerMeter/s.bH(1,this.center.lat)/this.worldSize}setLocationAtPoint(o,c){let m,v;const b=this.centerPoint;if(this.projection.name==="globe"){const M=this.worldSize;m=(c.x-b.x)/M,v=(c.y-b.y)/M}else{const M=this.pointCoordinate(c),O=this.pointCoordinate(b);m=M.x-O.x,v=M.y-O.y}const A=this.locationCoordinate(o);this.setLocation(new s.aa(A.x-m,A.y-v))}setLocation(o){this.center=this.coordinateLocation(o),this.projection.wrap&&(this.center=this.center.wrap())}locationPoint(o){return this.projection.locationPoint(this,o)}locationPoint3D(o){return this.projection.locationPoint(this,o,!0)}pointLocation(o){return this.coordinateLocation(this.pointCoordinate(o))}pointLocation3D(o){return this.coordinateLocation(this.pointCoordinate3D(o))}locationCoordinate(o,c){const m=c?s.bH(c,o.lat):void 0,v=this.projection.project(o.lng,o.lat);return new s.aa(v.x,v.y,m)}coordinateLocation(o){return this.projection.unproject(o.x,o.y)}pointRayIntersection(o,c){const m=c??this._centerAltitude,v=[o.x,o.y,0,1],b=[o.x,o.y,1,1];s.ab.vec4.transformMat4(v,v,this.pixelMatrixInverse),s.ab.vec4.transformMat4(b,b,this.pixelMatrixInverse);const A=b[3];s.ab.vec4.scale(v,v,1/v[3]),s.ab.vec4.scale(b,b,1/A);const M=v[2],O=b[2];return{p0:v,p1:b,t:M===O?0:(m-M)/(O-M)}}screenPointToMercatorRay(o){const c=[o.x,o.y,0,1],m=[o.x,o.y,1,1];return s.ab.vec4.transformMat4(c,c,this.pixelMatrixInverse),s.ab.vec4.transformMat4(m,m,this.pixelMatrixInverse),s.ab.vec4.scale(c,c,1/c[3]),s.ab.vec4.scale(m,m,1/m[3]),c[2]=s.bH(c[2],this._center.lat)*this.worldSize,m[2]=s.bH(m[2],this._center.lat)*this.worldSize,s.ab.vec4.scale(c,c,1/this.worldSize),s.ab.vec4.scale(m,m,1/this.worldSize),new s.aq([c[0],c[1],c[2]],s.ab.vec3.normalize([],s.ab.vec3.sub([],m,c)))}rayIntersectionCoordinate(o){const{p0:c,p1:m,t:v}=o,b=s.bH(c[2],this._center.lat),A=s.bH(m[2],this._center.lat);return new s.aa(s.af(c[0],m[0],v)/this.worldSize,s.af(c[1],m[1],v)/this.worldSize,s.af(b,A,v))}pointCoordinate(o,c=this._centerAltitude){return this.projection.pointCoordinate(this,o.x,o.y,c)}pointCoordinate3D(o){if(!this.elevation)return this.pointCoordinate(o);let c=this.projection.pointCoordinate3D(this,o.x,o.y);if(c)return new s.aa(c[0],c[1],c[2]);let m=0,v=this.horizonLineFromTop();if(o.y>v)return this.pointCoordinate(o);const b=.02*v,A=o.clone();for(let M=0;M<10&&v-m>b;M++){A.y=s.af(m,v,.66);const O=this.projection.pointCoordinate3D(this,A.x,A.y);O?(v=A.y,c=O):m=A.y}return c?new s.aa(c[0],c[1],c[2]):this.pointCoordinate(o)}isPointAboveHorizon(o){return this.projection.isPointAboveHorizon(this,o)}isPointOnSurface(o){if(o.y<0||o.y>this.height||o.x<0||o.x>this.width)return!1;if(this.elevation||this.zoom>=s.bY)return!this.isPointAboveHorizon(o);const c=this.pointCoordinate(o);return c.y>=0&&c.y<=1}_coordinatePoint(o,c){const m=c&&this.elevation?this.elevation.getAtPointOrZero(o,this._centerAltitude):this._centerAltitude,v=[o.x*this.worldSize,o.y*this.worldSize,m+o.toAltitude(),1];return s.ab.vec4.transformMat4(v,v,this.pixelMatrix),v[3]>0?new s.P(v[0]/v[3],v[1]/v[3]):new s.P(Number.MAX_VALUE,Number.MAX_VALUE)}_getBoundsNonRectangular(){const{top:o,left:c}=this._edgeInsets,m=this.height-this._edgeInsets.bottom,v=this.width-this._edgeInsets.right,b=this.pointLocation3D(new s.P(c,o)),A=this.pointLocation3D(new s.P(v,o)),M=this.pointLocation3D(new s.P(v,m)),O=this.pointLocation3D(new s.P(c,m));let k=Math.min(b.lng,A.lng,M.lng,O.lng),L=Math.max(b.lng,A.lng,M.lng,O.lng),U=Math.min(b.lat,A.lat,M.lat,O.lat),j=Math.max(b.lat,A.lat,M.lat,O.lat);const $=Math.pow(2,-this.zoom)/16*270,Q=this.projection.name==="globe"?1:4,Z=(te,ee,ae,me,fe)=>{const Ae=(te+ae)/2,ve=(ee+me)/2,be=new s.P(Ae,ve),{lng:ye,lat:Ie}=this.pointLocation3D(be),Fe=Math.max(0,k-ye,U-Ie,ye-L,Ie-j);k=Math.min(k,ye),L=Math.max(L,ye),U=Math.min(U,Ie),j=Math.max(j,Ie),(fe<Q||Fe>$)&&(Z(te,ee,Ae,ve,fe+1),Z(Ae,ve,ae,me,fe+1))};if(Z(c,o,v,o,1),Z(v,o,v,m,1),Z(v,m,c,m,1),Z(c,m,c,o,1),this.projection.name==="globe"){const[te,ee]=s.bZ(this);te?(j=90,L=180,k=-180):ee&&(U=-90,L=180,k=-180)}return new s.az(new s.bO(k,U),new s.bO(L,j))}_getBoundsRectangular(o,c){const{top:m,left:v}=this._edgeInsets,b=this.height-this._edgeInsets.bottom,A=this.width-this._edgeInsets.right,M=new s.P(v,m),O=new s.P(A,m),k=new s.P(A,b),L=new s.P(v,b);let U=this.pointCoordinate(M,o),j=this.pointCoordinate(O,o);const $=this.pointCoordinate(k,c),Q=this.pointCoordinate(L,c),Z=(te,ee)=>(ee.y-te.y)/(ee.x-te.x);return U.y>1&&j.y>=0?U=new s.aa((1-Q.y)/Z(Q,U)+Q.x,1):U.y<0&&j.y<=1&&(U=new s.aa(-Q.y/Z(Q,U)+Q.x,0)),j.y>1&&U.y>=0?j=new s.aa((1-$.y)/Z($,j)+$.x,1):j.y<0&&U.y<=1&&(j=new s.aa(-$.y/Z($,j)+$.x,0)),new s.az().extend(this.coordinateLocation(U)).extend(this.coordinateLocation(j)).extend(this.coordinateLocation(Q)).extend(this.coordinateLocation($))}_getBoundsRectangularTerrain(){const o=this.elevation;if(!o.visibleDemTiles.length||o.isUsingMockSource())return this._getBoundsRectangular(0,0);const c=o.visibleDemTiles.reduce((m,v)=>{if(v.dem){const b=v.dem.tree;m.min=Math.min(m.min,b.minimums[0]),m.max=Math.max(m.max,b.maximums[0])}return m},{min:Number.MAX_VALUE,max:0});return this._getBoundsRectangular(c.min*o.exaggeration(),c.max*o.exaggeration())}getBounds(){return this.projection.name==="mercator"||this.projection.name==="equirectangular"?this._terrainEnabled()?this._getBoundsRectangularTerrain():this._getBoundsRectangular(0,0):this._getBoundsNonRectangular()}horizonLineFromTop(o=!0){const c=this.height/2/Math.tan(this._fov/2)/Math.tan(Math.max(this._pitch,.1))-this.centerOffset.y,m=this.height/2-c*(1-this._horizonShift);return o?Math.max(0,m):m}getMaxBounds(){return this.maxBounds}setMaxBounds(o){this.maxBounds=o,this.minLat=-s.bX,this.maxLat=s.bX,this.minLng=-180,this.maxLng=180,o&&(this.minLat=o.getSouth(),this.maxLat=o.getNorth(),this.minLng=o.getWest(),this.maxLng=o.getEast(),this.maxLng<this.minLng&&(this.maxLng+=360)),this.worldMinX=s.at(this.minLng)*this.tileSize,this.worldMaxX=s.at(this.maxLng)*this.tileSize,this.worldMinY=s.aA(this.maxLat)*this.tileSize,this.worldMaxY=s.aA(this.minLat)*this.tileSize,this._constrain()}calculatePosMatrix(o,c){return this.projection.createTileMatrix(this,c,o)}calculateDistanceTileData(o){const c=o.key,m=this._distanceTileDataCache;if(m[c])return m[c];const v=o.canonical,b=1/this.height,A=this.cameraWorldSize,M=A/this.zoomScale(v.z),O=(v.x+Math.pow(2,v.z)*o.wrap)*M,k=v.y*M,L=this.point;L.x*=A/this.worldSize,L.y*=A/this.worldSize;const U=this.angle,j=Math.sin(-U),$=-Math.cos(-U);return m[c]={bearing:[j,$],center:[(L.x-O)*b,(L.y-k)*b],scale:M/s.ag*b},m[c]}calculateFogTileMatrix(o){const c=o.key,m=this._fogTileMatrixCache;if(m[c])return m[c];const v=this.projection.createTileMatrix(this,this.cameraWorldSizeForFog,o);return s.ab.mat4.multiply(v,this.worldToFogMatrix,v),m[c]=new Float32Array(v),m[c]}calculateProjMatrix(o,c=!1,m=!1){const v=o.key;let b;if(b=m?this._expandedProjMatrixCache:c?this._alignedProjMatrixCache:this._projMatrixCache,b[v])return b[v];const A=this.calculatePosMatrix(o,this.worldSize);let M;return M=this.projection.isReprojectedInTileSpace?this.mercatorMatrix:m?this.expandedFarZProjMatrix:c?this.alignedProjMatrix:this.projMatrix,s.ab.mat4.multiply(A,M,A),b[v]=new Float32Array(A),b[v]}calculatePixelsToTileUnitsMatrix(o){const c=o.tileID.key,m=this._pixelsToTileUnitsCache;if(m[c])return m[c];const v=s.b_(o,this);return m[c]=v,m[c]}customLayerMatrix(){return this.mercatorMatrix.slice()}globeToMercatorMatrix(){if(this.projection.name==="globe"){const o=1/this.worldSize,c=s.ab.mat4.fromScaling([],[o,o,o]);return s.ab.mat4.multiply(c,c,this.globeMatrix),c}}recenterOnTerrain(){if(!this._elevation||this.projection.name==="globe")return;const o=this._elevation;this._updateCameraState();const c=s.bH(1,this._center.lat)*this.worldSize,m=this._computeCameraPosition(c),v=this._camera.forward(),b=s.bH(1,this._center.lat);m[2]/=b,v[2]/=b,s.ab.vec3.normalize(v,v);const A=o.raycast(m,v,o.exaggeration());if(A){const M=s.ab.vec3.scaleAndAdd([],m,v,A),O=new s.aa(M[0],M[1],s.bH(M[2],s.aS(M[1]))),k=(O.z+s.ab.vec3.length([O.x-m[0],O.y-m[1],O.z-m[2]*b]))*this._pixelsPerMercatorPixel;this._seaLevelZoom=this._zoomFromMercatorZ(k),this._centerAltitude=O.toAltitude(),this._center=this.coordinateLocation(O),this._updateZoomFromElevation(),this._constrain(),this._calcMatrices()}}_constrainCamera(o=!1){if(!this._elevation)return;const c=this._elevation,m=s.bH(1,this._center.lat)*this.worldSize,v=this._computeCameraPosition(m),b=c.getAtPointOrZero(new s.aa(...v)),A=this.pixelsPerMeter/this.worldSize*b,M=this._minimumHeightOverTerrain(),O=v[2]-A;if(O<=M)if(O<0||o){const k=this.locationCoordinate(this._center,this._centerAltitude),L=[v[0],v[1],k.z-v[2]],U=s.ab.vec3.length(L);L[2]-=(M-O)/this._pixelsPerMercatorPixel;const j=s.ab.vec3.length(L);if(j===0)return;s.ab.vec3.scale(L,L,U/j*this._pixelsPerMercatorPixel),this._camera.position=[v[0],v[1],k.z*this._pixelsPerMercatorPixel-L[2]],this._updateStateFromCamera()}else this._isCameraConstrained=!0}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;this._constraining=!0;const o=this.projection.name==="globe"||this.mercatorFromTransition;if(this.projection.isReprojectedInTileSpace||o){const j=this.center;return j.lat=s.aw(j.lat,this.minLat,this.maxLat),(this.maxBounds||!this.renderWorldCopies&&!o)&&(j.lng=s.aw(j.lng,this.minLng,this.maxLng)),this.center=j,void(this._constraining=!1)}const c=this._unmodified,{x:m,y:v}=this.point;let b=0,A=m,M=v;const O=this.width/2,k=this.height/2,L=this.worldMinY*this.scale,U=this.worldMaxY*this.scale;if(v-k<L&&(M=L+k),v+k>U&&(M=U-k),U-L<this.height&&(b=Math.max(b,this.height/(U-L)),M=(U+L)/2),this.maxBounds||!this._renderWorldCopies||!this.projection.wrap){const j=this.worldMinX*this.scale,$=this.worldMaxX*this.scale,Q=this.worldSize/2-(j+$)/2;A=(m+Q+this.worldSize)%this.worldSize-Q,A-O<j&&(A=j+O),A+O>$&&(A=$-O),$-j<this.width&&(b=Math.max(b,this.width/($-j)),A=($+j)/2)}A===m&&M===v||(this.center=this.unproject(new s.P(A,M))),b&&(this.zoom+=this.scaleZoom(b)),this._constrainCamera(),this._unmodified=c,this._constraining=!1}_minZoomForBounds(){let o=Math.max(0,this.scaleZoom(this.height/(this.worldMaxY-this.worldMinY)));return this.maxBounds&&(o=Math.max(o,this.scaleZoom(this.width/(this.worldMaxX-this.worldMinX)))),o}_maxCameraBoundsDistance(){return this._mercatorZfromZoom(this._minZoomForBounds())}_calcMatrices(){if(!this.height)return;const o=this.centerOffset,c=this.projection.name==="globe",m=this.pixelsPerMeter;this.projection.name==="globe"&&(this._mercatorScaleRatio=s.bH(1,this.center.lat)/s.bH(1,s.c8));const v=s.b$(this.projection,this.zoom,this.width,this.height,1024);this._pixelsPerMercatorPixel=this.projection.pixelSpaceConversion(this.center.lat,this.worldSize,v),this.cameraToCenterDistance=.5/Math.tan(.5*this._fov)*this.height*this._pixelsPerMercatorPixel,this._updateCameraState(),this._farZ=this.projection.farthestPixelDistance(this),this._nearZ=this.height/50;const b=this.projection.zAxisUnit==="meters"?m:1,A=this._camera.getWorldToCamera(this.worldSize,b);let M;const O=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,this._farZ);if(O[8]=2*-o.x/this.width,O[9]=2*o.y/this.height,this.isOrthographic){let Ie=.5*this.height/Math.tan(this._fov/2)*1*Math.tan(.5*this._fov),Fe=Ie*this.aspect,Qe=-Fe,We=-Ie;Fe-=o.x,Qe-=o.x,Ie+=o.y,We+=o.y,M=this._camera.getCameraToClipOrthographic(Qe,Fe,We,Ie,this._nearZ,this._farZ),((at,nt,je,et)=>{for(let gt=0;gt<16;gt++)at[gt]=Xd(nt[gt],je[gt],et)})(M,M,O,Ju(this.pitch>=15?1:this.pitch/15))}else M=O;const k=s.ab.mat4.mul([],O,A);let L=s.ab.mat4.mul([],M,A);if(this.projection.isReprojectedInTileSpace){const Ie=this.locationCoordinate(this.center),Fe=s.ab.mat4.identity([]);s.ab.mat4.translate(Fe,Fe,[Ie.x*this.worldSize,Ie.y*this.worldSize,0]),s.ab.mat4.multiply(Fe,Fe,s.c0(this)),s.ab.mat4.translate(Fe,Fe,[-Ie.x*this.worldSize,-Ie.y*this.worldSize,0]),s.ab.mat4.multiply(L,L,Fe),s.ab.mat4.multiply(k,k,Fe),this.inverseAdjustmentMatrix=s.c1(this)}else this.inverseAdjustmentMatrix=[1,0,0,1];if(this.mercatorMatrix=s.ab.mat4.scale([],L,[this.worldSize,this.worldSize,this.worldSize/b,1]),this.projMatrix=L,this.invProjMatrix=s.ab.mat4.invert(new Float64Array(16),this.projMatrix),c){const Ie=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,1/0);Ie[8]=2*-o.x/this.width,Ie[9]=2*o.y/this.height,this.expandedFarZProjMatrix=s.ab.mat4.mul([],Ie,A)}else this.expandedFarZProjMatrix=this.projMatrix;const U=s.ab.mat4.invert([],M);this.frustumCorners=s.c2.fromInvProjectionMatrix(U,this.horizonLineFromTop(),this.height),this.cameraFrustum=s.bR.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,0,!c);const j=new Float32Array(16);s.ab.mat4.identity(j),s.ab.mat4.scale(j,j,[1,-1,1]),s.ab.mat4.rotateX(j,j,this._pitch),s.ab.mat4.rotateZ(j,j,this.angle);const $=s.ab.mat4.perspective(new Float32Array(16),this._fov,this.width/this.height,this._nearZ,this._farZ);this.starsProjMatrix=s.ab.mat4.clone($);const Q=(Math.PI/2-this._pitch)*(this.height/this._fov)*this._horizonShift;$[8]=2*-o.x/this.width,$[9]=2*(o.y+Q)/this.height,this.skyboxMatrix=s.ab.mat4.multiply(j,$,j);const Z=this.point,te=Z.x,ee=Z.y,ae=this.width%2/2,me=this.height%2/2,fe=Math.cos(this.angle),Ae=Math.sin(this.angle),ve=te-Math.round(te)+fe*ae+Ae*me,be=ee-Math.round(ee)+fe*me+Ae*ae,ye=new Float64Array(L);if(s.ab.mat4.translate(ye,ye,[ve>.5?ve-1:ve,be>.5?be-1:be,0]),this.alignedProjMatrix=ye,L=s.ab.mat4.create(),s.ab.mat4.scale(L,L,[this.width/2,-this.height/2,1]),s.ab.mat4.translate(L,L,[1,-1,0]),this.labelPlaneMatrix=L,L=s.ab.mat4.create(),s.ab.mat4.scale(L,L,[1,-1,1]),s.ab.mat4.translate(L,L,[-1,-1,0]),s.ab.mat4.scale(L,L,[2/this.width,2/this.height,1]),this.glCoordMatrix=L,this.pixelMatrix=s.ab.mat4.multiply(new Float64Array(16),this.labelPlaneMatrix,k),this._calcFogMatrices(),this._distanceTileDataCache={},L=s.ab.mat4.invert(new Float64Array(16),this.pixelMatrix),!L)throw new Error("failed to invert matrix");if(this.pixelMatrixInverse=L,this.projection.name==="globe"||this.mercatorFromTransition){this.globeMatrix=s.c3(this);const Ie=[this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]];this.globeCenterInViewSpace=s.ab.vec3.transformMat4(Ie,Ie,A),this.globeRadius=this.worldSize/2/Math.PI-1}else this.globeMatrix=L;this._projMatrixCache={},this._alignedProjMatrixCache={},this._pixelsToTileUnitsCache={},this._expandedProjMatrixCache={}}_calcFogMatrices(){this._fogTileMatrixCache={};const o=this.cameraWorldSizeForFog,c=this.cameraPixelsPerMeter,m=this._camera.position,v=1/this.height/this._pixelsPerMercatorPixel,b=[o,o,c];s.ab.vec3.scale(b,b,v),s.ab.vec3.scale(m,m,-1),s.ab.vec3.multiply(m,m,b);const A=s.ab.mat4.create();s.ab.mat4.translate(A,A,m),s.ab.mat4.scale(A,A,b),this.mercatorFogMatrix=A,this.worldToFogMatrix=this._camera.getWorldToCameraPosition(o,c,v)}_computeCameraPosition(o){const c=(o=o||this.pixelsPerMeter)/this.pixelsPerMeter,m=this._camera.forward(),v=this.point,b=this._mercatorZfromZoom(this._seaLevelZoom?this._seaLevelZoom:this._zoom)*c-o/this.worldSize*this._centerAltitude;return[v.x/this.worldSize-m[0]*b,v.y/this.worldSize-m[1]*b,o/this.worldSize*this._centerAltitude-m[2]*b]}_updateCameraState(){this.height&&(this._camera.setPitchBearing(this._pitch,this.angle),this._camera.position=this._computeCameraPosition())}_translateCameraConstrained(o){const c=this._maxCameraBoundsDistance()*Math.cos(this._pitch),m=this._camera.position[2],v=o[2];let b=1;this.projection.wrap&&(this.center=this.center.wrap()),v>0&&(b=Math.min((c-m)/v,1)),this._camera.position=s.ab.vec3.scaleAndAdd([],this._camera.position,o,b),this._updateStateFromCamera()}_updateStateFromCamera(){const o=this._camera.position,c=this._camera.forward(),{pitch:m,bearing:v}=this._camera.getPitchBearing(),b=s.bH(this._centerAltitude,this.center.lat)*this._pixelsPerMercatorPixel,A=this._mercatorZfromZoom(this._maxZoom)*Math.cos(s.ai(this._maxPitch)),M=Math.max((o[2]-b)/Math.cos(m),A),O=this._zoomFromMercatorZ(M);s.ab.vec3.scaleAndAdd(o,o,c,M),this._pitch=s.aw(m,s.ai(this.minPitch),s.ai(this.maxPitch)),this.angle=s.bF(v,-Math.PI,Math.PI),this._setZoom(s.aw(O,this._minZoom,this._maxZoom)),this._updateSeaLevelZoom(),this._center=this.coordinateLocation(new s.aa(o[0],o[1],o[2])),this._unmodified=!1,this._constrain(),this._calcMatrices()}_worldSizeFromZoom(o){return Math.pow(2,o)*this.tileSize}_mercatorZfromZoom(o){return this.cameraToCenterDistance/this._worldSizeFromZoom(o)}_minimumHeightOverTerrain(){const o=Math.min(this._seaLevelZoom!=null?this._seaLevelZoom:this._zoom,this._maxZoom)+4;return this._mercatorZfromZoom(o)}_zoomFromMercatorZ(o){return this.scaleZoom(this.cameraToCenterDistance/(o*this.tileSize))}zoomFromMercatorZAdjusted(o){let c=0,m=s.bY,v=0,b=1/0;for(;m-c>1e-6&&m>c;){const A=c+.5*(m-c),M=this.tileSize*Math.pow(2,A),O=this.getCameraToCenterDistance(this.projection,A,M),k=this.scaleZoom(O/(o*this.tileSize)),L=Math.abs(A-k);L<b&&(b=L,v=A),A<k?c=A:m=A}return v}_terrainEnabled(){return!(!this._elevation||!this.projection.supportsTerrain&&(s.w("Terrain is not yet supported with alternate projections. Use mercator or globe to enable terrain."),1))}anyCornerOffEdge(o,c){const m=Math.min(o.x,c.x),v=Math.max(o.x,c.x),b=Math.min(o.y,c.y),A=Math.max(o.y,c.y);if(b<this.horizonLineFromTop(!1))return!0;if(this.projection.name!=="mercator")return!1;const M=[new s.P(m,b),new s.P(v,A),new s.P(m,A),new s.P(v,b)],O=this.renderWorldCopies?-3:0,k=this.renderWorldCopies?4:1;for(const L of M){const U=this.pointRayIntersection(L);if(U.t<0)return!0;const j=this.rayIntersectionCoordinate(U);if(j.x<O||j.y<0||j.x>k||j.y>1)return!0}return!1}isHorizonVisible(){return this.pitch+s.c4(this.fovAboveCenter)>88||this.anyCornerOffEdge(new s.P(0,0),new s.P(this.width,this.height))}zoomDeltaToMovement(o,c){const m=s.ab.vec3.length(s.ab.vec3.sub([],this._camera.position,o)),v=this._zoomFromMercatorZ(m)+c;return m-this._mercatorZfromZoom(v)}getCameraPoint(){if(this.projection.name==="globe"){const o=function([c,m,v],b){const A=[c,m,v,1];s.ab.vec4.transformMat4(A,A,b);const M=A[3]=Math.max(A[3],1e-6);return A[0]/=M,A[1]/=M,A[2]/=M,A}([this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]],this.pixelMatrix);return new s.P(o[0],o[1])}{const o=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new s.P(0,o))}}getCameraToCenterDistance(o,c=this.zoom,m=this.worldSize){const v=s.b$(o,c,this.width,this.height,1024),b=o.pixelSpaceConversion(this.center.lat,m,v);let A=.5/Math.tan(.5*this._fov)*this.height*b;return this.isOrthographic&&(A=Xd(1,A,Ju(this.pitch>=15?1:this.pitch/15))),A}getWorldToCameraMatrix(){const o=this._camera.getWorldToCamera(this.worldSize,this.projection.zAxisUnit==="meters"?this.pixelsPerMeter:1);return this.projection.name==="globe"&&s.ab.mat4.multiply(o,o,this.globeMatrix),o}getFrustum(o){return s.bR.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,o,this.projection.zAxisUnit==="meters")}}const ta=(p,o)=>{if(o>0&&p.terrain&&s.w("Cutoff is currently disabled on terrain"),o<=0||p.terrain)return{shouldRenderCutoff:!1,uniformValues:{u_cutoff_params:[0,0,0,1]}};const c=p.transform,m=Math.max(Math.abs(c._zoom-(p.minCutoffZoom-1)),1),v=c.isLODDisabled(!1)?s.ac(60,45,c.pitch):s.ac(30,15,c.pitch),b=c._farZ-c._nearZ,A=o*c.height,M=((1-(O=v))*c.cameraToCenterDistance+O*(c._farZ+A))*m;var O;return{shouldRenderCutoff:v<1,uniformValues:{u_cutoff_params:[c._nearZ,c._farZ,(M-c._nearZ)/b,(M-A-c._nearZ)/b]}}},sn={cascadeCount:2,normalOffset:3,shadowMapResolution:2048};class Po{constructor(o,c){this.aabb=o,this.lastCascade=c}}class Zd{add(o,c){const m=this.receivers[o.key];m!==void 0?(m.aabb.min[0]=Math.min(m.aabb.min[0],c.min[0]),m.aabb.min[1]=Math.min(m.aabb.min[1],c.min[1]),m.aabb.min[2]=Math.min(m.aabb.min[2],c.min[2]),m.aabb.max[0]=Math.max(m.aabb.max[0],c.max[0]),m.aabb.max[1]=Math.max(m.aabb.max[1],c.max[1]),m.aabb.max[2]=Math.max(m.aabb.max[2],c.max[2])):this.receivers[o.key]=new Po(c,null)}clear(){this.receivers={}}get(o){return this.receivers[o.key]}computeRequiredCascades(o,c,m){const v=s.cd.fromPoints(o.points);let b=0;for(const A in this.receivers){const M=this.receivers[A];if(!M||!v.intersectsAabb(M.aabb))continue;M.aabb.min=v.closestPoint(M.aabb.min),M.aabb.max=v.closestPoint(M.aabb.max);const O=M.aabb.getCorners();for(let k=0;k<m.length;k++){let L=!0;for(const U of O){const j=[U[0]*c,U[1]*c,U[2]];if(s.ab.vec3.transformMat4(j,j,m[k].matrix),j[0]<-1||j[0]>1||j[1]<-1||j[1]>1){L=!1;break}}if(M.lastCascade=k,b=Math.max(b,k),L)break}}return b+1}}class Ma{constructor(o){this.painter=o,this._enabled=!1,this._shadowLayerCount=0,this._numCascadesToRender=0,this._cascades=[],this._groundShadowTiles=[],this._receivers=new Zd,this._depthMode=new Yt(o.context.gl.LEQUAL,Yt.ReadWrite,[0,1]),this._uniformValues={u_light_matrix_0:new Float32Array(16),u_light_matrix_1:new Float32Array(16),u_shadow_intensity:0,u_fade_range:[0,0],u_shadow_normal_offset:[1,1,1],u_shadow_texel_size:1,u_shadow_map_resolution:1,u_shadow_direction:[0,0,1],u_shadow_bias:[36e-5,.0012,.012],u_shadowmap_0:0,u_shadowmap_1:0},this._forceDisable=!1,this.useNormalOffset=!1,o.tp.registerParameter(this,["Shadows"],"_forceDisable",{label:"forceDisable"},()=>{this.painter.style.map.triggerRepaint()}),o.tp.registerParameter(sn,["Shadows"],"cascadeCount",{min:1,max:2,step:1}),o.tp.registerParameter(sn,["Shadows"],"normalOffset",{min:0,max:10,step:.05}),o.tp.registerParameter(sn,["Shadows"],"shadowMapResolution",{min:32,max:2048,step:32}),o.tp.registerBinding(this,["Shadows"],"_numCascadesToRender",{readonly:!0,label:"numCascadesToRender"})}destroy(){for(const o of this._cascades)o.texture.destroy(),o.framebuffer.destroy();this._cascades=[]}updateShadowParameters(o,c){const m=this.painter;if(this._enabled=!1,this._shadowLayerCount=0,this._receivers.clear(),!c||!c.properties)return;const v=c.properties.get("shadow-intensity");if(!c.shadowsEnabled()||v<=0||(this._shadowLayerCount=m.style.order.reduce((Q,Z)=>{const te=m.style._mergedLayers[Z];return Q+(te.hasShadowPass()&&!te.isHidden(o.zoom)?1:0)},0),this._enabled=this._shadowLayerCount>0,!this.enabled))return;const b=m.context,A=sn.shadowMapResolution,M=sn.shadowMapResolution;if(this._cascades.length===0||sn.shadowMapResolution!==this._cascades[0].texture.size[0]){this._cascades=[];for(let Q=0;Q<sn.cascadeCount;++Q){const Z=m._shadowMapDebug,te=b.gl,ee=b.createFramebuffer(A,M,Z,"texture"),ae=new s.T(b,{width:A,height:M,data:null},te.DEPTH_COMPONENT16);if(ee.depthAttachment.set(ae.texture),Z){const me=new s.T(b,{width:A,height:M,data:null},te.RGBA8);ee.colorAttachment.set(me.texture)}this._cascades.push({framebuffer:ee,texture:ae,matrix:[],far:0,boundingSphereRadius:0,frustum:new s.bR,scale:0})}}this.shadowDirection=Pa(c);let O=0;if(o.elevation){const Q=o.elevation,Z=[1e4,-1e4];Q.visibleDemTiles.filter(te=>te.dem).forEach(te=>{const ee=te.dem.tree;Z[0]=Math.min(Z[0],ee.minimums[0]),Z[1]=Math.max(Z[1],ee.maximums[0])}),Z[0]!==1e4&&(O=(Z[1]-Z[0])*Q.exaggeration())}const k=1.5*o.cameraToCenterDistance,L=3*k,U=new Float64Array(16);for(let Q=0;Q<this._cascades.length;++Q){const Z=this._cascades[Q];let te=o.height/50,ee=1;sn.cascadeCount===1?ee=L:Q===0?ee=k:(te=k,ee=L);const[ae,me]=D0(o,this.shadowDirection,te,ee,sn.shadowMapResolution,O);Z.scale=o.scale,Z.matrix=ae,Z.boundingSphereRadius=me,s.ab.mat4.invert(U,Z.matrix),Z.frustum=s.bR.fromInvProjectionMatrix(U,1,0,!0),Z.far=ee}const j=this._cascades.length-1;this._uniformValues.u_fade_range=[.75*this._cascades[j].far,this._cascades[j].far],this._uniformValues.u_shadow_intensity=v,this._uniformValues.u_shadow_direction=[this.shadowDirection[0],this.shadowDirection[1],this.shadowDirection[2]],this._uniformValues.u_shadow_texel_size=1/sn.shadowMapResolution,this._uniformValues.u_shadow_map_resolution=sn.shadowMapResolution,this._uniformValues.u_shadowmap_0=un.ShadowMap0,this._uniformValues.u_shadowmap_1=un.ShadowMap0+1,this._groundShadowTiles=m.transform.coveringTiles({tileSize:512,renderWorldCopies:!0});const $=m.transform.elevation;for(const Q of this._groundShadowTiles){let Z={min:0,max:0};if($){const te=$.getMinMaxForTile(Q);te&&(Z=te)}this.addShadowReceiver(Q.toUnwrapped(),Z.min,Z.max)}}get enabled(){return this._enabled&&!this._forceDisable}set enabled(o){this._enabled=o}drawShadowPass(o,c){if(!this.enabled)return;const m=this.painter,v=m.context;this._numCascadesToRender=this._receivers.computeRequiredCascades(m.transform.getFrustum(0),m.transform.worldSize,this._cascades),v.viewport.set([0,0,sn.shadowMapResolution,sn.shadowMapResolution]);for(let b=0;b<this._numCascadesToRender;++b){m.currentShadowCascade=b,v.bindFramebuffer.set(this._cascades[b].framebuffer.framebuffer),v.clear({color:s.aj.white,depth:1});for(const A of o.order){const M=o._mergedLayers[A];if(!M.hasShadowPass()||M.isHidden(m.transform.zoom))continue;const O=o.getLayerSourceCache(M),k=O?c[O.id]:void 0;(M.type==="model"||k&&k.length)&&m.renderLayer(m,O,M,k)}}m.currentShadowCascade=0}drawGroundShadows(){if(!this.enabled)return;const o=this.painter,c=o.style,m=o.context,v=c.directionalLight,b=c.ambientLight;if(!v||!b)return;const A=[],M=ta(o,o.longestCutoffRange);M.shouldRenderCutoff&&A.push("RENDER_CUTOFF"),A.push("RENDER_SHADOWS","DEPTH_TEXTURE"),this.useNormalOffset&&A.push("NORMAL_OFFSET");const O=Yd(c,v,b),k=new Yt(m.gl.LEQUAL,Yt.ReadOnly,o.depthRangeFor3D);for(const L of this._groundShadowTiles){const U=L.toUnwrapped(),j=o.isTileAffectedByFog(L),$=o.getOrCreateProgram("groundShadow",{defines:A,overrideFog:j});this.setupShadows(U,$),o.uploadCommonUniforms(m,$,U,null,M);const Q={u_matrix:o.transform.calculateProjMatrix(U),u_ground_shadow_factor:O};$.draw(o,m.gl.TRIANGLES,k,oi.disabled,xi.multiply,li.disabled,Q,"ground_shadow",o.tileExtentBuffer,o.quadTriangleIndexBuffer,o.tileExtentSegments,{},o.transform.zoom,null,null)}}getShadowPassColorMode(){return this.painter._shadowMapDebug?xi.unblended:xi.disabled}getShadowPassDepthMode(){return this._depthMode}getShadowCastingLayerCount(){return this._shadowLayerCount}calculateShadowPassMatrixFromTile(o){const c=this.painter.transform,m=c.calculatePosMatrix(o,c.worldSize);return s.ab.mat4.multiply(m,this._cascades[this.painter.currentShadowCascade].matrix,m),Float32Array.from(m)}calculateShadowPassMatrixFromMatrix(o){return s.ab.mat4.multiply(o,this._cascades[this.painter.currentShadowCascade].matrix,o),Float32Array.from(o)}setupShadows(o,c,m,v=0){if(!this.enabled)return;const b=this.painter.transform,A=this.painter.context,M=A.gl,O=this._uniformValues,k=new Float64Array(16),L=b.calculatePosMatrix(o,b.worldSize);for(let U=0;U<this._cascades.length;U++)s.ab.mat4.multiply(k,this._cascades[U].matrix,L),O[U===0?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(k),A.activeTexture.set(M.TEXTURE0+un.ShadowMap0+U),this._cascades[U].texture.bind(M.NEAREST,M.CLAMP_TO_EDGE);if(this.useNormalOffset=!!m,this.useNormalOffset){const U=s.cc(o.canonical),j=2/b.tileSize*s.ag/sn.shadowMapResolution,$=j*this._cascades[0].boundingSphereRadius,Q=j*this._cascades[this._cascades.length-1].boundingSphereRadius,Z=(m==="vector-tile"?1:3)/Math.pow(2,v-o.canonical.z-(1-b.zoom+Math.floor(b.zoom)));O.u_shadow_normal_offset=[U,$*Z,Q*Z],O.u_shadow_bias=[6e-5,.0012,.012]}else O.u_shadow_bias=[36e-5,.0012,.012];c.setShadowUniformValues(A,O)}setupShadowsFromMatrix(o,c,m=!1){if(!this.enabled)return;const v=this.painter.context,b=v.gl,A=this._uniformValues,M=new Float64Array(16);for(let O=0;O<sn.cascadeCount;O++)s.ab.mat4.multiply(M,this._cascades[O].matrix,o),A[O===0?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(M),v.activeTexture.set(b.TEXTURE0+un.ShadowMap0+O),this._cascades[O].texture.bind(b.NEAREST,b.CLAMP_TO_EDGE);if(this.useNormalOffset=m,m){const O=sn.normalOffset;A.u_shadow_normal_offset=[1,O,O],A.u_shadow_bias=[6e-5,.0012,.012]}else A.u_shadow_bias=[36e-5,.0012,.012];c.setShadowUniformValues(v,A)}getShadowUniformValues(){return this._uniformValues}getCurrentCascadeFrustum(){return this._cascades[this.painter.currentShadowCascade].frustum}computeSimplifiedTileShadowVolume(o,c,m,v){if(v[2]>=0)return{};const b=function(O,k,L){const U=L/(1<<O.canonical.z);return new s.cd([O.canonical.x*U+O.wrap*L,O.canonical.y*U+O.wrap*L,0],[(O.canonical.x+1)*U+O.wrap*L,(O.canonical.y+1)*U+O.wrap*L,k])}(o,c,m).getCorners(),A=c/-v[2];v[0]<0?(s.ab.vec3.add(b[0],b[0],[v[0]*A,0,0]),s.ab.vec3.add(b[3],b[3],[v[0]*A,0,0])):v[0]>0&&(s.ab.vec3.add(b[1],b[1],[v[0]*A,0,0]),s.ab.vec3.add(b[2],b[2],[v[0]*A,0,0])),v[1]<0?(s.ab.vec3.add(b[0],b[0],[0,v[1]*A,0]),s.ab.vec3.add(b[1],b[1],[0,v[1]*A,0])):v[1]>0&&(s.ab.vec3.add(b[2],b[2],[0,v[1]*A,0]),s.ab.vec3.add(b[3],b[3],[0,v[1]*A,0]));const M={};return M.vertices=b,M.planes=[Ra(b[1],b[0],b[4]),Ra(b[2],b[1],b[5]),Ra(b[3],b[2],b[6]),Ra(b[0],b[3],b[7])],M}addShadowReceiver(o,c,m){this._receivers.add(o,s.cd.fromTileIdAndHeight(o,c,m))}getMaxCascadeForTile(o){const c=this._receivers.get(o);return c&&c.lastCascade?c.lastCascade:0}}function Ra(p,o,c){const m=s.ab.vec3.sub([],c,o),v=s.ab.vec3.sub([],p,o),b=s.ab.vec3.cross([],m,v),A=s.ab.vec3.length(b);return A===0?[0,0,1,0]:(s.ab.vec3.scale(b,b,1/A),[b[0],b[1],b[2],-s.ab.vec3.dot(b,o)])}function Pa(p){const o=p.properties.get("direction"),c=s.cb(o.x,o.y,o.z);c[2]=s.aw(c[2],0,75);const m=s.ce([c[0],c[1],c[2]]);return s.ab.vec3.fromValues(m.x,m.y,m.z)}function Yd(p,o,c){const m=o.properties.get("color-use-theme")==="none",v=o.properties.get("color"),b=o.properties.get("intensity"),A=o.properties.get("direction"),M=[A.x,A.y,A.z],O=c.properties.get("color-use-theme")==="none",k=c.properties.get("color"),L=c.properties.get("intensity"),U=Math.max(s.ab.vec3.dot([0,0,1],M),0),j=[0,0,0];s.ab.vec3.scale(j,k.toRenderColor(O?null:p.getLut(o.scope)).toArray01Linear().slice(0,3),L);const $=[0,0,0];return s.ab.vec3.scale($,v.toRenderColor(m?null:p.getLut(c.scope)).toArray01Linear().slice(0,3),U*b),s.cf([j[0]>0?j[0]/(j[0]+$[0]):0,j[1]>0?j[1]/(j[1]+$[1]):0,j[2]>0?j[2]/(j[2]+$[2]):0])}function D0(p,o,c,m,v,b){const A=p.zoom,M=p.scale,O=p.worldSize,k=1/O,L=p.aspect,U=Math.sqrt(1+L*L)*Math.tan(.5*p.fovX),j=U*U,$=m-c,Q=m+c;let Z,te;j>$/Q?(Z=m,te=m*U):(Z=.5*Q*(1+j),te=.5*Math.sqrt($*$+2*(m*m+c*c)*j+Q*Q*j*j));const ee=p.projection.pixelsPerMeter(p.center.lat,O),ae=p._camera.getCameraToWorldMercator(),me=[0,0,-Z*k];s.ab.vec3.transformMat4(me,me,ae);let fe=te*k;const Ae=p._edgeInsets;if(!(Ae.left===0&&Ae.top===0&&Ae.right===0&&Ae.bottom===0||Ae.left===Ae.right&&Ae.top===Ae.bottom)){const Et=p._camera.getWorldToCamera(p.worldSize,p.projection.zAxisUnit==="meters"?ee:1),ft=p._camera.getCameraToClipPerspective(p._fov,p.width/p.height,c,m);ft[8]=2*-p.centerOffset.x/p.width,ft[9]=2*p.centerOffset.y/p.height;const ct=new Float64Array(16);s.ab.mat4.mul(ct,ft,Et);const xt=new Float64Array(16);s.ab.mat4.invert(xt,ct);const Tt=s.bR.fromInvProjectionMatrix(xt,O,A,!0);for(const Lt of Tt.points){const Ut=((ve=Lt)[0]/=M,ve[1]/=M,ve[2]=s.bH(ve[2],p._center.lat),ve);fe=Math.max(fe,s.ab.vec3.len(s.ab.vec3.subtract([],me,Ut)))}}var ve;fe*=v/(v-1);const be=Math.acos(o[2]),ye=Math.atan2(-o[0],-o[1]),Ie=new Vn;Ie.position=me,Ie.setPitchBearing(be,ye);const Fe=Ie.getWorldToCamera(O,ee),Qe=fe*O,We=Math.min(p._mercatorZfromZoom(17)*O*-2,-2*Qe),at=Ie.getCameraToClipOrthographic(-Qe,Qe,-Qe,Qe,We,(Qe+b*ee)/o[2]),nt=new Float64Array(16);s.ab.mat4.multiply(nt,at,Fe);const je=s.ab.vec3.fromValues(Math.floor(1e6*me[0])/1e6*O,Math.floor(1e6*me[1])/1e6*O,0),et=.5*v,gt=[0,0,0];s.ab.vec3.transformMat4(gt,je,nt),s.ab.vec3.scale(gt,gt,et);const Ve=[Math.floor(gt[0]),Math.floor(gt[1]),Math.floor(gt[2])],ut=[0,0,0];s.ab.vec3.sub(ut,gt,Ve),s.ab.vec3.scale(ut,ut,-1/et);const tt=new Float64Array(16);return s.ab.mat4.identity(tt),s.ab.mat4.translate(tt,tt,ut),s.ab.mat4.multiply(nt,tt,nt),[nt,Qe]}class Kd extends s.E{constructor(o){super(),this.requestManager=o,this.models={"":{}},this.modelUris={"":{}},this.numModelsLoading={}}loadModel(o,c){return s.aM(this.requestManager.transformRequest(c,s.R.Model).url).then(m=>{if(!m)return;const v=s.aN(m),b=new s.aO(o,void 0,void 0,v);return b.computeBoundsAndApplyParent(),b}).catch(m=>{if(m&&m.status===404)return null;this.fire(new s.y(new Error(`Could not load model ${o} from ${c}: ${m.message}`)))})}load(o,c,m={keepNumReferences:!1}){this.models[c]||(this.models[c]={});const v=Object.keys(o);this.numModelsLoading[c]=(this.numModelsLoading[c]||0)+v.length;const b=[];for(const A of v)b.push(this.loadModel(A,o[A]));Promise.allSettled(b).then(A=>{for(let M=0;M<A.length;M++){const{status:O,value:k}=A[M];if(O==="fulfilled"&&k){const L=this.models[c][v[M]];this.models[c][v[M]]={model:k,numReferences:m.keepNumReferences&&L?L.numReferences:1}}}this.numModelsLoading[c]-=v.length,this.fire(new s.z("data",{dataType:"style"}))}).catch(A=>{this.fire(new s.y(new Error(`Could not load models: ${A.message}`)))})}isLoaded(){for(const o in this.numModelsLoading)if(this.numModelsLoading[o]>0)return!1;return!0}hasModel(o,c){return!!this.getModel(o,c)}getModel(o,c){return this.models[c]||(this.models[c]={}),this.models[c][o]?this.models[c][o].model:void 0}addModel(o,c,m){this.models[m]||(this.models[m]={}),this.modelUris[m]||(this.modelUris[m]={}),this.hasModel(o,m)&&this.models[m][o].numReferences++,this.modelUris[m][o]=this.requestManager.normalizeModelURL(c),this.load({[o]:this.modelUris[m][o]},m)}addModels(o,c){this.models[c]||(this.models[c]={}),this.modelUris[c]||(this.modelUris[c]={});const m=this.modelUris[c];for(const v in o)this.models[c][v]={},m[v]=this.requestManager.normalizeModelURL(o[v]);this.load(m,c,{keepNumReferences:!0})}reloadModels(o){this.load(this.modelUris[o],o)}addModelsFromBucket(o,c){this.models[c]||(this.models[c]={}),this.modelUris[c]||(this.modelUris[c]={});const m={};for(const v of o)this.hasModel(v,c)?this.models[c][v].numReferences++:(this.modelUris[c][v]=this.requestManager.normalizeModelURL(v),m[v]=this.modelUris[c][v]);this.load(m,c)}removeModel(o,c){if(this.models[c]&&this.models[c][o]&&(this.models[c][o].numReferences--,this.models[c][o].numReferences===0)){const m=this.models[c][o].model;delete this.models[c][o],delete this.modelUris[c][o],m.destroy()}}listModels(o){return this.models[o]||(this.models[o]={}),Object.keys(this.models[o])}upload(o,c){this.models[c]||(this.models[c]={});for(const m in this.models[c])this.models[c][m].model&&this.models[c][m].model.upload(o.context)}}const O0=new s.a5({data:new s.a6(s.a3.colorTheme.data)}),Hm={"mbx-indoor-active-floorplans":{default:["literal",[]]},"mbx-indoor-underground":{default:["literal",!1]},"mbx-indoor-loaded-levels":{default:["literal",[]]},"mbx-indoor-level-height":{default:["literal",{}]},"mbx-indoor-level-base":{default:["literal",{}]},"mbx-indoor-level-selected":{default:["literal",{}]},"mbx-indoor-level-overlapped":{default:["literal",{}]}};function Jd(p){return p=p||{},Object.assign(p,Hm)}class Qd extends s.E{constructor(o){super(),this.mergeFloors=!0,this._scope=void 0,this._queryFeatureSetId=void 0,this._buildingEntryFeatureSetId=void 0,this._selectedFloorplan=void 0,this._indoorData=void 0,this._selectedLevel=void 0,this._floorplanStates={},s.aP(["_onLoad","_onMove","_checkFloorplanVisible"],this),this._map=o,this._checkFloorplanVisible(!0),this._map.on("load",this._onLoad),this._map.on("move",this._onMove)}destroy(){this._map.indoor.off("load",this._onLoad),this._map.indoor.off("move",this._onMove),this._map=void 0}_onLoad(){this._map.style.forEachFragmentStyle(o=>{o.stylesheet.indoor&&(this._queryFeatureSetId?this.fire(new s.y(new Error("Multiple indoor map styles detected, simultaneous usage is not allowed currently."))):(this._queryFeatureSetId=o.stylesheet.indoor.floorplanFeaturesetId,this._buildingEntryFeatureSetId=o.stylesheet.indoor.buildingFeaturesetId,this._scope=o.scope))}),this._queryFeatureSetId&&this._buildingEntryFeatureSetId&&this._map.addInteraction("mbx-indoor-buildingclick",{type:"click",target:{featuresetId:this._buildingEntryFeatureSetId,importId:this._scope},handler:o=>(o.feature&&o.feature.properties.floorplan&&this.selectFloorplan(o.feature.properties.floorplan),!0)}),this._checkFloorplanVisible(!0)}_onMove(){this._checkFloorplanVisible(!1)}_checkFloorplanVisible(o){if(!this._queryFeatureSetId||!this._map.isStyleLoaded()||this._map.transform.zoom<13)return;this._indoorData&&!function(A,M){const[O,k]=A,{center:L,radius:U}=M,[j,$]=L,Q=Math.abs(O-j);return Math.sqrt((Q>180?360-Q:Q)**2+(k-$)**2)<=U}([this._map.getCenter().lng,this._map.getCenter().lat],this._indoorData.circumCircle)&&(this._indoorData=void 0,this._selectedFloorplan=void 0,this._map.setConfigProperty(this._scope,"mbx-indoor-underground",!1),this._map.setConfigProperty(this._scope,"mbx-indoor-active-floorplans",["literal",[]]),this.fire(new s.z("floorplangone")));const c={target:{featuresetId:this._queryFeatureSetId,importId:this._scope}},m=new s.P(this._map.transform.width/2,this._map.transform.height/2),v=[new s.P(0,0),new s.P(this._map.transform.width,this._map.transform.height)],b=this._map.queryRenderedFeatures(o?v:m,c);b.length>0&&(this._selectedFloorplan&&b[0].properties.id===this._selectedFloorplan.properties.id||(this._selectedFloorplan=b[0],this._floorplanSelected(!1)))}_floorplanSelected(o){this._indoorData=JSON.parse(this._selectedFloorplan.properties["indoor-data"]),this._indoorData.id=this._selectedFloorplan.properties.id,this._indoorData.circumCircle=function(b){const[[A,M],[O,k]]=b,L=(O-A+360)%360,U=L>180?360-L:L;return{center:[(A+U/2+360)%360,(M+k)/2],radius:Math.sqrt(U**2+(k-M)**2)/2}}(this._indoorData.extent),this._floorplanStates[this._indoorData.id]||(this._floorplanStates[this._indoorData.id]={});const c=this._floorplanStates[this._indoorData.id].selectedBuilding,m=this._floorplanStates[this._indoorData.id].selectedLevel;let v;if(this._map.setConfigProperty(this._scope,"mbx-indoor-active-floorplans",this._indoorData.floorplanIDs),this._selectedLevel)for(const b of this._indoorData.levels)b.id===this._selectedLevel.id&&(v=b.id);if(this.fire(new s.z("floorplanselected",{buildings:this._indoorData.buildings,levels:this._indoorData.levels,selectedLevelId:v})),c){const b=this._indoorData.buildings.find(A=>A.id===c);this._buildingSelected(b,!1)}else this._indoorData.buildings.length>0&&this._buildingSelected(this._indoorData.buildings[0],!1);if(m){const b=this._indoorData.levels.find(A=>A.id===m);this._updateLevels(b,o)}else o&&this._indoorData["default-levels"].length>0&&this.selectLevel(this._indoorData["default-levels"][0])}_buildingSelected(o,c){c&&o&&o.extent&&this._map.fitBounds(o.extent,{pitch:this._map.getPitch(),bearing:this._map.getBearing()}),this._floorplanStates[this._indoorData.id].selectedBuilding=o?o.id:void 0;const m=this._indoorData.levels.filter(v=>o.levels.includes(v.id));this.fire(new s.z("buildingselected",{buildingId:o.id,levels:m}))}_levelSelected(o){if(o==="overview")this._updateLevels(void 0,!0);else{const c=this._indoorData.levels.find(m=>m.id===o);this._updateLevels(c,!0)}this.fire(new s.z("levelselected",{levelId:o==="overview"?void 0:o}))}_updateLevels(o,c){if(!o)return this._map.setConfigProperty(this._scope,"mbx-indoor-loaded-levels",["literal",[]]),this._map.setConfigProperty(this._scope,"mbx-indoor-underground",!1),this._floorplanStates[this._indoorData.id].selectedLevel=void 0,void(c&&this._indoorData.extent&&this._map.fitBounds(this._indoorData.extent,{pitch:this._map.getPitch(),bearing:this._map.getBearing()}));function m(k){const L=k.indexOf("/floor/");if(L===-1)return k;const U=L+7,j=k.indexOf("/",U);return j===-1?k.slice(U):k.slice(U,j)}this._selectedLevel=o,this._floorplanStates[this._indoorData.id].selectedLevel=o?o.id:void 0;const v=[],b={},A={},M={},O={};for(const k of this._indoorData.levels)if(v.push(k.id),b[k.id]=k.height,A[k.id]=k.base,o){if(this.mergeFloors){const L=m(o.id),U=m(k.id);M[k.id]=U===L?"true":"false"}else M[k.id]=k.id===o.id?"true":"false";O[k.id]=k.base<o.base?"true":"false"}else O[k.id]=!0;if(this._map.setConfigProperty(this._scope,"mbx-indoor-loaded-levels",["literal",v]),this._map.setConfigProperty(this._scope,"mbx-indoor-level-height",["literal",b]),this._map.setConfigProperty(this._scope,"mbx-indoor-level-base",["literal",A]),this._map.setConfigProperty(this._scope,"mbx-indoor-level-selected",["literal",M]),this._map.setConfigProperty(this._scope,"mbx-indoor-level-overlapped",["literal",O]),o&&(this._map.setConfigProperty(this._scope,"mbx-indoor-underground",!!o.isUnderground),c&&o.extent)){const k=this._map.cameraForBounds(o.extent,{pitch:this._map.getPitch(),bearing:this._map.getBearing()}),L=this._map.getZoom(),U=k.zoom?Math.abs(L-k.zoom):0;this._map.fitBounds(o.extent,U>=1?{pitch:this._map.getPitch(),bearing:this._map.getBearing()}:{pitch:this._map.getPitch(),bearing:this._map.getBearing(),zoom:L})}}selectFloorplan(o){const c={target:{featuresetId:this._queryFeatureSetId,importId:this._scope}},m=[new s.P(0,0),new s.P(this._map.transform.width,this._map.transform.height)],v=this._map.queryRenderedFeatures(m,c);if(v.length>0){for(const b of v)if(JSON.parse(b.properties["indoor-data"]).floorplanIDs.includes(o)){this._selectedFloorplan=b,this._floorplanSelected(!0);break}}}selectBuilding(o){const c=this._indoorData.buildings.find(m=>m.id===o);this._buildingSelected(c,!0)}selectLevel(o){this._levelSelected(o)}}function F0(p){if(!p.metadata||!p.metadata.content_area)return;const o=s.q.devicePixelRatio,{left:c,top:m,width:v,height:b}=p.metadata.content_area,A=c*o,M=m*o;return[A,M,A+v*o,M+b*o]}function Gm(p){if(p)return p.map(([o,c])=>[o*s.q.devicePixelRatio,c*s.q.devicePixelRatio])}const Ba=(p,o)=>Xs(p,o&&o.filter(c=>c.identifier!=="source.canvas")),k0=s.ay(bi,["addLayer","removeLayer","setLights","setPaintProperty","setLayoutProperty","setSlot","setFilter","addSource","removeSource","setLayerZoomRange","setLight","setTransition","setGeoJSONSourceData","setTerrain","setFog","setSnow","setRain","setProjection","setCamera","addImport","removeImport","updateImport"]),$m=s.ay(bi,["setCenter","setZoom","setBearing","setPitch"]),ef=new Set(["background","sky","slot","custom"]),Tc={version:8,layers:[],sources:{}},Wm={duration:300,delay:0};class Es extends s.E{constructor(o,c={}){super(),this.map=o,this.scope=c.scope||"",this.globalId=null,this.fragments=[],this.importDepth=c.importDepth||0,this.importsCache=c.importsCache||new Map,this.resolvedImports=c.resolvedImports||new Set,this.transition=s.l({},Wm),this._buildingIndex=new Vm(this),this.crossTileSymbolIndex=new Wd,this._mergedOrder=[],this._drapedFirstOrder=[],this._mergedLayers={},this._mergedSourceCaches={},this._mergedOtherSourceCaches={},this._mergedSymbolSourceCaches={},this._clipLayerPresent=!1,this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this._changes=c.styleChanges||new _n,this.dispatcher=c.dispatcher?c.dispatcher:new s.D(s.ci(),this),c.imageManager?this.imageManager=c.imageManager:(this.imageManager=new Wr(this.map._spriteFormat),this.imageManager.setEventedParent(this)),this.imageManager.createScope(this.scope),this.glyphManager=c.glyphManager?c.glyphManager:new s.cj(o._requestManager,c.localFontFamily?s.ck.all:c.localIdeographFontFamily?s.ck.ideographs:s.ck.none,c.localFontFamily||c.localIdeographFontFamily),c.modelManager?this.modelManager=c.modelManager:(this.modelManager=new Kd(o._requestManager),this.modelManager.setEventedParent(this)),this._layers={},this._sourceCaches={},this._otherSourceCaches={},this._symbolSourceCaches={},this._loaded=!1,this._precompileDone=!1,this._shouldPrecompile=!1,this._availableImages=[],this._order=[],this._markersNeedUpdate=!1,this.options=c.configOptions?c.configOptions:new Map,this._configDependentLayers=c.configDependentLayers?c.configDependentLayers:new Set,this._config=c.config,this._styleColorTheme={lut:null,lutLoading:!1,lutLoadingCorrelationID:0,colorTheme:null,colorThemeOverride:c.colorThemeOverride},this._styleColorThemeForScope={},this._initialConfig=c.initialConfig,this.dispatcher.broadcast("setReferrer",s.cl());const m=this;this._rtlTextPluginCallback=Es.registerForPluginStateChange(v=>{m.dispatcher.broadcast("syncRTLPluginState",{pluginStatus:v.pluginStatus,pluginURL:v.pluginURL},(b,A)=>{if(s.cm(b),A&&A.every(M=>M))for(const M in m._sourceCaches){const O=m._sourceCaches[M],k=O.getSource().type;k!=="vector"&&k!=="geojson"||O.reload()}})}),this.on("data",v=>{if(v.dataType!=="source"||v.sourceDataType!=="metadata")return;const b=this.getOwnSource(v.sourceId);if(b&&b.vectorLayerIds)for(const A in this._layers){const M=this._layers[A];M.source===b.id&&this._validateLayer(M)}})}load(o){return o?(typeof o=="string"?this.loadURL(o):this.loadJSON(o),this):this}_getGlobalId(o){if(!o)return null;if(typeof o=="string"){if(s.f(o))return o;const c=s.cn(o);if(!c.startsWith("http"))try{return new URL(c,location.href).toString()}catch{return c}return c}return`json://${s.co(JSON.stringify(o))}`}_diffStyle(o,c,m){this.globalId=this._getGlobalId(o);const v=(b,A)=>{try{A(null,this.setState(b,m))}catch(M){A(M,!1)}};if(typeof o=="string"){const b=this.map._requestManager.normalizeStyleURL(o),A=this.map._requestManager.transformRequest(b,s.R.Style);s.n(A,(M,O)=>{M?this.fire(new s.y(M)):O&&v(O,c)})}else typeof o=="object"&&v(o,c)}loadURL(o,c={}){this.fire(new s.z("dataloading",{dataType:"style"}));const m=typeof c.validate=="boolean"?c.validate:!s.f(o);this.globalId=this._getGlobalId(o),o=this.map._requestManager.normalizeStyleURL(o,c.accessToken),this.resolvedImports.add(o);const v=this.importsCache.get(o);if(v)return this._load(v,m);const b=this.map._requestManager.transformRequest(o,s.R.Style);this._request=s.n(b,(A,M)=>{if(this._request=null,A)this.fire(new s.y(A));else if(M)return this.importsCache.set(o,M),this._load(M,m)})}loadJSON(o,c={}){this.fire(new s.z("dataloading",{dataType:"style"})),this.globalId=this._getGlobalId(o),this._request=s.q.frame(()=>{this._request=null,this._load(o,c.validate!==!1)})}loadEmpty(){this.fire(new s.z("dataloading",{dataType:"style"})),this._load(Tc,!1)}_loadImports(o,c,m){if(this.importDepth>=4)return s.w("Style doesn't support nesting deeper than 5"),Promise.resolve();const v=[];for(const b of o){const A=this._createFragmentStyle(b),M=new Promise(L=>{A.once("style.import.load",L),A.once("error",L)}).then(()=>this.mergeAll());if(v.push(M),this.resolvedImports.has(b.url)){A.loadEmpty();continue}const O=b.data||this.importsCache.get(b.url);O?(A.loadJSON(O,{validate:c}),this._isInternalStyle(O)&&(A.globalId=null)):b.url?A.loadURL(b.url,{validate:c}):A.loadEmpty();const k={style:A,id:b.id,config:b.config};if(m){const L=this.fragments.findIndex(({id:U})=>U===m);this.fragments=this.fragments.slice(0,L).concat(k).concat(this.fragments.slice(L))}else this.fragments.push(k)}return Promise.allSettled(v)}getImportGlobalIds(o=this,c=new Set){for(const m of o.fragments)m.style.globalId&&c.add(m.style.globalId),this.getImportGlobalIds(m.style,c);return[...c.values()]}_createFragmentStyle(o){const c=this.scope?s.aC(o.id,this.scope):o.id;let m;const v=this._initialConfig&&this._initialConfig[c];(o.config||v)&&(m=s.l({},o.config,v));const b=new Es(this.map,{scope:c,styleChanges:this._changes,importDepth:this.importDepth+1,importsCache:this.importsCache,resolvedImports:new Set(this.resolvedImports),dispatcher:this.dispatcher,imageManager:this.imageManager,glyphManager:this.glyphManager,modelManager:this.modelManager,config:m,configOptions:this.options,colorThemeOverride:o["color-theme"],configDependentLayers:this._configDependentLayers});return b.setEventedParent(this.map,{style:b}),b}_reloadImports(){this.mergeAll(),this._updateMapProjection(),this.updateConfigDependencies(),this.map._triggerCameraUpdate(this.camera),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),this._shouldPrecompile=this.map._precompilePrograms&&this.isRootStyle()}_isInternalStyle(o){return this.isRootStyle()&&(o.fragment||!!o.schema&&o.fragment!==!1)}_load(o,c){const m=o.indoor?Jd(o.schema):o.schema;if(this._isInternalStyle(o)){const A=s.l({},Tc,{imports:[{id:"basemap",data:o,url:""}]});return void this._load(A,c)}if(this.updateConfig(this._config,m),c&&Ba(this,Yn(o)))return;this._loaded=!0,this.stylesheet=s.cp(o);const v=()=>{for(const k in o.sources)this.addSource(k,o.sources[k],{validate:!1,isInitialLoad:!0});o.sprite?this._loadIconset(o.sprite):(this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0})),this.glyphManager.setURL(o.glyphs,this.scope);const A=Gu(this.stylesheet.layers);if(this._order=A.map(k=>k.id),this.stylesheet.light&&s.w("The `light` root property is deprecated, prefer using `lights` with `flat` light type instead."),this.stylesheet.lights)if(this.stylesheet.lights.length===1&&this.stylesheet.lights[0].type==="flat"){const k=this.stylesheet.lights[0];this.light=new J(k.properties,k.id)}else this.setLights(this.stylesheet.lights);this.light||(this.light=new J(this.stylesheet.light)),this._layers={};for(const k of A){const L=s.cu(k,this.scope,this._styleColorTheme.lut,this.options);L.configDependencies.size!==0&&this._configDependentLayers.add(L.fqid),L.setEventedParent(this,{layer:{id:L.id}}),this._layers[L.id]=L;const U=this.getOwnLayerSourceCache(L),j=!!this.directionalLight&&this.directionalLight.shadowsEnabled();U&&L.canCastShadows()&&j&&(U.castsShadows=!0)}this.stylesheet.featuresets&&this.setFeaturesetSelectors(this.stylesheet.featuresets),this.stylesheet.models&&this.modelManager.addModels(this.stylesheet.models,this.scope);const M=this.stylesheet.terrain;M&&(this.checkCanvasFingerprintNoise(),this.disableElevatedTerrain||this.terrainSetForDrapingOnly()||this._createTerrain(M,1)),this.stylesheet.fog&&this._createFog(this.stylesheet.fog),this.stylesheet.snow&&this._createSnow(this.stylesheet.snow),this.stylesheet.rain&&this._createRain(this.stylesheet.rain),this.stylesheet.transition&&this.setTransition(this.stylesheet.transition),this.fire(new s.z("data",{dataType:"style"}));const O=this.isRootStyle();o.imports?this._loadImports(o.imports,c).then(()=>{this._reloadImports(),this.fire(new s.z(O?"style.load":"style.import.load"))}):(this._reloadImports(),this.fire(new s.z(O?"style.load":"style.import.load")))};this._styleColorTheme.colorTheme=this.stylesheet["color-theme"];const b=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(b){const A=this._evaluateColorThemeData(b);this._loadColorTheme(A).then(()=>{v()}).catch(M=>{s.w(`Couldn't load color theme from the stylesheet: ${M}`),v()})}else this._styleColorTheme.lut=null,v()}isRootStyle(){return this.importDepth===0}mergeAll(){let o,c,m,v,b,A,M,O,k,L;const U={};this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle(j=>{if(j.stylesheet){if(j.light!=null&&(o=j.light),j.stylesheet.lights)for(const $ of j.stylesheet.lights)$.type==="ambient"&&j.ambientLight!=null&&(c=j.ambientLight),$.type==="directional"&&j.directionalLight!=null&&(m=j.directionalLight);v=this._prioritizeTerrain(v,j.terrain,j.stylesheet.terrain),j.stylesheet.fog&&j.fog!=null&&(b=j.fog),j.stylesheet.snow&&j.snow!=null&&(A=j.snow),j.stylesheet.rain&&j.rain!=null&&(M=j.rain),j.stylesheet.camera!=null&&(L=j.stylesheet.camera),j.stylesheet.projection!=null&&(O=j.stylesheet.projection),j.stylesheet.transition!=null&&(k=j.stylesheet.transition),U[j.scope]=j._styleColorTheme}}),this.light=o,this.ambientLight=c,this.directionalLight=m,this.fog=b,this.snow=A,this.rain=M,this._styleColorThemeForScope=U,v===null?delete this.terrain:this.terrain=v,this.camera=L||{"camera-projection":"perspective"},this.projection=O||{name:"mercator"},this.transition=s.l({},Wm,k),this.mergeSources(),this.mergeLayers()}forEachFragmentStyle(o){const c=m=>{for(const v of m.fragments)c(v.style);o(m)};c(this)}_prioritizeTerrain(o,c,m){const v=o&&o.drapeRenderMode===0;return m===null?c&&c.drapeRenderMode===0?c:v?o:null:c!=null&&(!o||v||c&&c.drapeRenderMode===1)?c:o}mergeTerrain(){let o;this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle(c=>{o=this._prioritizeTerrain(o,c.terrain,c.stylesheet.terrain)}),o===null?delete this.terrain:this.terrain=o}mergeProjection(){let o;this.forEachFragmentStyle(c=>{c.stylesheet.projection!=null&&(o=c.stylesheet.projection)}),this.projection=o||{name:"mercator"}}mergeSources(){const o={},c={},m={};this.forEachFragmentStyle(v=>{for(const b in v._sourceCaches){const A=s.aC(b,v.scope);o[A]=v._sourceCaches[b]}for(const b in v._otherSourceCaches){const A=s.aC(b,v.scope);c[A]=v._otherSourceCaches[b]}for(const b in v._symbolSourceCaches){const A=s.aC(b,v.scope);m[A]=v._symbolSourceCaches[b]}}),this._mergedSourceCaches=o,this._mergedOtherSourceCaches=c,this._mergedSymbolSourceCaches=m}mergeLayers(){const o={},c=[],m={};this._mergedSlots=[],this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this.forEachFragmentStyle(b=>{for(const A of b._order){const M=b._layers[A];if(M.type==="slot"){const O=s.cq(A);if(o[O])continue;o[O]=[]}M.slot&&o[M.slot]?o[M.slot].push(M):c.push(M)}}),this._mergedOrder=[];const v=(b=[])=>{for(const A of b)if(A.type==="slot"){const M=s.cq(A.id);o[M]&&v(o[M]),this._mergedSlots.push(M)}else{const M=s.aC(A.id,A.scope);this._mergedOrder.push(M),m[M]=A,A.is3D()&&(this._has3DLayers=!0),A.type==="circle"&&(this._hasCircleLayers=!0),A.type==="symbol"&&(this._hasSymbolLayers=!0),A.type==="clip"&&(this._clipLayerPresent=!0)}};v(c),this._mergedOrder.sort((b,A)=>{const M=m[b],O=m[A];return M.hasInitialOcclusionOpacityProperties?O.is3D()?1:0:M.is3D()&&O.hasInitialOcclusionOpacityProperties?-1:0}),this._mergedLayers=m,this.updateDrapeFirstLayers(),this._buildingIndex.processLayersChanged()}terrainSetForDrapingOnly(){return!!this.terrain&&this.terrain.drapeRenderMode===0}getCamera(){return this.stylesheet.camera}setCamera(o){return this.stylesheet.camera=s.l({},this.stylesheet.camera,o),this.camera=this.stylesheet.camera,this}_evaluateColorThemeData(o){return o.data?function(c,m,v){const b=s.l({},m);for(const M of Object.keys(s.a3.colorTheme))b[M]===void 0&&(b[M]=s.a3.colorTheme[M].default);const A=new s.a4(O0,c,new Map(v));return A.setTransitionOrValue(b,v),A.untransitioned().possiblyEvaluate(new s.a8(0))}(this.scope,o,this.options).get("data"):null}_loadColorTheme(o){this._styleColorTheme.lutLoading=!0,this._styleColorTheme.lutLoadingCorrelationID+=1;const c=this._styleColorTheme.lutLoadingCorrelationID;return new Promise((m,v)=>{const b="data:image/png;base64,";if(!o||o.length===0)return this._styleColorTheme.lut=null,this._styleColorTheme.lutLoading=!1,void m();let A=o;A.startsWith(b)||(A=b+A);const M="mapbox-reserved-lut",O=new Image;O.src=A,O.onerror=()=>{this._styleColorTheme.lutLoading=!1,v(new Error("Failed to load image data"))},O.onload=()=>{if(this._styleColorTheme.lutLoadingCorrelationID!==c)return void m();this._styleColorTheme.lutLoading=!1;const{width:k,height:L,data:U}=s.q.getImageData(O);if(L>32)return void v(new Error("The height of the image must be less than or equal to 32 pixels."));if(k!==L*L)return void v(new Error("The width of the image must be equal to the height squared."));this.getImage(M)&&this.removeImage(M),this.addImage(M,{data:new s.r({width:k,height:L},U),pixelRatio:1,sdf:!1,usvg:!1,version:0});const j=this.imageManager.getImage(M,this.scope);j?(this._styleColorTheme.lut={image:j.data,data:o},m()):v(new Error("Missing LUT image."))}})}getLut(o){const c=this._styleColorThemeForScope[o];return c?c.lut:null}setProjection(o){o?this.stylesheet.projection=o:delete this.stylesheet.projection,this.mergeProjection(),this._updateMapProjection()}applyProjectionUpdate(){this._loaded&&(this.dispatcher.broadcast("setProjection",this.map.transform.projectionOptions),this.map.transform.projection.requiresDraping?(this.getTerrain()||this.stylesheet.terrain)&&!this.disableElevatedTerrain||this.setTerrainForDraping():this.terrainSetForDrapingOnly()&&this.setTerrain(null,0))}_updateMapProjection(){this.isRootStyle()&&(this.map._useExplicitProjection?this.applyProjectionUpdate():this.map._prioritizeAndUpdateProjection(null,this.projection))}_loadSprite(o){this._spriteRequest=function(c,m,v){let b,A,M;const O=s.q.devicePixelRatio>1?"@2x":"";let k=s.n(m.transformRequest(m.normalizeSpriteURL(c,O,".json"),s.R.SpriteJSON),(j,$)=>{k=null,M||(M=j,b=$,U())}),L=s.o(m.transformRequest(m.normalizeSpriteURL(c,O,".png"),s.R.SpriteImage),(j,$)=>{L=null,M||(M=j,A=$,U())});function U(){if(M)v(M);else if(b&&A){const j=s.q.getImageData(A),$={};for(const Q in b){const{width:Z,height:te,x:ee,y:ae,sdf:me,pixelRatio:fe,stretchX:Ae,stretchY:ve,content:be}=b[Q],ye=new s.r({width:Z,height:te});s.r.copy(j,ye,{x:ee,y:ae},{x:0,y:0},{width:Z,height:te},null),$[Q]={data:ye,pixelRatio:fe,sdf:me,stretchX:Ae,stretchY:ve,content:be,usvg:!1}}v(null,$)}}return{cancel(){k&&(k.cancel(),k=null),L&&(L.cancel(),L=null)}}}(o,this.map._requestManager,(c,m)=>{if(this._spriteRequest=null,c)this.fire(new s.y(c));else if(m)for(const v in m)this.imageManager.addImage(v,this.scope,m[v]);this.imageManager.setLoaded(!0,this.scope),this._availableImages=this.imageManager.listImages(this.scope),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages}),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new s.z("data",{dataType:"style"}))})}_loadIconset(o){if(!s.f(o)&&this.map._spriteFormat!=="icon_set"||this.map._spriteFormat==="raster")return void this._loadSprite(o);const c=this.map._spriteFormat==="auto";var m,v;this._spriteRequest=(v=(b,A)=>{if(this._spriteRequest=null,b)c?this._loadSprite(o):this.fire(new s.y(b));else if(A)for(const M in A)this.imageManager.addImage(M,this.scope,A[M]);this.imageManager.setLoaded(!0,this.scope),this._availableImages=this.imageManager.listImages(this.scope),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages}),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new s.z("data",{dataType:"style"}))},s.bi((m=this.map._requestManager).transformRequest(m.normalizeIconsetURL(o),s.R.Iconset),(b,A)=>{if(b)return void v(b);const M={},O=s.cg(new s.bh(A));for(const k of O.icons){const L={version:1,pixelRatio:s.q.devicePixelRatio,content:F0(k),stretchX:k.metadata?Gm(k.metadata.stretch_x_areas):void 0,stretchY:k.metadata?Gm(k.metadata.stretch_y_areas):void 0,sdf:!1,usvg:!0,icon:k};M[k.name]=L}v(null,M)}))}_validateLayer(o){const c=this.getOwnSource(o.source);if(!c)return;const m=o.sourceLayer;m&&(c.type==="geojson"||c.vectorLayerIds&&c.vectorLayerIds.indexOf(m)===-1)&&this.fire(new s.y(new Error(`Source layer "${m}" does not exist on source "${c.id}" as specified by style layer "${o.id}"`)))}loaded(){if(!this._loaded||Object.keys(this._changes.getUpdatedSourceCaches()).length)return!1;for(const o in this._sourceCaches)if(!this._sourceCaches[o].loaded())return!1;if(!this.imageManager.isLoaded()||!this.modelManager.isLoaded()||this._styleColorTheme.lutLoading)return!1;for(const{style:o}of this.fragments)if(!o.loaded())return!1;return!0}_serializeImports(){if(this.stylesheet.imports)return this.stylesheet.imports.map((o,c)=>{const m=this.fragments[c];return m&&m.style&&(o.data=m.style.serialize()),o})}_serializeSources(){const o={};for(const c in this._sourceCaches){const m=this._sourceCaches[c].getSource();o[m.id]||(o[m.id]=m.serialize())}return o}_serializeLayers(o){const c=[];for(const m of o){const v=this._layers[m];v&&v.type!=="custom"&&c.push(v.serialize())}return c}hasLightTransitions(){return!(!this.light||!this.light.hasTransition())||!(!this.ambientLight||!this.ambientLight.hasTransition())||!(!this.directionalLight||!this.directionalLight.hasTransition())}hasFogTransition(){return!!this.fog&&this.fog.hasTransition()}hasSnowTransition(){return!!this.snow&&this.snow.hasTransition()}hasRainTransition(){return!!this.rain&&this.rain.hasTransition()}hasTransitions(){if(this.hasLightTransitions()||this.hasFogTransition()||this.hasSnowTransition()||this.hasRainTransition())return!0;for(const o in this._sourceCaches)if(this._sourceCaches[o].hasTransition())return!0;for(const o in this._layers)if(this._layers[o].hasTransition())return!0;return!1}get order(){return this.terrain?this._drapedFirstOrder:this._mergedOrder}_getOrder(o){return o?this.order:this._mergedOrder}isLayerDraped(o){return!!this.terrain&&o.isDraped(this.getLayerSourceCache(o))}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading")}_checkLayer(o){const c=this.getOwnLayer(o);if(c)return c;this.fire(new s.y(new Error(`The layer '${o}' does not exist in the map's style.`)))}_checkSource(o){const c=this.getOwnSource(o);if(c)return c;this.fire(new s.y(new Error(`The source '${o}' does not exist in the map's style.`)))}precompilePrograms(o,c){const m=this.map.painter;if(m)for(let v=o.minzoom||0;v<(o.maxzoom||25.5);v++){const b=o.getProgramIds();if(b)for(const A of b){const M=o.getDefaultProgramParams(A,c.zoom,this._styleColorTheme.lut);M&&(m.style=this,this.fog&&(m._fogVisible=!0,M.overrideFog=!0,m.getOrCreateProgram(A,M)),m._fogVisible=!1,M.overrideFog=!1,m.getOrCreateProgram(A,M),(this.stylesheet.terrain||this.stylesheet.projection&&this.stylesheet.projection.name==="globe")&&(M.overrideRtt=!0,m.getOrCreateProgram(A,M)))}}}update(o){if(!this._loaded)return;this.ambientLight&&this.ambientLight.recalculate(o),this.directionalLight&&this.directionalLight.recalculate(o);const c=this.calculateLightsBrightness();o.brightness=c||0,c!==this._brightness&&(this._brightness=c,this.dispatcher.broadcast("setBrightness",c));const m=this._changes.isDirty();let v=!1;if(this._changes.isDirty()){const A=this._changes.getLayerUpdatesByScope();for(const M in A){const{updatedIds:O,removedIds:k}=A[M];(O||k)&&(this._updateWorkerLayers(M,O,k),v=!0)}this.updateSourceCaches(),this._updateTilesForChangedImages(),this.updateLayers(o),this.light&&this.light.updateTransitions(o),this.ambientLight&&this.ambientLight.updateTransitions(o),this.directionalLight&&this.directionalLight.updateTransitions(o),this.fog&&this.fog.updateTransitions(o),this.snow&&this.snow.updateTransitions(o),this.rain&&this.rain.updateTransitions(o),this._changes.reset()}const b={};for(const A in this._mergedSourceCaches){const M=this._mergedSourceCaches[A];b[A]=M.used,M.used=!1,M.tileCoverLift=0}for(const A of this._mergedOrder){const M=this._mergedLayers[A];if(M.recalculate(o,this._availableImages),!M.isHidden(o.zoom)){const O=this.getLayerSourceCache(M);O&&(O.used=!0,O.tileCoverLift=Math.max(O.tileCoverLift,M.tileCoverLift()))}!this._precompileDone&&this._shouldPrecompile&&("requestIdleCallback"in window?requestIdleCallback(()=>{this.precompilePrograms(M,o)}):this.precompilePrograms(M,o))}this._shouldPrecompile&&(this._precompileDone=!0),this.terrain&&v&&this.mergeLayers();for(const A in b){const M=this._mergedSourceCaches[A];b[A]!==M.used&&M.getSource().fire(new s.z("data",{sourceDataType:"visibility",dataType:"source",sourceId:M.getSource().id}))}this.light&&this.light.recalculate(o),this.terrain&&this.terrain.recalculate(o),this.fog&&this.fog.recalculate(o),this.snow&&this.snow.recalculate(o),this.rain&&this.rain.recalculate(o),this.z=o.zoom,this._markersNeedUpdate&&(this._updateMarkersOpacity(),this._markersNeedUpdate=!1),m&&this.fire(new s.z("data",{dataType:"style"}))}_updateTilesForChangedImages(){const o=this._changes.getUpdatedImages();if(o.length){for(const c in this._sourceCaches)this._sourceCaches[c].reloadTilesForDependencies(["icons","patterns"],o);this._changes.resetUpdatedImages()}}_updateWorkerLayers(o,c,m){const v=this.getFragmentStyle(o);v&&this.dispatcher.broadcast("updateLayers",{layers:c?v._serializeLayers(c):[],scope:o,removedIds:m||[],options:v.options})}setState(o,c){if(this._checkLoaded(),Ba(this,Yn(o)))return!1;(o=s.cp(o)).layers=Gu(o.layers);const m=function(A,M){if(!A)return[{command:bi.setStyle,args:[M]}];let O=[];try{if(!s.bn(A.version,M.version))return[{command:bi.setStyle,args:[M]}];if(s.bn(A.center,M.center)||O.push({command:bi.setCenter,args:[M.center]}),s.bn(A.zoom,M.zoom)||O.push({command:bi.setZoom,args:[M.zoom]}),s.bn(A.bearing,M.bearing)||O.push({command:bi.setBearing,args:[M.bearing]}),s.bn(A.pitch,M.pitch)||O.push({command:bi.setPitch,args:[M.pitch]}),s.bn(A.sprite,M.sprite)||O.push({command:bi.setSprite,args:[M.sprite]}),s.bn(A.glyphs,M.glyphs)||O.push({command:bi.setGlyphs,args:[M.glyphs]}),s.bn(A.imports,M.imports)||function($=[],Q=[],Z){Q=Q||[];const te=($=$||[]).map(yn),ee=Q.map(yn),ae=$.reduce(Io,{}),me=Q.reduce(Io,{}),fe=te.slice();let Ae,ve,be,ye;for(Ae=0,ve=0;Ae<te.length;Ae++)be=te[Ae],me.hasOwnProperty(be)?ve++:(Z.push({command:bi.removeImport,args:[be]}),fe.splice(fe.indexOf(be,ve),1));for(Ae=0,ve=0;Ae<ee.length;Ae++)be=ee[ee.length-1-Ae],fe[fe.length-1-Ae]!==be&&(ae.hasOwnProperty(be)?(Z.push({command:bi.removeImport,args:[be]}),fe.splice(fe.lastIndexOf(be,fe.length-ve),1)):ve++,ye=fe[fe.length-Ae],Z.push({command:bi.addImport,args:[me[be],ye]}),fe.splice(fe.length-Ae,0,be));for(const Ie of Q){const Fe=ae[Ie.id];Fe&&!s.bn(Fe,Ie)&&Z.push({command:bi.updateImport,args:[Ie.id,Ie]})}}(A.imports,M.imports,O),s.bn(A.transition,M.transition)||O.push({command:bi.setTransition,args:[M.transition]}),s.bn(A.light,M.light)||O.push({command:bi.setLight,args:[M.light]}),s.bn(A.fog,M.fog)||O.push({command:bi.setFog,args:[M.fog]}),s.bn(A.snow,M.snow)||O.push({command:bi.setSnow,args:[M.snow]}),s.bn(A.rain,M.rain)||O.push({command:bi.setRain,args:[M.rain]}),s.bn(A.projection,M.projection)||O.push({command:bi.setProjection,args:[M.projection]}),s.bn(A.lights,M.lights)||O.push({command:bi.setLights,args:[M.lights]}),s.bn(A.camera,M.camera)||O.push({command:bi.setCamera,args:[M.camera]}),!s.bn(A["color-theme"],M["color-theme"]))return[{command:bi.setStyle,args:[M]}];const k={},L=[];(function($,Q,Z,te){let ee;for(ee in Q=Q||{},$=$||{})$.hasOwnProperty(ee)&&(Q.hasOwnProperty(ee)||Ea(ee,Z,te));for(ee in Q){if(!Q.hasOwnProperty(ee))continue;const ae=Q[ee];$.hasOwnProperty(ee)?s.bn($[ee],ae)||($[ee].type==="geojson"&&ae.type==="geojson"&&$i($,Q,ee)?Z.push({command:bi.setGeoJSONSourceData,args:[ee,ae.data]}):jt(ee,Q,Z,te)):$u(ee,Q,Z)}})(A.sources,M.sources,L,k);const U=[];A.layers&&A.layers.forEach($=>{$.source&&k[$.source]?O.push({command:bi.removeLayer,args:[$.id]}):U.push($)});let j=A.terrain;j&&k[j.source]&&(O.push({command:bi.setTerrain,args:[void 0]}),j=void 0),O=O.concat(L),s.bn(j,M.terrain)||O.push({command:bi.setTerrain,args:[M.terrain]}),function($,Q,Z){Q=Q||[];const te=($=$||[]).map(yn),ee=Q.map(yn),ae=$.reduce(Io,{}),me=Q.reduce(Io,{}),fe=te.slice(),Ae=Object.create(null);let ve,be,ye,Ie,Fe,Qe,We;for(ve=0,be=0;ve<te.length;ve++)ye=te[ve],me.hasOwnProperty(ye)?be++:(Z.push({command:bi.removeLayer,args:[ye]}),fe.splice(fe.indexOf(ye,be),1));for(ve=0,be=0;ve<ee.length;ve++)ye=ee[ee.length-1-ve],fe[fe.length-1-ve]!==ye&&(ae.hasOwnProperty(ye)?(Z.push({command:bi.removeLayer,args:[ye]}),fe.splice(fe.lastIndexOf(ye,fe.length-be),1)):be++,Qe=fe[fe.length-ve],Z.push({command:bi.addLayer,args:[me[ye],Qe]}),fe.splice(fe.length-ve,0,ye),Ae[ye]=!0);for(ve=0;ve<ee.length;ve++)if(ye=ee[ve],Ie=ae[ye],Fe=me[ye],!Ae[ye]&&!s.bn(Ie,Fe))if(s.bn(Ie.source,Fe.source)&&s.bn(Ie["source-layer"],Fe["source-layer"])&&s.bn(Ie.type,Fe.type)){for(We in Oi(Ie.layout,Fe.layout,Z,ye,null,bi.setLayoutProperty),Oi(Ie.paint,Fe.paint,Z,ye,null,bi.setPaintProperty),s.bn(Ie.slot,Fe.slot)||Z.push({command:bi.setSlot,args:[ye,Fe.slot]}),s.bn(Ie.filter,Fe.filter)||Z.push({command:bi.setFilter,args:[ye,Fe.filter]}),s.bn(Ie.minzoom,Fe.minzoom)&&s.bn(Ie.maxzoom,Fe.maxzoom)||Z.push({command:bi.setLayerZoomRange,args:[ye,Fe.minzoom,Fe.maxzoom]}),Ie)Ie.hasOwnProperty(We)&&We!=="layout"&&We!=="paint"&&We!=="filter"&&We!=="metadata"&&We!=="minzoom"&&We!=="maxzoom"&&We!=="slot"&&(We.indexOf("paint.")===0?Oi(Ie[We],Fe[We],Z,ye,We.slice(6),bi.setPaintProperty):s.bn(Ie[We],Fe[We])||Z.push({command:bi.setLayerProperty,args:[ye,We,Fe[We]]}));for(We in Fe)Fe.hasOwnProperty(We)&&!Ie.hasOwnProperty(We)&&We!=="layout"&&We!=="paint"&&We!=="filter"&&We!=="metadata"&&We!=="minzoom"&&We!=="maxzoom"&&We!=="slot"&&(We.indexOf("paint.")===0?Oi(Ie[We],Fe[We],Z,ye,We.slice(6),bi.setPaintProperty):s.bn(Ie[We],Fe[We])||Z.push({command:bi.setLayerProperty,args:[ye,We,Fe[We]]}))}else Z.push({command:bi.removeLayer,args:[ye]}),Qe=fe[fe.lastIndexOf(ye)+1],Z.push({command:bi.addLayer,args:[Fe,Qe]})}(U,M.layers,O)}catch(k){console.warn("Unable to compute style diff:",k),O=[{command:bi.setStyle,args:[M]}]}return O}(this.serialize(),o).filter(A=>!(A.command in $m));if(m.length===0)return!1;const v=m.filter(A=>!(A.command in k0));if(v.length>0)throw new Error(`Unimplemented: ${v.map(A=>A.command).join(", ")}.`);const b=[];return m.forEach(A=>{b.push(this[A.command].apply(this,A.args))}),c&&Promise.all(b).then(c),this.stylesheet=o,this.mergeAll(),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),!0}addImage(o,c){return this.getImage(o)?this.fire(new s.y(new Error("An image with this name already exists."))):(this.imageManager.addImage(o,this.scope,c),this._afterImageUpdated(o),this)}updateImage(o,c,m=!1){this.imageManager.updateImage(o,this.scope,c),m&&this._afterImageUpdated(o)}getImage(o){return this.imageManager.getImage(o,this.scope)}removeImage(o){return this.getImage(o)?(this.imageManager.removeImage(o,this.scope),this._afterImageUpdated(o),this):this.fire(new s.y(new Error("No image with this name exists.")))}_afterImageUpdated(o){this._availableImages=this.imageManager.listImages(this.scope),this._changes.updateImage(o),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages}),this.fire(new s.z("data",{dataType:"style"}))}listImages(){return this._checkLoaded(),this._availableImages.slice()}addModel(o,c,m={}){return this._checkLoaded(),this._validate(uc,`models.${o}`,c,null,m)||(this.modelManager.addModel(o,c,this.scope),this._changes.setDirty()),this}hasModel(o){return this.modelManager.hasModel(o,this.scope)}removeModel(o){return this.hasModel(o)?(this.modelManager.removeModel(o,this.scope),this):this.fire(new s.y(new Error("No model with this ID exists.")))}listModels(){return this._checkLoaded(),this.modelManager.listModels(this.scope)}addSource(o,c,m={}){if(this._checkLoaded(),this.getOwnSource(o)!==void 0)throw new Error(`There is already a source with ID "${o}".`);if(!c.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(c).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(c.type)>=0&&this._validate(To,`sources.${o}`,c,null,m))return;this.map&&this.map._collectResourceTiming&&(c.collectResourceTiming=!0);const v=Rn(o,c,this.dispatcher,this);v.scope=this.scope,v.setEventedParent(this,()=>({isSourceLoaded:this._isSourceCacheLoaded(v.id),source:v.serialize(),sourceId:v.id}));const b=A=>{const M=(A?"symbol:":"other:")+v.id,O=s.aC(M,this.scope),k=this._sourceCaches[M]=new As(O,v,A);(A?this._symbolSourceCaches:this._otherSourceCaches)[v.id]=k,k.onAdd(this.map)};b(!1),c.type!=="vector"&&c.type!=="geojson"||b(!0),v.onAdd&&v.onAdd(this.map),m.isInitialLoad||(this.mergeSources(),this._changes.setDirty())}removeSource(o){this._checkLoaded();const c=this.getOwnSource(o);if(!c)throw new Error("There is no source with this ID");for(const v in this._layers)if(this._layers[v].source===o)return this.fire(new s.y(new Error(`Source "${o}" cannot be removed while layer "${v}" is using it.`)));if(this.terrain&&this.terrain.scope===this.scope&&this.terrain.get().source===o)return this.fire(new s.y(new Error(`Source "${o}" cannot be removed while terrain is using it.`)));const m=this.getOwnSourceCaches(o);for(const v of m){const b=s.cq(v.id);delete this._sourceCaches[b],this._changes.discardSourceCacheUpdate(v.id),v.fire(new s.z("data",{sourceDataType:"metadata",dataType:"source",sourceId:v.getSource().id})),v.setEventedParent(null),v.clearTiles()}return delete this._otherSourceCaches[o],delete this._symbolSourceCaches[o],this.mergeSources(),c.setEventedParent(null),c.onRemove&&c.onRemove(this.map),this._changes.setDirty(),this}setGeoJSONSourceData(o,c){this._checkLoaded(),this.getOwnSource(o).setData(c),this._changes.setDirty()}getOwnSource(o){const c=this.getOwnSourceCache(o);return c&&c.getSource()}getOwnSources(){const o=[];for(const c in this._otherSourceCaches){const m=this.getOwnSourceCache(c);m&&o.push(m.getSource())}return o}areTilesLoaded(){const o=this._mergedSourceCaches;for(const c in o){const m=o[c]._tiles;for(const v in m){const b=m[v];if(b.state!=="loaded"&&b.state!=="errored")return!1}}return!0}setLights(o){if(this._checkLoaded(),!o)return delete this.ambientLight,void delete this.directionalLight;const c=this._getTransitionParameters();for(const v of o){if(this._validate(cl,"lights",v))return;switch(v.type){case"ambient":if(this.ambientLight){const b=this.ambientLight;b.set(v),b.updateTransitions(c)}else this.ambientLight=new ti(v,It||(It=new s.a5({color:new s.a6(s.a3.properties_light_ambient.color),"color-use-theme":new s.a6({type:"string",default:"default","property-type":"data-constant"}),intensity:new s.a6(s.a3.properties_light_ambient.intensity)})),this.scope,this.options);break;case"directional":if(this.directionalLight){const b=this.directionalLight;b.set(v),b.updateTransitions(c)}else this.directionalLight=new ti(v,Ct||(Ct=new s.a5({direction:new s.ak(s.a3.properties_light_directional.direction),color:new s.a6(s.a3.properties_light_directional.color),"color-use-theme":new s.a6({type:"string",default:"default","property-type":"data-constant"}),intensity:new s.a6(s.a3.properties_light_directional.intensity),"cast-shadows":new s.a6(s.a3.properties_light_directional["cast-shadows"]),"shadow-quality":new s.a6(s.a3.properties_light_directional["shadow-quality"]),"shadow-intensity":new s.a6(s.a3.properties_light_directional["shadow-intensity"])})),this.scope,this.options)}}const m=new s.a8(this.z||0,c);this.ambientLight&&this.ambientLight.recalculate(m),this.directionalLight&&this.directionalLight.recalculate(m),this._brightness=this.calculateLightsBrightness(),this.dispatcher.broadcast("setBrightness",this._brightness)}calculateLightsBrightness(){const o=this.directionalLight,c=this.ambientLight;if(!o||!c)return;const m=j=>.2126*(j[0]<=.03928?j[0]/12.92:Math.pow((j[0]+.055)/1.055,2.4))+.7152*(j[1]<=.03928?j[1]/12.92:Math.pow((j[1]+.055)/1.055,2.4))+.0722*(j[2]<=.03928?j[2]/12.92:Math.pow((j[2]+.055)/1.055,2.4)),v=o.properties.get("color").toRenderColor(null).toArray01(),b=o.properties.get("intensity"),A=o.properties.get("direction"),M=1-s.cb(A.x,A.y,A.z)[2]/90,O=m(v)*b*M,k=c.properties.get("color").toRenderColor(null).toArray01(),L=c.properties.get("intensity"),U=m(k)*L;return Number(((O+U)/2).toFixed(6))}getBrightness(){return this._brightness}getLights(){if(!this.enable3dLights())return null;const o=[];return this.directionalLight&&o.push(this.directionalLight.get()),this.ambientLight&&o.push(this.ambientLight.get()),o}enable3dLights(){return!!this.ambientLight&&!!this.directionalLight}getFragmentStyle(o){if(!o)return this;if(s.cr(o)){const c=s.cs(o),m=this.fragments.find(({id:b})=>b===c);if(!m)throw new Error(`Style import '${o}' not found`);const v=s.cq(o);return m.style.getFragmentStyle(v)}{const c=this.fragments.find(({id:m})=>m===o);return c?c.style:void 0}}setFeaturesetSelectors(o){if(!o)return;const c={},m=(v,b="")=>`${v}::${b}`;this._featuresetSelectors={};for(const v in o){const b=this._featuresetSelectors[v]=[];for(const A of o[v].selectors){if(A.featureNamespace){const O=this.getOwnLayer(A.layer);if(!O){s.w(`Layer is undefined for selector: ${A.layer}`);continue}const k=m(O.source,O.sourceLayer);if(k in c&&c[k]!==A.featureNamespace){s.w(`"featureNamespace ${A.featureNamespace} of featureset ${v}'s selector is not associated to the same source, skip this selector`);continue}c[k]=A.featureNamespace}let M;if(A.properties)for(const O in A.properties){const k=s.U(A.properties[O]);k.result==="success"&&(M=M||{},M[O]=k.value)}b.push({layerId:A.layer,namespace:A.featureNamespace,properties:M,uniqueFeatureID:A._uniqueFeatureID})}}}getFeaturesetDescriptors(o){const c=this.getFragmentStyle(o);if(!c||!c.stylesheet.featuresets)return[];const m=[];for(const v in c.stylesheet.featuresets)m.push({featuresetId:v,importId:c.scope?c.scope:void 0});return m}getFeaturesetLayers(o,c){const m=this.getFragmentStyle(c),v=m.stylesheet.featuresets;if(!v||!v[o])return this.fire(new s.y(new Error(`The featureset '${o}' does not exist in the map's style and cannot be queried.`))),[];const b=[];for(const A of v[o].selectors){const M=m.getOwnLayer(A.layer);M&&b.push(M)}return b}getConfigProperty(o,c){const m=this.getFragmentStyle(o);if(!m)return null;const v=s.aC(c,m.scope),b=m.options.get(v),A=b?b.value||b.default:null;return A?A.serialize():null}setConfigProperty(o,c,m){const v=this.getFragmentStyle(o);if(!v)return;const b=v.stylesheet.indoor?Jd(v.stylesheet.schema):v.stylesheet.schema;if(!b||!b[c])return;const A=s.U(m);if(A.result!=="success")return void Ba(this,A.value);const M=A.value.expression,O=s.aC(c,v.scope),k=v.options.get(O);if(!k)return;let L;const{minValue:U,maxValue:j,stepValue:$,type:Q,values:Z}=b[c],te=s.U(b[c].default);te.result==="success"&&(L=te.value.expression),L?(this.options.set(O,Object.assign({},k,{value:M,default:L,minValue:U,maxValue:j,stepValue:$,type:Q,values:Z})),this.updateConfigDependencies(c)):this.fire(new s.y(new Error(`No schema defined for the config option "${c}" in the "${o}" fragment.`)))}getConfig(o){const c=this.getFragmentStyle(o);if(!c)return null;const m=c.stylesheet.schema;if(!m)return null;const v={};for(const b in m){const A=s.aC(b,c.scope),M=c.options.get(A),O=M?M.value||M.default:null;v[b]=O?O.serialize():null}return v}setConfig(o,c){const m=this.getFragmentStyle(o);m&&(m.updateConfig(c,m.stylesheet.schema),this.updateConfigDependencies())}getSchema(o){const c=this.getFragmentStyle(o);return c?c.stylesheet.schema:null}setSchema(o,c){const m=this.getFragmentStyle(o);m&&(m.stylesheet.schema=c,m.updateConfig(m._config,c),this.updateConfigDependencies())}updateConfig(o,c){if(this._config=o,o||c)if(c)for(const m in c){let v,b;const A=s.U(c[m].default);if(A.result==="success"&&(v=A.value.expression),o&&o[m]!==void 0){const j=s.U(o[m]);j.result==="success"&&(b=j.value.expression)}const{minValue:M,maxValue:O,stepValue:k,type:L,values:U}=c[m];if(v){const j=s.aC(m,this.scope);this.options.set(j,{default:v,value:b,minValue:M,maxValue:O,stepValue:k,type:L,values:U})}else this.fire(new s.y(new Error(`No schema defined for config option "${m}".`)))}else this.fire(new s.y(new Error("Attempting to set config for a style without schema.")))}updateConfigDependencies(o){for(const c of this._configDependentLayers){const m=this.getLayer(c);if(m){if(o&&!m.configDependencies.has(o))continue;m.possiblyEvaluateVisibility(),this._updateLayer(m)}}this.ambientLight&&this.ambientLight.updateConfig(this.options),this.directionalLight&&this.directionalLight.updateConfig(this.options),this.fog&&this.fog.updateConfig(this.options),this.snow&&this.snow.updateConfig(this.options),this.rain&&this.rain.updateConfig(this.options),this.forEachFragmentStyle(c=>{const m=c._styleColorTheme.colorThemeOverride?c._styleColorTheme.colorThemeOverride:c._styleColorTheme.colorTheme;if(m){const v=c._evaluateColorThemeData(m);(!c._styleColorTheme.lut&&v!==""||c._styleColorTheme.lut&&v!==c._styleColorTheme.lut.data)&&c.setColorTheme(m)}}),this._changes.setDirty()}addLayer(o,c,m={}){this._checkLoaded();const v=o.id;if(this._layers[v])return void this.fire(new s.y(new Error(`Layer with id "${v}" already exists on this map`)));let b;if(o.type==="custom"){if(Ba(this,s.ct(o)))return;b=s.cu(o,this.scope,this._styleColorTheme.lut,this.options)}else{if(typeof o.source=="object"&&(this.addSource(v,o.source),o=s.cp(o),o=s.l(o,{source:v})),this._validate(Uu,`layers.${v}`,o,{arrayIndex:-1},m))return;b=s.cu(o,this.scope,this._styleColorTheme.lut,this.options),this._validateLayer(b),b.setEventedParent(this,{layer:{id:v}})}b.configDependencies.size!==0&&this._configDependentLayers.add(b.fqid);let A=this._order.length;if(c){const L=this._order.indexOf(c);if(L===-1)return void this.fire(new s.y(new Error(`Layer with id "${c}" does not exist on this map.`)));b.slot===this._layers[c].slot?A=L:s.w(`Layer with id "${c}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(A,0,v),this._layerOrderChanged=!0,this._layers[v]=b;const M=this.getOwnLayerSourceCache(b),O=!!this.directionalLight&&this.directionalLight.shadowsEnabled();M&&b.canCastShadows()&&O&&(M.castsShadows=!0);const k=this._changes.getRemovedLayer(b);if(k&&b.source&&M&&b.type!=="custom"){this._changes.discardLayerRemoval(b);const L=s.aC(b.source,b.scope);k.type!==b.type?this._changes.updateSourceCache(L,"clear"):(this._changes.updateSourceCache(L,"reload"),M.pause())}this._updateLayer(b),b.onAdd&&b.onAdd(this.map),b.scope=this.scope,this.mergeLayers()}moveLayer(o,c){this._checkLoaded();const m=this._checkLayer(o);if(!m||o===c)return;const v=this._order.indexOf(o);this._order.splice(v,1);let b=this._order.length;if(c){const A=this._order.indexOf(c);if(A===-1)return void this.fire(new s.y(new Error(`Layer with id "${c}" does not exist on this map.`)));m.slot===this._layers[c].slot?b=A:s.w(`Layer with id "${c}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(b,0,o),this._changes.setDirty(),this._layerOrderChanged=!0,this.mergeLayers()}removeLayer(o){this._checkLoaded();const c=this._checkLayer(o);if(!c)return;c.setEventedParent(null);const m=this._order.indexOf(o);this._order.splice(m,1),delete this._layers[o],this._changes.setDirty(),this._layerOrderChanged=!0,this._configDependentLayers.delete(c.fqid),this._changes.removeLayer(c);const v=this.getOwnLayerSourceCache(c);if(v&&v.castsShadows){let b=!1;for(const A in this._layers)if(this._layers[A].source===c.source&&this._layers[A].canCastShadows()){b=!0;break}v.castsShadows=b}c.onRemove&&c.onRemove(this.map),this.mergeLayers()}getOwnLayer(o){return this._layers[o]}hasLayer(o){return o in this._mergedLayers}hasLayerType(o){for(const c in this._layers)if(this._layers[c].type===o)return!0;return!1}setLayerZoomRange(o,c,m){this._checkLoaded();const v=this._checkLayer(o);v&&(v.minzoom===c&&v.maxzoom===m||(c!=null&&(v.minzoom=c),m!=null&&(v.maxzoom=m),this._updateLayer(v)))}getSlots(){return this._checkLoaded(),this._mergedSlots}setSlot(o,c){this._checkLoaded();const m=this._checkLayer(o);m&&m.slot!==c&&(m.slot=c,this._updateLayer(m))}setFilter(o,c,m={}){this._checkLoaded();const v=this._checkLayer(o);if(v&&!s.bn(v.filter,c))return c==null?(v.filter=void 0,void this._updateLayer(v)):void(this._validate(Vr,`layers.${v.id}.filter`,c,{layerType:v.type},m)||(v.filter=s.cp(c),this._updateLayer(v)))}getFilter(o){const c=this._checkLayer(o);if(c)return s.cp(c.filter)}setLayoutProperty(o,c,m,v={}){this._checkLoaded();const b=this._checkLayer(o);if(b&&!s.bn(b.getLayoutProperty(c),m)){if(m!=null&&(!v||v.validate!==!1)&&Ba(b,Vu.call(Yn,{key:`layers.${o}.layout.${c}`,layerType:b.type,objectKey:c,value:m,styleSpec:s.a3,style:{glyphs:!0,sprite:!0}})))return;b.setLayoutProperty(c,m),b.configDependencies.size!==0&&this._configDependentLayers.add(b.fqid),this._updateLayer(b)}}getLayoutProperty(o,c){const m=this._checkLayer(o);if(m)return m.getLayoutProperty(c)}setPaintProperty(o,c,m,v={}){this._checkLoaded();const b=this._checkLayer(o);if(!b||s.bn(b.getPaintProperty(c),m)||m!=null&&(!v||v.validate!==!1)&&Ba(b,cc.call(Yn,{key:`layers.${o}.paint.${c}`,layerType:b.type,objectKey:c,value:m,styleSpec:s.a3})))return;const A=b.setPaintProperty(c,m);b.configDependencies.size!==0&&this._configDependentLayers.add(b.fqid),A&&this._updateLayer(b),this._changes.updatePaintProperties(b)}getPaintProperty(o,c){const m=this._checkLayer(o);if(m)return m.getPaintProperty(c)}setFeatureState(o,c){if(this._checkLoaded(),"target"in o){if("featuresetId"in o.target){const{featuresetId:O,importId:k}=o.target,L=this.getFragmentStyle(k),U=L.getFeaturesetLayers(O);for(const{source:j,sourceLayer:$}of U)L.setFeatureState({id:o.id,source:j,sourceLayer:$},c)}else if("layerId"in o.target){const{layerId:O}=o.target,k=this.getLayer(O);this.setFeatureState({id:o.id,source:k.source,sourceLayer:k.sourceLayer},c)}return}const m=o.source,v=o.sourceLayer,b=this._checkSource(m);if(!b)return;const A=b.type;if(A==="geojson"&&v)return void this.fire(new s.y(new Error("GeoJSON sources cannot have a sourceLayer parameter.")));if(A==="vector"&&!v)return void this.fire(new s.y(new Error("The sourceLayer parameter must be provided for vector source types.")));o.id===void 0&&this.fire(new s.y(new Error("The feature id parameter must be provided.")));const M=this.getOwnSourceCaches(m);for(const O of M)O.setFeatureState(v,o.id,c)}removeFeatureState(o,c){if(this._checkLoaded(),"target"in o){if("featuresetId"in o.target){const{featuresetId:O,importId:k}=o.target,L=this.getFragmentStyle(k),U=L.getFeaturesetLayers(O);for(const{source:j,sourceLayer:$}of U)L.removeFeatureState({id:o.id,source:j,sourceLayer:$},c)}else if("layerId"in o.target){const{layerId:O}=o.target,k=this.getLayer(O);this.removeFeatureState({id:o.id,source:k.source,sourceLayer:k.sourceLayer},c)}return}const m=o.source,v=this._checkSource(m);if(!v)return;const b=v.type,A=b==="vector"?o.sourceLayer:void 0;if(b==="vector"&&!A)return void this.fire(new s.y(new Error("The sourceLayer parameter must be provided for vector source types.")));if(c&&typeof o.id!="string"&&typeof o.id!="number")return void this.fire(new s.y(new Error("A feature id is required to remove its specific state property.")));const M=this.getOwnSourceCaches(m);for(const O of M)O.removeFeatureState(A,o.id,c)}getFeatureState(o){if(this._checkLoaded(),"target"in o){let b;if("featuresetId"in o.target){const{featuresetId:A,importId:M}=o.target,O=this.getFragmentStyle(M),k=O.getFeaturesetLayers(A);for(const{source:L,sourceLayer:U}of k){const j=O.getFeatureState({id:o.id,source:L,sourceLayer:U});if(j&&!b)b=j;else if(!s.bn(b,j))return void this.fire(new s.y(new Error("The same feature id exists in multiple sources in the featureset, but their feature states are not consistent through the sources.")))}}else if("layerId"in o.target){const{layerId:A}=o.target,M=this.getLayer(A);b=this.getFeatureState({id:o.id,source:M.source,sourceLayer:M.sourceLayer})}return b}const c=o.source,m=o.sourceLayer,v=this._checkSource(c);if(v){if(v.type!=="vector"||m)return o.id===void 0&&this.fire(new s.y(new Error("The feature id parameter must be provided."))),this.getOwnSourceCaches(c)[0].getFeatureState(m,o.id);this.fire(new s.y(new Error("The sourceLayer parameter must be provided for vector source types.")))}}setTransition(o){return this.stylesheet.transition=s.l({},this.stylesheet.transition,o),this.transition=this.stylesheet.transition,this}getTransition(){return s.l({},this.stylesheet.transition)}serialize(){this._checkLoaded();const o=this.getTerrain(),c=o&&this.terrain&&this.terrain.scope===this.scope?o:this.stylesheet.terrain;return s.cv({version:this.stylesheet.version,name:this.stylesheet.name,metadata:this.stylesheet.metadata,fragment:this.stylesheet.fragment,imports:this._serializeImports(),schema:this.stylesheet.schema,camera:this.stylesheet.camera,light:this.stylesheet.light,lights:this.stylesheet.lights,terrain:c,fog:this.stylesheet.fog,snow:this.stylesheet.snow,rain:this.stylesheet.rain,center:this.stylesheet.center,"color-theme":this.stylesheet["color-theme"],zoom:this.stylesheet.zoom,bearing:this.stylesheet.bearing,pitch:this.stylesheet.pitch,sprite:this.stylesheet.sprite,glyphs:this.stylesheet.glyphs,transition:this.stylesheet.transition,projection:this.stylesheet.projection,sources:this._serializeSources(),layers:this._serializeLayers(this._order)},m=>m!==void 0)}_updateFilteredLayers(o){for(const c of Object.values(this._mergedLayers))o(c)&&this._updateLayer(c)}_updateLayer(o){this._changes.updateLayer(o);const c=this.getLayerSourceCache(o),m=s.aC(o.source,o.scope),v=this._changes.getUpdatedSourceCaches();o.source&&!v[m]&&c&&c.getSource().type!=="raster"&&(this._changes.updateSourceCache(m,"reload"),c.pause()),o.invalidateCompiledFilter()}_flattenAndSortRenderedFeatures(o){const c=M=>this._mergedLayers[M].is3D(),m=this.order,v={},b=[];for(let M=m.length-1;M>=0;M--){const O=m[M];if(c(O)){v[O]=M;for(const k of o){const L=k[O];if(L)for(const U of L)b.push(U)}}}b.sort((M,O)=>O.intersectionZ-M.intersectionZ);const A=[];for(let M=m.length-1;M>=0;M--){const O=m[M];if(c(O))for(let k=b.length-1;k>=0;k--){const L=b[k].feature;if(L.layer&&v[L.layer.id]<M)break;A.push(L),b.pop()}else for(const k of o){const L=k[O];if(L)for(const U of L)A.push(U.feature)}}return A}queryRenderedFeatures(o,c,m){let v;c&&!Array.isArray(c)&&c.filter&&(this._validate(Vr,"queryRenderedFeatures.filter",c.filter,null,c),v=s.aZ(c.filter));const b={},A=L=>{if(ef.has(L.type))return;const U=this.getOwnLayerSourceCache(L),j=b[U.id]=b[U.id]||{sourceCache:U,layers:{},has3DLayers:!1};L.is3D()&&(j.has3DLayers=!0),j.layers[L.fqid]=j.layers[L.fqid]||{styleLayer:L,targets:[]},j.layers[L.fqid].targets.push({filter:v})};if(c&&c.layers){if(!Array.isArray(c.layers))return this.fire(new s.y(new Error("parameters.layers must be an Array."))),[];for(const L of c.layers){const U=this._layers[L];if(!U)return this.fire(new s.y(new Error(`The layer '${L}' does not exist in the map's style and cannot be queried for features.`))),[];A(U)}}else for(const L in this._layers)A(this._layers[L]);const M=this._queryRenderedFeatures(o,b,m),O=this._flattenAndSortRenderedFeatures(M),k=[];for(const L of O)s.cs(L.layer.id)===this.scope&&k.push(L);return k}queryRenderedFeatureset(o,c,m){let v;c&&!Array.isArray(c)&&c.filter&&(this._validate(Vr,"queryRenderedFeatures.filter",c.filter,null,c),v=s.aZ(c.filter));const b="mock",A=[];if(c&&c.target)A.push(Object.assign({},c,{targetId:b,filter:v}));else{const L=this.getFeaturesetDescriptors();for(const U of L)A.push({targetId:b,filter:v,target:U});for(const{style:U}of this.fragments){const j=U.getFeaturesetDescriptors();for(const $ of j)A.push({targetId:b,filter:v,target:$})}}const M=this.queryRenderedTargets(o,A,m),O=[],k=new Set;for(const L of M)for(const U of L.variants[b])Eo(U,L,k)||O.push(new s.cw(L,U));return O}queryRenderedTargets(o,c,m){const v={},b=(M,O,k,L)=>{const U=v[O.id]=v[O.id]||{sourceCache:O,layers:{},has3DLayers:!1};if(U.layers[M.fqid]=U.layers[M.fqid]||{styleLayer:M,targets:[]},M.is3D()&&(U.has3DLayers=!0),!L)return k.uniqueFeatureID=!1,void U.layers[M.fqid].targets.push(k);U.layers[M.fqid].targets.push(Object.assign({},k,{namespace:L.namespace,properties:L.properties,uniqueFeatureID:L.uniqueFeatureID}))};for(const M of c)if("featuresetId"in M.target){const{featuresetId:O,importId:k}=M.target,L=this.getFragmentStyle(k);if(!L||!L._featuresetSelectors)continue;const U=L._featuresetSelectors[O];if(!U){this.fire(new s.y(new Error(`The featureset '${O}' does not exist in the map's style and cannot be queried for features.`)));continue}for(const j of U){const $=L.getOwnLayer(j.layerId);$&&!ef.has($.type)&&b($,L.getOwnLayerSourceCache($),M,j)}}else if("layerId"in M.target){const{layerId:O}=M.target,k=this.getLayer(O);if(!k||ef.has(k.type))continue;b(k,this.getLayerSourceCache(k),M)}const A=this._queryRenderedFeatures(o,v,m);return this._flattenAndSortRenderedFeatures(A)}_queryRenderedFeatures(o,c,m){const v=[],b=!!this.map._showQueryGeometry,A=Jt.createFromScreenPoints(o,m);for(const M in c){const O=dc(A,c[M],this._availableImages,m,b);Object.keys(O).length&&v.push(O)}if(this.placement)for(const M in c){if(!c[M].sourceCache._onlySymbols)continue;const O=Dd(A.screenGeometry,c[M],this._availableImages,this.placement.collisionIndex,this.placement.retainedQueryData);Object.keys(O).length&&v.push(O)}return v}querySourceFeatures(o,c){const m=c&&c.filter;m&&this._validate(Vr,"querySourceFeatures.filter",m,null,c);let v=[];const b=this.getOwnSourceCaches(o);for(const A of b)v=v.concat(zm(A,c));return v}addSourceType(o,c,m){return Es.getSourceType(o)?m(new Error(`A source type called "${o}" already exists.`)):(Es.setSourceType(o,c),c.workerSourceURL?void this.dispatcher.broadcast("loadWorkerSource",{name:o,url:c.workerSourceURL},m):m(null,null))}getFlatLight(){return this.light.getLight()}setFlatLight(o,c,m={}){this._checkLoaded();const v=this.light.getLight();let b=!1;for(const M in o)if(!s.bn(o[M],v[M])){b=!0;break}if(!b)return;const A=this._getTransitionParameters();this.light.setLight(o,c,m),this.light.updateTransitions(A)}getTerrain(){return this.terrain&&this.terrain.drapeRenderMode===1?this.terrain.get():null}setTerrainForDraping(){this.setTerrain({source:"",exaggeration:0},0)}checkCanvasFingerprintNoise(){this.disableElevatedTerrain===void 0&&(this.disableElevatedTerrain=s.q.hasCanvasFingerprintNoise(),this.disableElevatedTerrain&&s.w("Terrain and hillshade are disabled because of Canvas2D limitations when fingerprinting protection is enabled (e.g. in private browsing mode)."))}setTerrain(o,c=1){if(this._checkLoaded(),!o)return this.terrainSetForDrapingOnly()||(delete this.terrain,this.map.transform.projection.requiresDraping&&this.setTerrainForDraping()),c===0&&delete this.terrain,o===null?this.stylesheet.terrain=null:delete this.stylesheet.terrain,this._force3DLayerUpdate(),void(this._markersNeedUpdate=!0);this.checkCanvasFingerprintNoise();let m=o;const v=o.source==null;if(c===1){if(this.disableElevatedTerrain)return;if(typeof m.source=="object"){const M="terrain-dem-src";this.addSource(M,m.source),m=s.cp(m),m=s.l(m,{source:M})}const b=s.l({},m),A={};if(this.terrain&&v){b.source=this.terrain.get().source;const M=this.terrain?this.getFragmentStyle(this.terrain.scope):null;M&&(A.style=M.serialize())}if(this._validate(ul,"terrain",b,A))return}if(!this.terrain||this.terrain.scope!==this.scope&&!v||this.terrain&&c!==this.terrain.drapeRenderMode){if(!m)return;this._createTerrain(m,c),this.fire(new s.z("data",{dataType:"style"}))}else{const b=this.terrain,A=b.get();for(const M of Object.keys(s.a3.terrain))!m.hasOwnProperty(M)&&s.a3.terrain[M].default&&(m[M]=s.a3.terrain[M].default);for(const M in o)if(!s.bn(o[M],A[M])){b.set(o,this.options),this.stylesheet.terrain=o;const O=this._getTransitionParameters({duration:0});b.updateTransitions(O),this.fire(new s.z("data",{dataType:"style"}));break}}this.mergeTerrain(),this.updateDrapeFirstLayers(),this._markersNeedUpdate=!0}_createFog(o){const c=this.fog=new Xe(o,this.map.transform,this.scope,this.options);this.stylesheet.fog=c.get();const m=this._getTransitionParameters({duration:0});c.updateTransitions(m)}_createSnow(o){const c=this.snow=new Zt(o,this.map.transform,this.scope,this.options);this.stylesheet.snow=c.get();const m=this._getTransitionParameters({duration:0});c.updateTransitions(m)}_createRain(o){const c=this.rain=new ei(o,this.map.transform,this.scope,this.options);this.stylesheet.rain=c.get();const m=this._getTransitionParameters({duration:0});c.updateTransitions(m)}_updateMarkersOpacity(){this.map._markers.length!==0&&this.map._requestDomTask(()=>{for(const o of this.map._markers)o._evaluateOpacity()})}getFog(){return this.fog?this.fog.get():null}setFog(o){if(this._checkLoaded(),!o)return delete this.fog,delete this.stylesheet.fog,void(this._markersNeedUpdate=!0);if(this.fog){const c=this.fog;if(!s.bn(c.get(),o)){c.set(o,this.options),this.stylesheet.fog=c.get();const m=this._getTransitionParameters({duration:0});c.updateTransitions(m)}}else this._createFog(o);this._markersNeedUpdate=!0}getSnow(){return this.snow?this.snow.get():null}setSnow(o){if(this._checkLoaded(),!o)return delete this.snow,void delete this.stylesheet.snow;if(this.snow){const c=this.snow;if(!s.bn(c.get(),o)){c.set(o,this.options),this.stylesheet.snow=c.get();const m=this._getTransitionParameters({duration:0});c.updateTransitions(m)}}else this._createSnow(o);this._markersNeedUpdate=!0}getRain(){return this.rain?this.rain.get():null}setRain(o){if(this._checkLoaded(),!o)return delete this.rain,void delete this.stylesheet.rain;if(this.rain){const c=this.rain;if(!s.bn(c.get(),o)){c.set(o,this.options),this.stylesheet.rain=c.get();const m=this._getTransitionParameters({duration:0});c.updateTransitions(m)}}else this._createRain(o);this._markersNeedUpdate=!0}_reloadColorTheme(){const o=()=>{for(const v in this._layers)this._layers[v].lut=this._styleColorTheme.lut;for(const v in this._sourceCaches)this._sourceCaches[v].clearTiles()},c=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(!c)return this._styleColorTheme.lut=null,void o();const m=this._evaluateColorThemeData(c);this._loadColorTheme(m).then(()=>{this.fire(new s.z("colorthemeset")),o()}).catch(v=>{s.w(`Couldn't set color theme: ${v}`)})}setColorTheme(o){this._checkLoaded(),this._styleColorTheme.colorThemeOverride&&s.w("Note: setColorTheme is called on a style with a color-theme override, the passed color-theme won't be visible."),this._styleColorTheme.colorTheme=o,this._reloadColorTheme()}setImportColorTheme(o,c){const m=this.getFragmentStyle(o);m&&(m._styleColorTheme.colorThemeOverride=c,m._reloadColorTheme())}_getTransitionParameters(o){return{now:s.q.now(),transition:s.l(this.transition,o)}}updateDrapeFirstLayers(){if(!this.terrain)return;const o=[],c=[];for(const m of this._mergedOrder)this.isLayerDraped(this._mergedLayers[m])?o.push(m):c.push(m);this._drapedFirstOrder=[],this._drapedFirstOrder.push(...o),this._drapedFirstOrder.push(...c)}_createTerrain(o,c){const m=this.terrain=new re(o,c,this.scope,this.options);c===1&&(this.stylesheet.terrain=o),this.mergeTerrain(),this.updateDrapeFirstLayers(),this._force3DLayerUpdate();const v=this._getTransitionParameters({duration:0});m.updateTransitions(v)}_force3DLayerUpdate(){for(const o in this._layers){const c=this._layers[o];c.type==="fill-extrusion"&&this._updateLayer(c)}}_forceSymbolLayerUpdate(){for(const o in this._layers){const c=this._layers[o];c.type==="symbol"&&this._updateLayer(c)}}_validate(o,c,m,v,b={}){if(b&&b.validate===!1)return!1;const A=s.l({},this.serialize());return Ba(this,o.call(Yn,s.l({key:c,style:A,value:m,styleSpec:s.a3},v)))}_remove(){this._request&&(this._request.cancel(),this._request=null),this._spriteRequest&&(this._spriteRequest.cancel(),this._spriteRequest=null),s.cx.off("pluginStateChange",this._rtlTextPluginCallback);for(const o in this._mergedLayers)this._mergedLayers[o].setEventedParent(null);for(const o in this._mergedSourceCaches)this._mergedSourceCaches[o].clearTiles(),this._mergedSourceCaches[o].setEventedParent(null);this.setEventedParent(null),delete this.fog,delete this.snow,delete this.rain,delete this.terrain,delete this.ambientLight,delete this.directionalLight,this.isRootStyle()&&(this.imageManager.setEventedParent(null),this.modelManager.setEventedParent(null),this.dispatcher.remove())}clearSource(o){const c=this.getSourceCaches(o);for(const m of c)m.clearTiles()}clearSources(){for(const o in this._mergedSourceCaches)this._mergedSourceCaches[o].clearTiles()}reloadSource(o){const c=this.getSourceCaches(o);for(const m of c)m.resume(),m.reload()}reloadSources(){for(const o of this.getSources())o.reload&&o.reload()}reloadModels(){this.modelManager.reloadModels(""),this.forEachFragmentStyle(o=>{o.modelManager.reloadModels(o.scope)})}updateSources(o){let c;this.directionalLight&&(c=Pa(this.directionalLight));for(const m in this._mergedSourceCaches)this._mergedSourceCaches[m].update(o,void 0,void 0,c)}_generateCollisionBoxes(){for(const o in this._sourceCaches){const c=this._sourceCaches[o];c.resume(),c.reload()}}_updatePlacement(o,c,m,v,b,A,M=!1){let O=!1,k=!1;const L={},U={};for(const j of this._mergedOrder){const $=this._mergedLayers[j];if($.type!=="symbol")continue;const Q=s.aC($.source,$.scope);let Z=L[Q];if(!Z){const ee=this.getLayerSourceCache($);if(!ee)continue;const ae=ee.getRenderableIds(!0).map(me=>ee.getTileByID(me));U[Q]=ae.slice(),Z=L[Q]=ae.sort((me,fe)=>fe.tileID.overscaledZ-me.tileID.overscaledZ||(me.tileID.isLessThan(fe.tileID)?-1:1))}const te=this.crossTileSymbolIndex.addLayer($,Z,c.center.lng,c.projection);O=O||te}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._mergedOrder),M=M||this._layerOrderChanged||v===0,this._layerOrderChanged&&this.fire(new s.z("neworder")),(M||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(s.q.now(),c.zoom))&&(this.pauseablePlacement=new R0(c,this._mergedOrder,M,m,v,b,this.placement,this.fog&&c.projection.supportsFog?this.fog.state:null,this._buildingIndex),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._mergedOrder,this._mergedLayers,L,U,this.map.painter.scaleFactor),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(s.q.now()),k=!0),O&&this.pauseablePlacement.placement.setStale()),k||O){this._buildingIndex.onNewFrame(c.zoom);for(let j=0;j<this._mergedOrder.length;j++){const $=this._mergedLayers[this._mergedOrder[j]];if($.type!=="symbol")continue;const Q=this.isLayerClipped($);this.placement.updateLayerOpacities($,L[s.aC($.source,$.scope)],j,Q?A:null)}}return{needsRerender:!this.pauseablePlacement.isDone()||this.placement.hasTransitions(s.q.now())}}_releaseSymbolFadeTiles(){for(const o in this._sourceCaches)this._sourceCaches[o].releaseSymbolFadeTiles()}addImport(o,c){this._checkLoaded();const m=this.stylesheet.imports=this.stylesheet.imports||[];if(m.findIndex(({id:b})=>b===o.id)!==-1)return void this.fire(new s.y(new Error(`Import with id '${o.id}' already exists in the map's style.`)));if(!c)return m.push(o),this._loadImports([o],!0);const v=m.findIndex(({id:b})=>b===c);return v===-1&&this.fire(new s.y(new Error(`Import with id "${c}" does not exist on this map.`))),this.stylesheet.imports=m.slice(0,v).concat(o).concat(m.slice(v)),this._loadImports([o],!0,c)}updateImport(o,c){this._checkLoaded();const m=this.stylesheet.imports||[],v=this.getImportIndex(o);return v===-1?this:typeof c=="string"?(this.setImportUrl(o,c),this):(c.url&&c.url!==m[v].url&&this.setImportUrl(o,c.url),s.bn(c.config,m[v].config)||this.setImportConfig(o,c.config,c.data.schema),s.bn(c.data,m[v].data)||this.setImportData(o,c.data),this)}moveImport(o,c){this._checkLoaded();let m=this.stylesheet.imports||[];const v=this.getImportIndex(o);if(v===-1)return this;const b=this.getImportIndex(c);if(b===-1)return this;const A=m[v],M=this.fragments[v];return m=m.filter(({id:O})=>O!==o),this.fragments=this.fragments.filter(({id:O})=>O!==o),this.stylesheet.imports=m.slice(0,b).concat(A).concat(m.slice(b)),this.fragments=this.fragments.slice(0,b).concat(M).concat(this.fragments.slice(b)),this.mergeLayers(),this}setImportUrl(o,c){this._checkLoaded();const m=this.stylesheet.imports||[],v=this.getImportIndex(o);if(v===-1)return this;m[v].url=c;const b=this.fragments[v];return b.style=this._createFragmentStyle(m[v]),b.style.on("style.import.load",()=>this.mergeAll()),b.style.loadURL(c),this}setImportData(o,c){this._checkLoaded();const m=this.getImportIndex(o),v=this.stylesheet.imports||[];return m===-1?this:c?(this.fragments[m].style.setState(c),this._reloadImports(),this):(delete v[m].data,this.setImportUrl(o,v[m].url))}setImportConfig(o,c,m){this._checkLoaded();const v=this.getImportIndex(o),b=this.stylesheet.imports||[];if(v===-1)return this;c?b[v].config=c:delete b[v].config;const A=this.fragments[v];m&&A.style.stylesheet&&(A.style.stylesheet.schema=m);const M=A.style.stylesheet&&A.style.stylesheet.schema;return A.config=c,A.style.updateConfig(c,M),this.updateConfigDependencies(),this}removeImport(o){this._checkLoaded();const c=this.stylesheet.imports||[],m=this.getImportIndex(o);m!==-1&&(c.splice(m,1),this.fragments[m].style._remove(),this.fragments.splice(m,1),this._reloadImports())}getImportIndex(o){const c=(this.stylesheet.imports||[]).findIndex(m=>m.id===o);return c===-1&&this.fire(new s.y(new Error(`Import '${o}' does not exist in the map's style and cannot be updated.`))),c}getLayer(o){return this._mergedLayers[o]}getSources(){const o=[];for(const c in this._mergedOtherSourceCaches){const m=this._mergedOtherSourceCaches[c];m&&o.push(m.getSource())}return o}getSource(o,c){const m=this.getSourceCache(o,c);return m&&m.getSource()}getLayerSource(o){const c=this.getLayerSourceCache(o);return c&&c.getSource()}getSourceCache(o,c){const m=s.aC(o,c);return this._mergedOtherSourceCaches[m]}getLayerSourceCache(o){const c=s.aC(o.source,o.scope);return o.type==="symbol"?this._mergedSymbolSourceCaches[c]:this._mergedOtherSourceCaches[c]}getSourceCaches(o){if(o==null)return Object.values(this._mergedSourceCaches);const c=[];return this._mergedOtherSourceCaches[o]&&c.push(this._mergedOtherSourceCaches[o]),this._mergedSymbolSourceCaches[o]&&c.push(this._mergedSymbolSourceCaches[o]),c}updateSourceCaches(){const o=this._changes.getUpdatedSourceCaches();for(const c in o){const m=o[c];m==="reload"?this.reloadSource(c):m==="clear"&&this.clearSource(c)}}updateLayers(o){const c=this._changes.getUpdatedPaintProperties();for(const m of c){const v=this.getLayer(m);v&&v.updateTransitions(o)}}getImages(o,c,m){this.imageManager.getImages(c.icons,c.scope,m),this._updateTilesForChangedImages();const v=b=>{b&&b.setDependencies(c.tileID.key,c.type,c.icons)};v(this._otherSourceCaches[c.source]),v(this._symbolSourceCaches[c.source])}rasterizeImages(o,c,m){this.imageManager.rasterizeImages(c,m)}getGlyphs(o,c,m){this.glyphManager.getGlyphs(c.stacks,c.scope,m)}getResource(o,c,m){return s.cy(c,m)}getOwnSourceCache(o){return this._otherSourceCaches[o]}getOwnLayerSourceCache(o){return o.type==="symbol"?this._symbolSourceCaches[o.source]:this._otherSourceCaches[o.source]}getOwnSourceCaches(o){const c=[];return this._otherSourceCaches[o]&&c.push(this._otherSourceCaches[o]),this._symbolSourceCaches[o]&&c.push(this._symbolSourceCaches[o]),c}_isSourceCacheLoaded(o){const c=this.getOwnSourceCaches(o);return c.length===0?(this.fire(new s.y(new Error(`There is no source with ID '${o}'`))),!1):c.every(m=>m.loaded())}has3DLayers(){return this._has3DLayers}hasSymbolLayers(){return this._hasSymbolLayers}hasCircleLayers(){return this._hasCircleLayers}isLayerClipped(o,c){if(!this._clipLayerPresent&&o.type!=="fill-extrusion")return!1;const m=o.type==="fill-extrusion"&&o.sourceLayer==="building";if(o.is3D()){if(m||c&&c.type==="batched-model"||o.type==="model")return!0}else if(o.type==="symbol")return!0;return!1}_clearWorkerCaches(){this.dispatcher.broadcast("clearCaches")}destroy(){this._clearWorkerCaches(),this.fragments.forEach(o=>{o.style._remove()}),this.terrainSetForDrapingOnly()&&(delete this.terrain,delete this.stylesheet.terrain)}}Es.getSourceType=function(p){return qr[p]},Es.setSourceType=function(p,o){qr[p]=o},Es.registerForPluginStateChange=s.ch;var Qu=`
#define EPSILON 0.0000001
#define PI 3.141592653589793
#ifdef RENDER_CUTOFF
float cutoff_opacity(vec4 cutoff_params,float depth) {float near=cutoff_params.x;float far=cutoff_params.y;float cutoffStart=cutoff_params.z;float cutoffEnd=cutoff_params.w;float linearDepth=(depth-near)/(far-near);return clamp((linearDepth-cutoffStart)/(cutoffEnd-cutoffStart),0.0,1.0);}
#endif`,Ec=`
out vec4 glFragColor;highp float unpack_depth(highp vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}highp vec4 pack_depth(highp float ndc_z) {highp float depth=ndc_z*0.5+0.5;const highp vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const highp vec4 bit_mask =vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);highp vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}
#ifdef INDICATOR_CUTOUT
uniform vec3 u_indicator_cutout_centers;uniform vec4 u_indicator_cutout_params;
#endif
vec4 applyCutout(vec4 color,float height) {
#ifdef INDICATOR_CUTOUT
float verticalFadeRange=u_indicator_cutout_centers.z*0.25;float holeMinOpacity=mix(1.0,u_indicator_cutout_params.x,smoothstep(u_indicator_cutout_centers.z,u_indicator_cutout_centers.z+verticalFadeRange,height));float holeRadius=max(u_indicator_cutout_params.y,0.0);float holeAspectRatio=u_indicator_cutout_params.z;float fadeStart=u_indicator_cutout_params.w;float distA=distance(vec2(gl_FragCoord.x,gl_FragCoord.y*holeAspectRatio),vec2(u_indicator_cutout_centers[0],u_indicator_cutout_centers[1]*holeAspectRatio));return color*min(smoothstep(fadeStart,holeRadius,distA)+holeMinOpacity,1.0);
#else
return color;
#endif
}
#ifdef DEBUG_WIREFRAME
#define HANDLE_WIREFRAME_DEBUG \\
glFragColor=vec4(0.7,0.0,0.0,0.7); \\
gl_FragDepth=gl_FragCoord.z-0.0001;
#else
#define HANDLE_WIREFRAME_DEBUG
#endif
#ifdef RENDER_CUTOFF
uniform highp vec4 u_cutoff_params;in float v_cutoff_opacity;
#endif
vec4 textureLodCustom(sampler2D image,highp vec2 pos,highp vec2 lod_coord) {highp vec2 size=vec2(textureSize(image,0));highp vec2 dx=dFdx(lod_coord.xy*size);highp vec2 dy=dFdy(lod_coord.xy*size);highp float delta_max_sqr=max(dot(dx,dx),dot(dy,dy));highp float lod=0.5*log2(delta_max_sqr);return textureLod(image,pos,lod);}vec4 applyLUT(highp sampler3D lut,vec4 col) {vec3 size=vec3(textureSize(lut,0));vec3 uvw=(col.rbg*float(size-1.0)+0.5)/size;return vec4(texture(lut,uvw).rgb,col.a);}vec3 applyLUT(highp sampler3D lut,vec3 col) {return applyLUT(lut,vec4(col,1.0)).rgb;}`,eh=`
#define EXTENT 8192.0
#define RAD_TO_DEG 180.0/PI
#define DEG_TO_RAD PI/180.0
#define GLOBE_RADIUS EXTENT/PI/2.0
float wrap(float n,float min,float max) {float d=max-min;float w=mod(mod(n-min,d)+d,d)+min;return (w==min) ? max : w;}
#ifdef PROJECTION_GLOBE_VIEW
vec3 mercator_tile_position(mat4 matrix,vec2 tile_anchor,vec3 tile_id,vec2 mercator_center) {
#ifndef PROJECTED_POS_ON_VIEWPORT
float tiles=tile_id.z;vec2 mercator=(tile_anchor/EXTENT+tile_id.xy)/tiles;mercator-=mercator_center;mercator.x=wrap(mercator.x,-0.5,0.5);vec4 mercator_tile=vec4(mercator.xy*EXTENT,EXTENT/(2.0*PI),1.0);mercator_tile=matrix*mercator_tile;return mercator_tile.xyz;
#else
return vec3(0.0);
#endif
}vec3 mix_globe_mercator(vec3 globe,vec3 mercator,float t) {return mix(globe,mercator,t);}mat3 globe_mercator_surface_vectors(vec3 pos_normal,vec3 up_dir,float zoom_transition) {vec3 normal=zoom_transition==0.0 ? pos_normal : normalize(mix(pos_normal,up_dir,zoom_transition));vec3 xAxis=normalize(vec3(normal.z,0.0,-normal.x));vec3 yAxis=normalize(cross(normal,xAxis));return mat3(xAxis,yAxis,normal);}
#endif
vec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(
unpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0
);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const vec2 units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (units_to_pixels*pos+offset)/pattern_size;}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {return get_pattern_pos(pixel_coord_upper,pixel_coord_lower,pattern_size,vec2(tile_units_to_pixels),pos);}float mercatorXfromLng(float lng) {return (180.0+lng)/360.0;}float mercatorYfromLat(float lat) {return (180.0-(RAD_TO_DEG*log(tan(PI/4.0+lat/2.0*DEG_TO_RAD))))/360.0;}vec3 latLngToECEF(vec2 latLng) {latLng=DEG_TO_RAD*latLng;float cosLat=cos(latLng[0]);float sinLat=sin(latLng[0]);float cosLng=cos(latLng[1]);float sinLng=sin(latLng[1]);float sx=cosLat*sinLng*GLOBE_RADIUS;float sy=-sinLat*GLOBE_RADIUS;float sz=cosLat*cosLng*GLOBE_RADIUS;return vec3(sx,sy,sz);}
#ifdef RENDER_CUTOFF
uniform vec4 u_cutoff_params;out float v_cutoff_opacity;
#endif
const vec4 AWAY=vec4(-1000.0,-1000.0,-1000.0,1);const float skirtOffset=24575.0;vec3 decomposeToPosAndSkirt(vec2 posWithComposedSkirt)
{float skirt=float(posWithComposedSkirt.x >=skirtOffset);vec2 pos=posWithComposedSkirt-vec2(skirt*skirtOffset,0.0);return vec3(pos,skirt);}`,ia="in highp vec3 a_pos_3f;uniform lowp mat4 u_matrix;out highp vec3 v_uv;void main() {const mat3 half_neg_pi_around_x=mat3(1.0,0.0, 0.0,0.0,0.0,-1.0,0.0,1.0, 0.0);v_uv=half_neg_pi_around_x*a_pos_3f;vec4 pos=u_matrix*vec4(a_pos_3f,1.0);gl_Position=pos.xyww;}",th=`
#define ELEVATION_SCALE 7.0
#define ELEVATION_OFFSET 450.0
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_tl_up;uniform vec3 u_tile_tr_up;uniform vec3 u_tile_br_up;uniform vec3 u_tile_bl_up;uniform float u_tile_up_scale;vec3 elevationVector(vec2 pos) {vec2 uv=pos/EXTENT;vec3 up=normalize(mix(
mix(u_tile_tl_up,u_tile_tr_up,uv.xxx),mix(u_tile_bl_up,u_tile_br_up,uv.xxx),uv.yyy));return up*u_tile_up_scale;}
#else
vec3 elevationVector(vec2 pos) { return vec3(0,0,1); }
#endif
#ifdef TERRAIN
uniform highp sampler2D u_dem;uniform highp sampler2D u_dem_prev;uniform vec2 u_dem_tl;uniform vec2 u_dem_tl_prev;uniform float u_dem_scale;uniform float u_dem_scale_prev;uniform float u_dem_size;uniform float u_dem_lerp;uniform float u_exaggeration;uniform float u_meter_to_dem;uniform mat4 u_label_plane_matrix_inv;vec4 tileUvToDemSample(vec2 uv,float dem_size,float dem_scale,vec2 dem_tl) {vec2 pos=dem_size*(uv*dem_scale+dem_tl)+1.0;vec2 f=fract(pos);return vec4((pos-f+0.5)/(dem_size+2.0),f);}float currentElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale+u_dem_tl)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem,pos).r;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale,u_dem_tl);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(dd,0)).r;float bl=texture(u_dem,pos+vec2(0,dd)).r;float br=texture(u_dem,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}float prevElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale_prev+u_dem_tl_prev)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem_prev,pos).r;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale_prev,u_dem_tl_prev);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem_prev,pos).r;float tr=texture(u_dem_prev,pos+vec2(dd,0)).r;float bl=texture(u_dem_prev,pos+vec2(0,dd)).r;float br=texture(u_dem_prev,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}
#ifdef TERRAIN_VERTEX_MORPHING
float elevation(vec2 apos) {
#ifdef ZERO_EXAGGERATION
return 0.0;
#endif
float nextElevation=currentElevation(apos);float prevElevation=prevElevation(apos);return mix(prevElevation,nextElevation,u_dem_lerp);}
#else
float elevation(vec2 apos) {
#ifdef ZERO_EXAGGERATION
return 0.0;
#endif
return currentElevation(apos);}
#endif
vec4 fourSample(vec2 pos,vec2 off) {float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(off.x,0.0)).r;float bl=texture(u_dem,pos+vec2(0.0,off.y)).r;float br=texture(u_dem,pos+off).r;return vec4(tl,tr,bl,br);}float flatElevation(vec2 pack) {vec2 apos=floor(pack/8.0);vec2 span=10.0*(pack-apos*8.0);vec2 uvTex=(apos-vec2(1.0,1.0))/8190.0;float size=u_dem_size+2.0;float dd=1.0/size;vec2 pos=u_dem_size*(uvTex*u_dem_scale+u_dem_tl)+1.0;vec2 f=fract(pos);pos=(pos-f+0.5)*dd;vec4 h=fourSample(pos,vec2(dd));float z=mix(mix(h.x,h.y,f.x),mix(h.z,h.w,f.x),f.y);vec2 w=floor(0.5*(span*u_meter_to_dem-1.0));vec2 d=dd*w;h=fourSample(pos-d,2.0*d+vec2(dd));vec4 diff=abs(h.xzxy-h.ywzw);vec2 slope=min(vec2(0.25),u_meter_to_dem*0.5*(diff.xz+diff.yw)/(2.0*w+vec2(1.0)));vec2 fix=slope*span;float base=z+max(fix.x,fix.y);return u_exaggeration*base;}float elevationFromUint16(float word) {return u_exaggeration*(word/ELEVATION_SCALE-ELEVATION_OFFSET);}
#else
float elevation(vec2 pos) { return 0.0; }
#endif
#ifdef DEPTH_OCCLUSION
uniform highp sampler2D u_depth;uniform highp vec2 u_depth_size_inv;uniform highp vec2 u_depth_range_unpack;uniform highp float u_occluder_half_size;uniform highp float u_occlusion_depth_offset;
#ifdef DEPTH_D24
float unpack_depth(float depth) {return depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}vec4 unpack_depth4(vec4 depth) {return depth*u_depth_range_unpack.x+vec4(u_depth_range_unpack.y);}
#else
highp float unpack_depth_rgba(vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}
#endif
bool isOccluded(vec4 frag) {vec3 coord=frag.xyz/frag.w;
#ifdef DEPTH_D24
float depth=unpack_depth(texture(u_depth,(coord.xy+1.0)*0.5).r);
#else
float depth=unpack_depth_rgba(texture(u_depth,(coord.xy+1.0)*0.5));
#endif
return coord.z+u_occlusion_depth_offset > depth;}highp vec4 getCornerDepths(vec2 coord) {highp vec3 df=vec3(u_occluder_half_size*u_depth_size_inv,0.0);highp vec2 uv=0.5*coord.xy+0.5;
#ifdef DEPTH_D24
highp vec4 depth=vec4(
texture(u_depth,uv-df.xz).r,texture(u_depth,uv+df.xz).r,texture(u_depth,uv-df.zy).r,texture(u_depth,uv+df.zy).r
);depth=unpack_depth4(depth);
#else
highp vec4 depth=vec4(
unpack_depth_rgba(texture(u_depth,uv-df.xz)),unpack_depth_rgba(texture(u_depth,uv+df.xz)),unpack_depth_rgba(texture(u_depth,uv-df.zy)),unpack_depth_rgba(texture(u_depth,uv+df.zy))
);
#endif
return depth;}highp float occlusionFadeMultiSample(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;highp vec2 uv=0.5*coord.xy+0.5;int NX=3;int NY=4;highp vec2 df=u_occluder_half_size*u_depth_size_inv;highp vec2 oneStep=2.0*u_occluder_half_size*u_depth_size_inv/vec2(NX-1,NY-1);highp float res=0.0;for (int y=0; y < NY;++y) {for (int x=0; x < NX;++x) {
#ifdef DEPTH_D24
highp float depth=unpack_depth(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)).r);
#else
highp float depth=unpack_depth_rgba(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)));
#endif
res+=1.0-clamp(300.0*(coord.z+u_occlusion_depth_offset-depth),0.0,1.0);}}res=clamp(2.0*res/float(NX*NY)-0.5,0.0,1.0);return res;}highp float occlusionFade(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;highp vec4 depth=getCornerDepths(coord.xy);return dot(vec4(0.25),vec4(1.0)-clamp(300.0*(vec4(coord.z+u_occlusion_depth_offset)-depth),0.0,1.0));}
#else
bool isOccluded(vec4 frag) { return false; }highp float occlusionFade(vec4 frag) { return 1.0; }highp float occlusionFadeMultiSample(vec4 frag) { return 1.0; }
#endif//DEPTH_OCCLUSION`,tf=`#ifdef FOG
uniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump mat4 u_fog_matrix;out vec3 v_fog_pos;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}vec3 fog_position(vec3 pos) {return (u_fog_matrix*vec4(pos,1.0)).xyz;}vec3 fog_position(vec2 pos) {return fog_position(vec3(pos,0.0));}float fog(vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));return opacity*fog_horizon_blending(pos/depth);}
#endif`,Da=`#ifdef FOG
uniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump vec2 u_fog_vertical_limit;uniform mediump float u_fog_temporal_offset;in vec3 v_fog_pos;uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform highp vec2 u_viewport;uniform float u_globe_transition;uniform int u_is_globe;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}float globe_glow_progress() {highp vec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float sdf=length(closest_point-u_globe_pos)/u_globe_radius;return sdf+PI*0.5;}float fog_opacity(vec3 pos) {float depth=length(pos);return fog_opacity(fog_range(depth));}vec3 fog_apply(vec3 color,vec3 pos,float opacity_limit) {float depth=length(pos);float opacity;if (u_is_globe==1) {float glow_progress=globe_glow_progress();float t=mix(glow_progress,depth,u_globe_transition);opacity=fog_opacity(fog_range(t));} else {opacity=fog_opacity(fog_range(depth));opacity*=fog_horizon_blending(pos/depth);}return mix(color,u_fog_color.rgb,min(opacity,opacity_limit));}vec3 fog_apply(vec3 color,vec3 pos) {return fog_apply(color,pos,1.0);}vec4 fog_apply_from_vert(vec4 color,float fog_opac) {float alpha=EPSILON+color.a;color.rgb=mix(color.rgb/alpha,u_fog_color.rgb,fog_opac)*alpha;return color;}vec3 fog_apply_sky_gradient(vec3 camera_ray,vec3 sky_color) {float horizon_blend=fog_horizon_blending(normalize(camera_ray));return mix(sky_color,u_fog_color.rgb,horizon_blend);}vec4 fog_apply_premultiplied(vec4 color,vec3 pos) {float alpha=EPSILON+color.a;color.rgb=fog_apply(color.rgb/alpha,pos)*alpha;return color;}vec4 fog_apply_premultiplied(vec4 color,vec3 pos,float heightMeters) {float verticalProgress=(u_fog_vertical_limit.x > 0.0 || u_fog_vertical_limit.y > 0.0) ? smoothstep(u_fog_vertical_limit.x,u_fog_vertical_limit.y,heightMeters) : 0.0;float opacityLimit=1.0-smoothstep(0.9,1.0,fog_opacity(pos));return mix(fog_apply_premultiplied(color,pos),color,min(verticalProgress,opacityLimit));}vec3 fog_dither(vec3 color) {return color;}vec4 fog_dither(vec4 color) {return vec4(fog_dither(color.rgb),color.a);}
#endif`,ml=`#ifdef RASTER_ARRAY
uniform highp sampler2D u_image0;uniform sampler2D u_image1;const vec4 NODATA=vec4(1);ivec4 _raTexLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}vec2 _raTexLinearMix(highp vec2 fxy,highp vec4 colorMix,highp float colorOffset,highp vec4 t00,highp vec4 t10,highp vec4 t01,highp vec4 t11) {vec2 c00=t00==NODATA ? vec2(0) : vec2(colorOffset+dot(t00,colorMix),1);vec2 c10=t10==NODATA ? vec2(0) : vec2(colorOffset+dot(t10,colorMix),1);vec2 c01=t01==NODATA ? vec2(0) : vec2(colorOffset+dot(t01,colorMix),1);vec2 c11=t11==NODATA ? vec2(0) : vec2(colorOffset+dot(t11,colorMix),1);return mix(mix(c01,c11,fxy.x),mix(c00,c10,fxy.x),fxy.y);}vec2 raTexture2D_image0_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image0,c.yz,0),texelFetch(u_image0,c.xz,0),texelFetch(u_image0,c.yw,0),texelFetch(u_image0,c.xw,0)
);}vec2 raTexture2D_image1_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image1,c.yz,0),texelFetch(u_image1,c.xz,0),texelFetch(u_image1,c.yw,0),texelFetch(u_image1,c.xw,0)
);}vec2 raTexture2D_image0_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image0,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}vec2 raTexture2D_image1_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image1,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}
#endif`,Sc=`#ifdef RASTER_ARRAY
uniform sampler2D u_velocity;uniform mediump vec2 u_velocity_res;uniform mediump float u_max_speed;const vec4 NO_DATA=vec4(1);const vec2 INVALID_VELOCITY=vec2(-1);uniform highp vec2 u_uv_offset;uniform highp float u_data_offset;uniform highp vec2 u_data_scale;ivec4 rasterArrayLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}highp vec2 lookup_velocity(highp vec2 uv) {uv=u_uv_offset.x+u_uv_offset.y*uv;highp vec2 fxy;ivec4 c=rasterArrayLinearCoord(uv,u_velocity_res,fxy);highp vec4 tl=texelFetch(u_velocity,c.yz,0);highp vec4 tr=texelFetch(u_velocity,c.xz,0);highp vec4 bl=texelFetch(u_velocity,c.yw,0);highp vec4 br=texelFetch(u_velocity,c.xw,0);if (tl==NO_DATA) {return INVALID_VELOCITY;}if (tr==NO_DATA) {return INVALID_VELOCITY;}if (bl==NO_DATA) {return INVALID_VELOCITY;}if (br==NO_DATA) {return INVALID_VELOCITY;}highp vec4 t=mix(mix(bl,br,fxy.x),mix(tl,tr,fxy.x),fxy.y);highp vec2 velocity=u_data_offset+vec2(dot(t.rg,u_data_scale),dot(t.ba,u_data_scale));velocity.y=-velocity.y;velocity/=max(u_max_speed,length(velocity));return velocity;}
#endif
uniform highp float u_particle_pos_scale;uniform highp vec2 u_particle_pos_offset;highp vec4 pack_pos_to_rgba(highp vec2 p) {highp vec2 v=(p+u_particle_pos_offset)/u_particle_pos_scale;highp vec4 r=vec4(v.x,fract(v.x*255.0),v.y,fract(v.y*255.0));return vec4(r.x-r.y/255.0,r.y,r.z-r.w/255.0,r.w);}highp vec2 unpack_pos_from_rgba(highp vec4 v) {v=floor(v*255.0+0.5)/255.0;highp vec2 p=vec2(v.x+(v.y/255.0),v.z+(v.w/255.0));return u_particle_pos_scale*p-u_particle_pos_offset;}`,Ic=`#ifdef RENDER_SHADOWS
uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_normal_offset;vec3 shadow_normal_offset(vec3 normal) {float tileInMeters=u_shadow_normal_offset[0];vec3 n=vec3(-normal.xy,tileInMeters*normal.z);float dotScale=min(1.0-dot(normal,u_shadow_direction),1.0)*0.5+0.5;return n*dotScale;}vec3 shadow_normal_offset_model(vec3 normal) {vec3 transformed_normal=vec3(-normal.xy,normal.z);float NDotL=dot(normalize(transformed_normal),u_shadow_direction);float dotScale=min(1.0-NDotL,1.0)*0.5+0.5;return normal*dotScale;}float shadow_normal_offset_multiplier0() {return u_shadow_normal_offset[1];}float shadow_normal_offset_multiplier1() {return u_shadow_normal_offset[2];}
#endif//RENDER_SHADOWS`,Oa=`#ifdef RENDER_SHADOWS
#ifdef DEPTH_TEXTURE
uniform highp sampler2D u_shadowmap_0;uniform highp sampler2D u_shadowmap_1;
#else
uniform sampler2D u_shadowmap_0;uniform sampler2D u_shadowmap_1;
#endif
uniform float u_shadow_intensity;uniform float u_shadow_map_resolution;uniform float u_shadow_texel_size;uniform highp vec3 u_shadow_normal_offset;uniform vec2 u_fade_range;uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_bias;highp float shadow_sample_1(highp vec2 uv,highp float compare) {highp float shadow_depth;
#ifdef DEPTH_TEXTURE
shadow_depth=texture(u_shadowmap_1,uv).r;
#else
shadow_depth=unpack_depth(texture(u_shadowmap_1,uv))*0.5+0.5;
#endif
return step(shadow_depth,compare);}highp float shadow_sample_0(highp vec2 uv,highp float compare) {highp float shadow_depth;
#ifdef DEPTH_TEXTURE
shadow_depth=texture(u_shadowmap_0,uv).r;
#else
shadow_depth=unpack_depth(texture(u_shadowmap_0,uv))*0.5+0.5;
#endif
return step(shadow_depth,compare);}float shadow_occlusion_1(highp vec4 pos,highp float bias) {highp vec2 uv=pos.xy;return shadow_sample_1(uv,pos.z-bias);}float shadow_occlusion_0(highp vec4 pos,highp float bias) {highp float compare0=pos.z-bias;
#ifdef TEXTURE_GATHER
highp vec2 uv=pos.xy;highp vec4 samples=textureGather(u_shadowmap_0,uv,0);lowp vec4 stepSamples=step(samples,vec4(compare0));
#else
highp vec2 uv00=pos.xy-vec2(0.5*u_shadow_texel_size);highp vec2 uv10=uv00+vec2(u_shadow_texel_size,0.0);highp vec2 uv01=uv00+vec2(0.0,u_shadow_texel_size);highp vec2 uv11=uv01+vec2(u_shadow_texel_size,0.0);lowp vec4 stepSamples=vec4(
shadow_sample_0(uv01,compare0),shadow_sample_0(uv11,compare0),shadow_sample_0(uv10,compare0),shadow_sample_0(uv00,compare0)
);
#endif
vec2 f=fract(pos.xy*u_shadow_map_resolution-vec2(0.5));lowp vec2 lerpx=mix(stepSamples.wx,stepSamples.zy,f.xx);return mix(lerpx.x,lerpx.y,f.y);}float shadow_occlusion(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,highp float bias) {
#ifdef SHADOWS_SINGLE_CASCADE
light_view_pos0.xyz/=light_view_pos0.w;vec2 abs_bounds=abs(light_view_pos0.xy);if (abs_bounds.x >=1.0 || abs_bounds.y >=1.0) {return 0.0;}light_view_pos0.xyz=light_view_pos0.xyz*0.5+0.5;return shadow_occlusion_0(light_view_pos0,bias);
#else
light_view_pos0.xyz/=light_view_pos0.w;light_view_pos1.xyz/=light_view_pos1.w;vec4 uv=vec4(light_view_pos0.xy,light_view_pos1.xy);vec4 abs_bounds=abs(uv);if (abs_bounds.x < 1.0 && abs_bounds.y < 1.0) {light_view_pos0.xyz=light_view_pos0.xyz*0.5+0.5;return shadow_occlusion_0(light_view_pos0,bias);}if (abs_bounds.z >=1.0 || abs_bounds.w >=1.0) {return 0.0;}light_view_pos1.xyz=light_view_pos1.xyz*0.5+0.5;float occlusion1=shadow_occlusion_1(light_view_pos1,bias);return mix(occlusion1,0.0,smoothstep(u_fade_range.x,u_fade_range.y,view_depth));
#endif
}highp float calculate_shadow_bias(float NDotL) {
#ifdef NORMAL_OFFSET
return 0.5*u_shadow_bias.x;
#else
return 0.5*(u_shadow_bias.x+clamp(u_shadow_bias.y*tan(acos(NDotL)),0.0,u_shadow_bias.z));
#endif
}float shadowed_light_factor_normal(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_opacity(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,float shadow_opacity) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias)*shadow_opacity;return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_unbiased(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}highp vec2 compute_receiver_plane_depth_bias(highp vec3 pos_dx,highp vec3 pos_dy)
{highp vec2 biasUV=vec2(
pos_dy.y*pos_dx.z-pos_dx.y*pos_dy.z,pos_dx.x*pos_dy.z-pos_dy.x*pos_dx.z);biasUV*=1.0/((pos_dx.x*pos_dy.y)-(pos_dx.y*pos_dy.x));return biasUV;}float shadowed_light_factor_plane_bias(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {highp vec3 light_view_pos0_xyz=light_view_pos0.xyz/light_view_pos0.w*0.5+0.5;highp vec3 light_view_pos0_ddx=dFdx(light_view_pos0_xyz);highp vec3 light_view_pos0_ddy=dFdy(light_view_pos0_xyz);highp vec2 plane_depth_bias=compute_receiver_plane_depth_bias(light_view_pos0_ddx,light_view_pos0_ddy);highp float bias=dot(vec2(u_shadow_texel_size,u_shadow_texel_size),plane_depth_bias)+0.0001;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadowed_light_factor(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadow_occlusion(float ndotl,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=calculate_shadow_bias(ndotl);return shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);}
#endif`;const Fa=[];ka(Qu,Fa),ka(eh,Fa),ka(Ec,Fa);const _l={"_prelude_fog.vertex.glsl":tf,"_prelude_terrain.vertex.glsl":th,"_prelude_shadow.vertex.glsl":Ic,"_prelude_fog.fragment.glsl":Da,"_prelude_shadow.fragment.glsl":Oa,"_prelude_lighting.glsl":`
#ifdef LIGHTING_3D_MODE
uniform mediump vec3 u_lighting_ambient_color;uniform mediump vec3 u_lighting_directional_dir;uniform mediump vec3 u_lighting_directional_color;uniform mediump vec3 u_ground_radiance;float calculate_ambient_directional_factor(vec3 normal) {float NdotL=dot(normal,u_lighting_directional_dir);const float factor_reduction_max=0.3;float dir_luminance=dot(u_lighting_directional_color,vec3(0.2126,0.7152,0.0722));float directional_factor_min=1.0-factor_reduction_max*min(dir_luminance,1.0);float ambient_directional_factor=mix(directional_factor_min,1.0,min((NdotL+1.0),1.0));const float vertical_factor_min=0.92;float vertical_factor=mix(vertical_factor_min,1.0,normal.z*0.5+0.5);return vertical_factor*ambient_directional_factor;}vec3 linearProduct(vec3 srgbIn,vec3 k) {return srgbIn*pow(k,vec3(1./2.2));}vec3 apply_lighting(vec3 color,vec3 normal,float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return linearProduct(color,ambient_contrib+directional_contrib);}vec4 apply_lighting(vec4 color,vec3 normal,float dir_factor) {return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting(vec3 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return apply_lighting(color.rgb,normal,dir_factor);}vec4 apply_lighting(vec4 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting_ground(vec3 color) {return color*u_ground_radiance;}vec4 apply_lighting_ground(vec4 color) {return vec4(apply_lighting_ground(color.rgb),color.a);}float calculate_NdotL(vec3 normal) {const float ext=0.70710678118;return (clamp(dot(normal,u_lighting_directional_dir),-ext,1.0)+ext)/(1.0+ext);}vec4 apply_lighting_with_emission_ground(vec4 color,float emissive_strength) {return mix(apply_lighting_ground(color),color,emissive_strength);}vec3 compute_flood_lighting(vec3 flood_light_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=flood_light_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);float occlusion_ramp=smoothstep(0.0,0.2,1.0-occlusion);return mix(fully_occluded_color,flood_light_color,occlusion_ramp);}vec3 compute_emissive_draped(vec3 unlit_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=unlit_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);return mix(fully_occluded_color,unlit_color,1.0-occlusion);}
#endif//LIGHTING_3D_MODE`,"_prelude_raster_array.glsl":ml,"_prelude_raster_particle.glsl":Sc},Cc={};Mi("",th),Mi(Da,tf),Mi(Oa,Ic),Mi(ml,""),Mi(Sc,"");const ih=Mi(Ec,eh),Mc=Qu;var gl={background:Mi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec4 u_color;uniform float u_opacity;
#ifdef LIGHTING_3D_MODE
in vec4 v_color;
#endif
void main() {vec4 out_color;
#ifdef LIGHTING_3D_MODE
out_color=v_color;
#else
out_color=u_color;
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_lighting.glsl"
in vec2 a_pos;uniform mat4 u_matrix;
#ifdef LIGHTING_3D_MODE
uniform mediump vec4 u_color;out vec4 v_color;uniform float u_emissive_strength;
#endif
void main() {gl_Position=u_matrix*vec4(a_pos,0,1);
#ifdef LIGHTING_3D_MODE
v_color=apply_lighting_with_emission_ground(u_color,u_emissive_strength);
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),backgroundPattern:Mi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec2 u_pattern_tl;uniform vec2 u_pattern_br;uniform vec2 u_texsize;uniform float u_opacity;uniform float u_emissive_strength;uniform sampler2D u_image;in highp vec2 v_pos;void main() {highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(u_pattern_tl/u_texsize,u_pattern_br/u_texsize,imagecoord);vec4 out_color=textureLodCustom(u_image,pos,v_pos);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_pattern_size;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec2 u_pattern_units_to_pixels;in vec2 a_pos;out highp vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_pattern_size,u_pattern_units_to_pixels,a_pos);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),circle:Mi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
in vec3 v_data;in float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
uniform float u_emissive_strength;void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=v_data.xy;float blur_positive=blur < 0.0 ? 0.0 : 1.0;lowp float antialiasblur=v_data.z;float extrude_length=length(extrude)+antialiasblur*(1.0-blur_positive);float antialiased_blur=-max(abs(blur),antialiasblur);float antialiase_blur_opacity=smoothstep(0.0,antialiasblur,extrude_length-1.0);float opacity_t=blur_positive==1.0 ? 
smoothstep(0.0,-antialiased_blur,1.0-extrude_length) : 
smoothstep(antialiased_blur,0.0,extrude_length-1.0)-antialiase_blur_opacity;float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(
antialiased_blur,0.0,extrude_length-radius/(radius+stroke_width)
);vec4 out_color=mix(color*opacity,stroke_color*stroke_opacity,color_t);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_apply_premultiplied(out_color,v_fog_pos);
#endif
glFragColor=out_color*(v_visibility*opacity_t);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define NUM_VISIBILITY_RINGS 2
#define INV_SQRT2 0.70710678
#define ELEVATION_BIAS 0.0001
#define NUM_SAMPLES_PER_RING 16
uniform mat4 u_matrix;uniform mat2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
#ifdef ELEVATED_ROADS
in float a_circle_z_offset;
#endif
out vec3 v_data;out float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
vec2 calc_offset(vec2 extrusion,float radius,float stroke_width, float view_scale) {return extrusion*(radius+stroke_width)*u_extrude_scale*view_scale;}float cantilevered_elevation(vec2 pos,float radius,float stroke_width,float view_scale) {vec2 c1=pos+calc_offset(vec2(-1,-1),radius,stroke_width,view_scale);vec2 c2=pos+calc_offset(vec2(1,-1),radius,stroke_width,view_scale);vec2 c3=pos+calc_offset(vec2(1,1),radius,stroke_width,view_scale);vec2 c4=pos+calc_offset(vec2(-1,1),radius,stroke_width,view_scale);float h1=elevation(c1)+ELEVATION_BIAS;float h2=elevation(c2)+ELEVATION_BIAS;float h3=elevation(c3)+ELEVATION_BIAS;float h4=elevation(c4)+ELEVATION_BIAS;return max(h4,max(h3,max(h1,h2)));}float circle_elevation(vec2 pos) {
#if defined(TERRAIN)
return elevation(pos)+ELEVATION_BIAS;
#else
return 0.0;
#endif
}vec4 project_vertex(vec2 extrusion,vec4 world_center,vec4 projected_center,float radius,float stroke_width, float view_scale,mat3 surface_vectors) {vec2 sample_offset=calc_offset(extrusion,radius,stroke_width,view_scale);
#ifdef PITCH_WITH_MAP
#ifdef PROJECTION_GLOBE_VIEW
return u_matrix*( world_center+vec4(sample_offset.x*surface_vectors[0]+sample_offset.y*surface_vectors[1],0) );
#else
return u_matrix*( world_center+vec4(sample_offset,0,0) );
#endif
#else
return projected_center+vec4(sample_offset,0,0);
#endif
}float get_sample_step() {
#ifdef PITCH_WITH_MAP
return 2.0*PI/float(NUM_SAMPLES_PER_RING);
#else
return PI/float(NUM_SAMPLES_PER_RING);
#endif
}void main(void) {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);vec4 world_center;mat3 surface_vectors;
#ifdef PROJECTION_GLOBE_VIEW
vec3 pos_normal_3=a_pos_normal_3/16384.0;surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(circle_center)*circle_elevation(circle_center);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*circle_elevation(circle_center);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,circle_center,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;vec3 pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);world_center=vec4(pos,1);
#else 
surface_vectors=mat3(1.0);float height=circle_elevation(circle_center);world_center=vec4(circle_center,height,1);
#endif
#ifdef ELEVATED_ROADS
world_center.z+=a_circle_z_offset+ELEVATION_BIAS;
#endif
vec4 projected_center=u_matrix*world_center;float view_scale=0.0;
#ifdef PITCH_WITH_MAP
#ifdef SCALE_WITH_MAP
view_scale=1.0;
#else
view_scale=projected_center.w/u_camera_to_center_distance;
#endif
#else
#ifdef SCALE_WITH_MAP
view_scale=u_camera_to_center_distance;
#else
view_scale=projected_center.w;
#endif
#endif
gl_Position=project_vertex(extrude,world_center,projected_center,radius,stroke_width,view_scale,surface_vectors);float visibility=0.0;
#ifdef TERRAIN
float step=get_sample_step();vec4 occlusion_world_center;vec4 occlusion_projected_center;
#ifdef PITCH_WITH_MAP
float cantilevered_height=cantilevered_elevation(circle_center,radius,stroke_width,view_scale);occlusion_world_center=vec4(circle_center,cantilevered_height,1);occlusion_projected_center=u_matrix*occlusion_world_center;
#else
occlusion_world_center=world_center;occlusion_projected_center=projected_center;
#endif
for(int ring=0; ring < NUM_VISIBILITY_RINGS; ring++) {float scale=(float(ring)+1.0)/float(NUM_VISIBILITY_RINGS);for(int i=0; i < NUM_SAMPLES_PER_RING; i++) {vec2 extrusion=vec2(cos(step*float(i)),-sin(step*float(i)))*scale;vec4 frag_pos=project_vertex(extrusion,occlusion_world_center,occlusion_projected_center,radius,stroke_width,view_scale,surface_vectors);visibility+=float(!isOccluded(frag_pos));}}visibility/=float(NUM_VISIBILITY_RINGS)*float(NUM_SAMPLES_PER_RING);
#else
visibility=1.0;
#endif
#ifdef PROJECTION_GLOBE_VIEW
visibility=1.0;
#endif
v_visibility=visibility;lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);
#ifdef FOG
v_fog_pos=fog_position(world_center.xyz);
#endif
}`),clippingMask:Mi("void main() {glFragColor=vec4(1.0);}","in vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:Mi(`#include "_prelude_fog.fragment.glsl"
uniform highp float u_intensity;in vec2 v_extrude;
#pragma mapbox: define highp float weight
#define GAUSS_COEF 0.3989422804014327
void main() {
#pragma mapbox: initialize highp float weight
float d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);glFragColor=vec4(val,1.0,1.0,1.0);
#ifdef FOG
if (u_is_globe==0) {glFragColor.r*=pow(1.0-fog_opacity(v_fog_pos),2.0);}
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_terrain.vertex.glsl"
#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
out vec2 v_extrude;
#pragma mapbox: define highp float weight
#pragma mapbox: define mediump float radius
const highp float ZERO=1.0/255.0/16.0;
#define GAUSS_COEF 0.3989422804014327
void main(void) {
#pragma mapbox: initialize highp float weight
#pragma mapbox: initialize mediump float radius
vec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 tilePos=floor(a_pos*0.5);vec3 pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 pos_normal_3=a_pos_normal_3/16384.0;mat3 surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(tilePos)*elevation(tilePos);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*elevation(tilePos);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,tilePos,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#else
pos=vec3(tilePos+extrude,elevation(tilePos));
#endif
gl_Position=u_matrix*vec4(pos,1);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),heatmapTexture:Mi(`uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;in vec2 v_pos;void main() {float t=texture(u_image,v_pos).r;vec4 color=texture(u_color_ramp,vec2(t,0.5));glFragColor=color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(0.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,"in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=vec4(a_pos,0,1);v_pos=a_pos*0.5+0.5;}"),collisionBox:Mi("in float v_placed;in float v_notUsed;void main() {vec4 red =vec4(1.0,0.0,0.0,1.0);vec4 blue=vec4(0.0,0.0,1.0,0.5);glFragColor =mix(red,blue,step(0.5,v_placed))*0.5;glFragColor*=mix(1.0,0.1,step(0.5,v_notUsed));}",`#include "_prelude_terrain.vertex.glsl"
in vec3 a_pos;in vec2 a_anchor_pos;in vec2 a_extrude;in vec2 a_placed;in vec2 a_shift;in vec2 a_elevation_from_sea;in float a_size_scale;in vec2 a_padding;in float a_auto_z_offset;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;out float v_placed;out float v_notUsed;void main() {float feature_elevation=a_elevation_from_sea.x+a_auto_z_offset;float terrain_elevation=(a_elevation_from_sea.y==1.0 ? 0.0 : elevation(a_anchor_pos));vec4 projectedPoint=u_matrix*vec4(a_pos+elevationVector(a_anchor_pos)*(feature_elevation+terrain_elevation),1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,1.5);gl_Position=projectedPoint;gl_Position.xy+=(a_extrude*a_size_scale+a_shift+a_padding)*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}`),collisionCircle:Mi("in float v_radius;in vec2 v_extrude;in float v_perspective_ratio;in float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);glFragColor=color*alpha*opacity_t;}",`in vec2 a_pos_2f;in float a_radius;in vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;out float v_radius;out vec2 v_extrude;out float v_perspective_ratio;out float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos_2f;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(
mix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}`),debug:Mi("uniform highp vec4 u_color;uniform sampler2D u_overlay;in vec2 v_uv;void main() {vec4 overlay_color=texture(u_overlay,v_uv);glFragColor=mix(u_color,overlay_color,overlay_color.a);}",`#include "_prelude_terrain.vertex.glsl"
in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;
#endif
out vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {float h=elevation(a_pos);v_uv=a_pos/8192.0;
#ifdef PROJECTION_GLOBE_VIEW
gl_Position=u_matrix*vec4(a_pos_3+elevationVector(a_pos)*h,1);
#else
gl_Position=u_matrix*vec4(a_pos*u_overlay_scale,h,1);
#endif
}`),fill:Mi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#endif
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
vec4 out_color=color;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
out_color*=opacity;
#ifdef INDICATOR_CUTOUT
if (v_z_offset >=0.0) {out_color=applyCutout(out_color,v_z_offset);}
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#endif
uniform mat4 u_matrix;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp float z_offset
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=z_offset;
#endif
}`),fillOutline:Mi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
in highp vec2 v_pos;uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=outline_color;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
uniform mat4 u_matrix;uniform vec2 u_world;out highp vec2 v_pos;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp float z_offset
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillOutlinePattern:Mi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
in highp vec2 v_pos;in highp vec2 v_pos_world;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);float dist=length(v_pos_world-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
out highp vec2 v_pos;out highp vec2 v_pos_world;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#pragma mapbox: define lowp float pixel_ratio
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize lowp float pixel_ratio
#pragma mapbox: initialize highp float z_offset
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);v_pos_world=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillPattern:Mi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;in highp vec2 v_pos;uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
out highp vec2 v_pos;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#pragma mapbox: define lowp float pixel_ratio
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize lowp float pixel_ratio
#pragma mapbox: initialize highp float z_offset
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillExtrusion:Mi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
in vec4 v_color;in vec4 v_flat;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;
#endif
uniform lowp float u_opacity;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;in vec2 v_ao;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
in vec4 v_roof_color;
#endif
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
in highp vec3 v_normal;
#endif
uniform vec3 u_flood_light_color;uniform highp float u_vertical_scale;uniform float u_flood_light_intensity;uniform vec3 u_ground_shadow_factor;
#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)
in float v_flood_radius;in float v_has_floodlight;
#endif
in float v_height;
#pragma mapbox: define highp float emissive_strength
void main() {
#pragma mapbox: initialize highp float emissive_strength
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
vec3 normal=normalize(v_normal);
#endif
float z;vec4 color=v_color;
#ifdef ZERO_ROOF_RADIUS
z=float(normal.z > 0.00001);
#ifdef LIGHTING_3D_MODE
normal=mix(normal,vec3(0.0,0.0,1.0),z);
#else
color=mix(v_color,v_roof_color,z);
#endif
#endif
float h=max(0.0,v_height);float ao_shade=1.0;
#ifdef FAUX_AO
float intensity=u_ao[0];float h_floors=h/(u_ao[1]*u_vertical_scale);float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);ao_shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;
#ifdef ZERO_ROOF_RADIUS
concave*=(1.0-z);
#endif
float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);ao_shade*=mix(1.0,x_shade*x_shade*x_shade,concave);
#ifdef LIGHTING_3D_MODE
#ifdef FLOOD_LIGHT
color.rgb*=mix(ao_shade,1.0,v_has_floodlight);
#else
color.rgb*=ao_shade;
#endif
#else
color.rgb*=ao_shade;
#endif
#endif
#ifdef LIGHTING_3D_MODE
float flood_radiance=0.0;
#ifdef FLOOD_LIGHT
flood_radiance=(1.0-min(h/v_flood_radius,1.0))*u_flood_light_intensity*v_has_floodlight;
#endif
#ifdef RENDER_SHADOWS
#ifdef FLOOD_LIGHT
float ndotl_unclamped=dot(normal,u_shadow_direction);float ndotl=max(0.0,ndotl_unclamped);float occlusion=ndotl_unclamped < 0.0 ? 1.0 : shadow_occlusion(ndotl,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 litColor=apply_lighting(color.rgb,normal,(1.0-u_shadow_intensity*occlusion)*ndotl);vec3 floodLitColor=compute_flood_lighting(u_flood_light_color*u_opacity,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=mix(litColor,floodLitColor,flood_radiance);
#else
float shadowed_lighting_factor;
#ifdef RENDER_CUTOFF
shadowed_lighting_factor=shadowed_light_factor_normal_opacity(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,v_cutoff_opacity);if (v_cutoff_opacity==0.0) {discard;}
#else
shadowed_lighting_factor=shadowed_light_factor_normal(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);
#endif
color.rgb=apply_lighting(color.rgb,normal,shadowed_lighting_factor);
#endif
#else
color.rgb=apply_lighting(color.rgb,normal);
#ifdef FLOOD_LIGHT
color.rgb=mix(color.rgb,u_flood_light_color*u_opacity,flood_radiance);
#endif
#endif
color.rgb=mix(color.rgb,v_flat.rgb,emissive_strength);color*=u_opacity;
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos,h));
#endif
#ifdef INDICATOR_CUTOUT
color=applyCutout(color,h);
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#include "_prelude_lighting.glsl"
uniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_edge_radius;uniform float u_width_scale;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef RENDER_WALL_MODE
in vec3 a_join_normal_inside;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
#ifdef TERRAIN
uniform int u_height_type;uniform int u_base_type;
#endif
uniform highp float u_vertical_scale;out vec4 v_color;out vec4 v_flat;
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
out vec4 v_roof_color;
#endif
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
out highp vec3 v_normal;
#endif
#ifdef FAUX_AO
uniform lowp vec2 u_ao;out vec2 v_ao;
#endif
#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)
out float v_flood_radius;out float v_has_floodlight;
#endif
out float v_height;vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
#pragma mapbox: define highp float flood_light_wall_radius
#pragma mapbox: define highp float line_width
#pragma mapbox: define highp float emissive_strength
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize highp float flood_light_wall_radius
#pragma mapbox: initialize highp float line_width
#pragma mapbox: initialize highp float emissive_strength
base*=u_vertical_scale;height*=u_vertical_scale;vec4 pos_nx=floor(a_pos_normal_ed*0.5);vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
v_normal=normal;
#endif
base=max(0.0,base);float attr_height=height;height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
float ele=0.0;float h=0.0;float c_ele=0.0;vec3 pos;
#ifdef TERRAIN
bool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;ele=elevation(pos_nx.xy);c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);h=t > 0.0 ? max(h_base,h_height) : h_base;pos=vec3(pos_nx.xy,h);
#else
h=t > 0.0 ? height : base;pos=vec3(pos_nx.xy,h);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*h);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,pos.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*pos.z;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
float cutoff=1.0;vec3 scaled_pos=pos;
#ifdef RENDER_CUTOFF
vec3 centroid_random=vec3(centroid_pos.xy,centroid_pos.x+centroid_pos.y+1.0);vec3 ground_pos=centroid_pos.x==0.0 ? pos.xyz : (centroid_random/8.0);vec4 ground=u_matrix*vec4(ground_pos.xy,ele,1.0);cutoff=cutoff_opacity(u_cutoff_params,ground.z);if (centroid_pos.y !=0.0 && centroid_pos.x !=0.0) {vec3 g=floor(ground_pos);vec3 mod_=centroid_random-g*8.0;float seed=min(1.0,0.1*(min(3.5,max(mod_.x+mod_.y,0.2*attr_height))*0.35+mod_.z));if (cutoff < 0.8-seed) {cutoff=0.0;}}float cutoff_scale=cutoff;v_cutoff_opacity=cutoff;scaled_pos.z=mix(c_ele,h,cutoff_scale);
#endif
float hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (cutoff==0.0 && centroid_pos.x !=0.0) || (color.a==0.0));
#ifdef RENDER_WALL_MODE
vec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);scaled_pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;scaled_pos.xy-=a_join_normal_inside.z*wall_offset*0.5;
#endif
gl_Position=mix(u_matrix*vec4(scaled_pos,1),AWAY,hidden);h=h-ele;v_height=h;
#ifdef RENDER_SHADOWS
vec3 shd_pos0=pos;vec3 shd_pos1=pos;
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(normal);shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);
#endif
float NdotL=0.0;float colorvalue=0.0;
#ifndef LIGHTING_3D_MODE
colorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),NdotL);if (normal.y !=0.0) {float r=0.84;r=mix(0.7,0.98,1.0-u_lightintensity);NdotL*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}
#endif
#ifdef FAUX_AO
float concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;
#ifdef TERRAIN
top_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);
#endif
v_ao=vec2(mix(concave,-concave,start),y_ground);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);
#ifdef PROJECTION_GLOBE_VIEW
top_height+=u_height_lift;
#endif
gl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;
#endif
#ifdef LIGHTING_3D_MODE
#ifdef FLOOD_LIGHT
float is_wall=1.0-float(t > 0.0 && top_up_ny.y > 0.0);v_has_floodlight=float(flood_light_wall_radius > 0.0 && is_wall > 0.0);v_flood_radius=flood_light_wall_radius*u_vertical_scale;
#endif
v_color=vec4(color.rgb,1.0);float ndotl=calculate_NdotL(normal);v_flat.rgb=sRGBToLinear(color.rgb);v_flat.rgb=v_flat.rgb*(ndotl+(1.0-min(ndotl*57.29,1.0))*emissive_strength);v_flat=vec4(linearTosRGB(v_flat.rgb),1.0);
#else
v_color=vec4(0.0,0.0,0.0,1.0);v_color.rgb+=clamp(color.rgb*NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_color*=u_opacity;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
float roofNdotL=clamp(u_lightpos.z,0.0,1.0);roofNdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),roofNdotL);v_roof_color=vec4(0.0,0.0,0.0,1.0);v_roof_color.rgb+=clamp(color.rgb*roofNdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_roof_color*=u_opacity;
#endif
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),fillExtrusionDepth:Mi(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,`#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;uniform float u_edge_radius;uniform float u_width_scale;uniform float u_vertical_scale;
#ifdef TERRAIN
uniform int u_height_type;uniform int u_base_type;
#endif
in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef RENDER_WALL_MODE
in vec3 a_join_normal_inside;
#endif
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp float line_width
#pragma mapbox: define highp vec4 color
out highp float v_depth;void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp float line_width
#pragma mapbox: initialize highp vec4 color
base*=u_vertical_scale;height*=u_vertical_scale;vec3 pos_nx=floor(a_pos_normal_ed.xyz*0.5);mediump vec3 top_up_ny=a_pos_normal_ed.xyz-2.0*pos_nx;base=max(0.0,base);height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
vec3 pos;
#ifdef TERRAIN
bool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;float ele=elevation(pos_nx.xy);float c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);float h=t > 0.0 ? max(h_base,h_height) : h_base;pos=vec3(pos_nx.xy,h);
#else
pos=vec3(pos_nx.xy,t > 0.0 ? height : base);
#endif
#ifdef RENDER_WALL_MODE
vec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;pos.xy-=a_join_normal_inside.z*wall_offset*0.5;
#endif
float hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (color.a==0.0));gl_Position=mix(u_matrix*vec4(pos,1),AWAY,hidden);v_depth=gl_Position.z/gl_Position.w;}`),fillExtrusionPattern:Mi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;in vec3 v_ao;
#endif
#ifdef LIGHTING_3D_MODE
in vec3 v_normal;
#endif
in highp vec2 v_pos;in vec4 v_lighting;uniform lowp float u_opacity;
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define mediump vec4 pattern
#pragma mapbox: define highp float pixel_ratio
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize highp float pixel_ratio
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting(out_color,normalize(v_normal))*u_opacity;
#else
out_color=out_color*v_lighting;
#endif
#ifdef FAUX_AO
float intensity=u_ao[0];float h=max(0.0,v_ao.z);float h_floors=h/u_ao[1];float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);float shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);shade*=mix(1.0,x_shade*x_shade*x_shade,concave);out_color.rgb=out_color.rgb*shade;
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,height);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#include "_prelude_lighting.glsl"
uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform float u_tile_units_to_pixels;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_width_scale;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef RENDER_WALL_MODE
in vec3 a_join_normal_inside;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
#ifdef TERRAIN
uniform int u_height_type;uniform int u_base_type;
#endif
out highp vec2 v_pos;out vec4 v_lighting;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;out vec3 v_ao;
#endif
#ifdef LIGHTING_3D_MODE
out vec3 v_normal;
#endif
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump vec4 pattern
#pragma mapbox: define highp float pixel_ratio
#pragma mapbox: define highp float line_width
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize highp float pixel_ratio
#pragma mapbox: initialize highp float line_width
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec4 pos_nx=floor(a_pos_normal_ed*0.5);mediump vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;mediump vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));float edgedistance=a_pos_normal_ed.w;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;float z=t > 0.0 ? height : base;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
float ele=0.0;float h=z;vec3 p;float c_ele;
#ifdef TERRAIN
bool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;ele=elevation(pos_nx.xy);c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);h=t > 0.0 ? max(h_base,h_height) : h_base;p=vec3(pos_nx.xy,h);
#else
p=vec3(pos_nx.xy,z);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*(p.z+lift));vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,p.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*p.z;p=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
#ifdef RENDER_WALL_MODE
vec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);p.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;p.xy-=a_join_normal_inside.z*wall_offset*0.5;
#endif
float hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (color.a==0.0));gl_Position=mix(u_matrix*vec4(p,1),AWAY,hidden);vec2 pos=normal.z==1.0
? pos_nx.xy
: vec2(edgedistance,z*u_height_factor);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float NdotL=0.0;
#ifdef LIGHTING_3D_MODE
NdotL=calculate_NdotL(normal);
#else
NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),NdotL);
#endif
if (normal.y !=0.0) {float r=0.84;
#ifndef LIGHTING_3D_MODE
r=mix(0.7,0.98,1.0-u_lightintensity);
#endif
NdotL*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}
#ifdef FAUX_AO
float concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;
#ifdef TERRAIN
top_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);
#endif
v_ao=vec3(mix(concave,-concave,start),y_ground,h-ele);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);
#ifdef PROJECTION_GLOBE_VIEW
top_height+=u_height_lift;
#endif
gl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;
#endif
#ifdef LIGHTING_3D_MODE
v_normal=normal;
#else
v_lighting.rgb+=clamp(NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;
#endif 
#ifdef FOG
v_fog_pos=fog_position(p);
#endif
}`),groundShadow:Mi(`#include "_prelude_shadow.fragment.glsl"
precision highp float;uniform vec3 u_ground_shadow_factor;in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;
#ifdef FOG
in float v_fog_opacity;
#endif
void main() {float light=shadowed_light_factor_plane_bias(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 shadow=mix(u_ground_shadow_factor,vec3(1.0),light);
#ifdef RENDER_CUTOFF
shadow=mix(vec3(1.0),shadow,cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w));
#endif
#ifdef FOG
shadow=mix(shadow,vec3(1.0),v_fog_opacity);
#endif
#ifdef INDICATOR_CUTOUT
shadow=mix(shadow,vec3(1.0),1.0-applyCutout(vec4(1.0),0.0).r);
#endif
glFragColor=vec4(shadow,1.0);}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;in vec2 a_pos;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;
#ifdef FOG
out float v_fog_opacity;
#endif
void main() {gl_Position=u_matrix*vec4(a_pos,0.0,1.0);v_pos_light_view_0=u_light_matrix_0*vec4(a_pos,0.0,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(a_pos,0.0,1.0);
#ifdef FOG
v_fog_pos=fog_position(a_pos);v_fog_opacity=fog(v_fog_pos);
#endif
}`),fillExtrusionGroundEffect:Mi(`uniform highp float u_ao_pass;uniform highp float u_opacity;uniform highp float u_flood_light_intensity;uniform highp vec3 u_flood_light_color;uniform highp float u_attenuation;uniform sampler2D u_fb;uniform float u_fb_size;
#ifdef SDF_SUBPASS
in highp vec2 v_pos;in highp vec4 v_line_segment;in highp float v_flood_light_radius_tile;in highp vec2 v_ao;float line_df(highp vec2 a,highp vec2 b,highp vec2 p) {highp vec2 ba=b-a;highp vec2 pa=p-a;highp float r=clamp(dot(pa,ba)/dot(ba,ba),0.0,1.0);return length(pa-r*ba);}
#ifdef FOG
in highp float v_fog;
#endif
#endif
void main() {
#ifdef CLEAR_SUBPASS
vec4 color=vec4(1.0);
#ifdef CLEAR_FROM_TEXTURE
color=texture(u_fb,gl_FragCoord.xy/vec2(u_fb_size));
#endif
glFragColor=color;
#else
#ifdef SDF_SUBPASS
highp float d=line_df(v_line_segment.xy,v_line_segment.zw,v_pos);highp float effect_radius=mix(v_flood_light_radius_tile,v_ao.y,u_ao_pass);d/=effect_radius;d=min(d,1.0);d=1.0-pow(1.0-d,u_attenuation);highp float effect_intensity=mix(u_flood_light_intensity,v_ao.x,u_ao_pass);highp float fog=1.0;
#ifdef FOG
fog=v_fog;
#endif
#ifdef RENDER_CUTOFF
fog*=v_cutoff_opacity;
#endif
glFragColor=vec4(vec3(0.0),mix(1.0,d,effect_intensity*u_opacity*fog));
#else
vec4 color=mix(vec4(u_flood_light_color,1.0),vec4(vec3(0.0),1.0),u_ao_pass);
#ifdef OVERDRAW_INSPECTOR
color=vec4(1.0);
#endif
glFragColor=color;
#endif
HANDLE_WIREFRAME_DEBUG;
#endif
}`,`#include "_prelude_fog.vertex.glsl"
in highp vec4 a_pos_end;in highp float a_angular_offset_factor;in highp float a_hidden_by_landmark;
#ifdef SDF_SUBPASS
out highp vec2 v_pos;out highp vec4 v_line_segment;out highp float v_flood_light_radius_tile;out highp vec2 v_ao;
#ifdef FOG
out highp float v_fog;
#endif
#endif
uniform highp float u_flood_light_intensity;uniform highp mat4 u_matrix;uniform highp float u_ao_pass;uniform highp float u_meter_to_tile;uniform highp float u_edge_radius;uniform highp float u_dynamic_offset;uniform highp vec2 u_ao;
#pragma mapbox: define highp float flood_light_ground_radius
const float TANGENT_CUTOFF=4.0;const float NORM=32767.0;void main() {
#pragma mapbox: initialize highp float flood_light_ground_radius
vec2 p=a_pos_end.xy;vec2 q=floor(a_pos_end.zw*0.5);vec2 start_bottom=a_pos_end.zw-q*2.0;float fl_ground_radius=flood_light_ground_radius;fl_ground_radius=abs(flood_light_ground_radius);float direction=flood_light_ground_radius < 0.0 ?-1.0 : 1.0;float flood_radius_tile=fl_ground_radius*u_meter_to_tile;vec2 v=normalize(q-p);float ao_radius=u_ao.y/3.5;float effect_radius=mix(flood_radius_tile,ao_radius,u_ao_pass)+u_edge_radius;float angular_offset_factor=a_angular_offset_factor/NORM*TANGENT_CUTOFF;float angular_offset=direction*angular_offset_factor*effect_radius;float top=1.0-start_bottom.y;float side=(0.5-start_bottom.x)*2.0;vec2 extrusion_parallel=v*side*mix(u_dynamic_offset,angular_offset,top);vec2 perp=vec2(v.y,-v.x);vec2 extrusion_perp=direction*perp*effect_radius*top;vec3 pos=vec3(mix(q,p,start_bottom.x),0.0);pos.xy+=extrusion_parallel+extrusion_perp;
#ifdef SDF_SUBPASS
v_pos=pos.xy;v_line_segment=vec4(p,q)+perp.xyxy*u_edge_radius;v_flood_light_radius_tile=flood_radius_tile;v_ao=vec2(u_ao.x,ao_radius);
#ifdef FOG
v_fog_pos=fog_position(pos);v_fog=1.0-fog(v_fog_pos);
#endif
#endif
float hidden_by_landmark=0.0;
#ifdef HAS_CENTROID
hidden_by_landmark=a_hidden_by_landmark;
#endif
float isFloodlit=float(fl_ground_radius > 0.0 && u_flood_light_intensity > 0.0);float hidden=mix(1.0-isFloodlit,isFloodlit,u_ao_pass);hidden+=hidden_by_landmark;gl_Position=mix(u_matrix*vec4(pos,1.0),AWAY,float(hidden > 0.0));
#ifdef RENDER_CUTOFF
v_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);
#endif
}`),hillshadePrepare:Mi(`precision highp float;uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;float getElevation(vec2 coord) {return texture(u_image,coord).r/4.0;}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y));float b=getElevation(v_pos+vec2(0,-epsilon.y));float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y));float d=getElevation(v_pos+vec2(-epsilon.x,0));float e=getElevation(v_pos+vec2(epsilon.x,0));float f=getElevation(v_pos+vec2(-epsilon.x,epsilon.y));float g=getElevation(v_pos+vec2(0,epsilon.y));float h=getElevation(v_pos+vec2(epsilon.x,epsilon.y));float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2(
(c+e+e+h)-(a+d+d+f),(f+g+g+h)-(a+b+b+c)
)/pow(2.0,exaggeration+(19.2562-u_zoom));glFragColor=clamp(vec4(
deriv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);}`,"uniform mat4 u_matrix;uniform vec2 u_dimension;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:Mi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;uniform float u_emissive_strength;void main() {vec4 pixel=texture(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);glFragColor=accent_color*(1.0-shade_color.a)+shade_color;
#ifdef LIGHTING_3D_MODE
glFragColor=apply_lighting_with_emission_ground(glFragColor,u_emissive_strength);
#endif
#ifdef FOG
glFragColor=fog_dither(fog_apply_premultiplied(glFragColor,v_fog_pos));
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),line:Mi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform lowp float u_device_pixel_ratio;uniform highp float u_width_scale;uniform highp float u_floor_width_scale;uniform float u_alpha_discard_threshold;uniform highp vec2 u_trim_offset;uniform highp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;in vec2 v_width2;in vec2 v_normal;in float v_gamma_scale;in highp vec3 v_uv;
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#ifdef RENDER_LINE_DASH
uniform sampler2D u_dash_image;in vec2 v_tex;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform sampler2D u_gradient_image;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
float luminance(vec3 c) {return (c.r+c.r+c.b+c.g+c.g+c.g)*0.1667;}uniform float u_emissive_strength;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float border_width
#pragma mapbox: define lowp vec4 border_color
float linearstep(float edge0,float edge1,float x) {return  clamp((x-edge0)/(edge1-edge0),0.0,1.0);}void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float border_width
#pragma mapbox: initialize lowp vec4 border_color
float dist=length(v_normal)*v_width2.s;float blur2=(u_width_scale*blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);
#ifdef RENDER_LINE_DASH
float sdfdist=texture(u_dash_image,v_tex).r;float sdfgamma=1.0/(2.0*u_device_pixel_ratio)/dash.z;float scaled_floorwidth=(floorwidth*u_floor_width_scale);alpha*=linearstep(0.5-sdfgamma/scaled_floorwidth,0.5+sdfgamma/scaled_floorwidth,sdfdist);
#endif
highp vec4 out_color;
#ifdef RENDER_LINE_GRADIENT
out_color=texture(u_gradient_image,v_uv.xy);
#else
out_color=color;
#endif
float trim_alpha=1.0;
#ifdef RENDER_LINE_TRIM_OFFSET
highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=v_uv[2];if (trim_end > trim_start) {highp float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/max(u_trim_fade_range[0],1.0e-9)));highp float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/max(u_trim_fade_range[1],1.0e-9)));highp float transition_factor=min(start_transition,end_transition);out_color=mix(out_color,u_trim_color,transition_factor);trim_alpha=1.0-transition_factor;}
#endif
if (u_alpha_discard_threshold !=0.0) {if (alpha < u_alpha_discard_threshold) {discard;}}
#ifdef RENDER_LINE_BORDER
float edgeBlur=((border_width*u_width_scale)+1.0/u_device_pixel_ratio);float alpha2=clamp(min(dist-(v_width2.t-edgeBlur),v_width2.s-dist)/edgeBlur,0.0,1.0);if (alpha2 < 1.) {float smoothAlpha=smoothstep(0.6,1.0,alpha2);if (border_color.a==0.0) {float Y=(out_color.a > 0.01) ? luminance(out_color.rgb/out_color.a) : 1.;float adjustment=(Y > 0.) ? 0.5/Y : 0.45;if (out_color.a > 0.25 && Y < 0.25) {vec3 borderColor=(Y > 0.) ? out_color.rgb : vec3(1,1,1)*out_color.a;out_color.rgb=out_color.rgb+borderColor*(adjustment*(1.0-smoothAlpha));} else {out_color.rgb*=(0.6 +0.4*smoothAlpha);}} else {out_color=mix(border_color*trim_alpha,out_color,smoothAlpha);}}
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef ELEVATED_ROADS
out_color.rgb*=mix(v_road_z_offset > 0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#else
out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
out_color*=(alpha*opacity);
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,v_z_offset);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define EXTRUDE_SCALE 0.015873016
in vec2 a_pos_normal;in vec4 a_data;
#if defined(ELEVATED) || defined(ELEVATED_ROADS) || defined(VARIABLE_LINE_WIDTH)
in vec3 a_z_offset_width;
#endif
#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)
in highp vec3 a_packed;
#endif
#ifdef RENDER_LINE_DASH
in float a_linesofar;
#endif
uniform mat4 u_matrix;uniform mat2 u_pixels_to_tile_units;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;uniform float u_width_scale;uniform highp float u_floor_width_scale;
#ifdef ELEVATED
uniform lowp float u_zbias_factor;uniform lowp float u_tile_to_meter;float sample_elevation(vec2 apos) {
#ifdef ELEVATION_REFERENCE_SEA
return 0.0;
#else
return elevation(apos);
#endif
}
#endif
out vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp vec3 v_uv;
#ifdef ELEVATED_ROADS
out highp float v_road_z_offset;
#endif
#ifdef RENDER_LINE_DASH
uniform vec2 u_texsize;uniform float u_tile_units_to_pixels;out vec2 v_tex;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform float u_image_height;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float border_width
#pragma mapbox: define lowp vec4 border_color
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float border_width
#pragma mapbox: initialize lowp vec4 border_color
float a_z_offset;
#if defined(ELEVATED) || defined(ELEVATED_ROADS)
a_z_offset=a_z_offset_width.x;
#endif
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth;
#ifdef VARIABLE_LINE_WIDTH
float left=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);halfwidth=(u_width_scale*(left==1.0 ? a_z_offset_width.y : a_z_offset_width.z))/2.0;
#else
halfwidth=(u_width_scale*width)/2.0;
#endif
offset=-1.0*offset*u_width_scale;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*EXTRUDE_SCALE;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*EXTRUDE_SCALE*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec2 extrude=dist*u_pixels_to_tile_units;vec4 projected_extrude=u_matrix*vec4(extrude,0.0,0.0);vec2 projected_extrude_xy=projected_extrude.xy;
#ifdef ELEVATED_ROADS
v_road_z_offset=a_z_offset;gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset,1.0)+projected_extrude;
#else
#ifdef ELEVATED
vec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 offset_pos=pos+offsetTile;float ele=0.0;
#ifdef CROSS_SLOPE_VERTICAL
float top=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);float line_height=2.0*u_tile_to_meter*outset*top*u_pixels_to_tile_units[1][1]+a_z_offset;ele=sample_elevation(offset_pos)+line_height;projected_extrude=vec4(0);
#else
#ifdef CROSS_SLOPE_HORIZONTAL
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,max(ele1,ele2));ele=ele_max+a_z_offset;
#else
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,0.5*(ele1+ele2));ele=ele_max-ele0+ele1+a_z_offset;
#endif
#endif
gl_Position=u_matrix*vec4(offset_pos,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*u_zbias_factor*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);
#else
gl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);
#endif
#endif
#ifdef ELEVATED_ROADS
#ifdef RENDER_SHADOWS
vec3 shd_pos=vec3(pos+(offset2+dist)*u_pixels_to_tile_units,a_z_offset);vec3 shd_pos0=shd_pos;vec3 shd_pos1=shd_pos;
#ifdef NORMAL_OFFSET
vec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#endif
#ifndef RENDER_TO_TEXTURE
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude_xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=mix(extrude_length_without_perspective/extrude_length_with_perspective,1.0,step(0.01,blur));
#else
v_gamma_scale=1.0;
#endif
#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)
highp float a_uv_x=a_packed[0];float a_split_index=a_packed[1];highp float line_progress=a_packed[2];
#ifdef RENDER_LINE_GRADIENT
highp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec3(a_uv_x,a_split_index*texel_height-half_texel_height,line_progress);
#else
v_uv=vec3(a_uv_x,0.0,line_progress);
#endif
#endif
#ifdef RENDER_LINE_DASH
float scale=dash.z==0.0 ? 0.0 : u_tile_units_to_pixels/dash.z;float height=dash.y;v_tex=vec2(a_linesofar*scale/(floorwidth*u_floor_width_scale),(-normal.y*height+dash.x+0.5)/u_texsize.y);
#endif
v_width2=vec2(outset,inset);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=a_z_offset;
#endif
}`),linePattern:Mi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform highp float u_device_pixel_ratio;uniform highp float u_width_scale;uniform highp float u_alpha_discard_threshold;uniform highp vec2 u_texsize;uniform highp float u_tile_units_to_pixels;uniform highp vec2 u_trim_offset;uniform highp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;uniform sampler2D u_image;in vec2 v_normal;in vec2 v_width2;in highp float v_linesofar;in float v_gamma_scale;in float v_width;
#ifdef RENDER_LINE_TRIM_OFFSET
in highp vec3 v_uv;
#endif
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#ifdef LINE_JOIN_NONE
in vec2 v_pattern_data;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
uniform float u_emissive_strength;
#pragma mapbox: define mediump vec4 pattern
#pragma mapbox: define mediump float pixel_ratio
#pragma mapbox: define mediump float blur
#pragma mapbox: define mediump float opacity
void main() {
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize mediump float pixel_ratio
#pragma mapbox: initialize mediump float blur
#pragma mapbox: initialize mediump float opacity
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;highp float pattern_size=display_size.x/u_tile_units_to_pixels;float aspect=display_size.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(u_width_scale*blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);highp float pattern_x=v_linesofar/pattern_size*aspect;highp float x=mod(pattern_x,1.0);highp float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;highp vec2 pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(x,y));highp vec2 lod_pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(pattern_x,y));vec4 color=textureLodCustom(u_image,pos,lod_pos);
#ifdef RENDER_LINE_TRIM_OFFSET
highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=v_uv[2];if (trim_end > trim_start) {highp float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/max(u_trim_fade_range[0],1.0e-9)));highp float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/max(u_trim_fade_range[1],1.0e-9)));highp float transition_factor=min(start_transition,end_transition);color=mix(color,color.a*u_trim_color,transition_factor);}
#endif
#ifdef LINE_JOIN_NONE
highp float pattern_len=pattern_size/aspect;highp float segment_phase=pattern_len-mod(v_linesofar-v_pattern_data.x+pattern_len,pattern_len);highp float visible_start=segment_phase-step(pattern_len*0.5,segment_phase)*pattern_len;highp float visible_end=floor((v_pattern_data.y-segment_phase)/pattern_len)*pattern_len+segment_phase;visible_end+=step(pattern_len*0.5,v_pattern_data.y-visible_end)*pattern_len;if (v_pattern_data.x < visible_start || v_pattern_data.x >=visible_end) {color=vec4(0.0);}
#endif
#ifdef LIGHTING_3D_MODE
color=apply_lighting_with_emission_ground(color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef ELEVATED_ROADS
color.rgb*=mix(v_road_z_offset > 0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#else
color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
color*=(alpha*opacity);if (u_alpha_discard_threshold !=0.0) {if (color.a < u_alpha_discard_threshold) {discard;}}
#ifdef INDICATOR_CUTOUT
color=applyCutout(color,v_z_offset);
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define scale 0.015873016
in vec2 a_pos_normal;in vec4 a_data;
#if defined(ELEVATED) || defined(ELEVATED_ROADS)
in vec3 a_z_offset_width;
#endif
#ifdef RENDER_LINE_TRIM_OFFSET
in highp vec3 a_packed;
#endif
in highp float a_linesofar;
#ifdef LINE_JOIN_NONE
in highp vec3 a_pattern_data;out vec2 v_pattern_data;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#endif
uniform mat4 u_matrix;uniform float u_tile_units_to_pixels;uniform vec2 u_units_to_pixels;uniform mat2 u_pixels_to_tile_units;uniform float u_device_pixel_ratio;uniform float u_width_scale;uniform float u_floor_width_scale;
#ifdef ELEVATED
uniform lowp float u_zbias_factor;uniform lowp float u_tile_to_meter;float sample_elevation(vec2 apos) {
#ifdef ELEVATION_REFERENCE_SEA
return 0.0;
#else
return elevation(apos);
#endif
}
#endif
out vec2 v_normal;out vec2 v_width2;out highp float v_linesofar;out float v_gamma_scale;out float v_width;
#ifdef RENDER_LINE_TRIM_OFFSET
out highp vec3 v_uv;
#endif
#ifdef ELEVATED_ROADS
out highp float v_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#pragma mapbox: define mediump float blur
#pragma mapbox: define mediump float opacity
#pragma mapbox: define mediump float offset
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define mediump float width
#pragma mapbox: define mediump float floorwidth
#pragma mapbox: define mediump vec4 pattern
#pragma mapbox: define mediump float pixel_ratio
void main() {
#pragma mapbox: initialize mediump float blur
#pragma mapbox: initialize mediump float opacity
#pragma mapbox: initialize mediump float offset
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize mediump float floorwidth
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize mediump float pixel_ratio
float a_z_offset;
#if defined(ELEVATED) || defined(ELEVATED_ROADS)
a_z_offset=a_z_offset_width.x;
#endif
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=(u_width_scale*width)/2.0;offset=-1.0*offset*u_width_scale;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);vec2 dist=outset*a_extrude*scale;float u=0.5*a_direction;float t=1.0-abs(u);vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec2 extrude=dist*u_pixels_to_tile_units;vec4 projected_extrude=u_matrix*vec4(extrude,0.0,0.0);vec2 projected_extrude_xy=projected_extrude.xy;
#ifdef ELEVATED_ROADS
v_road_z_offset=a_z_offset;gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset,1.0)+projected_extrude;
#else
#ifdef ELEVATED
vec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 offset_pos=pos+offsetTile;float ele=0.0;
#ifdef CROSS_SLOPE_VERTICAL
float top=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);float line_height=2.0*u_tile_to_meter*outset*top*u_pixels_to_tile_units[1][1]+a_z_offset;ele=sample_elevation(offset_pos)+line_height;projected_extrude=vec4(0);
#else
#ifdef CROSS_SLOPE_HORIZONTAL
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,max(ele1,ele2));ele=ele_max+a_z_offset;
#else
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,0.5*(ele1+ele2));ele=ele_max-ele0+ele1+a_z_offset;
#endif
#endif
gl_Position=u_matrix*vec4(offset_pos,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*u_zbias_factor*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);
#else
gl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);
#endif
#endif
#ifdef ELEVATED_ROADS
#ifdef RENDER_SHADOWS
vec3 shd_pos=vec3(pos+(offset2+dist)*u_pixels_to_tile_units,a_z_offset);vec3 shd_pos0=shd_pos;vec3 shd_pos1=shd_pos;
#ifdef NORMAL_OFFSET
vec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#endif
#ifndef RENDER_TO_TEXTURE
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude_xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=mix(extrude_length_without_perspective/extrude_length_with_perspective,1.0,step(0.01,blur));
#else
v_gamma_scale=1.0;
#endif
#ifdef RENDER_LINE_TRIM_OFFSET
highp float a_uv_x=a_packed[0];highp float line_progress=a_packed[2];v_uv=vec3(a_uv_x,0.0,line_progress);
#endif
v_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=(floorwidth*u_floor_width_scale);
#ifdef LINE_JOIN_NONE
v_width=(floorwidth*u_floor_width_scale)+ANTIALIASING;mediump float pixels_to_tile_units=1.0/u_tile_units_to_pixels;mediump float pixel_ratio_inverse=1.0/pixel_ratio;mediump float aspect=v_width/((pattern.w-pattern.y)*pixel_ratio_inverse);highp float subt_multiple=(pattern.z-pattern.x)*pixel_ratio_inverse*pixels_to_tile_units*aspect*32.0;highp float subt=floor(a_pattern_data.z/subt_multiple)*subt_multiple;float offset_sign=(fract(a_pattern_data.x)-0.5)*4.0;float line_progress_offset=offset_sign*v_width*0.5*pixels_to_tile_units;v_linesofar=(a_pattern_data.z-subt)+a_linesofar+line_progress_offset;v_pattern_data=vec2(a_pattern_data.x+line_progress_offset,a_pattern_data.y);
#endif
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=a_z_offset;
#endif
}`),raster:Mi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_raster_array.glsl"
uniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;uniform highp float u_zoom_transition;in vec2 v_pos0;in vec2 v_pos1;in float v_depth;
#ifdef PROJECTION_GLOBE_VIEW
in float v_split_fade;
#endif
uniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;uniform float u_emissive_strength;
#ifndef RASTER_ARRAY
uniform highp sampler2D u_image0;uniform sampler2D u_image1;
#endif
#ifdef RASTER_COLOR
uniform sampler2D u_color_ramp;uniform highp vec4 u_colorization_mix;uniform highp float u_colorization_offset;uniform vec2 u_texture_res;
#endif
void main() {vec4 color0,color1,color;vec2 value;
#ifdef RASTER_COLOR
#ifdef RASTER_ARRAY
#ifdef RASTER_ARRAY_LINEAR
value=mix(
raTexture2D_image0_linear(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_linear(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t
);
#else
value=mix(
raTexture2D_image0_nearest(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_nearest(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t
);
#endif
if (value.y > 0.0) value.x/=value.y;
#else
color=mix(texture(u_image0,v_pos0),texture(u_image1,v_pos1),u_fade_t);value=vec2(u_colorization_offset+dot(color.rgb,u_colorization_mix.rgb),color.a);
#endif
color=texture(u_color_ramp,vec2(value.x,0.5));if (color.a > 0.0) color.rgb/=color.a;color.a*=value.y;
#else
color0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);
#endif
color.a*=u_opacity;
#ifdef GLOBE_POLES
color.a*=1.0-smoothstep(0.0,0.05,u_zoom_transition);
#endif
vec3 rgb=color.rgb;rgb=vec3(
dot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);vec3 out_color=mix(u_high_vec,u_low_vec,rgb);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),u_emissive_strength).rgb;
#endif
#ifdef FOG
highp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));
#endif
glFragColor=vec4(out_color*color.a,color.a);
#ifdef PROJECTION_GLOBE_VIEW
glFragColor*=mix(1.0,1.0-smoothstep(0.0,0.05,u_zoom_transition),smoothstep(0.8,0.9,v_split_fade));
#endif
#ifdef RENDER_CUTOFF
glFragColor=glFragColor*cutoff_opacity(u_cutoff_params,v_depth);
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform vec2 u_perspective_transform;uniform vec2 u_texture_offset;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;
#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8
#ifdef GLOBE_POLES
in vec3 a_globe_pos;in vec2 a_uv;
#else
in vec2 a_pos;in vec2 a_texture_pos;
#endif
out vec2 v_pos0;out vec2 v_pos1;out float v_depth;
#ifdef PROJECTION_GLOBE_VIEW
out float v_split_fade;
#endif
void main() {vec2 uv;
#ifdef GLOBE_POLES
vec3 globe_pos=a_globe_pos;globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;gl_Position=u_matrix*u_globe_matrix*vec4(globe_pos   ,1.0);uv=a_uv;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(a_globe_pos,1.0)).xyz);
#endif
#else
float w=1.0+dot(a_texture_pos,u_perspective_transform);uv=a_texture_pos/8192.0;
#ifdef PROJECTION_GLOBE_VIEW
vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);    
v_split_fade=0.0;if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;float opposite_merc_center=mod(u_merc_center.x+0.5,1.0);float dist_from_poles=(abs(mercatorY-0.5)*2.0);float range=0.1;v_split_fade=abs(opposite_merc_center-mercatorX);v_split_fade=clamp(1.0-v_split_fade,0.0,1.0);v_split_fade=max(smoothstep(1.0-range,1.0,dist_from_poles),max(smoothstep(1.0-range,1.0,v_split_fade),smoothstep(1.0-range,1.0,1.0-v_split_fade)));}float tiles=u_grid_matrix[0][2];if (tiles > 0.0) {float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvY=mercatorY*tiles-idy;float uvX=mercatorX*tiles-idx;uv=vec2(uvX,uvY);}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
#else
gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#endif
#endif
v_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;v_pos0=u_texture_offset.x+u_texture_offset.y*v_pos0;v_pos1=u_texture_offset.x+u_texture_offset.y*v_pos1;
#ifdef RENDER_CUTOFF
v_depth=gl_Position.z;
#endif
}`),rasterParticle:Mi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;in vec2 v_pos0;in vec2 v_pos1;uniform sampler2D u_image0;uniform sampler2D u_image1;void main() {vec4 color0,color1,color;color0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 out_color=color.rgb;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),0.0).rgb;
#endif
#ifdef FOG
highp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));
#endif
glFragColor=vec4(out_color*color.a,color.a);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;
#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8
in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos0;out vec2 v_pos1;void main() {float w=1.0;vec2 uv;
#ifdef PROJECTION_GLOBE_VIEW
vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvX=mercatorX*tiles-idx;float uvY=mercatorY*tiles-idy;uv=vec2(uvX,uvY);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
#else
uv=a_texture_pos/8192.0;gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#endif
v_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;}`),rasterParticleDraw:Mi("uniform sampler2D u_color_ramp;in float v_particle_speed;void main() {glFragColor=texture(u_color_ramp,vec2(v_particle_speed,0.5));}",`#include "_prelude_raster_particle.glsl"
in float a_index;uniform sampler2D u_particle_texture;uniform float u_particle_texture_side_len;uniform vec2 u_tile_offset;out float v_particle_speed;void main() {ivec2 pixel_coord=ivec2(
mod(a_index,u_particle_texture_side_len),a_index/u_particle_texture_side_len);vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);vec2 pos=unpack_pos_from_rgba(pixel)+u_tile_offset;vec2 tex_coord=fract(pos);vec2 velocity=lookup_velocity(tex_coord);if (velocity==INVALID_VELOCITY) {gl_Position=AWAY;v_particle_speed=0.0;} else {gl_Position=vec4(2.0*pos-1.0,0,1);v_particle_speed=length(velocity);}gl_PointSize=1.0;}`),rasterParticleTexture:Mi("uniform sampler2D u_texture;uniform float u_opacity;in vec2 v_tex_pos;void main() {vec4 color=texture(u_texture,v_tex_pos);glFragColor=vec4(floor(255.0*color*u_opacity)/255.0);}","in vec2 a_pos;out vec2 v_tex_pos;void main() {vec2 uv=0.5*a_pos+vec2(0.5);v_tex_pos=uv;gl_Position=vec4(a_pos,0.0,1.0);}"),rasterParticleUpdate:Mi(`#include "_prelude_raster_particle.glsl"
uniform sampler2D u_particle_texture;uniform mediump float u_particle_texture_side_len;uniform mediump float u_speed_factor;uniform highp float u_reset_rate;uniform highp float u_rand_seed;in highp vec2 v_tex_coord;vec2 linearstep(vec2 edge0,vec2 edge1,vec2 x) {return  clamp((x-edge0)/(edge1-edge0),vec2(0),vec2(1));}const highp vec3 rand_constants=vec3(12.9898,78.233,4375.85453);highp float rand(const highp vec2 co) {highp float t=dot(rand_constants.xy,co);return fract(sin(t)*(rand_constants.z+t));}void main() {ivec2 pixel_coord=ivec2(v_tex_coord*u_particle_texture_side_len);highp vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);highp vec2 pos=unpack_pos_from_rgba(pixel);highp vec2 velocity=lookup_velocity(clamp(pos,0.0,1.0));highp vec2 dp=velocity==INVALID_VELOCITY ? vec2(0) : velocity*u_speed_factor;pos=pos+dp;highp vec2 seed=(pos+v_tex_coord)*u_rand_seed;highp vec2 random_pos=vec2(rand(seed+1.3),rand(seed+2.1));highp vec2 persist_rate=pow(
linearstep(vec2(-u_particle_pos_offset),vec2(0),pos)*linearstep(vec2(1.0+u_particle_pos_offset),vec2(1),pos),vec2(4)
);highp vec2 per_frame_persist=pow(persist_rate,abs(dp)/u_particle_pos_offset);highp float drop_rate=1.0-per_frame_persist.x*per_frame_persist.y;drop_rate=any(greaterThanEqual(abs(pos-0.5),vec2(0.5+u_particle_pos_offset))) ? 1.0 : drop_rate;highp float drop=step(1.0-drop_rate-u_reset_rate,rand(seed));highp vec2 next_pos=mix(pos,random_pos,drop);glFragColor=pack_pos_to_rgba(next_pos);}`,"in vec2 a_pos;out vec2 v_tex_coord;void main() {v_tex_coord=0.5*(a_pos+vec2(1.0));gl_Position=vec4(a_pos,0.0,1.0);}"),symbol:Mi(`#include "_prelude_lighting.glsl"
#define SDF_PX 8.0
#define SDF 1.0
#define ICON 0.0
uniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;uniform bool u_is_halo;uniform lowp float u_scale_factor;
#ifdef ICON_TRANSITION
uniform float u_icon_transition;
#endif
#ifdef COLOR_ADJUSTMENT
uniform mat4 u_color_adj_mat;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#endif
in vec2 v_tex_a;
#ifdef ICON_TRANSITION
in vec2 v_tex_b;
#endif
in float v_draw_halo;in vec3 v_gamma_scale_size_fade_opacity;
#ifdef RENDER_TEXT_AND_SYMBOL
in float is_sdf;in vec2 v_tex_a_icon;
#endif
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
vec4 out_color;float fade_opacity=v_gamma_scale_size_fade_opacity[2];
#ifdef RENDER_TEXT_AND_SYMBOL
if (is_sdf==ICON) {vec2 tex_icon=v_tex_a_icon;lowp float alpha=opacity*fade_opacity;glFragColor=texture(u_texture_icon,tex_icon)*alpha;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
return;}
#endif
#ifdef RENDER_SDF
float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_gamma_scale_size_fade_opacity.x;float size=v_gamma_scale_size_fade_opacity.y;float fontScale=u_is_text ? size/24.0 : size;out_color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;bool draw_halo=v_draw_halo > 0.0;if (draw_halo) {out_color=halo_color;gamma=(halo_blur*u_scale_factor*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width*u_scale_factor/fontScale)/SDF_PX;}lowp float dist=texture(u_texture,v_tex_a).r;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);out_color*=alpha;
#else
#ifdef ICON_TRANSITION
vec4 a=texture(u_texture,v_tex_a)*(1.0-u_icon_transition);vec4 b=texture(u_texture,v_tex_b)*u_icon_transition;out_color=(a+b);
#else
out_color=texture(u_texture,v_tex_a);
#endif
#ifdef COLOR_ADJUSTMENT
out_color=u_color_adj_mat*out_color;
#endif
#endif
out_color*=opacity*fade_opacity;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,emissive_strength);
#endif
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,v_z_offset);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_terrain.vertex.glsl"
in vec4 a_pos_offset;in vec4 a_tex_size;in vec4 a_pixeloffset;in vec4 a_projected_pos;in float a_fade_opacity;
#ifdef Z_OFFSET
in float a_auto_z_offset;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_globe_anchor;in vec3 a_globe_normal;
#endif
#ifdef ICON_TRANSITION
in vec2 a_texb;
#endif
#ifdef OCCLUSION_QUERIES
in float a_occlusion_query_opacity;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#endif
uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_elevation_from_sea;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;uniform vec2 u_texsize_icon;uniform bool u_is_halo;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;
#endif
out vec2 v_tex_a;
#ifdef ICON_TRANSITION
out vec2 v_tex_b;
#endif
out float v_draw_halo;out vec3 v_gamma_scale_size_fade_opacity;
#ifdef RENDER_TEXT_AND_SYMBOL
out float is_sdf;out vec2 v_tex_a_icon;
#endif
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
#pragma mapbox: define lowp float occlusion_opacity
#pragma mapbox: define lowp float z_offset
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
#pragma mapbox: initialize lowp float occlusion_opacity
#pragma mapbox: initialize lowp float z_offset
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_min_font_scale=a_pixeloffset.zw/256.0;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=u_elevation_from_sea ? z_offset : z_offset+elevation(tile_anchor);
#ifdef Z_OFFSET
e+=a_auto_z_offset;
#endif
vec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;vec3 world_pos_globe;
#ifdef PROJECTION_GLOBE_VIEW
mercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos_globe=a_globe_anchor+h;world_pos=mix_globe_mercator(world_pos_globe,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;
#else
world_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(
0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetprojected_point;vec2 a;
#ifdef PROJECTION_GLOBE_VIEW
vec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetprojected_point=u_matrix*vec4(a_globe_anchor+displacement,1);vec4 projected_point_globe=u_matrix*vec4(world_pos_globe,1);a=projected_point_globe.xy/projected_point_globe.w;
#else
offsetprojected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);a=projected_point.xy/projected_point.w;
#endif
vec2 b=offsetprojected_point.xy/offsetprojected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;
#ifdef PROJECTION_GLOBE_VIEW
#ifdef PROJECTED_POS_ON_VIEWPORT
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xyz+h,1.0);
#else
vec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz,mercator_pos,u_zoom_transition)+h;projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);    
#endif
#else
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);
#endif
highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*max(a_min_font_scale,font_scale)+a_pxoffset/16.0);
#ifdef TERRAIN
#ifdef PITCH_WITH_MAP_TERRAIN
vec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);
#endif
#endif
#ifdef Z_OFFSET
z+=u_pitch_with_map ? a_auto_z_offset+(u_elevation_from_sea ? z_offset : z_offset) : 0.0;
#else
z+=u_pitch_with_map ? (u_elevation_from_sea ? z_offset : z_offset) : 0.0;
#endif
float occlusion_fade=globe_occlusion_fade;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float out_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));
#ifdef DEPTH_OCCLUSION
float depth_occlusion=occlusionFadeMultiSample(projected_point);float depth_occlusion_multplier=mix(occlusion_opacity,1.0,depth_occlusion);out_fade_opacity*=depth_occlusion_multplier;
#endif
#ifdef OCCLUSION_QUERIES
float occludedFadeMultiplier=mix(occlusion_opacity,1.0,a_occlusion_query_opacity);out_fade_opacity*=occludedFadeMultiplier;
#endif
float alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);
#ifdef PROJECTION_GLOBE_VIEW
vec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y,1.0),AWAY,hidden);
#else
gl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,hidden);
#endif
float gamma_scale=gl_Position.w;v_draw_halo=(u_is_halo && float(gl_InstanceID)==0.0) ? 1.0 : 0.0;v_gamma_scale_size_fade_opacity=vec3(gamma_scale,size,out_fade_opacity);v_tex_a=a_tex/u_texsize;
#ifdef RENDER_TEXT_AND_SYMBOL
is_sdf=a_size[0]-2.0*a_size_min;v_tex_a_icon=a_tex/u_texsize_icon;
#endif
#ifdef ICON_TRANSITION
v_tex_b=a_texb/u_texsize;
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=e;
#endif
}`),terrainRaster:Mi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image0;in vec2 v_pos0;
#ifdef FOG
in float v_fog_opacity;
#endif
#ifdef RENDER_SHADOWS
in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;
#endif
uniform vec3 u_ground_shadow_factor;void main() {vec4 image_color=texture(u_image0,v_pos0);vec4 color;
#ifdef LIGHTING_3D_MODE
const vec3 normal=vec3(0.0,0.0,1.0);
#ifdef RENDER_SHADOWS
float cutoffOpacity=1.0;
#ifdef RENDER_CUTOFF
cutoffOpacity=cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w);
#endif
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
vec3 unlit_base=image_color.rgb*(1.0-image_color.a);vec3 emissive_base=image_color.rgb*image_color.a;float ndotl=u_shadow_direction.z;float occlusion=ndotl < 0.0 ? 1.0 : shadow_occlusion(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,0.0);ndotl=max(0.0,ndotl);vec3 lit=apply_lighting(unlit_base,normal,mix(1.0,(1.0-(u_shadow_intensity*occlusion))*ndotl,cutoffOpacity));vec3 emissive=compute_emissive_draped(emissive_base,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=lit+emissive;color.a=1.0;
#else
float lighting_factor=shadowed_light_factor_normal_unbiased(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);color=apply_lighting(image_color,normal,mix(1.0,lighting_factor,cutoffOpacity));
#endif
#else
float lighting_factor=u_lighting_directional_dir.z;color=apply_lighting(image_color,normal,lighting_factor);
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
color.rgb=mix(color.rgb,image_color.rgb,image_color.a);color.a=1.0;
#endif
#endif
#else
color=image_color;
#endif
#ifdef FOG
#ifdef ZERO_EXAGGERATION
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#else
color=fog_dither(fog_apply_from_vert(color,v_fog_opacity));
#endif
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;uniform float u_skirt_height;in vec2 a_pos;out vec2 v_pos0;
#ifdef FOG
out float v_fog_opacity;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;out float v_depth;
#endif
void main() {vec3 decomposedPosAndSkirt=decomposeToPosAndSkirt(a_pos);float skirt=decomposedPosAndSkirt.z;vec2 decodedPos=decomposedPosAndSkirt.xy;float elevation=elevation(decodedPos)-skirt*u_skirt_height;v_pos0=decodedPos/8192.0;gl_Position=u_matrix*vec4(decodedPos,elevation,1.0);
#ifdef FOG
#ifdef ZERO_EXAGGERATION
v_fog_pos=fog_position(decodedPos);
#else
v_fog_opacity=fog(fog_position(vec3(decodedPos,elevation)));
#endif
#endif
#ifdef RENDER_SHADOWS
vec3 pos=vec3(decodedPos,elevation);v_pos_light_view_0=u_light_matrix_0*vec4(pos,1.);v_pos_light_view_1=u_light_matrix_1*vec4(pos,1.);
#endif
}`),terrainDepth:Mi("precision highp float;in float v_depth;void main() {glFragColor=pack_depth(v_depth);}",`#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;in vec2 a_pos;out float v_depth;void main() {float elevation=elevation(a_pos);gl_Position=u_matrix*vec4(a_pos,elevation,1.0);v_depth=gl_Position.z/gl_Position.w;}`),skybox:Mi(`#include "_prelude_fog.fragment.glsl"
in lowp vec3 v_uv;uniform lowp samplerCube u_cubemap;uniform lowp float u_opacity;uniform highp float u_temporal_offset;uniform highp vec3 u_sun_direction;float sun_disk(highp vec3 ray_direction,highp vec3 sun_direction) {highp float cos_angle=dot(normalize(ray_direction),sun_direction);const highp float cos_sun_angular_diameter=0.99996192306;const highp float smoothstep_delta=1e-5;return smoothstep(
cos_sun_angular_diameter-smoothstep_delta,cos_sun_angular_diameter+smoothstep_delta,cos_angle);}float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec3 uv=v_uv;const float y_bias=0.015;uv.y+=y_bias;uv.y=pow(abs(uv.y),1.0/5.0);uv.y=map(uv.y,0.0,1.0,-1.0,1.0);vec3 sky_color=texture(u_cubemap,uv).rgb;
#ifdef FOG
sky_color=fog_apply_sky_gradient(v_uv.xzy,sky_color);
#endif
sky_color+=0.1*sun_disk(v_uv,u_sun_direction);glFragColor=vec4(sky_color*u_opacity,u_opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,ia),skyboxGradient:Mi(`#include "_prelude_fog.fragment.glsl"
in highp vec3 v_uv;uniform lowp sampler2D u_color_ramp;uniform highp vec3 u_center_direction;uniform lowp float u_radius;uniform lowp float u_opacity;uniform highp float u_temporal_offset;void main() {float progress=acos(dot(normalize(v_uv),u_center_direction))/u_radius;vec4 color=texture(u_color_ramp,vec2(progress,0.5));
#ifdef FOG
color.rgb=fog_apply_sky_gradient(v_uv.xzy,color.rgb/color.a)*color.a;
#endif
color*=u_opacity;glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,ia),skyboxCapture:Mi(`
in highp vec3 v_position;uniform highp float u_sun_intensity;uniform highp float u_luminance;uniform lowp vec3 u_sun_direction;uniform highp vec4 u_color_tint_r;uniform highp vec4 u_color_tint_m;precision highp float;
#define BETA_R                  vec3(5.5e-6,13.0e-6,22.4e-6)
#define BETA_M                  vec3(21e-6,21e-6,21e-6)
#define MIE_G                   0.76
#define DENSITY_HEIGHT_SCALE_R  8000.0
#define DENSITY_HEIGHT_SCALE_M  1200.0
#define PLANET_RADIUS           6360e3
#define ATMOSPHERE_RADIUS       6420e3
#define SAMPLE_STEPS            10
#define DENSITY_STEPS           4
float ray_sphere_exit(vec3 orig,vec3 dir,float radius) {float a=dot(dir,dir);float b=2.0*dot(dir,orig);float c=dot(orig,orig)-radius*radius;float d=sqrt(b*b-4.0*a*c);return (-b+d)/(2.0*a);}vec3 extinction(vec2 density) {return exp(-vec3(BETA_R*u_color_tint_r.a*density.x+BETA_M*u_color_tint_m.a*density.y));}vec2 local_density(vec3 point) {float height=max(length(point)-PLANET_RADIUS,0.0);float exp_r=exp(-height/DENSITY_HEIGHT_SCALE_R);float exp_m=exp(-height/DENSITY_HEIGHT_SCALE_M);return vec2(exp_r,exp_m);}float phase_ray(float cos_angle) {return (3.0/(16.0*PI))*(1.0+cos_angle*cos_angle);}float phase_mie(float cos_angle) {return (3.0/(8.0*PI))*((1.0-MIE_G*MIE_G)*(1.0+cos_angle*cos_angle))/((2.0+MIE_G*MIE_G)*pow(1.0+MIE_G*MIE_G-2.0*MIE_G*cos_angle,1.5));}vec2 density_to_atmosphere(vec3 point,vec3 light_dir) {float ray_len=ray_sphere_exit(point,light_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(DENSITY_STEPS);vec2 density_point_to_atmosphere=vec2(0.0);for (int i=0; i < DENSITY_STEPS;++i) {vec3 point_on_ray=point+light_dir*((float(i)+0.5)*step_len);density_point_to_atmosphere+=local_density(point_on_ray)*step_len;;}return density_point_to_atmosphere;}vec3 atmosphere(vec3 ray_dir,vec3 sun_direction,float sun_intensity) {vec2 density_orig_to_point=vec2(0.0);vec3 scatter_r=vec3(0.0);vec3 scatter_m=vec3(0.0);vec3 origin=vec3(0.0,PLANET_RADIUS,0.0);float ray_len=ray_sphere_exit(origin,ray_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(SAMPLE_STEPS);for (int i=0; i < SAMPLE_STEPS;++i) {vec3 point_on_ray=origin+ray_dir*((float(i)+0.5)*step_len);vec2 density=local_density(point_on_ray)*step_len;density_orig_to_point+=density;vec2 density_point_to_atmosphere=density_to_atmosphere(point_on_ray,sun_direction);vec2 density_orig_to_atmosphere=density_orig_to_point+density_point_to_atmosphere;vec3 extinction=extinction(density_orig_to_atmosphere);scatter_r+=density.x*extinction;scatter_m+=density.y*extinction;}float cos_angle=dot(ray_dir,sun_direction);float phase_r=phase_ray(cos_angle);float phase_m=phase_mie(cos_angle);vec3 beta_r=BETA_R*u_color_tint_r.rgb*u_color_tint_r.a;vec3 beta_m=BETA_M*u_color_tint_m.rgb*u_color_tint_m.a;return (scatter_r*phase_r*beta_r+scatter_m*phase_m*beta_m)*sun_intensity;}const float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;vec3 uncharted2_tonemap(vec3 x) {return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;}void main() {vec3 ray_direction=v_position;ray_direction.y=pow(ray_direction.y,5.0);const float y_bias=0.015;ray_direction.y+=y_bias;vec3 color=atmosphere(normalize(ray_direction),u_sun_direction,u_sun_intensity);float white_scale=1.0748724675633854;color=uncharted2_tonemap((log2(2.0/pow(u_luminance,4.0)))*color)*white_scale;glFragColor=vec4(color,1.0);}`,"in highp vec3 a_pos_3f;uniform mat3 u_matrix_3f;out highp vec3 v_position;float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec4 pos=vec4(u_matrix_3f*a_pos_3f,1.0);v_position=pos.xyz;v_position.y*=-1.0;v_position.y=map(v_position.y,-1.0,1.0,0.0,1.0);gl_Position=vec4(a_pos_3f.xy,0.0,1.0);}"),globeRaster:Mi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image0;uniform float u_far_z_cutoff;in vec2 v_pos0;
#ifndef FOG
uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform vec2 u_viewport;
#endif
void main() {vec4 color;
#ifdef CUSTOM_ANTIALIASING
highp vec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float norm_dist_from_center=1.0-length(closest_point-u_globe_pos)/u_globe_radius;const float antialias_pixel=2.0;highp float antialias_factor=antialias_pixel*fwidth(norm_dist_from_center);highp float antialias=smoothstep(0.0,antialias_factor,norm_dist_from_center);vec4 raster=texture(u_image0,v_pos0);
#ifdef LIGHTING_3D_MODE
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
raster=apply_lighting_with_emission_ground(raster,raster.a);color=vec4(clamp(raster.rgb,vec3(0),vec3(1))*antialias,antialias);
#else
raster=apply_lighting_ground(raster);color=vec4(raster.rgb*antialias,raster.a*antialias);
#endif
#else
color=vec4(raster.rgb*antialias,raster.a*antialias);
#endif
#else
color=texture(u_image0,v_pos0);
#ifdef LIGHTING_3D_MODE
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
color=apply_lighting_with_emission_ground(color,color.a);color.a=1.0;
#else
color=apply_lighting_ground(color);
#endif
#endif
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
color*=1.0-step(u_far_z_cutoff,1.0/gl_FragCoord.w);glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_proj_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform float u_zoom_transition;uniform vec2 u_merc_center;uniform mat3 u_grid_matrix;uniform float u_skirt_height;
#ifdef GLOBE_POLES
in vec3 a_globe_pos;in vec2 a_uv;
#else
in vec2 a_pos;
#endif
out vec2 v_pos0;void main() {
#ifdef GLOBE_POLES
vec3 globe_pos=a_globe_pos;vec2 uv=a_uv;
#else
float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float uvY=mercatorY*tiles-idy;float mercatorX=mercatorXfromLng(latLng[1]);float uvX=mercatorX*tiles-idx;vec3 globe_pos=latLngToECEF(latLng.xy);vec2 merc_pos=vec2(mercatorX,mercatorY);vec2 uv=vec2(uvX,uvY);
#endif
v_pos0=uv;vec2 tile_pos=uv*EXTENT;vec3 globe_derived_up_vector=normalize(globe_pos)*u_tile_up_scale;
#ifdef GLOBE_POLES
vec3 up_vector=globe_derived_up_vector;
#else
vec3 up_vector=elevationVector(tile_pos);
#endif
float height=elevation(tile_pos);globe_pos+=up_vector*height;
#ifndef GLOBE_POLES
globe_pos-=globe_derived_up_vector*u_skirt_height*decomposed_pos_and_skirt.z;
#endif
#ifdef GLOBE_POLES
vec4 interpolated_pos=u_globe_matrix*vec4(globe_pos,1.0);
#else
vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {merc_world_pos=vec4(merc_pos,height-u_skirt_height*decomposed_pos_and_skirt.z,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition),1.0);
#endif
gl_Position=u_proj_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
}`),globeAtmosphere:Mi(`#include "_prelude_fog.fragment.glsl"
uniform float u_transition;uniform highp float u_fadeout_range;uniform highp float u_temporal_offset;uniform vec4 u_color;uniform vec4 u_high_color;uniform vec4 u_space_color;uniform float u_horizon_angle;in highp vec3 v_ray_dir;in highp vec3 v_horizon_dir;void main() {highp vec3 dir=normalize(v_ray_dir);float globe_pos_dot_dir;
#ifdef PROJECTION_GLOBE_VIEW
globe_pos_dot_dir=dot(u_globe_pos,dir);highp vec3 closest_point_forward=abs(globe_pos_dot_dir)*dir;float norm_dist_from_center=length(closest_point_forward-u_globe_pos)/u_globe_radius;if (norm_dist_from_center < 0.98) {
#ifdef ALPHA_PASS
glFragColor=vec4(0,0,0,0);return;
#else
#ifdef NATIVE
glFragColor=vec4(1,1,1,1);
#else
glFragColor=vec4(0,0,0,1);
#endif
return;
#endif
}
#endif
highp vec3 horizon_dir=normalize(v_horizon_dir);float horizon_angle_mercator=dir.y < horizon_dir.y ?
0.0 : max(acos(clamp(dot(dir,horizon_dir),-1.0,1.0)),0.0);float horizon_angle;
#ifdef PROJECTION_GLOBE_VIEW
highp vec3 closest_point=globe_pos_dot_dir*dir;highp float closest_point_to_center=length(closest_point-u_globe_pos);highp float theta=asin(clamp(closest_point_to_center/length(u_globe_pos),-1.0,1.0));horizon_angle=globe_pos_dot_dir < 0.0 ?
PI-theta-u_horizon_angle : theta-u_horizon_angle;float angle_t=pow(u_transition,10.0);horizon_angle=mix(horizon_angle,horizon_angle_mercator,angle_t);
#else
horizon_angle=horizon_angle_mercator;
#endif
horizon_angle/=PI;float t=exp(-horizon_angle/u_fadeout_range);float alpha_0=u_color.a;float alpha_1=u_high_color.a;float alpha_2=u_space_color.a;vec3 color_stop_0=u_color.rgb;vec3 color_stop_1=u_high_color.rgb;vec3 color_stop_2=u_space_color.rgb;
#ifdef ALPHA_PASS
float a0=mix(alpha_2,1.0,alpha_1);float a1=mix(a0,1.0,alpha_0);float a2=mix(a0,a1,t);float a =mix(alpha_2,a2,t);glFragColor=vec4(1.0,1.0,1.0,a);
#else
vec3 c0=mix(color_stop_2,color_stop_1,alpha_1);vec3 c1=mix(c0,color_stop_0,alpha_0);vec3 c2=mix(c0,c1,t);vec3 c=c2;glFragColor=vec4(c*t,t);
#endif
}`,`in vec3 a_pos;in vec2 a_uv;uniform vec3 u_frustum_tl;uniform vec3 u_frustum_tr;uniform vec3 u_frustum_br;uniform vec3 u_frustum_bl;uniform float u_horizon;out highp vec3 v_ray_dir;out highp vec3 v_horizon_dir;void main() {v_ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,a_uv.x),mix(u_frustum_bl,u_frustum_br,a_uv.x),a_uv.y);v_horizon_dir=mix(
mix(u_frustum_tl,u_frustum_bl,u_horizon),mix(u_frustum_tr,u_frustum_br,u_horizon),a_uv.x);gl_Position=vec4(a_pos,1.0);}`),model:Mi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform float u_opacity;uniform vec3 u_lightcolor;uniform vec3 u_lightpos;uniform float u_lightintensity;uniform vec4 u_baseColorFactor;uniform vec4 u_emissiveFactor;uniform float u_metallicFactor;uniform float u_roughnessFactor;uniform float u_emissive_strength;in highp vec4 v_position_height;in lowp vec4 v_color_mix;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth_shadows;
#endif
#ifdef OCCLUSION_TEXTURE_TRANSFORM
uniform vec4 u_occlusionTextureTransform;
#endif
#pragma mapbox: define-attribute highp vec3 normal_3f
#pragma mapbox: define-attribute highp vec3 color_3f
#pragma mapbox: define-attribute highp vec4 color_4f
#pragma mapbox: define-attribute highp vec2 uv_2f
#pragma mapbox: initialize-attribute highp vec3 normal_3f
#pragma mapbox: initialize-attribute highp vec3 color_3f
#pragma mapbox: initialize-attribute highp vec4 color_4f
#pragma mapbox: initialize-attribute highp vec2 uv_2f
#ifdef HAS_ATTRIBUTE_a_pbr
in lowp vec4 v_roughness_metallic_emissive_alpha;in mediump vec4 v_height_based_emission_params;
#endif
#ifdef HAS_TEXTURE_u_baseColorTexture
uniform sampler2D u_baseColorTexture;uniform bool u_baseTextureIsAlpha;uniform bool u_alphaMask;uniform float u_alphaCutoff;
#endif
#ifdef HAS_TEXTURE_u_metallicRoughnessTexture
uniform sampler2D u_metallicRoughnessTexture;
#endif
#ifdef HAS_TEXTURE_u_occlusionTexture
uniform sampler2D u_occlusionTexture;uniform float u_aoIntensity;
#endif
#ifdef HAS_TEXTURE_u_normalTexture
uniform sampler2D u_normalTexture;
#endif
#ifdef HAS_TEXTURE_u_emissionTexture
uniform sampler2D u_emissionTexture;
#endif
#ifdef APPLY_LUT_ON_GPU
uniform highp sampler3D u_lutTexture;
#endif
#ifdef TERRAIN_FRAGMENT_OCCLUSION
in highp float v_depth;uniform highp sampler2D u_depthTexture;uniform highp vec2 u_inv_depth_size;uniform highp vec2 u_depth_range_unpack;
#ifdef DEPTH_D24
highp float unpack_depth(highp float depth) {return  depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}
#else
highp float unpack_depth_rgba(highp vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}
#endif
bool isOccluded() {highp vec2 coord=gl_FragCoord.xy*u_inv_depth_size;
#ifdef DEPTH_D24
highp float depth=unpack_depth(texture(u_depthTexture,coord).r);
#else
highp float depth=unpack_depth_rgba(texture(u_depthTexture,coord));
#endif
return v_depth > depth+0.0005;}
#endif
#define saturate(_x) clamp(_x,0.,1.)
vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}float calculate_NdotL(vec3 normal,vec3 lightDir) {const float ext=0.70710678118;return (clamp(dot(normal,lightDir),-ext,1.0)+ext)/(1.0+ext);}vec3 getDiffuseShadedColor(vec3 albedo,vec3 normal,vec3 lightDir,vec3 lightColor)
{
#ifdef LIGHTING_3D_MODE
vec3 transformed_normal=vec3(-normal.xy,normal.z);float lighting_factor;
#ifdef RENDER_SHADOWS
lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
lighting_factor=saturate(dot(transformed_normal,u_lighting_directional_dir));
#endif
return apply_lighting(albedo,transformed_normal,lighting_factor);
#else
vec3 n=normal;float colorvalue=((albedo.x*0.2126)+(albedo.y*0.7152))+(albedo.z*0.0722);vec3 c=vec3(0.03,0.03,0.03);float directional=clamp(dot(n,vec3(lightDir)),0.0,1.0);directional=mix(1.0-u_lightintensity,max((1.0-colorvalue)+u_lightintensity,1.0),directional);vec3 c3=c+clamp((albedo*directional)*lightColor,mix(vec3(0.0),vec3(0.3),vec3(1.0)-lightColor),vec3(1.0));return c3;
#endif
}vec4 getBaseColor() {vec4 albedo=u_baseColorFactor;
#ifdef HAS_ATTRIBUTE_a_color_3f
albedo*=vec4(color_3f,1.0);
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
#else
#ifdef HAS_ATTRIBUTE_a_color_4f
albedo*=color_4f;
#endif
#endif
#if defined (HAS_TEXTURE_u_baseColorTexture) && defined (HAS_ATTRIBUTE_a_uv_2f)
vec4 texColor=texture(u_baseColorTexture,uv_2f);if(u_alphaMask) {if (texColor.w < u_alphaCutoff) {discard;}}
#ifdef UNPREMULT_TEXTURE_IN_SHADER
if(texColor.w > 0.0) {texColor.rgb/=texColor.w;}texColor.w=1.0;
#endif
if(u_baseTextureIsAlpha) {if (texColor.r < 0.5) {discard;}} else {texColor.rgb=sRGBToLinear(texColor.rgb);albedo*=texColor;}
#endif
vec4 color=vec4(mix(albedo.rgb,v_color_mix.rgb,v_color_mix.a),albedo.a);
#ifdef APPLY_LUT_ON_GPU
color=applyLUT(u_lutTexture,color);
#endif
return color;}highp mat3 cotangentFrame(highp vec3 N,highp vec3 p,highp vec2 uv ) {
#ifdef HAS_TEXTURE_u_normalTexture
highp vec3 dp1=vec3(dFdx(p.x),dFdx(p.y),dFdx(p.z));highp vec3 dp2=vec3(dFdy(p.x),dFdy(p.y),dFdy(p.z));highp vec2 duv1=vec2(dFdx(uv.x),dFdx(uv.y));highp vec2 duv2=vec2(dFdy(uv.x),dFdy(uv.y));highp vec3 dp2perp=cross( dp2,N );highp vec3 dp1perp=cross( N,dp1 );highp vec3 T=dp2perp*duv1.x+dp1perp*duv2.x;highp vec3 B=dp2perp*duv1.y+dp1perp*duv2.y;highp float lengthT=dot(T,T);highp float lengthB=dot(B,B);highp float maxLength=max(lengthT,lengthB);highp float invmax=inversesqrt( maxLength );highp mat3 res=mat3( T*invmax,B*invmax,N );return res;
#else
return mat3(1.0);
#endif
}highp vec3 getNormal(){highp vec3 n;
#ifdef HAS_ATTRIBUTE_a_normal_3f
n=normalize(normal_3f);
#else
highp vec3 fdx=vec3(dFdx(v_position_height.x),dFdx(v_position_height.y),dFdx(v_position_height.z));highp vec3 fdy=vec3(dFdy(v_position_height.x),dFdy(v_position_height.y),dFdy(v_position_height.z));n=normalize(cross(fdx,fdy))*-1.0;
#endif
#if defined(HAS_TEXTURE_u_normalTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
vec3 nMap=texture( u_normalTexture,uv_2f).xyz;nMap=normalize(2.0*nMap-vec3(1.0));highp vec3 v=normalize(-v_position_height.xyz);highp mat3 TBN=cotangentFrame(n,v,uv_2f);n=normalize(TBN*nMap);
#endif
return n;}struct Material {float perceptualRoughness;float alphaRoughness;float metallic;vec3 f90;vec4 baseColor;vec3 diffuseColor;vec3 specularColor;highp vec3 normal;};Material getPBRMaterial() {Material mat;mat.baseColor=getBaseColor();mat.perceptualRoughness=u_roughnessFactor;mat.metallic=u_metallicFactor;
#ifdef HAS_ATTRIBUTE_a_pbr
mat.perceptualRoughness=v_roughness_metallic_emissive_alpha.x;mat.metallic=v_roughness_metallic_emissive_alpha.y;mat.baseColor.w*=v_roughness_metallic_emissive_alpha.w;
#endif
#if defined(HAS_TEXTURE_u_metallicRoughnessTexture) && defined(HAS_ATTRIBUTE_a_uv_2f) 
vec4 mrSample=texture(u_metallicRoughnessTexture,uv_2f);mat.perceptualRoughness*=mrSample.g;mat.metallic*=mrSample.b;
#endif
const float c_minRoughness=0.04;mat.perceptualRoughness=clamp(mat.perceptualRoughness,c_minRoughness,1.0);mat.metallic=saturate(mat.metallic);mat.alphaRoughness=mat.perceptualRoughness*mat.perceptualRoughness;const vec3 f0=vec3(0.04);mat.diffuseColor=mat.baseColor.rgb*(vec3(1.0)-f0);mat.diffuseColor*=1.0-mat.metallic;mat.specularColor=mix(f0,mat.baseColor.rgb,mat.metallic);highp float reflectance=max(max(mat.specularColor.r,mat.specularColor.g),mat.specularColor.b);highp float reflectance90=saturate(reflectance*25.0);mat.f90=vec3(reflectance90);mat.normal=getNormal();return mat;}float V_GGX(float NdotL,float NdotV,float roughness)
{float a2=roughness*roughness;float GGXV=NdotL*sqrt(NdotV*NdotV*(1.0-a2)+a2);float GGXL=NdotV*sqrt(NdotL*NdotL*(1.0-a2)+a2);return 0.5/(GGXV+GGXL);}float V_GGXFast(float NdotL,float NdotV,float roughness) {float a=roughness;float GGXV=NdotL*(NdotV*(1.0-a)+a);float GGXL=NdotV*(NdotL*(1.0-a)+a);return 0.5/(GGXV+GGXL);}vec3 F_Schlick(vec3 specularColor,vec3 f90,float VdotH)
{return specularColor+(f90-specularColor)*pow(clamp(1.0-VdotH,0.0,1.0),5.0);}vec3 F_SchlickFast(vec3 specularColor,float VdotH)
{float x=1.0-VdotH;float x4=x*x*x*x;return specularColor+(1.0-specularColor)*x4*x;}float D_GGX(highp float NdotH,float alphaRoughness)
{highp float a4=alphaRoughness*alphaRoughness;highp float f=(NdotH*a4-NdotH)*NdotH+1.0;return a4/(PI*f*f);}vec3 diffuseBurley(Material mat,float LdotH,float NdotL,float NdotV)
{float f90=2.0*LdotH*LdotH*mat.alphaRoughness-0.5;return (mat.diffuseColor/PI)*(1.0+f90*pow((1.0-NdotL),5.0))*(1.0+f90*pow((1.0-NdotV),5.0));}vec3 diffuseLambertian(Material mat)
{
#ifdef LIGHTING_3D_MODE
return mat.diffuseColor;
#else
return mat.diffuseColor/PI;
#endif
}vec3 EnvBRDFApprox(vec3 specularColor,float roughness,highp float NdotV)
{vec4 c0=vec4(-1,-0.0275,-0.572,0.022);vec4 c1=vec4(1,0.0425,1.04,-0.04);highp vec4 r=roughness*c0+c1;highp float a004=min(r.x*r.x,exp2(-9.28*NdotV))*r.x+r.y;vec2 AB=vec2(-1.04,1.04)*a004+r.zw;return specularColor*AB.x+AB.y;}vec3 computeIndirectLightContribution(Material mat,float NdotV,vec3 normal)
{vec3 env_light=vec3(0.65,0.65,0.65);
#ifdef LIGHTING_3D_MODE
float ambient_factor=calculate_ambient_directional_factor(normal);env_light=u_lighting_ambient_color*ambient_factor;
#endif
vec3 envBRDF=EnvBRDFApprox(mat.specularColor,mat.perceptualRoughness,NdotV);vec3 indirectSpecular= envBRDF*env_light;vec3 indirectDiffuse=mat.diffuseColor*env_light;return indirectSpecular+indirectDiffuse;}vec3 computeLightContribution(Material mat,vec3 lightPosition,vec3 lightColor)
{highp vec3 n=mat.normal;highp vec3 v=normalize(-v_position_height.xyz);highp vec3 l=normalize(lightPosition);highp vec3 h=normalize(v+l);float NdotV=clamp(abs(dot(n,v)),0.001,1.0);float NdotL=saturate(dot(n,l));highp float NdotH=saturate(dot(n,h));float VdotH=saturate(dot(v,h));vec3 f=F_SchlickFast(mat.specularColor,VdotH);float g=V_GGXFast(NdotL,NdotV,mat.alphaRoughness);float d=D_GGX(NdotH,mat.alphaRoughness);vec3 diffuseTerm=(1.0-f)*diffuseLambertian(mat);vec3 specularTerm=f*g*d;vec3 transformed_normal=vec3(-n.xy,n.z);float lighting_factor;
#ifdef RENDER_SHADOWS
lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
lighting_factor=NdotL;
#endif
vec3 directLightColor=(specularTerm+diffuseTerm)*lighting_factor*lightColor;vec3 indirectLightColor=computeIndirectLightContribution(mat,NdotV,transformed_normal);vec3 color=(saturate(directLightColor)+indirectLightColor);float intensityFactor=1.0;
#if !defined(LIGHTING_3D_MODE)
const vec3 luminosityFactor=vec3(0.2126,0.7152,0.0722);float luminance=dot(diffuseTerm,luminosityFactor);intensityFactor=mix((1.0-u_lightintensity),max((1.0-luminance+u_lightintensity),1.0),NdotL);
#endif
color*=intensityFactor;return color;}void main() {
#ifdef TERRAIN_FRAGMENT_OCCLUSION
if (isOccluded()) {discard;}
#endif
vec3 lightDir=u_lightpos;vec3 lightColor=u_lightcolor;
#ifdef LIGHTING_3D_MODE
lightDir=u_lighting_directional_dir;lightDir.xy=-lightDir.xy;lightColor=u_lighting_directional_color;
#endif
vec4 finalColor;
#ifdef DIFFUSE_SHADED
vec3 N=getNormal();vec3 baseColor=getBaseColor().rgb;vec3 diffuse=getDiffuseShadedColor(baseColor,N,lightDir,lightColor);
#ifdef HAS_TEXTURE_u_occlusionTexture
float ao=(texture(u_occlusionTexture,uv_2f).r-1.0)*u_aoIntensity+1.0;diffuse*=ao;
#endif
finalColor=vec4(mix(diffuse,baseColor,u_emissive_strength),1.0)*u_opacity;
#else
Material mat=getPBRMaterial();vec3 color=computeLightContribution(mat,lightDir,lightColor);float ao=1.0;
#if defined (HAS_TEXTURE_u_occlusionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
#ifdef OCCLUSION_TEXTURE_TRANSFORM
vec2 uv=uv_2f.xy*u_occlusionTextureTransform.zw+u_occlusionTextureTransform.xy;
#else
vec2 uv=uv_2f;
#endif
ao=(texture(u_occlusionTexture,uv).x-1.0)*u_aoIntensity+1.0;color*=ao;
#endif
vec4 emissive=u_emissiveFactor;
#if defined(HAS_TEXTURE_u_emissionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
emissive.rgb*=sRGBToLinear(texture(u_emissionTexture,uv_2f).rgb);
#endif
#ifdef APPLY_LUT_ON_GPU
float emissiveFactorLength=max(length(u_emissiveFactor.rgb),0.001);emissive.rgb=sRGBToLinear(applyLUT(u_lutTexture,linearTosRGB(emissive.rgb/emissiveFactorLength).rbg))*emissiveFactorLength;
#endif
color+=emissive.rgb;float opacity=mat.baseColor.w*u_opacity;
#ifdef HAS_ATTRIBUTE_a_pbr
float resEmission=v_roughness_metallic_emissive_alpha.z;resEmission*=v_height_based_emission_params.z+v_height_based_emission_params.w*pow(clamp(v_height_based_emission_params.x,0.0,1.0),v_height_based_emission_params.y);vec3 color_mix=v_color_mix.rgb;
#ifdef APPLY_LUT_ON_GPU
color_mix=applyLUT(u_lutTexture,color_mix);
#endif
color=mix(color,color_mix,min(1.0,resEmission));
#ifdef HAS_ATTRIBUTE_a_color_4f
float distance=length(vec2(1.3*max(0.0,abs(color_4f.x)-color_4f.z),color_4f.y));distance+= mix(0.5,0.0,clamp(resEmission-1.0,0.0,1.0));opacity*=v_roughness_metallic_emissive_alpha.w*saturate(1.0-distance*distance);
#endif
#endif
vec3 unlitColor=mat.baseColor.rgb*ao+emissive.rgb;color=mix(color,unlitColor,u_emissive_strength);color=linearTosRGB(color);color*=opacity;finalColor=vec4(color,opacity);
#endif
#ifdef FOG
finalColor=fog_dither(fog_apply_premultiplied(finalColor,v_fog_pos,v_position_height.w));
#endif
#ifdef RENDER_CUTOFF
finalColor*=v_cutoff_opacity;
#endif
#ifdef INDICATOR_CUTOUT
finalColor=applyCutout(finalColor,v_position_height.w);
#endif
glFragColor=finalColor;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec3 a_pos_3f;
#pragma mapbox: define-attribute highp vec3 normal_3f
#pragma mapbox: define-attribute highp vec2 uv_2f
#pragma mapbox: define-attribute highp vec3 color_3f
#pragma mapbox: define-attribute highp vec4 color_4f
#pragma mapbox: define-attribute-vertex-shader-only highp vec4 pbr
#pragma mapbox: define-attribute-vertex-shader-only highp vec3 heightBasedEmissiveStrength
uniform mat4 u_matrix;uniform mat4 u_node_matrix;uniform mat4 u_lighting_matrix;uniform vec3 u_camera_pos;uniform vec4 u_color_mix;
#ifdef INSTANCED_ARRAYS
in vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;
#else
uniform highp mat4 u_normal_matrix;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth_shadows;
#endif
out vec4 v_position_height;out lowp vec4 v_color_mix;
#ifdef TERRAIN_FRAGMENT_OCCLUSION
out highp float v_depth;
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
out lowp vec4 v_roughness_metallic_emissive_alpha;out mediump vec4 v_height_based_emission_params;
#endif
vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}void main() {
#pragma mapbox: initialize-attribute highp vec3 normal_3f
#pragma mapbox: initialize-attribute highp vec2 uv_2f
#pragma mapbox: initialize-attribute highp vec3 color_3f
#pragma mapbox: initialize-attribute highp vec4 color_4f
#pragma mapbox: initialize-attribute-custom highp vec4 pbr
#pragma mapbox: initialize-attribute-custom highp vec3 heightBasedEmissiveStrength
highp mat4 normal_matrix;
#ifdef INSTANCED_ARRAYS
normal_matrix=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);
#else
normal_matrix=u_normal_matrix;
#endif
vec3 local_pos;mat3 rs;
#ifdef MODEL_POSITION_ON_GPU
vec3 pos_color=normal_matrix[0].xyz;vec4 translate=normal_matrix[1];vec3 pos_a=floor(pos_color);vec3 rgb=1.05*(pos_color-pos_a);float hidden=float(pos_a.x > EXTENT);float color_mix=pos_a.z/100.0;v_color_mix=vec4(sRGBToLinear(rgb),color_mix);float meter_to_tile=normal_matrix[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);rs[0].x=normal_matrix[1].w;rs[0].yz=normal_matrix[2].xy;rs[1].xy=normal_matrix[2].zw;rs[1].z=normal_matrix[3].x;rs[2].xyz=normal_matrix[3].yzw;vec4 pos_node=u_lighting_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;local_pos=pos.xyz;gl_Position=mix(u_matrix*pos,AWAY,hidden);pos.z*=meter_to_tile;v_position_height.xyz=pos.xyz-u_camera_pos;
#else
local_pos=a_pos_3f;gl_Position=u_matrix*vec4(a_pos_3f,1);v_position_height.xyz=vec3(u_lighting_matrix*vec4(a_pos_3f,1));v_color_mix=vec4(sRGBToLinear(u_color_mix.rgb),u_color_mix.a);
#endif
v_position_height.w=a_pos_3f.z;
#ifdef HAS_ATTRIBUTE_a_pbr
vec4 albedo_c=decode_color(pbr.xy);vec2 e_r_m=unpack_float(pbr.z);vec2 r_m= unpack_float(e_r_m.y*16.0);r_m.r=r_m.r*16.0;v_color_mix=vec4(albedo_c.rgb,1.0);v_roughness_metallic_emissive_alpha=vec4(vec3(r_m,e_r_m.x)/255.0,albedo_c.a);v_roughness_metallic_emissive_alpha.z*=2.0;float heightBasedRelativeIntepolation=a_pos_3f.z*heightBasedEmissiveStrength.x+heightBasedEmissiveStrength.y;v_height_based_emission_params.x=heightBasedRelativeIntepolation;v_height_based_emission_params.y=heightBasedEmissiveStrength.z;vec2 emissionMultiplierValues=unpack_float(pbr.w)/256.0;v_height_based_emission_params.z=emissionMultiplierValues.x;v_height_based_emission_params.w=emissionMultiplierValues.y-emissionMultiplierValues.x;
#endif
#ifdef FOG
v_fog_pos=fog_position(local_pos);
#endif
#ifdef RENDER_CUTOFF
v_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);
#endif
#ifdef TERRAIN_FRAGMENT_OCCLUSION
v_depth=gl_Position.z/gl_Position.w;
#endif
#ifdef HAS_ATTRIBUTE_a_normal_3f
#ifdef MODEL_POSITION_ON_GPU
float x_squared_scale=dot(rs[0],rs[0]);float y_squared_scale=dot(rs[1],rs[1]);float z_squared_scale=dot(rs[2],rs[2]);vec3 squared_scale=vec3(x_squared_scale,y_squared_scale,z_squared_scale);normal_3f=rs*((u_lighting_matrix*vec4(normal_3f,0.0)).xyz/squared_scale);normal_3f=normalize(normal_3f);
#else
normal_3f=vec3(normal_matrix*vec4(normal_3f,0));
#endif
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
#ifdef HAS_ATTRIBUTE_a_color_4f
v_roughness_metallic_emissive_alpha.w=clamp(color_4f.a*v_roughness_metallic_emissive_alpha.w*(v_roughness_metallic_emissive_alpha.z-1.0),0.0,1.0);
#endif
#endif
#ifdef RENDER_SHADOWS
vec4 shadow_pos=u_node_matrix*vec4(local_pos,1.0);
#ifdef NORMAL_OFFSET
#ifdef HAS_ATTRIBUTE_a_normal_3f
#ifdef MODEL_POSITION_ON_GPU
vec3 offset=shadow_normal_offset(vec3(-normal_3f.xy,normal_3f.z));shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();
#else
vec3 offset=shadow_normal_offset_model(normal_3f);shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();
#endif
#endif
#endif
v_pos_light_view_0=u_light_matrix_0*shadow_pos;v_pos_light_view_1=u_light_matrix_1*shadow_pos;v_depth_shadows=gl_Position.w;
#endif
}`),modelDepth:Mi(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,`in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;
#ifdef MODEL_POSITION_ON_GPU
#ifdef INSTANCED_ARRAYS
in vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;
#else
uniform highp mat4 u_instance;
#endif
uniform highp mat4 u_node_matrix;
#endif
void main() {
#ifdef MODEL_POSITION_ON_GPU
highp mat4 instance;
#ifdef INSTANCED_ARRAYS
instance=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);
#else
instance=u_instance;
#endif
vec3 pos_color=instance[0].xyz;vec4 translate=instance[1];vec3 pos_a=floor(pos_color);float hidden=float(pos_a.x > EXTENT);float meter_to_tile=instance[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);mat3 rs;rs[0].x=instance[1].w;rs[0].yz=instance[2].xy;rs[1].xy=instance[2].zw;rs[1].z=instance[3].x;rs[2].xyz=instance[3].yzw;vec4 pos_node=u_node_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;gl_Position=mix(u_matrix*pos,AWAY,hidden);
#else
gl_Position=u_matrix*vec4(a_pos_3f,1);
#endif
v_depth=gl_Position.z/gl_Position.w;}`),stars:Mi(`in highp vec2 v_uv;in mediump float v_intensity;float shapeCircle(in vec2 uv)
{float beginFade=0.6;float lengthFromCenter=length(v_uv);return 1.0-clamp((lengthFromCenter-beginFade)/(1.0-beginFade),0.0,1.0);}void main() {float alpha=shapeCircle(v_uv);vec3 color=vec3(1.0,1.0,1.0);alpha*=v_intensity;glFragColor=vec4(color*alpha,alpha);HANDLE_WIREFRAME_DEBUG;}`,`
in vec3 a_pos_3f;in vec2 a_uv;in float a_size_scale;in float a_fade_opacity;uniform mat4 u_matrix;uniform vec3 u_up;uniform vec3 u_right;uniform float u_intensity_multiplier;out highp vec2 v_uv;out mediump float v_intensity;void main() {v_uv=a_uv;v_intensity=a_fade_opacity*u_intensity_multiplier;vec3 pos=a_pos_3f;pos+=a_uv.x*u_right*a_size_scale;pos+=a_uv.y*u_up*a_size_scale;gl_Position=u_matrix*vec4(pos,1.0);}`),snowParticle:Mi("in highp vec2 uv;in highp float alphaMultiplier;uniform vec4 u_particleColor;uniform vec2 u_simpleShapeParameters;void main() {float t=clamp((length(uv)-u_simpleShapeParameters.x)/(1.0-u_simpleShapeParameters.x),0.0,1.0);float alpha=1.0-pow(t,pow(10.0,u_simpleShapeParameters.y));alpha*=alphaMultiplier;alpha*=u_particleColor.a;vec3 color=u_particleColor.rgb*alpha;glFragColor=vec4(color,alpha) ;HANDLE_WIREFRAME_DEBUG;}",`
in highp vec3 a_pos_3f;in highp vec2 a_uv;in highp vec4 a_snowParticleData;in highp vec4 a_snowParticleDataHorizontalOscillation;uniform mat4 u_modelview;uniform mat4 u_projection;uniform vec3 u_cam_pos;uniform vec2 u_screenSize;uniform float u_time;uniform float u_boxSize;uniform float u_velocityConeAperture; 
uniform float u_velocity;uniform vec3 u_direction;uniform float u_horizontalOscillationRadius; 
uniform float u_horizontalOscillationRate; 
uniform float u_billboardSize;uniform vec2 u_thinningCenterPos;uniform vec3 u_thinningShape;uniform float u_thinningAffectedRatio;uniform float u_thinningParticleOffset;out highp vec2 uv;out highp float alphaMultiplier;void main() {vec3 pos=a_pos_3f;float halfBoxSize=0.5*u_boxSize;pos.xyz*=halfBoxSize;pos+=u_cam_pos;float velocityConeApertureRad=radians(u_velocityConeAperture*0.5);float coneAnglePichRad=velocityConeApertureRad*a_snowParticleData.z;float coneAngleHeadingRad=a_snowParticleData.w*radians(360.0);vec3 localZ=normalize(u_direction);vec3 localX=normalize(cross(localZ,vec3(1,0,0)));vec3 localY=normalize(cross(localZ,localX));vec3 direction;direction.x=cos(coneAngleHeadingRad)*sin(coneAnglePichRad);direction.y=sin(coneAngleHeadingRad)*sin(coneAnglePichRad);direction.z=cos(coneAnglePichRad);direction=normalize(direction);vec3 simPosLocal=vec3(0,0,0);float velocityScale=(1.0+3.0*a_snowParticleData.y)*u_velocity;simPosLocal+=direction*velocityScale*u_time;float horizontalOscillationRadius=u_horizontalOscillationRadius*a_snowParticleDataHorizontalOscillation.x;float horizontalOscillationAngle=u_horizontalOscillationRate*u_time*(-1.0+2.0*a_snowParticleDataHorizontalOscillation.y);simPosLocal.xy+=horizontalOscillationRadius*vec2(cos(horizontalOscillationAngle),sin(horizontalOscillationAngle));vec3 simPos=localX*simPosLocal.x+
localY*simPosLocal.y+localZ*simPosLocal.z;pos+=simPos;pos=fract((pos+vec3(halfBoxSize))/vec3(u_boxSize))*u_boxSize-vec3(halfBoxSize);float clipZ=-u_cam_pos.z+pos.z;vec4 posView=u_modelview*vec4(pos,1.0);float size=u_billboardSize;alphaMultiplier=1.0;vec4 posScreen=u_projection*posView;posScreen/=posScreen.w;posScreen.xy=vec2(0.5)+posScreen.xy*0.5;posScreen.xy*=u_screenSize;vec2 thinningCenterPos=u_thinningCenterPos.xy;thinningCenterPos.y=u_screenSize.y-thinningCenterPos.y;float screenDist=length((thinningCenterPos-posScreen.xy)/(0.5*u_screenSize));screenDist+=a_snowParticleData.x*u_thinningParticleOffset;float scaleFactorMode=0.0;float thinningShapeDist=u_thinningShape.x+u_thinningShape.y;if (screenDist < thinningShapeDist) {float thinningFadeRatio=clamp((screenDist-u_thinningShape.x)/u_thinningShape.y,0.0,1.0);thinningFadeRatio=pow(thinningFadeRatio,u_thinningShape.z);if (a_snowParticleData.x < u_thinningAffectedRatio) {scaleFactorMode=1.0-thinningFadeRatio;alphaMultiplier=thinningFadeRatio;}}vec4 posScreen1=u_projection*vec4(posView.x-size,posView.yzw);posScreen1/=posScreen1.w;vec4 posScreen2=u_projection*vec4(posView.x+size,posView.yzw);posScreen2/=posScreen2.w;posScreen1.xy=vec2(0.5)+posScreen1.xy*0.5;posScreen1.xy*=u_screenSize;posScreen2.xy=vec2(0.5)+posScreen2.xy*0.5;posScreen2.xy*=u_screenSize;float screenLength=length(posScreen1.xy-posScreen2.xy);float screenEpsilon=3.0;float scaleFactor=1.0;if (screenLength < screenEpsilon) {scaleFactor=screenEpsilon/max(screenLength,0.01);scaleFactor=mix(scaleFactor,1.0,scaleFactorMode);}float screenEpsilon2=15.0;if (screenLength > screenEpsilon2) {scaleFactor=screenEpsilon2/max(screenLength,0.01);}size*=scaleFactor;vec2 right=size*vec2(1,0);vec2 up=size*vec2(0,1);posView.xy+=right*a_uv.x;posView.xy+=up*a_uv.y;uv=a_uv;gl_Position=u_projection*posView;}`),rainParticle:Mi("in highp vec2 uv;in highp float particleRandomValue;uniform sampler2D u_texScreen;uniform float u_distortionStrength;uniform vec4 u_color;uniform vec2 u_thinningCenterPos;uniform vec3 u_thinningShape;uniform float u_thinningAffectedRatio;uniform float u_thinningParticleOffset;uniform float u_shapeDirectionalPower;uniform float u_mode;void main() {vec2 st=uv*0.5+vec2(0.5);vec2 uvm=uv;uvm.y=-1.0+2.0*pow(st.y,u_shapeDirectionalPower);float shape=clamp(1.0-length(uvm),0.0,1.0);float alpha=abs(shape)*u_color.a;vec2 screenSize=vec2(textureSize(u_texScreen,0));vec2 thinningCenterPos=u_thinningCenterPos.xy;thinningCenterPos.y=screenSize.y-thinningCenterPos.y;float screenDist=length((thinningCenterPos-gl_FragCoord.xy)/(0.5*screenSize));screenDist+=(0.5+0.5*particleRandomValue)*u_thinningParticleOffset;float thinningShapeDist=u_thinningShape.x+u_thinningShape.y;float thinningAlpha=1.0;if (screenDist < thinningShapeDist) {float thinningFadeRatio=clamp((screenDist-u_thinningShape.x)/u_thinningShape.y,0.0,1.0);thinningFadeRatio=pow(thinningFadeRatio,u_thinningShape.z);thinningAlpha*=thinningFadeRatio;}vec2 offsetXY=normalize(uvm)*abs(shape);vec2 stScreen=(gl_FragCoord.xy+offsetXY*u_distortionStrength*thinningAlpha)/screenSize;vec3 colorScreen=texture(u_texScreen,stScreen).rgb;alpha*=thinningAlpha;glFragColor=mix(vec4(colorScreen,1.0),vec4(u_color.rgb*alpha,alpha),u_mode);HANDLE_WIREFRAME_DEBUG;}",`
in highp vec3 a_pos_3f;in highp vec2 a_uv;in highp vec4 a_rainParticleData;uniform mat4 u_modelview;uniform mat4 u_projection;uniform vec3 u_cam_pos;uniform float u_time;uniform float u_boxSize;uniform float u_velocityConeAperture; 
uniform float u_velocity; 
uniform vec2 u_rainDropletSize;uniform vec3 u_rainDirection;out highp vec2 uv;out highp float particleRandomValue;void main() {vec3 pos=a_pos_3f;float halfBoxSize=0.5*u_boxSize;pos*=halfBoxSize; 
pos+=u_cam_pos;float velocityConeApertureRad=radians(u_velocityConeAperture*0.5);float coneAnglePichRad=velocityConeApertureRad*a_rainParticleData.z;float coneAngleHeadingRad=a_rainParticleData.w*radians(360.0);vec3 localZ=normalize(u_rainDirection);vec3 localX=normalize(cross(localZ,vec3(1,0,0)));vec3 localY=normalize(cross(localZ,localX));vec3 directionLocal;directionLocal.x=cos(coneAngleHeadingRad)*sin(coneAnglePichRad);directionLocal.y=sin(coneAngleHeadingRad)*sin(coneAnglePichRad);directionLocal.z=cos(coneAnglePichRad);directionLocal=normalize(directionLocal);vec3 directionWorld=localX*directionLocal.x+localY*directionLocal.y+localZ*directionLocal.z;float velocityScale=(1.0+3.0*a_rainParticleData.y)*u_velocity;vec3 simPosLocal=vec3(0,0,0);simPosLocal+=directionLocal*velocityScale*u_time;vec3 simPos=localX*simPosLocal.x+
localY*simPosLocal.y+localZ*simPosLocal.z;pos+=simPos;pos=fract((pos+vec3(halfBoxSize))/vec3(u_boxSize))*u_boxSize-vec3(halfBoxSize);vec4 posView=u_modelview*vec4(pos,1.0);vec3 directionView=normalize((u_modelview*vec4(directionWorld,0.0)).xyz);vec3 side=cross(directionView,normalize(posView.xyz));posView.xyz+=side*a_uv.x*u_rainDropletSize.x;posView.xyz+=directionView*a_uv.y*u_rainDropletSize.y;uv=a_uv;particleRandomValue=a_rainParticleData.x;gl_Position=u_projection*posView;}`),vignette:Mi("uniform vec3 u_vignetteShape;uniform vec4 u_vignetteColor;in vec2 st;void main() {float screenDist=length(st);float alpha=clamp((screenDist-u_vignetteShape.x)/u_vignetteShape.y,0.0,1.0);alpha=pow(alpha,u_vignetteShape.z)*u_vignetteColor.a;vec3 color=u_vignetteColor.rgb;glFragColor=vec4(color*alpha,alpha) ;}","in vec2 a_pos_2f;out vec2 st;void main() {st=a_pos_2f;gl_Position=vec4(a_pos_2f,0,1);}"),occlusion:Mi("uniform vec4 u_color;void main() {glFragColor=u_color;}",`#include "_prelude_terrain.vertex.glsl"
in highp vec2 a_offset_xy;uniform highp vec3 u_anchorPos;uniform mat4 u_matrix;uniform vec2 u_screenSizePx;uniform vec2 u_occluderSizePx;void main() {vec3 world_pos=u_anchorPos;
#ifdef TERRAIN
float e=elevation(world_pos.xy);world_pos.z+=e;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1.0);projected_point.xy+=projected_point.w*a_offset_xy*0.5*u_occluderSizePx/u_screenSizePx;gl_Position=projected_point;}`)};function ka(p,o){const c=p.replace(/\s*\/\/[^\n]*\n/g,`
`).split(`
`);for(let m of c)if(m=m.trim(),m[0]==="#"&&m.includes("if")&&!m.includes("endif")){m=m.replace("#","").replace(/ifdef|ifndef|elif|if/g,"").replace(/!|defined|\(|\)|\|\||&&/g,"").replace(/\s+/g," ").trim();const v=m.split(" ");for(const b of v)o.includes(b)||o.push(b)}}function Mi(p,o){const c=/#include\s+"([^"]+)"/g,m=/#pragma mapbox: ([\w\-]+) ([\w]+) ([\w]+) ([\w]+)/g;let v=o.match(/(attribute(\S*)|(^\s*|;)in) (highp |mediump |lowp )?([\w]+) ([\w]+)/gm);v&&(v=v.map(k=>{const L=k.split(" ");return L[L.length-1]}),v=[...new Set(v)]);const b={},A=[],M=[];if(p=p.replace(c,(k,L)=>(M.push(L),"")),(o=o.replace(c,(k,L)=>(A.push(L),""))).includes("flat out"))return void console.error('The usage of "flat" qualifier is disallowed, see: https://bugs.webkit.org/show_bug.cgi?id=268071');let O=[...Fa];ka(p,O),ka(o,O);for(const k of[...A,...M])_l[k]||console.error(`Undefined include: ${k}`),Cc[k]||(Cc[k]=[],ka(_l[k],Cc[k])),O=[...O,...Cc[k]];return{fragmentSource:p=p.replace(m,(k,L,U,j,$)=>(b[$]=!0,L==="define"?`
#ifndef HAS_UNIFORM_u_${$}
in ${U} ${j} ${$};
#else
uniform ${U} ${j} u_${$};
#endif
`:L==="initialize"?`
#ifdef HAS_UNIFORM_u_${$}
    ${U} ${j} ${$} = u_${$};
#endif
`:L==="define-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${$}
    in ${U} ${j} ${$};
#endif
`:L==="initialize-attribute"?"":void 0)),vertexSource:o=o.replace(m,(k,L,U,j,$)=>{const Q=j==="float"?"vec2":j,Z=$.match(/color/)?"color":Q;return L==="define-attribute-vertex-shader-only"?`
#ifdef HAS_ATTRIBUTE_a_${$}
in ${U} ${j} a_${$};
#endif
`:b[$]?L==="define"?`
#ifndef HAS_UNIFORM_u_${$}
uniform lowp float u_${$}_t;
in ${U} ${Q} a_${$};
out ${U} ${j} ${$};
#else
uniform ${U} ${j} u_${$};
#endif
`:L==="initialize"?Z==="vec4"?`
#ifndef HAS_UNIFORM_u_${$}
    ${$} = a_${$};
#else
    ${U} ${j} ${$} = u_${$};
#endif
`:`
#ifndef HAS_UNIFORM_u_${$}
    ${$} = unpack_mix_${Z}(a_${$}, u_${$}_t);
#else
    ${U} ${j} ${$} = u_${$};
#endif
`:L==="define-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${$}
    in ${U} ${j} a_${$};
    out ${U} ${j} ${$};
#endif
`:L==="initialize-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${$}
    ${$} = a_${$};
#endif
`:void 0:L==="define"?`
#ifndef HAS_UNIFORM_u_${$}
uniform lowp float u_${$}_t;
in ${U} ${Q} a_${$};
#else
uniform ${U} ${j} u_${$};
#endif
`:L==="define-instanced"?Z==="mat4"?`
#ifdef INSTANCED_ARRAYS
in vec4 a_${$}0;
in vec4 a_${$}1;
in vec4 a_${$}2;
in vec4 a_${$}3;
#else
uniform ${U} ${j} u_${$};
#endif
`:`
#ifdef INSTANCED_ARRAYS
in ${U} ${Q} a_${$};
#else
uniform ${U} ${j} u_${$};
#endif
`:L==="initialize-attribute-custom"?`
#ifdef HAS_ATTRIBUTE_a_${$}
    ${U} ${j} ${$} = a_${$};
#endif
`:Z==="vec4"?`
#ifndef HAS_UNIFORM_u_${$}
    ${U} ${j} ${$} = a_${$};
#else
    ${U} ${j} ${$} = u_${$};
#endif
`:`
#ifndef HAS_UNIFORM_u_${$}
    ${U} ${j} ${$} = unpack_mix_${Z}(a_${$}, u_${$}_t);
#else
    ${U} ${j} ${$} = u_${$};
#endif
`}),staticAttributes:v,usedDefines:O,vertexIncludes:A,fragmentIncludes:M}}class qm{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffers=[],this.vao=null}bind(o,c,m,v,b,A,M,O){this.context=o;let k=this.boundPaintVertexBuffers.length!==v.length;for(let U=0;!k&&U<v.length;U++)this.boundPaintVertexBuffers[U]!==v[U]&&(k=!0);let L=this.boundDynamicVertexBuffers.length!==M.length;for(let U=0;!L&&U<M.length;U++)this.boundDynamicVertexBuffers[U]!==M[U]&&(L=!0);if(!this.vao||this.boundProgram!==c||this.boundLayoutVertexBuffer!==m||k||L||this.boundIndexBuffer!==b||this.boundVertexOffset!==A)this.freshBind(c,m,v,b,A,M,O);else{o.bindVertexArrayOES.set(this.vao);for(const U of M)U&&(U.bind(),O&&U.instanceCount&&U.setVertexAttribDivisor(o.gl,c,O));b&&b.dynamicDraw&&b.bind()}}freshBind(o,c,m,v,b,A,M){const O=o.numAttributes,k=this.context,L=k.gl;this.vao&&this.destroy(),this.vao=k.gl.createVertexArray(),k.bindVertexArrayOES.set(this.vao),this.boundProgram=o,this.boundLayoutVertexBuffer=c,this.boundPaintVertexBuffers=m,this.boundIndexBuffer=v,this.boundVertexOffset=b,this.boundDynamicVertexBuffers=A,c.enableAttributes(L,o),c.bind(),c.setVertexAttribPointers(L,o,b);for(const U of m)U.enableAttributes(L,o),U.bind(),U.setVertexAttribPointers(L,o,b);for(const U of A)U&&(U.enableAttributes(L,o),U.bind(),U.setVertexAttribPointers(L,o,b),M&&U.instanceCount&&U.setVertexAttribDivisor(L,o,M));v&&v.bind(),k.currentNumAttributes=O}destroy(){this.vao&&(this.context.gl.deleteVertexArray(this.vao),this.vao=null)}}function yl(p,o){const c=Math.pow(2,o.canonical.z),m=o.canonical.y;return[new s.aa(0,m/c).toLngLat().lat,new s.aa(0,(m+1)/c).toLngLat().lat]}function Xm(p,o,c,m,v,b,A){const M=p.context,O=M.gl,k=c.hillshadeFBO;if(!k)return;p.prepareDrawTile();const L=p.isTileAffectedByFog(o),U=p.getOrCreateProgram("hillshade",{overrideFog:L});M.activeTexture.set(O.TEXTURE0),O.bindTexture(O.TEXTURE_2D,k.colorAttachment.get());const j=((te,ee,ae,me)=>{const fe=ae.paint.get("hillshade-shadow-color"),Ae=ae.paint.get("hillshade-shadow-color-use-theme").constantOr("default")==="none",ve=ae.paint.get("hillshade-highlight-color"),be=ae.paint.get("hillshade-highlight-color-use-theme").constantOr("default")==="none",ye=ae.paint.get("hillshade-accent-color"),Ie=ae.paint.get("hillshade-accent-color-use-theme").constantOr("default")==="none",Fe=ae.paint.get("hillshade-emissive-strength");let Qe=s.ai(ae.paint.get("hillshade-illumination-direction"));if(ae.paint.get("hillshade-illumination-anchor")==="viewport")Qe-=te.transform.angle;else if(te.style&&te.style.enable3dLights()&&te.style.directionalLight){const at=te.style.directionalLight.properties.get("direction"),nt=s.cb(at.x,at.y,at.z);Qe=s.ai(nt[1])}const We=!te.options.moving;return{u_matrix:me||te.transform.calculateProjMatrix(ee.tileID.toUnwrapped(),We),u_image:0,u_latrange:yl(0,ee.tileID),u_light:[ae.paint.get("hillshade-exaggeration"),Qe],u_shadow:fe.toRenderColor(Ae?null:ae.lut),u_highlight:ve.toRenderColor(be?null:ae.lut),u_emissive_strength:Fe,u_accent:ye.toRenderColor(Ie?null:ae.lut)}})(p,c,m,p.terrain?o.projMatrix:null);p.uploadCommonUniforms(M,U,o.toUnwrapped());const{tileBoundsBuffer:$,tileBoundsIndexBuffer:Q,tileBoundsSegments:Z}=p.getTileBoundsBuffers(c);U.draw(p,O.TRIANGLES,v,b,A,li.disabled,j,m.id,$,Q,Z)}function Zm(p,o,c){if(!o.needsDEMTextureUpload)return;const m=p.context,v=m.gl;m.pixelStoreUnpackPremultiplyAlpha.set(!1),o.demTexture=o.demTexture||p.getTileTexture(c.stride);const b=c.getPixels();o.demTexture?o.demTexture.update(b,{premultiply:!1}):o.demTexture=new s.T(m,b,v.R32F,{premultiply:!1}),o.needsDEMTextureUpload=!1}function L0(p,o,c){const m=p.context,v=m.gl;if(!o.dem)return;const b=o.dem;if(m.activeTexture.set(v.TEXTURE1),Zm(p,o,b),!o.demTexture)return;o.demTexture.bind(v.NEAREST,v.CLAMP_TO_EDGE);const A=b.dim;m.activeTexture.set(v.TEXTURE0);let M=o.hillshadeFBO;if(!M){const j=new s.T(m,{width:A,height:A,data:null},v.RGBA8);j.bind(v.LINEAR,v.CLAMP_TO_EDGE),M=o.hillshadeFBO=m.createFramebuffer(A,A,!0,"renderbuffer"),M.colorAttachment.set(j.texture)}m.bindFramebuffer.set(M.framebuffer),m.viewport.set([0,0,A,A]);const{tileBoundsBuffer:O,tileBoundsIndexBuffer:k,tileBoundsSegments:L}=p.getMercatorTileBoundsBuffers(),U=[];p.linearFloatFilteringSupported()&&U.push("TERRAIN_DEM_FLOAT_FORMAT"),p.getOrCreateProgram("hillshadePrepare",{defines:U}).draw(p,v.TRIANGLES,Yt.disabled,oi.disabled,xi.unblended,li.disabled,((j,$)=>{const Q=$.stride,Z=s.ab.mat4.create();return s.ab.mat4.ortho(Z,0,s.ag,-s.ag,0,0,1),s.ab.mat4.translate(Z,Z,[0,-s.ag,0]),{u_matrix:Z,u_image:1,u_dimension:[Q,Q],u_zoom:j.overscaledZ}})(o.tileID,b),c.id,O,k,L),o.needsHillshadePrepare=!1}class or{constructor(o){this.gl=o.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(o){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class rf extends or{getDefault(){return s.aj.transparent}set(o){const c=this.current;(o.r!==c.r||o.g!==c.g||o.b!==c.b||o.a!==c.a||this.dirty)&&(this.gl.clearColor(o.r,o.g,o.b,o.a),this.current=o,this.dirty=!1)}}class nf extends or{getDefault(){return 1}set(o){(o!==this.current||this.dirty)&&(this.gl.clearDepth(o),this.current=o,this.dirty=!1)}}class sf extends or{getDefault(){return 0}set(o){(o!==this.current||this.dirty)&&(this.gl.clearStencil(o),this.current=o,this.dirty=!1)}}class of extends or{getDefault(){return[!0,!0,!0,!0]}set(o){const c=this.current;(o[0]!==c[0]||o[1]!==c[1]||o[2]!==c[2]||o[3]!==c[3]||this.dirty)&&(this.gl.colorMask(o[0],o[1],o[2],o[3]),this.current=o,this.dirty=!1)}}class Ym extends or{getDefault(){return!0}set(o){(o!==this.current||this.dirty)&&(this.gl.depthMask(o),this.current=o,this.dirty=!1)}}class Km extends or{getDefault(){return 255}set(o){(o!==this.current||this.dirty)&&(this.gl.stencilMask(o),this.current=o,this.dirty=!1)}}class N0 extends or{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(o){const c=this.current;(o.func!==c.func||o.ref!==c.ref||o.mask!==c.mask||this.dirty)&&(this.gl.stencilFunc(o.func,o.ref,o.mask),this.current=o,this.dirty=!1)}}class Rc extends or{getDefault(){const o=this.gl;return[o.KEEP,o.KEEP,o.KEEP]}set(o){const c=this.current;(o[0]!==c[0]||o[1]!==c[1]||o[2]!==c[2]||this.dirty)&&(this.gl.stencilOp(o[0],o[1],o[2]),this.current=o,this.dirty=!1)}}class Pc extends or{getDefault(){return!1}set(o){if(o===this.current&&!this.dirty)return;const c=this.gl;o?c.enable(c.STENCIL_TEST):c.disable(c.STENCIL_TEST),this.current=o,this.dirty=!1}}class Jm extends or{getDefault(){return[0,1]}set(o){const c=this.current;(o[0]!==c[0]||o[1]!==c[1]||this.dirty)&&(this.gl.depthRange(o[0],o[1]),this.current=o,this.dirty=!1)}}class Kn extends or{getDefault(){return!1}set(o){if(o===this.current&&!this.dirty)return;const c=this.gl;o?c.enable(c.DEPTH_TEST):c.disable(c.DEPTH_TEST),this.current=o,this.dirty=!1}}class af extends or{getDefault(){return this.gl.LESS}set(o){(o!==this.current||this.dirty)&&(this.gl.depthFunc(o),this.current=o,this.dirty=!1)}}class rh extends or{getDefault(){return!1}set(o){if(o===this.current&&!this.dirty)return;const c=this.gl;o?c.enable(c.BLEND):c.disable(c.BLEND),this.current=o,this.dirty=!1}}class nh extends or{getDefault(){const o=this.gl;return[o.ONE,o.ZERO,o.ONE,o.ZERO]}set(o){const c=this.current;(o[0]!==c[0]||o[1]!==c[1]||o[2]!==c[2]||o[3]!==c[3]||this.dirty)&&(this.gl.blendFuncSeparate(o[0],o[1],o[2],o[3]),this.current=o,this.dirty=!1)}}class lf extends or{getDefault(){return s.aj.transparent}set(o){const c=this.current;(o.r!==c.r||o.g!==c.g||o.b!==c.b||o.a!==c.a||this.dirty)&&(this.gl.blendColor(o.r,o.g,o.b,o.a),this.current=o,this.dirty=!1)}}class cf extends or{getDefault(){return this.gl.FUNC_ADD}set(o){(o!==this.current||this.dirty)&&(this.gl.blendEquationSeparate(o,o),this.current=o,this.dirty=!1)}}class sh extends or{getDefault(){return!1}set(o){if(o===this.current&&!this.dirty)return;const c=this.gl;o?c.enable(c.CULL_FACE):c.disable(c.CULL_FACE),this.current=o,this.dirty=!1}}class uf extends or{getDefault(){return this.gl.BACK}set(o){(o!==this.current||this.dirty)&&(this.gl.cullFace(o),this.current=o,this.dirty=!1)}}class hf extends or{getDefault(){return this.gl.CCW}set(o){(o!==this.current||this.dirty)&&(this.gl.frontFace(o),this.current=o,this.dirty=!1)}}let oh=class extends or{getDefault(){return null}set(p){(p!==this.current||this.dirty)&&(this.gl.useProgram(p),this.current=p,this.dirty=!1)}};class Qm extends or{getDefault(){return this.gl.TEXTURE0}set(o){(o!==this.current||this.dirty)&&(this.gl.activeTexture(o),this.current=o,this.dirty=!1)}}class e_ extends or{getDefault(){const o=this.gl;return[0,0,o.drawingBufferWidth,o.drawingBufferHeight]}set(o){const c=this.current;(o[0]!==c[0]||o[1]!==c[1]||o[2]!==c[2]||o[3]!==c[3]||this.dirty)&&(this.gl.viewport(o[0],o[1],o[2],o[3]),this.current=o,this.dirty=!1)}}class vl extends or{getDefault(){return null}set(o){if(o===this.current&&!this.dirty)return;const c=this.gl;c.bindFramebuffer(c.FRAMEBUFFER,o),this.current=o,this.dirty=!1}}class z0 extends or{getDefault(){return null}set(o){if(o===this.current&&!this.dirty)return;const c=this.gl;c.bindRenderbuffer(c.RENDERBUFFER,o),this.current=o,this.dirty=!1}}class U0 extends or{getDefault(){return null}set(o){if(o===this.current&&!this.dirty)return;const c=this.gl;c.bindTexture(c.TEXTURE_2D,o),this.current=o,this.dirty=!1}}class V0 extends or{getDefault(){return null}set(o){if(o===this.current&&!this.dirty)return;const c=this.gl;c.bindBuffer(c.ARRAY_BUFFER,o),this.current=o,this.dirty=!1}}class j0 extends or{getDefault(){return null}set(o){const c=this.gl;c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,o),this.current=o,this.dirty=!1}}class H0 extends or{getDefault(){return null}set(o){this.gl&&(o!==this.current||this.dirty)&&(this.gl.bindVertexArray(o),this.current=o,this.dirty=!1)}}class G0 extends or{getDefault(){return 4}set(o){if(o===this.current&&!this.dirty)return;const c=this.gl;c.pixelStorei(c.UNPACK_ALIGNMENT,o),this.current=o,this.dirty=!1}}class df extends or{getDefault(){return!1}set(o){if(o===this.current&&!this.dirty)return;const c=this.gl;c.pixelStorei(c.UNPACK_PREMULTIPLY_ALPHA_WEBGL,o),this.current=o,this.dirty=!1}}class ff extends or{getDefault(){return!1}set(o){if(o===this.current&&!this.dirty)return;const c=this.gl;c.pixelStorei(c.UNPACK_FLIP_Y_WEBGL,o),this.current=o,this.dirty=!1}}class ah extends or{constructor(o,c){super(o),this.context=o,this.parent=c}getDefault(){return null}}class xl extends ah{setDirty(){this.dirty=!0}set(o){if(o===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const c=this.gl;c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_2D,o,0),this.current=o,this.dirty=!1}}class pf extends ah{attachment(){return this.gl.DEPTH_ATTACHMENT}set(o){if(o===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const c=this.gl;c.framebufferRenderbuffer(c.FRAMEBUFFER,this.attachment(),c.RENDERBUFFER,o),this.current=o,this.dirty=!1}}class t_ extends ah{attachment(){return this.gl.DEPTH_ATTACHMENT}set(o){if(o===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const c=this.gl;c.framebufferTexture2D(c.FRAMEBUFFER,this.attachment(),c.TEXTURE_2D,o,0),this.current=o,this.dirty=!1}}class i_ extends pf{attachment(){return this.gl.DEPTH_STENCIL_ATTACHMENT}}const mf=(p,o,c)=>({u_matrix:p,u_image0:0,u_skirt_height:o,u_ground_shadow_factor:c}),ra=(p,o,c,m,v,b,A,M,O,k,L,U,j,$,Q,Z)=>({u_proj_matrix:Float32Array.from(p),u_globe_matrix:o,u_normalize_matrix:Float32Array.from(m),u_merc_matrix:c,u_zoom_transition:v,u_merc_center:b,u_image0:0,u_frustum_tl:A,u_frustum_tr:M,u_frustum_br:O,u_frustum_bl:k,u_globe_pos:L,u_globe_radius:U,u_viewport:j,u_grid_matrix:Z?Float32Array.from(Z):new Float32Array(9),u_skirt_height:$,u_far_z_cutoff:Q});function _f(p,o){return p!=null&&o!=null&&!(!p.hasData()||!o.hasData())&&p.demTexture!=null&&o.demTexture!=null&&p.tileID.key!==o.tileID.key}const ds=new class{constructor(){this.operations={}}newMorphing(p,o,c,m,v){if(p in this.operations){const b=this.operations[p];b.to.tileID.key!==c.tileID.key&&(b.queued=c)}else this.operations[p]={startTime:m,phase:0,duration:v,from:o,to:c,queued:null}}getMorphValuesForProxy(p){if(!(p in this.operations))return null;const o=this.operations[p];return{from:o.from,to:o.to,phase:o.phase}}update(p){for(const o in this.operations){const c=this.operations[o];for(c.phase=(p-c.startTime)/c.duration;c.phase>=1||!this._validOp(c);)if(!this._nextOp(c,p)){delete this.operations[o];break}}}_nextOp(p,o){return!!p.queued&&(p.from=p.to,p.to=p.queued,p.queued=null,p.phase=0,p.startTime=o,!0)}_validOp(p){return p.from.hasData()&&p.to.hasData()}},lh={0:null,1:"TERRAIN_VERTEX_MORPHING"};function Bc(p,o,c){if(o===0)return 0;const m=o<1&&c===514?.25/o:1;return 6*Math.pow(1.5,22-p)*Math.max(o,1)*m}function r_(p,o){const c=1<<p.z;return!o&&(p.x===0||p.x===c-1)||p.y===0||p.y===c-1}const ch=p=>({u_matrix:p});function Dc(p,o,c,m,v){if(v>0){const b=s.q.now(),A=(b-p.timeAdded)/v,M=o?(b-o.timeAdded)/v:-1,O=c.getSource(),k=m.coveringZoomLevel({tileSize:O.tileSize,roundZoom:O.roundZoom}),L=!o||Math.abs(o.tileID.overscaledZ-k)>Math.abs(p.tileID.overscaledZ-k),U=L&&p.refreshedUponExpiration?1:s.aw(L?A:1-M,0,1);return p.refreshedUponExpiration&&A>=1&&(p.refreshedUponExpiration=!1),o?{opacity:1,mix:1-U}:{opacity:U,mix:0}}return{opacity:1,mix:0}}class gf extends As{constructor(o){const c={type:"raster-dem",maxzoom:o.transform.maxZoom},m=new s.D(s.ci(),null),v=Rn("mock-dem",c,m,o.style);super("mock-dem",v,!1),v.setEventedParent(this),this._sourceLoaded=!0}_loadTile(o,c){o.state="loaded",c(null)}}class $0 extends As{constructor(o){const c=Rn("proxy",{type:"geojson",maxzoom:o.transform.maxZoom},new s.D(s.ci(),null),o.style);super("proxy",c,!1),c.setEventedParent(this),this.map=this.getSource().map=o,this.used=this._sourceLoaded=!0,this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}update(o,c,m){if(o.freezeTileCoverage)return;this.transform=o;const v=o.coveringTiles({tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled}).reduce((b,A)=>{if(b[A.key]="",!this._tiles[A.key]){const M=new Jo(A,this._source.tileSize*A.overscaleFactor(),o.tileZoom);M.state="loaded",this._tiles[A.key]=M}return b},{});for(const b in this._tiles)b in v||(this.freeFBO(b),this._tiles[b].unloadVectorData(),delete this._tiles[b])}freeFBO(o){const c=this.proxyCachedFBO[o];if(c!==void 0){const m=Object.values(c);this.renderCachePool.push(...m),delete this.proxyCachedFBO[o]}}deallocRenderCache(){this.renderCache.forEach(o=>o.fb.destroy()),this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}}class yf extends s.aG{constructor(o,c,m){super(o.overscaledZ,o.wrap,o.canonical.z,o.canonical.x,o.canonical.y),this.proxyTileKey=c,this.projMatrix=m}}class bl extends s.cJ{constructor(o,c){super(),this._debugParams={sortTilesHiZFirst:!0,disableRenderCache:!1},o.tp.registerParameter(this._debugParams,["Terrain"],"sortTilesHiZFirst",{},()=>{this._style.map.triggerRepaint()}),o.tp.registerParameter(this._debugParams,["Terrain"],"disableRenderCache",{},()=>{this._style.map.triggerRepaint()}),o.tp.registerButton(["Terrain"],"Invalidate Render Cache",()=>{this.invalidateRenderCache=!0,this._style.map.triggerRepaint()}),this.painter=o,this.terrainTileForTile={},this.prevTerrainTileForTile={};const[m,v,b]=function(O){const k=new s.b4,L=new s.aU,U=131;k.reserve(17161),L.reserve(33800);const j=s.ag/128,$=s.ag+j/2,Q=$+j;for(let te=-j;te<Q;te+=j)for(let ee=-j;ee<Q;ee+=j){const ae=ee<0||ee>$||te<0||te>$?24575:0,me=s.aw(Math.round(ee),0,s.ag),fe=s.aw(Math.round(te),0,s.ag);k.emplaceBack(me+ae,fe)}const Z=(te,ee)=>{const ae=ee*U+te;L.emplaceBack(ae+1,ae,ae+U),L.emplaceBack(ae+U,ae+U+1,ae+1)};for(let te=1;te<129;te++)for(let ee=1;ee<129;ee++)Z(ee,te);return[0,129].forEach(te=>{for(let ee=0;ee<130;ee++)Z(ee,te),Z(te,ee)}),[k,L,32768]}(),A=o.context;this.gridBuffer=A.createVertexBuffer(m,s.b6.members),this.gridIndexBuffer=A.createIndexBuffer(v),this.gridSegments=s.b7.simpleSegment(0,0,m.length,v.length),this.gridNoSkirtSegments=s.b7.simpleSegment(0,0,m.length,b),this.proxyCoords=[],this.proxiedCoords={},this._visibleDemTiles=[],this._drapedRenderBatches=[],this._sourceTilesOverlap={},this.proxySourceCache=new $0(c.map),this.orthoMatrix=s.ab.mat4.create(),s.ab.mat4.ortho(this.orthoMatrix,this.painter.transform.projection.name==="globe"?.015:0,s.ag,0,s.ag,0,1);const M=A.gl;this._overlapStencilMode=new oi({func:M.GEQUAL,mask:255},0,255,M.KEEP,M.KEEP,M.REPLACE),this._previousZoom=o.transform.zoom,this.pool=[],this._findCoveringTileCache={},this._tilesDirty={},this.style=c,this._useVertexMorphing=!0,this._exaggeration=1,this._mockSourceCache=new gf(c.map),this._pendingGroundEffectLayers=[]}set style(o){o.on("data",this._onStyleDataEvent.bind(this)),this._style=o,this._style.map.on("moveend",()=>{this._clearLineLayersFromRenderCache()})}update(o,c,m){if(o&&o.terrain){this._style!==o&&(this.style=o,this._evaluationZoom=void 0);const v=o.terrain.properties,b=o.terrain.drapeRenderMode===0,A=o.terrain.isZoomDependent();this._previousUpdateTimestamp=this.enabled?this._updateTimestamp:void 0,this._updateTimestamp=s.q.now();const M=o.terrain&&o.terrain.scope,O=v.get("source"),k=b?this._mockSourceCache:o.getSourceCache(O,M);if(!k)return void s.w(`Couldn't find terrain source "${O}".`);if(this.sourceCache=k,this._attenuationRange=o.terrain.getAttenuationRange(),this._exaggeration=A?this.calculateExaggeration(c):v.get("exaggeration"),!c.projection.requiresDraping&&A&&this._exaggeration===0)return void this._disable();this.enabled=!0;const L=()=>{this.sourceCache.used&&s.w(`Raster DEM source '${this.sourceCache.id}' is used both for terrain and as layer source.
This leads to lower resolution of hillshade. For full hillshade resolution but higher memory consumption, define another raster DEM source.`);const U=this.getScaledDemTileSize();this.sourceCache.update(c,U,!0),this.resetTileLookupCache(this.sourceCache.id)};this.sourceCache.usedForTerrain||(this.resetTileLookupCache(this.sourceCache.id),this.sourceCache.usedForTerrain=!0,L(),this._initializing=!0),L(),c.updateElevation(!0,m),this.resetTileLookupCache(this.proxySourceCache.id),this.proxySourceCache.update(c),this._emptyDEMTextureDirty=!0,this._previousZoom=c.zoom}else this._disable()}calculateExaggeration(o){if(this._attenuationRange&&o.zoom>=Math.ceil(this._attenuationRange[1]))return this._style.terrain.getExaggeration(o.zoom);const c=this._previousCameraAltitude,m=o.getFreeCameraOptions().position.z/o.pixelsPerMeter*o.worldSize;this._previousCameraAltitude=m;const v=c!=null?m-c:Number.MAX_VALUE;if(Math.abs(v)<2)return this._exaggeration;const b=o.zoom,A=this._style.terrain;if(!this._previousUpdateTimestamp)return A.getExaggeration(b);let M=b-this._previousZoom;const O=this._previousUpdateTimestamp;let k=b;this._evaluationZoom!=null&&(k=this._evaluationZoom,Math.abs(b-k)>.5&&(M=.5*(b-k+M)),M*v<0&&(k+=M)),this._evaluationZoom=k;const L=A.getExaggeration(k),U=L===A.getExaggeration(Math.max(0,k-.1));if(U&&Math.abs(L-this._exaggeration)<.01)return L;let j=Math.min(.1,.00375*(this._updateTimestamp-O));return(U||L<.1||Math.abs(M)<1e-4)&&(j=Math.min(.2,4*j)),s.af(this._exaggeration,L,j)}resetTileLookupCache(o){this._findCoveringTileCache[o]={}}attenuationRange(){return this._attenuationRange}getDemUpscale(){return this.proxySourceCache.getSource().tileSize/128}getScaledDemTileSize(){return this.sourceCache.getSource().tileSize/128*this.proxySourceCache.getSource().tileSize}_onStyleDataEvent(o){o.coord&&o.dataType==="source"?this._clearRenderCacheForTile(o.sourceCacheId,o.coord):o.dataType==="style"&&(this.invalidateRenderCache=!0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this._previousCameraAltitude=void 0)}_disable(){if(this.enabled&&(this.enabled=!1,this._emptyDEMTextureDirty=!0,this._sharedDepthStencil=void 0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this.proxySourceCache.deallocRenderCache(),this._style))for(const o in this._style._mergedSourceCaches)this._style._mergedSourceCaches[o].usedForTerrain=!1}destroy(){this._disable(),this._emptyDEMTexture&&this._emptyDEMTexture.destroy(),this.pool.forEach(o=>o.fb.destroy()),this.pool=[],this.framebufferCopyTexture&&this.framebufferCopyTexture.destroy()}_source(){return this.enabled?this.sourceCache:null}isUsingMockSource(){return this.sourceCache===this._mockSourceCache}exaggeration(){return this.enabled?this._exaggeration:0}get visibleDemTiles(){return this._visibleDemTiles}get drapeBufferSize(){const o=2*this.proxySourceCache.getSource().tileSize;return[o,o]}set useVertexMorphing(o){this._useVertexMorphing=o}updateTileBinding(o){if(!this.enabled)return;this.prevTerrainTileForTile=this.terrainTileForTile;const c=this.proxySourceCache,m=this.painter.transform;this._initializing&&(this._initializing=m._centerAltitude===0&&this.getAtPointOrZero(s.aa.fromLngLat(m.center),-1)===-1,this._emptyDEMTextureDirty=!this._initializing);const v=this.proxyCoords=c.getIds().map(O=>{const k=c.getTileByID(O).tileID;return k.projMatrix=m.calculateProjMatrix(k.toUnwrapped()),k});(function(O,k){const L=k.transform.pointCoordinate(k.transform.getCameraPoint()),U=new s.P(L.x,L.y);O.sort((j,$)=>{if($.overscaledZ-j.overscaledZ)return $.overscaledZ-j.overscaledZ;const Q=new s.P(j.canonical.x+(1<<j.canonical.z)*j.wrap,j.canonical.y),Z=new s.P($.canonical.x+(1<<$.canonical.z)*$.wrap,$.canonical.y),te=U.mult(1<<j.canonical.z);return te.x-=.5,te.y-=.5,te.distSqr(Q)-te.distSqr(Z)})})(v,this.painter);const b=this.proxyToSource||{};this.proxyToSource={},v.forEach(O=>{this.proxyToSource[O.key]={}}),this.terrainTileForTile={};const A=this._style._mergedSourceCaches;for(const O in A){const k=A[O];if(!k.used||(k!==this.sourceCache&&this.resetTileLookupCache(k.id),this._setupProxiedCoordsForOrtho(k,o[O],b),k.usedForTerrain))continue;const L=o[O];k.getSource().reparseOverscaled&&this._assignTerrainTiles(L)}this.proxiedCoords[c.id]=v.map(O=>new yf(O,O.key,this.orthoMatrix)),this._assignTerrainTiles(v),this._prepareDEMTextures(),this._setupDrapedRenderBatches(),this._initFBOPool(),this._setupRenderCache(b),this.renderingToTexture=!1;const M={};this._visibleDemTiles=[];for(const O of this.proxyCoords){const k=this.terrainTileForTile[O.key];if(!k)continue;const L=k.tileID.key;L in M||(this._visibleDemTiles.push(k),M[L]=L)}}_assignTerrainTiles(o){this._initializing||o.forEach(c=>{if(this.terrainTileForTile[c.key])return;const m=this._findTileCoveringTileID(c,this.sourceCache);m&&(this.terrainTileForTile[c.key]=m)})}_prepareDEMTextures(){const o=this.painter.context,c=o.gl;for(const m in this.terrainTileForTile){const v=this.terrainTileForTile[m],b=v.dem;!b||v.demTexture&&!v.needsDEMTextureUpload||(o.activeTexture.set(c.TEXTURE1),Zm(this.painter,v,b))}}_prepareDemTileUniforms(o,c,m,v){if(!c||c.demTexture==null)return!1;const b=o.tileID.canonical,A=Math.pow(2,c.tileID.canonical.z-b.z),M=v||"";return m[`u_dem_tl${M}`]=[b.x*A%1,b.y*A%1],m[`u_dem_scale${M}`]=A,!0}get emptyDEMTexture(){return!this._emptyDEMTextureDirty&&this._emptyDEMTexture?this._emptyDEMTexture:this._updateEmptyDEMTexture()}_getLoadedAreaMinimum(){if(!this.enabled)return 0;let o=0;const c=this._visibleDemTiles.reduce((m,v)=>{if(!v.dem)return m;const b=v.dem.tree.minimums[0];return b>0&&o++,m+b},0);return o?c/o:0}_updateEmptyDEMTexture(){const o=this.painter.context,c=o.gl;o.activeTexture.set(c.TEXTURE2);const m=this._getLoadedAreaMinimum(),v=new s.cK({width:1,height:1},new Float32Array([m]));this._emptyDEMTextureDirty=!1;let b=this._emptyDEMTexture;return b?b.update(v,{premultiply:!1}):b=this._emptyDEMTexture=new s.T(o,v,c.R32F,{premultiply:!1}),b}setupElevationDraw(o,c,m){const v=this.painter.context,b=v.gl,A={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0};A.u_exaggeration=this.exaggeration();let M=null,O=null,k=1;if(m&&m.morphing&&this._useVertexMorphing){const $=m.morphing.srcDemTile,Q=m.morphing.dstDemTile;k=m.morphing.phase,$&&Q&&(this._prepareDemTileUniforms(o,$,A,"_prev")&&(O=$),this._prepareDemTileUniforms(o,Q,A)&&(M=Q))}const L=$=>$&&$.demTexture&&this.painter.linearFloatFilteringSupported()?b.LINEAR:b.NEAREST;let U=null;var j;if(this.enabled?O&&M?(U=M.demTexture,v.activeTexture.set(b.TEXTURE4),O.demTexture.bind(L(O),b.CLAMP_TO_EDGE),A.u_dem_lerp=k):(M=this.terrainTileForTile[o.tileID.key],U=this._prepareDemTileUniforms(o,M,A)?M.demTexture:this.emptyDEMTexture):U=this.emptyDEMTexture,v.activeTexture.set(b.TEXTURE2),U&&(A.u_dem_size=(j=U).size[0]===1?1:j.size[0]-2,U.bind(L(M),b.CLAMP_TO_EDGE)),this.painter.setupDepthForOcclusion(m&&m.useDepthForOcclusion,c,A),m&&m.useMeterToDem&&M){const $=(1<<M.tileID.canonical.z)*s.bH(1,this.painter.transform.center.lat)*this.sourceCache.getSource().tileSize;A.u_meter_to_dem=$}if(m&&m.labelPlaneMatrixInv&&(A.u_label_plane_matrix_inv=m.labelPlaneMatrixInv),c.setTerrainUniformValues(v,A),this.painter.transform.projection.name==="globe"){const $=this.globeUniformValues(this.painter.transform,o.tileID.canonical,m&&m.useDenormalizedUpVectorScale);c.setGlobeUniformValues(v,$)}}globeUniformValues(o,c,m){const v=o.projection;return{u_tile_tl_up:v.upVector(c,0,0),u_tile_tr_up:v.upVector(c,s.ag,0),u_tile_br_up:v.upVector(c,s.ag,s.ag),u_tile_bl_up:v.upVector(c,0,s.ag),u_tile_up_scale:m?s.cL(1):v.upVectorScale(c,o.center.lat,o.worldSize).metersToTile}}renderToBackBuffer(o){const c=this.painter,m=this.painter.context;o.length!==0&&(m.bindFramebuffer.set(null),m.viewport.set([0,0,c.width,c.height]),c.gpuTimingDeferredRenderStart(),this.renderingToTexture=!1,function(v,b,A,M,O){if(v.transform.projection.name==="globe")(function(k,L,U,j,$){const Q=k.context,Z=Q.gl;let te,ee;const ae=k.transform,me=s.cC(k,Q,ae),fe=(at,nt)=>{if(ee===nt)return;const je=[lh[nt],"PROJECTION_GLOBE_VIEW"];me&&je.push("CUSTOM_ANTIALIASING");const et=k.isTileAffectedByFog(at);te=k.getOrCreateProgram("globeRaster",{defines:je,overrideFog:et}),ee=nt},Ae=k.colorModeForRenderPass(),ve=new Yt(Z.LEQUAL,Yt.ReadWrite,k.depthRangeFor3D);ds.update($);const be=s.cD(ae),ye=[s.at(ae.center.lng),s.aA(ae.center.lat)],Ie=k.globeSharedBuffers,Fe=[ae.width*s.q.devicePixelRatio,ae.height*s.q.devicePixelRatio],Qe=Float32Array.from(ae.globeMatrix),We={useDenormalizedUpVectorScale:!0};{const at=k.transform,nt=Bc(at.zoom,L.exaggeration(),L.sourceCache._source.tileSize);ee=-1;const je=Z.TRIANGLES;for(const et of j){const gt=U.getTile(et),Ve=oi.disabled,ut=L.prevTerrainTileForTile[et.key],tt=L.terrainTileForTile[et.key];_f(ut,tt)&&ds.newMorphing(et.key,ut,tt,$,250),Q.activeTexture.set(Z.TEXTURE0),gt.texture&&gt.texture.bind(Z.LINEAR,Z.CLAMP_TO_EDGE);const Et=ds.getMorphValuesForProxy(et.key),ft=Et?1:0;Et&&s.J(We,{morphing:{srcDemTile:Et.from,dstDemTile:Et.to,phase:s.cB(Et.phase)}});const ct=s.cE(et.canonical),xt=s.cF(ct.getCenter().lat),Tt=s.cG(et.canonical,ct,xt,at.worldSize/at._pixelsPerMercatorPixel),Lt=s.bb(s.cH(et.canonical)),Ut=ra(at.expandedFarZProjMatrix,Qe,be,Lt,s.ae(at.zoom),ye,at.frustumCorners.TL,at.frustumCorners.TR,at.frustumCorners.BR,at.frustumCorners.BL,at.globeCenterInViewSpace,at.globeRadius,Fe,nt,at._farZ,Tt);if(fe(et,ft),te&&(L.setupElevationDraw(gt,te,We),k.uploadCommonUniforms(Q,te,et.toUnwrapped()),Ie)){const[ni,Xt,Kt]=Ie.getGridBuffers(xt,nt!==0);te.draw(k,je,ve,Ve,Ae,li.backCCW,Ut,"globe_raster",ni,Xt,Kt)}}}if(Ie&&(k.renderDefaultNorthPole||k.renderDefaultSouthPole)){const at=["GLOBE_POLES","PROJECTION_GLOBE_VIEW"];me&&at.push("CUSTOM_ANTIALIASING"),te=k.getOrCreateProgram("globeRaster",{defines:at});for(const nt of j){const{x:je,y:et,z:gt}=nt.canonical,Ve=et===0,ut=et===(1<<gt)-1,[tt,Et,ft,ct]=Ie.getPoleBuffers(gt,!1);if(ct&&(Ve||ut)){const xt=U.getTile(nt);Q.activeTexture.set(Z.TEXTURE0),xt.texture&&xt.texture.bind(Z.LINEAR,Z.CLAMP_TO_EDGE);let Tt=s.cI(gt,je,ae);const Lt=s.bb(s.cH(nt.canonical)),Ut=(ni,Xt)=>ni.draw(k,Z.TRIANGLES,ve,oi.disabled,Ae,li.disabled,ra(ae.expandedFarZProjMatrix,Tt,Tt,Lt,0,ye,ae.frustumCorners.TL,ae.frustumCorners.TR,ae.frustumCorners.BR,ae.frustumCorners.BL,ae.globeCenterInViewSpace,ae.globeRadius,Fe,0,ae._farZ),"globe_pole_raster",Xt,ft,ct);L.setupElevationDraw(xt,te,We),k.uploadCommonUniforms(Q,te,nt.toUnwrapped()),Ve&&k.renderDefaultNorthPole&&Ut(te,tt),ut&&k.renderDefaultSouthPole&&(Tt=s.ab.mat4.scale(s.ab.mat4.create(),Tt,[1,-1,1]),Ut(te,Et))}}}})(v,b,A,M,O);else{const k=v.context,L=k.gl;let U,j;const $=v.shadowRenderer,Q=ta(v,v.longestCutoffRange),Z=Ae=>{if(j===Ae)return;const ve=[];ve.push(lh[Ae]),Q.shouldRenderCutoff&&ve.push("RENDER_CUTOFF"),$&&(ve.push("RENDER_SHADOWS","DEPTH_TEXTURE"),$.useNormalOffset&&ve.push("NORMAL_OFFSET")),U=v.getOrCreateProgram("terrainRaster",{defines:ve}),j=Ae},te=v.colorModeForRenderPass(),ee=new Yt(L.LEQUAL,Yt.ReadWrite,v.depthRangeFor3D);ds.update(O);const ae=v.transform,me=Bc(ae.zoom,b.exaggeration(),b.sourceCache._source.tileSize);let fe=[0,0,0];if($){const Ae=v.style.directionalLight,ve=v.style.ambientLight;Ae&&ve&&(fe=Yd(v.style,Ae,ve))}{j=-1;const Ae=L.TRIANGLES,[ve,be]=[b.gridIndexBuffer,b.gridSegments];for(const ye of M){const Ie=A.getTile(ye),Fe=oi.disabled,Qe=b.prevTerrainTileForTile[ye.key],We=b.terrainTileForTile[ye.key];_f(Qe,We)&&ds.newMorphing(ye.key,Qe,We,O,250),k.activeTexture.set(L.TEXTURE0),Ie.texture&&Ie.texture.bind(L.LINEAR,L.CLAMP_TO_EDGE);const at=ds.getMorphValuesForProxy(ye.key),nt=at?1:0;let je;at&&(je={morphing:{srcDemTile:at.from,dstDemTile:at.to,phase:s.cB(at.phase)}});const et=mf(ye.projMatrix,r_(ye.canonical,ae.renderWorldCopies)?me/10:me,fe);if(Z(nt),!U)continue;b.setupElevationDraw(Ie,U,je);const gt=ye.toUnwrapped();$&&$.setupShadows(gt,U),v.uploadCommonUniforms(k,U,gt,null,Q),U.draw(v,Ae,ee,Fe,te,li.backCCW,et,"terrain_raster",b.gridBuffer,ve,be)}}}}(c,this,this.proxySourceCache,o,this._updateTimestamp),this.renderingToTexture=!0,c.gpuTimingDeferredRenderEnd(),o.splice(0,o.length))}renderBatch(o){if(this._drapedRenderBatches.length===0)return o+1;this.renderingToTexture=!0;const c=this.painter,m=this.painter.context,v=this.proxySourceCache,b=this.proxiedCoords[v.id],A=this._drapedRenderBatches.shift(),M=c.style.order,O=[];let k=0;for(const L of b){const U=v.getTileByID(L.proxyTileKey),j=v.proxyCachedFBO[L.key]?v.proxyCachedFBO[L.key][o]:void 0,$=j!==void 0?v.renderCache[j]:this.pool[k++],Q=j!==void 0;if(U.texture=$.tex,Q&&!$.dirty){O.push(U.tileID);continue}let Z;m.bindFramebuffer.set($.fb.framebuffer),this.renderedToTile=!1,$.dirty&&(m.clear({color:s.aj.transparent,stencil:0}),$.dirty=!1);for(let te=A.start;te<=A.end;++te){const ee=c.style._mergedLayers[M[te]];if(ee.isHidden(c.transform.zoom))continue;const ae=c.style.getLayerSourceCache(ee),me=ae?this.proxyToSource[L.key][ae.id]:[L];if(!me)continue;const fe=me;m.viewport.set([0,0,$.fb.width,$.fb.height]),Z!==(ae?ae.id:null)&&(this._setupStencil($,me,ee,ae),Z=ae?ae.id:null),c.renderLayer(c,ae,ee,fe)}if(this._drapedRenderBatches.length===0)for(const te of this._pendingGroundEffectLayers){const ee=c.style._mergedLayers[M[te]];if(ee.isHidden(c.transform.zoom))continue;const ae=c.style.getLayerSourceCache(ee),me=ae?this.proxyToSource[L.key][ae.id]:[L];if(!me)continue;const fe=me;m.viewport.set([0,0,$.fb.width,$.fb.height]),Z!==(ae?ae.id:null)&&(this._setupStencil($,me,ee,ae),Z=ae?ae.id:null),c.renderLayer(c,ae,ee,fe)}this.renderedToTile?($.dirty=!0,O.push(U.tileID)):Q||--k,k===5&&(k=0,this.renderToBackBuffer(O))}return this.renderToBackBuffer(O),this.renderingToTexture=!1,m.bindFramebuffer.set(null),m.viewport.set([0,0,c.width,c.height]),A.end+1}postRender(){}isLayerOrderingCorrect(o){const c=o.order.length;let m=-1,v=c;for(let b=0;b<c;++b)this._style.isLayerDraped(o._mergedLayers[o.order[b]])?m=Math.max(m,b):v=Math.min(v,b);return v>m}getMinElevationBelowMSL(){let o=0;return this._visibleDemTiles.filter(c=>c.dem).forEach(c=>{o=Math.min(o,c.dem.tree.minimums[0])}),o===0?o:(o-30)*this._exaggeration}raycast(o,c,m){if(!this._visibleDemTiles)return null;const v=this._visibleDemTiles.filter(b=>b.dem).map(b=>{const A=b.tileID,M=1<<A.overscaledZ,{x:O,y:k}=A.canonical,L=O/M,U=(O+1)/M,j=k/M,$=(k+1)/M;return{minx:L,miny:j,maxx:U,maxy:$,t:b.dem.tree.raycastRoot(L,j,U,$,o,c,m),tile:b}});v.sort((b,A)=>(b.t!==null?b.t:Number.MAX_VALUE)-(A.t!==null?A.t:Number.MAX_VALUE));for(const b of v){if(b.t==null)return null;const A=b.tile.dem.tree.raycast(b.minx,b.miny,b.maxx,b.maxy,o,c,m);if(A!=null)return A}return null}_createFBO(){const o=this.painter.context,c=o.gl,m=this.drapeBufferSize;o.activeTexture.set(c.TEXTURE0);const v=new s.T(o,{width:m[0],height:m[1],data:null},c.RGBA8);v.bind(c.LINEAR,c.CLAMP_TO_EDGE);const b=o.createFramebuffer(m[0],m[1],!0,null);return b.colorAttachment.set(v.texture),b.depthAttachment=new i_(o,b.framebuffer),this._sharedDepthStencil===void 0?(this._sharedDepthStencil=o.createRenderbuffer(o.gl.DEPTH_STENCIL,m[0],m[1]),this._stencilRef=0,b.depthAttachment.set(this._sharedDepthStencil),o.clear({stencil:0})):b.depthAttachment.set(this._sharedDepthStencil),o.extTextureFilterAnisotropic&&c.texParameterf(c.TEXTURE_2D,o.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,o.extTextureFilterAnisotropicMax),{fb:b,tex:v,dirty:!1}}_initFBOPool(){for(;this.pool.length<Math.min(5,this.proxyCoords.length);)this.pool.push(this._createFBO())}_shouldDisableRenderCache(){if(this._debugParams.disableRenderCache||this._style.hasLightTransitions())return!0;for(const o in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[o].hasTransition())return!0;return this._style.order.some(o=>{const c=this._style._mergedLayers[o],m=c.isHidden(this.painter.transform.zoom);return c.type==="hillshade"||c.type==="custom"?!m&&c.shouldRedrape():!m&&c.hasTransition()})}_clearLineLayersFromRenderCache(){let o=!1;for(const m of this._style.getSources())if(m instanceof Dr){o=!0;break}if(!o)return;const c={};for(let m=0;m<this._style.order.length;++m){const v=this._style._mergedLayers[this._style.order[m]],b=this._style.getLayerSourceCache(v);if(b&&!c[b.id]&&!v.isHidden(this.painter.transform.zoom)&&v.type==="line"&&v.widthExpression()instanceof s.a9){c[b.id]=!0;for(const A of this.proxyCoords){const M=this.proxyToSource[A.key][b.id];if(M)for(const O of M)this._clearRenderCacheForTile(b.id,O)}}}}_clearRasterLayersFromRenderCache(){let o=!1;for(const m in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[m]._source instanceof Zs){o=!0;break}if(!o)return;const c={};for(let m=0;m<this._style.order.length;++m){const v=this._style._mergedLayers[this._style.order[m]],b=this._style.getLayerSourceCache(v);if(!b||c[b.id]||v.isHidden(this.painter.transform.zoom)||v.type!=="raster")continue;const A=v.paint.get("raster-fade-duration");for(const M of this.proxyCoords){const O=this.proxyToSource[M.key][b.id];if(O)for(const k of O){const L=Dc(b.getTile(k),b.findLoadedParent(k,0),b,this.painter.transform,A);(L.opacity!==1||L.mix!==0)&&this._clearRenderCacheForTile(b.id,k)}}}}_setupDrapedRenderBatches(){this._style.updateDrapeFirstLayers();const o=this._style.order,c=o.length;if(c===0)return;const m=[];this._pendingGroundEffectLayers=[];let v,b=0,A=this._style._mergedLayers[o[b]];for(;!this._style.isLayerDraped(A)&&A.isHidden(this.painter.transform.zoom)&&++b<c;)A=this._style._mergedLayers[o[b]];for(;b<c;++b){const M=this._style._mergedLayers[o[b]];M.isHidden(this.painter.transform.zoom)||(this._style.isLayerDraped(M)?v===void 0&&(v=b):(M.type==="fill-extrusion"&&this._pendingGroundEffectLayers.push(b),v!==void 0&&(m.push({start:v,end:b-1}),v=void 0)))}if(v!==void 0&&m.push({start:v,end:b-1}),m.length!==0){const M=m[m.length-1];this._pendingGroundEffectLayers.every(O=>O>M.end)||s.w("fill-extrusion with flood lighting and/or ground ambient occlusion should be moved to be on top of all draped layers.")}this._drapedRenderBatches=m}_setupRenderCache(o){const c=this.proxySourceCache;if(this._shouldDisableRenderCache()||this.invalidateRenderCache){if(this.invalidateRenderCache=!1,c.renderCache.length>c.renderCachePool.length){const A=Object.values(c.proxyCachedFBO);c.proxyCachedFBO={};for(let M=0;M<A.length;++M){const O=Object.values(A[M]);c.renderCachePool.push(...O)}}return}this._clearRasterLayersFromRenderCache();const m=this.proxyCoords,v=this._tilesDirty;for(let A=m.length-1;A>=0;A--){const M=m[A];if(c.getTileByID(M.key),c.proxyCachedFBO[M.key]!==void 0){const O=o[M.key],k=this.proxyToSource[M.key];let L=0;for(const U in k){const j=k[U],$=O[U];if(!$||$.length!==j.length||j.some((Q,Z)=>Q!==$[Z]||v[U]&&v[U].hasOwnProperty(Q.key))){L=-1;break}++L}for(const U in c.proxyCachedFBO[M.key])c.renderCache[c.proxyCachedFBO[M.key][U]].dirty=L<0||L!==Object.values(O).length}}const b=[...this._drapedRenderBatches];b.sort((A,M)=>M.end-M.start-(A.end-A.start));for(const A of b)for(const M of m){if(c.proxyCachedFBO[M.key])continue;let O=c.renderCachePool.pop();O===void 0&&c.renderCache.length<50&&(O=c.renderCache.length,c.renderCache.push(this._createFBO())),O!==void 0&&(c.proxyCachedFBO[M.key]={},c.proxyCachedFBO[M.key][A.start]=O,c.renderCache[O].dirty=!0)}this._tilesDirty={}}_setupStencil(o,c,m,v){if(!v||!this._sourceTilesOverlap[v.id])return void(this._overlapStencilType&&(this._overlapStencilType=!1));const b=this.painter.context,A=b.gl;if(c.length<=1)return void(this._overlapStencilType=!1);let M;if(m.isTileClipped())M=c.length,this._overlapStencilMode.test={func:A.EQUAL,mask:255},this._overlapStencilType="Clip";else{if(!(c[0].overscaledZ>c[c.length-1].overscaledZ))return void(this._overlapStencilType=!1);M=1,this._overlapStencilMode.test={func:A.GREATER,mask:255},this._overlapStencilType="Mask"}this._stencilRef+M>255&&(b.clear({stencil:0}),this._stencilRef=0),this._stencilRef+=M,this._overlapStencilMode.ref=this._stencilRef,m.isTileClipped()&&this._renderTileClippingMasks(c,this._overlapStencilMode.ref)}clipOrMaskOverlapStencilType(){return this._overlapStencilType==="Clip"||this._overlapStencilType==="Mask"}stencilModeForRTTOverlap(o){return this.renderingToTexture&&this._overlapStencilType?(this._overlapStencilType==="Clip"&&(this._overlapStencilMode.ref=this.painter._tileClippingMaskIDs[o.key]),this._overlapStencilMode):oi.disabled}_renderTileClippingMasks(o,c){const m=this.painter,v=this.painter.context,b=v.gl;m._tileClippingMaskIDs={},v.setColorMode(xi.disabled),v.setDepthMode(Yt.disabled);const A=m.getOrCreateProgram("clippingMask");for(const M of o){const O=m._tileClippingMaskIDs[M.key]=--c;A.draw(m,b.TRIANGLES,Yt.disabled,new oi({func:b.ALWAYS,mask:0},O,255,b.KEEP,b.KEEP,b.REPLACE),xi.disabled,li.disabled,ch(M.projMatrix),"$clipping",m.tileExtentBuffer,m.quadTriangleIndexBuffer,m.tileExtentSegments)}}pointCoordinate(o){const c=this.painter.transform;if(o.x<0||o.x>c.width||o.y<0||o.y>c.height)return null;const m=[o.x,o.y,1,1];s.ab.vec4.transformMat4(m,m,c.pixelMatrixInverse),s.ab.vec4.scale(m,m,1/m[3]),m[0]/=c.worldSize,m[1]/=c.worldSize;const v=c._camera.position,b=s.bH(1,c.center.lat),A=[v[0],v[1],v[2]/b,0],M=s.ab.vec3.subtract([],m.slice(0,3),A);s.ab.vec3.normalize(M,M);const O=this.raycast(A,M,this._exaggeration);return O!==null&&O?(s.ab.vec3.scaleAndAdd(A,A,M,O),A[3]=A[2],A[2]*=b,A):null}_setupProxiedCoordsForOrtho(o,c,m){if(o.getSource()instanceof s.aJ)return this._setupProxiedCoordsForImageSource(o,c,m);this._findCoveringTileCache[o.id]=this._findCoveringTileCache[o.id]||{};const v=this.proxiedCoords[o.id]=[],b=this.proxyCoords;for(let O=0;O<b.length;O++){const k=b[O],L=this._findTileCoveringTileID(k,o);if(L){const U=this._createProxiedId(k,L,m[k.key]&&m[k.key][o.id]);v.push(U),this.proxyToSource[k.key][o.id]=[U]}}let A=!1;const M=new Set;for(let O=0;O<c.length;O++){const k=o.getTile(c[O]);if(!k||!k.hasData())continue;const L=this._findTileCoveringTileID(k.tileID,this.proxySourceCache);if(L&&L.tileID.canonical.z!==k.tileID.canonical.z){const U=this.proxyToSource[L.tileID.key][o.id],j=this._createProxiedId(L.tileID,k,m[L.tileID.key]&&m[L.tileID.key][o.id]);U?U.splice(U.length-1,0,j):this.proxyToSource[L.tileID.key][o.id]=[j];const $=this.proxyToSource[L.tileID.key][o.id];M.has($)||M.add($),v.push(j),A=!0}}if(this._sourceTilesOverlap[o.id]=A,A&&this._debugParams.sortTilesHiZFirst)for(const O of M)O.sort((k,L)=>L.overscaledZ-k.overscaledZ)}_setupProxiedCoordsForImageSource(o,c,m){if(!o.getSource().loaded())return;const v=this.proxiedCoords[o.id]=[],b=this.proxyCoords,A=o.getSource(),M=A.tileID;if(!M)return;const O=new s.P(M.x,M.y)._div(1<<M.z),k=A.coordinates.map(s.aa.fromLngLat).reduce((U,j)=>(U.min.x=Math.min(U.min.x,j.x-O.x),U.min.y=Math.min(U.min.y,j.y-O.y),U.max.x=Math.max(U.max.x,j.x-O.x),U.max.y=Math.max(U.max.y,j.y-O.y),U),{min:new s.P(Number.MAX_VALUE,Number.MAX_VALUE),max:new s.P(-Number.MAX_VALUE,-Number.MAX_VALUE)}),L=(U,j)=>{const $=U.wrap+U.canonical.x/(1<<U.canonical.z),Q=U.canonical.y/(1<<U.canonical.z),Z=s.ag/(1<<U.canonical.z),te=j.wrap+j.canonical.x/(1<<j.canonical.z),ee=j.canonical.y/(1<<j.canonical.z);return $+Z<te+k.min.x||$>te+k.max.x||Q+Z<ee+k.min.y||Q>ee+k.max.y};for(let U=0;U<b.length;U++){const j=b[U];for(let $=0;$<c.length;$++){const Q=o.getTile(c[$]);if(!Q||!Q.hasData()||L(j,Q.tileID))continue;const Z=this._createProxiedId(j,Q,m[j.key]&&m[j.key][o.id]),te=this.proxyToSource[j.key][o.id];te?te.push(Z):this.proxyToSource[j.key][o.id]=[Z],v.push(Z)}}}_createProxiedId(o,c,m){let v=this.orthoMatrix;if(m){const b=m.find(A=>A.key===c.tileID.key);if(b)return b}if(c.tileID.key!==o.key){const b=o.canonical.z-c.tileID.canonical.z;let A,M,O;v=s.ab.mat4.create();const k=c.tileID.wrap-o.wrap<<o.overscaledZ;b>0?(A=s.ag>>b,M=A*((c.tileID.canonical.x<<b)-o.canonical.x+k),O=A*((c.tileID.canonical.y<<b)-o.canonical.y)):(A=s.ag<<-b,M=s.ag*(c.tileID.canonical.x-(o.canonical.x+k<<-b)),O=s.ag*(c.tileID.canonical.y-(o.canonical.y<<-b))),s.ab.mat4.ortho(v,0,A,0,A,0,1),s.ab.mat4.translate(v,v,[M,O,0])}return new yf(c.tileID,o.key,v)}_findTileCoveringTileID(o,c){let m=c.getTile(o);if(m&&m.hasData())return m;const v=this._findCoveringTileCache[c.id],b=v[o.key];if(m=b?c.getTileByID(b):null,m&&m.hasData()||b===null)return m;let A=m?m.tileID:o,M=A.overscaledZ;const O=c.getSource().minzoom,k=[];if(!b){const U=c.getSource().maxzoom;if(o.canonical.z>=U){const j=o.canonical.z-U;c.getSource().reparseOverscaled?(M=Math.max(o.canonical.z+2,c.transform.tileZoom),A=new s.aG(M,o.wrap,U,o.canonical.x>>j,o.canonical.y>>j)):j!==0&&(M=U,A=new s.aG(M,o.wrap,U,o.canonical.x>>j,o.canonical.y>>j))}A.key!==o.key&&(k.push(A.key),m=c.getTile(A))}const L=U=>{k.forEach(j=>{v[j]=U}),k.length=0};for(M-=1;M>=O&&(!m||!m.hasData());M--){m&&L(m.tileID.key);const U=A.calculateScaledKey(M);if(m=c.getTileByID(U),m&&m.hasData())break;const j=v[U];if(j===null)break;j===void 0?k.push(U):m=c.getTileByID(j)}return L(m?m.tileID.key:null),m&&m.hasData()?m:null}findDEMTileFor(o){return this.enabled?this._findTileCoveringTileID(o,this.sourceCache):null}prepareDrawTile(){this.renderedToTile=!0}_clearRenderCacheForTile(o,c){let m=this._tilesDirty[o];m||(m=this._tilesDirty[o]={}),m[c.key]=!0}}function W0(p,o,c){const m=function(M,O,k){const L=s.ab.vec3.dot(O,M),U=s.ab.vec3.dot(k,[.2126,.7152,.0722]),j=(Q,Z,te)=>(1-te)*Q+te*Z,$=j(1-.3*Math.min(U,1),1,Math.min(L+1,1));return j(.92,1,Math.asin(s.aw(O[2],-1,1))/Math.PI+.5)*$}(p,[0,0,1],o),v=[0,0,0];s.ab.vec3.scale(v,c.slice(0,3),m);const b=[0,0,0];s.ab.vec3.scale(b,o.slice(0,3),p[2]);const A=[0,0,0];return s.ab.vec3.add(A,v,b),s.cf(A)}const q0=["fill","fillOutline","fillPattern","line","linePattern","background","backgroundPattern","hillshade","raster"],n_=["stars","rainParticle","snowParticle","fillExtrusion","fillExtrusionGroundEffect","model","symbol"];class s_{static cacheKey(o,c,m,v){let b=`${c}${v?v.cacheKey:""}`;for(const A of m)o.usedDefines.includes(A)&&(b+=`/${A}`);return b}constructor(o,c,m,v,b,A){const M=o.gl;this.program=M.createProgram(),this.configuration=v,this.name=c,this.fixedDefines=[...A];const O=v?v.getBinderAttributes():[],k=(m.staticAttributes||[]).concat(O);let L=v?v.defines():[];L=L.concat(A.map(te=>`#define ${te}`));const U=`#version 300 es
`;let j=U+L.concat("precision mediump float;",Mc,ih.fragmentSource).join(`
`);for(const te of m.fragmentIncludes)j+=`
${_l[te]}`;j+=`
${m.fragmentSource}`;let $=U+L.concat("precision highp float;",Mc,ih.vertexSource).join(`
`);for(const te of m.vertexIncludes)$+=`
${_l[te]}`;this.forceManualRenderingForInstanceIDShaders=o.forceManualRenderingForInstanceIDShaders&&m.vertexSource.indexOf("gl_InstanceID")!==-1,this.forceManualRenderingForInstanceIDShaders&&($+=`
uniform int u_instanceID;
`),$+=`
${m.vertexSource}`,this.forceManualRenderingForInstanceIDShaders&&($=$.replaceAll("gl_InstanceID","u_instanceID"));const Q=M.createShader(M.FRAGMENT_SHADER);if(M.isContextLost())return void(this.failedToCreate=!0);M.shaderSource(Q,j),M.compileShader(Q),M.attachShader(this.program,Q);const Z=M.createShader(M.VERTEX_SHADER);if(M.isContextLost())this.failedToCreate=!0;else{M.shaderSource(Z,$),M.compileShader(Z),M.attachShader(this.program,Z),this.attributes={},this.numAttributes=k.length;for(let te=0;te<this.numAttributes;te++)if(k[te]){const ee=k[te].startsWith("a_")?k[te]:`a_${k[te]}`;M.bindAttribLocation(this.program,te,ee),this.attributes[ee]=te}M.linkProgram(this.program),M.deleteShader(Z),M.deleteShader(Q),this.fixedUniforms=b(o),this.binderUniforms=v?v.getUniforms(o):[],this.forceManualRenderingForInstanceIDShaders&&(this.instancingUniforms=(te=>({u_instanceID:new s.bN(te)}))(o)),(A.includes("TERRAIN")||c.indexOf("symbol")!==-1||c.indexOf("circle")!==-1)&&(this.terrainUniforms=(te=>({u_dem:new s.bN(te),u_dem_prev:new s.bN(te),u_dem_tl:new s.bK(te),u_dem_scale:new s.bM(te),u_dem_tl_prev:new s.bK(te),u_dem_scale_prev:new s.bM(te),u_dem_size:new s.bM(te),u_dem_lerp:new s.bM(te),u_exaggeration:new s.bM(te),u_depth:new s.bN(te),u_depth_size_inv:new s.bK(te),u_depth_range_unpack:new s.bK(te),u_occluder_half_size:new s.bM(te),u_occlusion_depth_offset:new s.bM(te),u_meter_to_dem:new s.bM(te),u_label_plane_matrix_inv:new s.bJ(te)}))(o)),A.includes("GLOBE")&&(this.globeUniforms=(te=>({u_tile_tl_up:new s.bL(te),u_tile_tr_up:new s.bL(te),u_tile_br_up:new s.bL(te),u_tile_bl_up:new s.bL(te),u_tile_up_scale:new s.bM(te)}))(o)),A.includes("FOG")&&(this.fogUniforms=(te=>({u_fog_matrix:new s.bJ(te),u_fog_range:new s.bK(te),u_fog_color:new s.ca(te),u_fog_horizon_blend:new s.bM(te),u_fog_vertical_limit:new s.bK(te),u_fog_temporal_offset:new s.bM(te),u_frustum_tl:new s.bL(te),u_frustum_tr:new s.bL(te),u_frustum_br:new s.bL(te),u_frustum_bl:new s.bL(te),u_globe_pos:new s.bL(te),u_globe_radius:new s.bM(te),u_globe_transition:new s.bM(te),u_is_globe:new s.bN(te),u_viewport:new s.bK(te)}))(o)),A.includes("RENDER_CUTOFF")&&(this.cutoffUniforms=(te=>({u_cutoff_params:new s.ca(te)}))(o)),A.includes("LIGHTING_3D_MODE")&&(this.lightsUniforms=(te=>({u_lighting_ambient_color:new s.bL(te),u_lighting_directional_dir:new s.bL(te),u_lighting_directional_color:new s.bL(te),u_ground_radiance:new s.bL(te)}))(o)),A.includes("RENDER_SHADOWS")&&(this.shadowUniforms=(te=>({u_light_matrix_0:new s.bJ(te),u_light_matrix_1:new s.bJ(te),u_fade_range:new s.bK(te),u_shadow_normal_offset:new s.bL(te),u_shadow_intensity:new s.bM(te),u_shadow_texel_size:new s.bM(te),u_shadow_map_resolution:new s.bM(te),u_shadow_direction:new s.bL(te),u_shadow_bias:new s.bL(te),u_shadowmap_0:new s.bN(te),u_shadowmap_1:new s.bN(te)}))(o))}}setTerrainUniformValues(o,c){if(!this.terrainUniforms)return;const m=this.terrainUniforms;if(!this.failedToCreate){o.program.set(this.program);for(const v in c)m[v]&&m[v].set(this.program,v,c[v])}}setGlobeUniformValues(o,c){if(!this.globeUniforms)return;const m=this.globeUniforms;if(!this.failedToCreate){o.program.set(this.program);for(const v in c)m[v]&&m[v].set(this.program,v,c[v])}}setFogUniformValues(o,c){if(!this.fogUniforms)return;const m=this.fogUniforms;if(!this.failedToCreate){o.program.set(this.program);for(const v in c)m[v].set(this.program,v,c[v])}}setCutoffUniformValues(o,c){if(!this.cutoffUniforms)return;const m=this.cutoffUniforms;if(!this.failedToCreate){o.program.set(this.program);for(const v in c)m[v].set(this.program,v,c[v])}}setLightsUniformValues(o,c){if(!this.lightsUniforms)return;const m=this.lightsUniforms;if(!this.failedToCreate){o.program.set(this.program);for(const v in c)m[v].set(this.program,v,c[v])}}setShadowUniformValues(o,c){if(this.failedToCreate||!this.shadowUniforms)return;const m=this.shadowUniforms;o.program.set(this.program);for(const v in c)m[v].set(this.program,v,c[v])}_drawDebugWireframe(o,c,m,v,b,A,M,O,k,L){const U=o.options.wireframe;if(U.terrain===!1&&U.layers2D===!1&&U.layers3D===!1)return;const j=o.context;if(!(!(!U.terrain||this.name!=="terrainRaster"&&this.name!=="globeRaster")||!(!U.layers2D||o._terrain&&o._terrain.renderingToTexture||!q0.includes(this.name))||!(!U.layers3D||!n_.includes(this.name))))return;const $=j.gl,Q=o.wireframeDebugCache.getLinesFromTrianglesBuffer(o.frameCounter,b,j);if(!Q)return;const Z=[...this.fixedDefines];Z.push("DEBUG_WIREFRAME");const te=o.getOrCreateProgram(this.name,{config:this.configuration,defines:Z});j.program.set(te.program);const ee=(fe,Ae,ve)=>{if(Ae[fe]&&ve[fe])for(const be in Ae[fe])ve[fe][be]&&ve[fe][be].set(ve.program,be,Ae[fe][be].current)};k&&k.setUniforms(te.program,j,te.binderUniforms,M,{zoom:O}),ee("fixedUniforms",this,te),ee("terrainUniforms",this,te),ee("globeUniforms",this,te),ee("fogUniforms",this,te),ee("lightsUniforms",this,te),ee("shadowUniforms",this,te),Q.bind(),j.setColorMode(new xi([$.ONE,$.ONE_MINUS_SRC_ALPHA,$.ZERO,$.ONE],s.aj.transparent,[!0,!0,!0,!1])),j.setDepthMode(new Yt(c.func===$.LESS?$.LEQUAL:c.func,Yt.ReadOnly,c.range)),j.setStencilMode(oi.disabled);const ae=3*A.primitiveLength*2,me=3*A.primitiveOffset*2*2;if(this.forceManualRenderingForInstanceIDShaders){const fe=L||1;for(let Ae=0;Ae<fe;++Ae)te.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",Ae),$.drawElements($.LINES,ae,$.UNSIGNED_SHORT,me)}else L&&L>1?$.drawElementsInstanced($.LINES,ae,$.UNSIGNED_SHORT,me,L):$.drawElements($.LINES,ae,$.UNSIGNED_SHORT,me);b.bind(),j.program.set(this.program),j.setDepthMode(c),j.setStencilMode(m),j.setColorMode(v)}checkUniforms(o,c,m){if(this.fixedDefines.includes(c)){for(const v of Object.keys(m))if(!m[v].initialized)throw new Error(`Program '${this.name}', from draw '${o}': uniform ${v} not set but required by ${c} being defined`)}}draw(o,c,m,v,b,A,M,O,k,L,U,j,$,Q,Z,te){const ee=o.context,ae=ee.gl;if(this.failedToCreate)return;ee.program.set(this.program),ee.setDepthMode(m),ee.setStencilMode(v),ee.setColorMode(b),ee.setCullFace(A);for(const Ae of Object.keys(this.fixedUniforms))this.fixedUniforms[Ae].set(this.program,Ae,M[Ae]);Q&&Q.setUniforms(this.program,ee,this.binderUniforms,j,{zoom:$});const me={[ae.POINTS]:1,[ae.LINES]:2,[ae.TRIANGLES]:3,[ae.LINE_STRIP]:1}[c];this.checkUniforms(O,"RENDER_SHADOWS",this.shadowUniforms);const fe=te&&te>0?1:void 0;for(const Ae of U.get()){const ve=Ae.vaos||(Ae.vaos={});if((ve[O]||(ve[O]=new qm)).bind(ee,this,k,Q?Q.getPaintVertexBuffers():[],L,Ae.vertexOffset,Z||[],fe),this.forceManualRenderingForInstanceIDShaders){const be=te||1;for(let ye=0;ye<be;++ye)this.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",ye),L?ae.drawElements(c,Ae.primitiveLength*me,ae.UNSIGNED_SHORT,Ae.primitiveOffset*me*2):ae.drawArrays(c,Ae.vertexOffset,Ae.vertexLength)}else te&&te>1?ae.drawElementsInstanced(c,Ae.primitiveLength*me,ae.UNSIGNED_SHORT,Ae.primitiveOffset*me*2,te):L?ae.drawElements(c,Ae.primitiveLength*me,ae.UNSIGNED_SHORT,Ae.primitiveOffset*me*2):ae.drawArrays(c,Ae.vertexOffset,Ae.vertexLength);c===ae.TRIANGLES&&L&&this._drawDebugWireframe(o,m,v,b,L,Ae,j,$,Q,te)}}}function uh(p,o){const c=Math.pow(2,o.tileID.overscaledZ),m=o.tileSize*Math.pow(2,p.transform.tileZoom)/c,v=m*(o.tileID.canonical.x+o.tileID.wrap*c),b=m*o.tileID.canonical.y;return{u_image:0,u_texsize:o.imageAtlasTexture?o.imageAtlasTexture.size:[0,0],u_tile_units_to_pixels:1/s.ar(o,1,p.transform.tileZoom),u_pixel_coord_upper:[v>>16,b>>16],u_pixel_coord_lower:[65535&v,65535&b]}}const wl={terrain:0,flat:1},Al=s.ab.mat4.create(),hh=(p,o,c,m,v,b,A,M,O,k,L,U,j,$,Q,Z,te,ee)=>{const ae=o.style.light,me=ae.properties.get("position"),fe=[me.x,me.y,me.z],Ae=s.ab.mat3.create();ae.properties.get("anchor")==="viewport"&&(s.ab.mat3.fromRotation(Ae,-o.transform.angle),s.ab.vec3.transformMat3(fe,fe,Ae));const ve=ae.properties.get("color"),be=o.transform,ye={u_matrix:p,u_lightpos:fe,u_lightintensity:ae.properties.get("intensity"),u_lightcolor:[ve.r,ve.g,ve.b],u_vertical_gradient:+c,u_opacity:m,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:Al,u_merc_center:[0,0],u_up_dir:[0,0,0],u_height_lift:0,u_height_type:wl[k],u_base_type:wl[L],u_ao:v,u_edge_radius:b,u_width_scale:A,u_flood_light_color:Q,u_vertical_scale:Z,u_flood_light_intensity:te,u_ground_shadow_factor:ee};return be.projection.name==="globe"&&(ye.u_tile_id=[M.canonical.x,M.canonical.y,1<<M.canonical.z],ye.u_zoom_transition=U,ye.u_inv_rot_matrix=$,ye.u_merc_center=j,ye.u_up_dir=be.projection.upVector(new s.bT(0,0,0),j[0]*s.ag,j[1]*s.ag),ye.u_height_lift=O),ye},Oc=(p,o,c,m,v,b)=>({u_matrix:p,u_edge_radius:o,u_width_scale:c,u_vertical_scale:m,u_height_type:wl[v],u_base_type:wl[b]}),o_=(p,o,c,m,v,b,A,M,O,k,L,U,j,$,Q,Z,te)=>{const ee=hh(p,o,c,m,v,b,A,M,k,L,U,j,$,Q,Z,te,1,[0,0,0]),ae={u_height_factor:-Math.pow(2,M.overscaledZ)/O.tileSize/8};return s.l(ee,uh(o,O),ae)},Fc=(p,o)=>({u_matrix:p,u_emissive_strength:o}),kc=(p,o,c,m)=>s.l(Fc(p,o),uh(c,m)),vf=(p,o,c)=>({u_matrix:p,u_world:c,u_emissive_strength:o}),a_=(p,o,c,m,v)=>s.l(kc(p,o,c,m),{u_world:v}),X0=(p,o,c,m)=>{const v=s.ag/c.tileSize;return{u_matrix:p,u_camera_to_center_distance:o.getCameraToCenterDistance(m),u_extrude_scale:[o.pixelsToGLUnits[0]/v,o.pixelsToGLUnits[1]/v]}},La=(p,o,c=1)=>({u_matrix:p,u_color:o.toRenderColor(null),u_overlay:0,u_overlay_scale:c}),dh=s.ab.mat4.create(),Vt=(p,o,c,m,v,b,A)=>{const M=p.transform,O=M.projection.name==="globe",k=O?s.cN(M.zoom,o.canonical)*M._pixelsPerMercatorPixel:s.ar(c,1,b),L={u_matrix:o.projMatrix,u_extrude_scale:k,u_intensity:A,u_inv_rot_matrix:dh,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0]};if(O){L.u_inv_rot_matrix=m,L.u_merc_center=v,L.u_tile_id=[o.canonical.x,o.canonical.y,1<<o.canonical.z],L.u_zoom_transition=s.ae(M.zoom);const U=v[0]*s.ag,j=v[1]*s.ag;L.u_up_dir=M.projection.upVector(new s.bT(0,0,0),U,j)}return L};function xf(p,[o,c,m,v],[b,A]){if(b===A)return[0,0,0,0];const M=255*(p-1)/(p*(A-b));return[o*M,c*M,m*M,v*M]}function bf(p,o,[c,m]){return c===m?0:.5/p+(o-c)*(p-1)/(p*(m-c))}const na=(p,o,c,m,v,b,A,M,O,k,L,U,j,$,Q,Z,te,ee,ae,me,fe)=>({u_matrix:p,u_normalize_matrix:o,u_globe_matrix:c,u_merc_matrix:m,u_grid_matrix:v,u_tl_parent:b,u_scale_parent:k,u_fade_t:L.mix,u_opacity:L.opacity*U.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:U.paint.get("raster-brightness-min"),u_brightness_high:U.paint.get("raster-brightness-max"),u_saturation_factor:s.cO(U.paint.get("raster-saturation")),u_contrast_factor:s.cP(U.paint.get("raster-contrast")),u_spin_weights:Na(U.paint.get("raster-hue-rotate")),u_perspective_transform:j,u_raster_elevation:$,u_zoom_transition:A,u_merc_center:M,u_cutoff_params:O,u_colorization_mix:xf(s.cQ,Z,ee),u_colorization_offset:bf(s.cQ,te,ee),u_color_ramp:Q,u_texture_offset:[me/(ae+2*me),ae/(ae+2*me)],u_texture_res:[ae+2*me,ae+2*me],u_emissive_strength:fe});function Na(p){p*=Math.PI/180;const o=Math.sin(p),c=Math.cos(p);return[(2*c+1)/3,(-Math.sqrt(3)*o-c+1)/3,(Math.sqrt(3)*o-c+1)/3]}const $t=.05,wf=(p,o,c,m,v,b,A,M,O,k,L,U)=>({u_matrix:p,u_normalize_matrix:o,u_globe_matrix:c,u_merc_matrix:m,u_grid_matrix:v,u_tl_parent:b,u_scale_parent:k,u_fade_t:L.mix,u_opacity:L.opacity,u_image0:0,u_image1:1,u_raster_elevation:U,u_zoom_transition:A,u_merc_center:M,u_cutoff_params:O}),Z0=(p,o,c,m,v,b,A,M,O,k)=>({u_particle_texture:p,u_particle_texture_side_len:o,u_tile_offset:c,u_velocity:m,u_color_ramp:b,u_velocity_res:v,u_max_speed:A,u_uv_offset:M,u_data_scale:[255*O[0],255*O[1]],u_data_offset:k,u_particle_pos_scale:1.1,u_particle_pos_offset:[$t,$t]}),Y0=(p,o,c,m,v,b,A,M,O,k)=>({u_particle_texture:p,u_particle_texture_side_len:o,u_velocity:c,u_velocity_res:m,u_max_speed:v,u_speed_factor:b,u_reset_rate:A,u_rand_seed:Math.random(),u_uv_offset:M,u_data_scale:[255*O[0],255*O[1]],u_data_offset:k,u_particle_pos_scale:1.1,u_particle_pos_offset:[$t,$t]}),fh=s.ab.mat4.create(),Af=(p,o,c,m,v,b,A,M,O,k,L,U,j,$,Q,Z,te,ee,ae,me,fe,Ae)=>{const ve=v.transform,be={u_is_size_zoom_constant:+(p==="constant"||p==="source"),u_is_size_feature_constant:+(p==="constant"||p==="camera"),u_size_t:o?o.uSizeT:0,u_size:o?o.uSize:0,u_camera_to_center_distance:ve.getCameraToCenterDistance(ae),u_rotate_symbol:+c,u_aspect_ratio:ve.width/ve.height,u_fade_change:v.options.fadeDuration?v.symbolFadeChange:1,u_matrix:b,u_label_plane_matrix:A,u_coord_matrix:M,u_is_text:+k,u_elevation_from_sea:O?1:0,u_pitch_with_map:+m,u_texsize:L,u_texsize_icon:U,u_texture:0,u_texture_icon:1,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:fh,u_merc_center:[0,0],u_camera_forward:[0,0,0],u_ecef_origin:[0,0,0],u_tile_matrix:fh,u_up_vector:[0,-1,0],u_color_adj_mat:me,u_icon_transition:fe||0,u_gamma_scale:m?v.transform.getCameraToCenterDistance(ae)*Math.cos(v.terrain?0:v.transform._pitch):1,u_device_pixel_ratio:s.q.devicePixelRatio,u_is_halo:1,u_scale_factor:Ae||1};return ae.name==="globe"&&(be.u_tile_id=[$.canonical.x,$.canonical.y,1<<$.canonical.z],be.u_zoom_transition=Q,be.u_inv_rot_matrix=te,be.u_merc_center=Z,be.u_camera_forward=ve._camera.forward(),be.u_ecef_origin=s.cR(ve.globeMatrix,$.toUnwrapped()),be.u_tile_matrix=Float32Array.from(ve.globeMatrix),be.u_up_vector=ee),be},Tf=(p,o,c,m)=>({u_matrix:p,u_emissive_strength:o,u_opacity:c,u_color:m}),l_=(p,o,c,m,v,b,A,M,O)=>s.l(function(k,L,U,j,$,Q){const{width:Z,height:te}=j.imageManager.getPixelSize(L),ee=Math.pow(2,Q.tileID.overscaledZ),ae=Q.tileSize*Math.pow(2,j.transform.tileZoom)/ee,me=ae*(Q.tileID.canonical.x+Q.tileID.wrap*ee),fe=ae*Q.tileID.canonical.y;return{u_image:0,u_pattern_tl:U.tl,u_pattern_br:U.br,u_texsize:[Z,te],u_pattern_size:U.displaySize,u_pattern_units_to_pixels:$?[j.transform.width,-1*j.transform.height]:[1/s.ar(Q,1,j.transform.tileZoom),1/s.ar(Q,1,j.transform.tileZoom)],u_pixel_coord_upper:[me>>16,fe>>16],u_pixel_coord_lower:[65535&me,65535&fe]}}(0,b,A,m,M,O),{u_matrix:p,u_emissive_strength:o,u_opacity:c}),Ef=new Float32Array(s.ab.mat4.identity([])),Lc=(p,o,c,m,v,b,A,M,O,k,L,U,j,$=[0,0,0],Q)=>{const Z=v.style.light,te=Z.properties.get("position"),ee=[-te.x,-te.y,te.z],ae=s.ab.mat3.create();Z.properties.get("anchor")==="viewport"&&(s.ab.mat3.fromRotation(ae,-v.transform.angle),s.ab.vec3.transformMat3(ee,ee,ae));const me=L.alphaMode==="MASK",fe=Z.properties.get("color").toRenderColor(null),Ae=j.paint.get("model-ambient-occlusion-intensity"),ve=j.paint.get("model-color").constantOr(s.aj.white).toRenderColor(null),be=j.paint.get("model-color-mix-intensity").constantOr(0);return{u_matrix:p,u_lighting_matrix:o,u_normal_matrix:c,u_node_matrix:m||Ef,u_lightpos:ee,u_lightintensity:Z.properties.get("intensity"),u_lightcolor:[fe.r,fe.g,fe.b],u_camera_pos:$,u_opacity:b,u_baseTextureIsAlpha:0,u_alphaMask:+me,u_alphaCutoff:L.alphaCutoff,u_baseColorFactor:[A.r,A.g,A.b,A.a],u_emissiveFactor:[M[0],M[1],M[2],1],u_metallicFactor:O,u_roughnessFactor:k,u_baseColorTexture:un.BaseColor,u_metallicRoughnessTexture:un.MetallicRoughness,u_normalTexture:un.Normal,u_occlusionTexture:un.Occlusion,u_emissionTexture:un.Emission,u_lutTexture:un.LUT,u_color_mix:[ve.r,ve.g,ve.b,be],u_aoIntensity:Ae,u_emissive_strength:U,u_occlusionTextureTransform:Q||[0,0,0,0]}},ph=(p,o=Ef,c=Ef)=>({u_matrix:p,u_instance:o,u_node_matrix:c}),Sf={fillExtrusion:p=>({u_matrix:new s.bJ(p),u_lightpos:new s.bL(p),u_lightintensity:new s.bM(p),u_lightcolor:new s.bL(p),u_vertical_gradient:new s.bM(p),u_opacity:new s.bM(p),u_edge_radius:new s.bM(p),u_width_scale:new s.bM(p),u_ao:new s.bK(p),u_height_type:new s.bN(p),u_base_type:new s.bN(p),u_tile_id:new s.bL(p),u_zoom_transition:new s.bM(p),u_inv_rot_matrix:new s.bJ(p),u_merc_center:new s.bK(p),u_up_dir:new s.bL(p),u_height_lift:new s.bM(p),u_flood_light_color:new s.bL(p),u_vertical_scale:new s.bM(p),u_flood_light_intensity:new s.bM(p),u_ground_shadow_factor:new s.bL(p)}),fillExtrusionDepth:p=>({u_matrix:new s.bJ(p),u_edge_radius:new s.bM(p),u_width_scale:new s.bM(p),u_vertical_scale:new s.bM(p),u_height_type:new s.bN(p),u_base_type:new s.bN(p)}),fillExtrusionPattern:p=>({u_matrix:new s.bJ(p),u_lightpos:new s.bL(p),u_lightintensity:new s.bM(p),u_lightcolor:new s.bL(p),u_vertical_gradient:new s.bM(p),u_height_factor:new s.bM(p),u_edge_radius:new s.bM(p),u_width_scale:new s.bM(p),u_ao:new s.bK(p),u_height_type:new s.bN(p),u_base_type:new s.bN(p),u_tile_id:new s.bL(p),u_zoom_transition:new s.bM(p),u_inv_rot_matrix:new s.bJ(p),u_merc_center:new s.bK(p),u_up_dir:new s.bL(p),u_height_lift:new s.bM(p),u_image:new s.bN(p),u_texsize:new s.bK(p),u_pixel_coord_upper:new s.bK(p),u_pixel_coord_lower:new s.bK(p),u_tile_units_to_pixels:new s.bM(p),u_opacity:new s.bM(p)}),fillExtrusionGroundEffect:p=>({u_matrix:new s.bJ(p),u_opacity:new s.bM(p),u_ao_pass:new s.bM(p),u_meter_to_tile:new s.bM(p),u_ao:new s.bK(p),u_flood_light_intensity:new s.bM(p),u_flood_light_color:new s.bL(p),u_attenuation:new s.bM(p),u_edge_radius:new s.bM(p),u_fb:new s.bN(p),u_fb_size:new s.bM(p),u_dynamic_offset:new s.bM(p)}),fill:p=>({u_matrix:new s.bJ(p),u_emissive_strength:new s.bM(p)}),fillPattern:p=>({u_matrix:new s.bJ(p),u_emissive_strength:new s.bM(p),u_image:new s.bN(p),u_texsize:new s.bK(p),u_pixel_coord_upper:new s.bK(p),u_pixel_coord_lower:new s.bK(p),u_tile_units_to_pixels:new s.bM(p)}),fillOutline:p=>({u_matrix:new s.bJ(p),u_emissive_strength:new s.bM(p),u_world:new s.bK(p)}),fillOutlinePattern:p=>({u_matrix:new s.bJ(p),u_emissive_strength:new s.bM(p),u_world:new s.bK(p),u_image:new s.bN(p),u_texsize:new s.bK(p),u_pixel_coord_upper:new s.bK(p),u_pixel_coord_lower:new s.bK(p),u_tile_units_to_pixels:new s.bM(p)}),circle:s.cS,collisionBox:p=>({u_matrix:new s.bJ(p),u_camera_to_center_distance:new s.bM(p),u_extrude_scale:new s.bK(p)}),collisionCircle:p=>({u_matrix:new s.bJ(p),u_inv_matrix:new s.bJ(p),u_camera_to_center_distance:new s.bM(p),u_viewport_size:new s.bK(p)}),debug:p=>({u_color:new s.cz(p),u_matrix:new s.bJ(p),u_overlay:new s.bN(p),u_overlay_scale:new s.bM(p)}),clippingMask:p=>({u_matrix:new s.bJ(p)}),heatmap:p=>({u_extrude_scale:new s.bM(p),u_intensity:new s.bM(p),u_matrix:new s.bJ(p),u_inv_rot_matrix:new s.bJ(p),u_merc_center:new s.bK(p),u_tile_id:new s.bL(p),u_zoom_transition:new s.bM(p),u_up_dir:new s.bL(p)}),heatmapTexture:p=>({u_image:new s.bN(p),u_color_ramp:new s.bN(p),u_opacity:new s.bM(p)}),hillshade:p=>({u_matrix:new s.bJ(p),u_image:new s.bN(p),u_latrange:new s.bK(p),u_light:new s.bK(p),u_shadow:new s.cz(p),u_highlight:new s.cz(p),u_emissive_strength:new s.bM(p),u_accent:new s.cz(p)}),hillshadePrepare:p=>({u_matrix:new s.bJ(p),u_image:new s.bN(p),u_dimension:new s.bK(p),u_zoom:new s.bM(p)}),line:s.cT,linePattern:s.cU,raster:p=>({u_matrix:new s.bJ(p),u_normalize_matrix:new s.bJ(p),u_globe_matrix:new s.bJ(p),u_merc_matrix:new s.bJ(p),u_grid_matrix:new s.cA(p),u_tl_parent:new s.bK(p),u_scale_parent:new s.bM(p),u_fade_t:new s.bM(p),u_opacity:new s.bM(p),u_image0:new s.bN(p),u_image1:new s.bN(p),u_brightness_low:new s.bM(p),u_brightness_high:new s.bM(p),u_saturation_factor:new s.bM(p),u_contrast_factor:new s.bM(p),u_spin_weights:new s.bL(p),u_perspective_transform:new s.bK(p),u_raster_elevation:new s.bM(p),u_zoom_transition:new s.bM(p),u_merc_center:new s.bK(p),u_cutoff_params:new s.ca(p),u_colorization_mix:new s.ca(p),u_colorization_offset:new s.bM(p),u_color_ramp:new s.bN(p),u_texture_offset:new s.bK(p),u_texture_res:new s.bK(p),u_emissive_strength:new s.bM(p)}),rasterParticle:p=>({u_matrix:new s.bJ(p),u_normalize_matrix:new s.bJ(p),u_globe_matrix:new s.bJ(p),u_merc_matrix:new s.bJ(p),u_grid_matrix:new s.cA(p),u_tl_parent:new s.bK(p),u_scale_parent:new s.bM(p),u_fade_t:new s.bM(p),u_opacity:new s.bM(p),u_image0:new s.bN(p),u_image1:new s.bN(p),u_raster_elevation:new s.bM(p),u_zoom_transition:new s.bM(p),u_merc_center:new s.bK(p),u_cutoff_params:new s.ca(p)}),rasterParticleTexture:p=>({u_texture:new s.bN(p),u_opacity:new s.bM(p)}),rasterParticleDraw:p=>({u_particle_texture:new s.bN(p),u_particle_texture_side_len:new s.bM(p),u_tile_offset:new s.bK(p),u_velocity:new s.bN(p),u_color_ramp:new s.bN(p),u_velocity_res:new s.bK(p),u_max_speed:new s.bM(p),u_uv_offset:new s.bK(p),u_data_scale:new s.bK(p),u_data_offset:new s.bM(p),u_particle_pos_scale:new s.bM(p),u_particle_pos_offset:new s.bK(p)}),rasterParticleUpdate:p=>({u_particle_texture:new s.bN(p),u_particle_texture_side_len:new s.bM(p),u_velocity:new s.bN(p),u_velocity_res:new s.bK(p),u_max_speed:new s.bM(p),u_speed_factor:new s.bM(p),u_reset_rate:new s.bM(p),u_rand_seed:new s.bM(p),u_uv_offset:new s.bK(p),u_data_scale:new s.bK(p),u_data_offset:new s.bM(p),u_particle_pos_scale:new s.bM(p),u_particle_pos_offset:new s.bK(p)}),symbol:p=>({u_is_size_zoom_constant:new s.bN(p),u_is_size_feature_constant:new s.bN(p),u_size_t:new s.bM(p),u_size:new s.bM(p),u_camera_to_center_distance:new s.bM(p),u_rotate_symbol:new s.bN(p),u_aspect_ratio:new s.bM(p),u_fade_change:new s.bM(p),u_matrix:new s.bJ(p),u_label_plane_matrix:new s.bJ(p),u_coord_matrix:new s.bJ(p),u_is_text:new s.bN(p),u_elevation_from_sea:new s.bN(p),u_pitch_with_map:new s.bN(p),u_texsize:new s.bK(p),u_texsize_icon:new s.bK(p),u_texture:new s.bN(p),u_texture_icon:new s.bN(p),u_gamma_scale:new s.bM(p),u_device_pixel_ratio:new s.bM(p),u_tile_id:new s.bL(p),u_zoom_transition:new s.bM(p),u_inv_rot_matrix:new s.bJ(p),u_merc_center:new s.bK(p),u_camera_forward:new s.bL(p),u_tile_matrix:new s.bJ(p),u_up_vector:new s.bL(p),u_ecef_origin:new s.bL(p),u_is_halo:new s.bN(p),u_icon_transition:new s.bM(p),u_color_adj_mat:new s.bJ(p),u_scale_factor:new s.bM(p)}),background:p=>({u_matrix:new s.bJ(p),u_emissive_strength:new s.bM(p),u_opacity:new s.bM(p),u_color:new s.cz(p)}),backgroundPattern:p=>({u_matrix:new s.bJ(p),u_emissive_strength:new s.bM(p),u_opacity:new s.bM(p),u_image:new s.bN(p),u_pattern_tl:new s.bK(p),u_pattern_br:new s.bK(p),u_texsize:new s.bK(p),u_pattern_size:new s.bK(p),u_pixel_coord_upper:new s.bK(p),u_pixel_coord_lower:new s.bK(p),u_pattern_units_to_pixels:new s.bK(p)}),terrainRaster:p=>({u_matrix:new s.bJ(p),u_image0:new s.bN(p),u_skirt_height:new s.bM(p),u_ground_shadow_factor:new s.bL(p)}),skybox:p=>({u_matrix:new s.bJ(p),u_sun_direction:new s.bL(p),u_cubemap:new s.bN(p),u_opacity:new s.bM(p),u_temporal_offset:new s.bM(p)}),skyboxGradient:p=>({u_matrix:new s.bJ(p),u_color_ramp:new s.bN(p),u_center_direction:new s.bL(p),u_radius:new s.bM(p),u_opacity:new s.bM(p),u_temporal_offset:new s.bM(p)}),skyboxCapture:p=>({u_matrix_3f:new s.cA(p),u_sun_direction:new s.bL(p),u_sun_intensity:new s.bM(p),u_color_tint_r:new s.ca(p),u_color_tint_m:new s.ca(p),u_luminance:new s.bM(p)}),globeRaster:p=>({u_proj_matrix:new s.bJ(p),u_globe_matrix:new s.bJ(p),u_normalize_matrix:new s.bJ(p),u_merc_matrix:new s.bJ(p),u_zoom_transition:new s.bM(p),u_merc_center:new s.bK(p),u_image0:new s.bN(p),u_grid_matrix:new s.cA(p),u_skirt_height:new s.bM(p),u_far_z_cutoff:new s.bM(p),u_frustum_tl:new s.bL(p),u_frustum_tr:new s.bL(p),u_frustum_br:new s.bL(p),u_frustum_bl:new s.bL(p),u_globe_pos:new s.bL(p),u_globe_radius:new s.bM(p),u_viewport:new s.bK(p)}),globeAtmosphere:p=>({u_frustum_tl:new s.bL(p),u_frustum_tr:new s.bL(p),u_frustum_br:new s.bL(p),u_frustum_bl:new s.bL(p),u_horizon:new s.bM(p),u_transition:new s.bM(p),u_fadeout_range:new s.bM(p),u_color:new s.ca(p),u_high_color:new s.ca(p),u_space_color:new s.ca(p),u_temporal_offset:new s.bM(p),u_horizon_angle:new s.bM(p)}),model:p=>({u_matrix:new s.bJ(p),u_lighting_matrix:new s.bJ(p),u_normal_matrix:new s.bJ(p),u_node_matrix:new s.bJ(p),u_lightpos:new s.bL(p),u_lightintensity:new s.bM(p),u_lightcolor:new s.bL(p),u_camera_pos:new s.bL(p),u_opacity:new s.bM(p),u_baseColorFactor:new s.ca(p),u_emissiveFactor:new s.ca(p),u_metallicFactor:new s.bM(p),u_roughnessFactor:new s.bM(p),u_baseTextureIsAlpha:new s.bN(p),u_alphaMask:new s.bN(p),u_alphaCutoff:new s.bM(p),u_baseColorTexture:new s.bN(p),u_metallicRoughnessTexture:new s.bN(p),u_normalTexture:new s.bN(p),u_occlusionTexture:new s.bN(p),u_emissionTexture:new s.bN(p),u_lutTexture:new s.bN(p),u_color_mix:new s.ca(p),u_aoIntensity:new s.bM(p),u_emissive_strength:new s.bM(p),u_occlusionTextureTransform:new s.ca(p)}),modelDepth:p=>({u_matrix:new s.bJ(p),u_instance:new s.bJ(p),u_node_matrix:new s.bJ(p)}),groundShadow:p=>({u_matrix:new s.bJ(p),u_ground_shadow_factor:new s.bL(p)}),stars:p=>({u_matrix:new s.bJ(p),u_up:new s.bL(p),u_right:new s.bL(p),u_intensity_multiplier:new s.bM(p)}),snowParticle:p=>({u_modelview:new s.bJ(p),u_projection:new s.bJ(p),u_time:new s.bM(p),u_cam_pos:new s.bL(p),u_velocityConeAperture:new s.bM(p),u_velocity:new s.bM(p),u_horizontalOscillationRadius:new s.bM(p),u_horizontalOscillationRate:new s.bM(p),u_boxSize:new s.bM(p),u_billboardSize:new s.bM(p),u_simpleShapeParameters:new s.bK(p),u_screenSize:new s.bK(p),u_thinningCenterPos:new s.bK(p),u_thinningShape:new s.bL(p),u_thinningAffectedRatio:new s.bM(p),u_thinningParticleOffset:new s.bM(p),u_particleColor:new s.ca(p),u_direction:new s.bL(p)}),rainParticle:p=>({u_modelview:new s.bJ(p),u_projection:new s.bJ(p),u_time:new s.bM(p),u_cam_pos:new s.bL(p),u_texScreen:new s.bN(p),u_velocityConeAperture:new s.bM(p),u_velocity:new s.bM(p),u_boxSize:new s.bM(p),u_rainDropletSize:new s.bK(p),u_distortionStrength:new s.bM(p),u_rainDirection:new s.bL(p),u_color:new s.ca(p),u_screenSize:new s.bK(p),u_thinningCenterPos:new s.bK(p),u_thinningShape:new s.bL(p),u_thinningAffectedRatio:new s.bM(p),u_thinningParticleOffset:new s.bM(p),u_shapeDirectionalPower:new s.bM(p),u_shapeNormalPower:new s.bM(p),u_mode:new s.bM(p)}),vignette:p=>({u_vignetteShape:new s.bL(p),u_vignetteColor:new s.ca(p)}),occlusion:p=>({u_matrix:new s.bJ(p),u_anchorPos:new s.bL(p),u_screenSizePx:new s.bK(p),u_occluderSizePx:new s.bK(p),u_color:new s.ca(p)})};class eo{constructor(o,c,m,v){this.id=eo.uniqueIdxCounter,eo.uniqueIdxCounter++,this.context=o;const b=o.gl;this.buffer=b.createBuffer(),this.dynamicDraw=!!m,this.context.unbindVAO(),o.bindElementBuffer.set(this.buffer),b.bufferData(b.ELEMENT_ARRAY_BUFFER,c.arrayBuffer,this.dynamicDraw?b.DYNAMIC_DRAW:b.STATIC_DRAW),this.dynamicDraw||v||c.destroy()}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(o){this.id=eo.uniqueIdxCounter,eo.uniqueIdxCounter++;const c=this.context.gl;this.context.unbindVAO(),this.bind(),c.bufferSubData(c.ELEMENT_ARRAY_BUFFER,0,o.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}eo.uniqueIdxCounter=0;const Jn={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class sa{constructor(o,c,m,v,b,A){this.length=c.length,this.attributes=m,this.itemSize=c.bytesPerElement,this.dynamicDraw=v,this.instanceCount=A,this.context=o;const M=o.gl;this.buffer=M.createBuffer(),o.bindVertexBuffer.set(this.buffer),M.bufferData(M.ARRAY_BUFFER,c.arrayBuffer,this.dynamicDraw?M.DYNAMIC_DRAW:M.STATIC_DRAW),this.dynamicDraw||b||c.destroy()}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(o){const c=this.context.gl;this.bind(),c.bufferSubData(c.ARRAY_BUFFER,0,o.arrayBuffer)}enableAttributes(o,c){for(let m=0;m<this.attributes.length;m++){const v=c.attributes[this.attributes[m].name];v!==void 0&&o.enableVertexAttribArray(v)}}setVertexAttribPointers(o,c,m){for(let v=0;v<this.attributes.length;v++){const b=this.attributes[v],A=c.attributes[b.name];A!==void 0&&o.vertexAttribPointer(A,b.components,o[Jn[b.type]],!1,this.itemSize,b.offset+this.itemSize*(m||0))}}setVertexAttribDivisor(o,c,m){for(let v=0;v<this.attributes.length;v++){const b=c.attributes[this.attributes[v].name];b!==void 0&&this.instanceCount&&this.instanceCount>0&&o.vertexAttribDivisor(b,m)}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class If{constructor(o,c,m,v,b){this.context=o,this.width=c,this.height=m;const A=this.framebuffer=o.gl.createFramebuffer();v&&(this.colorAttachment=new xl(o,A)),b&&(this.depthAttachmentType=b,this.depthAttachment=b==="renderbuffer"?new pf(o,A):new t_(o,A))}destroy(){const o=this.context.gl;if(this.colorAttachment){const c=this.colorAttachment.get();c&&o.deleteTexture(c)}if(this.depthAttachment&&this.depthAttachmentType)if(this.depthAttachmentType==="renderbuffer"){const c=this.depthAttachment.get();c&&o.deleteRenderbuffer(c)}else{const c=this.depthAttachment.get();c&&o.deleteTexture(c)}o.deleteFramebuffer(this.framebuffer)}}class Cf{constructor(o,c){this.gl=o,this.clearColor=new rf(this),this.clearDepth=new nf(this),this.clearStencil=new sf(this),this.colorMask=new of(this),this.depthMask=new Ym(this),this.stencilMask=new Km(this),this.stencilFunc=new N0(this),this.stencilOp=new Rc(this),this.stencilTest=new Pc(this),this.depthRange=new Jm(this),this.depthTest=new Kn(this),this.depthFunc=new af(this),this.blend=new rh(this),this.blendFunc=new nh(this),this.blendColor=new lf(this),this.blendEquation=new cf(this),this.cullFace=new sh(this),this.cullFaceSide=new uf(this),this.frontFace=new hf(this),this.program=new oh(this),this.activeTexture=new Qm(this),this.viewport=new e_(this),this.bindFramebuffer=new vl(this),this.bindRenderbuffer=new z0(this),this.bindTexture=new U0(this),this.bindVertexBuffer=new V0(this),this.bindElementBuffer=new j0(this),this.bindVertexArrayOES=new H0(this),this.pixelStoreUnpack=new G0(this),this.pixelStoreUnpackPremultiplyAlpha=new df(this),this.pixelStoreUnpackFlipY=new ff(this),this.options=c?Object.assign({},c):{},this.options.extTextureFilterAnisotropicForceOff||(this.extTextureFilterAnisotropic=o.getExtension("EXT_texture_filter_anisotropic")||o.getExtension("MOZ_EXT_texture_filter_anisotropic")||o.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=o.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT))),this.extDebugRendererInfo=o.getExtension("WEBGL_debug_renderer_info"),this.extDebugRendererInfo&&(this.renderer=o.getParameter(this.extDebugRendererInfo.UNMASKED_RENDERER_WEBGL),this.vendor=o.getParameter(this.extDebugRendererInfo.UNMASKED_VENDOR_WEBGL)),this.forceManualRenderingForInstanceIDShaders=c&&!!c.forceManualRenderingForInstanceIDShaders||this.renderer&&this.renderer.indexOf("PowerVR")!==-1,this.options.extTextureFloatLinearForceOff||(this.extTextureFloatLinear=o.getExtension("OES_texture_float_linear")),this.extRenderToTextureHalfFloat=o.getExtension("EXT_color_buffer_half_float"),this.extTimerQuery=o.getExtension("EXT_disjoint_timer_query_webgl2"),this.maxTextureSize=o.getParameter(o.MAX_TEXTURE_SIZE),this.maxPointSize=o.getParameter(o.ALIASED_POINT_SIZE_RANGE)[1]}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.bindVertexArrayOES.dirty=!0,this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(o,c,m){return new eo(this,o,c,m)}createVertexBuffer(o,c,m,v,b){return new sa(this,o,c,m,v,b)}createRenderbuffer(o,c,m){const v=this.gl,b=v.createRenderbuffer();return this.bindRenderbuffer.set(b),v.renderbufferStorage(v.RENDERBUFFER,o,c,m),this.bindRenderbuffer.set(null),b}createFramebuffer(o,c,m,v){return new If(this,o,c,m,v)}clear({color:o,depth:c,stencil:m,colorMask:v}){const b=this.gl;let A=0;o&&(A|=b.COLOR_BUFFER_BIT,this.clearColor.set(o),this.colorMask.set(v||[!0,!0,!0,!0])),c!==void 0&&(A|=b.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(c),this.depthMask.set(!0)),m!==void 0&&(A|=b.STENCIL_BUFFER_BIT,this.clearStencil.set(m),this.stencilMask.set(255)),b.clear(A)}setCullFace(o){o.enable===!1?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(o.mode),this.frontFace.set(o.frontFace))}setDepthMode(o){o.func!==this.gl.ALWAYS||o.mask?(this.depthTest.set(!0),this.depthFunc.set(o.func),this.depthMask.set(o.mask),this.depthRange.set(o.range)):this.depthTest.set(!1)}setStencilMode(o){o.test.func!==this.gl.ALWAYS||o.mask?(this.stencilTest.set(!0),this.stencilMask.set(o.mask),this.stencilOp.set([o.fail,o.depthFail,o.pass]),this.stencilFunc.set({func:o.test.func,ref:o.ref,mask:o.test.mask})):this.stencilTest.set(!1)}setColorMode(o){s.bn(o.blendFunction,xi.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(o.blendFunction),this.blendColor.set(o.blendColor),o.blendEquation?this.blendEquation.set(o.blendEquation):this.blendEquation.setDefault()),this.colorMask.set(o.mask)}unbindVAO(){this.bindVertexArrayOES.set(null)}}let Tl;function mh(p,o,c,m,v,b,A){const M=p.context,O=M.gl,k=p.transform,L=p.getOrCreateProgram("collisionBox"),U=[];let j=0,$=0;for(let fe=0;fe<m.length;fe++){const Ae=m[fe],ve=o.getTile(Ae),be=ve.getBucket(c);if(!be)continue;const ye=Ds(Ae,be,k);let Ie=ye;v[0]===0&&v[1]===0||(Ie=p.translatePosMatrix(ye,ve,v,b));const Fe=A?be.textCollisionBox:be.iconCollisionBox,Qe=be.collisionCircleArray;if(Qe.length>0){const We=s.ab.mat4.create(),at=Ie;s.ab.mat4.mul(We,be.placementInvProjMatrix,k.glCoordMatrix),s.ab.mat4.mul(We,We,be.placementViewportMatrix),U.push({circleArray:Qe,circleOffset:$,transform:at,invTransform:We,projection:be.getProjection()}),j+=Qe.length/4,$=j}Fe&&(p.terrain&&p.terrain.setupElevationDraw(ve,L),L.draw(p,O.LINES,Yt.disabled,oi.disabled,p.colorModeForRenderPass(),li.disabled,X0(Ie,k,ve,be.getProjection()),c.id,Fe.layoutVertexBuffer,Fe.indexBuffer,Fe.segments,null,k.zoom,null,[Fe.collisionVertexBuffer,Fe.collisionVertexBufferExt]))}if(!A||!U.length)return;const Q=p.getOrCreateProgram("collisionCircle"),Z=new s.cV;Z.resize(4*j),Z._trim();let te=0;for(const fe of U)for(let Ae=0;Ae<fe.circleArray.length/4;Ae++){const ve=4*Ae,be=fe.circleArray[ve+0],ye=fe.circleArray[ve+1],Ie=fe.circleArray[ve+2],Fe=fe.circleArray[ve+3];Z.emplace(te++,be,ye,Ie,Fe,0),Z.emplace(te++,be,ye,Ie,Fe,1),Z.emplace(te++,be,ye,Ie,Fe,2),Z.emplace(te++,be,ye,Ie,Fe,3)}(!Tl||Tl.length<2*j)&&(Tl=function(fe){const Ae=2*fe,ve=new s.aU;ve.resize(Ae),ve._trim();for(let be=0;be<Ae;be++){const ye=6*be;ve.uint16[ye+0]=4*be+0,ve.uint16[ye+1]=4*be+1,ve.uint16[ye+2]=4*be+2,ve.uint16[ye+3]=4*be+2,ve.uint16[ye+4]=4*be+3,ve.uint16[ye+5]=4*be+0}return ve}(j));const ee=M.createIndexBuffer(Tl,!0),ae=M.createVertexBuffer(Z,s.cW.members,!0);for(const fe of U){const Ae={u_matrix:fe.transform,u_inv_matrix:fe.invTransform,u_camera_to_center_distance:(me=k).getCameraToCenterDistance(fe.projection),u_viewport_size:[me.width,me.height]};Q.draw(p,O.TRIANGLES,Yt.disabled,oi.disabled,p.colorModeForRenderPass(),li.disabled,Ae,c.id,ae,ee,s.b7.simpleSegment(0,2*fe.circleOffset,fe.circleArray.length,fe.circleArray.length/2),null,k.zoom)}var me;ae.destroy(),ee.destroy()}const Nc=s.ab.mat4.create();function fs(p){const o=p._camera.getWorldToCamera(p.worldSize,1),c=s.ab.mat4.multiply([],o,p.globeMatrix);s.ab.mat4.invert(c,c);const m=[0,0,0],v=[0,1,0,0];return s.ab.vec4.transformMat4(v,v,c),m[0]=v[0],m[1]=v[1],m[2]=v[2],s.ab.vec3.normalize(m,m),m}function tr({width:p,height:o,anchor:c,textOffset:m,textScale:v},b){const{horizontalAlign:A,verticalAlign:M}=s.bD(c),O=-(A-.5)*p,k=-(M-.5)*o,L=s.bC(c,m);return new s.P((O/v+L[0])*b,(k/v+L[1])*b)}function _h(p,o,c,m,v,b,A,M,O,k,L){const U=p.text.placedSymbolArray,j=p.text.dynamicLayoutVertexArray,$=p.icon.dynamicLayoutVertexArray,Q={},Z=p.getProjection(),te=Sa(M,Z,b),ee=b.elevation,ae=Z.upVectorScale(M.canonical,b.center.lat,b.worldSize).metersToTile;j.clear();for(let me=0;me<U.length;me++){const fe=U.get(me),{tileAnchorX:Ae,tileAnchorY:ve,numGlyphs:be}=fe,ye=fe.hidden||!fe.crossTileID||p.allowVerticalPlacement&&!fe.placedOrientation?null:m[fe.crossTileID];if(ye){let Ie=0,Fe=0,Qe=0;if(ee){const tt=ee?ee.getAtTileOffset(M,Ae,ve):0,[Et,ft,ct]=Z.upVector(M.canonical,Ae,ve);Ie=tt*Et*ae,Fe=tt*ft*ae,Qe=tt*ct*ae}let[We,at,nt,je]=zn(fe.projectedAnchorX+Ie,fe.projectedAnchorY+Fe,fe.projectedAnchorZ+Qe,c?te:A);const et=Wu(b.getCameraToCenterDistance(Z),je);let gt=v.evaluateSizeForFeature(p.textSizeData,k,fe)*et/s.bw;c&&(gt*=p.tilePixelRatio/O);const Ve=tr(ye,gt);c?({x:We,y:at,z:nt}=Z.projectTilePoint(Ae+Ve.x,ve+Ve.y,M.canonical),[We,at,nt]=zn(We+Ie,at+Fe,nt+Qe,A)):(o&&Ve._rotate(-b.angle),We+=Ve.x,at+=Ve.y,nt=0);const ut=p.allowVerticalPlacement&&fe.placedOrientation===s.bq.vertical?Math.PI/2:0;for(let tt=0;tt<be;tt++)s.bt(j,We,at,nt,ut);L&&fe.associatedIconIndex>=0&&(Q[fe.associatedIconIndex]={x:We,y:at,z:nt,angle:ut})}else yr(be,j)}if(L){$.clear();const me=p.icon.placedSymbolArray;for(let fe=0;fe<me.length;fe++){const Ae=me.get(fe),{numGlyphs:ve}=Ae,be=Q[fe];if(Ae.hidden||!be)yr(ve,$);else{const{x:ye,y:Ie,z:Fe,angle:Qe}=be;for(let We=0;We<ve;We++)s.bt($,ye,Ie,Fe,Qe)}}p.icon.dynamicLayoutVertexBuffer.updateData($)}p.text.dynamicLayoutVertexBuffer.updateData(j)}function zc(p,o,c,m,v,b,A={}){const M=c.paint.get("icon-translate"),O=c.paint.get("text-translate"),k=c.paint.get("icon-translate-anchor"),L=c.paint.get("text-translate-anchor"),U=c.layout.get("icon-rotation-alignment"),j=c.layout.get("text-rotation-alignment"),$=c.layout.get("icon-pitch-alignment"),Q=c.layout.get("text-pitch-alignment"),Z=c.layout.get("icon-keep-upright"),te=c.layout.get("text-keep-upright"),ee=c.paint.get("icon-color-saturation"),ae=c.paint.get("icon-color-contrast"),me=c.paint.get("icon-color-brightness-min"),fe=c.paint.get("icon-color-brightness-max"),Ae=c.layout.get("symbol-elevation-reference")==="sea",ve=p.context,be=ve.gl,ye=p.transform,Ie=U==="map",Fe=j==="map",Qe=$==="map",We=Q==="map",at=c.layout.get("symbol-sort-key").constantOr(1)!==void 0;let nt=!1;const je=p.depthModeForSublayer(0,Yt.ReadOnly),et=[s.at(ye.center.lng),s.aA(ye.center.lat)],gt=c.layout.get("text-variable-anchor"),Ve=ye.projection.name==="globe",ut=[],tt=[0,-1,0];for(const Et of m){const ft=o.getTile(Et),ct=ft.getBucket(c);if(!ct||ct.projection.name==="mercator"&&Ve||ct.fullyClipped)continue;const xt=ct.projection.name==="globe",Tt=xt?s.ae(ye.zoom):0,Lt=Sa(Et,ct.getProjection(),ye),Ut=ye.calculatePixelsToTileUnitsMatrix(ft),ni=gt&&ct.hasTextData(),Xt=ct.hasIconTextFit()&&ni&&ct.hasIconData(),Kt=ct.getProjection().createInversionMatrix(ye,Et.canonical),ci=Ui=>{ye.depthOcclusionForSymbolsAndCircles&&(c.hasInitialOcclusionOpacityProperties||p.terrain)&&(Ui.push("DEPTH_D24"),Ui.push("DEPTH_OCCLUSION"))},Ci=()=>{const Ui=Ie&&c.layout.get("symbol-placement")!=="point",Hi=[];ci(Hi);const ur=Ui||Xt,Xr=c.paint.get("icon-image-cross-fade").constantOr(0);p.terrainRenderModeElevated()&&Qe&&Hi.push("PITCH_WITH_MAP_TERRAIN"),xt&&(Hi.push("PROJECTION_GLOBE_VIEW"),ur&&Hi.push("PROJECTED_POS_ON_VIEWPORT")),Xr>0&&Hi.push("ICON_TRANSITION"),ct.icon.zOffsetVertexBuffer&&Hi.push("Z_OFFSET"),ee===0&&ae===0&&me===0&&fe===1||Hi.push("COLOR_ADJUSTMENT"),ct.sdfIcons&&Hi.push("RENDER_SDF");const Lr=ct.icon.programConfigurations.get(c.id),Nr=p.getOrCreateProgram("symbol",{config:Lr,defines:Hi}),_s=ft.imageAtlasTexture?ft.imageAtlasTexture.size:[0,0],bn=ct.iconSizeData,hr=s.bp(bn,ye.zoom),Qi=Qe||ye.pitch!==0,Ki=rn(Lt,ft.tileID.canonical,Qe,Ie,ye,ct.getProjection(),Ut),Ri=zd(Lt,ft.tileID.canonical,Qe,Ie,ye,ct.getProjection(),Ut),Ir=p.translatePosMatrix(Ri,ft,M,k,!0),Zr=p.translatePosMatrix(Lt,ft,M,k),Ji=ur?Nc:Ki,wn=Ie&&!Qe&&!Ui;let Is=tt;!Ve&&!ye.mercatorFromTransition||Ie||(Is=fs(ye));const ts=xt?Is:tt,Hn=c.getColorAdjustmentMatrix(ee,ae,me,fe),oo=Af(bn.kind,hr,wn,Qe,p,Zr,Ji,Ir,Ae,!1,_s,[0,0],!0,Et,Tt,et,Kt,ts,ct.getProjection(),Hn,Xr),Cs=ft.imageAtlasTexture?ft.imageAtlasTexture:null,gs=c.layout.get("icon-size").constantOr(0)!==1||ct.iconsNeedLinear,Wa=ct.sdfIcons||p.options.rotating||p.options.zooming||gs||Qi?be.LINEAR:be.NEAREST,ao=ct.sdfIcons&&c.paint.get("icon-halo-width").constantOr(1)!==0,qa=p.terrain&&Qe&&Ui?s.ab.mat4.invert(s.ab.mat4.create(),Ki):Nc;if(Ui&&ct.icon){const Ll=ye.elevation,Bh=Ll?Ll.getAtTileOffsetFunc(Et,ye.center.lat,ye.worldSize,ct.getProjection()):null,Kf=wr(Lt,ft.tileID.canonical,Qe,Ie,ye,ct.getProjection(),Ut);qu(ct,Lt,p,!1,Kf,Ri,Qe,Z,Bh,Et)}return{program:Nr,buffers:ct.icon,uniformValues:oo,atlasTexture:Cs,atlasTextureIcon:null,atlasInterpolation:Wa,atlasInterpolationIcon:null,isSDF:ct.sdfIcons,hasHalo:ao,tile:ft,labelPlaneMatrixInv:qa}},Xi=()=>{const Ui=Fe&&c.layout.get("symbol-placement")!=="point",Hi=[],ur=Ui||gt||Xt;p.terrainRenderModeElevated()&&We&&Hi.push("PITCH_WITH_MAP_TERRAIN"),xt&&(Hi.push("PROJECTION_GLOBE_VIEW"),ur&&Hi.push("PROJECTED_POS_ON_VIEWPORT")),ct.text.zOffsetVertexBuffer&&Hi.push("Z_OFFSET"),ct.iconsInText&&Hi.push("RENDER_TEXT_AND_SYMBOL"),Hi.push("RENDER_SDF"),ci(Hi);const Xr=ct.text.programConfigurations.get(c.id),Lr=p.getOrCreateProgram("symbol",{config:Xr,defines:Hi});let Nr,_s=[0,0],bn=null;const hr=ct.textSizeData;ct.iconsInText&&(_s=ft.imageAtlasTexture?ft.imageAtlasTexture.size:[0,0],bn=ft.imageAtlasTexture?ft.imageAtlasTexture:null,Nr=We||ye.pitch!==0||p.options.rotating||p.options.zooming||hr.kind==="composite"||hr.kind==="camera"?be.LINEAR:be.NEAREST);const Qi=ft.glyphAtlasTexture?ft.glyphAtlasTexture.size:[0,0],Ki=c.layout.get("text-size-scale-range"),Ri=s.aw(p.scaleFactor,Ki[0],Ki[1]),Ir=s.bp(hr,ye.zoom,Ri),Zr=rn(Lt,ft.tileID.canonical,We,Fe,ye,ct.getProjection(),Ut),Ji=zd(Lt,ft.tileID.canonical,We,Fe,ye,ct.getProjection(),Ut),wn=p.translatePosMatrix(Ji,ft,O,L,!0),Is=p.translatePosMatrix(Lt,ft,O,L),ts=ur?Nc:Zr,Hn=Fe&&!We&&!Ui;let oo=tt;!Ve&&!ye.mercatorFromTransition||Fe||(oo=fs(ye));const Cs=Af(hr.kind,Ir,Hn,We,p,Is,ts,wn,Ae,!0,Qi,_s,!0,Et,Tt,et,Kt,xt?oo:tt,ct.getProjection(),null,null,Ri),gs=ft.glyphAtlasTexture?ft.glyphAtlasTexture:null,Wa=be.LINEAR,ao=c.paint.get("text-halo-width").constantOr(1)!==0,qa=p.terrain&&We&&Ui?s.ab.mat4.invert(s.ab.mat4.create(),Zr):Nc;if(Ui&&ct.text){const Ll=ye.elevation,Bh=Ll?Ll.getAtTileOffsetFunc(Et,ye.center.lat,ye.worldSize,ct.getProjection()):null,Kf=wr(Lt,ft.tileID.canonical,We,Fe,ye,ct.getProjection(),Ut);qu(ct,Lt,p,!0,Kf,Ji,We,te,Bh,Et)}return{program:Lr,buffers:ct.text,uniformValues:Cs,atlasTexture:gs,atlasTextureIcon:bn,atlasInterpolation:Wa,atlasInterpolationIcon:Nr,isSDF:!0,hasHalo:ao,tile:ft,labelPlaneMatrixInv:qa}},pr=ct.icon.segments.get().length,rr=ct.text.segments.get().length,di=pr&&!A.onlyText?Ci():null,Fi=rr&&!A.onlyIcons?Xi():null,Wt=c.paint.get("icon-opacity").constantOr(1),Ei=c.paint.get("text-opacity").constantOr(1);if(at&&ct.canOverlap){nt=!0;const Ui=Wt&&!A.onlyText?ct.icon.segments.get():[],Hi=Ei&&!A.onlyIcons?ct.text.segments.get():[];for(const ur of Ui)ut.push({segments:new s.b7([ur]),sortKey:ur.sortKey,state:di});for(const ur of Hi)ut.push({segments:new s.b7([ur]),sortKey:ur.sortKey,state:Fi})}else A.onlyText||ut.push({segments:Wt?ct.icon.segments:new s.b7([]),sortKey:0,state:di}),A.onlyIcons||ut.push({segments:Ei?ct.text.segments:new s.b7([]),sortKey:0,state:Fi})}nt&&ut.sort((Et,ft)=>Et.sortKey-ft.sortKey);for(const Et of ut){const ft=Et.state;if(ft)if(p.terrain?p.terrain.setupElevationDraw(ft.tile,ft.program,{useDepthForOcclusion:ye.depthOcclusionForSymbolsAndCircles,labelPlaneMatrixInv:ft.labelPlaneMatrixInv}):p.setupDepthForOcclusion(ye.depthOcclusionForSymbolsAndCircles,ft.program),ve.activeTexture.set(be.TEXTURE0),ft.atlasTexture&&ft.atlasTexture.bind(ft.atlasInterpolation,be.CLAMP_TO_EDGE,!0),ft.atlasTextureIcon&&(ve.activeTexture.set(be.TEXTURE1),ft.atlasTextureIcon&&ft.atlasTextureIcon.bind(ft.atlasInterpolationIcon,be.CLAMP_TO_EDGE,!0)),p.uploadCommonLightUniforms(p.context,ft.program),ft.hasHalo){const ct=ft.uniformValues;ct.u_is_halo=1,gh(ft.buffers,Et.segments,c,p,ft.program,je,v,b,ct,2),ct.u_is_halo=0}else{if(ft.isSDF){const ct=ft.uniformValues;ft.hasHalo&&(ct.u_is_halo=1,gh(ft.buffers,Et.segments,c,p,ft.program,je,v,b,ct,1)),ct.u_is_halo=0}gh(ft.buffers,Et.segments,c,p,ft.program,je,v,b,ft.uniformValues,1)}}}function gh(p,o,c,m,v,b,A,M,O,k){const L=[p.dynamicLayoutVertexBuffer,p.opacityVertexBuffer,p.iconTransitioningVertexBuffer,p.globeExtVertexBuffer,p.zOffsetVertexBuffer];v.draw(m,m.context.gl.TRIANGLES,b,A,M,li.disabled,O,c.id,p.layoutVertexBuffer,p.indexBuffer,o,c.paint,m.transform.zoom,p.programConfigurations.get(c.id),L,k)}function Mf(p,o,c,m,v,b,A){const M=p.context.gl,O=c.paint.get("fill-pattern"),k=c.is3D(),L=k?p.stencilModeFor3D():oi.disabled,U=O&&O.constantOr(1);let j,$,Q,Z,te;A?($=U&&!c.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",j=M.LINES):($=U?"fillPattern":"fill",j=M.TRIANGLES);for(const ee of m){const ae=o.getTile(ee);if(U&&!ae.patternsLoaded())continue;const me=ae.getBucket(c);if(!me)continue;p.prepareDrawTile();const fe=me.programConfigurations.get(c.id),Ae=p.isTileAffectedByFog(ee),ve=p.getOrCreateProgram($,{config:fe,overrideFog:Ae});U&&(p.context.activeTexture.set(M.TEXTURE0),ae.imageAtlasTexture&&ae.imageAtlasTexture.bind(M.LINEAR,M.CLAMP_TO_EDGE),fe.updatePaintBuffers());const be=O.constantOr(null);if(be&&ae.imageAtlas){const Fe=ae.imageAtlas,Qe=s.A.from(be).getPrimary().scaleSelf(s.q.devicePixelRatio).serialize(),We=Fe.patternPositions[Qe];We&&fe.setConstantPatternPositions(We)}const ye=p.translatePosMatrix(ee.projMatrix,ae,c.paint.get("fill-translate"),c.paint.get("fill-translate-anchor")),Ie=c.paint.get("fill-emissive-strength");if(A){Z=me.indexBuffer2,te=me.segments2;const Fe=p.terrain&&p.terrain.renderingToTexture?p.terrain.drapeBufferSize:[M.drawingBufferWidth,M.drawingBufferHeight];Q=$==="fillOutlinePattern"&&U?a_(ye,Ie,p,ae,Fe):vf(ye,Ie,Fe)}else Z=me.indexBuffer,te=me.segments,Q=U?kc(ye,Ie,p,ae):Fc(ye,Ie);p.uploadCommonUniforms(p.context,ve,ee.toUnwrapped()),ve.draw(p,j,v,k?L:p.stencilModeForClipping(ee),b,li.disabled,Q,c.id,me.layoutVertexBuffer,Z,te,c.paint,p.transform.zoom,fe,void 0)}}function Uc(p,o,c,m,v,b,A,M){c.resetLayerRenderingStats(p);const O=p.context,k=O.gl,L=p.transform,U=c.paint.get("fill-extrusion-pattern"),j=U.constantOr(1),$=c.paint.get("fill-extrusion-opacity"),Q=p.style.enable3dLights(),Z=c.paint.get(Q&&!j?"fill-extrusion-ambient-occlusion-wall-radius":"fill-extrusion-ambient-occlusion-radius"),te=[c.paint.get("fill-extrusion-ambient-occlusion-intensity"),Z],ee=c.layout.get("fill-extrusion-edge-radius"),ae=ee>0&&!c.paint.get("fill-extrusion-rounded-roof"),me=ae?0:ee,fe=L.projection.name==="globe"?s.d3():0,Ae=L.projection.name==="globe",ve=Ae?s.ae(L.zoom):0,be=[s.at(L.center.lng),s.aA(L.center.lat)],ye=c.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default")==="none",Ie=c.paint.get("fill-extrusion-flood-light-color").toRenderColor(ye?null:c.lut).toArray01().slice(0,3),Fe=c.paint.get("fill-extrusion-flood-light-intensity"),Qe=c.paint.get("fill-extrusion-vertical-scale"),We=c.paint.get("fill-extrusion-line-width").constantOr(1)!==0,at=c.paint.get("fill-extrusion-height-alignment"),nt=c.paint.get("fill-extrusion-base-alignment"),je=ta(p,c.paint.get("fill-extrusion-cutoff-fade-range")),et=[];let gt;Ae&&et.push("PROJECTION_GLOBE_VIEW"),te[0]>0&&et.push("FAUX_AO"),ae&&et.push("ZERO_ROOF_RADIUS"),M&&et.push("HAS_CENTROID"),Fe>0&&et.push("FLOOD_LIGHT"),je.shouldRenderCutoff&&et.push("RENDER_CUTOFF"),We&&et.push("RENDER_WALL_MODE");const Ve=p.renderPass==="shadow",ut=p.shadowRenderer,tt=Ve&&!!ut;p.shadowRenderer&&(p.shadowRenderer.useNormalOffset=!0);let Et=[0,0,0];if(ut){const xt=p.style.directionalLight,Tt=p.style.ambientLight;xt&&Tt&&(Et=Yd(p.style,xt,Tt)),Ve||(et.push("RENDER_SHADOWS","DEPTH_TEXTURE"),ut.useNormalOffset&&et.push("NORMAL_OFFSET")),gt=et.concat(["SHADOWS_SINGLE_CASCADE"])}const ft=tt?"fillExtrusionDepth":j?"fillExtrusionPattern":"fillExtrusion",ct=c.getLayerRenderingStats();for(const xt of m){const Tt=o.getTile(xt),Lt=Tt.getBucket(c);if(!Lt||Lt.projection.name!==L.projection.name)continue;let Ut=!1;ut&&(Ut=ut.getMaxCascadeForTile(xt.toUnwrapped())===0);const ni=p.isTileAffectedByFog(xt),Xt=Lt.programConfigurations.get(c.id),Kt=p.getOrCreateProgram(ft,{config:Xt,defines:Ut?gt:et,overrideFog:ni});if(p.terrain&&p.terrain.setupElevationDraw(Tt,Kt,{useMeterToDem:!0}),!Lt.centroidVertexBuffer){const Fi=Kt.attributes.a_centroid_pos;Fi!==void 0&&k.vertexAttrib2f(Fi,0,0)}!Ve&&ut&&ut.setupShadows(Tt.tileID.toUnwrapped(),Kt,"vector-tile",Tt.tileID.overscaledZ),j&&(p.context.activeTexture.set(k.TEXTURE0),Tt.imageAtlasTexture&&Tt.imageAtlasTexture.bind(k.LINEAR,k.CLAMP_TO_EDGE),Xt.updatePaintBuffers());const ci=U.constantOr(null);if(ci&&Tt.imageAtlas){const Fi=Tt.imageAtlas,Wt=s.A.from(ci).getPrimary().scaleSelf(s.q.devicePixelRatio),Ei=Fi.patternPositions[Wt.serialize()];Ei&&Xt.setConstantPatternPositions(Ei)}const Ci=c.paint.get("fill-extrusion-vertical-gradient"),Xi=1/Lt.tileToMeter;let pr;if(Ve&&ut){if(Cl(Tt.tileID,Lt,p))continue;const Fi=ut.calculateShadowPassMatrixFromTile(Tt.tileID.toUnwrapped());pr=Oc(Fi,me,Xi,Qe,at,nt)}else{const Fi=p.translatePosMatrix(xt.expandedProjMatrix,Tt,c.paint.get("fill-extrusion-translate"),c.paint.get("fill-extrusion-translate-anchor")),Wt=L.projection.createInversionMatrix(L,xt.canonical);pr=j?o_(Fi,p,Ci,$,te,me,Xi,xt,Tt,fe,at,nt,ve,be,Wt,Ie,Qe):hh(Fi,p,Ci,$,te,me,Xi,xt,fe,at,nt,ve,be,Wt,Ie,Qe,Fe,Et)}p.uploadCommonUniforms(O,Kt,xt.toUnwrapped(),null,je);let rr=Lt.segments;if(L.projection.name==="mercator"&&!Ve&&(rr=Lt.getVisibleSegments(Tt.tileID,p.terrain,p.transform.getFrustum(0)),!rr.get().length))continue;if(ct)if(Ve)for(const Fi of rr.get())ct.numRenderedVerticesInShadowPass+=Fi.primitiveLength;else for(const Fi of rr.get())ct.numRenderedVerticesInTransparentPass+=Fi.primitiveLength;const di=[];(p.terrain||M)&&di.push(Lt.centroidVertexBuffer),Ae&&di.push(Lt.layoutVertexExtBuffer),We&&di.push(Lt.wallVertexBuffer),Kt.draw(p,O.gl.TRIANGLES,v,b,A,li.backCCW,pr,c.id,Lt.layoutVertexBuffer,Lt.indexBuffer,rr,c.paint,p.transform.zoom,Xt,di)}p.shadowRenderer&&(p.shadowRenderer.useNormalOffset=!1)}function El(p,o,c,m,v,b,A,M,O,k,L,U,j,$,Q,Z,te,ee,ae){const me=p.context,fe=me.gl,Ae=p.transform,ve=p.transform.zoom,be=[],ye=ta(p,c.paint.get("fill-extrusion-cutoff-fade-range"));k==="clear"?(be.push("CLEAR_SUBPASS"),ae&&(be.push("CLEAR_FROM_TEXTURE"),me.activeTexture.set(fe.TEXTURE0),ae.bind(fe.LINEAR,fe.CLAMP_TO_EDGE))):k==="sdf"&&be.push("SDF_SUBPASS"),te&&be.push("HAS_CENTROID"),ye.shouldRenderCutoff&&be.push("RENDER_CUTOFF");const Ie=c.layout.get("fill-extrusion-edge-radius"),Fe=(Qe,We,at,nt,je)=>{const et=We.programConfigurations.get(c.id),gt=p.isTileAffectedByFog(Qe),Ve=p.getOrCreateProgram("fillExtrusionGroundEffect",{config:et,defines:be,overrideFog:gt}),ut=((Et,ft,ct,xt,Tt,Lt,Ut,ni,Xt,Kt,ci)=>({u_matrix:ft,u_opacity:ct,u_ao_pass:xt?1:0,u_meter_to_tile:Tt,u_ao:Lt,u_flood_light_intensity:Ut,u_flood_light_color:ni,u_attenuation:Xt,u_edge_radius:Kt,u_fb:0,u_fb_size:ci,u_dynamic_offset:1}))(0,nt,L,O,je,[U,j*je],$,Q,Z,ve>=17?0:Ie*je,ae?ae.size[0]:0),tt=[];te&&tt.push(We.hiddenByLandmarkVertexBuffer),p.uploadCommonUniforms(me,Ve,Qe.toUnwrapped(),null,ye),Ve.draw(p,me.gl.TRIANGLES,v,b,A,M,ut,c.id,We.vertexBuffer,We.indexBuffer,at,c.paint,ve,et,tt)};for(const Qe of m){const We=o.getTile(Qe),at=We.getBucket(c);if(!at||at.projection.name!==Ae.projection.name||!at.groundEffect||at.groundEffect&&!at.groundEffect.hasData())continue;const nt=at.groundEffect,je=1/at.tileToMeter;{const et=p.translatePosMatrix(Qe.projMatrix,We,c.paint.get("fill-extrusion-translate"),c.paint.get("fill-extrusion-translate-anchor")),gt=nt.getDefaultSegment();Fe(Qe,nt,gt,et,je)}if(ee)for(let et=0;et<4;et++){const gt=s.d4[et](Qe),Ve=o.getTile(gt);if(!Ve)continue;const ut=Ve.getBucket(c);if(!ut||ut.projection.name!==Ae.projection.name||!ut.groundEffect||ut.groundEffect&&!ut.groundEffect.hasData())continue;const tt=ut.groundEffect;let Et,ft;et===0?(Et=[-s.ag,0,0],ft=1):et===1?(Et=[s.ag,0,0],ft=0):et===2?(Et=[0,-s.ag,0],ft=3):(Et=[0,s.ag,0],ft=2);const ct=tt.regionSegments[ft];if(!ct)continue;const xt=new Float32Array(16);s.ab.mat4.translate(xt,Qe.projMatrix,Et),Fe(Qe,tt,ct,p.translatePosMatrix(xt,We,c.paint.get("fill-extrusion-translate"),c.paint.get("fill-extrusion-translate-anchor")),je)}}}function Sl(p,o,c,m,v,b,A){m.centroidVertexArray.length===0&&m.createCentroidsBuffer();const M=b?b.findDEMTileFor(c):null;if(!(M&&M.dem||A))return;b&&M&&M.dem&&m.selfDEMTileTimestamp!==M.dem._timestamp&&(m.borderDoneWithNeighborZ=[-1,-1,-1,-1],m.selfDEMTileTimestamp=M.dem._timestamp);const O=ee=>new s.P(Math.ceil((ee+s.d7)*s.d8),0),k=ee=>{const ae=o.getSource().minzoom,me=Ae=>{const ve=o.getTileByID(Ae);if(ve&&ve.hasData())return ve.getBucket(v)},fe=[0,-1,1];for(const Ae of fe){if(ee.overscaledZ+Ae<ae)continue;const ve=me(ee.calculateScaledKey(ee.overscaledZ+Ae));if(ve)return ve}},L=[0,0,0],U=(ee,ae)=>(L[0]=Math.min(ee.min.y,ae.min.y),L[1]=Math.max(ee.max.y,ae.max.y),L[2]=s.ag-ae.min.x>ee.max.x?ae.min.x-s.ag:ee.max.x,L),j=(ee,ae)=>(L[0]=Math.min(ee.min.x,ae.min.x),L[1]=Math.max(ee.max.x,ae.max.x),L[2]=s.ag-ae.min.y>ee.max.y?ae.min.y-s.ag:ee.max.y,L),$=[(ee,ae)=>U(ee,ae),(ee,ae)=>U(ae,ee),(ee,ae)=>j(ee,ae),(ee,ae)=>j(ae,ee)],Q=(ee,ae,me,fe,Ae,ve,be)=>{if(!b)return 0;const ye=[[ve?me:ee,ve?ee:me,0],[ve?me:ae,ve?ae:me,0]],Ie=be<0?s.ag+be:be,Fe=[ve?Ie:(ee+ae)/2,ve?(ee+ae)/2:Ie,0];return me===0&&be<0||me!==0&&be>0?b.getForTilePoints(Ae,[Fe],!0,fe):ye.push(Fe),b.getForTilePoints(c,ye,!0,M),Math.max(ye[0][2],ye[1][2],Fe[2])/b.exaggeration()};for(let ee=0;ee<4;ee++){const ae=m.borderFeatureIndices[ee];if(ae.length===0)continue;const me=s.d4[ee](c),fe=k(me);if(!(fe&&fe instanceof s.d5))continue;const Ae=b?b.findDEMTileFor(me):null;if(!(Ae&&Ae.dem||A)||(b&&Ae&&Ae.dem&&m.borderDEMTileTimestamp[ee]!==Ae.dem._timestamp&&(m.borderDoneWithNeighborZ[ee]=-1,m.borderDEMTileTimestamp[ee]=Ae.dem._timestamp),m.borderDoneWithNeighborZ[ee]===fe.canonical.z))continue;fe.centroidVertexArray.length===0&&fe.createCentroidsBuffer();const ve=(ee<2?1:5)-ee,be=fe.borderDoneWithNeighborZ[ve]!==m.canonical.z,ye=fe.borderFeatureIndices[ve];let Ie=0;if(m.canonical.z!==fe.canonical.z){for(const Fe of ae)m.showCentroid(m.featuresOnBorder[Fe]);if(be)for(const Fe of ye)fe.showCentroid(fe.featuresOnBorder[Fe]);m.borderDoneWithNeighborZ[ee]=fe.canonical.z,fe.borderDoneWithNeighborZ[ve]=m.canonical.z}for(const Fe of ae){const Qe=m.featuresOnBorder[Fe],We=m.centroidData[Qe.centroidDataIndex],at=Qe.borders[ee];let nt;for(;Ie<ye.length;){nt=fe.featuresOnBorder[ye[Ie]];const je=nt.borders[ve];if(je[1]>at[0]+3||je[0]>at[0]-3)break;fe.showCentroid(nt),Ie++}if(nt&&Ie<ye.length){const je=Ie;let et=0;for(;!(nt.borders[ve][0]>at[1]-3)&&(et++,++Ie!==ye.length);)nt=fe.featuresOnBorder[ye[Ie]];nt=fe.featuresOnBorder[ye[je]];let gt=!1;if(et>=1){const tt=nt.borders[ve];Math.abs(at[0]-tt[0])<3&&Math.abs(at[1]-tt[1])<3&&(et=1,gt=!0,Ie=je+1)}else if(et===0){m.showCentroid(Qe);continue}const Ve=fe.centroidData[nt.centroidDataIndex];A&&gt&&(((Z=We).flags|(te=Ve).flags)&s.d6?(Z.flags|=s.d6,te.flags|=s.d6):(Z.flags&=~s.d6,te.flags&=~s.d6));const ut=Qe.intersectsCount()>1||nt.intersectsCount()>1;if(et>1)Ie=je,We.centroidXY=Ve.centroidXY=new s.P(0,0);else if(Ae&&Ae.dem&&!ut){const tt=$[ee](We,Ve),Et=ee%2?s.ag-1:0,ft=Q(tt[0],Math.min(s.ag-1,tt[1]),Et,Ae,me,ee<2,tt[2]);We.centroidXY=Ve.centroidXY=O(ft)}else ut?We.centroidXY=Ve.centroidXY=new s.P(0,0):(We.centroidXY=m.encodeBorderCentroid(Qe),Ve.centroidXY=fe.encodeBorderCentroid(nt));m.writeCentroidToBuffer(We),fe.writeCentroidToBuffer(Ve)}else m.showCentroid(Qe)}m.borderDoneWithNeighborZ[ee]=fe.canonical.z,fe.borderDoneWithNeighborZ[ve]=m.canonical.z}var Z,te;(m.needsCentroidUpdate||!m.centroidVertexBuffer&&m.centroidVertexArray.length!==0)&&m.uploadCentroid(p)}const Il=[1,0,0],wt=[0,1,0],Nt=[0,0,1];function Cl(p,o,c){const m=c.transform,v=c.shadowRenderer;if(!v)return!0;const b=p.toUnwrapped(),A=m.tileSize*v._cascades[c.currentShadowCascade].scale;let M=o.maxHeight;if(m.elevation){const Z=m.elevation.getMinMaxForTile(p);Z&&(M+=Z.max)}const O=[...v.shadowDirection];O[2]=-O[2];const k=v.computeSimplifiedTileShadowVolume(b,M,A,O);if(!k)return!1;const L=[Il,wt,Nt,O,[O[0],0,O[2]],[0,O[1],O[2]]],U=m.projection.name==="globe",j=m.scaleZoom(A),$=s.bR.fromInvProjectionMatrix(m.invProjMatrix,m.worldSize,j,!U),Q=v.getCurrentCascadeFrustum();return $.intersectsPrecise(k.vertices,k.planes,L)===0||Q.intersectsPrecise(k.vertices,k.planes,L)===0}function cr(p){return[p[0]*s.d9,p[1]*s.d9,p[2]*s.d9,0]}function qe(p,o,c,m,v,b,A,M,O){const k=m.getSource(),L=c.globeSharedBuffers;if(!L)return;let U,j,$;if(o&&(U=m.getTile(o)),k instanceof s.aJ?(j=k.texture,$=s.cI(0,0,c.transform)):U&&o&&(j=U.texture,$=s.cI(o.canonical.z,o.canonical.x,c.transform)),!j||!$)return;p||($=s.ab.mat4.scale(s.ab.mat4.create(),$,[1,-1,1]));const Q=c.context,Z=Q.gl,te=v.paint.get("raster-resampling")==="nearest"?Z.NEAREST:Z.LINEAR,ee=c.colorModeForDrapableLayerRenderPass(b),ae=A.defines;ae.push("GLOBE_POLES");const me=new Yt(Z.LEQUAL,Yt.ReadWrite,c.depthRangeFor3D),fe=Float32Array.from(c.transform.expandedFarZProjMatrix),Ae=Float32Array.from(s.bb(s.cH(new s.bT(0,0,0))));c.terrain&&c.terrain.prepareDrawTile(),Q.activeTexture.set(Z.TEXTURE0),j.bind(te,Z.CLAMP_TO_EDGE),Q.activeTexture.set(Z.TEXTURE1),j.bind(te,Z.CLAMP_TO_EDGE),j.useMipmap&&Q.extTextureFilterAnisotropic&&c.transform.pitch>20&&Z.texParameterf(Z.TEXTURE_2D,Q.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,Q.extTextureFilterAnisotropicMax);const[ve,be,ye,Ie]=o?L.getPoleBuffers(o.canonical.z,!1):L.getPoleBuffers(0,!0),Fe=v.paint.get("raster-elevation");let Qe;p?(Qe=ve,c.renderDefaultNorthPole=Fe!==0):(Qe=be,c.renderDefaultSouthPole=Fe!==0);const We=cr(A.mix),at=((je,et,gt,Ve,ut,tt,Et,ft,ct,xt,Tt,Lt,Ut)=>na(je,et,gt,new Float32Array(16),new Float32Array(9),[0,0],Ve,[0,0],[0,0,0,0],1,{opacity:1,mix:0},tt,[0,0],ft,2,xt,Tt,Lt,1,0,Ut))(fe,Ae,$,s.ae(c.transform.zoom),0,v,0,Fe,0,We,A.offset,A.range,b),nt=c.getOrCreateProgram("raster",{defines:ae});c.uploadCommonUniforms(Q,nt,null),nt.draw(c,Z.TRIANGLES,me,O,ee,M,at,v.id,Qe,ye,Ie)}function c_(p){const o=p._nearZ,c=p.projection.farthestPixelDistance(p),m=c-o,v=.2*p.height,b=o+v;return[o,c,(b-v-o)/m,(b-o)/m]}function yh(p,o,c,m){if(p)return o instanceof jr&&p instanceof Qo?o.getTextureDescriptor(p,c,!0):{texture:p.texture,mix:cr(m.mix),offset:m.offset,buffer:0,tileSize:1}}var Rf=s.da([{name:"a_index",type:"Int16",components:1}]);class u_{constructor(o,c,m,v){const b={width:m[0],height:m[1],data:null},A=o.gl;this.targetColorTexture=new s.T(o,b,A.RGBA8,{useMipmap:!1}),this.backgroundColorTexture=new s.T(o,b,A.RGBA8,{useMipmap:!1}),this.context=o,this.updateParticleTexture(c,v),this.lastInvalidatedAt=0}updateParticleTexture(o,c){if(this.particleTextureDimension===c.width)return;(this.particleTexture0||this.particleTexture1||this.particleIndexBuffer||this.particleSegment)&&(this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleIndexBuffer.destroy(),this.particleSegment.destroy());const m=this.context.gl,v=c.width*c.height;this.particleTexture0=new s.T(this.context,c,m.RGBA8,{premultiply:!1,useMipmap:!1}),this.particleTexture1=new s.T(this.context,c,m.RGBA8,{premultiply:!1,useMipmap:!1});const b=new s.db;b.reserve(v);for(let A=0;A<v;A++)b.emplaceBack(A);this.particleIndexBuffer=this.context.createVertexBuffer(b,Rf.members,!0),this.particleSegment=s.b7.simpleSegment(0,0,this.particleIndexBuffer.length,0),this.particleTextureDimension=c.width}update(o){return!(this.lastInvalidatedAt<o&&(this.lastInvalidatedAt=s.q.now(),1))}destroy(){this.targetColorTexture.destroy(),this.backgroundColorTexture.destroy(),this.particleIndexBuffer.destroy(),this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleSegment.destroy()}}function h_(p,o,c){if(!p)return null;const m=o.getTextureDescriptor(p,c,!0);if(!m)return null;let{texture:v,mix:b,offset:A,tileSize:M,buffer:O,format:k}=m;if(!v||!k)return null;let L=!1;return k==="uint32"&&(L=!0,b[3]=0,b=xf(s.dc,b,[0,c.paint.get("raster-particle-max-speed")]),A=bf(s.dc,A,[0,c.paint.get("raster-particle-max-speed")])),{texture:v,textureOffset:[O/(M+2*O),M/(M+2*O)],tileSize:M,scalarData:L,scale:b,offset:A,defines:["RASTER_ARRAY",{uint8:"DATA_FORMAT_UINT8",uint16:"DATA_FORMAT_UINT16",uint32:"DATA_FORMAT_UINT32"}[k]]}}function d_(p){const o=p._nearZ,c=p.projection.farthestPixelDistance(p),m=c-o,v=.2*p.height,b=o+v;return[o,c,(b-v-o)/m,(b-o)/m]}const Ml=new s.aj(1,0,0,1),K0=new s.aj(0,1,0,1),J0=new s.aj(0,0,1,1),f_=new s.aj(1,0,1,1),vh=new s.aj(0,1,1,1);function oa(p,o,c,m,v,b,A){const M=p.context,O=p.transform,k=M.gl,L=O.projection.name==="globe",U=L?["PROJECTION_GLOBE_VIEW"]:[];let j=s.ab.mat4.clone(c.projMatrix);if(L&&s.ae(O.zoom)>0){const We=s.ba(c.canonical,O),at=s.dd(We);j=s.ab.mat4.multiply(new Float32Array(16),O.globeMatrix,at),s.ab.mat4.multiply(j,O.projMatrix,j)}const $=s.ab.mat4.create();$[12]+=2*v/(s.q.devicePixelRatio*O.width),$[13]+=2*b/(s.q.devicePixelRatio*O.height),s.ab.mat4.multiply(j,$,j);const Q=p.getOrCreateProgram("debug",{defines:U}),Z=o.getTileByID(c.key);p.terrain&&p.terrain.setupElevationDraw(Z,Q);const te=Yt.disabled,ee=oi.disabled,ae=p.colorModeForRenderPass(),me="$debug";M.activeTexture.set(k.TEXTURE0),p.emptyTexture.bind(k.LINEAR,k.CLAMP_TO_EDGE),L?Z._makeGlobeTileDebugBuffers(p.context,O):Z._makeDebugTileBoundsBuffers(p.context,O.projection);const fe=Z._tileDebugBuffer||p.debugBuffer,Ae=Z._tileDebugIndexBuffer||p.debugIndexBuffer,ve=Z._tileDebugSegments||p.debugSegments;if(Q.draw(p,k.LINE_STRIP,te,ee,ae,li.disabled,La(j,m),me,fe,Ae,ve,null,null,null,[Z._globeTileDebugBorderBuffer]),A){const We=Z.latestRawTileData,at=Math.floor((We&&We.byteLength||0)/1024);let nt=c.canonical.toString();c.overscaledZ!==c.canonical.z&&(nt+=` => ${c.overscaledZ}`),nt+=` ${Z.state}`,nt+=` ${at}kb`,function(je,et){je.initDebugOverlayCanvas();const gt=je.debugOverlayCanvas,Ve=je.context.gl,ut=je.debugOverlayCanvas.getContext("2d");ut.clearRect(0,0,gt.width,gt.height),ut.shadowColor="white",ut.shadowBlur=2,ut.lineWidth=1.5,ut.strokeStyle="white",ut.textBaseline="top",ut.font="bold 36px Open Sans, sans-serif",ut.fillText(et,5,5),ut.strokeText(et,5,5),je.debugOverlayTexture.update(gt),je.debugOverlayTexture.bind(Ve.LINEAR,Ve.CLAMP_TO_EDGE)}(p,nt)}const be=o.getTile(c).tileSize,ye=512/Math.min(be,512)*(c.overscaledZ/O.zoom)*.5,Ie=Z._tileDebugTextBuffer||p.debugBuffer,Fe=Z._tileDebugTextIndexBuffer||p.quadTriangleIndexBuffer,Qe=Z._tileDebugTextSegments||p.debugSegments;Q.draw(p,k.TRIANGLES,te,ee,xi.alphaBlended,li.disabled,La(j,s.aj.transparent,ye),me,Ie,Fe,Qe,null,null,null,[Z._globeTileDebugTextBuffer])}function Pf(p,o,c,m){za(p,0,o+c/2,p.transform.width,c,m)}function Bf(p,o,c,m){za(p,o-c/2,0,c,p.transform.height,m)}function za(p,o,c,m,v,b){const A=p.context,M=A.gl;M.enable(M.SCISSOR_TEST),M.scissor(o*s.q.devicePixelRatio,c*s.q.devicePixelRatio,m*s.q.devicePixelRatio,v*s.q.devicePixelRatio),A.clear({color:b}),M.disable(M.SCISSOR_TEST)}const xh=s.da([{name:"a_pos_3f",components:3,type:"Float32"}]),{members:to}=xh;function Bo(p,o,c,m){p.emplaceBack(o,c,m)}class p_{constructor(o){this.vertexArray=new s.de,this.indices=new s.aU,Bo(this.vertexArray,-1,-1,1),Bo(this.vertexArray,1,-1,1),Bo(this.vertexArray,-1,1,1),Bo(this.vertexArray,1,1,1),Bo(this.vertexArray,-1,-1,-1),Bo(this.vertexArray,1,-1,-1),Bo(this.vertexArray,-1,1,-1),Bo(this.vertexArray,1,1,-1),this.indices.emplaceBack(5,1,3),this.indices.emplaceBack(3,7,5),this.indices.emplaceBack(6,2,0),this.indices.emplaceBack(0,4,6),this.indices.emplaceBack(2,6,7),this.indices.emplaceBack(7,3,2),this.indices.emplaceBack(5,4,0),this.indices.emplaceBack(0,1,5),this.indices.emplaceBack(0,2,3),this.indices.emplaceBack(3,1,0),this.indices.emplaceBack(7,6,4),this.indices.emplaceBack(4,5,7),this.vertexBuffer=o.createVertexBuffer(this.vertexArray,to),this.indexBuffer=o.createIndexBuffer(this.indices),this.segment=s.b7.simpleSegment(0,0,36,12)}}function Jr(p,o,c,m,v,b){const A=p.context.gl,M=o.paint.get("sky-atmosphere-color"),O=o.paint.get("sky-atmosphere-halo-color"),k=o.paint.get("sky-atmosphere-sun-intensity"),L=((U,j,$,Q,Z)=>({u_matrix_3f:U,u_sun_direction:j,u_sun_intensity:$,u_color_tint_r:[Q.r,Q.g,Q.b,Q.a],u_color_tint_m:[Z.r,Z.g,Z.b,Z.a],u_luminance:5e-5}))(s.ab.mat3.fromMat4(s.ab.mat3.create(),m),v,k,M,O);A.framebufferTexture2D(A.FRAMEBUFFER,A.COLOR_ATTACHMENT0,A.TEXTURE_CUBE_MAP_POSITIVE_X+b,o.skyboxTexture,0),c.draw(p,A.TRIANGLES,Yt.disabled,oi.disabled,xi.unblended,li.frontCW,L,"skyboxCapture",o.skyboxGeometry.vertexBuffer,o.skyboxGeometry.indexBuffer,o.skyboxGeometry.segment)}const Q0=s.da([{type:"Float32",name:"a_pos",components:3},{type:"Float32",name:"a_uv",components:2}]);class Vc{constructor(o){const c=new s.df;c.emplaceBack(-1,1,1,0,0),c.emplaceBack(1,1,1,1,0),c.emplaceBack(1,-1,1,1,1),c.emplaceBack(-1,-1,1,0,1);const m=new s.aU;m.emplaceBack(0,1,2),m.emplaceBack(2,3,0),this.vertexBuffer=o.createVertexBuffer(c,Q0.members),this.indexBuffer=o.createIndexBuffer(m),this.segments=s.b7.simpleSegment(0,0,4,2)}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy()}}const ir=s.da([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_size_scale",components:1},{type:"Float32",name:"a_fade_opacity",components:1}]);class ji{constructor(){this.starsCount=16e3,this.sizeMultiplier=.15,this.sizeRange=100,this.intensityRange=200}}class m_{constructor(o){this.colorModeAlphaBlendedWriteRGB=new xi([1,Ia,1,Ia],s.aj.transparent,[!0,!0,!0,!1]),this.colorModeWriteAlpha=new xi([1,0,1,0],s.aj.transparent,[!1,!1,!1,!0]),this.params=new ji,this.updateNeeded=!0,o.tp.registerParameter(this.params,["Stars"],"starsCount",{min:100,max:16e3,step:1},()=>{this.updateNeeded=!0}),o.tp.registerParameter(this.params,["Stars"],"sizeMultiplier",{min:.01,max:2,step:.01}),o.tp.registerParameter(this.params,["Stars"],"sizeRange",{min:0,max:200,step:1},()=>{this.updateNeeded=!0}),o.tp.registerParameter(this.params,["Stars"],"intensityRange",{min:0,max:200,step:1},()=>{this.updateNeeded=!0})}update(o){const c=o.context;if(!this.atmosphereBuffer||this.updateNeeded){this.updateNeeded=!1,this.atmosphereBuffer=new Vc(c);const m=this.params.sizeRange,v=this.params.intensityRange,b=function(L){const U=s.di(30),j=[];for(let $=0;$<L;++$){const Q=2*Math.PI*U(),Z=Math.acos(1-2*U())-.5*Math.PI;j.push(s.ab.vec3.fromValues(Math.cos(Z)*Math.cos(Q),Math.cos(Z)*Math.sin(Q),Math.sin(Z)))}return j}(this.params.starsCount),A=s.di(300),M=new s.dg,O=new s.aU;let k=0;for(let L=0;L<b.length;++L){const U=s.ab.vec3.scale([],b[L],200),j=Math.max(0,1+.01*m*(1*A()-.5)),$=Math.max(0,1+.01*v*(1*A()-.5));M.emplaceBack(U[0],U[1],U[2],-1,-1,j,$),M.emplaceBack(U[0],U[1],U[2],1,-1,j,$),M.emplaceBack(U[0],U[1],U[2],1,1,j,$),M.emplaceBack(U[0],U[1],U[2],-1,1,j,$),O.emplaceBack(k+0,k+1,k+2),O.emplaceBack(k+0,k+2,k+3),k+=4}this.starsVx=c.createVertexBuffer(M,ir.members),this.starsIdx=c.createIndexBuffer(O),this.starsSegments=s.b7.simpleSegment(0,0,M.length,O.length)}}destroy(){this.atmosphereBuffer&&this.atmosphereBuffer.destroy(),this.starsVx&&this.starsVx.destroy(),this.starsIdx&&this.starsIdx.destroy()}drawAtmosphereGlow(o,c){const m=o.context,v=m.gl,b=o.transform,A=new Yt(v.LEQUAL,Yt.ReadOnly,[0,1]),M=s.ae(b.zoom),O=o.style.getLut(c.scope),k=c.properties.get("color-use-theme")==="none",L=c.properties.get("color").toRenderColor(k?null:O).toArray01(),U=c.properties.get("high-color-use-theme")==="none",j=c.properties.get("high-color").toRenderColor(U?null:O).toArray01(),$=c.properties.get("space-color-use-theme")==="none",Q=c.properties.get("space-color").toRenderColor($?null:O).toArray01PremultipliedAlpha(),Z=5e-4,te=s.dh(c.properties.get("horizon-blend"),0,1,Z,.25),ee=s.cC(o,m,b)&&te===Z?b.worldSize/(2*Math.PI*1.025)-1:b.globeRadius,ae=o.frameCounter/1e3%1,me=s.ab.vec3.length(b.globeCenterInViewSpace),fe=Math.sqrt(Math.pow(me,2)-Math.pow(ee,2)),Ae=Math.acos(fe/me),ve=be=>{const ye=b.projection.name==="globe"?["PROJECTION_GLOBE_VIEW","FOG"]:["FOG"];be&&ye.push("ALPHA_PASS");const Ie=o.getOrCreateProgram("globeAtmosphere",{defines:ye}),Fe=((We,at,nt,je,et,gt,Ve,ut,tt,Et,ft,ct)=>({u_frustum_tl:We,u_frustum_tr:at,u_frustum_br:nt,u_frustum_bl:je,u_horizon:et,u_transition:gt,u_fadeout_range:Ve,u_color:ut,u_high_color:tt,u_space_color:Et,u_temporal_offset:ft,u_horizon_angle:ct}))(b.frustumCorners.TL,b.frustumCorners.TR,b.frustumCorners.BR,b.frustumCorners.BL,b.frustumCorners.horizon,M,te,L,j,Q,ae,Ae);o.uploadCommonUniforms(m,Ie);const Qe=this.atmosphereBuffer;Qe&&Ie.draw(o,v.TRIANGLES,A,oi.disabled,be?this.colorModeWriteAlpha:this.colorModeAlphaBlendedWriteRGB,li.backCW,Fe,be?"atmosphere_glow_alpha":"atmosphere_glow",Qe.vertexBuffer,Qe.indexBuffer,Qe.segments)};ve(!1),ve(!0)}drawStars(o,c){const m=s.aw(c.properties.get("star-intensity"),0,1);if(m===0)return;const v=o.context,b=v.gl,A=o.transform,M=o.getOrCreateProgram("stars"),O=s.ab.quat.identity([]);s.ab.quat.rotateX(O,O,-A._pitch),s.ab.quat.rotateZ(O,O,-A.angle),s.ab.quat.rotateX(O,O,s.ai(A._center.lat)),s.ab.quat.rotateY(O,O,-s.ai(A._center.lng));const k=s.ab.mat4.fromQuat(new Float32Array(16),O),L=s.ab.mat4.multiply([],A.starsProjMatrix,k),U=s.ab.mat3.fromMat4([],k),j=s.ab.mat3.invert([],U),$=[0,1,0];s.ab.vec3.transformMat3($,$,j),s.ab.vec3.scale($,$,this.params.sizeMultiplier);const Q=[1,0,0];s.ab.vec3.transformMat3(Q,Q,j),s.ab.vec3.scale(Q,Q,this.params.sizeMultiplier);const Z=(te=$,ee=Q,ae=m,{u_matrix:Float32Array.from(L),u_up:te,u_right:ee,u_intensity_multiplier:ae});var te,ee,ae;o.uploadCommonUniforms(v,M),this.starsVx&&this.starsIdx&&M.draw(o,b.TRIANGLES,Yt.disabled,oi.disabled,this.colorModeAlphaBlendedWriteRGB,li.disabled,Z,"atmosphere_stars",this.starsVx,this.starsIdx,this.starsSegments)}}function Do(p,o){const c=[...p],m=o.cameraWorldSizeForFog/o.worldSize,v=s.ab.mat4.identity([]);return s.ab.mat4.scale(v,v,[m,m,1]),s.ab.mat4.multiply(c,v,c),s.ab.mat4.multiply(c,o.worldToFogMatrix,c),c}function Rl(p,o,c,m,v){const b=c.material,A=m.context,{baseColorTexture:M,metallicRoughnessTexture:O}=b.pbrMetallicRoughness,{normalTexture:k,occlusionTexture:L,emissionTexture:U}=b;function j(Q,Z,te){if(Q&&(p.push(Z),A.activeTexture.set(A.gl.TEXTURE0+te),Q.gfxTexture)){const{minFilter:ee,magFilter:ae,wrapS:me,wrapT:fe}=Q.sampler;Q.gfxTexture.bindExtraParam(ee,ae,me,fe)}}j(M,"HAS_TEXTURE_u_baseColorTexture",un.BaseColor),j(O,"HAS_TEXTURE_u_metallicRoughnessTexture",un.MetallicRoughness),j(k,"HAS_TEXTURE_u_normalTexture",un.Normal),j(L,"HAS_TEXTURE_u_occlusionTexture",un.Occlusion),j(U,"HAS_TEXTURE_u_emissionTexture",un.Emission),v&&(v.texture||(v.texture=new s.dk(m.context,v.image,[v.image.height,v.image.height,v.image.height],A.gl.RGBA8)),A.activeTexture.set(A.gl.TEXTURE0+un.LUT),v.texture&&v.texture.bind(A.gl.LINEAR,A.gl.CLAMP_TO_EDGE),p.push("APPLY_LUT_ON_GPU")),c.texcoordBuffer&&(p.push("HAS_ATTRIBUTE_a_uv_2f"),o.push(c.texcoordBuffer)),c.colorBuffer&&(p.push(c.colorBuffer.itemSize===12?"HAS_ATTRIBUTE_a_color_3f":"HAS_ATTRIBUTE_a_color_4f"),o.push(c.colorBuffer)),c.normalBuffer&&(p.push("HAS_ATTRIBUTE_a_normal_3f"),o.push(c.normalBuffer)),c.pbrBuffer&&(p.push("HAS_ATTRIBUTE_a_pbr"),p.push("HAS_ATTRIBUTE_a_heightBasedEmissiveStrength"),o.push(c.pbrBuffer)),b.alphaMode!=="OPAQUE"&&b.alphaMode!=="MASK"||p.push("UNPREMULT_TEXTURE_IN_SHADER"),b.defined||p.push("DIFFUSE_SHADED");const $=m.shadowRenderer;$&&(p.push("RENDER_SHADOWS","DEPTH_TEXTURE"),$.useNormalOffset&&p.push("NORMAL_OFFSET"))}function Oo(p,o,c,m,v,b){const A=c.paint.get("model-opacity").constantOr(1),M=o.context,O=new Yt(o.context.gl.LEQUAL,Yt.ReadWrite,o.depthRangeFor3D),k=o.transform,L=p.mesh,U=L.material,j=U.pbrMetallicRoughness,$=o.style.fog;let Q;Q=o.transform.projection.zAxisUnit==="pixels"?[...p.nodeModelMatrix]:s.ab.mat4.multiply([],m.zScaleMatrix,p.nodeModelMatrix),s.ab.mat4.multiply(Q,m.negCameraPosMatrix,Q);const Z=s.ab.mat4.invert([],Q);s.ab.mat4.transpose(Z,Z);const te=c.paint.get("model-color-use-theme").constantOr("default")==="none",ee=c.paint.get("model-emissive-strength").constantOr(0),ae=Lc(new Float32Array(p.worldViewProjection),new Float32Array(Q),new Float32Array(Z),null,o,A,j.baseColorFactor.toRenderColor(null),U.emissiveFactor,j.metallicFactor,j.roughnessFactor,U,ee,c),me={defines:[]},fe=[],Ae=o.shadowRenderer;Ae&&(Ae.useNormalOffset=!1),Rl(me.defines,fe,L,o,te?null:c.lut);let ve=null;if($){const Ie=Do(p.nodeModelMatrix,o.transform);if(ve=new Float32Array(Ie),k.projection.name!=="globe"){const Fe=L.aabb.min,Qe=L.aabb.max,[We,at]=$.getOpacityForBounds(Ie,Fe[0],Fe[1],Qe[0],Qe[1]);me.overrideFog=We>=Ee||at>=Ee}}const be=ta(o,c.paint.get("model-cutoff-fade-range"));be.shouldRenderCutoff&&me.defines.push("RENDER_CUTOFF");const ye=o.getOrCreateProgram("model",me);o.uploadCommonUniforms(M,ye,null,ve,be),o.renderPass!=="shadow"&&Ae&&Ae.setupShadowsFromMatrix(p.nodeModelMatrix,ye),ye.draw(o,M.gl.TRIANGLES,O,v,b,L.material.doubleSided?li.disabled:li.backCCW,ae,c.id,L.vertexBuffer,L.indexBuffer,L.segments,c.paint,o.transform.zoom,void 0,fe)}function bh(p,o,c,m,v,b,A){let M;M=p.projection.name==="globe"?s.dl(c,p):[...c],s.ab.mat4.multiply(M,M,o.matrix);const O=s.ab.mat4.multiply([],m,M);if(o.meshes)for(const k of o.meshes){if(k.material.alphaMode!=="BLEND"){A.push({mesh:k,depth:0,modelIndex:v,worldViewProjection:O,nodeModelMatrix:M});continue}const L=s.ab.vec3.transformMat4([],k.centroid,O);!p.isOrthographic&&L[2]<=0||b.push({mesh:k,depth:L[2],modelIndex:v,worldViewProjection:O,nodeModelMatrix:M})}if(o.children)for(const k of o.children)bh(p,k,c,m,v,b,A)}function jc(p,o,c,m){const v=c.shadowRenderer;if(!v)return;const b=v.getShadowPassDepthMode(),A=v.getShadowPassColorMode(),M=v.calculateShadowPassMatrixFromMatrix(o),O=ph(M);c.getOrCreateProgram("modelDepth",{defines:c._shadowMapDebug?[]:["DEPTH_TEXTURE"]}).draw(c,c.context.gl.TRIANGLES,b,oi.disabled,A,li.backCCW,O,m.id,p.vertexBuffer,p.indexBuffer,p.segments,m.paint,c.transform.zoom,void 0,void 0)}function io(p,o,c){const m=o.updateZoomBasedPaintProperties(),v=function(b,A,M){let O,k,L,U=b.terrain?b.terrain.exaggeration():0;if(b.terrain&&U>0){const j=b.terrain,$=j.findDEMTileFor(M);$&&$.dem?O=s.dn.create(j,M,$):U=0}if(U===0&&(A.terrainElevationMin=0,A.terrainElevationMax=0),U===A.validForExaggeration&&(U===0||O&&O._demTile&&O._demTile.tileID===A.validForDEMTile.id&&O._dem._timestamp===A.validForDEMTile.timestamp))return!1;for(const j in A.instancesPerModel){const $=A.instancesPerModel[j];for(let Q=0;Q<$.instancedDataArray.length;++Q){const Z=(O?U*O.getElevationAt(0|$.instancedDataArray.float32[16*Q],0|$.instancedDataArray.float32[16*Q+1],!0,!0):0)+$.instancesEvaluatedElevation[Q];$.instancedDataArray.float32[16*Q+6]=Z,k=k?Math.min(A.terrainElevationMin,Z):Z,L=L?Math.max(A.terrainElevationMax,Z):Z}}return A.terrainElevationMin=k||0,A.terrainElevationMax=L||0,A.validForExaggeration=U,A.validForDEMTile=O&&O._demTile?{id:O._demTile.tileID,timestamp:O._dem._timestamp}:{id:void 0,timestamp:0},!0}(p,o,c);(m||v)&&(o.uploaded=!1,o.upload(p.context))}const xn={shadowUniformsInitialized:!1,useSingleShadowCascade:!1,tileMatrix:new Float64Array(16),shadowTileMatrix:new Float32Array(16),aabb:new s.cd([0,0,0],[s.ag,s.ag,0])};function wh(p,o){const c=1<<p.canonical.z,m=o.getFreeCameraOptions().position,v=o.elevation,b=p.canonical.x/c,A=(p.canonical.x+1)/c,M=p.canonical.y/c,O=(p.canonical.y+1)/c;let k=o._centerAltitude;if(v){const $=v.getMinMaxForTile(p);$&&$.max>k&&(k=$.max)}const L=s.aw(m.x,b,A)-m.x,U=s.aw(m.y,M,O)-m.y,j=s.bH(k,o.center.lat)-m.z;return o._zoomFromMercatorZ(Math.sqrt(L*L+U*U+j*j))}function Hc(p,o,c,m,v,b,A){const M=p.context,O=p.renderPass==="shadow",k=p.shadowRenderer,L=O&&k?k.getShadowPassDepthMode():new Yt(M.gl.LEQUAL,Yt.ReadWrite,p.depthRangeFor3D),U=p.isTileAffectedByFog(b);if(c.meshes)for(const j of c.meshes){const $=["MODEL_POSITION_ON_GPU"],Q=[];let Z,te,ee;m.instancedDataArray.length>20&&$.push("INSTANCED_ARRAYS");const ae=ta(p,o.paint.get("model-cutoff-fade-range"));if(ae.shouldRenderCutoff&&$.push("RENDER_CUTOFF"),O&&k)Z=p.getOrCreateProgram("modelDepth",{defines:$}),te=ph(A.shadowTileMatrix,A.shadowTileMatrix,Float32Array.from(c.matrix)),ee=k.getShadowPassColorMode();else{Rl($,Q,j,p,o.paint.get("model-color-use-theme").constantOr("default")==="none"?null:o.lut),Z=p.getOrCreateProgram("model",{defines:$,overrideFog:U});const fe=j.material,Ae=fe.pbrMetallicRoughness,ve=o.paint.get("model-opacity").constantOr(1),be=o.paint.get("model-emissive-strength").constantOr(0);te=Lc(b.expandedProjMatrix,Float32Array.from(c.matrix),new Float32Array(16),null,p,ve,Ae.baseColorFactor.toRenderColor(null),fe.emissiveFactor,Ae.metallicFactor,Ae.roughnessFactor,fe,be,o,v),k&&(A.shadowUniformsInitialized?Z.setShadowUniformValues(M,k.getShadowUniformValues()):(k.setupShadows(b.toUnwrapped(),Z,"model-tile",b.overscaledZ),A.shadowUniformsInitialized=!0)),ee=ae.shouldRenderCutoff||ve<1||fe.alphaMode!=="OPAQUE"?xi.alphaBlended:xi.unblended}p.uploadCommonUniforms(M,Z,b.toUnwrapped(),null,ae);const me=j.material.doubleSided?li.disabled:li.backCCW;if(m.instancedDataArray.length>20)Q.push(m.instancedDataBuffer),Z.draw(p,M.gl.TRIANGLES,L,oi.disabled,ee,me,te,o.id,j.vertexBuffer,j.indexBuffer,j.segments,o.paint,p.transform.zoom,void 0,Q,m.instancedDataArray.length);else{const fe=O?"u_instance":"u_normal_matrix";for(let Ae=0;Ae<m.instancedDataArray.length;++Ae)te[fe]=new Float32Array(m.instancedDataArray.arrayBuffer,64*Ae,16),Z.draw(p,M.gl.TRIANGLES,L,oi.disabled,ee,me,te,o.id,j.vertexBuffer,j.indexBuffer,j.segments,o.paint,p.transform.zoom,void 0,Q)}}if(c.children)for(const j of c.children)Hc(p,o,j,m,v,b,A)}const Df=[1,-1,1];function Of(p,o,c,m){if(!c.modelManager)return!0;const v=c.modelManager;if(!c.shadowRenderer)return!0;const b=c.shadowRenderer,A=o.aabb;let M=!0,O=p.maxHeight;if(O===0){let L=0;for(const U in p.instancesPerModel){const j=v.getModel(U,m);j?L=Math.max(L,Math.max(Math.max(j.aabb.max[0],j.aabb.max[1]),j.aabb.max[2])):M=!1}O=p.maxScale*L*1.41+p.maxVerticalOffset,M&&(p.maxHeight=O)}A.max[2]=O,A.min[2]+=p.terrainElevationMin,A.max[2]+=p.terrainElevationMax,s.ab.vec3.transformMat4(A.min,A.min,o.tileMatrix),s.ab.vec3.transformMat4(A.max,A.max,o.tileMatrix);const k=A.intersects(b.getCurrentCascadeFrustum());return c.currentShadowCascade===0&&(p.isInsideFirstShadowMapFrustum=k===2),k===0}function Ua(p,o){const c=p.uniformValues.u_cutoff_params[0],m=p.uniformValues.u_cutoff_params[1],v=p.uniformValues.u_cutoff_params[2],b=p.uniformValues.u_cutoff_params[3];return m===c||b===v?1:s.aw(((o-c)/(m-c)-v)/(b-v),0,1)}function Ff(p,o,c,m){if(o.pitch<20)return 1;const v=o.getWorldToCameraMatrix();s.ab.mat4.multiply(v,v,p);const b=s.ab.vec4.fromValues(c.min[0],c.min[1],c.min[2],1);let A=s.ab.vec4.transformMat4(s.ab.vec4.create(),b,v),M=A,O=A;b[1]=c.max[1],A=s.ab.vec4.transformMat4(s.ab.vec4.create(),b,v),M=A[1]<M[1]?A:M,O=A[1]>O[1]?A:O,b[0]=c.max[0],A=s.ab.vec4.transformMat4(s.ab.vec4.create(),b,v),M=A[1]<M[1]?A:M,O=A[1]>O[1]?A:O,b[1]=c.min[1],A=s.ab.vec4.transformMat4(s.ab.vec4.create(),b,v),M=A[1]<M[1]?A:M,O=A[1]>O[1]?A:O;const k=s.aw(m[0],0,1),L=100*o.pixelsPerMeter*s.aw(m[1],0,1),U=s.aw(m[2],0,1),j=s.ab.vec4.lerp(s.ab.vec4.create(),M,O,k),$=Math.tan(.5*o.fovX),Q=-j[2]*$;if(L===0)return j[1]<-Math.abs(Q)?U:1;const Z=(-Math.abs(Q)-j[1])/L,te=(ae,me,fe)=>(1-fe)*ae+fe*me,ee=s.aw(te(1,U,Z),U,1);return te(1,ee,s.aw((o.pitch-20)/20,0,1))}class aa{}class kf{constructor(){this._storage=new Map}getLinesFromTrianglesBuffer(o,c,m){{const U=this._storage.get(c.id);if(U)return U.lastUsedFrameIdx=o,U.buf}const v=m.gl,b=v.getBufferParameter(v.ELEMENT_ARRAY_BUFFER,v.BUFFER_SIZE),A=new ArrayBuffer(b),M=new Int16Array(A);v.getBufferSubData(v.ELEMENT_ARRAY_BUFFER,0,new Int16Array(A));const O=new s.dq;for(let U=0;U<b/2;U+=3){const j=M[U],$=M[U+1],Q=M[U+2];O.emplaceBack(j,$),O.emplaceBack($,Q),O.emplaceBack(Q,j)}const k=m.bindVertexArrayOES.current,L=new aa;return L.buf=new eo(m,O),L.lastUsedFrameIdx=o,this._storage.set(c.id,L),m.bindVertexArrayOES.set(k),L.buf}update(o){for(const[c,m]of this._storage)o-m.lastUsedFrameIdx>30&&(m.buf.destroy(),this._storage.delete(c))}destroy(){for(const[o,c]of this._storage)c.buf.destroy(),this._storage.delete(o)}}class Ah{constructor(o){this.occluderSize=30,this.depthOffset=-1e-4,o.registerParameter(this,["Occlusion"],"occluderSize",{min:1,max:100,step:1}),o.registerParameter(this,["Occlusion"],"depthOffset",{min:-.05,max:0,step:1e-5})}}const Lf=s.da([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_rainParticleData",components:4}]);class Nf{registerParameter(){}registerButton(){}registerBinding(){}refreshUI(){}}class on{constructor(o,c){this.revealStart=11,this.revealRange=2,o.registerParameter(this,[...c,"Reveal"],"revealStart",{min:0,max:17,step:.05}),o.registerParameter(this,[...c,"Reveal"],"revealRange",{min:.1,max:5.1,step:.05})}}const zf=s.da([{type:"Float32",name:"a_pos_2f",components:2}]);class Uf{destroy(){this.vignetteVx&&this.vignetteVx.destroy(),this.vignetteIdx&&this.vignetteIdx.destroy()}draw(o,c){const m=o.getOrCreateProgram("vignette");if(!this.vignetteVx||!this.vignetteIdx){const A=new s.dr,M=new s.aU;A.emplaceBack(-1,-1),A.emplaceBack(1,-1),A.emplaceBack(1,1),A.emplaceBack(-1,1),M.emplaceBack(0,1,2),M.emplaceBack(0,2,3),this.vignetteVx=o.context.createVertexBuffer(A,zf.members),this.vignetteIdx=o.context.createIndexBuffer(M)}const v=s.b7.simpleSegment(0,0,4,6);if(this.vignetteVx&&this.vignetteIdx){o.uploadCommonUniforms(o.context,m);const A={u_vignetteShape:(b={vignetteShape:[c.start,c.range,Math.pow(10,c.fadePower)],vignetteColor:[c.color.r,c.color.g,c.color.b,c.color.a*c.strength]}).vignetteShape,u_vignetteColor:b.vignetteColor};m.draw(o,o.context.gl.TRIANGLES,Yt.disabled,oi.disabled,xi.alphaBlended,li.disabled,A,"vignette",this.vignetteVx,this.vignetteIdx,v,{})}var b}}class Gc{constructor(){this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0}update(o,c){const m=o.getFreeCameraOptions().position,v=m.toAltitude(),b=m.toLngLat(),A=s.ai(b.lng),M=s.ai(b.lat),O=o.pixelsPerMeter/c,k=A*s.ds,L=s.ds*Math.log(Math.tan(Math.PI/4+M/2));if(this._offsetXPrev===void 0)this._offsetXPrev=0,this._offsetYPrev=0,this._elevationPrev=0,this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0;else{const U=-this._offsetYPrev+L,j=-this._elevationPrev+v;this._accumulatedOffsetX+=(-this._offsetXPrev+k)*O,this._accumulatedOffsetY+=U*O,this._accumulatedElevation+=j*O,this._offsetXPrev=k,this._offsetYPrev=L,this._elevationPrev=v}}getPosition(){return[this._accumulatedOffsetX,this._accumulatedOffsetY,this._accumulatedElevation]}}function la(p,o){return[-(p[0]-Math.floor(p[0]/o)*o),-(p[1]-Math.floor(p[1]/o)*o),-(p[2]-Math.floor(p[2]/o)*o)]}function Th(p){const o=s.di(1323123451230),c=[];for(let m=0;m<p;++m){const v=2*o()-1,b=2*o()-1,A=2*o()-1;c.push(s.ab.vec3.fromValues(v,b,A))}return c}function ro(p,o,c,m,v){const b=s.aw((v-c)/(m-c),0,1);return(1-b)*p+b*o}class Eh{constructor(o){this._movement=new Gc,this._accumulatedTimeFromStart=0,this._prevTime=Date.now()/1e3,this._vignette=new Uf,this._ppmScaleFactor=o}destroy(){this.particlesVx&&this.particlesVx.destroy(),this.particlesIdx&&this.particlesIdx.destroy(),this._vignette&&this._vignette.destroy()}updateOnRender(o,c){const m=o.transform;this._movement.update(m,this._ppmScaleFactor);const v=m.starsProjMatrix,b=s.ab.quat.identity([]);s.ab.quat.rotateX(b,b,s.ai(90)-m._pitch),s.ab.quat.rotateZ(b,b,-m.angle);const A=s.ab.mat4.fromQuat(new Float32Array(16),b),M=s.ab.mat4.fromValues(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1),O=s.ab.mat4.transpose([],M),k=s.ab.mat4.multiply([],O,A),L=Date.now()/1e3;return this._accumulatedTimeFromStart+=(L-this._prevTime)*c,this._prevTime=L,{projectionMatrix:v,modelviewMatrix:k}}}class Pl extends Eh{constructor(o){super(4.25),this._params={overrideStyleParameters:!1,intensity:.5,timeFactor:1,velocityConeAperture:0,velocity:300,boxSize:2500,dropletSizeX:1,dropletSizeYScale:10,distortionStrength:70,screenThinning:{intensity:.57,start:.46,range:1.17,fadePower:.17,affectedRatio:1,particleOffset:-.2},color:{r:.66,g:.68,b:.74,a:.7},direction:{x:-50,y:-35},shapeDirPower:2,shapeNormalPower:1},this._revealParams=new on(o.tp,["Precipitation","Rain"]),this._vignetteParams={strength:1,start:.7,range:1,fadePower:.4,color:{r:.27,g:.27,b:.27,a:1}},this.particlesCount=16e3}update(o){const c=o.context;if(!this.particlesVx){const m=Th(this.particlesCount),v=new s.dt,b=new s.aU;let A=0;const M=s.di(1323123451230);for(let O=0;O<m.length;++O){const k=m[O],L=[2*M()-1,M(),M(),M()];v.emplaceBack(k[0],k[1],k[2],-1,-1,...L),v.emplaceBack(k[0],k[1],k[2],1,-1,...L),v.emplaceBack(k[0],k[1],k[2],1,1,...L),v.emplaceBack(k[0],k[1],k[2],-1,1,...L),b.emplaceBack(A+0,A+1,A+2),b.emplaceBack(A+0,A+2,A+3),A+=4}this.particlesVx=c.createVertexBuffer(v,Lf.members),this.particlesIdx=c.createIndexBuffer(b)}}draw(o){if(!this._params.overrideStyleParameters&&!o.style.rain)return;const c=this._params.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},m=o.transform.zoom;if(c.revealStart>m)return;const v=ro(0,1,c.revealStart,c.revealStart+c.revealRange,m);if(!this.particlesVx||!this.particlesIdx)return;const b=structuredClone(this._params);let A=[-b.direction.x,b.direction.y,-100];s.ab.vec3.normalize(A,A);const M=structuredClone(this._vignetteParams);M.strength*=v,b.overrideStyleParameters||(b.intensity=o.style.rain.state.density,b.timeFactor=o.style.rain.state.intensity,b.color=structuredClone(o.style.rain.state.color),A=structuredClone(o.style.rain.state.direction),b.screenThinning.intensity=o.style.rain.state.centerThinning,b.dropletSizeX=o.style.rain.state.dropletSize[0],b.dropletSizeYScale=o.style.rain.state.dropletSize[1]/o.style.rain.state.dropletSize[0],b.distortionStrength=100*o.style.rain.state.distortionStrength,M.strength=1,M.color=structuredClone(o.style.rain.state.vignetteColor));const O=this.updateOnRender(o,b.timeFactor),k=o.context,L=k.gl,U=o.transform;this.screenTexture&&this.screenTexture.size[0]===o.width&&this.screenTexture.size[1]===o.height||(this.screenTexture=new s.T(k,{width:o.width,height:o.height,data:null},L.RGBA8)),b.distortionStrength>0&&(k.activeTexture.set(L.TEXTURE0),this.screenTexture.bind(L.LINEAR,L.CLAMP_TO_EDGE),L.copyTexSubImage2D(L.TEXTURE_2D,0,0,0,0,0,o.width,o.height));const j=o.getOrCreateProgram("rainParticle");o.uploadCommonUniforms(k,j),k.activeTexture.set(L.TEXTURE0),this.screenTexture.bind(L.LINEAR,L.CLAMP_TO_EDGE);const $=[b.color.r,b.color.g,b.color.b,b.color.a],Q=(Z,te)=>{const ee=la(this._movement.getPosition(),Z),ae=b.dropletSizeX,me=b.dropletSizeX*b.dropletSizeYScale,fe=o.width/2,Ae=o.height/2,ve=ro(0,b.screenThinning.start,0,1,b.screenThinning.intensity),be=ro(.001,b.screenThinning.range,0,1,b.screenThinning.intensity),ye=ro(0,b.screenThinning.particleOffset,0,1,b.screenThinning.intensity),Ie=(Fe={modelview:O.modelviewMatrix,projection:O.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:ee,velocityConeAperture:b.velocityConeAperture,velocity:b.velocity,boxSize:Z,rainDropletSize:[ae,me],distortionStrength:b.distortionStrength,rainDirection:A,color:$,screenSize:[U.width,U.height],thinningCenterPos:[fe,Ae],thinningShape:[ve,be,Math.pow(10,b.screenThinning.fadePower)],thinningAffectedRatio:b.screenThinning.affectedRatio,thinningParticleOffset:ye,shapeDirectionalPower:b.shapeDirPower,shapeNormalPower:b.shapeNormalPower,mode:te?0:1},{u_modelview:Float32Array.from(Fe.modelview),u_projection:Float32Array.from(Fe.projection),u_time:Fe.time,u_cam_pos:Fe.camPos,u_texScreen:0,u_velocityConeAperture:Fe.velocityConeAperture,u_velocity:Fe.velocity,u_boxSize:Fe.boxSize,u_rainDropletSize:Fe.rainDropletSize,u_distortionStrength:Fe.distortionStrength,u_rainDirection:Fe.rainDirection,u_color:Fe.color,u_screenSize:Fe.screenSize,u_thinningCenterPos:Fe.thinningCenterPos,u_thinningShape:Fe.thinningShape,u_thinningAffectedRatio:Fe.thinningAffectedRatio,u_thinningParticleOffset:Fe.thinningParticleOffset,u_shapeDirectionalPower:Fe.shapeDirectionalPower,u_shapeNormalPower:Fe.shapeNormalPower,u_mode:Fe.mode});var Fe;const Qe=Math.round(b.intensity*this.particlesCount),We=s.b7.simpleSegment(0,0,4*Qe,2*Qe);j.draw(o,L.TRIANGLES,Yt.disabled,oi.disabled,xi.alphaBlended,li.disabled,Ie,"rain_particles",this.particlesVx,this.particlesIdx,We,{})};b.distortionStrength>0&&Q(b.boxSize,!0),Q(b.boxSize,!1),this._vignette.draw(o,M)}}const Vf=s.da([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_snowParticleData",components:4},{type:"Float32",name:"a_snowParticleDataHorizontalOscillation",components:2}]);class jf extends Eh{constructor(o){super(2.25),this._params={overrideStyleParameters:!1,intensity:.85,timeFactor:.75,velocityConeAperture:70,velocity:40,horizontalOscillationRadius:4,horizontalOscillationRate:1.5,boxSize:2e3,billboardSize:2,shapeFadeStart:.27,shapeFadePower:.21,screenThinning:{intensity:.4,start:.15,range:1.4,fadePower:.24,affectedRatio:1,particleOffset:-.2},color:{r:1,g:1,b:1,a:1},direction:{x:-50,y:-35}},this._revealParams=new on(o.tp,["Precipitation","Snow"]),this._vignetteParams={strength:.3,start:.78,range:.46,fadePower:.2,color:{r:1,g:1,b:1,a:1}},this.particlesCount=16e3}update(o){const c=o.context;if(!this.particlesVx){const m=Th(this.particlesCount),v=new s.du,b=new s.aU;let A=0;const M=s.di(1323123451230);for(let O=0;O<m.length;++O){const k=m[O],L=M(),U=M(),j=M(),$=[O/m.length,L,U,j],Q=[M(),M()];v.emplaceBack(k[0],k[1],k[2],-1,-1,...$,...Q),v.emplaceBack(k[0],k[1],k[2],1,-1,...$,...Q),v.emplaceBack(k[0],k[1],k[2],1,1,...$,...Q),v.emplaceBack(k[0],k[1],k[2],-1,1,...$,...Q),b.emplaceBack(A+0,A+1,A+2),b.emplaceBack(A+0,A+2,A+3),A+=4}this.particlesVx=c.createVertexBuffer(v,Vf.members),this.particlesIdx=c.createIndexBuffer(b)}}draw(o){if(!this._params.overrideStyleParameters&&!o.style.snow)return;const c=structuredClone(this._params);let m=[-c.direction.x,c.direction.y,-100];s.ab.vec3.normalize(m,m);const v=structuredClone(this._vignetteParams),b=c.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},A=o.transform.zoom;if(b.revealStart>A)return;const M=ro(0,1,b.revealStart,b.revealStart+b.revealRange,A);v.strength*=M,c.overrideStyleParameters||(c.intensity=o.style.snow.state.density,c.timeFactor=o.style.snow.state.intensity,c.color=structuredClone(o.style.snow.state.color),m=structuredClone(o.style.snow.state.direction),c.screenThinning.intensity=o.style.snow.state.centerThinning,c.billboardSize=2.79*o.style.snow.state.flakeSize,v.strength=1,v.color=structuredClone(o.style.snow.state.vignetteColor));const O=this.updateOnRender(o,c.timeFactor);if(!this.particlesVx||!this.particlesIdx)return;const k=o.context,L=k.gl,U=o.transform,j=o.getOrCreateProgram("snowParticle");o.uploadCommonUniforms(k,j),(($,Q,Z)=>{const te=la(this._movement.getPosition(),$),ee=U.width/2,ae=U.height/2,me=ro(0,Z.screenThinning.start,0,1,Z.screenThinning.intensity),fe=ro(.001,Z.screenThinning.range,0,1,Z.screenThinning.intensity),Ae=ro(0,Z.screenThinning.particleOffset,0,1,Z.screenThinning.intensity),ve=(be={modelview:O.modelviewMatrix,projection:O.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:te,velocityConeAperture:Z.velocityConeAperture,velocity:Z.velocity,horizontalOscillationRadius:Z.horizontalOscillationRadius,horizontalOscillationRate:Z.horizontalOscillationRate,boxSize:$,billboardSize:1*Z.billboardSize,simpleShapeParameters:[Z.shapeFadeStart,Z.shapeFadePower],screenSize:[U.width,U.height],thinningCenterPos:[ee,ae],thinningShape:[me,fe,Math.pow(10,Z.screenThinning.fadePower)],thinningAffectedRatio:Z.screenThinning.affectedRatio,thinningParticleOffset:Ae,color:[Z.color.r,Z.color.g,Z.color.b,Z.color.a],direction:m},{u_modelview:Float32Array.from(be.modelview),u_projection:Float32Array.from(be.projection),u_time:be.time,u_cam_pos:be.camPos,u_velocityConeAperture:be.velocityConeAperture,u_velocity:be.velocity,u_horizontalOscillationRadius:be.horizontalOscillationRadius,u_horizontalOscillationRate:be.horizontalOscillationRate,u_boxSize:be.boxSize,u_billboardSize:be.billboardSize,u_simpleShapeParameters:be.simpleShapeParameters,u_screenSize:be.screenSize,u_thinningCenterPos:be.thinningCenterPos,u_thinningShape:be.thinningShape,u_thinningAffectedRatio:be.thinningAffectedRatio,u_thinningParticleOffset:be.thinningParticleOffset,u_particleColor:be.color,u_direction:be.direction});var be;const ye=Math.round(Z.intensity*this.particlesCount),Ie=s.b7.simpleSegment(0,0,4*ye,2*ye);this.particlesVx&&this.particlesIdx&&j.draw(o,L.TRIANGLES,Yt.disabled,oi.disabled,xi.alphaBlended,li.disabled,ve,"snow_particles",this.particlesVx,this.particlesIdx,Ie,{})})(c.boxSize,0,c),this._vignette.draw(o,v)}}const $c={symbol:function(p,o,c,m,v){if(p.renderPass!=="translucent")return;const b=oi.disabled,A=p.colorModeForRenderPass(),M=c.layout.get("text-variable-anchor"),O=c.layout.get("text-size-scale-range"),k=s.aw(p.scaleFactor,O[0],O[1]);M&&function(j,$,Q,Z,te,ee,ae,me){const fe=$.transform,Ae=te==="map",ve=ee==="map";for(const be of j){const ye=Z.getTile(be),Ie=ye.getBucket(Q);if(!Ie||!Ie.text||!Ie.text.segments.get().length)continue;const Fe=s.bp(Ie.textSizeData,fe.zoom,me),Qe=Sa(be,Ie.getProjection(),fe),We=fe.calculatePixelsToTileUnitsMatrix(ye),at=rn(Qe,ye.tileID.canonical,ve,Ae,fe,Ie.getProjection(),We),nt=Ie.hasIconTextFit()&&Ie.hasIconData();if(Fe){const je=Math.pow(2,fe.zoom-ye.tileID.overscaledZ);_h(Ie,Ae,ve,ae,s.cX,fe,at,be,je,Fe,nt)}}}(m,p,c,o,c.layout.get("text-rotation-alignment"),c.layout.get("text-pitch-alignment"),v,k);const L=c.paint.get("icon-opacity").constantOr(1)!==0,U=c.paint.get("text-opacity").constantOr(1)!==0;c.layout.get("symbol-sort-key").constantOr(1)!==void 0&&(L||U)?zc(p,o,c,m,b,A):(L&&zc(p,o,c,m,b,A,{onlyIcons:!0}),U&&zc(p,o,c,m,b,A,{onlyText:!0})),o.map.showCollisionBoxes&&(mh(p,o,c,m,c.paint.get("text-translate"),c.paint.get("text-translate-anchor"),!0),mh(p,o,c,m,c.paint.get("icon-translate"),c.paint.get("icon-translate-anchor"),!1))},circle:function(p,o,c,m){if(p.renderPass!=="translucent")return;const v=c.paint.get("circle-opacity"),b=c.paint.get("circle-stroke-width"),A=c.paint.get("circle-stroke-opacity"),M=c.layout.get("circle-sort-key").constantOr(1)!==void 0,O=c.paint.get("circle-emissive-strength");if(v.constantOr(1)===0&&(b.constantOr(1)===0||A.constantOr(1)===0))return;const k=p.context,L=k.gl,U=p.transform,j=p.depthModeForSublayer(0,Yt.ReadOnly),$=oi.disabled,Q=p.colorModeForDrapableLayerRenderPass(O),Z=U.projection.name==="globe",te=[s.at(U.center.lng),s.aA(U.center.lat)],ee=[];for(let me=0;me<m.length;me++){const fe=m[me],Ae=o.getTile(fe),ve=Ae.getBucket(c);if(!ve||ve.projection.name!==U.projection.name)continue;const be=ve.programConfigurations.get(c.id),ye=s.cY(c),Ie=p.isTileAffectedByFog(fe);Z&&ye.push("PROJECTION_GLOBE_VIEW"),ye.push("DEPTH_D24"),p.terrain&&U.depthOcclusionForSymbolsAndCircles&&ye.push("DEPTH_OCCLUSION");const Fe=p.getOrCreateProgram("circle",{config:be,defines:ye,overrideFog:Ie}),Qe=ve.layoutVertexBuffer,We=ve.globeExtVertexBuffer,at=ve.indexBuffer,nt=U.projection.createInversionMatrix(U,fe.canonical),je={programConfiguration:be,program:Fe,layoutVertexBuffer:Qe,globeExtVertexBuffer:We,indexBuffer:at,uniformValues:s.cZ(p,fe,Ae,nt,te,c),tile:Ae};if(M){const et=ve.segments.get();for(const gt of et)ee.push({segments:new s.b7([gt]),sortKey:gt.sortKey,state:je})}else ee.push({segments:ve.segments,sortKey:0,state:je})}M&&ee.sort((me,fe)=>me.sortKey-fe.sortKey);const ae={useDepthForOcclusion:U.depthOcclusionForSymbolsAndCircles};for(const me of ee){const{programConfiguration:fe,program:Ae,layoutVertexBuffer:ve,globeExtVertexBuffer:be,indexBuffer:ye,uniformValues:Ie,tile:Fe}=me.state,Qe=me.segments;p.terrain&&p.terrain.setupElevationDraw(Fe,Ae,ae),p.uploadCommonUniforms(k,Ae,Fe.tileID.toUnwrapped()),Ae.draw(p,L.TRIANGLES,j,$,Q,li.disabled,Ie,c.id,ve,ye,Qe,c.paint,U.zoom,fe,[be])}},heatmap:function(p,o,c,m){if(c.paint.get("heatmap-opacity")!==0)if(p.renderPass==="offscreen"){const v=p.context,b=v.gl,A=oi.disabled,M=new xi([b.ONE,b.ONE,b.ONE,b.ONE],s.aj.transparent,[!0,!0,!0,!0]);(function($,Q,Z,te){const ee=$.gl,ae=Q.width*te,me=Q.height*te;$.activeTexture.set(ee.TEXTURE1),$.viewport.set([0,0,ae,me]);let fe=Z.heatmapFbo;if(!fe||fe&&(fe.width!==ae||fe.height!==me)){fe&&fe.destroy();const Ae=ee.createTexture();ee.bindTexture(ee.TEXTURE_2D,Ae),ee.texParameteri(ee.TEXTURE_2D,ee.TEXTURE_WRAP_S,ee.CLAMP_TO_EDGE),ee.texParameteri(ee.TEXTURE_2D,ee.TEXTURE_WRAP_T,ee.CLAMP_TO_EDGE),ee.texParameteri(ee.TEXTURE_2D,ee.TEXTURE_MIN_FILTER,ee.LINEAR),ee.texParameteri(ee.TEXTURE_2D,ee.TEXTURE_MAG_FILTER,ee.LINEAR),fe=Z.heatmapFbo=$.createFramebuffer(ae,me,!0,null),function(ve,be,ye,Ie,Fe,Qe){const We=ve.gl;We.texImage2D(We.TEXTURE_2D,0,ve.extRenderToTextureHalfFloat?We.RGBA16F:We.RGBA,Fe,Qe,0,We.RGBA,ve.extRenderToTextureHalfFloat?We.HALF_FLOAT:We.UNSIGNED_BYTE,null),Ie.colorAttachment.set(ye)}($,0,Ae,fe,ae,me)}else ee.bindTexture(ee.TEXTURE_2D,fe.colorAttachment.get()),$.bindFramebuffer.set(fe.framebuffer)})(v,p,c,p.transform.projection.name==="globe"?.5:.25),v.clear({color:s.aj.transparent});const O=p.transform,k=O.projection.name==="globe",L=k?["PROJECTION_GLOBE_VIEW"]:[],U=k?li.frontCCW:li.disabled,j=[s.at(O.center.lng),s.aA(O.center.lat)];for(let $=0;$<m.length;$++){const Q=m[$];if(o.hasRenderableParent(Q))continue;const Z=o.getTile(Q),te=Z.getBucket(c);if(!te||te.projection.name!==O.projection.name)continue;const ee=p.isTileAffectedByFog(Q),ae=te.programConfigurations.get(c.id),me=p.getOrCreateProgram("heatmap",{config:ae,defines:L,overrideFog:ee}),{zoom:fe}=p.transform;p.terrain&&p.terrain.setupElevationDraw(Z,me),p.uploadCommonUniforms(v,me,Q.toUnwrapped());const Ae=O.projection.createInversionMatrix(O,Q.canonical);me.draw(p,b.TRIANGLES,Yt.disabled,A,M,U,Vt(p,Q,Z,Ae,j,fe,c.paint.get("heatmap-intensity")),c.id,te.layoutVertexBuffer,te.indexBuffer,te.segments,c.paint,p.transform.zoom,ae,k?[te.globeExtVertexBuffer]:null)}v.viewport.set([0,0,p.width,p.height])}else p.renderPass==="translucent"&&(p.context.setColorMode(p.colorModeForRenderPass()),function(v,b){const A=v.context,M=A.gl,O=b.heatmapFbo;if(!O)return;A.activeTexture.set(M.TEXTURE0),M.bindTexture(M.TEXTURE_2D,O.colorAttachment.get()),A.activeTexture.set(M.TEXTURE1);let k=b.colorRampTexture;k||(k=b.colorRampTexture=new s.T(A,b.colorRamp,M.RGBA8)),k.bind(M.LINEAR,M.CLAMP_TO_EDGE),v.getOrCreateProgram("heatmapTexture").draw(v,M.TRIANGLES,Yt.disabled,oi.disabled,v.colorModeForRenderPass(),li.disabled,((L,U,j,$)=>({u_image:0,u_color_ramp:1,u_opacity:U.paint.get("heatmap-opacity")}))(0,b),b.id,v.viewportBuffer,v.quadTriangleIndexBuffer,v.viewportSegments,b.paint,v.transform.zoom)}(p,c))},line:function(p,o,c,m){if(p.renderPass!=="translucent")return;const v=c.paint.get("line-opacity"),b=c.paint.get("line-width");if(v.constantOr(1)===0||b.constantOr(1)===0)return;const A=c.paint.get("line-emissive-strength"),M=c.paint.get("line-occlusion-opacity"),O=c.layout.get("line-elevation-reference"),k=c.layout.get("line-width-unit")==="meters",L=O==="sea",U=p.context,j=U.gl;if(c.hasElevatedBuckets&&p.transform.projection.name==="globe")return;const $=c.layout.get("line-cross-slope"),Q=$!==void 0,Z=$<1,te=p.colorModeForDrapableLayerRenderPass(A),ee=p.terrain&&p.terrain.renderingToTexture,ae=ee?1:s.q.devicePixelRatio,me=c.paint.get("line-dasharray"),fe=me.constantOr(1),Ae=c.layout.get("line-cap"),ve=me.constantOr(null),be=Ae.constantOr(null),ye=c.paint.get("line-pattern"),Ie=ye.constantOr(1),Fe=ye.constantOr(null),Qe=c.paint.get("line-opacity").constantOr(1);let We=!Ie&&Qe!==1||p.depthOcclusion&&M>0&&M<1;const at=c.paint.get("line-gradient"),nt=Ie?"linePattern":"line",je=s.c_(c);let et;if(ee&&p.terrain&&p.terrain.clipOrMaskOverlapStencilType()&&(We=!1),M!==0&&p.depthOcclusion){const Ve=c.paint._values["line-opacity"];Ve&&Ve.value&&Ve.value.kind==="constant"?et=Ve.value:s.w(`Occlusion opacity for layer ${c.id} is supported only when line-opacity isn't data-driven.`)}b.value.kind!=="constant"&&b.value.isLineProgressConstant===!1&&je.push("VARIABLE_LINE_WIDTH");const gt=(Ve,ut,tt,Et,ft)=>{for(const ct of Ve){const xt=o.getTile(ct);if(Ie&&!xt.patternsLoaded())continue;const Tt=xt.getBucket(c);if(!Tt||Tt.hasZOffset&&!ft||!Tt.hasZOffset&&ft)continue;p.prepareDrawTile();const Lt=Tt.programConfigurations.get(c.id),Ut=p.isTileAffectedByFog(ct),ni=p.getOrCreateProgram(nt,{config:Lt,defines:ut,overrideFog:Ut,overrideRtt:!ft&&void 0});if(Fe&&xt.imageAtlas){const di=s.A.from(Fe).getPrimary().scaleSelf(ae).serialize(),Fi=xt.imageAtlas.patternPositions[di];Fi&&Lt.setConstantPatternPositions(Fi)}if(!Ie&&ve&&be&&xt.lineAtlas){const di=xt.lineAtlas.getDash(ve,be);di&&Lt.setConstantPatternPositions(di)}let[Xt,Kt]=c.paint.get("line-trim-offset");(be==="round"||be==="square")&&Xt!==Kt&&(Xt===0&&(Xt-=1),Kt===1&&(Kt+=1));const ci=ee?ct.projMatrix:null,Ci=k?1/Tt.tileToMeter/s.ar(xt,1,p.transform.zoom):1,Xi=k?1/Tt.tileToMeter/s.ar(xt,1,Math.floor(p.transform.zoom)):1,pr=Ie?s.c$(p,xt,c,ci,ae,Ci,Xi,[Xt,Kt]):s.d0(p,xt,c,ci,Tt.lineClipsArray.length,ae,Ci,Xi,[Xt,Kt]);if(at){const di=Tt.gradients[c.id];let Fi=di.texture;if(c.gradientVersion!==di.version){let Wt=256;if(c.stepInterpolant){const Ei=o.getSource().maxzoom,Ui=ct.canonical.z===Ei?Math.ceil(1<<p.transform.maxZoom-ct.canonical.z):1;Wt=s.aw(s.d1(Tt.maxLineLength/s.ag*1024*Ui),256,U.maxTextureSize)}di.gradient=s.d2({expression:c.gradientExpression(),evaluationKey:"lineProgress",resolution:Wt,image:di.gradient||void 0,clips:Tt.lineClipsArray}),di.texture?di.texture.update(di.gradient):di.texture=new s.T(U,di.gradient,j.RGBA8),di.version=c.gradientVersion,Fi=di.texture}U.activeTexture.set(j.TEXTURE1),Fi.bind(c.stepInterpolant?j.NEAREST:j.LINEAR,j.CLAMP_TO_EDGE)}fe&&(U.activeTexture.set(j.TEXTURE0),xt.lineAtlasTexture&&xt.lineAtlasTexture.bind(j.LINEAR,j.REPEAT),Lt.updatePaintBuffers()),Ie&&(U.activeTexture.set(j.TEXTURE0),xt.imageAtlasTexture&&xt.imageAtlasTexture.bind(j.LINEAR,j.CLAMP_TO_EDGE),Lt.updatePaintBuffers()),ft&&!L&&p.terrain.setupElevationDraw(xt,ni),p.uploadCommonUniforms(U,ni,ct.toUnwrapped());const rr=di=>{et!=null&&(et.value=Qe*M),ni.draw(p,j.TRIANGLES,tt,di,te,li.disabled,pr,c.id,Tt.layoutVertexBuffer,Tt.indexBuffer,Tt.segments,c.paint,p.transform.zoom,Lt,[Tt.layoutVertexBuffer2,Tt.patternVertexBuffer,Tt.zOffsetVertexBuffer]),et!=null&&(et.value=Qe)};if(We&&!ft){const di=p.stencilModeForClipping(ct).ref;di===0&&ee&&U.clear({stencil:0});const Fi={func:j.EQUAL,mask:255};pr.u_alpha_discard_threshold=.8,rr(new oi(Fi,di,255,j.KEEP,j.KEEP,j.INVERT)),pr.u_alpha_discard_threshold=0,rr(new oi(Fi,di,255,j.KEEP,j.KEEP,j.KEEP))}else We&&ft&&(pr.u_alpha_discard_threshold=.001),rr(ft?Et:p.stencilModeForClipping(ct))}};if(c.hasNonElevatedBuckets){const Ve=!ee&&p.terrain;M!==0&&Ve?s.w(`Occlusion opacity for layer ${c.id} is supported on terrain only if the layer has line-z-offset enabled.`):Ve?s.w(`Cannot render non-elevated lines in immediate mode when terrain is enabled. Layer: ${c.id}.`):gt(m,je,p.depthModeForSublayer(0,Yt.ReadOnly),oi.disabled,!1)}if(c.hasElevatedBuckets){je.push("ELEVATED"),Q&&je.push(Z?"CROSS_SLOPE_HORIZONTAL":"CROSS_SLOPE_VERTICAL"),L&&je.push("ELEVATION_REFERENCE_SEA");const Ve=We?p.stencilModeFor3D():oi.disabled,ut=new Yt(p.depthOcclusion?j.GREATER:j.LEQUAL,Yt.ReadOnly,p.depthRangeFor3D);p.forceTerrainMode=!0,gt(m,je,ut,Ve,!0),p.forceTerrainMode=!1}We&&(p.resetStencilClippingMasks(),ee&&U.clear({stencil:0})),M===0||p.depthOcclusion||ee||p.layersWithOcclusionOpacity.push(p.currentLayer)},fill:function(p,o,c,m){const v=c.paint.get("fill-color"),b=c.paint.get("fill-opacity"),A=c.is3D(),M=new Yt(p.context.gl.LEQUAL,Yt.ReadWrite,p.depthRangeFor3D);if(b.constantOr(1)===0)return;const O=c.paint.get("fill-emissive-strength"),k=p.colorModeForDrapableLayerRenderPass(O),L=c.paint.get("fill-pattern"),U=p.opaquePassEnabledForLayer()&&!L.constantOr(1)&&v.constantOr(s.aj.transparent).a===1&&b.constantOr(0)===1?"opaque":"translucent";if(p.renderPass===U){const j=A?M:p.depthModeForSublayer(1,p.renderPass==="opaque"?Yt.ReadWrite:Yt.ReadOnly);Mf(p,o,c,m,j,k,!1)}if(!A&&p.renderPass==="translucent"&&c.paint.get("fill-antialias")){const j=A?M:p.depthModeForSublayer(c.getPaintProperty("fill-outline-color")?2:0,Yt.ReadOnly);Mf(p,o,c,m,j,k,!0)}},"fill-extrusion":function(p,o,c,m){const v=c.paint.get("fill-extrusion-opacity"),b=p.context,A=b.gl,M=p.terrain,O=M&&M.renderingToTexture;if(v===0)return;const k=p.conflationActive&&p.style.isLayerClipped(c,o.getSource()),L=p.style.order.indexOf(c.fqid);if(k&&function(U,j,$,Q,Z){for(const te of Q){const ee=j.getTile(te).getBucket($);ee&&(ee.updateReplacement(te,U.replacementSource,Z),ee.uploadCentroid(U.context))}}(p,o,c,m,L),M||k)for(const U of m){const j=o.getTile(U).getBucket(c);j&&Sl(p.context,o,U,j,c,M,k)}if(p.renderPass==="shadow"&&p.shadowRenderer){const U=p.shadowRenderer;if(M&&v<.65&&c._transitionablePaint._values["fill-extrusion-opacity"].value.expression instanceof s.a9)return;const j=U.getShadowPassDepthMode(),$=U.getShadowPassColorMode();Uc(p,o,c,m,j,oi.disabled,$,k)}else if(p.renderPass==="translucent"){const U=!c.paint.get("fill-extrusion-pattern").constantOr(1),j=c.paint.get("fill-extrusion-color").constantOr(s.aj.white);if(!O&&j.a!==0){const $=new Yt(p.context.gl.LEQUAL,Yt.ReadWrite,p.depthRangeFor3D);v===1&&U?Uc(p,o,c,m,$,oi.disabled,xi.unblended,k):(Uc(p,o,c,m,$,oi.disabled,xi.disabled,k),Uc(p,o,c,m,$,p.stencilModeFor3D(),p.colorModeForRenderPass(),k),p.resetStencilClippingMasks())}if(p.style.enable3dLights()&&U&&(!M&&p.transform.projection.name!=="globe"||O)){const $=c.paint.get("fill-extrusion-opacity"),Q=c.paint.get("fill-extrusion-ambient-occlusion-intensity"),Z=c.paint.get("fill-extrusion-ambient-occlusion-ground-radius"),te=c.paint.get("fill-extrusion-flood-light-intensity"),ee=c.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default")==="none",ae=c.paint.get("fill-extrusion-flood-light-color").toRenderColor(ee?null:c.lut).toArray01().slice(0,3),me=Q>0&&Z>0,fe=te>0,Ae=(be,ye,Ie)=>(1-Ie)*be+Ie*ye,ve=be=>{const ye=p.depthModeForSublayer(1,Yt.ReadOnly,A.LEQUAL,!0),Ie=c.paint.get(be?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),Fe=Ae(.1,3,Ie),Qe=p._showOverdrawInspector;if(!Qe){const We=new oi({func:A.ALWAYS,mask:255},255,255,A.KEEP,A.KEEP,A.REPLACE),at=new xi([A.ONE,A.ONE,A.ONE,A.ONE],s.aj.transparent,[!1,!1,!1,!0],A.MIN);El(p,o,c,m,ye,We,at,li.disabled,be,"sdf",$,Q,Z,te,ae,Fe,k,!1)}{const We=Qe?oi.disabled:new oi({func:A.EQUAL,mask:255},255,255,A.KEEP,A.DECR,A.DECR),at=Qe?p.colorModeForRenderPass():new xi([A.ONE_MINUS_DST_ALPHA,A.DST_ALPHA,A.ONE,A.ONE],s.aj.transparent,[!0,!0,!0,!0]);El(p,o,c,m,ye,We,at,li.disabled,be,"color",$,Q,Z,te,ae,Fe,k,!1)}};if(O){const be=(ye,Ie,Fe)=>{const Qe=p.depthModeForSublayer(1,Yt.ReadOnly,A.LEQUAL,!1),We=c.paint.get(ye?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),at=Ae(.1,3,We);{const nt=new xi([A.ONE,A.ONE,A.ONE,A.ONE],s.aj.transparent,[!1,!1,!1,!0]);El(p,o,c,m,Qe,oi.disabled,nt,li.disabled,ye,"clear",$,Q,Z,te,ae,at,k,Ie)}{const nt=new oi({func:A.ALWAYS,mask:255},255,255,A.KEEP,A.KEEP,A.REPLACE),je=new xi([A.ONE,A.ONE,A.ONE,A.ONE],s.aj.transparent,[!1,!1,!1,!0],A.MIN);El(p,o,c,m,Qe,nt,je,li.disabled,ye,"sdf",$,Q,Z,te,ae,at,k,Ie)}{const nt=ye?A.ZERO:A.ONE_MINUS_DST_ALPHA,je=new oi({func:A.EQUAL,mask:255},255,255,A.KEEP,A.DECR,A.DECR),et=new xi([nt,A.DST_ALPHA,A.ONE_MINUS_DST_ALPHA,A.ZERO],s.aj.transparent,[!0,!0,!0,!0]);El(p,o,c,m,Qe,je,et,li.disabled,ye,"color",$,Q,Z,te,ae,at,k,Ie)}{const nt=new xi([A.ONE,A.ONE,A.ONE,ye?A.ZERO:A.ONE],s.aj.transparent,[!1,!1,!1,!0],ye?A.FUNC_ADD:A.MAX);El(p,o,c,m,Qe,oi.disabled,nt,li.disabled,ye,"clear",$,Q,Z,te,ae,at,k,Ie,Fe)}};if(me||fe){let ye;if(p.prepareDrawTile(),M){const Ie=M.drapeBufferSize[0],Fe=M.drapeBufferSize[1];ye=M.framebufferCopyTexture,ye&&(!ye||ye.size[0]===Ie&&ye.size[1]===Fe)||(ye&&ye.destroy(),ye=M.framebufferCopyTexture=new s.T(b,new s.r({width:Ie,height:Fe}),A.RGBA8)),ye.bind(A.LINEAR,A.CLAMP_TO_EDGE),A.copyTexSubImage2D(A.TEXTURE_2D,0,0,0,0,0,Ie,Fe)}me&&be(!0,!1,ye),fe&&be(!1,!0,ye)}}else me&&ve(!0),fe&&ve(!1),(me||fe)&&p.resetStencilClippingMasks()}}},hillshade:function(p,o,c,m){if(p.renderPass!=="offscreen"&&p.renderPass!=="translucent"||p.style.disableElevatedTerrain)return;const v=p.context,b=p.terrain&&p.terrain.renderingToTexture,[A,M]=p.renderPass!=="translucent"||b?[{},m]:p.stencilConfigForOverlap(m);for(const O of M){const k=o.getTile(O);if(k.needsHillshadePrepare&&p.renderPass==="offscreen")L0(p,k,c);else if(p.renderPass==="translucent"){const L=p.depthModeForSublayer(0,Yt.ReadOnly),U=c.paint.get("hillshade-emissive-strength"),j=p.colorModeForDrapableLayerRenderPass(U),$=b&&p.terrain?p.terrain.stencilModeForRTTOverlap(O):A[O.overscaledZ];Xm(p,O,k,c,L,$,j)}}v.viewport.set([0,0,p.width,p.height]),p.resetStencilClippingMasks()},raster:function(p,o,c,m,v,b){if(p.renderPass!=="translucent"||c.paint.get("raster-opacity")===0)return;const A=p.transform.projection.name==="globe",M=c.paint.get("raster-elevation")!==0,O=M&&A;if(p.renderElevatedRasterBackface&&!O)return;const k=p.context,L=k.gl,U=o.getSource(),j=function(ve,be,ye,Ie){const Fe=be.paint.get("raster-color"),Qe=ve.type==="raster-array",We=[],at=be.paint.get("raster-resampling"),nt=be.paint.get("raster-color-mix");let je=be.paint.get("raster-color-range");const et=[nt[0],nt[1],nt[2],0],gt=nt[3];let Ve=at==="nearest"?Ie.NEAREST:Ie.LINEAR;if(Qe&&(We.push("RASTER_ARRAY"),Fe||We.push("RASTER_COLOR"),at==="linear"&&We.push("RASTER_ARRAY_LINEAR"),Ve=Ie.NEAREST,!je&&ve.rasterLayers)){const ut=ve.rasterLayers.find(({id:tt})=>tt===be.sourceLayer);ut&&ut.fields&&ut.fields.range&&(je=ut.fields.range)}if(je=je||[0,1],Fe){We.push("RASTER_COLOR"),ye.activeTexture.set(Ie.TEXTURE2),be.updateColorRamp(je);let ut=be.colorRampTexture;ut||(ut=be.colorRampTexture=new s.T(ye,be.colorRamp,Ie.RGBA8)),ut.bind(Ie.LINEAR,Ie.CLAMP_TO_EDGE)}return{mix:et,range:je,offset:gt,defines:We,resampling:Ve}}(U,c,k,L);if(U instanceof s.aJ&&!m.length&&!A)return;const $=c.paint.get("raster-emissive-strength"),Q=p.colorModeForDrapableLayerRenderPass($),Z=p.terrain&&p.terrain.renderingToTexture,te=!p.options.moving,ee=c.paint.get("raster-resampling")==="nearest"?L.NEAREST:L.LINEAR;if(U instanceof s.aJ&&!m.length&&(U.onNorthPole||U.onSouthPole)){const ve=M?p.stencilModeFor3D():oi.disabled;return void qe(!!U.onNorthPole,null,p,o,c,$,j,li.disabled,ve)}if(!m.length)return;const[ae,me]=U instanceof s.aJ||Z?[{},m]:p.stencilConfigForOverlap(m),fe=me[me.length-1].overscaledZ;O&&j.defines.push("PROJECTION_GLOBE_VIEW"),M&&j.defines.push("RENDER_CUTOFF");const Ae=(ve,be,ye)=>{for(const Ie of ve){const Fe=Ie.toUnwrapped(),Qe=o.getTile(Ie);if(Z&&(!Qe||!Qe.hasData()))continue;k.activeTexture.set(L.TEXTURE0);const We=yh(Qe,U,c,j);if(!We||!We.texture)continue;const{texture:at,mix:nt,offset:je,tileSize:et,buffer:gt}=We;let Ve,ut;Z?(Ve=Yt.disabled,ut=Ie.projMatrix):M?(Ve=new Yt(L.LEQUAL,Yt.ReadWrite,p.depthRangeFor3D),ut=A?Float32Array.from(p.transform.expandedFarZProjMatrix):p.transform.calculateProjMatrix(Fe,te)):(Ve=p.depthModeForSublayer(Ie.overscaledZ-fe,c.paint.get("raster-opacity")===1?Yt.ReadWrite:Yt.ReadOnly,L.LESS),ut=p.transform.calculateProjMatrix(Fe,te));const tt=p.terrain&&Z?p.terrain.stencilModeForRTTOverlap(Ie):ae[Ie.overscaledZ],Et=b?0:c.paint.get("raster-fade-duration");Qe.registerFadeDuration(Et);const ft=o.findLoadedParent(Ie,0),ct=Dc(Qe,ft,o,p.transform,Et);let xt,Tt;p.terrain&&p.terrain.prepareDrawTile(),k.activeTexture.set(L.TEXTURE0),at.bind(ee,L.CLAMP_TO_EDGE),k.activeTexture.set(L.TEXTURE1),ft?(ft.texture&&ft.texture.bind(ee,L.CLAMP_TO_EDGE),xt=Math.pow(2,ft.tileID.overscaledZ-Qe.tileID.overscaledZ),Tt=[Qe.tileID.canonical.x*xt%1,Qe.tileID.canonical.y*xt%1]):at.bind(ee,L.CLAMP_TO_EDGE),at.useMipmap&&k.extTextureFilterAnisotropic&&p.transform.pitch>20&&L.texParameterf(L.TEXTURE_2D,k.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,k.extTextureFilterAnisotropicMax);const Lt=p.transform;let Ut;const ni=M?c_(Lt):[0,0,0,0];let Xt,Kt,ci,Ci,Xi,pr=0;if(O&&U instanceof s.aJ&&U.coordinates.length>3)Xt=Float32Array.from(s.bb(s.cH(new s.bT(0,0,0)))),Kt=Float32Array.from(Lt.globeMatrix),ci=Float32Array.from(s.cD(Lt)),Ci=[s.at(Lt.center.lng),s.aA(Lt.center.lat)],Ut=U.elevatedGlobePerspectiveTransform,Xi=U.elevatedGlobeGridMatrix||new Float32Array(9);else if(O){const Wt=s.cE(Ie.canonical);pr=s.cF(Wt.getCenter().lat),Xt=Float32Array.from(s.bb(s.cH(Ie.canonical))),Kt=Float32Array.from(Lt.globeMatrix),ci=Float32Array.from(s.cD(Lt)),Ci=[s.at(Lt.center.lng),s.aA(Lt.center.lat)],Ut=[0,0],Xi=Float32Array.from(s.cG(Ie.canonical,Wt,pr,Lt.worldSize/Lt._pixelsPerMercatorPixel))}else Ut=U instanceof s.aJ?U.perspectiveTransform:[0,0],Xt=new Float32Array(16),Kt=new Float32Array(9),ci=new Float32Array(16),Ci=[0,0],Xi=new Float32Array(9);const rr=na(ut,Xt,Kt,ci,Xi,Tt||[0,0],s.ae(p.transform.zoom),Ci,ni,xt||1,ct,c,Ut,M?c.paint.get("raster-elevation"):0,2,nt,je,j.range,et,gt,$),di=p.isTileAffectedByFog(Ie),Fi=p.getOrCreateProgram("raster",{defines:j.defines,overrideFog:di});if(p.uploadCommonUniforms(k,Fi,Fe),U instanceof s.aJ){const Wt=U.elevatedGlobeVertexBuffer,Ei=U.elevatedGlobeIndexBuffer;if(Z||!A)U.boundsBuffer&&U.boundsSegments&&Fi.draw(p,L.TRIANGLES,Ve,oi.disabled,Q,li.disabled,rr,c.id,U.boundsBuffer,p.quadTriangleIndexBuffer,U.boundsSegments);else if(Wt&&Ei){const Ui=Lt.zoom<=s.c6?U.elevatedGlobeSegments:U.getSegmentsForLongitude(Lt.center.lng);Ui&&Fi.draw(p,L.TRIANGLES,Ve,oi.disabled,Q,be,rr,c.id,Wt,Ei,Ui)}}else if(O){Ve=new Yt(L.LEQUAL,Yt.ReadOnly,p.depthRangeFor3D);const Wt=p.globeSharedBuffers;if(Wt){const[Ei,Ui,Hi]=Wt.getGridBuffers(pr,!1);Fi.draw(p,L.TRIANGLES,Ve,ye||tt,p.colorModeForRenderPass(),be,rr,c.id,Ei,Ui,Hi)}}else{const{tileBoundsBuffer:Wt,tileBoundsIndexBuffer:Ei,tileBoundsSegments:Ui}=p.getTileBoundsBuffers(Qe);Fi.draw(p,L.TRIANGLES,Ve,tt,Q,li.disabled,rr,c.id,Wt,Ei,Ui)}}if(!(U instanceof s.aJ)&&O)for(const Ie of ve){const Fe=Ie.canonical.y===(1<<Ie.canonical.z)-1;Ie.canonical.y===0&&qe(!0,Ie,p,o,c,$,j,be,ye||oi.disabled),Fe&&qe(!1,Ie,p,o,c,$,j,be===li.frontCW?li.backCW:li.frontCW,ye||oi.disabled)}};O?Ae(me,p.renderElevatedRasterBackface?li.backCW:li.frontCW,p.stencilModeFor3D()):Ae(me,li.disabled,void 0),p.resetStencilClippingMasks()},"raster-particle":function(p,o,c,m,v,b){p.renderPass==="offscreen"&&function(A,M,O,k){if(!k.length)return;const L=A.context,U=L.gl,j=M.getSource();if(!(j instanceof jr))return;const $=Math.ceil(Math.sqrt(O.paint.get("raster-particle-count")));let Q=O.particlePositionRGBAImage;if(!Q||Q.width!==$){const me=function(fe){const Ae=fe*fe,ve=new Uint8Array(4*Ae),be=function(Ie){return Ie|=0,Ie=Math.imul(2747636419^Ie,2654435769),Ie=Math.imul(Ie^Ie>>>16,2654435769),((Ie=Math.imul(Ie^Ie>>>16,2654435769))>>>0)/4294967296},ye=1/1.1;for(let Ie=0;Ie<Ae;Ie++){const Fe=ye*(be(2*Ie+0)+$t),Qe=ye*(be(2*Ie+1)+$t),We=255*Fe%1,at=255*Qe%1,nt=We,je=Qe-at/255,et=at;ve[4*Ie+0]=255*(Fe-We/255),ve[4*Ie+1]=255*nt,ve[4*Ie+2]=255*je,ve[4*Ie+3]=255*et}return ve}($);Q=O.particlePositionRGBAImage=new s.r({width:$,height:$},me)}let Z=O.particleFramebuffer;Z?Z.width!==$&&(Z.destroy(),Z=O.particleFramebuffer=L.createFramebuffer($,$,!0,null)):Z=O.particleFramebuffer=L.createFramebuffer($,$,!0,null);const te=[];for(const me of k){const fe=M.getTile(me);if(!(fe instanceof Qo))continue;const Ae=h_(fe,j,O);if(!Ae)continue;const ve=[fe.tileSize,fe.tileSize];let be=O.tileFramebuffer;be||(be=O.tileFramebuffer=L.createFramebuffer(ve[0],ve[1],!0,null));let ye=fe.rasterParticleState;ye||(ye=fe.rasterParticleState=new u_(L,me,ve,Q));const Ie=ye.update(O.lastInvalidatedAt);ye.particleTextureDimension!==$&&ye.updateParticleTexture(me,Q);const Fe=ye.targetColorTexture;ye.targetColorTexture=ye.backgroundColorTexture,ye.backgroundColorTexture=Fe;const Qe=ye.particleTexture0;ye.particleTexture0=ye.particleTexture1,ye.particleTexture1=Qe,te.push([me,Ae,ye,Ie])}if(te.length===0)return;const ee=s.q.now(),ae=O.previousDrawTimestamp?.001*(ee-O.previousDrawTimestamp):.0167;if(O.previousDrawTimestamp=ee,O.hasColorMap()){L.activeTexture.set(U.TEXTURE0+2);let me=O.colorRampTexture;me||(me=O.colorRampTexture=new s.T(L,O.colorRamp,U.RGBA8)),me.bind(U.LINEAR,U.CLAMP_TO_EDGE)}L.bindFramebuffer.set(O.tileFramebuffer.framebuffer),function(me,fe,Ae){const ve=me.context,be=ve.gl,ye=fe.tileFramebuffer;ve.activeTexture.set(be.TEXTURE0);const Ie={u_texture:0,u_opacity:1.05*(Qe=fe.paint.get("raster-particle-fade-opacity-factor"))/(Qe+.05)},Fe=me.getOrCreateProgram("rasterParticleTexture",{defines:[],overrideFog:!1});var Qe;for(const We of Ae){const[,,at,nt]=We;ye.colorAttachment.set(at.targetColorTexture.texture),ve.viewport.set([0,0,ye.width,ye.height]),ve.clear({color:s.aj.transparent}),nt&&(at.backgroundColorTexture.bind(be.NEAREST,be.CLAMP_TO_EDGE),Fe.draw(me,be.TRIANGLES,Yt.disabled,oi.disabled,xi.alphaBlended,li.disabled,Ie,fe.id,me.viewportBuffer,me.quadTriangleIndexBuffer,me.viewportSegments))}}(A,O,te),function(me,fe,Ae,ve){const be=me.context,ye=be.gl,Ie=Ae.tileFramebuffer,Fe=me.transform.projection.name==="globe",Qe=Ae.paint.get("raster-particle-max-speed");for(const We of ve){const[at,nt,je]=We;be.activeTexture.set(ye.TEXTURE0+0),nt.texture.bind(ye.LINEAR,ye.CLAMP_TO_EDGE),Ie.colorAttachment.set(je.targetColorTexture.texture);const et=me.getOrCreateProgram("rasterParticleDraw",{defines:nt.defines,overrideFog:!1});be.activeTexture.set(ye.TEXTURE0+1);const gt=nt.scalarData?[]:[0,1,2,3].map(tt=>s.d4[tt](at));gt.push(at);const Ve=at.canonical.x,ut=at.canonical.y;for(const tt of gt){const Et=fe.getTile(Fe?tt.wrapped():tt);if(!Et)continue;const ft=Et.rasterParticleState;if(!ft)continue;const ct=tt.canonical.x+(1<<tt.canonical.z)*(tt.wrap-at.wrap),xt=tt.canonical.y;ft.particleTexture0.bind(ye.NEAREST,ye.CLAMP_TO_EDGE);const Tt=Z0(1,ft.particleTexture0.size[0],[ct-Ve,xt-ut],0,nt.texture.size,2,Qe,nt.textureOffset,nt.scale,nt.offset);et.draw(me,ye.POINTS,Yt.disabled,oi.disabled,xi.alphaBlended,li.disabled,Tt,Ae.id,ft.particleIndexBuffer,void 0,ft.particleSegment)}}}(A,M,O,te),L.bindFramebuffer.set(O.particleFramebuffer.framebuffer),function(me,fe,Ae,ve){const be=me.context,ye=be.gl,Ie=fe.paint.get("raster-particle-max-speed"),Fe=ve*fe.paint.get("raster-particle-speed-factor")*.15,Qe=function(at){return Math.pow(at,6)}(.01+1*fe.paint.get("raster-particle-reset-rate-factor")),We=fe.particleFramebuffer;be.viewport.set([0,0,We.width,We.height]);for(const at of Ae){const[,nt,je]=at;be.activeTexture.set(ye.TEXTURE0+0),nt.texture.bind(ye.LINEAR,ye.CLAMP_TO_EDGE),be.activeTexture.set(ye.TEXTURE0+1);const et=je.particleTexture0;et.bind(ye.NEAREST,ye.CLAMP_TO_EDGE);const gt=Y0(1,et.size[0],0,nt.texture.size,Ie,Fe,Qe,nt.textureOffset,nt.scale,nt.offset);We.colorAttachment.set(je.particleTexture1.texture),be.clear({color:s.aj.transparent}),me.getOrCreateProgram("rasterParticleUpdate",{defines:nt.defines}).draw(me,ye.TRIANGLES,Yt.disabled,oi.disabled,xi.unblended,li.disabled,gt,fe.id,me.viewportBuffer,me.quadTriangleIndexBuffer,me.viewportSegments)}}(A,O,te,ae)}(p,o,c,m),p.renderPass==="translucent"&&(function(A,M,O,k,L){const U=A.context,j=U.gl,$=M.getSource().tileSize,Q=5*(1-s.ac(s.bY,s.bY+1,A.transform.zoom))*$+O.paint.get("raster-particle-elevation"),Z=!A.options.moving,te=A.transform.projection.name==="globe";if(!k.length)return;const[ee,ae]=A.stencilConfigForOverlap(k),me=[];te&&me.push("PROJECTION_GLOBE_VIEW");const fe=A.stencilModeFor3D();for(const Ae of ae){const ve=Ae.toUnwrapped(),be=M.getTile(Ae);if(!be.rasterParticleState)continue;const ye=be.rasterParticleState,Ie=100;be.registerFadeDuration(Ie);const Fe=M.findLoadedParent(Ae,0),Qe=Dc(be,Fe,M,A.transform,Ie);let We,at;A.terrain&&A.terrain.prepareDrawTile(),U.activeTexture.set(j.TEXTURE0),ye.targetColorTexture.bind(j.LINEAR,j.CLAMP_TO_EDGE),U.activeTexture.set(j.TEXTURE1),Fe&&Fe.rasterParticleState?(Fe.rasterParticleState.targetColorTexture.bind(j.LINEAR,j.CLAMP_TO_EDGE),We=Math.pow(2,Fe.tileID.overscaledZ-be.tileID.overscaledZ),at=[be.tileID.canonical.x*We%1,be.tileID.canonical.y*We%1]):ye.targetColorTexture.bind(j.LINEAR,j.CLAMP_TO_EDGE);const nt=te?Float32Array.from(A.transform.expandedFarZProjMatrix):A.transform.calculateProjMatrix(ve,Z),je=A.transform,et=d_(je),gt=s.cE(Ae.canonical),Ve=s.cF(gt.getCenter().lat);let ut,tt,Et,ft,ct;te?(ut=Float32Array.from(s.bb(s.cH(Ae.canonical))),tt=Float32Array.from(je.globeMatrix),Et=Float32Array.from(s.cD(je)),ft=[s.at(je.center.lng),s.aA(je.center.lat)],ct=Float32Array.from(s.cG(Ae.canonical,gt,Ve,je.worldSize/je._pixelsPerMercatorPixel))):(ut=new Float32Array(16),tt=new Float32Array(9),Et=new Float32Array(16),ft=[0,0],ct=new Float32Array(9));const xt=wf(nt,ut,tt,Et,ct,at||[0,0],s.ae(A.transform.zoom),ft,et,We||1,Qe,Q),Tt=A.isTileAffectedByFog(Ae),Lt=A.getOrCreateProgram("rasterParticle",{defines:me,overrideFog:Tt});if(A.uploadCommonUniforms(U,Lt,ve),te){const Ut=new Yt(j.LEQUAL,Yt.ReadOnly,A.depthRangeFor3D),ni=0,Xt=A.globeSharedBuffers;if(Xt){const[Kt,ci,Ci]=Xt.getGridBuffers(Ve,ni!==0);Lt.draw(A,j.TRIANGLES,Ut,fe,xi.alphaBlended,A.renderElevatedRasterBackface?li.frontCCW:li.backCCW,xt,O.id,Kt,ci,Ci)}}else{const Ut=A.depthModeForSublayer(0,Yt.ReadOnly),ni=ee[Ae.overscaledZ],{tileBoundsBuffer:Xt,tileBoundsIndexBuffer:Kt,tileBoundsSegments:ci}=A.getTileBoundsBuffers(be);Lt.draw(A,j.TRIANGLES,Ut,ni,xi.alphaBlended,li.disabled,xt,O.id,Xt,Kt,ci)}}A.resetStencilClippingMasks()}(p,o,c,m),p.style.map.triggerRepaint())},background:function(p,o,c,m){const v=c.paint.get("background-color"),b=c.paint.get("background-color-use-theme").constantOr("default")==="none",A=c.paint.get("background-opacity"),M=c.paint.get("background-emissive-strength"),O=c.paint.get("background-pitch-alignment")==="viewport";if(A===0)return;const k=p.context,L=k.gl,U=p.transform,j=U.tileSize,$=c.paint.get("background-pattern");let Q;if($!==void 0&&($===null||(Q=p.imageManager.getPattern($.toString(),c.scope,p.style.getLut(c.scope)),!Q)))return;const Z=!$&&v.a===1&&A===1&&p.opaquePassEnabledForLayer()?"opaque":"translucent";if(p.renderPass!==Z)return;const te=oi.disabled,ee=p.depthModeForSublayer(0,Z==="opaque"?Yt.ReadWrite:Yt.ReadOnly),ae=p.colorModeForDrapableLayerRenderPass(M),me=$?"backgroundPattern":"background";let fe,Ae=m;if(Ae||(fe=p.getBackgroundTiles(),Ae=Object.values(fe).map(ve=>ve.tileID)),$&&(k.activeTexture.set(L.TEXTURE0),p.imageManager.bind(p.context,c.scope)),O){const ve=p.getOrCreateProgram(me,{overrideFog:!1,overrideRtt:!0}),be=new Float32Array(s.ab.mat4.identity([])),ye=new s.aG(0,0,0,0,0),Ie=$?l_(be,M,A,p,0,c.scope,Q,O,{tileID:ye,tileSize:j}):Tf(be,M,A,v.toRenderColor(b?null:c.lut));ve.draw(p,L.TRIANGLES,ee,te,ae,li.disabled,Ie,c.id,p.viewportBuffer,p.quadTriangleIndexBuffer,p.viewportSegments)}else for(const ve of Ae){const be=p.isTileAffectedByFog(ve),ye=p.getOrCreateProgram(me,{overrideFog:be}),Ie=ve.toUnwrapped(),Fe=m?ve.projMatrix:p.transform.calculateProjMatrix(Ie);p.prepareDrawTile();const Qe=o?o.getTile(ve):fe?fe[ve.key]:new Jo(ve,j,U.zoom,p),We=$?l_(Fe,M,A,p,0,c.scope,Q,O,{tileID:ve,tileSize:j}):Tf(Fe,M,A,v.toRenderColor(b?null:c.lut));p.uploadCommonUniforms(k,ye,Ie);const{tileBoundsBuffer:at,tileBoundsIndexBuffer:nt,tileBoundsSegments:je}=p.getTileBoundsBuffers(Qe);ye.draw(p,L.TRIANGLES,ee,te,ae,li.disabled,We,c.id,at,nt,je)}},sky:function(p,o,c){const m=p._atmosphere?s.ae(p.transform.zoom):1,v=c.paint.get("sky-opacity")*m;if(v===0)return;const b=p.context,A=c.paint.get("sky-type"),M=new Yt(b.gl.LEQUAL,Yt.ReadOnly,[0,1]),O=p.frameCounter/1e3%1;A==="atmosphere"?p.renderPass==="offscreen"?c.needsSkyboxCapture(p)&&(function(k,L,U,j){const $=k.context,Q=$.gl;let Z=L.skyboxFbo;if(!Z){Z=L.skyboxFbo=$.createFramebuffer(32,32,!0,null),L.skyboxGeometry=new p_($),L.skyboxTexture=$.gl.createTexture(),Q.bindTexture(Q.TEXTURE_CUBE_MAP,L.skyboxTexture),Q.texParameteri(Q.TEXTURE_CUBE_MAP,Q.TEXTURE_WRAP_S,Q.CLAMP_TO_EDGE),Q.texParameteri(Q.TEXTURE_CUBE_MAP,Q.TEXTURE_WRAP_T,Q.CLAMP_TO_EDGE),Q.texParameteri(Q.TEXTURE_CUBE_MAP,Q.TEXTURE_MIN_FILTER,Q.LINEAR),Q.texParameteri(Q.TEXTURE_CUBE_MAP,Q.TEXTURE_MAG_FILTER,Q.LINEAR);for(let me=0;me<6;++me)Q.texImage2D(Q.TEXTURE_CUBE_MAP_POSITIVE_X+me,0,Q.RGBA,32,32,0,Q.RGBA,Q.UNSIGNED_BYTE,null)}$.bindFramebuffer.set(Z.framebuffer),$.viewport.set([0,0,32,32]);const te=L.getCenter(k,!0),ee=k.getOrCreateProgram("skyboxCapture"),ae=new Float64Array(16);s.ab.mat4.identity(ae),s.ab.mat4.rotateY(ae,ae,.5*-Math.PI),Jr(k,L,ee,ae,te,0),s.ab.mat4.identity(ae),s.ab.mat4.rotateY(ae,ae,.5*Math.PI),Jr(k,L,ee,ae,te,1),s.ab.mat4.identity(ae),s.ab.mat4.rotateX(ae,ae,.5*-Math.PI),Jr(k,L,ee,ae,te,2),s.ab.mat4.identity(ae),s.ab.mat4.rotateX(ae,ae,.5*Math.PI),Jr(k,L,ee,ae,te,3),s.ab.mat4.identity(ae),Jr(k,L,ee,ae,te,4),s.ab.mat4.identity(ae),s.ab.mat4.rotateY(ae,ae,Math.PI),Jr(k,L,ee,ae,te,5),$.viewport.set([0,0,k.width,k.height])}(p,c),c.markSkyboxValid(p)):p.renderPass==="sky"&&function(k,L,U,j,$){const Q=k.context,Z=Q.gl,te=k.transform,ee=k.getOrCreateProgram("skybox");Q.activeTexture.set(Z.TEXTURE0),Z.bindTexture(Z.TEXTURE_CUBE_MAP,L.skyboxTexture);const ae=((me,fe,Ae,ve,be)=>({u_matrix:me,u_sun_direction:fe,u_cubemap:0,u_opacity:ve,u_temporal_offset:be}))(te.skyboxMatrix,L.getCenter(k,!1),0,j,$);k.uploadCommonUniforms(Q,ee),ee.draw(k,Z.TRIANGLES,U,oi.disabled,k.colorModeForRenderPass(),li.backCW,ae,"skybox",L.skyboxGeometry.vertexBuffer,L.skyboxGeometry.indexBuffer,L.skyboxGeometry.segment)}(p,c,M,v,O):A==="gradient"&&p.renderPass==="sky"&&function(k,L,U,j,$){const Q=k.context,Z=Q.gl,te=k.transform,ee=k.getOrCreateProgram("skyboxGradient");L.skyboxGeometry||(L.skyboxGeometry=new p_(Q)),Q.activeTexture.set(Z.TEXTURE0);let ae=L.colorRampTexture;ae||(ae=L.colorRampTexture=new s.T(Q,L.colorRamp,Z.RGBA8)),ae.bind(Z.LINEAR,Z.CLAMP_TO_EDGE);const me=((fe,Ae,ve,be,ye)=>({u_matrix:fe,u_color_ramp:0,u_center_direction:Ae,u_radius:s.ai(ve),u_opacity:be,u_temporal_offset:ye}))(te.skyboxMatrix,L.getCenter(k,!1),L.paint.get("sky-gradient-radius"),j,$);k.uploadCommonUniforms(Q,ee),ee.draw(k,Z.TRIANGLES,U,oi.disabled,k.colorModeForRenderPass(),li.backCW,me,"skyboxGradient",L.skyboxGeometry.vertexBuffer,L.skyboxGeometry.indexBuffer,L.skyboxGeometry.segment)}(p,c,M,v,O)},debug:function(p,o,c,m,v,b){for(let A=0;A<c.length;A++)if(v){const k=new s.aj(m.r*.8,m.g*.8,m.b*.8,1);oa(p,o,c[A],m,-1,-1,b),oa(p,o,c[A],m,-1,1,b),oa(p,o,c[A],m,1,1,b),oa(p,o,c[A],m,1,-1,b),oa(p,o,c[A],k,0,0,b)}else oa(p,o,c[A],m,0,0,b)},custom:function(p,o,c,m){const v=p.context,b=c.implementation;if(!p.transform.projection.unsupportedLayers||!p.transform.projection.unsupportedLayers.includes("custom")||p.terrain&&(p.terrain.renderingToTexture||p.renderPass==="offscreen")&&c.isDraped(o)){if(p.renderPass==="offscreen"){const A=b.prerender;if(A){if(p.setCustomLayerDefaults(),v.setColorMode(p.colorModeForRenderPass()),p.transform.projection.name==="globe"){const M=p.transform.pointMerc;A.call(b,v.gl,p.transform.customLayerMatrix(),p.transform.getProjection(),p.transform.globeToMercatorMatrix(),s.ae(p.transform.zoom),[M.x,M.y],p.transform.pixelsPerMeterRatio)}else A.call(b,v.gl,p.transform.customLayerMatrix());v.setDirty(),p.setBaseState()}}else if(p.renderPass==="translucent"){if(p.terrain&&p.terrain.renderingToTexture){const M=b.renderToTile;if(M){const O=m[0].canonical,k=new s.aa(O.x+m[0].wrap*(1<<O.z),O.y,O.z);v.setDepthMode(Yt.disabled),v.setStencilMode(oi.disabled),v.setColorMode(p.colorModeForRenderPass()),p.setCustomLayerDefaults(),M.call(b,v.gl,k),v.setDirty(),p.setBaseState()}return}p.setCustomLayerDefaults(),v.setColorMode(p.colorModeForRenderPass()),v.setStencilMode(oi.disabled);const A=b.renderingMode==="3d"?new Yt(p.context.gl.LEQUAL,Yt.ReadWrite,p.depthRangeFor3D):p.depthModeForSublayer(0,Yt.ReadOnly);if(v.setDepthMode(A),p.transform.projection.name==="globe"){const M=p.transform.pointMerc;b.render(v.gl,p.transform.customLayerMatrix(),p.transform.getProjection(),p.transform.globeToMercatorMatrix(),s.ae(p.transform.zoom),[M.x,M.y],p.transform.pixelsPerMeterRatio)}else b.render(v.gl,p.transform.customLayerMatrix());v.setDirty(),p.setBaseState(),v.bindFramebuffer.set(null)}}else s.w("Custom layers are not yet supported with this projection. Use mercator or globe to enable usage of custom layers.")},model:function(p,o,c,m){if(p.renderPass==="opaque")return;const v=c.paint.get("model-opacity").constantOr(1);if(v===0)return;const b=c.paint.get("model-cast-shadows");if(p.renderPass==="shadow"&&(!b||p.terrain&&v<.65&&c._transitionablePaint._values["model-opacity"].value.expression instanceof s.a9))return;const A=p.shadowRenderer,M=c.paint.get("model-receive-shadows");A&&(A.useNormalOffset=!0,M||(A.enabled=!1));const O=()=>{A&&(A.useNormalOffset=!0,M||(A.enabled=!0))},k=o.getSource();if(p.renderPass==="light-beam"&&k.type!=="batched-model")return;if(k.type==="vector"||k.type==="geojson")return function(ee,ae,me,fe,Ae){const ve=ee.transform;if(ve.projection.name!=="mercator")return void s.w(`Drawing 3D models for ${ve.projection.name} projection is not yet implemented`);const be=ve.getFreeCameraOptions().position;if(!ee.modelManager)return;const ye=ee.modelManager;me.modelManager=ye;const Ie=ee.shadowRenderer;if(!me._unevaluatedLayout._values.hasOwnProperty("model-id"))return;const Fe=me._unevaluatedLayout._values["model-id"],Qe=Object.assign({},me.layout.get("model-id").parameters),We=ee.style.order.indexOf(me.fqid);for(const at of fe){const nt=ae.getTile(at).getBucket(me);if(!nt||nt.projection.name!==ve.projection.name)continue;const je=nt.getModelUris();je&&!nt.modelsRequested&&(ye.addModelsFromBucket(je,Ae),nt.modelsRequested=!0);const et=wh(at,ve);Qe.zoom=et;const gt=Fe.possiblyEvaluate(Qe);if(io(ee,nt,at),xn.shadowUniformsInitialized=!1,xn.useSingleShadowCascade=!!Ie&&Ie.getMaxCascadeForTile(at.toUnwrapped())===0,ee.renderPass==="shadow"&&Ie){if(ee.currentShadowCascade===1&&nt.isInsideFirstShadowMapFrustum)continue;const tt=ve.calculatePosMatrix(at.toUnwrapped(),ve.worldSize);if(xn.tileMatrix.set(tt),xn.shadowTileMatrix=Float32Array.from(Ie.calculateShadowPassMatrixFromMatrix(tt)),xn.aabb.min.fill(0),xn.aabb.max[0]=xn.aabb.max[1]=s.ag,xn.aabb.max[2]=0,Of(nt,xn,ee,me.scope))continue}const Ve=1<<at.canonical.z,ut=[((be.x-at.wrap)*Ve-at.canonical.x)*s.ag,(be.y*Ve-at.canonical.y)*s.ag,be.z*Ve*s.ag];ee.conflationActive&&Object.keys(nt.instancesPerModel).length>0&&ee.style.isLayerClipped(me,ae.getSource())&&nt.updateReplacement(at,ee.replacementSource,We,Ae)&&(nt.uploaded=!1,nt.upload(ee.context));for(let tt in nt.instancesPerModel){const Et=nt.instancesPerModel[tt];Et.features.length>0&&(tt=gt.evaluate(Et.features[0].feature,{}));const ft=ye.getModel(tt,Ae);if(ft&&ft.uploaded)for(const ct of ft.nodes)Hc(ee,me,ct,Et,ut,at,xn)}}}(p,o,c,m,k.type==="vector"?c.scope:""),void O();if(!k.loaded())return;if(k.type==="batched-model")return function(ee,ae,me,fe){me.resetLayerRenderingStats(ee);const Ae=ee.context,ve=ee.transform,be=ee.style.fog,ye=ee.shadowRenderer;if(ve.projection.name!=="mercator")return void s.w(`Drawing 3D landmark models for ${ve.projection.name} projection is not yet implemented`);const Ie=ee.transform.getFreeCameraOptions().position,Fe=s.ab.vec3.scale([],[Ie.x,Ie.y,Ie.z],ee.transform.worldSize),Qe=s.ab.vec3.negate([],Fe),We=s.ab.mat4.identity([]),at=s.dj(ve.center.lat,ve.zoom),nt=s.ab.mat4.fromScaling([],[1,1,1/at]);s.ab.mat4.translate(We,We,Qe);const je=me.paint.get("model-opacity").constantOr(1),et=new Yt(Ae.gl.LEQUAL,Yt.ReadWrite,ee.depthRangeFor3D),gt=new Yt(Ae.gl.LEQUAL,Yt.ReadOnly,ee.depthRangeFor3D),Ve=new s.cd([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),ut=ee.renderPass==="shadow",tt=ut&&ye?ye.getCurrentCascadeFrustum():ve.getFrustum(ve.scaleZoom(ve.worldSize)),Et=me.paint.get("model-front-cutoff"),ft=Et[2]<1,ct=ta(ee,me.paint.get("model-cutoff-fade-range")),xt=me.getLayerRenderingStats();(function(Tt,Lt,Ut,ni){const Xt=Tt.terrain?Tt.terrain.exaggeration():0,Kt=Tt.transform.zoom;for(const ci of ni){const Ci=Lt.getTile(ci).getBucket(Ut);Ci&&(Tt.conflationActive&&Ci.updateReplacement(ci,Tt.replacementSource),Ci.evaluateScale(Tt,Ut),Tt.terrain&&Xt>0&&Ci.elevationUpdate(Tt.terrain,Xt,ci,Ut.source),Ci.needsReEvaluation(Tt,Kt,Ut)&&Ci.evaluate(Ut))}})(ee,ae,me,fe),function(){let Tt,Lt,Ut;ft?(Tt=fe.length-1,Lt=-1,Ut=-1):(Tt=0,Lt=fe.length,Ut=1);const ni=new Float64Array(16),Xt=s.ab.vec3.create(),Kt=new s.P(0,0);for(let ci=Tt;ci!==Lt;ci+=Ut){const Ci=fe[ci],Xi=ae.getTile(Ci).getBucket(me);if(!Xi||!Xi.uploaded)continue;let pr=!1;ye&&(pr=ye.getMaxCascadeForTile(Ci.toUnwrapped())===0);const rr=ve.calculatePosMatrix(Ci.toUnwrapped(),ve.worldSize),di=Xi.modelTraits;!ut&&ft&&(s.ab.mat4.invert(ni,rr),s.ab.vec3.transformMat4(Xt,Fe,ni),Kt.x=Xt[0],Kt.y=Xt[1]);const Fi=[];for(const Wt of Xi.getNodesInfo()){if(Wt.hiddenByReplacement||!Wt.node.meshes)continue;const Ei=Wt.node;let Ui=0;ee.terrain&&Ei.elevation&&(Ui=Ei.elevation*ee.terrain.exaggeration());const Hi=(()=>{const Ri=Wt.aabb;return Ve.min=[...Ri.min],Ve.max=[...Ri.max],Ve.min[2]+=Ui,Ve.max[2]+=Ui,s.ab.vec3.transformMat4(Ve.min,Ve.min,rr),s.ab.vec3.transformMat4(Ve.max,Ve.max,rr),Ve})(),ur=Wt.evaluatedScale;if(ur[0]<=1&&ur[1]<=1&&ur[2]<=1&&Hi.intersects(tt)===0)continue;if(!ut&&ft){const Ri=.16666666666666666;Wt.cameraCollisionOpacity=Fe[0]>Hi.min[0]&&Fe[0]<Hi.max[0]&&Fe[1]>Hi.min[1]&&Fe[1]<Hi.max[1]&&Fe[2]*at<Hi.max[2]&&Ei.footprint&&s.bA(Kt,Ei.footprint)?Math.max(Wt.cameraCollisionOpacity-Ri,0):Math.min(1,Wt.cameraCollisionOpacity+Ri)}const Xr=[...rr],Lr=Ei.anchor?Ei.anchor[0]:0,Nr=Ei.anchor?Ei.anchor[1]:0;s.ab.mat4.translate(Xr,Xr,[Lr*(ur[0]-1),Nr*(ur[1]-1),Ui]),s.ab.vec3.exactEquals(ur,s.dm)||s.ab.mat4.scale(Xr,Xr,ur);const _s=s.ab.mat4.multiply([],Xr,Ei.matrix),bn=s.ab.mat4.multiply([],ve.expandedFarZProjMatrix,_s),hr=s.ab.mat4.multiply([],ve.expandedFarZProjMatrix,Xr),Qi=s.ab.vec4.transformMat4([],[Lr,Nr,Ui,1],bn)[2];Ei.hidden=!1;let Ki=je;ut||(ft&&(Ki*=Wt.cameraCollisionOpacity,Ki*=Ff(Xr,ve,Wt.aabb,Et)),Ki*=Ua(ct,Qi)),Ki!==0?Fi.push({nodeInfo:Wt,depth:Qi,opacity:Ki,wvpForNode:bn,wvpForTile:hr,nodeModelMatrix:_s,tileModelMatrix:Xr}):Ei.hidden=!0}ut||Fi.sort((Wt,Ei)=>!ft||Wt.opacity===1&&Ei.opacity===1?Wt.depth<Ei.depth?-1:1:Wt.opacity===1?-1:Ei.opacity===1?1:Wt.depth>Ei.depth?-1:1);for(const Wt of Fi){const Ei=Wt.nodeInfo,Ui=Ei.node;let Hi=s.ab.mat4.multiply([],nt,Wt.tileModelMatrix);s.ab.mat4.multiply(Hi,We,Hi);const ur=s.ab.mat4.invert([],Hi);s.ab.mat4.transpose(ur,ur),s.ab.mat4.scale(ur,ur,Df),Hi=s.ab.mat4.multiply(Hi,Hi,Ui.matrix);const Xr=ee.renderPass==="light-beam",Lr=me.paint.get("model-color-use-theme").constantOr("default")==="none",Nr=di&s.dp.HasMapboxMeshFeatures,_s=Nr?0:Ei.evaluatedRMEA[0][2];for(let bn=0;bn<Ui.meshes.length;++bn){const hr=Ui.meshes[bn],Qi=bn===Ui.lightMeshIndex;let Ki=Wt.wvpForNode;if(Qi){if(!Xr&&!ee.terrain&&ee.shadowRenderer){ee.currentLayer<ee.firstLightBeamLayer&&(ee.firstLightBeamLayer=ee.currentLayer);continue}Ki=Wt.wvpForTile}else if(Xr)continue;const Ri={defines:[]},Ir=[];if(!ut&&ye&&(ye.useNormalOffset=!!hr.normalBuffer),Rl(Ri.defines,Ir,hr,ee,Lr?null:me.lut),Nr||Ri.defines.push("DIFFUSE_SHADED"),pr&&Ri.defines.push("SHADOWS_SINGLE_CASCADE"),xt&&(ut?xt.numRenderedVerticesInShadowPass+=hr.vertexArray.length:xt.numRenderedVerticesInTransparentPass+=hr.vertexArray.length),ut){jc(hr,Wt.nodeModelMatrix,ee,me);continue}let Zr=null;if(be){const oo=Do(Wt.nodeModelMatrix,ee.transform);if(Zr=new Float32Array(oo),ve.projection.name!=="globe"){const Cs=hr.aabb.min,gs=hr.aabb.max,[Wa,ao]=be.getOpacityForBounds(oo,Cs[0],Cs[1],gs[0],gs[1]);Ri.overrideFog=Wa>=Ee||ao>=Ee}}const Ji=hr.material;let wn;Ji.occlusionTexture&&Ji.occlusionTexture.offsetScale&&(wn=Ji.occlusionTexture.offsetScale,Ri.defines.push("OCCLUSION_TEXTURE_TRANSFORM"));const Is=ee.getOrCreateProgram("model",Ri);!ut&&ye&&ye.setupShadowsFromMatrix(Wt.tileModelMatrix,Is,ye.useNormalOffset),ee.uploadCommonUniforms(Ae,Is,null,Zr);const ts=Ji.pbrMetallicRoughness;ts.metallicFactor=.9,ts.roughnessFactor=.5;const Hn=Lc(new Float32Array(Ki),new Float32Array(Hi),new Float32Array(ur),new Float32Array(Ui.matrix),ee,Wt.opacity,ts.baseColorFactor.toRenderColor(null),Ji.emissiveFactor,ts.metallicFactor,ts.roughnessFactor,Ji,_s,me,[0,0,0],wn);!Qi&&(Ei.hasTranslucentParts||Wt.opacity<1)&&Is.draw(ee,Ae.gl.TRIANGLES,et,oi.disabled,xi.disabled,li.backCCW,Hn,me.id,hr.vertexBuffer,hr.indexBuffer,hr.segments,me.paint,ee.transform.zoom,void 0,Ir),Is.draw(ee,Ae.gl.TRIANGLES,Qi?gt:et,oi.disabled,Qi||Wt.opacity<1||Ei.hasTranslucentParts?xi.alphaBlended:xi.unblended,li.backCCW,Hn,me.id,hr.vertexBuffer,hr.indexBuffer,hr.segments,me.paint,ee.transform.zoom,void 0,Ir)}}}}()}(p,o,c,m),void O();if(k.type!=="model")return;const L=k.getModels(),U=[],j=p.transform.getFreeCameraOptions().position,$=s.ab.vec3.scale([],[j.x,j.y,j.z],p.transform.worldSize);s.ab.vec3.negate($,$);const Q=[],Z=[];let te=0;for(const ee of L){const ae=c.paint.get("model-rotation").constantOr(null),me=c.paint.get("model-scale").constantOr(null),fe=c.paint.get("model-translation").constantOr(null);ee.computeModelMatrix(p,ae,me,fe,!0,!0,!1);const Ae=s.ab.mat4.identity([]),ve=s.dj(ee.position.lat,p.transform.zoom),be=s.ab.mat4.fromScaling([],[1,1,1/ve]);s.ab.mat4.translate(Ae,Ae,$),U.push({zScaleMatrix:be,negCameraPosMatrix:Ae});for(const ye of ee.nodes)bh(p.transform,ye,ee.matrix,p.transform.expandedFarZProjMatrix,te,Q,Z);te++}if(Q.sort((ee,ae)=>ae.depth-ee.depth),p.renderPass!=="shadow"){if(v===1)for(const ee of Z)Oo(ee,p,c,U[ee.modelIndex],oi.disabled,p.colorModeForRenderPass());else{for(const ee of Z)Oo(ee,p,c,U[ee.modelIndex],oi.disabled,xi.disabled);for(const ee of Z)Oo(ee,p,c,U[ee.modelIndex],p.stencilModeFor3D(),p.colorModeForRenderPass());p.resetStencilClippingMasks()}for(const ee of Q)Oo(ee,p,c,U[ee.modelIndex],oi.disabled,p.colorModeForRenderPass());O()}else{for(const ee of Z)jc(ee.mesh,ee.nodeModelMatrix,p,c);for(const ee of Q)jc(ee.mesh,ee.nodeModelMatrix,p,c);O()}}},Wc={line:function(p,o,c){if(p.hasElevatedBuckets=!1,p.hasNonElevatedBuckets=!1,p._unevaluatedLayout.getValue("line-elevation-reference")!==void 0||p._unevaluatedLayout.getValue("line-z-offset")!==void 0){if(o){const m=o.getVisibleCoordinates();for(const v of m){const b=o.getTile(v).getBucket(p);if(b&&(b.hasZOffset?p.hasElevatedBuckets=!0:p.hasNonElevatedBuckets=!0,p.hasElevatedBuckets&&p.hasNonElevatedBuckets))break}}}else p.hasNonElevatedBuckets=!0},model:function(p,o,c){const m=o.getSource();if(!m.loaded())return;if(m.type==="vector"||m.type==="geojson")return void(c.modelManager&&c.modelManager.upload(c,m.type==="vector"?p.scope:""));if(m.type==="batched-model"||m.type!=="model")return;const v=m.getModels();for(const b of v)b.upload(c.context)},raster:function(p,o,c){const m=o.getSource();if(!(m instanceof jr&&m.loaded()))return;const v=p.sourceLayer||m.rasterLayerIds&&m.rasterLayerIds[0];if(!v)return;const b=p.paint.get("raster-array-band")||m.getInitialBand(v);if(b==null)return;const A=o.getIds().map(M=>o.getTileByID(M));for(const M of A)M.updateNeeded(v,b)&&m.prepareTile(M,v,b)},"raster-particle":function(p,o,c){const m=o.getSource();if(!(m instanceof jr&&m.loaded()))return;const v=p.sourceLayer||m.rasterLayerIds&&m.rasterLayerIds[0];if(!v)return;const b=p.paint.get("raster-particle-array-band")||m.getInitialBand(v);if(b==null)return;const A=o.getIds().map(M=>o.getTileByID(M));for(const M of A)M.updateNeeded(v,b)&&m.prepareTile(M,v,b)}};class Hf{constructor(o,c,m,v,b){this.context=new Cf(o,c),this.transform=m,this._tileTextures={},this.frameCopies=[],this.loadTimeStamps=[],this.tp=b,this._timeStamp=s.q.now(),this._averageFPS=0,this._fpsHistory=[],this._dt=0,this._debugParams={forceEnablePrecipitation:!1,showTerrainProxyTiles:!1,fpsWindow:30,continousRedraw:!1,enabledLayers:{}};const A=["fill","line","symbol","circle","heatmap","fill-extrusion","raster","raster-particle","hillshade","model","background","sky"];for(const O of A)this._debugParams.enabledLayers[O]=!0;b.registerParameter(this._debugParams,["Terrain"],"showTerrainProxyTiles",{},()=>{this.style.map.triggerRepaint()}),b.registerParameter(this._debugParams,["Precipitation"],"forceEnablePrecipitation"),b.registerParameter(this._debugParams,["FPS"],"fpsWindow",{min:1,max:100,step:1}),b.registerBinding(this._debugParams,["FPS"],"continousRedraw",{readonly:!0,label:"continuous redraw"}),b.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"value"}),b.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"graph",view:"graph",min:0,max:200});for(const O of A)b.registerParameter(this._debugParams.enabledLayers,["Debug","Layers"],O);this.occlusionParams=new Ah(b),this.setup(),this.numSublayers=As.maxUnderzooming+As.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.deferredRenderGpuTimeQueries=[],this.gpuTimers={},this.frameCounter=0,this._backgroundTiles={},this.conflationActive=!1,this.replacementSource=new s.dv,this.longestCutoffRange=0,this.minCutoffZoom=0,this._fogVisible=!1,this._cachedTileFogOpacities={},this._shadowRenderer=new Ma(this),this._wireframeDebugCache=new kf,this.renderDefaultNorthPole=!0,this.renderDefaultSouthPole=!0,this.layersWithOcclusionOpacity=[];const M=new s.r({width:1,height:1},Uint8Array.of(0,0,0,0));this.emptyDepthTexture=new s.T(this.context,M,o.RGBA8),this._clippingActiveLastFrame=!1,this.scaleFactor=v}updateTerrain(o,c){const m=!!o&&!!o.terrain&&this.transform.projection.supportsTerrain;if(!(m||this._terrain&&this._terrain.enabled))return;this._terrain||(this._terrain=new bl(this,o));const v=this._terrain;this.transform.elevation=m?v:null,v.update(o,this.transform,c),this.transform.elevation&&!v.enabled&&(this.transform.elevation=null)}_updateFog(o){const c=o.fog;if(!c||this.transform.projection.name==="globe"||c.getOpacity(this.transform.pitch)<1||c.properties.get("horizon-blend")<.03)return void(this.transform.fogCullDistSq=null);const[m,v]=c.getFovAdjustedRange(this.transform._fov);if(m>v)return void(this.transform.fogCullDistSq=null);const b=m+.78*(v-m);this.transform.fogCullDistSq=b*b}get terrain(){return this.transform._terrainEnabled()&&this._terrain&&this._terrain.enabled||this._forceTerrainMode?this._terrain:null}get forceTerrainMode(){return this._forceTerrainMode}set forceTerrainMode(o){o&&!this._terrain&&(this._terrain=new bl(this,this.style)),this._forceTerrainMode=o}get shadowRenderer(){return this._shadowRenderer&&this._shadowRenderer.enabled?this._shadowRenderer:null}get wireframeDebugCache(){return this._wireframeDebugCache}resize(o,c){if(this.width=o*s.q.devicePixelRatio,this.height=c*s.q.devicePixelRatio,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const m of this.style.order)this.style._mergedLayers[m].resize()}setup(){const o=this.context,c=new s.b4;c.emplaceBack(0,0),c.emplaceBack(s.ag,0),c.emplaceBack(0,s.ag),c.emplaceBack(s.ag,s.ag),this.tileExtentBuffer=o.createVertexBuffer(c,s.b6.members),this.tileExtentSegments=s.b7.simpleSegment(0,0,4,2);const m=new s.b4;m.emplaceBack(0,0),m.emplaceBack(s.ag,0),m.emplaceBack(0,s.ag),m.emplaceBack(s.ag,s.ag),this.debugBuffer=o.createVertexBuffer(m,s.b6.members),this.debugSegments=s.b7.simpleSegment(0,0,4,5);const v=new s.b4;v.emplaceBack(-1,-1),v.emplaceBack(1,-1),v.emplaceBack(-1,1),v.emplaceBack(1,1),this.viewportBuffer=o.createVertexBuffer(v,s.b6.members),this.viewportSegments=s.b7.simpleSegment(0,0,4,2);const b=new s.aT;b.emplaceBack(0,0,0,0),b.emplaceBack(s.ag,0,s.ag,0),b.emplaceBack(0,s.ag,0,s.ag),b.emplaceBack(s.ag,s.ag,s.ag,s.ag),this.mercatorBoundsBuffer=o.createVertexBuffer(b,s.b9.members),this.mercatorBoundsSegments=s.b7.simpleSegment(0,0,4,2);const A=new s.aU;A.emplaceBack(0,1,2),A.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=o.createIndexBuffer(A);const M=new s.b5;for(const k of[0,1,3,2,0])M.emplaceBack(k);this.debugIndexBuffer=o.createIndexBuffer(M),this.emptyTexture=new s.T(o,new s.r({width:1,height:1},Uint8Array.of(0,0,0,0)),o.gl.RGBA8),this.identityMat=s.ab.mat4.create();const O=this.context.gl;this.stencilClearMode=new oi({func:O.ALWAYS,mask:0},0,255,O.ZERO,O.ZERO,O.ZERO),this.loadTimeStamps.push(performance.now())}getMercatorTileBoundsBuffers(){return{tileBoundsBuffer:this.mercatorBoundsBuffer,tileBoundsIndexBuffer:this.quadTriangleIndexBuffer,tileBoundsSegments:this.mercatorBoundsSegments}}getTileBoundsBuffers(o){return o._makeTileBoundsBuffers(this.context,this.transform.projection),o._tileBoundsBuffer?{tileBoundsBuffer:o._tileBoundsBuffer,tileBoundsIndexBuffer:o._tileBoundsIndexBuffer,tileBoundsSegments:o._tileBoundsSegments}:this.getMercatorTileBoundsBuffers()}clearStencil(){const o=this.context.gl;this.nextStencilID=1,this.currentStencilSource=void 0,this._tileClippingMaskIDs={},this.getOrCreateProgram("clippingMask").draw(this,o.TRIANGLES,Yt.disabled,this.stencilClearMode,xi.disabled,li.disabled,ch(this.identityMat),"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}resetStencilClippingMasks(){this.terrain||(this.currentStencilSource=void 0,this._tileClippingMaskIDs={})}_renderTileClippingMasks(o,c,m){if(!c||this.currentStencilSource===c.id||!o.isTileClipped()||!m||m.length===0)return;if(this._tileClippingMaskIDs&&!this.terrain){let M=!1;for(const O of m)if(this._tileClippingMaskIDs[O.key]===void 0){M=!0;break}if(!M)return}this.currentStencilSource=c.id;const v=this.context,b=v.gl;this.nextStencilID+m.length>256&&this.clearStencil(),v.setColorMode(xi.disabled),v.setDepthMode(Yt.disabled);const A=this.getOrCreateProgram("clippingMask");this._tileClippingMaskIDs={};for(const M of m){const O=c.getTile(M),k=this._tileClippingMaskIDs[M.key]=this.nextStencilID++,{tileBoundsBuffer:L,tileBoundsIndexBuffer:U,tileBoundsSegments:j}=this.getTileBoundsBuffers(O);A.draw(this,b.TRIANGLES,Yt.disabled,new oi({func:b.ALWAYS,mask:0},k,255,b.KEEP,b.KEEP,b.REPLACE),xi.disabled,li.disabled,ch(M.projMatrix),"$clipping",L,U,j)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const o=this.nextStencilID++,c=this.context.gl;return new oi({func:c.NOTEQUAL,mask:255},o,255,c.KEEP,c.KEEP,c.REPLACE)}stencilModeForClipping(o){if(this.terrain)return this.terrain.stencilModeForRTTOverlap(o);const c=this.context.gl;return new oi({func:c.EQUAL,mask:255},this._tileClippingMaskIDs[o.key],0,c.KEEP,c.KEEP,c.REPLACE)}stencilConfigForOverlap(o){const c=this.context.gl,m=o.sort((A,M)=>M.overscaledZ-A.overscaledZ),v=m[m.length-1].overscaledZ,b=m[0].overscaledZ-v+1;if(b>1){this.currentStencilSource=void 0,this.nextStencilID+b>256&&this.clearStencil();const A={};for(let M=0;M<b;M++)A[M+v]=new oi({func:c.GEQUAL,mask:255},M+this.nextStencilID,255,c.KEEP,c.KEEP,c.REPLACE);return this.nextStencilID+=b,[A,m]}return[{[v]:oi.disabled},m]}colorModeForRenderPass(){const o=this.context.gl;return this._showOverdrawInspector?new xi([o.CONSTANT_COLOR,o.ONE,o.CONSTANT_COLOR,o.ONE],new s.aj(.125,.125,.125,0),[!0,!0,!0,!0]):this.renderPass==="opaque"?xi.unblended:xi.alphaBlended}colorModeForDrapableLayerRenderPass(o){const c=this.context.gl;return this.style&&this.style.enable3dLights()&&this.terrain&&this.terrain.renderingToTexture&&this.renderPass==="translucent"?new xi([c.ONE,c.ONE_MINUS_SRC_ALPHA,c.CONSTANT_ALPHA,c.ONE_MINUS_SRC_ALPHA],new s.aj(0,0,0,o===void 0?0:o),[!0,!0,!0,!0]):this.colorModeForRenderPass()}depthModeForSublayer(o,c,m,v=!1){if(this.depthOcclusion)return new Yt(this.context.gl.GREATER,Yt.ReadOnly,this.depthRangeFor3D);if(!this.opaquePassEnabledForLayer()&&!v)return Yt.disabled;const b=1-((1+this.currentLayer)*this.numSublayers+o)*this.depthEpsilon;return new Yt(m||this.context.gl.LEQUAL,c,[b,b])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}blitDepth(){const o=this.context.gl,c=Math.ceil(this.width),m=Math.ceil(this.height),v=this.context.bindFramebuffer.get(),b=o.getParameter(o.TEXTURE_BINDING_2D);this.depthFBO&&this.depthFBO.width===c&&this.depthFBO.height===m||(this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),c!==0&&m!==0&&(this.depthFBO=new If(this.context,c,m,!1,"texture"),this.depthTexture=new s.T(this.context,{width:c,height:m,data:null},o.DEPTH24_STENCIL8),this.depthFBO.depthAttachment.set(this.depthTexture.texture))),this.context.bindFramebuffer.set(v),o.bindTexture(o.TEXTURE_2D,b),this.depthFBO&&(o.bindFramebuffer(o.READ_FRAMEBUFFER,null),o.bindFramebuffer(o.DRAW_FRAMEBUFFER,this.depthFBO.framebuffer),o.blitFramebuffer(0,0,c,m,0,0,c,m,o.DEPTH_BUFFER_BIT,o.NEAREST),o.bindFramebuffer(o.FRAMEBUFFER,this.context.bindFramebuffer.current))}updateAverageFPS(){this._fpsHistory.push(this._dt===0?0:1e3/this._dt),this._fpsHistory.length>this._debugParams.fpsWindow&&this._fpsHistory.splice(0,this._fpsHistory.length-this._debugParams.fpsWindow),this._averageFPS=Math.round(this._fpsHistory.reduce((o,c)=>o+c/this._fpsHistory.length,0))}render(o,c){const m=s.q.now();this._dt=m-this._timeStamp,this._timeStamp=m,this._wireframeDebugCache.update(this.frameCounter),this._debugParams.continousRedraw=o.map.repaint,this.style=o,this.options=c;const v=this.style._mergedLayers,b=!(!this.terrain||!this.terrain.enabled),A=()=>this.style._getOrder(b).filter(je=>{const et=v[je];return!(et.type in this._debugParams.enabledLayers)||this._debugParams.enabledLayers[et.type]});let M=A(),O=!1,k=!1;for(const je of M){const et=v[je];et.type==="circle"&&(O=!0),et.type==="symbol"&&(et.hasInitialOcclusionOpacityProperties?k=!0:O=!0)}let L=M.map(je=>v[je]);const U=this.style._mergedSourceCaches;this.imageManager=o.imageManager,this.modelManager=o.modelManager,this.symbolFadeChange=o.placement.symbolFadeChange(s.q.now()),this.imageManager.beginFrame();let j=0,$=!1;for(const je in U){const et=U[je];et.used&&(et.prepare(this.context),et.getSource().usedInConflation&&++j)}let Q=!1;for(const je of L)je.isHidden(this.transform.zoom)||(je.type==="clip"&&(Q=!0),this.prepareLayer(je));const Z={},te={},ee={},ae={},me={};for(const je in U){const et=U[je];Z[je]=et.getVisibleCoordinates(),te[je]=Z[je].slice().reverse(),ee[je]=et.getVisibleCoordinates(!0).reverse(),ae[je]=et.getShadowCasterCoordinates(),me[je]=et.sortCoordinatesByDistance(Z[je])}const fe=je=>{const et=this.style.getLayerSourceCache(je);return et&&et.used?et.getSource():null};if(j||Q||this._clippingActiveLastFrame){const je=[],et=[];let gt=0;for(const Ve of L)this.isSourceForClippingOrConflation(Ve,fe(Ve))&&(je.push(Ve),et.push(gt)),gt++;if(je&&(Q||je.length>1)||this._clippingActiveLastFrame){Q=!1;const Ve=[];for(let ut=0;ut<je.length;ut++){const tt=je[ut],Et=et[ut],ft=this.style.getLayerSourceCache(tt);if(!ft||!ft.used||!ft.getSource().usedInConflation&&tt.type!=="clip")continue;let ct=s.dx,xt=s.by.None;const Tt=[];let Lt=!0;if(tt.type==="clip"){ct=Et;for(const Ut of tt.layout.get("clip-layer-types"))xt|=Ut==="model"?s.by.Model:Ut==="symbol"?s.by.Symbol:s.by.FillExtrusion;for(const Ut of tt.layout.get("clip-layer-scope"))Tt.push(Ut);tt.isHidden(this.transform.zoom)?Lt=!1:Q=!0}Lt&&Ve.push({layer:tt.fqid,cache:ft,order:ct,clipMask:xt,clipScope:Tt})}this.replacementSource.setSources(Ve),$=!0}}this._clippingActiveLastFrame=Q,$||this.replacementSource.clear(),this.conflationActive=$,this.minCutoffZoom=0,this.longestCutoffRange=0,this.opaquePassCutoff=1/0,this._lastOcclusionLayer=-1,this.layersWithOcclusionOpacity=[];for(let je=0;je<L.length;je++){const et=L[je],gt=et.cutoffRange();if(this.longestCutoffRange=Math.max(gt,this.longestCutoffRange),gt>0){const Ve=fe(et);Ve&&(this.minCutoffZoom=Math.max(Ve.minzoom,this.minCutoffZoom)),et.minzoom&&(this.minCutoffZoom=Math.max(et.minzoom,this.minCutoffZoom))}et.is3D()&&(this.opaquePassCutoff===1/0&&(this.opaquePassCutoff=je),this._lastOcclusionLayer=je)}const Ae=this.style&&this.style.fog;Ae?(this._fogVisible=Ae.getOpacity(this.transform.pitch)!==0,this._fogVisible&&this.transform.projection.name!=="globe"&&(this._fogVisible=Ae.isVisibleOnFrustum(this.transform.cameraFrustum))):this._fogVisible=!1,this._cachedTileFogOpacities={},this.terrain&&(this.terrain.updateTileBinding(ee),this.opaquePassCutoff=0,M=A(),L=M.map(je=>v[je]));const ve=this._shadowRenderer;if(ve){ve.updateShadowParameters(this.transform,this.style.directionalLight);for(const je in U)for(const et of Z[je]){let gt={min:0,max:0};this.terrain&&(gt=this.terrain.getMinMaxForTile(et)||gt),ve.addShadowReceiver(et.toUnwrapped(),gt.min,gt.max)}}this.transform.projection.name!=="globe"||this.globeSharedBuffers||(this.globeSharedBuffers=new s.dw(this.context)),this.style.fog&&this.transform.projection.supportsFog?(this._atmosphere||(this._atmosphere=new m_(this)),this._atmosphere.update(this)):this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0);const be=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.snow),ye=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.rain);if(be&&!this._snow&&(this._snow=new jf(this)),!be&&this._snow&&(this._snow.destroy(),delete this._snow),ye&&!this._rain&&(this._rain=new Pl(this)),!ye&&this._rain&&(this._rain.destroy(),delete this._rain),this._snow&&this._snow.update(this),this._rain&&this._rain.update(this),!sr.has(this.context.gl))return;this.renderPass="offscreen";for(const je of L){const et=o.getLayerSourceCache(je);if(!je.hasOffscreenPass()||je.isHidden(this.transform.zoom))continue;const gt=et?te[et.id]:void 0;(je.type==="custom"||je.type==="raster"||je.type==="raster-particle"||je.isSky()||gt&&gt.length)&&this.renderLayer(this,et,je,gt)}this.depthRangeFor3D=[0,1-(L.length+2)*this.numSublayers*this.depthEpsilon],this._shadowRenderer&&(this.renderPass="shadow",this._shadowRenderer.drawShadowPass(this.style,ae)),this.context.bindFramebuffer.set(null),this.context.viewport.set([0,0,this.width,this.height]);const Ie=this.transform.projection.name==="globe"||this.transform.isHorizonVisible(),Fe=(()=>{if(c.showOverdrawInspector)return s.aj.black;const je=this.style.fog;if(je&&this.transform.projection.supportsFog){const et=this.style.getLut(je.scope);if(!Ie){const gt=je.properties.get("color-use-theme")==="none",Ve=je.properties.get("color").toRenderColor(gt?null:et).toArray01();return new s.aj(...Ve)}if(Ie){const gt=je.properties.get("space-color-use-theme")==="none",Ve=je.properties.get("space-color").toRenderColor(gt?null:et).toArray01();return new s.aj(...Ve)}}return s.aj.transparent})();if(this.context.clear({color:Fe,depth:1}),this.clearStencil(),this._showOverdrawInspector=c.showOverdrawInspector,this.renderPass="opaque",this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&Ie&&this._atmosphere.drawStars(this,this.style.fog),!this.terrain)for(this.currentLayer=M.length-1;this.currentLayer>=0;this.currentLayer--){const je=L[this.currentLayer],et=o.getLayerSourceCache(je);if(je.isSky())continue;const gt=et?(je.is3D()?me:te)[et.id]:void 0;this._renderTileClippingMasks(je,et,gt),this.renderLayer(this,et,je,gt)}if(this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&Ie&&this._atmosphere.drawAtmosphereGlow(this,this.style.fog),this.renderPass="sky",(!this._atmosphere||s.ae(this.transform.zoom)>0)&&(this.transform.projection.name==="globe"||this.transform.isHorizonVisible()))for(this.currentLayer=0;this.currentLayer<M.length;this.currentLayer++){const je=L[this.currentLayer],et=o.getLayerSourceCache(je);je.isSky()&&this.renderLayer(this,et,je,et?te[et.id]:void 0)}function Qe(je,et){let gt;return et&&(gt=(je.type==="symbol"?ee:je.is3D()?me:te)[et.id]),gt}if(this.renderPass="translucent",this.transform.projection.name==="globe"){for(this.renderElevatedRasterBackface=!0,this.currentLayer=0;this.currentLayer<M.length;){const je=L[this.currentLayer];if(je.type==="raster"||je.type==="raster-particle"){const et=o.getLayerSourceCache(je);this.renderLayer(this,et,je,Qe(je,et))}++this.currentLayer}this.renderElevatedRasterBackface=!1}this.currentLayer=0,this.firstLightBeamLayer=Number.MAX_SAFE_INTEGER;let We=0;ve&&(We=ve.getShadowCastingLayerCount());let at=!1,nt=-1;for(let je=0;je<M.length;++je){const et=L[je];et.isHidden(this.transform.zoom)||et.is3D()&&(nt=je)}for(k&&nt===-1&&(O=!0);this.currentLayer<M.length;){const je=L[this.currentLayer],et=o.getLayerSourceCache(je);if(je.isSky())++this.currentLayer;else if(this.terrain&&this.style.isLayerDraped(je)){if(je.isHidden(this.transform.zoom)){++this.currentLayer;continue}this.currentLayer=this.terrain.renderBatch(this.currentLayer),this._lastOcclusionLayer=Math.max(this.currentLayer,this._lastOcclusionLayer)}else{if(O&&!at&&this.terrain&&!this.transform.isOrthographic&&(at=!0,this.blitDepth()),k&&nt!==-1&&this.currentLayer===nt+1&&!this.transform.isOrthographic&&this.blitDepth(),je.is3D()||this.terrain||this._renderTileClippingMasks(je,et,et?Z[et.id]:void 0),this.renderLayer(this,et,je,Qe(je,et)),!this.terrain&&ve&&We>0&&je.hasShadowPass()&&--We==0&&(ve.drawGroundShadows(),this.firstLightBeamLayer<=this.currentLayer)){const gt=this.currentLayer;for(this.renderPass="light-beam",this.currentLayer=this.firstLightBeamLayer;this.currentLayer<=gt;this.currentLayer++){const Ve=L[this.currentLayer];if(!Ve.hasLightBeamPass())continue;const ut=o.getLayerSourceCache(Ve);this.renderLayer(this,ut,Ve,ut?te[ut.id]:void 0)}this.currentLayer=gt,this.renderPass="translucent"}if(this.currentLayer>=this._lastOcclusionLayer&&this.layersWithOcclusionOpacity.length>0){const gt=this.currentLayer;this.depthOcclusion=!0;for(const Ve of this.layersWithOcclusionOpacity){this.currentLayer=Ve;const ut=L[this.currentLayer],tt=o.getLayerSourceCache(ut),Et=tt?te[tt.id]:void 0;ut.is3D()||this.terrain||this._renderTileClippingMasks(ut,tt,tt?Z[tt.id]:void 0),this.renderLayer(this,tt,ut,Et)}this.depthOcclusion=!1,this.currentLayer=gt,this.renderPass="translucent",this.layersWithOcclusionOpacity=[]}++this.currentLayer}}if(this.terrain&&this.terrain.postRender(),this._snow&&this._snow.draw(this),this._rain&&this._rain.draw(this),this.options.showTileBoundaries||this.options.showQueryGeometry||this.options.showTileAABBs){let je=null;L.forEach(et=>{const gt=o.getLayerSourceCache(et);gt&&!et.isHidden(this.transform.zoom)&&gt.getVisibleCoordinates().length&&(!je||je.getSource().maxzoom<gt.getSource().maxzoom)&&(je=gt)}),je&&this.options.showTileBoundaries&&$c.debug(this,je,je.getVisibleCoordinates(),s.aj.red,!1,this.options.showParseStatus)}this.terrain&&this._debugParams.showTerrainProxyTiles&&$c.debug(this,this.terrain.proxySourceCache,this.terrain.proxyCoords,new s.aj(1,.8,.1,1),!0,this.options.showParseStatus),this.options.showPadding&&function(je){const et=je.transform.padding;Pf(je,je.transform.height-(et.top||0),3,Ml),Pf(je,et.bottom||0,3,K0),Bf(je,et.left||0,3,J0),Bf(je,je.transform.width-(et.right||0),3,f_);const gt=je.transform.centerPoint;(function(Ve,ut,tt,Et){za(Ve,ut-1,tt-10,2,20,Et),za(Ve,ut-10,tt-1,20,2,Et)})(je,gt.x,je.transform.height-gt.y,vh)}(this),this.context.setDefault(),this.frameCounter=(this.frameCounter+1)%Number.MAX_SAFE_INTEGER,this.tileLoaded&&this.options.speedIndexTiming&&(this.loadTimeStamps.push(performance.now()),this.saveCanvasCopy()),$||(this.conflationActive=!1)}prepareLayer(o){this.gpuTimingStart(o);const{unsupportedLayers:c}=this.transform.projection,m=!c||!c.includes(o.type);if(Wc[o.type]&&(m||this.terrain&&o.type==="custom")){const v=this.style.getLayerSourceCache(o);Wc[o.type](o,v,this)}this.gpuTimingEnd()}renderLayer(o,c,m,v){m.isHidden(this.transform.zoom)||(m.type==="background"||m.type==="sky"||m.type==="custom"||m.type==="model"||m.type==="raster"||m.type==="raster-particle"||v&&v.length)&&(this.id=m.id,this.gpuTimingStart(m),o.transform.projection.unsupportedLayers&&o.transform.projection.unsupportedLayers.includes(m.type)&&(!o.terrain||m.type!=="custom")||m.type==="clip"||$c[m.type](o,c,m,v,this.style.placement.variableOffsets,this.options.isInitialLoad),this.gpuTimingEnd())}gpuTimingStart(o){if(!this.options.gpuTiming)return;const c=this.context.extTimerQuery,m=this.context.gl;let v=this.gpuTimers[o.id];v||(v=this.gpuTimers[o.id]={calls:0,cpuTime:0,query:m.createQuery()}),v.calls++,m.beginQuery(c.TIME_ELAPSED_EXT,v.query)}gpuTimingDeferredRenderStart(){if(this.options.gpuTimingDeferredRender){const o=this.context.extTimerQuery,c=this.context.gl,m=c.createQuery();this.deferredRenderGpuTimeQueries.push(m),c.beginQuery(o.TIME_ELAPSED_EXT,m)}}gpuTimingDeferredRenderEnd(){this.options.gpuTimingDeferredRender&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}gpuTimingEnd(){this.options.gpuTiming&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}collectGpuTimers(){const o=this.gpuTimers;return this.gpuTimers={},o}collectDeferredRenderGpuQueries(){const o=this.deferredRenderGpuTimeQueries;return this.deferredRenderGpuTimeQueries=[],o}queryGpuTimers(o){const c={};for(const m in o){const v=o[m],b=this.context.extTimerQuery,A=b.getQueryParameter(v.query,this.context.gl.QUERY_RESULT)/1e6;b.deleteQueryEXT(v.query),c[m]=A}return c}queryGpuTimeDeferredRender(o){if(!this.options.gpuTimingDeferredRender)return 0;const c=this.context.gl;let m=0;for(const v of o)m+=c.getQueryParameter(v,c.QUERY_RESULT)/1e6,c.deleteQuery(v);return m}translatePosMatrix(o,c,m,v,b){if(!m[0]&&!m[1])return o;const A=b?v==="map"?this.transform.angle:0:v==="viewport"?-this.transform.angle:0;if(A){const k=Math.sin(A),L=Math.cos(A);m=[m[0]*L-m[1]*k,m[0]*k+m[1]*L]}const M=[b?m[0]:s.ar(c,m[0],this.transform.zoom),b?m[1]:s.ar(c,m[1],this.transform.zoom),0],O=new Float32Array(16);return s.ab.mat4.translate(O,o,M),O}saveTileTexture(o){const c=o.size[0],m=this._tileTextures[c];m?m.push(o):this._tileTextures[c]=[o]}getTileTexture(o){const c=this._tileTextures[o];return c&&c.length>0?c.pop():null}terrainRenderModeElevated(){return this.style&&!!this.style.getTerrain()&&!!this.terrain&&!this.terrain.renderingToTexture||this.forceTerrainMode}linearFloatFilteringSupported(){return this.context.extTextureFloatLinear!=null}currentGlobalDefines(o,c,m){const v=m===void 0?this.terrain&&this.terrain.renderingToTexture:m,b=[];return this.style&&this.style.enable3dLights()&&(o==="globeRaster"||o==="terrainRaster"?(b.push("LIGHTING_3D_MODE"),b.push("LIGHTING_3D_ALPHA_EMISSIVENESS")):v||b.push("LIGHTING_3D_MODE")),this.renderPass==="shadow"&&(this._shadowMapDebug||b.push("DEPTH_TEXTURE")),this.terrainRenderModeElevated()&&(b.push("TERRAIN"),this.linearFloatFilteringSupported()&&b.push("TERRAIN_DEM_FLOAT_FORMAT")),this.transform.projection.name==="globe"&&b.push("GLOBE"),!this._fogVisible||v||c!==void 0&&!c||b.push("FOG","FOG_DITHERING"),v&&b.push("RENDER_TO_TEXTURE"),this._showOverdrawInspector&&b.push("OVERDRAW_INSPECTOR"),b}getOrCreateProgram(o,c){this.cache=this.cache||{};const m=c&&c.defines||[],v=c&&c.config,b=this.currentGlobalDefines(o,c&&c.overrideFog,c&&c.overrideRtt).concat(m),A=s_.cacheKey(gl[o],o,b,v);return this.cache[A]||(this.cache[A]=new s_(this.context,o,gl[o],v,Sf[o],b)),this.cache[A]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.frontFace.setDefault(),this.context.cullFaceSide.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const o=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(o.FUNC_ADD)}initDebugOverlayCanvas(){this.debugOverlayCanvas==null&&(this.debugOverlayCanvas=document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new s.T(this.context,this.debugOverlayCanvas,this.context.gl.RGBA8))}destroy(){this._terrain&&this._terrain.destroy(),this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0),this.globeSharedBuffers&&this.globeSharedBuffers.destroy(),this.emptyTexture.destroy(),this.debugOverlayTexture&&this.debugOverlayTexture.destroy(),this._wireframeDebugCache.destroy(),this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),this.emptyDepthTexture&&this.emptyDepthTexture.destroy()}prepareDrawTile(){this.terrain&&this.terrain.prepareDrawTile()}uploadCommonLightUniforms(o,c){if(this.style.enable3dLights()){const m=this.style.directionalLight,v=this.style.ambientLight;if(m&&v){const b=((A,M,O)=>{const k=A.properties.get("direction"),L=A.properties.get("color-use-theme")==="none",U=A.properties.get("color").toRenderColor(L?null:O.getLut(A.scope)).toArray01(),j=A.properties.get("intensity"),$=M.properties.get("color-use-theme")==="none",Q=M.properties.get("color").toRenderColor($?null:O.getLut(M.scope)).toArray01(),Z=M.properties.get("intensity"),te=[k.x,k.y,k.z],ee=s.cM(Q,Z),ae=s.cM(U,j);return{u_lighting_ambient_color:ee,u_lighting_directional_dir:te,u_lighting_directional_color:ae,u_ground_radiance:W0(te,ae,ee)}})(m,v,this.style);c.setLightsUniformValues(o,b)}}}uploadCommonUniforms(o,c,m,v,b){if(this.uploadCommonLightUniforms(o,c),this.terrain&&this.terrain.renderingToTexture)return;const A=this.style.fog;if(A){const M=A.getOpacity(this.transform.pitch),O=((k,L,U,j,$,Q,Z,te,ee,ae,me,fe)=>{const Ae=k.transform,ve=L.properties.get("color-use-theme")==="none",be=L.properties.get("color").toRenderColor(ve?null:k.style.getLut(L.scope)).toArray01();be[3]=j;const ye=k.frameCounter/1e3%1,[Ie,Fe]=L.properties.get("vertical-range");return{u_fog_matrix:U?Ae.calculateFogTileMatrix(U):fe||k.identityMat,u_fog_range:L.getFovAdjustedRange(Ae._fov),u_fog_color:be,u_fog_horizon_blend:L.properties.get("horizon-blend"),u_fog_vertical_limit:[Math.min(Ie,Fe),Fe],u_fog_temporal_offset:ye,u_frustum_tl:$,u_frustum_tr:Q,u_frustum_br:Z,u_frustum_bl:te,u_globe_pos:ee,u_globe_radius:ae,u_viewport:me,u_globe_transition:s.ae(Ae.zoom),u_is_globe:+(Ae.projection.name==="globe")}})(this,A,m,M,this.transform.frustumCorners.TL,this.transform.frustumCorners.TR,this.transform.frustumCorners.BR,this.transform.frustumCorners.BL,this.transform.globeCenterInViewSpace,this.transform.globeRadius,[this.transform.width*s.q.devicePixelRatio,this.transform.height*s.q.devicePixelRatio],v);c.setFogUniformValues(o,O)}b&&c.setCutoffUniformValues(o,b.uniformValues)}setTileLoadedFlag(o){this.tileLoaded=o}saveCanvasCopy(){const o=this.canvasCopy();o&&(this.frameCopies.push(o),this.tileLoaded=!1)}canvasCopy(){const o=this.context.gl,c=o.createTexture();return o.bindTexture(o.TEXTURE_2D,c),o.copyTexImage2D(o.TEXTURE_2D,0,o.RGBA,0,0,o.drawingBufferWidth,o.drawingBufferHeight,0),c}getCanvasCopiesAndTimestamps(){return{canvasCopies:this.frameCopies,timeStamps:this.loadTimeStamps}}averageElevationNeedsEasing(){if(!this.transform._elevation)return!1;const o=this.style&&this.style.fog;return!!o&&o.getOpacity(this.transform.pitch)!==0}getBackgroundTiles(){const o=this._backgroundTiles,c=this._backgroundTiles={},m=this.transform.coveringTiles({tileSize:512});for(const v of m)c[v.key]=o[v.key]||new Jo(v,512,this.transform.tileZoom,this);return c}clearBackgroundTiles(){this._backgroundTiles={}}isSourceForClippingOrConflation(o,c){return!(!o.is3D()||o.type!=="clip"&&(o.minzoom&&o.minzoom>this.transform.zoom||(this.style._clipLayerPresent||o.sourceLayer!=="building")&&(!c||c.type!=="batched-model")))}isTileAffectedByFog(o){if(!this.style||!this.style.fog)return!1;if(this.transform.projection.name==="globe")return!0;let c=this._cachedTileFogOpacities[o.key];return c||(this._cachedTileFogOpacities[o.key]=c=this.style.fog.getOpacityForTile(o)),c[0]>=Ee||c[1]>=Ee}setupDepthForOcclusion(o,c,m){const v=this.context,b=v.gl,A=!!m;var M;m||(m={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0}),v.activeTexture.set(b.TEXTURE3),o&&this.depthFBO&&this.depthTexture?(this.depthTexture.bind(b.NEAREST,b.CLAMP_TO_EDGE),m.u_depth_size_inv=[1/this.depthFBO.width,1/this.depthFBO.height],m.u_depth_range_unpack=[2/((M=this.depthRangeFor3D)[1]-M[0]),-1-2*M[0]/(M[1]-M[0])],m.u_occluder_half_size=.5*this.occlusionParams.occluderSize,m.u_occlusion_depth_offset=this.occlusionParams.depthOffset):this.emptyDepthTexture.bind(b.NEAREST,b.CLAMP_TO_EDGE),v.activeTexture.set(b.TEXTURE0),A||c.setTerrainUniformValues(v,m)}}function Sh(p,o){let c=!1,m=null;const v=()=>{m=null,c&&(p(),m=setTimeout(v,o),c=!1)};return()=>(c=!0,m||v(),m)}class __{constructor(o){this._hashName=o&&encodeURIComponent(o),s.aP(["_getCurrentHash","_onHashChange","_updateHash"],this),this._updateHash=Sh(this._updateHashUnthrottled.bind(this),300)}addTo(o){return this._map=o,window.addEventListener("hashchange",this._onHashChange,!1),o.on("moveend",this._updateHash),this}remove(){return this._map?(this._map.off("moveend",this._updateHash),window.removeEventListener("hashchange",this._onHashChange,!1),clearTimeout(this._updateHash()),this._map=void 0,this):this}getHashString(){const o=this._map;if(!o)return"";const c=Gf(o);if(this._hashName){const m=this._hashName;let v=!1;const b=location.hash.slice(1).split("&").map(A=>{const M=A.split("=")[0];return M===m?(v=!0,`${M}=${c}`):A}).filter(A=>A);return v||b.push(`${m}=${c}`),`#${b.join("&")}`}return`#${c}`}_getCurrentHash(){const o=location.hash.replace("#","");if(this._hashName){let c;return o.split("&").map(m=>m.split("=")).forEach(m=>{m[0]===this._hashName&&(c=m)}),(c&&c[1]||"").split("/")}return o.split("/")}_onHashChange(){const o=this._map;if(!o)return!1;const c=this._getCurrentHash();if(c.length>=3&&!c.some(m=>isNaN(m))){const m=o.dragRotate.isEnabled()&&o.touchZoomRotate.isEnabled()?+(c[3]||0):o.getBearing();return o.jumpTo({center:[+c[2],+c[1]],zoom:+c[0],bearing:m,pitch:+(c[4]||0)}),!0}return!1}_updateHashUnthrottled(){history.replaceState(history.state,"",location.href.replace(/(#.+)?$/,this.getHashString()))}}function Gf(p,o){const c=p.getCenter(),m=Math.round(100*p.getZoom())/100,v=Math.ceil((m*Math.LN2+Math.log(512/360/.5))/Math.LN10),b=Math.pow(10,v),A=Math.round(c.lng*b)/b,M=Math.round(c.lat*b)/b,O=p.getBearing(),k=p.getPitch();let L=o?`/${A}/${M}/${m}`:`${m}/${M}/${A}`;return(O||k)&&(L+="/"+Math.round(10*O)/10),k&&(L+=`/${Math.round(k)}`),L}const qc={linearity:.3,easing:s.dy(0,0,.3,1)},g_=s.l({deceleration:2500,maxSpeed:1400},qc),y_=s.l({deceleration:20,maxSpeed:1400},qc),v_=s.l({deceleration:1e3,maxSpeed:360},qc),x_=s.l({deceleration:1e3,maxSpeed:90},qc);class b_{constructor(o){this._map=o,this.clear()}clear(){this._inertiaBuffer=[]}record(o){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:s.q.now(),settings:o})}_drainInertiaBuffer(){const o=this._inertiaBuffer,c=s.q.now();for(;o.length>0&&c-o[0].time>160;)o.shift()}_onMoveEnd(o){if(this._map._prefersReducedMotion()||(this._drainInertiaBuffer(),this._inertiaBuffer.length<2))return;const c={zoom:0,bearing:0,pitch:0,pan:new s.P(0,0),pinchAround:void 0,around:void 0};for(const{settings:b}of this._inertiaBuffer)c.zoom+=b.zoomDelta||0,c.bearing+=b.bearingDelta||0,c.pitch+=b.pitchDelta||0,b.panDelta&&c.pan._add(b.panDelta),b.around&&(c.around=b.around),b.pinchAround&&(c.pinchAround=b.pinchAround);const m=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,v={};if(c.pan.mag()){const b=Zc(c.pan.mag(),m,s.l({},g_,o||{}));v.offset=c.pan.mult(b.amount/c.pan.mag()),v.center=this._map.transform.center,Xc(v,b)}if(c.zoom){const b=Zc(c.zoom,m,y_);v.zoom=this._map.transform.zoom+b.amount,Xc(v,b)}if(c.bearing){const b=Zc(c.bearing,m,v_);v.bearing=this._map.transform.bearing+s.aw(b.amount,-179,179),Xc(v,b)}if(c.pitch){const b=Zc(c.pitch,m,x_);v.pitch=this._map.transform.pitch+b.amount,Xc(v,b)}if(v.zoom||v.bearing){const b=c.pinchAround===void 0?c.around:c.pinchAround;v.around=b?this._map.unproject(b):this._map.getCenter()}return this.clear(),v.noMoveStart=!0,v}}function Xc(p,o){(!p.duration||p.duration<o.duration)&&(p.duration=o.duration,p.easing=o.easing)}function Zc(p,o,c){const{maxSpeed:m,linearity:v,deceleration:b}=c,A=s.aw(p*v/(o/1e3),-m,m),M=Math.abs(A)/(b*v);return{easing:c.easing,duration:1e3*M,amount:A*(M/2)}}class Qn extends s.z{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(o,c,m,v={}){const b=St(c.getCanvasContainer(),m),A=c.unproject(b);super(o,s.l({point:b,lngLat:A,originalEvent:m},v)),this._defaultPrevented=!1,this.target=c}}class Yc extends s.z{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(o,c,m){const v=o==="touchend"?m.changedTouches:m.touches,b=Pt(c.getCanvasContainer(),v),A=b.map(O=>c.unproject(O)),M=b.reduce((O,k,L,U)=>O.add(k.div(U.length)),new s.P(0,0));super(o,{points:b,point:M,lngLats:A,lngLat:c.unproject(M),originalEvent:m}),this._defaultPrevented=!1}}class w_ extends s.z{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(o,c){super("wheel",{originalEvent:c}),this._defaultPrevented=!1}}class ev{constructor(o,c){this._map=o,this._clickTolerance=c.clickTolerance}reset(){this._mousedownPos=void 0}wheel(o){return this._firePreventable(new w_(this._map,o))}mousedown(o,c){return this._mousedownPos=c,this._firePreventable(new Qn(o.type,this._map,o))}mouseup(o){this._map.fire(new Qn(o.type,this._map,o))}preclick(o){const c=s.l({},o);c.type="preclick",this._map.fire(new Qn(c.type,this._map,c))}click(o,c){this._mousedownPos&&this._mousedownPos.dist(c)>=this._clickTolerance||(this.preclick(o),this._map.fire(new Qn(o.type,this._map,o)))}dblclick(o){return this._firePreventable(new Qn(o.type,this._map,o))}mouseover(o){this._map.fire(new Qn(o.type,this._map,o))}mouseout(o){this._map.fire(new Qn(o.type,this._map,o))}touchstart(o){return this._firePreventable(new Yc(o.type,this._map,o))}touchmove(o){this._map.fire(new Yc(o.type,this._map,o))}touchend(o){this._map.fire(new Yc(o.type,this._map,o))}touchcancel(o){this._map.fire(new Yc(o.type,this._map,o))}_firePreventable(o){if(this._map.fire(o),o.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class tv{constructor(o){this._map=o}reset(){this._delayContextMenu=!1,this._contextMenuEvent=void 0}mousemove(o){this._map.fire(new Qn(o.type,this._map,o))}mousedown(){this._delayContextMenu=!0}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new Qn("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(o){this._delayContextMenu?this._contextMenuEvent=o:this._map.fire(new Qn(o.type,this._map,o)),this._map.listens("contextmenu")&&o.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class Ar{constructor(o,c){this._map=o,this._el=o.getCanvasContainer(),this._container=o.getContainer(),this._clickTolerance=c.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(o,c){this.isEnabled()&&o.shiftKey&&o.button===0&&(ge(),this._startPos=this._lastPos=c,this._active=!0)}mousemoveWindow(o,c){if(!this._active)return;const m=c,v=this._startPos,b=this._lastPos;if(!v||!b||b.equals(m)||!this._box&&m.dist(v)<this._clickTolerance)return;this._lastPos=m,this._box||(this._box=K("div","mapboxgl-boxzoom",this._container),this._container.classList.add("mapboxgl-crosshair"),this._fireEvent("boxzoomstart",o));const A=Math.min(v.x,m.x),M=Math.max(v.x,m.x),O=Math.min(v.y,m.y),k=Math.max(v.y,m.y);this._map._requestDomTask(()=>{this._box&&(this._box.style.transform=`translate(${A}px,${O}px)`,this._box.style.width=M-A+"px",this._box.style.height=k-O+"px")})}mouseupWindow(o,c){if(!this._active)return;const m=this._startPos,v=c;if(m&&o.button===0){if(this.reset(),Ye(),m.x!==v.x||m.y!==v.y)return this._map.fire(new s.z("boxzoomend",{originalEvent:o})),{cameraAnimation:b=>b.fitScreenCoordinates(m,v,this._map.getBearing(),{linear:!1})};this._fireEvent("boxzoomcancel",o)}}keydown(o){this._active&&o.keyCode===27&&(this.reset(),this._fireEvent("boxzoomcancel",o))}blur(){this.reset()}reset(){this._active=!1,this._container.classList.remove("mapboxgl-crosshair"),this._box&&(this._box.remove(),this._box=null),Le(),delete this._startPos,delete this._lastPos}_fireEvent(o,c){return this._map.fire(new s.z(o,{originalEvent:c}))}}function Ih(p,o){const c={};for(let m=0;m<p.length;m++)c[p[m].identifier]=o[m];return c}class iv{constructor(o){this.reset(),this.numTouches=o.numTouches}reset(){this.centroid=void 0,this.startTime=0,this.touches={},this.aborted=!1}touchstart(o,c,m){(this.centroid||m.length>this.numTouches)&&(this.aborted=!0),this.aborted||(this.startTime===0&&(this.startTime=o.timeStamp),m.length===this.numTouches&&(this.centroid=function(v){const b=new s.P(0,0);for(const A of v)b._add(A);return b.div(v.length)}(c),this.touches=Ih(m,c)))}touchmove(o,c,m){if(this.aborted||!this.centroid)return;const v=Ih(m,c);for(const b in this.touches){const A=v[b];(!A||A.dist(this.touches[b])>30)&&(this.aborted=!0)}}touchend(o,c,m){if((!this.centroid||o.timeStamp-this.startTime>500)&&(this.aborted=!0),m.length===0){const v=!this.aborted&&this.centroid;if(this.reset(),v)return v}}}class $f{constructor(o){this.singleTap=new iv(o),this.numTaps=o.numTaps,this.reset()}reset(){this.lastTime=1/0,this.lastTap=void 0,this.count=0,this.singleTap.reset()}touchstart(o,c,m){this.singleTap.touchstart(o,c,m)}touchmove(o,c,m){this.singleTap.touchmove(o,c,m)}touchend(o,c,m){const v=this.singleTap.touchend(o,c,m);if(v){const b=o.timeStamp-this.lastTime<500,A=!this.lastTap||this.lastTap.dist(v)<30;if(b&&A||this.reset(),this.count++,this.lastTime=o.timeStamp,this.lastTap=v,this.count===this.numTaps)return this.reset(),v}}}class Kc{constructor(){this._zoomIn=new $f({numTouches:1,numTaps:2}),this._zoomOut=new $f({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(o,c,m){this._zoomIn.touchstart(o,c,m),this._zoomOut.touchstart(o,c,m)}touchmove(o,c,m){this._zoomIn.touchmove(o,c,m),this._zoomOut.touchmove(o,c,m)}touchend(o,c,m){const v=this._zoomIn.touchend(o,c,m),b=this._zoomOut.touchend(o,c,m);return v?(this._active=!0,o.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:A=>A.easeTo({duration:300,zoom:A.getZoom()+1,around:A.unproject(v)},{originalEvent:o})}):b?(this._active=!0,o.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:A=>A.easeTo({duration:300,zoom:A.getZoom()-1,around:A.unproject(b)},{originalEvent:o})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}const A_={0:1,2:2};class Jc{constructor(o){this.reset(),this._clickTolerance=o.clickTolerance||1}blur(){this.reset()}reset(){this._active=!1,this._moved=!1,this._lastPoint=void 0,this._eventButton=void 0}_correctButton(o,c){return!1}_move(o,c){return{}}mousedown(o,c){if(this._lastPoint)return;const m=vt(o);this._correctButton(o,m)&&(this._lastPoint=c,this._eventButton=m)}mousemoveWindow(o,c){const m=this._lastPoint;if(m){if(o.preventDefault(),this._eventButton!=null&&function(v,b){const A=A_[b];return v.buttons===void 0||(v.buttons&A)!==A}(o,this._eventButton))this.reset();else if(this._moved||!(c.dist(m)<this._clickTolerance))return this._moved=!0,this._lastPoint=c,this._move(m,c)}}mouseupWindow(o){this._lastPoint&&vt(o)===this._eventButton&&(this._moved&&Ye(),this.reset())}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Ch extends Jc{mousedown(o,c){super.mousedown(o,c),this._lastPoint&&(this._active=!0)}_correctButton(o,c){return c===0&&!o.ctrlKey}_move(o,c){return{around:c,panDelta:c.sub(o)}}}class no extends Jc{_correctButton(o,c){return c===0&&o.ctrlKey||c===2}_move(o,c){const m=.8*(c.x-o.x);if(m)return this._active=!0,{bearingDelta:m}}contextmenu(o){o.preventDefault()}}class Qc extends Jc{_correctButton(o,c){return c===0&&o.ctrlKey||c===2}_move(o,c){const m=-.5*(c.y-o.y);if(m)return this._active=!0,{pitchDelta:m}}contextmenu(o){o.preventDefault()}}class Sr{constructor(o,c){this._map=o,this._el=o.getCanvasContainer(),this._minTouches=1,this._clickTolerance=c.clickTolerance||1,this.reset(),s.aP(["_addTouchPanBlocker","_showTouchPanBlockerAlert"],this)}reset(){this._active=!1,this._touches={},this._sum=new s.P(0,0)}touchstart(o,c,m){return this._calculateTransform(o,c,m)}touchmove(o,c,m){if(this._active&&!(m.length<this._minTouches)){if(this._map._cooperativeGestures&&!this._map.isMoving()){if(m.length===1&&!s.dz())return void this._showTouchPanBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}return o.cancelable&&o.preventDefault(),this._calculateTransform(o,c,m)}}touchend(o,c,m){this._calculateTransform(o,c,m),this._active&&m.length<this._minTouches&&this.reset()}touchcancel(){this.reset()}_calculateTransform(o,c,m){m.length>0&&(this._active=!0);const v=Ih(m,c),b=new s.P(0,0),A=new s.P(0,0);let M=0;for(const k in v){const L=v[k],U=this._touches[k];U&&(b._add(L),A._add(L.sub(U)),M++,v[k]=L)}if(this._touches=v,M<this._minTouches||!A.mag())return;const O=A.div(M);return this._sum._add(O),this._sum.mag()<this._clickTolerance?void 0:{around:b.div(M),panDelta:O}}enable(){this._enabled=!0,this._map._cooperativeGestures&&(this._addTouchPanBlocker(),this._el.classList.add("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page"))}disable(){this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove(),this._el.classList.remove("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page")),this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}_addTouchPanBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=K("div","mapboxgl-touch-pan-blocker",this._map._container),this._alertContainer.textContent=this._map._getUIString("TouchPanBlocker.Message"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showTouchPanBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-touch-pan-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-touch-pan-blocker-show"),this._alertContainer.removeAttribute("role")},500)}}class Ss{constructor(){this.reset()}reset(){this._active=!1,this._firstTwoTouches=void 0}_start(o){}_move(o,c,m){return{}}touchstart(o,c,m){this._firstTwoTouches||m.length<2||(this._firstTwoTouches=[m[0].identifier,m[1].identifier],this._start([c[0],c[1]]))}touchmove(o,c,m){const v=this._firstTwoTouches;if(!v)return;o.preventDefault();const[b,A]=v,M=Bl(m,c,b),O=Bl(m,c,A);if(!M||!O)return;const k=this._aroundCenter?null:M.add(O).div(2);return this._move([M,O],k,o)}touchend(o,c,m){if(!this._firstTwoTouches)return;const[v,b]=this._firstTwoTouches,A=Bl(m,c,v),M=Bl(m,c,b);A&&M||(this._active&&Ye(),this.reset())}touchcancel(){this.reset()}enable(o){this._enabled=!0,this._aroundCenter=!!o&&o.around==="center"}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}function Bl(p,o,c){for(let m=0;m<p.length;m++)if(p[m].identifier===c)return o[m]}function eu(p,o){return Math.log(p/o)/Math.LN2}class T_ extends Ss{reset(){super.reset(),this._distance=0,this._startDistance=0}_start(o){this._startDistance=this._distance=o[0].dist(o[1])}_move(o,c){const m=this._distance;if(this._distance=o[0].dist(o[1]),this._active||!(Math.abs(eu(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:eu(this._distance,m),pinchAround:c}}}function E_(p,o){return 180*p.angleWith(o)/Math.PI}class tu extends Ss{reset(){super.reset(),this._minDiameter=0,this._startVector=void 0,this._vector=void 0}_start(o){this._startVector=this._vector=o[0].sub(o[1]),this._minDiameter=o[0].dist(o[1])}_move(o,c){const m=this._vector;if(this._vector=o[0].sub(o[1]),m&&(this._active||!this._isBelowThreshold(this._vector)))return this._active=!0,{bearingDelta:E_(this._vector,m),pinchAround:c}}_isBelowThreshold(o){this._minDiameter=Math.min(this._minDiameter,o.mag());const c=25/(Math.PI*this._minDiameter)*360,m=this._startVector;if(!m)return!1;const v=E_(o,m);return Math.abs(v)<c}}function Wf(p){return Math.abs(p.y)>Math.abs(p.x)}class rv extends Ss{constructor(o){super(),this._map=o}reset(){super.reset(),this._valid=void 0,this._firstMove=void 0,this._lastPoints=void 0}_start(o){this._lastPoints=o,Wf(o[0].sub(o[1]))&&(this._valid=!1)}_move(o,c,m){const v=this._lastPoints;if(!v)return;const b=o[0].sub(v[0]),A=o[1].sub(v[1]);return this._map._cooperativeGestures&&!s.dz()&&m.touches.length<3||(this._valid=this.gestureBeginsVertically(b,A,m.timeStamp),!this._valid)?void 0:(this._lastPoints=o,this._active=!0,{pitchDelta:(b.y+A.y)/2*-.5})}gestureBeginsVertically(o,c,m){if(this._valid!==void 0)return this._valid;const v=o.mag()>=2,b=c.mag()>=2;if(!v&&!b)return;if(!v||!b)return this._firstMove==null&&(this._firstMove=m),m-this._firstMove<100&&void 0;const A=o.y>0==c.y>0;return Wf(o)&&Wf(c)&&A}}const qf={panStep:100,bearingStep:15,pitchStep:10};class Xf{constructor(){const o=qf;this._panStep=o.panStep,this._bearingStep=o.bearingStep,this._pitchStep=o.pitchStep,this._rotationDisabled=!1}blur(){this.reset()}reset(){this._active=!1}keydown(o){if(o.altKey||o.ctrlKey||o.metaKey)return;let c=0,m=0,v=0,b=0,A=0;switch(o.keyCode){case 61:case 107:case 171:case 187:c=1;break;case 189:case 109:case 173:c=-1;break;case 37:o.shiftKey?m=-1:(o.preventDefault(),b=-1);break;case 39:o.shiftKey?m=1:(o.preventDefault(),b=1);break;case 38:o.shiftKey?v=1:(o.preventDefault(),A=-1);break;case 40:o.shiftKey?v=-1:(o.preventDefault(),A=1);break;default:return}return this._rotationDisabled&&(m=0,v=0),{cameraAnimation:M=>{const O=M.getZoom();M.easeTo({duration:300,easeId:"keyboardHandler",easing:Va,zoom:c?Math.round(O)+c*(o.shiftKey?2:1):O,bearing:M.getBearing()+m*this._bearingStep,pitch:M.getPitch()+v*this._pitchStep,offset:[-b*this._panStep,-A*this._panStep],center:M.getCenter()},{originalEvent:o})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function Va(p){return p*(2-p)}const ja=4.000244140625,Fo=1/450;class Fs{constructor(o,c){this._map=o,this._el=o.getCanvasContainer(),this._handler=c,this._delta=0,this._lastDelta=0,this._defaultZoomRate=.01,this._wheelZoomRate=Fo,s.aP(["_onTimeout","_addScrollZoomBlocker","_showBlockerAlert"],this)}setZoomRate(o){this._defaultZoomRate=o}setWheelZoomRate(o){this._wheelZoomRate=o}isEnabled(){return!!this._enabled}isActive(){return this._active||this._finishTimeout!==void 0}isZooming(){return!!this._zooming}enable(o){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!o&&o.around==="center",this._map._cooperativeGestures&&this._addScrollZoomBlocker())}disable(){this.isEnabled()&&(this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove()))}wheel(o){if(!this.isEnabled())return;if(this._map._cooperativeGestures){if(!(o.ctrlKey||o.metaKey||this.isZooming()||s.dz()))return void this._showBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}let c=o.deltaMode===WheelEvent.DOM_DELTA_LINE?40*o.deltaY:o.deltaY;const m=s.q.now(),v=m-(this._lastWheelEventTime||0);this._lastWheelEventTime=m,c!==0&&c%ja==0?this._type="wheel":c!==0&&Math.abs(c)<4?this._type="trackpad":v>400?(this._type=null,this._lastValue=c,this._timeout=window.setTimeout(this._onTimeout,40,o)):this._type||(this._type=Math.abs(v*c)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,c+=this._lastValue)),o.shiftKey&&c&&(c/=4),this._type&&(this._lastWheelEvent=o,this._delta-=c,this._active||this._start(o)),o.preventDefault()}_onTimeout(o){this._type="wheel",this._delta-=this._lastValue,this._active||this._start(o)}_start(o){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const c=St(this._el,o);this._aroundPoint=this._aroundCenter?this._map.transform.centerPoint:c,this._aroundCoord=this._map.transform.pointCoordinate3D(this._aroundPoint),this._targetZoom=void 0,this._frameId||(this._frameId=!0,this._handler._triggerRenderFrame())}renderFrame(){if(!this._frameId||(this._frameId=null,!this.isActive()))return;const o=this._map.transform;this._type==="wheel"&&o.projection.wrap&&(o._center.lng>=180||o._center.lng<=-180)&&(this._prevEase=null,this._easing=null,this._lastWheelEvent=null,this._lastWheelEventTime=0);const c=()=>o._terrainEnabled()&&this._aroundCoord?o.computeZoomRelativeTo(this._aroundCoord):o.zoom;if(this._delta!==0){const k=this._type==="wheel"&&Math.abs(this._delta)>ja?this._wheelZoomRate:this._defaultZoomRate;let L=2/(1+Math.exp(-Math.abs(this._delta*k)));this._delta<0&&L!==0&&(L=1/L);const U=c(),j=Math.pow(2,U),$=typeof this._targetZoom=="number"?o.zoomScale(this._targetZoom):j;this._targetZoom=Math.min(o.maxZoom,Math.max(o.minZoom,o.scaleZoom($*L))),this._type==="wheel"&&(this._startZoom=U,this._easing=this._smoothOutEasing(200)),this._lastDelta=this._delta,this._delta=0}const m=typeof this._targetZoom=="number"?this._targetZoom:c(),v=this._startZoom,b=this._easing;let A,M=!1;if(this._type==="wheel"&&v&&b){const k=Math.min((s.q.now()-this._lastWheelEventTime)/200,1),L=b(k);A=s.af(v,m,L),k<1?this._frameId||(this._frameId=!0):M=!0}else A=m,M=!0;this._active=!0,M&&(this._active=!1,this._finishTimeout=window.setTimeout(()=>{this._zooming=!1,this._handler._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout},200));let O=A-c();return O*this._lastDelta<0&&(O=0),{noInertia:!0,needsRenderFrame:!M,zoomDelta:O,around:this._aroundPoint,aroundCoord:this._aroundCoord,originalEvent:this._lastWheelEvent}}_smoothOutEasing(o){let c=s.dA;if(this._prevEase){const m=this._prevEase,v=(s.q.now()-m.start)/m.duration,b=m.easing(v+.01)-m.easing(v),A=.27/Math.sqrt(b*b+1e-4)*.01,M=Math.sqrt(.0729-A*A);c=s.dy(A,M,.25,1)}return this._prevEase={start:s.q.now(),duration:o,easing:c},c}blur(){this.reset()}reset(){this._active=!1}_addScrollZoomBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=K("div","mapboxgl-scroll-zoom-blocker",this._map._container),this._alertContainer.textContent=/(Mac|iPad)/i.test(navigator.userAgent)?this._map._getUIString("ScrollZoomBlocker.CmdMessage"):this._map._getUIString("ScrollZoomBlocker.CtrlMessage"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.removeAttribute("role")},200)}}class ca{constructor(o,c){this._clickZoom=o,this._tapZoom=c}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class Ha{constructor(){this.reset()}reset(){this._active=!1}blur(){this.reset()}dblclick(o,c){return o.preventDefault(),{cameraAnimation:m=>{m.easeTo({duration:300,zoom:m.getZoom()+(o.shiftKey?-1:1),around:m.unproject(c)},{originalEvent:o})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class ua{constructor(){this._tap=new $f({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,this._swipePoint=void 0,this._swipeTouch=0,this._tapTime=0,this._tap.reset()}touchstart(o,c,m){this._swipePoint||(this._tapTime&&o.timeStamp-this._tapTime>500&&this.reset(),this._tapTime?m.length>0&&(this._swipePoint=c[0],this._swipeTouch=m[0].identifier):this._tap.touchstart(o,c,m))}touchmove(o,c,m){if(this._tapTime){if(this._swipePoint){if(m[0].identifier!==this._swipeTouch)return;const v=c[0],b=v.y-this._swipePoint.y;return this._swipePoint=v,o.preventDefault(),this._active=!0,{zoomDelta:b/128}}}else this._tap.touchmove(o,c,m)}touchend(o,c,m){this._tapTime?this._swipePoint&&m.length===0&&this.reset():this._tap.touchend(o,c,m)&&(this._tapTime=o.timeStamp)}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class nv{constructor(o,c,m){this._el=o,this._mousePan=c,this._touchPan=m}enable(o){this._inertiaOptions=o||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("mapboxgl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("mapboxgl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class sv{constructor(o,c,m){this._pitchWithRotate=o.pitchWithRotate,this._mouseRotate=c,this._mousePitch=m}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class ov{constructor(o,c,m,v){this._el=o,this._touchZoom=c,this._touchRotate=m,this._tapDragZoom=v,this._rotationDisabled=!1,this._enabled=!0}enable(o){this._touchZoom.enable(o),this._rotationDisabled||this._touchRotate.enable(o),this._tapDragZoom.enable(),this._el.classList.add("mapboxgl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("mapboxgl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}const Mh=p=>p.zoom||p.drag||p.pitch||p.rotate;class S_ extends s.z{}class Bn{constructor(){this.constants=[1,1,.01],this.radius=0}setup(o,c){const m=s.ab.vec3.sub([],c,o);this.radius=s.ab.vec3.length(m[2]<0?s.ab.vec3.div([],m,this.constants):[m[0],m[1],0])}projectRay(o){s.ab.vec3.div(o,o,this.constants),s.ab.vec3.normalize(o,o),s.ab.vec3.mul(o,o,this.constants);const c=s.ab.vec3.scale([],o,this.radius);if(c[2]>0){const m=s.ab.vec3.scale([],[0,0,1],s.ab.vec3.dot(c,[0,0,1])),v=s.ab.vec3.scale([],s.ab.vec3.normalize([],[c[0],c[1],0]),this.radius),b=s.ab.vec3.add([],c,s.ab.vec3.scale([],s.ab.vec3.sub([],s.ab.vec3.add([],v,m),c),2));c[0]=b[0],c[1]=b[1]}return c}}function Dl(p){return p.panDelta&&p.panDelta.mag()||p.zoomDelta||p.bearingDelta||p.pitchDelta}class I_{constructor(o,c){this._map=o,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new b_(o),this._bearingSnap=c.bearingSnap,this._previousActiveHandlers={},this._trackingEllipsoid=new Bn,this._dragOrigin=null,this._eventsInProgress={},this._addDefaultHandlers(c),s.aP(["handleEvent","handleWindowEvent"],this);const m=this._el;this._listeners=[[m,"touchstart",{passive:!0}],[m,"touchmove",{passive:!1}],[m,"touchend",void 0],[m,"touchcancel",void 0],[m,"mousedown",void 0],[m,"mousemove",void 0],[m,"mouseup",void 0],[document,"mousemove",{capture:!0}],[document,"mouseup",void 0],[m,"mouseover",void 0],[m,"mouseout",void 0],[m,"dblclick",void 0],[m,"click",void 0],[m,"keydown",{capture:!1}],[m,"keyup",void 0],[m,"wheel",{passive:!1}],[m,"contextmenu",void 0],[window,"blur",void 0]];for(const[v,b,A]of this._listeners){const M=v===document?this.handleWindowEvent:this.handleEvent;v.addEventListener(b,M,A)}}destroy(){for(const[o,c,m]of this._listeners){const v=o===document?this.handleWindowEvent:this.handleEvent;o.removeEventListener(c,v,m)}}_addDefaultHandlers(o){const c=this._map,m=c.getCanvasContainer();this._add("mapEvent",new ev(c,o));const v=c.boxZoom=new Ar(c,o);this._add("boxZoom",v);const b=new Kc,A=new Ha;c.doubleClickZoom=new ca(A,b),this._add("tapZoom",b),this._add("clickZoom",A);const M=new ua;this._add("tapDragZoom",M);const O=c.touchPitch=new rv(c);this._add("touchPitch",O);const k=new no(o),L=new Qc(o);c.dragRotate=new sv(o,k,L),this._add("mouseRotate",k,["mousePitch"]),this._add("mousePitch",L,["mouseRotate"]);const U=new Ch(o),j=new Sr(c,o);c.dragPan=new nv(m,U,j),this._add("mousePan",U),this._add("touchPan",j,["touchZoom","touchRotate"]);const $=new tu,Q=new T_;c.touchZoomRotate=new ov(m,Q,$,M),this._add("touchRotate",$,["touchPan","touchZoom"]),this._add("touchZoom",Q,["touchPan","touchRotate"]),this._add("blockableMapEvent",new tv(c));const Z=c.scrollZoom=new Fs(c,this);this._add("scrollZoom",Z,["mousePan"]);const te=c.keyboard=new Xf;this._add("keyboard",te);for(const ee of["boxZoom","doubleClickZoom","tapDragZoom","touchPitch","dragRotate","dragPan","touchZoomRotate","scrollZoom","keyboard"])o.interactive&&o[ee]&&c[ee].enable(o[ee])}_add(o,c,m){this._handlers.push({handlerName:o,handler:c,allowed:m}),this._handlersById[o]=c}stop(o){if(!this._updatingCamera){for(const{handler:c}of this._handlers)c.reset();this._inertia.clear(),this._fireEvents({},{},o),this._changes=[],this._originalZoom=void 0}}isActive(){for(const{handler:o}of this._handlers)if(o.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!Mh(this._eventsInProgress)||this.isZooming()}_isDragging(){return!!this._eventsInProgress.drag}_blockedByActive(o,c,m){for(const v in o)if(v!==m&&(!c||c.indexOf(v)<0))return!0;return!1}handleWindowEvent(o){this.handleEvent(o,`${o.type}Window`)}_getMapTouches(o){const c=[];for(const m of o)this._el.contains(m.target)&&c.push(m);return c}handleEvent(o,c){this._updatingCamera=!0;const m=o.type==="renderFrame",v=m?void 0:o,b={needsRenderFrame:!1},A={},M={},O=o.touches?this._getMapTouches(o.touches):void 0,k=O?Pt(this._el,O):m?void 0:St(this._el,o);for(const{handlerName:j,handler:$,allowed:Q}of this._handlers){if(!$.isEnabled())continue;let Z;this._blockedByActive(M,Q,j)?$.reset():$[c||o.type]&&(Z=$[c||o.type](o,k,O),this.mergeHandlerResult(b,A,Z,j,v),Z&&Z.needsRenderFrame&&this._triggerRenderFrame()),(Z||$.isActive())&&(M[j]=$)}const L={};for(const j in this._previousActiveHandlers)M[j]||(L[j]=v);this._previousActiveHandlers=M,(Object.keys(L).length||Dl(b))&&(this._changes.push([b,A,L]),this._triggerRenderFrame()),(Object.keys(M).length||Dl(b))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:U}=b;U&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],U(this._map))}mergeHandlerResult(o,c,m,v,b){if(!m)return;s.l(o,m);const A={handlerName:v,originalEvent:m.originalEvent||b};m.zoomDelta!==void 0&&(c.zoom=A),m.panDelta!==void 0&&(c.drag=A),m.pitchDelta!==void 0&&(c.pitch=A),m.bearingDelta!==void 0&&(c.rotate=A)}_applyChanges(){const o={},c={},m={};for(const[v,b,A]of this._changes)v.panDelta&&(o.panDelta=(o.panDelta||new s.P(0,0))._add(v.panDelta)),v.zoomDelta&&(o.zoomDelta=(o.zoomDelta||0)+v.zoomDelta),v.bearingDelta&&(o.bearingDelta=(o.bearingDelta||0)+v.bearingDelta),v.pitchDelta&&(o.pitchDelta=(o.pitchDelta||0)+v.pitchDelta),v.around!==void 0&&(o.around=v.around),v.aroundCoord!==void 0&&(o.aroundCoord=v.aroundCoord),v.pinchAround!==void 0&&(o.pinchAround=v.pinchAround),v.noInertia&&(o.noInertia=v.noInertia),s.l(c,b),s.l(m,A);this._updateMapTransform(o,c,m),this._changes=[]}_updateMapTransform(o,c,m){const v=this._map,b=v.transform,A=ae=>[ae.x,ae.y,ae.z];if((ae=>{const me=this._eventsInProgress.drag;return me&&!this._handlersById[me.handlerName].isActive()})()&&!Dl(o)){const ae=b.zoom;b.cameraElevationReference="sea",this._originalZoom!=null&&b._orthographicProjectionAtLowPitch&&b.projection.name!=="globe"&&b.pitch===0?(b.cameraElevationReference="ground",b.zoom=this._originalZoom):(b.recenterOnTerrain(),b.cameraElevationReference="ground"),ae!==b.zoom&&this._map._update(!0)}if(b._isCameraConstrained&&v._stop(!0),!Dl(o))return void this._fireEvents(c,m,!0);let{panDelta:M,zoomDelta:O,bearingDelta:k,pitchDelta:L,around:U,aroundCoord:j,pinchAround:$}=o;b._isCameraConstrained&&(O>0&&(O=0),b._isCameraConstrained=!1),$!==void 0&&(U=$),(O||(ae=>c[ae]&&!this._eventsInProgress[ae])("drag"))&&U&&(this._dragOrigin=A(b.pointCoordinate3D(U)),this._originalZoom=b.zoom,this._trackingEllipsoid.setup(b._camera.position,this._dragOrigin)),b.cameraElevationReference="sea",v._stop(!0),U=U||v.transform.centerPoint,k&&(b.bearing+=k),L&&(b.pitch+=L),b._updateCameraState();const Q=[0,0,0];if(M)if(b.projection.name==="mercator"){const ae=this._trackingEllipsoid.projectRay(b.screenPointToMercatorRay(U).dir),me=this._trackingEllipsoid.projectRay(b.screenPointToMercatorRay(U.sub(M)).dir);Q[0]=me[0]-ae[0],Q[1]=me[1]-ae[1]}else{const ae=b.pointCoordinate(U);if(b.projection.name==="globe"){M=M.rotate(-b.angle);const me=b._pixelsPerMercatorPixel/b.worldSize;Q[0]=-M.x*s.dB(s.aS(ae.y))*me,Q[1]=-M.y*s.dB(b.center.lat)*me}else{const me=b.pointCoordinate(U.sub(M));ae&&me&&(Q[0]=me.x-ae.x,Q[1]=me.y-ae.y)}}const Z=b.zoom,te=[0,0,0];if(O){const ae=A(j||b.pointCoordinate3D(U)),me={dir:s.ab.vec3.normalize([],s.ab.vec3.sub([],ae,b._camera.position))};if(me.dir[2]<0){const fe=b.zoomDeltaToMovement(ae,O);s.ab.vec3.scale(te,me.dir,fe)}}const ee=s.ab.vec3.add(Q,Q,te);b._translateCameraConstrained(ee),O&&Math.abs(b.zoom-Z)>1e-4&&b.recenterOnTerrain(),b.cameraElevationReference="ground",this._map._update(),o.noInertia||this._inertia.record(o),this._fireEvents(c,m,!0)}_fireEvents(o,c,m){const v=Mh(this._eventsInProgress),b=Mh(o),A={};for(const L in o){const{originalEvent:U}=o[L];this._eventsInProgress[L]||(A[`${L}start`]=U),this._eventsInProgress[L]=o[L]}!v&&b&&this._fireEvent("movestart",b.originalEvent);for(const L in A)this._fireEvent(L,A[L]);b&&this._fireEvent("move",b.originalEvent);for(const L in o){const{originalEvent:U}=o[L];this._fireEvent(L,U)}const M={};let O;for(const L in this._eventsInProgress){const{handlerName:U,originalEvent:j}=this._eventsInProgress[L];this._handlersById[U].isActive()||(delete this._eventsInProgress[L],O=c[U]||j,M[`${L}end`]=O)}for(const L in M)this._fireEvent(L,M[L]);const k=Mh(this._eventsInProgress);if(m&&(v||b)&&!k){this._updatingCamera=!0;const L=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),U=j=>j!==0&&-this._bearingSnap<j&&j<this._bearingSnap;L?(U(L.bearing||this._map.getBearing())&&(L.bearing=0),this._map.easeTo(L,{originalEvent:O})):(this._map.fire(new s.z("moveend",{originalEvent:O})),U(this._map.getBearing())&&this._map.resetNorth()),this._updatingCamera=!1}}_fireEvent(o,c){this._map.fire(new s.z(o,c?{originalEvent:c}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add(o=>{this._frameId=void 0,this.handleEvent(new S_("renderFrame",{timeStamp:o})),this._applyChanges()})}_triggerRenderFrame(){this._frameId===void 0&&(this._frameId=this._requestFrame())}}const C_="map.setFreeCameraOptions(...) and map.getFreeCameraOptions() are not yet supported for non-mercator projections.";class Ol extends s.E{constructor(o,c){super(),this._moving=!1,this._zooming=!1,this.transform=o,this._bearingSnap=c.bearingSnap,this._respectPrefersReducedMotion=c.respectPrefersReducedMotion!==!1,s.aP(["_renderFrameCallback"],this)}getCenter(){return new s.bO(this.transform.center.lng,this.transform.center.lat)}setCenter(o,c){return this.jumpTo({center:o},c)}panBy(o,c,m){return o=s.P.convert(o).mult(-1),this.panTo(this.transform.center,s.l({offset:o},c),m)}panTo(o,c,m){return this.easeTo(s.l({center:o},c),m)}getZoom(){return this.transform.zoom}setZoom(o,c){return this.jumpTo({zoom:o},c),this}zoomTo(o,c,m){return this.easeTo(s.l({zoom:o},c),m)}zoomIn(o,c){return this.zoomTo(this.getZoom()+1,o,c),this}zoomOut(o,c){return this.zoomTo(this.getZoom()-1,o,c),this}getBearing(){return this.transform.bearing}setBearing(o,c){return this.jumpTo({bearing:o},c),this}getPadding(){return this.transform.padding}setPadding(o,c){return this.jumpTo({padding:o},c),this}rotateTo(o,c,m){return this.easeTo(s.l({bearing:o},c),m)}resetNorth(o,c){return this.rotateTo(0,s.l({duration:1e3},o),c),this}resetNorthPitch(o,c){return this.easeTo(s.l({bearing:0,pitch:0,duration:1e3},o),c),this}snapToNorth(o,c){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(o,c):this}getPitch(){return this.transform.pitch}setPitch(o,c){return this.jumpTo({pitch:o},c),this}cameraForBounds(o,c){o=s.az.convert(o);const m=c&&c.bearing||0,v=c&&c.pitch||0,b=o.getNorthWest(),A=o.getSouthEast();return this._cameraForBounds(this.transform,b,A,m,v,c)}_extendPadding(o){const c={top:0,right:0,bottom:0,left:0};return o==null?s.l({},c,this.transform.padding):typeof o=="number"?{top:o,bottom:o,right:o,left:o}:s.l({},c,o)}_extendCameraOptions(o){return(o=s.l({offset:[0,0],maxZoom:this.transform.maxZoom},o)).padding=this._extendPadding(o.padding),o}_minimumAABBFrustumDistance(o,c){const m=c.max[0]-c.min[0],v=c.max[1]-c.min[1];return m/v>o.aspect?m/(2*Math.tan(.5*o.fovX)*o.aspect):v/(2*Math.tan(.5*o.fovY)*o.aspect)}_cameraForBoundsOnGlobe(o,c,m,v,b,A){const M=o.clone(),O=this._extendCameraOptions(A);M.bearing=v,M.pitch=b;const k=s.bO.convert(c),L=s.bO.convert(m),U=.5*(k.lat+L.lat),j=.5*(k.lng+L.lng),$=s.dC(U,j),Q=s.ab.vec3.normalize([],$),Z=s.ab.vec3.normalize([],s.ab.vec3.cross([],Q,[0,1,0])),te=s.ab.vec3.cross([],Z,Q),ee=[Z[0],Z[1],Z[2],0,te[0],te[1],te[2],0,Q[0],Q[1],Q[2],0,0,0,0,1],ae=[$,s.dC(k.lat,k.lng),s.dC(L.lat,k.lng),s.dC(L.lat,L.lng),s.dC(k.lat,L.lng),s.dC(U,k.lng),s.dC(U,L.lng),s.dC(k.lat,j),s.dC(L.lat,j)];let me=s.cd.fromPoints(ae.map(tt=>[s.ab.vec3.dot(Z,tt),s.ab.vec3.dot(te,tt),s.ab.vec3.dot(Q,tt)]));const fe=s.ab.vec3.transformMat4([],me.center,ee);s.ab.vec3.squaredLength(fe)===0&&s.ab.vec3.set(fe,0,0,1),s.ab.vec3.normalize(fe,fe),s.ab.vec3.scale(fe,fe,s.ax),M.center=s.dD(fe);const Ae=M.getWorldToCameraMatrix(),ve=s.ab.mat4.invert(new Float64Array(16),Ae);me=s.cd.applyTransform(me,s.ab.mat4.multiply([],Ae,ee));const be=this._extendAABB(me,M,O,v);if(!be)return void s.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");me=be,s.ab.vec3.transformMat4(fe,fe,Ae);const ye=.5*(me.max[2]-me.min[2]),Ie=this._minimumAABBFrustumDistance(M,me),Fe=s.ab.vec3.scale([],[0,0,1],ye),Qe=s.ab.vec3.add(Fe,fe,Fe),We=Ie+(M.pitch===0?0:s.ab.vec3.distance(fe,Qe)),at=M.globeCenterInViewSpace,nt=s.ab.vec3.sub([],fe,[at[0],at[1],at[2]]);s.ab.vec3.normalize(nt,nt),s.ab.vec3.scale(nt,nt,We);const je=s.ab.vec3.add([],fe,nt);s.ab.vec3.transformMat4(je,je,ve);const et=s.ds/s.ax,gt=s.ab.vec3.length(je),Ve=s.bH(Math.max(gt*et-s.ds,Number.EPSILON),0),ut=Math.min(M.zoomFromMercatorZAdjusted(Ve),O.maxZoom);return ut>.5*(s.c6+s.bY)?(M.setProjection({name:"mercator"}),M.zoom=ut,this._cameraForBounds(M,c,m,v,b,A)):{center:M.center,zoom:ut,bearing:v,pitch:b}}_extendAABB(o,c,m,v){const b=.5*((m.padding.left||0)+(m.padding.right||0)),A=.5*((m.padding.top||0)+(m.padding.bottom||0)),M=A,O=b,k=b,L=A,U=c.width-(O+k),j=c.height-(M+L),$=s.ab.vec3.sub([],o.max,o.min),Q=Math.min(U/$[0],j/$[1]),Z=Math.min(c.scaleZoom(c.scale*Q),m.maxZoom);if(isNaN(Z))return null;const te=c.scale/c.zoomScale(Z),ee=new s.cd([o.min[0]-O*te,o.min[1]-L*te,o.min[2]],[o.max[0]+k*te,o.max[1]+M*te,o.max[2]]),ae=(typeof m.offset.x=="number"&&typeof m.offset.y=="number"?new s.P(m.offset.x,m.offset.y):s.P.convert(m.offset)).rotate(-s.ai(v));return ee.center[0]-=ae.x*te,ee.center[1]+=ae.y*te,ee}queryTerrainElevation(o,c){const m=this.transform.elevation;return m?(c=s.l({},{exaggerated:!0},c),m.getAtPoint(s.aa.fromLngLat(o),null,c.exaggerated)):null}_cameraForBounds(o,c,m,v,b,A){if(o.projection.name==="globe")return this._cameraForBoundsOnGlobe(o,c,m,v,b,A);const M=o.clone(),O=this._extendCameraOptions(A);M.bearing=v,M.pitch=b;const k=s.bO.convert(c),L=s.bO.convert(m),U=new s.bO(k.lng,L.lat),j=new s.bO(L.lng,k.lat),$=M.project(k),Q=M.project(L),Z=this.queryTerrainElevation(k),te=this.queryTerrainElevation(L),ee=this.queryTerrainElevation(U),ae=this.queryTerrainElevation(j),me=[[$.x,$.y,Math.min(Z||0,te||0,ee||0,ae||0)],[Q.x,Q.y,Math.max(Z||0,te||0,ee||0,ae||0)]];let fe=s.cd.fromPoints(me);const Ae=M.getWorldToCameraMatrix(),ve=s.ab.mat4.invert(new Float64Array(16),Ae);fe=s.cd.applyTransform(fe,Ae);const be=this._extendAABB(fe,M,O,v);if(!be)return void s.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");fe=be;const ye=.5*s.ab.vec3.sub([],fe.max,fe.min)[2],Ie=this._minimumAABBFrustumDistance(M,fe),Fe=[0,0,1,0];s.ab.vec4.transformMat4(Fe,Fe,Ae),s.ab.vec4.normalize(Fe,Fe);const Qe=s.ab.vec3.scale([],Fe,Ie+ye),We=s.ab.vec3.add([],fe.center,Qe);s.ab.vec3.transformMat4(fe.center,fe.center,ve),s.ab.vec3.transformMat4(We,We,ve);const at=M.unproject(new s.P(fe.center[0],fe.center[1])),nt=s.dE(M.projection,at),je=Math.pow(2,nt),et=Math.min(M._zoomFromMercatorZ(We[2]*M.pixelsPerMeter*je/M.worldSize),O.maxZoom);return M.mercatorFromTransition&&et<.5*(s.c6+s.bY)?(M.setProjection({name:"globe"}),M.zoom=et,this._cameraForBounds(M,c,m,v,b,A)):{center:at,zoom:et,bearing:v,pitch:b}}fitBounds(o,c,m){const v=this.cameraForBounds(o,c);return this._fitInternal(v,c,m)}fitScreenCoordinates(o,c,m,v,b){const A=s.P.convert(o),M=s.P.convert(c),O=new s.P(Math.min(A.x,M.x),Math.min(A.y,M.y)),k=new s.P(Math.max(A.x,M.x),Math.max(A.y,M.y));if(this.transform.projection.name==="mercator"&&this.transform.anyCornerOffEdge(A,M))return this;const L=this.transform.pointLocation3D(O),U=this.transform.pointLocation3D(k),j=this.transform.pointLocation3D(new s.P(O.x,k.y)),$=this.transform.pointLocation3D(new s.P(k.x,O.y)),Q=[Math.min(L.lng,U.lng,j.lng,$.lng),Math.min(L.lat,U.lat,j.lat,$.lat)],Z=[Math.max(L.lng,U.lng,j.lng,$.lng),Math.max(L.lat,U.lat,j.lat,$.lat)],te=v&&v.pitch?v.pitch:this.getPitch(),ee=this._cameraForBounds(this.transform,Q,Z,m,te,v);return this._fitInternal(ee,v,b)}_fitInternal(o,c,m){return o?(c=s.l(o,c)).linear?this.easeTo(c,m):this.flyTo(c,m):this}jumpTo(o,c){this.stop();const m=o.preloadOnly?this.transform.clone():this.transform;let v=!1,b=!1,A=!1;"zoom"in o&&m.zoom!==+o.zoom&&(v=!0,m.zoom=+o.zoom),o.center!==void 0&&(m.center=s.bO.convert(o.center)),"bearing"in o&&m.bearing!==+o.bearing&&(b=!0,m.bearing=+o.bearing),"pitch"in o&&m.pitch!==+o.pitch&&(A=!0,m.pitch=+o.pitch);const M=typeof o.padding=="number"?this._extendPadding(o.padding):o.padding;if(o.padding!=null&&!m.isPaddingEqual(M))if(o.retainPadding===!1){const O=m.clone();O.padding=M,m.setLocationAtPoint(m.center,O.centerPoint)}else m.padding=M;return o.preloadOnly?(this._preloadTiles(m),this):(this.fire(new s.z("movestart",c)).fire(new s.z("move",c)),v&&this.fire(new s.z("zoomstart",c)).fire(new s.z("zoom",c)).fire(new s.z("zoomend",c)),b&&this.fire(new s.z("rotatestart",c)).fire(new s.z("rotate",c)).fire(new s.z("rotateend",c)),A&&this.fire(new s.z("pitchstart",c)).fire(new s.z("pitch",c)).fire(new s.z("pitchend",c)),this.fire(new s.z("moveend",c)))}getFreeCameraOptions(){return this.transform.projection.supportsFreeCamera||s.w(C_),this.transform.getFreeCameraOptions()}setFreeCameraOptions(o,c){const m=this.transform;if(!m.projection.supportsFreeCamera)return s.w(C_),this;this.stop();const v=m.zoom,b=m.pitch,A=m.bearing;m.setFreeCameraOptions(o);const M=v!==m.zoom,O=b!==m.pitch,k=A!==m.bearing;return this.fire(new s.z("movestart",c)).fire(new s.z("move",c)),M&&this.fire(new s.z("zoomstart",c)).fire(new s.z("zoom",c)).fire(new s.z("zoomend",c)),k&&this.fire(new s.z("rotatestart",c)).fire(new s.z("rotate",c)).fire(new s.z("rotateend",c)),O&&this.fire(new s.z("pitchstart",c)).fire(new s.z("pitch",c)).fire(new s.z("pitchend",c)),this.fire(new s.z("moveend",c)),this}easeTo(o,c){this._stop(!1,o.easeId),((o=s.l({offset:[0,0],duration:500,easing:s.dA},o)).animate===!1||this._prefersReducedMotion(o))&&(o.duration=0);const m=this.transform,v=this.getZoom(),b=this.getBearing(),A=this.getPitch(),M=this.getPadding(),O="zoom"in o?+o.zoom:v,k="bearing"in o?this._normalizeBearing(o.bearing,b):b,L="pitch"in o?+o.pitch:A,U=this._extendPadding(o.padding),j=s.P.convert(o.offset);let $,Q,Z;if(m.projection.name==="globe"){const Fe=s.aa.fromLngLat(m.center),Qe=j.rotate(-m.angle);Fe.x+=Qe.x/m.worldSize,Fe.y+=Qe.y/m.worldSize;const We=Fe.toLngLat(),at=s.bO.convert(o.center||We);this._normalizeCenter(at),$=m.centerPoint.add(Qe),Q=new s.P(Fe.x,Fe.y).mult(m.worldSize),Z=new s.P(s.at(at.lng),s.aA(at.lat)).mult(m.worldSize).sub(Q)}else{$=m.centerPoint.add(j);const Fe=m.pointLocation($),Qe=s.bO.convert(o.center||Fe);this._normalizeCenter(Qe),Q=m.project(Fe),Z=m.project(Qe).sub(Q)}const te=m.zoomScale(O-v);let ee,ae;o.around&&(ee=s.bO.convert(o.around),ae=m.locationPoint(ee));const me=this._zooming||O!==v,fe=this._rotating||b!==k,Ae=this._pitching||L!==A,ve=!m.isPaddingEqual(U),be=o.retainPadding===!1?m.clone():m,ye=Fe=>Qe=>{if(me&&(Fe.zoom=s.af(v,O,Qe)),fe&&(Fe.bearing=s.af(b,k,Qe)),Ae&&(Fe.pitch=s.af(A,L,Qe)),ve&&(be.interpolatePadding(M,U,Qe),$=be.centerPoint.add(j)),ee)Fe.setLocationAtPoint(ee,ae);else{const We=Fe.zoomScale(Fe.zoom-v),at=O>v?Math.min(2,te):Math.max(.5,te),nt=Math.pow(at,1-Qe),je=Fe.unproject(Q.add(Z.mult(Qe*nt)).mult(We));Fe.setLocationAtPoint(Fe.renderWorldCopies?je.wrap():je,$)}return o.preloadOnly||this._fireMoveEvents(c),Fe};if(o.preloadOnly){const Fe=this._emulate(ye,o.duration,m);return this._preloadTiles(Fe),this}const Ie={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=me,this._rotating=fe,this._pitching=Ae,this._padding=ve,this._easeId=o.easeId,this._prepareEase(c,o.noMoveStart,Ie),this._ease(ye(m),Fe=>{m.cameraElevationReference==="sea"&&m.recenterOnTerrain(),this._afterEase(c,Fe)},o),this}_prepareEase(o,c,m={}){this._moving=!0,this.transform.cameraElevationReference="sea",this.transform._orthographicProjectionAtLowPitch&&this.transform.pitch===0&&this.transform.projection.name!=="globe"&&(this.transform.cameraElevationReference="ground"),c||m.moving||this.fire(new s.z("movestart",o)),this._zooming&&!m.zooming&&this.fire(new s.z("zoomstart",o)),this._rotating&&!m.rotating&&this.fire(new s.z("rotatestart",o)),this._pitching&&!m.pitching&&this.fire(new s.z("pitchstart",o))}_fireMoveEvents(o){this.fire(new s.z("move",o)),this._zooming&&this.fire(new s.z("zoom",o)),this._rotating&&this.fire(new s.z("rotate",o)),this._pitching&&this.fire(new s.z("pitch",o))}_afterEase(o,c){if(this._easeId&&c&&this._easeId===c)return;this._easeId=void 0,this.transform.cameraElevationReference="ground";const m=this._zooming,v=this._rotating,b=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,m&&this.fire(new s.z("zoomend",o)),v&&this.fire(new s.z("rotateend",o)),b&&this.fire(new s.z("pitchend",o)),this.fire(new s.z("moveend",o))}flyTo(o,c){if(this._prefersReducedMotion(o)){const tt=s.ay(o,["center","zoom","bearing","pitch","around","padding","retainPadding"]);return this.jumpTo(tt,c)}this.stop(),o=s.l({offset:[0,0],speed:1.2,curve:1.42,easing:s.dA},o);const m=this.transform,v=this.getZoom(),b=this.getBearing(),A=this.getPitch(),M=this.getPadding(),O="zoom"in o?s.aw(+o.zoom,m.minZoom,m.maxZoom):v,k="bearing"in o?this._normalizeBearing(o.bearing,b):b,L="pitch"in o?+o.pitch:A,U=this._extendPadding(o.padding),j=m.zoomScale(O-v),$=s.P.convert(o.offset);let Q=m.centerPoint.add($);const Z=m.pointLocation(Q),te=s.bO.convert(o.center||Z);this._normalizeCenter(te);const ee=m.project(Z),ae=m.project(te).sub(ee);let me=o.curve;const fe=Math.max(m.width,m.height),Ae=fe/j,ve=ae.mag();if("minZoom"in o){const tt=s.aw(Math.min(o.minZoom,v,O),m.minZoom,m.maxZoom),Et=fe/m.zoomScale(tt-v);me=Math.sqrt(Et/ve*2)}const be=me*me;function ye(tt){const Et=(Ae*Ae-fe*fe+(tt?-1:1)*be*be*ve*ve)/(2*(tt?Ae:fe)*be*ve);return Math.log(Math.sqrt(Et*Et+1)-Et)}function Ie(tt){return(Math.exp(tt)-Math.exp(-tt))/2}function Fe(tt){return(Math.exp(tt)+Math.exp(-tt))/2}const Qe=ye(0);let We=function(tt){return Fe(Qe)/Fe(Qe+me*tt)},at=function(tt){return fe*((Fe(Qe)*(Ie(Et=Qe+me*tt)/Fe(Et))-Ie(Qe))/be)/ve;var Et},nt=(ye(1)-Qe)/me;if(Math.abs(ve)<1e-6||!isFinite(nt)){if(Math.abs(fe-Ae)<1e-6)return this.easeTo(o,c);const tt=Ae<fe?-1:1;nt=Math.abs(Math.log(Ae/fe))/me,at=function(){return 0},We=function(Et){return Math.exp(tt*me*Et)}}o.duration="duration"in o?+o.duration:1e3*nt/("screenSpeed"in o?+o.screenSpeed/me:+o.speed),o.maxDuration&&o.duration>o.maxDuration&&(o.duration=0);const je=b!==k,et=L!==A,gt=!m.isPaddingEqual(U),Ve=o.retainPadding===!1?m.clone():m,ut=tt=>Et=>{const ft=Et*nt,ct=1/We(ft);tt.zoom=Et===1?O:v+tt.scaleZoom(ct),je&&(tt.bearing=s.af(b,k,Et)),et&&(tt.pitch=s.af(A,L,Et)),gt&&(Ve.interpolatePadding(M,U,Et),Q=Ve.centerPoint.add($));const xt=Et===1?te:tt.unproject(ee.add(ae.mult(at(ft))).mult(ct));return tt.setLocationAtPoint(tt.renderWorldCopies?xt.wrap():xt,Q),tt._updateCameraOnTerrain(),o.preloadOnly||this._fireMoveEvents(c),tt};if(o.preloadOnly){const tt=this._emulate(ut,o.duration,m);return this._preloadTiles(tt),this}return this._zooming=!0,this._rotating=je,this._pitching=et,this._padding=gt,this._prepareEase(c,!1),this._ease(ut(m),()=>this._afterEase(c),o),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_requestRenderFrame(o){}_cancelRenderFrame(o){}_stop(o,c){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),this._easeFrameId=void 0,this._onEaseFrame=void 0),this._onEaseEnd){const m=this._onEaseEnd;this._onEaseEnd=void 0,m.call(this,c)}if(!o){const m=this.handlers;m&&m.stop(!1)}return this}_ease(o,c,m){m.animate===!1||m.duration===0?(o(1),c()):(this._easeStart=s.q.now(),this._easeOptions=m,this._onEaseFrame=o,this._onEaseEnd=c,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_renderFrameCallback(){const o=Math.min((s.q.now()-this._easeStart)/this._easeOptions.duration,1),c=this._onEaseFrame;c&&c(this._easeOptions.easing(o)),o<1?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()}_normalizeBearing(o,c){o=s.bF(o,-180,180);const m=Math.abs(o-c);return Math.abs(o-360-c)<m&&(o-=360),Math.abs(o+360-c)<m&&(o+=360),o}_normalizeCenter(o){const c=this.transform;if(c.maxBounds||c.projection.name!=="globe"&&!c.renderWorldCopies)return;const m=o.lng-c.center.lng;o.lng+=m>180?-360:m<-180?360:0}_prefersReducedMotion(o){return this._respectPrefersReducedMotion&&s.q.prefersReducedMotion&&!(o&&o.essential)}_emulate(o,c,m){const v=Math.ceil(15*c/1e3),b=[],A=o(m.clone());for(let M=0;M<=v;M++){const O=A(M/v);b.push(O.clone())}return b}_preloadTiles(o,c){}}class Rh{constructor(o={}){this.options=o,s.aP(["_toggleAttribution","_updateEditLink","_updateData","_updateCompact"],this)}getDefaultPosition(){return"bottom-right"}onAdd(o){const c=this.options&&this.options.compact,m=o._getUIString("AttributionControl.ToggleAttribution");this._map=o,this._container=K("div","mapboxgl-ctrl mapboxgl-ctrl-attrib"),this._compactButton=K("button","mapboxgl-ctrl-attrib-button",this._container),this._compactButton.type="button",this._compactButton.addEventListener("click",this._toggleAttribution),this._compactButton.setAttribute("aria-label",m);const v=K("span","mapboxgl-ctrl-icon",this._compactButton);return v.setAttribute("aria-hidden","true"),v.setAttribute("title",m),this._innerContainer=K("div","mapboxgl-ctrl-attrib-inner",this._container),c&&this._container.classList.add("mapboxgl-compact"),this._updateAttributions(),this._updateEditLink(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("moveend",this._updateEditLink),c===void 0&&(this._map.on("resize",this._updateCompact),this._updateCompact()),this._container}onRemove(){this._container.remove(),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("moveend",this._updateEditLink),this._map.off("resize",this._updateCompact),this._map=void 0,this._attribHTML=void 0}_toggleAttribution(){this._container.classList.contains("mapboxgl-compact-show")?(this._container.classList.remove("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","false")):(this._container.classList.add("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","true"))}_updateEditLink(){let o=this._editLink;o||(o=this._editLink=this._container.querySelector(".mapbox-improve-map"));const c=[{key:"owner",value:this.styleOwner},{key:"id",value:this.styleId},{key:"access_token",value:this._map._requestManager._customAccessToken||s.e.ACCESS_TOKEN}];if(o){const m=c.reduce((v,b,A)=>(b.value&&(v+=`${b.key}=${b.value}${A<c.length-1?"&":""}`),v),"?");o.href=`${s.e.FEEDBACK_URL}/${m}#${Gf(this._map,!0)}`,o.rel="noopener nofollow"}}_updateData(o){!o||o.sourceDataType!=="metadata"&&o.sourceDataType!=="visibility"&&o.dataType!=="style"||(this._updateAttributions(),this._updateEditLink())}_updateAttributions(){if(!this._map.style)return;let o=[];if(this._map.style.stylesheet){const v=this._map.style.stylesheet;this.styleOwner=v.owner,this.styleId=v.id}const c=this._map.style._mergedSourceCaches;for(const v in c){const b=c[v];if(b.used){const A=b.getSource();A.attribution&&o.indexOf(A.attribution)<0&&o.push(A.attribution)}}o.sort((v,b)=>v.length-b.length),o=o.filter((v,b)=>{for(let A=b+1;A<o.length;A++)if(o[A].indexOf(v)>=0)return!1;return!0}),this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?o=[...this.options.customAttribution,...o]:o.unshift(this.options.customAttribution));const m=o.join(" | ");m!==this._attribHTML&&(this._attribHTML=m,o.length?(this._innerContainer.innerHTML=m,this._container.classList.remove("mapboxgl-attrib-empty")):this._container.classList.add("mapboxgl-attrib-empty"),this._editLink=null)}_updateCompact(){this._map.getCanvasContainer().offsetWidth<=640?this._container.classList.add("mapboxgl-compact"):this._container.classList.remove("mapboxgl-compact","mapboxgl-compact-show")}}class ps{constructor(){s.aP(["_updateLogo","_updateCompact"],this)}onAdd(o){this._map=o,this._container=K("div","mapboxgl-ctrl");const c=K("a","mapboxgl-ctrl-logo");return c.target="_blank",c.rel="noopener nofollow",c.href="https://www.mapbox.com/",c.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),c.setAttribute("rel","noopener nofollow"),this._container.appendChild(c),this._container.style.display="none",this._map.on("sourcedata",this._updateLogo),this._updateLogo(),this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){this._container.remove(),this._map.off("sourcedata",this._updateLogo),this._map.off("resize",this._updateCompact)}getDefaultPosition(){return"bottom-left"}_updateLogo(o){o&&o.sourceDataType!=="metadata"||(this._container.style.display=this._logoRequired()?"block":"none")}_logoRequired(){if(!this._map.style)return!0;const o=this._map.style._sourceCaches;if(Object.entries(o).length===0)return!0;for(const c in o){const m=o[c].getSource();if(m.hasOwnProperty("mapbox_logo")&&!m.mapbox_logo)return!1}return!0}_updateCompact(){const o=this._container.children;if(o.length){const c=o[0];this._map.getCanvasContainer().offsetWidth<250?c.classList.add("mapboxgl-compact"):c.classList.remove("mapboxgl-compact")}}}class ms{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(o){const c=++this._id;return this._queue.push({callback:o,id:c,cancelled:!1}),c}remove(o){const c=this._currentlyRunning,m=c?this._queue.concat(c):this._queue;for(const v of m)if(v.id===o)return void(v.cancelled=!0)}run(o=0){const c=this._currentlyRunning=this._queue;this._queue=[];for(const m of c)if(!m.cancelled&&(m.callback(o),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}class Fl{constructor(o){this.jumpTo(o)}getValue(o){if(o<=this._startTime)return this._start;if(o>=this._endTime)return this._end;const c=s.cB((o-this._startTime)/(this._endTime-this._startTime));return this._start*(1-c)+this._end*c}isEasing(o){return o>=this._startTime&&o<=this._endTime}jumpTo(o){this._startTime=-1/0,this._endTime=-1/0,this._start=o,this._end=o}easeTo(o,c,m){this._start=this.getValue(c),this._end=o,this._startTime=c,this._endTime=c+m}}const Ga={"AttributionControl.ToggleAttribution":"Toggle attribution","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"Mapbox homepage","Map.Title":"Map","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScrollZoomBlocker.CtrlMessage":"Use ctrl + scroll to zoom the map","ScrollZoomBlocker.CmdMessage":"Use  + scroll to zoom the map","TouchPanBlocker.Message":"Use two fingers to move the map"};class $a extends s.z{constructor(o,c,m,v){const{point:b,lngLat:A,originalEvent:M,target:O}=o;super(o.type,{point:b,lngLat:A,originalEvent:M,target:O}),this.preventDefault=()=>{o.preventDefault()},this.id=c,this.interaction=m,this.feature=v}}class Zf{constructor(o){this.map=o,this.interactionsByType=new Map,this.delegatedInteractions=new Map,this.typeById=new Map,this.filters=new Map,this.handleType=this.handleType.bind(this),this.handleMove=this.handleMove.bind(this),this.handleOut=this.handleOut.bind(this),this.hoveredFeatures=new Map,this.prevHoveredFeatures=new Map}add(o,c){if(this.typeById.has(o))throw new Error(`Interaction id "${o}" already exists.`);const m=c.filter;let v=c.type;m&&this.filters.set(o,s.aZ(m)),v==="mouseover"&&(v="mouseenter"),v==="mouseout"&&(v="mouseleave");const b=this.interactionsByType.get(v)||new Map;v==="mouseenter"||v==="mouseleave"?(this.delegatedInteractions.size===0&&(this.map.on("mousemove",this.handleMove),this.map.on("mouseout",this.handleOut)),this.delegatedInteractions.set(o,c)):b.size===0&&this.map.on(v,this.handleType),b.size===0&&this.interactionsByType.set(v,b),b.set(o,c),this.typeById.set(o,v)}get(o){const c=this.typeById.get(o);if(!c)return;const m=this.interactionsByType.get(c);return m?m.get(o):void 0}remove(o){const c=this.typeById.get(o);if(!c)return;this.typeById.delete(o),this.filters.delete(o);const m=this.interactionsByType.get(c);m&&(m.delete(o),c==="mouseenter"||c==="mouseleave"?(this.delegatedInteractions.delete(o),this.delegatedInteractions.size===0&&(this.map.off("mousemove",this.handleMove),this.map.off("mouseout",this.handleOut))):m.size===0&&this.map.off(c,this.handleType))}queryTargets(o,c){const m=[];for(const[v,b]of c)b.target&&m.push({targetId:v,target:b.target,filter:this.filters.get(v)});return this.map.style.queryRenderedTargets(o,m,this.map.transform)}handleMove(o){this.prevHoveredFeatures=this.hoveredFeatures,this.hoveredFeatures=new Map;const c=this.queryTargets(o.point,Array.from(this.delegatedInteractions).reverse());c.length&&(o.type="mouseenter",this.handleType(o,c));const m=new Map;for(const[v,{feature:b}]of this.prevHoveredFeatures)this.hoveredFeatures.has(v)||m.set(b.id,b);m.size&&(o.type="mouseleave",this.handleType(o,Array.from(m.values())))}handleOut(o){const c=Array.from(this.hoveredFeatures.values()).map(({feature:m})=>m);c.length&&(o.type="mouseleave",this.handleType(o,c)),this.hoveredFeatures.clear()}handleType(o,c){const m=Array.from(this.interactionsByType.get(o.type)).reverse(),v=!!c;c=c||this.queryTargets(o.point,m);const b=o.type==="mouseenter";let A=!1;const M=new Set;for(const O of c){for(const[k,L]of m){if(!L.target)continue;const U=O.variants?O.variants[k]:null;if(U){for(const j of U){if(Eo(j,O,M,k))continue;const $=new s.cw(O,j),Q=hc(j,O,k);v&&($.state=this.map.getFeatureState($));const Z=b?this.prevHoveredFeatures.get(Q):null,te=new $a(o,k,L,$),ee=Z?Z.stop:L.handler(te);if(b&&this.hoveredFeatures.set(Q,{feature:O,stop:ee}),ee!==!1){A=!0;break}}if(A)break}}if(A)break}if(!A)for(const[O,k]of m){const{handler:L,target:U}=k;if(!U&&L(new $a(o,O,k,null))!==!1)break}}}function Li(p,o){if(Array.isArray(p)&&Array.isArray(o)){const c=new Set(p),m=new Set(o);return c.size===m.size&&p.every(v=>m.has(v))}return s.bn(p,o)}const ha={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:85,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,performanceMetricsCollection:!0,bearingSnap:7,clickTolerance:3,pitchWithRotate:!0,hash:!1,attributionControl:!0,antialias:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,minTileCacheSize:null,maxTileCacheSize:null,localIdeographFontFamily:"sans-serif",localFontFamily:null,transformRequest:null,accessToken:null,fadeDuration:300,respectPrefersReducedMotion:!0,crossSourceCollisions:!0,collectResourceTiming:!1,testMode:!1,precompilePrograms:!0,scaleFactor:1,spriteFormat:"auto"},av={showCompass:!0,showZoom:!0,visualizePitch:!1};class lv{constructor(o,c,m=!1){this._clickTolerance=10,this.element=c,this.mouseRotate=new no({clickTolerance:o.dragRotate._mouseRotate._clickTolerance}),this.map=o,m&&(this.mousePitch=new Qc({clickTolerance:o.dragRotate._mousePitch._clickTolerance})),s.aP(["mousedown","mousemove","mouseup","touchstart","touchmove","touchend","reset"],this),c.addEventListener("mousedown",this.mousedown),c.addEventListener("touchstart",this.touchstart,{passive:!1}),c.addEventListener("touchmove",this.touchmove),c.addEventListener("touchend",this.touchend),c.addEventListener("touchcancel",this.reset)}down(o,c){this.mouseRotate.mousedown(o,c),this.mousePitch&&this.mousePitch.mousedown(o,c),ge()}move(o,c){const m=this.map,v=this.mouseRotate.mousemoveWindow(o,c),b=v&&v.bearingDelta;if(b&&m.setBearing(m.getBearing()+b),this.mousePitch){const A=this.mousePitch.mousemoveWindow(o,c),M=A&&A.pitchDelta;M&&m.setPitch(m.getPitch()+M)}}off(){const o=this.element;o.removeEventListener("mousedown",this.mousedown),o.removeEventListener("touchstart",this.touchstart,{passive:!1}),o.removeEventListener("touchmove",this.touchmove),o.removeEventListener("touchend",this.touchend),o.removeEventListener("touchcancel",this.reset),this.offTemp()}offTemp(){Le(),window.removeEventListener("mousemove",this.mousemove),window.removeEventListener("mouseup",this.mouseup)}mousedown(o){this.down(s.l({},o,{ctrlKey:!0,preventDefault:()=>o.preventDefault()}),St(this.element,o)),window.addEventListener("mousemove",this.mousemove),window.addEventListener("mouseup",this.mouseup)}mousemove(o){this.move(o,St(this.element,o))}mouseup(o){this.mouseRotate.mouseupWindow(o),this.mousePitch&&this.mousePitch.mouseupWindow(o),this.offTemp()}touchstart(o){o.targetTouches.length!==1?this.reset():(this._startPos=this._lastPos=Pt(this.element,o.targetTouches)[0],this.down({type:"mousedown",button:0,ctrlKey:!0,preventDefault:()=>o.preventDefault()},this._startPos))}touchmove(o){o.targetTouches.length!==1?this.reset():(this._lastPos=Pt(this.element,o.targetTouches)[0],this.move({preventDefault:()=>o.preventDefault()},this._lastPos))}touchend(o){o.targetTouches.length===0&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),this.reset()}reset(){this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()}}function Ph(p,o,c){if(p=new s.bO(p.lng,p.lat),o){const m=new s.bO(p.lng-360,p.lat),v=new s.bO(p.lng+360,p.lat),b=360*Math.ceil(Math.abs(p.lng-c.center.lng)/360),A=c.locationPoint(p).distSqr(o),M=o.x<0||o.y<0||o.x>c.width||o.y>c.height;c.locationPoint(m).distSqr(o)<A&&(M||Math.abs(m.lng-c.center.lng)<b)?p=m:c.locationPoint(v).distSqr(o)<A&&(M||Math.abs(v.lng-c.center.lng)<b)&&(p=v)}for(;Math.abs(p.lng-c.center.lng)>180;){const m=c.locationPoint(p);if(m.x>=0&&m.y>=0&&m.x<=c.width&&m.y<=c.height)break;p.lng>c.center.lng?p.lng-=360:p.lng+=360}return p}const so={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"};class ks extends s.E{constructor(o,c){if(super(),(o instanceof HTMLElement||c)&&(o=s.l({element:o},c)),s.aP(["_update","_onMove","_onUp","_addDragHandler","_onMapClick","_onKeyPress","_clearFadeTimer"],this),this._anchor=o&&o.anchor||"center",this._color=o&&o.color||"#3FB1CE",this._scale=o&&o.scale||1,this._draggable=o&&o.draggable||!1,this._clickTolerance=o&&o.clickTolerance||0,this._isDragging=!1,this._state="inactive",this._rotation=o&&o.rotation||0,this._rotationAlignment=o&&o.rotationAlignment||"auto",this._pitchAlignment=o&&o.pitchAlignment&&o.pitchAlignment||"auto",this._updateMoving=()=>this._update(!0),this._occludedOpacity=o&&o.occludedOpacity||.2,o&&o.element)this._element=o.element,this._offset=s.P.convert(o&&o.offset||[0,0]);else{this._defaultMarker=!0,this._element=K("div");const b=41,A=27,M=ue("svg",{display:"block",height:b*this._scale+"px",width:A*this._scale+"px",viewBox:`0 0 ${A} ${b}`},this._element),O=ue("radialGradient",{id:"shadowGradient"},ue("defs",{},M));ue("stop",{offset:"10%","stop-opacity":.4},O),ue("stop",{offset:"100%","stop-opacity":.05},O),ue("ellipse",{cx:13.5,cy:34.8,rx:10.5,ry:5.25,fill:"url(#shadowGradient)"},M),ue("path",{fill:this._color,d:"M27,13.5C27,19.07 20.25,27 14.75,34.5C14.02,35.5 12.98,35.5 12.25,34.5C6.75,27 0,19.22 0,13.5C0,6.04 6.04,0 13.5,0C20.96,0 27,6.04 27,13.5Z"},M),ue("path",{opacity:.25,d:"M13.5,0C6.04,0 0,6.04 0,13.5C0,19.22 6.75,27 12.25,34.5C13,35.52 14.02,35.5 14.75,34.5C20.25,27 27,19.07 27,13.5C27,6.04 20.96,0 13.5,0ZM13.5,1C20.42,1 26,6.58 26,13.5C26,15.9 24.5,19.18 22.22,22.74C19.95,26.3 16.71,30.14 13.94,33.91C13.74,34.18 13.61,34.32 13.5,34.44C13.39,34.32 13.26,34.18 13.06,33.91C10.28,30.13 7.41,26.31 5.02,22.77C2.62,19.23 1,15.95 1,13.5C1,6.58 6.58,1 13.5,1Z"},M),ue("circle",{fill:"white",cx:13.5,cy:13.5,r:5.5},M),this._offset=s.P.convert(o&&o.offset||[0,-14])}this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label","Map marker"),this._element.hasAttribute("role")||this._element.setAttribute("role","img"),this._element.classList.add("mapboxgl-marker"),this._element.addEventListener("dragstart",b=>{b.preventDefault()}),this._element.addEventListener("mousedown",b=>{b.preventDefault()});const m=this._element.classList;for(const b in so)m.remove(`mapboxgl-marker-anchor-${b}`);m.add(`mapboxgl-marker-anchor-${this._anchor}`);const v=o&&o.className?o.className.trim().split(/\s+/):[];m.add(...v),this._popup=null}addTo(o){return o===this._map||(this.remove(),this._map=o,o.getCanvasContainer().appendChild(this._element),o.on("move",this._updateMoving),o.on("moveend",this._update),o.on("remove",this._clearFadeTimer),o._addMarker(this),this.setDraggable(this._draggable),this._update(),o.on("click",this._onMapClick)),this}remove(){const o=this._map;return o&&(o.off("click",this._onMapClick),o.off("move",this._updateMoving),o.off("moveend",this._update),o.off("mousedown",this._addDragHandler),o.off("touchstart",this._addDragHandler),o.off("mouseup",this._onUp),o.off("touchend",this._onUp),o.off("mousemove",this._onMove),o.off("touchmove",this._onMove),o.off("remove",this._clearFadeTimer),o._removeMarker(this),this._map=void 0),this._clearFadeTimer(),this._element.remove(),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(o){return this._lngLat=s.bO.convert(o),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(!0),this}getElement(){return this._element}setPopup(o){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeAttribute("role"),this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),o){if(!("offset"in o.options)){const v=Math.sqrt(Math.pow(13.5,2)/2);o.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-38.1],"bottom-left":[v,-1*(38.1-13.5+v)],"bottom-right":[-v,-1*(38.1-13.5+v)],left:[13.5,-1*(38.1-13.5)],right:[-13.5,-1*(38.1-13.5)]}:this._offset}this._popup=o,o._marker=this,this._lngLat&&this._popup.setLngLat(this._lngLat),this._element.setAttribute("role","button"),this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress),this._element.setAttribute("aria-expanded","false")}return this}_onKeyPress(o){const c=o.code,m=o.charCode||o.keyCode;c!=="Space"&&c!=="Enter"&&m!==32&&m!==13||this.togglePopup()}_onMapClick(o){const c=o.originalEvent.target,m=this._element;this._popup&&(c===m||m.contains(c))&&this.togglePopup()}getPopup(){return this._popup}togglePopup(){const o=this._popup;return o?(o.isOpen()?(o.remove(),this._element.setAttribute("aria-expanded","false")):this._map&&(o.addTo(this._map),this._element.setAttribute("aria-expanded","true")),this):this}_behindTerrain(){const o=this._map,c=this._pos;if(!o||!c)return!1;const m=o.unproject(c),v=o.getFreeCameraOptions();if(!v.position)return!1;const b=v.position.toLngLat();return b.distanceTo(m)<.9*b.distanceTo(this._lngLat)}_evaluateOpacity(){const o=this._map;if(!o)return;const c=this._pos;if(!c||c.x<0||c.x>o.transform.width||c.y<0||c.y>o.transform.height)return void this._clearFadeTimer();const m=o.unproject(c);let v;o._showingGlobe()&&s.dH(o.transform,this._lngLat)?v=0:(v=1-o._queryFogOpacity(m),o.transform._terrainEnabled()&&o.getTerrain()&&this._behindTerrain()&&(v*=this._occludedOpacity)),this._element.style.opacity=`${v}`,this._element.style.pointerEvents=v>0?"auto":"none",this._popup&&this._popup._setOpacity(v),this._fadeTimer=null}_clearFadeTimer(){this._fadeTimer&&(clearTimeout(this._fadeTimer),this._fadeTimer=null)}_updateDOM(){const o=this._pos;if(!o||!this._map)return;const c=this._offset.mult(this._scale);this._element.style.transform=`
            translate(${o.x}px,${o.y}px)
            ${so[this._anchor]}
            ${this._calculateXYTransform()} ${this._calculateZTransform()}
            translate(${c.x}px,${c.y}px)
        `}_calculateXYTransform(){const o=this._pos,c=this._map,m=this.getPitchAlignment();if(!c||!o||m!=="map")return"";if(!c._showingGlobe()){const O=c.getPitch();return O?`rotateX(${O}deg)`:""}const v=s.c4(s.dI(c.transform,this._lngLat)),b=o.sub(s.dJ(c.transform)),A=Math.abs(b.x)+Math.abs(b.y);if(A===0)return"";const M=v/A;return`rotateX(${-b.y*M}deg) rotateY(${b.x*M}deg)`}_calculateZTransform(){const o=this._pos,c=this._map;if(!c||!o)return"";let m=0;const v=this.getRotationAlignment();if(v==="map")if(c._showingGlobe()){const b=c.project(new s.bO(this._lngLat.lng,this._lngLat.lat+.001)),A=c.project(new s.bO(this._lngLat.lng,this._lngLat.lat-.001)).sub(b);m=s.c4(Math.atan2(A.y,A.x))-90}else m=-c.getBearing();else if(v==="horizon"){const b=s.ac(4,6,c.getZoom()),A=s.dJ(c.transform);A.y+=b*c.transform.height;const M=o.sub(A),O=s.c4(Math.atan2(M.y,M.x));m=(O>90?O-270:O+90)*(1-b)}return m+=this._rotation,m?`rotateZ(${m}deg)`:""}_update(o){cancelAnimationFrame(this._updateFrameId);const c=this._map;c&&(c.transform.renderWorldCopies&&(this._lngLat=Ph(this._lngLat,this._pos,c.transform)),this._pos=c.project(this._lngLat),o===!0?this._updateFrameId=requestAnimationFrame(()=>{this._element&&this._pos&&this._anchor&&(this._pos=this._pos.round(),this._updateDOM())}):this._pos=this._pos.round(),c._requestDomTask(()=>{this._map&&(this._element&&this._pos&&this._anchor&&this._updateDOM(),(c._showingGlobe()||c.getTerrain()||c.getFog())&&!this._fadeTimer&&(this._fadeTimer=window.setTimeout(this._evaluateOpacity.bind(this),60)))}))}getOffset(){return this._offset}setOffset(o){return this._offset=s.P.convert(o),this._update(),this}addClassName(o){return this._element.classList.add(o),this}removeClassName(o){return this._element.classList.remove(o),this}toggleClassName(o){return this._element.classList.toggle(o)}_onMove(o){const c=this._map;if(!c)return;const m=this._pointerdownPos,v=this._positionDelta;if(m&&v){if(!this._isDragging){const b=this._clickTolerance||c._clickTolerance;if(o.point.dist(m)<b)return;this._isDragging=!0}this._pos=o.point.sub(v),this._lngLat=c.unproject(this._pos),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none",this._state==="pending"&&(this._state="active",this.fire(new s.z("dragstart"))),this.fire(new s.z("drag"))}}_onUp(){this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1;const o=this._map;o&&(o.off("mousemove",this._onMove),o.off("touchmove",this._onMove)),this._state==="active"&&this.fire(new s.z("dragend")),this._state="inactive"}_addDragHandler(o){const c=this._map,m=this._pos;c&&m&&this._element.contains(o.originalEvent.target)&&(o.preventDefault(),this._positionDelta=o.point.sub(m),this._pointerdownPos=o.point,this._state="pending",c.on("mousemove",this._onMove),c.on("touchmove",this._onMove),c.once("mouseup",this._onUp),c.once("touchend",this._onUp))}setDraggable(o){this._draggable=!!o;const c=this._map;return c&&(o?(c.on("mousedown",this._addDragHandler),c.on("touchstart",this._addDragHandler)):(c.off("mousedown",this._addDragHandler),c.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(o){return this._rotation=o||0,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(o){return this._rotationAlignment=o||"auto",this._update(),this}getRotationAlignment(){return this._rotationAlignment==="auto"||this._rotationAlignment==="horizon"&&this._map&&!this._map._showingGlobe()?"viewport":this._rotationAlignment}setPitchAlignment(o){return this._pitchAlignment=o||"auto",this._update(),this}getPitchAlignment(){return this._pitchAlignment==="auto"?this.getRotationAlignment():this._pitchAlignment}setOccludedOpacity(o){return this._occludedOpacity=o||.2,this._update(),this}getOccludedOpacity(){return this._occludedOpacity}}const Dn={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0,showUserHeading:!1},es={maxWidth:100,unit:"metric"},an={kilometer:"km",meter:"m",mile:"mi",foot:"ft","nautical-mile":"nm"},M_={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px"},jn=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function Yf(p=new s.P(0,0),o="bottom"){if(typeof p=="number"){const c=Math.round(Math.sqrt(.5*Math.pow(p,2)));switch(o){case"top":return new s.P(0,p);case"top-left":return new s.P(c,c);case"top-right":return new s.P(-c,c);case"bottom":return new s.P(0,-p);case"bottom-left":return new s.P(c,-c);case"bottom-right":return new s.P(-c,-c);case"left":return new s.P(p,0);case"right":return new s.P(-p,0)}return new s.P(0,0)}return p instanceof s.P||Array.isArray(p)?s.P.convert(p):s.P.convert(p[o]||[0,0])}return{version:T,supported:ne.supported,setRTLTextPlugin:s.dK,getRTLTextPluginStatus:s.dL,Map:class extends Ol{constructor(p){F.mark(B.create);const o=p;if((p=s.l({},ha,p)).minZoom!=null&&p.maxZoom!=null&&p.minZoom>p.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(p.minPitch!=null&&p.maxPitch!=null&&p.minPitch>p.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(p.minPitch!=null&&p.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(p.maxPitch!=null&&p.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(p.antialias&&s.dF(window)&&(p.antialias=!1,s.w("Antialiasing is disabled for this WebGL context to avoid browser bug: https://github.com/mapbox/mapbox-gl-js/issues/11609")),super(new Ac(p.minZoom,p.maxZoom,p.minPitch,p.maxPitch,p.renderWorldCopies),p),this._repaint=!!p.repaint,this._interactive=p.interactive,this._minTileCacheSize=p.minTileCacheSize,this._maxTileCacheSize=p.maxTileCacheSize,this._failIfMajorPerformanceCaveat=p.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=p.preserveDrawingBuffer,this._antialias=p.antialias,this._trackResize=p.trackResize,this._bearingSnap=p.bearingSnap,this._refreshExpiredTiles=p.refreshExpiredTiles,this._fadeDuration=p.fadeDuration,this._isInitialLoad=!0,this._crossSourceCollisions=p.crossSourceCollisions,this._collectResourceTiming=p.collectResourceTiming,this._language=this._parseLanguage(p.language),this._worldview=p.worldview,this._renderTaskQueue=new ms,this._domRenderTaskQueue=new ms,this._controls=[],this._markers=[],this._popups=[],this._mapId=s.aV(),this._locale=s.l({},Ga,p.locale),this._clickTolerance=p.clickTolerance,this._cooperativeGestures=p.cooperativeGestures,this._performanceMetricsCollection=p.performanceMetricsCollection,this._tessellationStep=p.tessellationStep,this._containerWidth=0,this._containerHeight=0,this._showParseStatus=!0,this._precompilePrograms=p.precompilePrograms,this._scaleFactorChanged=!1,this._averageElevationLastSampledAt=-1/0,this._averageElevationExaggeration=0,this._averageElevation=new Fl(0),this._interactionRange=[1/0,-1/0],this._visibilityHidden=0,this._useExplicitProjection=!1,this._frameId=0,this._scaleFactor=p.scaleFactor,this._requestManager=new Si(p.transformRequest,p.accessToken,p.testMode),this._silenceAuthErrors=!!p.testMode,this._contextCreateOptions=p.contextCreateOptions?Object.assign({},p.contextCreateOptions):{},typeof p.container=="string"){const c=document.getElementById(p.container);if(!c)throw new Error(`Container '${p.container.toString()}' not found.`);this._container=c}else{if(!(p.container instanceof HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=p.container}if(this._container.childNodes.length>0&&s.w("The map container element should be empty, otherwise the map's interactivity will be negatively impacted. If you want to display a message when WebGL is not supported, use the Mapbox GL Supported plugin instead."),p.maxBounds&&this.setMaxBounds(p.maxBounds),this._spriteFormat=p.spriteFormat,s.aP(["_onWindowOnline","_onWindowResize","_onVisibilityChange","_onMapScroll","_contextLost","_contextRestored"],this),this._setupContainer(),this._tp||(this._tp=new Nf),this._tp.registerParameter(this,["Debug"],"showOverdrawInspector"),this._tp.registerParameter(this,["Debug"],"showTileBoundaries"),this._tp.registerParameter(this,["Debug"],"showParseStatus"),this._tp.registerParameter(this,["Debug"],"repaint"),this._tp.registerParameter(this,["Debug"],"showTileAABBs"),this._tp.registerParameter(this,["Debug"],"showPadding"),this._tp.registerParameter(this,["Debug"],"showCollisionBoxes",{noSave:!0}),this._tp.registerParameter(this.transform,["Debug"],"freezeTileCoverage",{noSave:!0},()=>{this._update()}),this._tp.registerParameter(this,["Debug","Wireframe"],"showTerrainWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers2DWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers3DWireframe"),this._tp.registerParameter(this,["Scaling"],"_scaleFactor",{min:.1,max:10,step:.1},()=>{this.setScaleFactor(this._scaleFactor)}),this._setupPainter(),this.painter===void 0)throw new Error("Failed to initialize WebGL.");if(this.on("move",()=>this._update(!1)),this.on("moveend",()=>this._update(!1)),this.on("zoom",()=>this._update(!0)),this._fullscreenchangeEvent="onfullscreenchange"in document?"fullscreenchange":"webkitfullscreenchange",window.addEventListener("online",this._onWindowOnline,!1),window.addEventListener("resize",this._onWindowResize,!1),window.addEventListener("orientationchange",this._onWindowResize,!1),window.addEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.addEventListener("visibilitychange",this._onVisibilityChange,!1),this.handlers=new I_(this,p),this._localFontFamily=p.localFontFamily,this._localIdeographFontFamily=p.localIdeographFontFamily,(p.style||!p.testMode)&&this.setStyle(p.style||s.e.DEFAULT_STYLE,{config:p.config,localFontFamily:this._localFontFamily,localIdeographFontFamily:this._localIdeographFontFamily}),p.projection&&this.setProjection(p.projection),this.indoor=new Qd(this),p.hash&&(this._hash=new __(typeof p.hash=="string"&&p.hash||void 0).addTo(this)),!this._hash||!this._hash._onHashChange()){o.center==null&&o.zoom==null||(this.transform._unmodified=!1),this.jumpTo({center:p.center,zoom:p.zoom,bearing:p.bearing,pitch:p.pitch});const c=p.bounds;c&&(this.resize(),this.fitBounds(c,s.l({},p.fitBoundsOptions,{duration:0})))}this.resize(),p.attributionControl&&this.addControl(new Rh({customAttribution:p.customAttribution})),this._logoControl=new ps,this.addControl(this._logoControl,p.logoPosition),this.on("style.load",()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet),this._postStyleLoadEvent()}),this.on("data",c=>{this._update(c.dataType==="style"),this.fire(new s.z(`${c.dataType}data`,c))}),this.on("dataloading",c=>{this.fire(new s.z(`${c.dataType}dataloading`,c))}),this._interactions=new Zf(this)}_getMapId(){return this._mapId}addControl(p,o){if(o===void 0&&(o=p.getDefaultPosition?p.getDefaultPosition():"top-right"),!p||!p.onAdd)return this.fire(new s.y(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const c=p.onAdd(this);this._controls.push(p);const m=this._controlPositions[o];return o.indexOf("bottom")!==-1?m.insertBefore(c,m.firstChild):m.appendChild(c),this}removeControl(p){if(!p||!p.onRemove)return this.fire(new s.y(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const o=this._controls.indexOf(p);return o>-1&&this._controls.splice(o,1),p.onRemove(this),this}hasControl(p){return this._controls.indexOf(p)>-1}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}resize(p){if(this._updateContainerDimensions(),this._containerWidth===this.transform.width&&this._containerHeight===this.transform.height)return this;this._resizeCanvas(this._containerWidth,this._containerHeight),this.transform.resize(this._containerWidth,this._containerHeight),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight));const o=!this._moving;return o&&this.fire(new s.z("movestart",p)).fire(new s.z("move",p)),this.fire(new s.z("resize",p)),o&&this.fire(new s.z("moveend",p)),this}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()||null}setMaxBounds(p){return this.transform.setMaxBounds(s.az.convert(p)),this._update()}setMinZoom(p){if((p=p??-2)>=-2&&p<=this.transform.maxZoom)return this.transform.minZoom=p,this._update(),this.getZoom()<p?this.setZoom(p):this.fire(new s.z("zoomstart")).fire(new s.z("zoom")).fire(new s.z("zoomend")),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(p){if((p=p??22)>=this.transform.minZoom)return this.transform.maxZoom=p,this._update(),this.getZoom()>p?this.setZoom(p):this.fire(new s.z("zoomstart")).fire(new s.z("zoom")).fire(new s.z("zoomend")),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(p){if((p=p??0)<0)throw new Error("minPitch must be greater than or equal to 0");if(p>=0&&p<=this.transform.maxPitch)return this.transform.minPitch=p,this._update(),this.getPitch()<p?this.setPitch(p):this.fire(new s.z("pitchstart")).fire(new s.z("pitch")).fire(new s.z("pitchend")),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(p){if((p=p??85)>85)throw new Error("maxPitch must be less than or equal to 85");if(p>=this.transform.minPitch)return this.transform.maxPitch=p,this._update(),this.getPitch()>p?this.setPitch(p):this.fire(new s.z("pitchstart")).fire(new s.z("pitch")).fire(new s.z("pitchend")),this;throw new Error("maxPitch must be greater than or equal to minPitch")}getMaxPitch(){return this.transform.maxPitch}getScaleFactor(){return this._scaleFactor}setScaleFactor(p){return this._scaleFactor=p,this.painter.scaleFactor=p,this._tp.refreshUI(),this._scaleFactorChanged=!0,this.style._updateFilteredLayers(o=>o.type==="symbol"),this._update(!0),this}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(p){return this.transform.renderWorldCopies=p,this.transform.renderWorldCopies||this._forceMarkerAndPopupUpdate(!0),this._update()}getLanguage(){return this._language}_parseLanguage(p){return p==="auto"?navigator.language:Array.isArray(p)?p.length===0?void 0:p.map(o=>o==="auto"?navigator.language:o):p}setLanguage(p){const o=this._parseLanguage(p);if(!this.style||o===this._language)return this;this._language=o,this.style.reloadSources();for(const c of this._controls)c._setLanguage&&c._setLanguage(this._language);return this}getWorldview(){return this._worldview}setWorldview(p){return this.style&&p!==this._worldview?(this._worldview=p,this.style.reloadSources(),this):this}getProjection(){return this.transform.mercatorFromTransition?{name:"globe",center:[0,0]}:this.transform.getProjection()}_showingGlobe(){return this.transform.projection.name==="globe"}setProjection(p){return this._lazyInitEmptyStyle(),p?typeof p=="string"&&(p={name:p}):p=null,this._useExplicitProjection=!!p,this._prioritizeAndUpdateProjection(p,this.style.projection)}_updateProjectionTransition(){if(this.getProjection().name!=="globe")return;const p=this.transform,o=p.projection.name;let c;o==="globe"&&p.zoom>=s.bY?(p.setMercatorFromTransition(),c=!0):o==="mercator"&&p.zoom<s.bY&&(p.setProjection({name:"globe"}),c=!0),c&&(this.style.applyProjectionUpdate(),this.style._forceSymbolLayerUpdate())}_prioritizeAndUpdateProjection(p,o){return this._updateProjection(p||o||{name:"mercator"})}_updateProjection(p){let o;return o=p.name==="globe"&&this.transform.zoom>=s.bY?this.transform.setMercatorFromTransition():this.transform.setProjection(p),this.style.applyProjectionUpdate(),o&&(this.painter.clearBackgroundTiles(),this.style.clearSources(),this._update(!0),this._forceMarkerAndPopupUpdate(!0)),this}project(p){return this.transform.locationPoint3D(s.bO.convert(p))}unproject(p){return this.transform.pointLocation3D(s.P.convert(p))}isMoving(){return this._moving||this.handlers&&this.handlers.isMoving()||!1}isZooming(){return this._zooming||this.handlers&&this.handlers.isZooming()||!1}isRotating(){return this._rotating||this.handlers&&this.handlers.isRotating()||!1}_isDragging(){return this.handlers&&this.handlers._isDragging()||!1}_createDelegatedListener(p,o,c){const m=v=>{let b=[];if(Array.isArray(o)){const A=o.filter(M=>this.getLayer(M));b=A.length?this.queryRenderedFeatures(v,{layers:A}):[]}else b=this.queryRenderedFeatures(v,{target:o});return b};if(p==="mouseenter"||p==="mouseover"){let v=!1;return{listener:c,targets:o,delegates:{mousemove:A=>{const M=m(A.point);M.length?v||(v=!0,c.call(this,new Qn(p,this,A.originalEvent,{features:M}))):v=!1},mouseout:()=>{v=!1}}}}if(p==="mouseleave"||p==="mouseout"){let v=!1;return{listener:c,targets:o,delegates:{mousemove:M=>{m(M.point).length?v=!0:v&&(v=!1,c.call(this,new Qn(p,this,M.originalEvent)))},mouseout:M=>{v&&(v=!1,c.call(this,new Qn(p,this,M.originalEvent)))}}}}{const v=b=>{const A=m(b.point);A.length&&(b.features=A,c.call(this,b),delete b.features)};return{listener:c,targets:o,delegates:{[p]:v}}}}on(p,o,c){if(typeof o=="function"||c===void 0)return super.on(p,o);if(typeof o=="string"&&(o=[o]),!this._areTargetsValid(o))return this;const m=this._createDelegatedListener(p,o,c);this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[p]=this._delegatedListeners[p]||[],this._delegatedListeners[p].push(m);for(const v in m.delegates)this.on(v,m.delegates[v]);return this}once(p,o,c){if(typeof o=="function"||c===void 0)return super.once(p,o);if(typeof o=="string"&&(o=[o]),!this._areTargetsValid(o))return this;const m=this._createDelegatedListener(p,o,c);for(const v in m.delegates)this.once(v,m.delegates[v]);return this}off(p,o,c){if(typeof o=="function"||c===void 0)return super.off(p,o);if(typeof o=="string"&&(o=[o]),!this._areTargetsValid(o))return this;const m=this._delegatedListeners?this._delegatedListeners[p]:void 0;return m&&(v=>{for(let b=0;b<v.length;b++){const A=v[b];if(A.listener===c&&Li(A.targets,o)){for(const M in A.delegates)this.off(M,A.delegates[M]);return v.splice(b,1),this}}})(m),this}queryRenderedFeatures(p,o){if(!this.style)return[];if(p===void 0||p instanceof s.P||Array.isArray(p)||o!==void 0||(o=p,p=void 0),p=p||[[0,0],[this.transform.width,this.transform.height]],!o){const b=this.style.queryRenderedFeatures(p,void 0,this.transform),A=this.style.queryRenderedFeatureset(p,void 0,this.transform);return b.concat(A)}let c=!0;if(o.target&&(c=this._isTargetValid(o.target),c&&!o.layers))return this.style.queryRenderedFeatureset(p,o,this.transform);let m=!0;if(o.layers&&Array.isArray(o.layers)){for(const b of o.layers)if(!this._isValidId(b)){m=!1;break}if(m&&!o.target)return this.style.queryRenderedFeatures(p,o,this.transform)}let v=[];return m&&(v=v.concat(this.style.queryRenderedFeatures(p,o,this.transform))),c&&(v=v.concat(this.style.queryRenderedFeatureset(p,o,this.transform))),v}querySourceFeatures(p,o){return!p||typeof p=="string"&&!this._isValidId(p)?[]:this.style.querySourceFeatures(p,o)}isPointOnSurface(p){const{name:o}=this.transform.projection;return o!=="globe"&&o!=="mercator"&&s.w(`${o} projection does not support isPointOnSurface, this API may behave unexpectedly.`),this.transform.isPointOnSurface(s.P.convert(p))}addInteraction(p,o){return this._interactions.add(p,o),this}removeInteraction(p){return this._interactions.remove(p),this}setStyle(p,o){return o=s.l({},{localIdeographFontFamily:this._localIdeographFontFamily,localFontFamily:this._localFontFamily},o),this.style&&p&&o.diff!==!1&&o.localFontFamily===this._localFontFamily&&o.localIdeographFontFamily===this._localIdeographFontFamily&&!o.config?(this.style._diffStyle(p,(c,m)=>{c?(s.w(`Unable to perform style diff: ${String(c.message||c.error||c)}. Rebuilding the style from scratch.`),this._updateStyle(p,o)):m&&this._update(!0)},()=>{this._postStyleLoadEvent()}),this):(this._localIdeographFontFamily=o.localIdeographFontFamily,this._localFontFamily=o.localFontFamily,this._updateStyle(p,o))}_getUIString(p){const o=this._locale[p];if(o==null)throw new Error(`Missing UI string '${p}'`);return o}_updateStyle(p,o){if(this.style&&(this.style.setEventedParent(null),this.style._remove(),this.style=void 0),p){const c=s.l({},o);o&&o.config&&(c.initialConfig=o.config,delete c.config),this.style=new Es(this,c).load(p),this.style.setEventedParent(this,{style:this.style})}return this._updateTerrain(),this}_lazyInitEmptyStyle(){this.style||(this.style=new Es(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():(s.w("There is no style added to the map."),!1)}_isValidId(p){return p==null?(this.fire(new s.y(new Error("IDs can't be empty."))),!1):!s.cr(p)||(this.fire(new s.y(new Error(`IDs can't contain special symbols: "${p}".`))),!1)}_isTargetValid(p){return"featuresetId"in p?this._isValidId("importId"in p?p.importId:p.featuresetId):"layerId"in p&&this._isValidId(p.layerId)}_areTargetsValid(p){if(Array.isArray(p)){for(const o of p)if(!this._isValidId(o))return!1;return!0}return this._isTargetValid(p)}addSource(p,o){return this._isValidId(p)?(this._lazyInitEmptyStyle(),this.style.addSource(p,o),this._update(!0)):this}isSourceLoaded(p){return!!this._isValidId(p)&&!!this.style&&this.style._isSourceCacheLoaded(p)}areTilesLoaded(){return this.style.areTilesLoaded()}addSourceType(p,o,c){this._lazyInitEmptyStyle(),this.style.addSourceType(p,o,c)}removeSource(p){return this._isValidId(p)?(this.style.removeSource(p),this._updateTerrain(),this._update(!0)):this}getSource(p){return this._isValidId(p)?this.style.getOwnSource(p):null}addImage(p,o,{pixelRatio:c=1,sdf:m=!1,stretchX:v,stretchY:b,content:A}={}){if(this._lazyInitEmptyStyle(),o instanceof HTMLImageElement||ImageBitmap&&o instanceof ImageBitmap){const{width:M,height:O,data:k}=s.q.getImageData(o);this.style.addImage(p,{data:new s.r({width:M,height:O},k),pixelRatio:c,stretchX:v,stretchY:b,content:A,sdf:m,version:0,usvg:!1})}else if(o.width===void 0||o.height===void 0)this.fire(new s.y(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));else{const{width:M,height:O}=o,k=o;this.style.addImage(p,{data:new s.r({width:M,height:O},new Uint8Array(k.data)),pixelRatio:c,stretchX:v,stretchY:b,content:A,sdf:m,usvg:!1,version:0,userImage:k}),k.onAdd&&k.onAdd(this,p)}}updateImage(p,o){this._lazyInitEmptyStyle();const c=this.style.getImage(p);if(!c)return void this.fire(new s.y(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const m=o instanceof HTMLImageElement||ImageBitmap&&o instanceof ImageBitmap?s.q.getImageData(o):o,{width:v,height:b,data:A}=m;if(v===void 0||b===void 0)return void this.fire(new s.y(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));if(v!==(c.usvg?c.icon.usvg_tree.width:c.data.width)||b!==(c.usvg?c.icon.usvg_tree.height:c.data.height))return void this.fire(new s.y(new Error(`The width and height of the updated image (${v}, ${b})
                must be that same as the previous version of the image
                (${c.data.width}, ${c.data.height})`)));const M=!(o instanceof HTMLImageElement||ImageBitmap&&o instanceof ImageBitmap);let O=!1;c.usvg?(c.data=new s.r({width:v,height:b},new Uint8Array(A)),c.usvg=!1,c.icon=void 0,O=!0):c.data.replace(A,M),this.style.updateImage(p,c,O)}hasImage(p){return p?!!this.style&&!!this.style.getImage(p):(this.fire(new s.y(new Error("Missing required image id"))),!1)}removeImage(p){this.style.removeImage(p)}loadImage(p,o){s.o(this._requestManager.transformRequest(p,s.R.Image),(c,m)=>{o(c,m instanceof HTMLImageElement?s.q.getImageData(m):m)})}listImages(){return this.style.listImages()}addModel(p,o){this._lazyInitEmptyStyle(),this.style.addModel(p,o)}hasModel(p){return p?this.style.hasModel(p):(this.fire(new s.y(new Error("Missing required model id"))),!1)}removeModel(p){this.style.removeModel(p)}listModels(){return this.style.listModels()}addLayer(p,o){return this._isValidId(p.id)?(this._lazyInitEmptyStyle(),this.style.addLayer(p,o),this._update(!0)):this}getSlot(p){const o=this.getLayer(p);return o&&o.slot||null}setSlot(p,o){return this.style.setSlot(p,o),this.style.mergeLayers(),this._update(!0)}addImport(p,o){return this.style.addImport(p,o),this}updateImport(p,o){return typeof o!="string"&&o.id!==p?(this.removeImport(p),this.addImport(o)):(this.style.updateImport(p,o),this._update(!0))}removeImport(p){return this.style.removeImport(p),this}moveImport(p,o){return this.style.moveImport(p,o),this._update(!0)}moveLayer(p,o){return this._isValidId(p)?(this.style.moveLayer(p,o),this._update(!0)):this}removeLayer(p){return this._isValidId(p)?(this.style.removeLayer(p),this._update(!0)):this}getLayer(p){if(!this._isValidId(p))return null;const o=this.style.getOwnLayer(p);return o?o.type==="custom"?o.implementation:o.serialize():void 0}getSlots(){return this.style.getSlots()}setLayerZoomRange(p,o,c){return this._isValidId(p)?(this.style.setLayerZoomRange(p,o,c),this._update(!0)):this}setFilter(p,o,c={}){return this._isValidId(p)?(this.style.setFilter(p,o,c),this._update(!0)):this}getFilter(p){return this._isValidId(p)?this.style.getFilter(p):null}setPaintProperty(p,o,c,m={}){return this._isValidId(p)?(this.style.setPaintProperty(p,o,c,m),this._update(!0)):this}getPaintProperty(p,o){return this._isValidId(p)?this.style.getPaintProperty(p,o):null}setLayoutProperty(p,o,c,m={}){return this._isValidId(p)?(this.style.setLayoutProperty(p,o,c,m),this._update(!0)):this}getLayoutProperty(p,o){return this._isValidId(p)?this.style.getLayoutProperty(p,o):null}getSchema(p){return this.style.getSchema(p)}setSchema(p,o){return this.style.setSchema(p,o),this._update(!0)}getConfig(p){return this.style.getConfig(p)}setConfig(p,o){return this.style.setConfig(p,o),this._update(!0)}getConfigProperty(p,o){return this.style.getConfigProperty(p,o)}setConfigProperty(p,o,c){return this.style.setConfigProperty(p,o,c),this._update(!0)}getFeaturesetDescriptors(p){return this.style.getFeaturesetDescriptors(p)}setLights(p){if(this._lazyInitEmptyStyle(),p&&p.length===1&&p[0].type==="flat"){const o=p[0];o.properties?this.style.setFlatLight(o.properties,o.id,{}):this.style.setFlatLight({},"flat")}else this.style.setLights(p),this.painter.terrain&&(this.painter.terrain.invalidateRenderCache=!0);return this._update(!0)}getLights(){const p=this.style.getLights()||[];return p.length===0&&p.push({id:this.style.light.id,type:"flat",properties:this.style.getFlatLight()}),p}setLight(p,o={}){return console.log("The `map.setLight` function is deprecated, prefer using `map.setLights` with `flat` light type instead."),this.setLights([{id:"flat",type:"flat",properties:p}])}getLight(){return console.log("The `map.getLight` function is deprecated, prefer using `map.getLights` instead."),this.style.getFlatLight()}setTerrain(p){return this._lazyInitEmptyStyle(),!p&&this.transform.projection.requiresDraping?this.style.setTerrainForDraping():this.style.setTerrain(p),this._averageElevationLastSampledAt=-1/0,this._update(!0)}getTerrain(){return this.style?this.style.getTerrain():null}setFog(p){return this._lazyInitEmptyStyle(),this.style.setFog(p),this._update(!0)}getFog(){return this.style?this.style.getFog():null}setSnow(p){return this._lazyInitEmptyStyle(),this.style.setSnow(p),this._update(!0)}getSnow(){return this.style?this.style.getSnow():null}setRain(p){return this._lazyInitEmptyStyle(),this.style.setRain(p),this._update(!0)}getRain(){return this.style?this.style.getRain():null}setColorTheme(p){return this._lazyInitEmptyStyle(),this.style.setColorTheme(p),this._update(!0)}setImportColorTheme(p,o){return this._lazyInitEmptyStyle(),this.style.setImportColorTheme(p,o),this._update(!0)}setCamera(p){return this.style.setCamera(p),this._triggerCameraUpdate(p)}_triggerCameraUpdate(p){return this._update(this.transform.setOrthographicProjectionAtLowPitch(p["camera-projection"]==="orthographic"))}getCamera(){return this.style.camera}_queryFogOpacity(p){return this.style&&this.style.fog?this.style.fog.getOpacityAtLatLng(s.bO.convert(p),this.transform):0}setFeatureState(p,o){return p.source&&!this._isValidId(p.source)?this:(this.style.setFeatureState(p,o),this._update())}removeFeatureState(p,o){return p.source&&!this._isValidId(p.source)?this:(this.style.removeFeatureState(p,o),this._update())}getFeatureState(p){return p.source&&!this._isValidId(p.source)?null:this.style.getFeatureState(p)}_updateContainerDimensions(){if(!this._container)return;const p=this._container.getBoundingClientRect().width||400,o=this._container.getBoundingClientRect().height||300;let c,m,v,b=this._container;for(;b&&(!m||!v);){const A=window.getComputedStyle(b).transform;A&&A!=="none"&&(c=A.match(/matrix.*\((.+)\)/)[1].split(", "),c[0]&&c[0]!=="0"&&c[0]!=="1"&&(m=c[0]),c[3]&&c[3]!=="0"&&c[3]!=="1"&&(v=c[3])),b=b.parentElement}this._containerWidth=m?Math.abs(p/m):p,this._containerHeight=v?Math.abs(o/v):o}_detectMissingCSS(){window.getComputedStyle(this._missingCSSCanary).getPropertyValue("background-color")!=="rgb(250, 128, 114)"&&s.w("This page appears to be missing CSS declarations for Mapbox GL JS, which may cause the map to display incorrectly. Please ensure your page includes mapbox-gl.css, as described in https://www.mapbox.com/mapbox-gl-js/api/.")}_setupContainer(){const p=this._container;p.classList.add("mapboxgl-map"),(this._missingCSSCanary=K("div","mapboxgl-canary",p)).style.visibility="hidden",this._detectMissingCSS();const o=this._canvasContainer=K("div","mapboxgl-canvas-container",p);this._canvas=K("canvas","mapboxgl-canvas",o),this._interactive&&(o.classList.add("mapboxgl-interactive"),this._canvas.setAttribute("tabindex","0")),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region"),this._updateContainerDimensions(),this._resizeCanvas(this._containerWidth,this._containerHeight);const c=this._controlContainer=K("div","mapboxgl-control-container",p),m=this._controlPositions={};["top-left","top","top-right","right","bottom-right","bottom","bottom-left","left"].forEach(v=>{m[v]=K("div",`mapboxgl-ctrl-${v}`,c)}),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(p,o){const c=s.q.devicePixelRatio||1;this._canvas.width=c*Math.ceil(p),this._canvas.height=c*Math.ceil(o),this._canvas.style.width=`${p}px`,this._canvas.style.height=`${o}px`}_addMarker(p){this._markers.push(p)}_removeMarker(p){const o=this._markers.indexOf(p);o!==-1&&this._markers.splice(o,1)}_addPopup(p){this._popups.push(p)}_removePopup(p){const o=this._popups.indexOf(p);o!==-1&&this._popups.splice(o,1)}_setupPainter(){const p=s.l({},ne.supported.webGLContextAttributes,{failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1}),o=this._canvas.getContext("webgl2",p);o?(Xn(o,!0),this.painter=new Hf(o,this._contextCreateOptions,this.transform,this._scaleFactor,this._tp),this.on("data",c=>{c.dataType==="source"&&this.painter.setTileLoadedFlag(!0)}),s.m.testSupport(o)):this.fire(new s.y(new Error("Failed to initialize WebGL")))}_contextLost(p){p.preventDefault(),this._frame&&(this._frame.cancel(),this._frame=null),this.fire(new s.z("webglcontextlost",{originalEvent:p}))}_contextRestored(p){this._setupPainter(),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight)),this._updateTerrain(),this.style.reloadModels(),this.style.clearSources(),this._update(),this.fire(new s.z("webglcontextrestored",{originalEvent:p}))}_onMapScroll(p){if(p.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1}idle(){return!this.isMoving()&&this.loaded()}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}frameReady(){return this.loaded()&&!this._placementDirty}_update(p){return this.style?(this._styleDirty=this._styleDirty||p,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(p){return this._update(),this._renderTaskQueue.add(p)}_cancelRenderFrame(p){this._renderTaskQueue.remove(p)}_requestDomTask(p){!this.loaded()||this.loaded()&&!this.isMoving()?p():this._domRenderTaskQueue.add(p)}_render(p){let o;this.fire(new s.z("renderstart")),++this._frameId;const c=this.painter.context.extTimerQuery,m=s.q.now(),v=this.painter.context.gl;if(this.listens("gpu-timing-frame")&&(o=v.createQuery(),v.beginQuery(c.TIME_ELAPSED_EXT,o)),this.painter.context.setDirty(),this.painter.setBaseState(),(this.isMoving()||this.isRotating()||this.isZooming())&&(this._interactionRange[0]=Math.min(this._interactionRange[0],performance.now()),this._interactionRange[1]=Math.max(this._interactionRange[1],performance.now())),this._renderTaskQueue.run(p),this._domRenderTaskQueue.run(p),this._removed)return;this._updateProjectionTransition();const b=this._isInitialLoad?0:this._fadeDuration;if(this.style&&this._styleDirty){this._styleDirty=!1;const k=this.transform.zoom,L=this.transform.pitch,U=s.q.now(),j=new s.a8(k,{now:U,fadeDuration:b,pitch:L,transition:this.style.transition});this.style.update(j)}this.style&&this.style.hasFogTransition()&&(this.style._markersNeedUpdate=!0,this._sourcesDirty=!0);let A=!1;this.style&&this._sourcesDirty?(this._sourcesDirty=!1,this.painter._updateFog(this.style),this._updateTerrain(),A=this._updateAverageElevation(m),this.style.updateSources(this.transform),this._forceMarkerAndPopupUpdate()):A=this._updateAverageElevation(m);const M=this.style&&this.style._updatePlacement(this.painter,this.painter.transform,this.showCollisionBoxes,b,this._crossSourceCollisions,this.painter.replacementSource,this._scaleFactorChanged);if(this._scaleFactorChanged&&(this._scaleFactorChanged=!1),M&&(this._placementDirty=M.needsRerender),this.style&&this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showParseStatus:this.showParseStatus,wireframe:{terrain:this.showTerrainWireframe,layers2D:this.showLayers2DWireframe,layers3D:this.showLayers3DWireframe},showOverdrawInspector:this._showOverdrawInspector,showQueryGeometry:!!this._showQueryGeometry,showTileAABBs:this.showTileAABBs,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:b,isInitialLoad:this._isInitialLoad,showPadding:this.showPadding,gpuTiming:!!this.listens("gpu-timing-layer"),gpuTimingDeferredRender:!!this.listens("gpu-timing-deferred-render"),speedIndexTiming:this.speedIndexTiming}),this.fire(new s.z("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,F.mark(B.load),this.fire(new s.z("load"))),this.style&&this.style.hasTransitions()&&(this._styleDirty=!0),this.style&&(this.style.snow||this.style.rain)&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles(),o){const k=s.q.now()-m;v.endQuery(c.TIME_ELAPSED_EXT),setTimeout(()=>{const L=v.getQueryParameter(o,v.QUERY_RESULT)/1e6;v.deleteQuery(o),this.fire(new s.z("gpu-timing-frame",{cpuTime:k,gpuTime:L}))},50)}if(this.listens("gpu-timing-layer")){const k=this.painter.collectGpuTimers();setTimeout(()=>{const L=this.painter.queryGpuTimers(k);this.fire(new s.z("gpu-timing-layer",{layerTimes:L}))},50)}if(this.listens("gpu-timing-deferred-render")){const k=this.painter.collectDeferredRenderGpuQueries();setTimeout(()=>{const L=this.painter.queryGpuTimeDeferredRender(k);this.fire(new s.z("gpu-timing-deferred-render",{gpuTime:L}))},50)}const O=this._sourcesDirty||this._styleDirty||this._placementDirty||A;if(O||this._repaint)this.triggerRepaint();else{const k=this.idle();if(k&&(A=this._updateAverageElevation(m,!0)),A)this.triggerRepaint();else if(this._triggerFrame(!1),k&&(this.fire(new s.z("idle")),this._isInitialLoad=!1,this.speedIndexTiming)){const L=this._calculateSpeedIndex();this.fire(new s.z("speedindexcompleted",{speedIndex:L})),this.speedIndexTiming=!1}}!this._loaded||this._fullyLoaded||O||(this._fullyLoaded=!0,F.mark(B.fullLoad),this._performanceMetricsCollection&&br(this._requestManager._customAccessToken,{width:this.painter.width,height:this.painter.height,interactionRange:this._interactionRange,visibilityHidden:this._visibilityHidden,terrainEnabled:!!this.painter.style.getTerrain(),fogEnabled:!!this.painter.style.getFog(),projection:this.getProjection().name,zoom:this.transform.zoom,renderer:this.painter.context.renderer,vendor:this.painter.context.vendor}),this._authenticate())}_forceMarkerAndPopupUpdate(p){for(const o of this._markers)p&&!this.getRenderWorldCopies()&&(o._lngLat=o._lngLat.wrap()),o._update();for(const o of this._popups)!p||this.getRenderWorldCopies()||o._trackPointer||(o._lngLat=o._lngLat.wrap()),o._update()}_updateAverageElevation(p,o=!1){const c=v=>(this.transform.averageElevation=v,this._update(!1),!0);if(!this.painter.averageElevationNeedsEasing())return this.transform.averageElevation!==0&&c(0);const m=this.transform.elevation&&this.transform.elevation.exaggeration()!==this._averageElevationExaggeration;if(m||(o||p-this._averageElevationLastSampledAt>500)&&!this._averageElevation.isEasing(p)){const v=this.transform.averageElevation;let b=this.transform.sampleAverageElevation();this.transform.elevation!=null&&(this._averageElevationExaggeration=this.transform.elevation.exaggeration()),isNaN(b)?b=0:this._averageElevationLastSampledAt=p;const A=Math.abs(v-b);if(A>1){if(this._isInitialLoad||m)return this._averageElevation.jumpTo(b),c(b);this._averageElevation.easeTo(b,p,300)}else if(A>1e-4)return this._averageElevation.jumpTo(b),c(b)}return!!this._averageElevation.isEasing(p)&&c(this._averageElevation.getValue(p))}_authenticate(){Re(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,p=>{if(p&&(p.message===Pi||p.status===401)){const o=this.painter.context.gl;Xn(o,!1),this._logoControl instanceof ps&&this._logoControl._updateLogo(),o&&o.clear(o.DEPTH_BUFFER_BIT|o.COLOR_BUFFER_BIT|o.STENCIL_BUFFER_BIT),this._silenceAuthErrors||this.fire(new s.y(new Error("A valid Mapbox access token is required to use Mapbox GL JS. To create an account or a new access token, visit https://account.mapbox.com/")))}}),$s(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,()=>{})}_postStyleLoadEvent(){this.style.globalId&&cs(this._requestManager._customAccessToken,{map:this,skuToken:this._requestManager._skuToken,style:this.style.globalId,importedStyles:this.style.getImportGlobalIds()})}_updateTerrain(){const p=this._isDragging();this.painter.updateTerrain(this.style,p)}_calculateSpeedIndex(){const p=this.painter.canvasCopy(),o=this.painter.getCanvasCopiesAndTimestamps();o.timeStamps.push(performance.now());const c=this.painter.context.gl,m=c.createFramebuffer();function v(b){c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_2D,b,0);const A=new Uint8Array(c.drawingBufferWidth*c.drawingBufferHeight*4);return c.readPixels(0,0,c.drawingBufferWidth,c.drawingBufferHeight,c.RGBA,c.UNSIGNED_BYTE,A),A}return c.bindFramebuffer(c.FRAMEBUFFER,m),this._canvasPixelComparison(v(p),o.canvasCopies.map(v),o.timeStamps)}_canvasPixelComparison(p,o,c){let m=c[1]-c[0];const v=p.length/4;for(let b=0;b<o.length;b++){const A=o[b];let M=0;for(let O=0;O<A.length;O+=4)A[O]===p[O]&&A[O+1]===p[O+1]&&A[O+2]===p[O+2]&&A[O+3]===p[O+3]&&(M+=1);m+=(c[b+2]-c[b+1])*(1-M/v)}return m}remove(){this._hash&&this._hash.remove();for(const o of this._controls)o.onRemove(this);this._controls=[],this._frame&&(this._frame.cancel(),this._frame=null),this._renderTaskQueue.clear(),this._domRenderTaskQueue.clear(),this.style&&this.style.destroy(),this.indoor.destroy(),this.painter.destroy(),this.handlers&&this.handlers.destroy(),this.handlers=void 0,this.setStyle(null),window.removeEventListener("resize",this._onWindowResize,!1),window.removeEventListener("orientationchange",this._onWindowResize,!1),window.removeEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.removeEventListener("online",this._onWindowOnline,!1),window.removeEventListener("visibilitychange",this._onVisibilityChange,!1);const p=this.painter.context.gl.getExtension("WEBGL_lose_context");p&&p.loseContext(),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvasContainer.remove(),this._controlContainer.remove(),this._missingCSSCanary.remove(),this._canvas=void 0,this._canvasContainer=void 0,this._controlContainer=void 0,this._missingCSSCanary=void 0,this._container.classList.remove("mapboxgl-map"),this._container.removeEventListener("scroll",this._onMapScroll,!1),sr.delete(this.painter.context.gl),kn.remove(),si.remove(),this._removed=!0,this.fire(new s.z("remove"))}triggerRepaint(){this._triggerFrame(!0)}_triggerFrame(p){this._renderNextFrame=this._renderNextFrame||p,this.style&&!this._frame&&(this._frame=s.q.frame(o=>{const c=!!this._renderNextFrame;this._frame=null,this._renderNextFrame=null,c&&this._render(o)}))}_preloadTiles(p){const o=this.style?this.style.getSourceCaches():[];return s.bl(o,(c,m)=>c._preloadTiles(p,m),()=>{this.triggerRepaint()}),this}_onWindowOnline(){this._update()}_onWindowResize(p){this._trackResize&&this.resize({originalEvent:p})._update()}_onVisibilityChange(){document.visibilityState==="hidden"&&this._visibilityHidden++}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(p){this._showTileBoundaries!==p&&(this._showTileBoundaries=p,this._tp.refreshUI(),this._update())}get showParseStatus(){return!!this._showParseStatus}set showParseStatus(p){this._showParseStatus!==p&&(this._showParseStatus=p,this._tp.refreshUI(),this._update())}get showTerrainWireframe(){return!!this._showTerrainWireframe}set showTerrainWireframe(p){this._showTerrainWireframe!==p&&(this._showTerrainWireframe=p,this._tp.refreshUI(),this._update())}get showLayers2DWireframe(){return!!this._showLayers2DWireframe}set showLayers2DWireframe(p){this._showLayers2DWireframe!==p&&(this._showLayers2DWireframe=p,this._tp.refreshUI(),this._update())}get showLayers3DWireframe(){return!!this._showLayers3DWireframe}set showLayers3DWireframe(p){this._showLayers3DWireframe!==p&&(this._showLayers3DWireframe=p,this._tp.refreshUI(),this._update())}get speedIndexTiming(){return!!this._speedIndexTiming}set speedIndexTiming(p){this._speedIndexTiming!==p&&(this._speedIndexTiming=p,this._update())}get showPadding(){return!!this._showPadding}set showPadding(p){this._showPadding!==p&&(this._showPadding=p,this._tp.refreshUI(),this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(p){this._showCollisionBoxes!==p&&(this._showCollisionBoxes=p,this._tp.refreshUI(),p?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(p){this._showOverdrawInspector!==p&&(this._showOverdrawInspector=p,this._tp.refreshUI(),this._update())}get repaint(){return!!this._repaint}set repaint(p){this._repaint!==p&&(this._repaint=p,this._tp.refreshUI(),this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(p){this._vertices=p,this._update()}get showTileAABBs(){return!!this._showTileAABBs}set showTileAABBs(p){this._showTileAABBs!==p&&(this._showTileAABBs=p,this._tp.refreshUI(),p&&this._update())}_setCacheLimits(p,o){s.dG(p,o)}get version(){return T}},NavigationControl:class{constructor(p={}){this.options=s.l({},av,p),this._container=K("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._container.addEventListener("contextmenu",o=>o.preventDefault()),this.options.showZoom&&(s.aP(["_setButtonTitle","_updateZoomButtons"],this),this._zoomInButton=this._createButton("mapboxgl-ctrl-zoom-in",o=>{this._map&&this._map.zoomIn({},{originalEvent:o})}),K("span","mapboxgl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("mapboxgl-ctrl-zoom-out",o=>{this._map&&this._map.zoomOut({},{originalEvent:o})}),K("span","mapboxgl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(s.aP(["_rotateCompassArrow"],this),this._compass=this._createButton("mapboxgl-ctrl-compass",o=>{const c=this._map;c&&(this.options.visualizePitch?c.resetNorthPitch({},{originalEvent:o}):c.resetNorth({},{originalEvent:o}))}),this._compassIcon=K("span","mapboxgl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}_updateZoomButtons(){const p=this._map;if(!p)return;const o=p.getZoom(),c=o===p.getMaxZoom(),m=o===p.getMinZoom();this._zoomInButton.disabled=c,this._zoomOutButton.disabled=m,this._zoomInButton.setAttribute("aria-disabled",c.toString()),this._zoomOutButton.setAttribute("aria-disabled",m.toString())}_rotateCompassArrow(){const p=this._map;if(!p)return;const o=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(p.transform.pitch*(Math.PI/180)),.5)}) rotateX(${p.transform.pitch}deg) rotateZ(${p.transform.angle*(180/Math.PI)}deg)`:`rotate(${p.transform.angle*(180/Math.PI)}deg)`;p._requestDomTask(()=>{this._compassIcon&&(this._compassIcon.style.transform=o)})}onAdd(p){return this._map=p,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),p.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&p.on("pitch",this._rotateCompassArrow),p.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new lv(p,this._compass,this.options.visualizePitch)),this._container}onRemove(){const p=this._map;p&&(this._container.remove(),this.options.showZoom&&p.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&p.off("pitch",this._rotateCompassArrow),p.off("rotate",this._rotateCompassArrow),this._handler&&this._handler.off(),this._handler=void 0),this._map=void 0)}_createButton(p,o){const c=K("button",p,this._container);return c.type="button",c.addEventListener("click",o),c}_setButtonTitle(p,o){if(!this._map)return;const c=this._map._getUIString(`NavigationControl.${o}`);p.setAttribute("aria-label",c),p.firstElementChild&&p.firstElementChild.setAttribute("title",c)}},GeolocateControl:class extends s.E{constructor(p={}){super();const o=navigator.geolocation;this.options=s.l({geolocation:o},Dn,p),s.aP(["_onSuccess","_onError","_onZoom","_finish","_setupUI","_updateCamera","_updateMarker","_updateMarkerRotation","_onDeviceOrientation"],this),this._updateMarkerRotationThrottled=Sh(this._updateMarkerRotation,20),this._numberOfWatches=0}onAdd(p){return this._map=p,this._container=K("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkGeolocationSupport(this._setupUI),this._container}onRemove(){this._geolocationWatchID!==void 0&&(this.options.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),this._container.remove(),this._map.off("zoom",this._onZoom),this._map=void 0,this._numberOfWatches=0,this._noTimeout=!1}_checkGeolocationSupport(p){const o=(c=!!this.options.geolocation)=>{this._supportsGeolocation=c,p(c)};this._supportsGeolocation!==void 0?p(this._supportsGeolocation):navigator.permissions!==void 0?navigator.permissions.query({name:"geolocation"}).then(c=>o(c.state!=="denied")).catch(()=>o()):o()}_isOutOfMapMaxBounds(p){const o=this._map.getMaxBounds(),c=p.coords;return!!o&&(c.longitude<o.getWest()||c.longitude>o.getEast()||c.latitude<o.getSouth()||c.latitude>o.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting")}}_onSuccess(p){if(this._map){if(this._isOutOfMapMaxBounds(p))return this._setErrorState(),this.fire(new s.z("outofmaxbounds",p)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=p,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background")}this.options.showUserLocation&&this._watchState!=="OFF"&&this._updateMarker(p),this.options.trackUserLocation&&this._watchState!=="ACTIVE_LOCK"||this._updateCamera(p),this.options.showUserLocation&&this._userLocationDotMarker.removeClassName("mapboxgl-user-location-dot-stale"),this.fire(new s.z("geolocate",p)),this._finish()}}_updateCamera(p){const o=new s.bO(p.coords.longitude,p.coords.latitude),c=p.coords.accuracy,m=this._map.getBearing(),v=s.l({bearing:m},this.options.fitBoundsOptions);this._map.fitBounds(o.toBounds(c),v,{geolocateSource:!0})}_updateMarker(p){if(p){const o=new s.bO(p.coords.longitude,p.coords.latitude);this._accuracyCircleMarker.setLngLat(o).addTo(this._map),this._userLocationDotMarker.setLngLat(o).addTo(this._map),this._accuracy=p.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()}_updateCircleRadius(){const p=this._map.transform,o=s.bH(1,p._center.lat)*p.worldSize,c=Math.ceil(2*this._accuracy*o);this._circleElement.style.width=`${c}px`,this._circleElement.style.height=`${c}px`}_onZoom(){this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}_updateMarkerRotation(){this._userLocationDotMarker&&typeof this._heading=="number"?(this._userLocationDotMarker.setRotation(this._heading),this._userLocationDotMarker.addClassName("mapboxgl-user-location-show-heading")):(this._userLocationDotMarker.removeClassName("mapboxgl-user-location-show-heading"),this._userLocationDotMarker.setRotation(0))}_onError(p){if(this._map){if(this.options.trackUserLocation)if(p.code===1){this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const o=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.setAttribute("aria-label",o),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",o),this._geolocationWatchID!==void 0&&this._clearWatch()}else{if(p.code===3&&this._noTimeout)return;this._setErrorState()}this._watchState!=="OFF"&&this.options.showUserLocation&&this._userLocationDotMarker.addClassName("mapboxgl-user-location-dot-stale"),this.fire(new s.z("error",p)),this._finish()}}_finish(){this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0}_setupUI(p){if(this._map!==void 0){if(this._container.addEventListener("contextmenu",o=>o.preventDefault()),this._geolocateButton=K("button","mapboxgl-ctrl-geolocate",this._container),K("span","mapboxgl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",p===!1){s.w("Geolocation support is not available so the GeolocateControl will be disabled.");const o=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.setAttribute("aria-label",o),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",o)}else{const o=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.setAttribute("aria-label",o),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",o)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=K("div","mapboxgl-user-location"),this._dotElement.appendChild(K("div","mapboxgl-user-location-dot")),this._dotElement.appendChild(K("div","mapboxgl-user-location-heading")),this._userLocationDotMarker=new ks({element:this._dotElement,rotationAlignment:"map",pitchAlignment:"map"}),this._circleElement=K("div","mapboxgl-user-location-accuracy-circle"),this._accuracyCircleMarker=new ks({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",this.trigger.bind(this)),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",o=>{o.geolocateSource||this._watchState!=="ACTIVE_LOCK"||o.originalEvent&&o.originalEvent.type==="resize"||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this.fire(new s.z("trackuserlocationend")))})}}_onDeviceOrientation(p){this._userLocationDotMarker&&(p.webkitCompassHeading?this._heading=p.webkitCompassHeading:p.absolute===!0&&(this._heading=-1*p.alpha),this._updateMarkerRotationThrottled())}trigger(){if(!this._setup)return s.w("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new s.z("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":this._numberOfWatches--,this._noTimeout=!1,this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this.fire(new s.z("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new s.z("trackuserlocationstart"))}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"BACKGROUND":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background");break;case"BACKGROUND_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error")}if(this._watchState==="OFF"&&this._geolocationWatchID!==void 0)this._clearWatch();else if(this._geolocationWatchID===void 0){let p;this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),this._numberOfWatches++,this._numberOfWatches>1?(p={maximumAge:6e5,timeout:0},this._noTimeout=!0):(p=this.options.positionOptions,this._noTimeout=!1),this._geolocationWatchID=this.options.geolocation.watchPosition(this._onSuccess,this._onError,p),this.options.showUserHeading&&this._addDeviceOrientationListener()}}else this.options.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=window.setTimeout(this._finish,1e4);return!0}_addDeviceOrientationListener(){const p=()=>{"ondeviceorientationabsolute"in window?window.addEventListener("deviceorientationabsolute",this._onDeviceOrientation):window.addEventListener("deviceorientation",this._onDeviceOrientation)};typeof DeviceMotionEvent<"u"&&typeof DeviceMotionEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(o=>{o==="granted"&&p()}).catch(console.error):p()}_clearWatch(){this.options.geolocation.clearWatch(this._geolocationWatchID),window.removeEventListener("deviceorientation",this._onDeviceOrientation),window.removeEventListener("deviceorientationabsolute",this._onDeviceOrientation),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},AttributionControl:Rh,ScaleControl:class{constructor(p={}){this.options=s.l({},es,p),this._isNumberFormatSupported=function(){try{return new Intl.NumberFormat("en",{style:"unit",unitDisplay:"short",unit:"meter"}),!0}catch{return!1}}(),s.aP(["_update","_setScale","setUnit"],this)}getDefaultPosition(){return"bottom-left"}_update(){const p=this.options.maxWidth||100,o=this._map,c=o._containerHeight/2,m=o._containerWidth/2-p/2,v=o.unproject([m,c]),b=o.unproject([m+p,c]),A=v.distanceTo(b);if(this.options.unit==="imperial"){const M=3.2808*A;M>5280?this._setScale(p,M/5280,"mile"):this._setScale(p,M,"foot")}else this.options.unit==="nautical"?this._setScale(p,A/1852,"nautical-mile"):A>=1e3?this._setScale(p,A/1e3,"kilometer"):this._setScale(p,A,"meter")}_setScale(p,o,c){this._map._requestDomTask(()=>{const m=function(b){const A=Math.pow(10,`${Math.floor(b)}`.length-1);let M=b/A;return M=M>=10?10:M>=5?5:M>=3?3:M>=2?2:M>=1?1:function(O){const k=Math.pow(10,Math.ceil(-Math.log(O)/Math.LN10));return Math.round(O*k)/k}(M),A*M}(o),v=m/o;this._container.innerHTML=this._isNumberFormatSupported&&c!=="nautical-mile"?new Intl.NumberFormat(this._language,{style:"unit",unitDisplay:"short",unit:c}).format(m):`${m}&nbsp;${an[c]}`,this._container.style.width=p*v+"px"})}onAdd(p){return this._map=p,this._language=p.getLanguage(),this._container=K("div","mapboxgl-ctrl mapboxgl-ctrl-scale",p.getContainer()),this._container.dir="auto",this._map.on("move",this._update),this._update(),this._container}onRemove(){this._container.remove(),this._map.off("move",this._update),this._map=void 0}_setLanguage(p){this._language=p,this._update()}setUnit(p){this.options.unit=p,this._update()}},FullscreenControl:class{constructor(p={}){this._fullscreen=!1,p&&p.container&&(p.container instanceof HTMLElement?this._container=p.container:s.w("Full screen control 'container' must be a DOM element.")),s.aP(["_onClickFullscreen","_changeIcon"],this),"onfullscreenchange"in document?this._fullscreenchange="fullscreenchange":"onwebkitfullscreenchange"in document&&(this._fullscreenchange="webkitfullscreenchange")}onAdd(p){return this._map=p,this._container||(this._container=this._map.getContainer()),this._controlContainer=K("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkFullscreenSupport()?this._setupUI():(this._controlContainer.style.display="none",s.w("This device does not support fullscreen mode.")),this._controlContainer}onRemove(){this._controlContainer.remove(),this._map=null,document.removeEventListener(this._fullscreenchange,this._changeIcon)}_checkFullscreenSupport(){return!(!document.fullscreenEnabled&&!document.webkitFullscreenEnabled)}_setupUI(){const p=this._fullscreenButton=K("button","mapboxgl-ctrl-fullscreen",this._controlContainer);K("span","mapboxgl-ctrl-icon",p).setAttribute("aria-hidden","true"),p.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),document.addEventListener(this._fullscreenchange,this._changeIcon)}_updateTitle(){const p=this._getTitle();this._fullscreenButton.setAttribute("aria-label",p),this._fullscreenButton.firstElementChild&&this._fullscreenButton.firstElementChild.setAttribute("title",p)}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_changeIcon(){(document.fullscreenElement||document.webkitFullscreenElement)===this._container!==this._fullscreen&&(this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("mapboxgl-ctrl-shrink"),this._fullscreenButton.classList.toggle("mapboxgl-ctrl-fullscreen"),this._updateTitle())}_onClickFullscreen(){this._isFullscreen()?document.exitFullscreen?document.exitFullscreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen():this._container.requestFullscreen?this._container.requestFullscreen():this._container.webkitRequestFullscreen&&this._container.webkitRequestFullscreen()}},Popup:class extends s.E{constructor(p){super(),this.options=s.l(Object.create(M_),p),s.aP(["_update","_onClose","remove","_onMouseEvent"],this),this._classList=new Set(p&&p.className?p.className.trim().split(/\s+/):[])}addTo(p){return this._map&&this.remove(),this._map=p,this.options.closeOnClick&&p.on("preclick",this._onClose),this.options.closeOnMove&&p.on("move",this._onClose),p.on("remove",this.remove),this._update(),p._addPopup(this),this._focusFirstElement(),this._trackPointer?(p.on("mousemove",this._onMouseEvent),p.on("mouseup",this._onMouseEvent),p._canvasContainer.classList.add("mapboxgl-track-pointer")):p.on("move",this._update),this.fire(new s.z("open")),this}isOpen(){return!!this._map}remove(){this._content&&this._content.remove(),this._container&&(this._container.remove(),this._container=void 0);const p=this._map;return p&&(p.off("move",this._update),p.off("move",this._onClose),p.off("preclick",this._onClose),p.off("click",this._onClose),p.off("remove",this.remove),p.off("mousemove",this._onMouseEvent),p.off("mouseup",this._onMouseEvent),p.off("drag",this._onMouseEvent),p._canvasContainer&&p._canvasContainer.classList.remove("mapboxgl-track-pointer"),p._removePopup(this),this._map=void 0),this.fire(new s.z("close")),this}getLngLat(){return this._lngLat}setLngLat(p){this._lngLat=s.bO.convert(p),this._pos=null,this._trackPointer=!1,this._update();const o=this._map;return o&&(o.on("move",this._update),o.off("mousemove",this._onMouseEvent),o._canvasContainer.classList.remove("mapboxgl-track-pointer")),this}trackPointer(){this._trackPointer=!0,this._pos=null,this._update();const p=this._map;return p&&(p.off("move",this._update),p.on("mousemove",this._onMouseEvent),p.on("drag",this._onMouseEvent),p._canvasContainer.classList.add("mapboxgl-track-pointer")),this}getElement(){return this._container}setText(p){return this.setDOMContent(document.createTextNode(p))}setHTML(p){const o=document.createDocumentFragment(),c=document.createElement("body");let m;for(c.innerHTML=p;m=c.firstChild,m;)o.appendChild(m);return this.setDOMContent(o)}getMaxWidth(){return this._container&&this._container.style.maxWidth}setMaxWidth(p){return this.options.maxWidth=p,this._update(),this}setDOMContent(p){let o=this._content;if(o)for(;o.hasChildNodes();)o.firstChild&&o.removeChild(o.firstChild);else o=this._content=K("div","mapboxgl-popup-content",this._container||void 0);if(o.appendChild(p),this.options.closeButton){const c=this._closeButton=K("button","mapboxgl-popup-close-button",o);c.type="button",c.setAttribute("aria-label","Close popup"),c.innerHTML='<span aria-hidden="true">&#215;</span>',c.addEventListener("click",this._onClose)}return this._update(),this._focusFirstElement(),this}addClassName(p){return this._classList.add(p),this._updateClassList(),this}removeClassName(p){return this._classList.delete(p),this._updateClassList(),this}setOffset(p){return this.options.offset=p,this._update(),this}toggleClassName(p){let o;return this._classList.delete(p)?o=!1:(this._classList.add(p),o=!0),this._updateClassList(),o}_onMouseEvent(p){this._update(p.point)}_getAnchor(p){if(this.options.anchor)return this.options.anchor;const o=this._map,c=this._container,m=this._pos;if(!o||!c||!m)return"bottom";const v=c.offsetWidth,b=c.offsetHeight,A=m.x<v/2,M=m.x>o.transform.width-v/2;if(m.y+p<b)return A?"top-left":M?"top-right":"top";if(m.y>o.transform.height-b){if(A)return"bottom-left";if(M)return"bottom-right"}return A?"left":M?"right":"bottom"}_updateClassList(){const p=this._container;if(!p)return;const o=[...this._classList];o.push("mapboxgl-popup"),this._anchor&&o.push(`mapboxgl-popup-anchor-${this._anchor}`),this._trackPointer&&o.push("mapboxgl-popup-track-pointer"),p.className=o.join(" ")}_update(p){const o=this._map,c=this._content;if(!o||!this._lngLat&&!this._trackPointer||!c)return;let m=this._container;if(m||(m=this._container=K("div","mapboxgl-popup",o.getContainer()),this._tip=K("div","mapboxgl-popup-tip",m),m.appendChild(c)),this.options.maxWidth&&m.style.maxWidth!==this.options.maxWidth&&(m.style.maxWidth=this.options.maxWidth),o.transform.renderWorldCopies&&!this._trackPointer&&(this._lngLat=Ph(this._lngLat,this._pos,o.transform)),!this._trackPointer||p){const v=this._pos=this._trackPointer&&p instanceof s.P?p:o.project(this._lngLat),b=Yf(this.options.offset),A=this._anchor=this._getAnchor(b.y),M=Yf(this.options.offset,A),O=v.add(M).round();o._requestDomTask(()=>{this._container&&A&&(this._container.style.transform=`${so[A]} translate(${O.x}px,${O.y}px)`)})}if(!this._marker&&o._showingGlobe()){const v=s.dH(o.transform,this._lngLat)?0:1;this._setOpacity(v)}this._updateClassList()}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const p=this._container.querySelector(jn);p&&p.focus()}_onClose(){this.remove()}_setOpacity(p){this._container&&(this._container.style.opacity=`${p}`),this._content&&(this._content.style.pointerEvents=p?"auto":"none")}},Marker:ks,Style:Es,LngLat:s.bO,LngLatBounds:s.az,Point:s.P,MercatorCoordinate:s.aa,FreeCameraOptions:Ku,Evented:s.E,config:s.e,prewarm:s.dM,clearPrewarmedResources:s.dN,get accessToken(){return s.e.ACCESS_TOKEN},set accessToken(p){s.e.ACCESS_TOKEN=p},get baseApiUrl(){return s.e.API_URL},set baseApiUrl(p){s.e.API_URL=p},get workerCount(){return s.dO.workerCount},set workerCount(p){s.dO.workerCount=p},get maxParallelImageRequests(){return s.e.MAX_PARALLEL_IMAGE_REQUESTS},set maxParallelImageRequests(p){s.e.MAX_PARALLEL_IMAGE_REQUESTS=p},clearStorage(p){s.dP(p)},get workerUrl(){return s.dQ.workerUrl},set workerUrl(p){s.dQ.workerUrl=p},get workerClass(){return s.dQ.workerClass},set workerClass(p){s.dQ.workerClass=p},get workerParams(){return s.dQ.workerParams},set workerParams(p){s.dQ.workerParams=p},get dracoUrl(){return s.dR()},set dracoUrl(p){s.dS(p)},get meshoptUrl(){return s.dT()},set meshoptUrl(p){s.dU(p)},setNow:s.q.setNow,restoreNow:s.q.restoreNow}});var y=a;return y})}(ry)),ry.exports}var PB=hY();const BB=OC(PB),dY=WF({__proto__:null,default:BB},[PB]),fY=Ot.createContext(null);function pY(i,e){const t=Array.isArray(i)?i[0]:i?i.x:0,r=Array.isArray(i)?i[1]:i?i.y:0,a=Array.isArray(e)?e[0]:e?e.x:0,h=Array.isArray(e)?e[1]:e?e.y:0;return t===a&&r===h}function Qa(i,e){if(i===e)return!0;if(!i||!e)return!1;if(Array.isArray(i)){if(!Array.isArray(e)||i.length!==e.length)return!1;for(let t=0;t<i.length;t++)if(!Qa(i[t],e[t]))return!1;return!0}else if(Array.isArray(e))return!1;if(typeof i=="object"&&typeof e=="object"){const t=Object.keys(i),r=Object.keys(e);if(t.length!==r.length)return!1;for(const a of t)if(!e.hasOwnProperty(a)||!Qa(i[a],e[a]))return!1;return!0}return!1}function mY(i){const e=i.clone();return e.pixelsToGLUnits=i.pixelsToGLUnits,e}function wC(i,e){if(!i.getProjection)return;const t=i.getProjection(),r=e.getProjection();Qa(t,r)||e.setProjection(t)}function AC(i){return{longitude:i.center.lng,latitude:i.center.lat,zoom:i.zoom,pitch:i.pitch,bearing:i.bearing,padding:i.padding}}function TC(i,e){const t=e.viewState||e;let r=!1;if("zoom"in t){const a=i.zoom;i.zoom=t.zoom,r=r||a!==i.zoom}if("bearing"in t){const a=i.bearing;i.bearing=t.bearing,r=r||a!==i.bearing}if("pitch"in t){const a=i.pitch;i.pitch=t.pitch,r=r||a!==i.pitch}if(t.padding&&!i.isPaddingEqual(t.padding)&&(r=!0,i.padding=t.padding),"longitude"in t&&"latitude"in t){const a=i.center;i.center=new a.constructor(t.longitude,t.latitude),r=r||a!==i.center}return r}const _Y=["type","source","source-layer","minzoom","maxzoom","filter","layout"];function EC(i){if(!i)return null;if(typeof i=="string"||("toJS"in i&&(i=i.toJS()),!i.layers))return i;const e={};for(const r of i.layers)e[r.id]=r;const t=i.layers.map(r=>{let a=null;"interactive"in r&&(a=Object.assign({},r),delete a.interactive);const h=e[r.ref];if(h){a=a||Object.assign({},r),delete a.ref;for(const y of _Y)y in h&&(a[y]=h[y])}return a||r});return{...i,layers:t}}var SC={};const IC={version:8,sources:{},layers:[]},CC={mousedown:"onMouseDown",mouseup:"onMouseUp",mouseover:"onMouseOver",mousemove:"onMouseMove",click:"onClick",dblclick:"onDblClick",mouseenter:"onMouseEnter",mouseleave:"onMouseLeave",mouseout:"onMouseOut",contextmenu:"onContextMenu",touchstart:"onTouchStart",touchend:"onTouchEnd",touchmove:"onTouchMove",touchcancel:"onTouchCancel"},i1={movestart:"onMoveStart",move:"onMove",moveend:"onMoveEnd",dragstart:"onDragStart",drag:"onDrag",dragend:"onDragEnd",zoomstart:"onZoomStart",zoom:"onZoom",zoomend:"onZoomEnd",rotatestart:"onRotateStart",rotate:"onRotate",rotateend:"onRotateEnd",pitchstart:"onPitchStart",pitch:"onPitch",pitchend:"onPitchEnd"},MC={wheel:"onWheel",boxzoomstart:"onBoxZoomStart",boxzoomend:"onBoxZoomEnd",boxzoomcancel:"onBoxZoomCancel",resize:"onResize",load:"onLoad",render:"onRender",idle:"onIdle",remove:"onRemove",data:"onData",styledata:"onStyleData",sourcedata:"onSourceData",error:"onError"},gY=["minZoom","maxZoom","minPitch","maxPitch","maxBounds","projection","renderWorldCopies"],yY=["scrollZoom","boxZoom","dragRotate","dragPan","keyboard","doubleClickZoom","touchZoomRotate","touchPitch"];class Id{constructor(e,t,r){this._map=null,this._internalUpdate=!1,this._inRender=!1,this._hoveredFeatures=null,this._deferredEvents={move:!1,zoom:!1,pitch:!1,rotate:!1},this._onEvent=a=>{const h=this.props[MC[a.type]];h?h(a):a.type==="error"&&console.error(a.error)},this._onPointerEvent=a=>{(a.type==="mousemove"||a.type==="mouseout")&&this._updateHover(a);const h=this.props[CC[a.type]];h&&(this.props.interactiveLayerIds&&a.type!=="mouseover"&&a.type!=="mouseout"&&(a.features=this._hoveredFeatures||this._queryRenderedFeatures(a.point)),h(a),delete a.features)},this._onCameraEvent=a=>{if(!this._internalUpdate){const h=this.props[i1[a.type]];h&&h(a)}a.type in this._deferredEvents&&(this._deferredEvents[a.type]=!1)},this._MapClass=e,this.props=t,this._initialize(r)}get map(){return this._map}get transform(){return this._renderTransform}setProps(e){const t=this.props;this.props=e;const r=this._updateSettings(e,t);r&&this._createShadowTransform(this._map);const a=this._updateSize(e),h=this._updateViewState(e,!0);this._updateStyle(e,t),this._updateStyleComponents(e,t),this._updateHandlers(e,t),(r||a||h&&!this._map.isMoving())&&this.redraw()}static reuse(e,t){const r=Id.savedMaps.pop();if(!r)return null;const a=r.map,h=a.getContainer();for(t.className=h.className;h.childNodes.length>0;)t.appendChild(h.childNodes[0]);a._container=t;const y=a._resizeObserver;y&&(y.disconnect(),y.observe(t)),r.setProps({...e,styleDiffing:!1}),a.resize();const{initialViewState:s}=e;return s&&(s.bounds?a.fitBounds(s.bounds,{...s.fitBoundsOptions,duration:0}):r._updateViewState(s,!1)),a.isStyleLoaded()?a.fire("load"):a.once("styledata",()=>a.fire("load")),a._update(),r}_initialize(e){const{props:t}=this,{mapStyle:r=IC}=t,a={...t,...t.initialViewState,accessToken:t.mapboxAccessToken||vY()||null,container:e,style:EC(r)},h=a.initialViewState||a.viewState||a;if(Object.assign(a,{center:[h.longitude||0,h.latitude||0],zoom:h.zoom||0,pitch:h.pitch||0,bearing:h.bearing||0}),t.gl){const F=HTMLCanvasElement.prototype.getContext;HTMLCanvasElement.prototype.getContext=()=>(HTMLCanvasElement.prototype.getContext=F,t.gl)}const y=new this._MapClass(a);h.padding&&y.setPadding(h.padding),t.cursor&&(y.getCanvas().style.cursor=t.cursor),this._createShadowTransform(y);const s=y._render;y._render=F=>{this._inRender=!0,s.call(y,F),this._inRender=!1};const T=y._renderTaskQueue.run;y._renderTaskQueue.run=F=>{T.call(y._renderTaskQueue,F),this._onBeforeRepaint()},y.on("render",()=>this._onAfterRepaint());const B=y.fire;y.fire=this._fireEvent.bind(this,B),y.on("resize",()=>{this._renderTransform.resize(y.transform.width,y.transform.height)}),y.on("styledata",()=>{this._updateStyleComponents(this.props,{}),wC(y.transform,this._renderTransform)}),y.on("sourcedata",()=>this._updateStyleComponents(this.props,{}));for(const F in CC)y.on(F,this._onPointerEvent);for(const F in i1)y.on(F,this._onCameraEvent);for(const F in MC)y.on(F,this._onEvent);this._map=y}recycle(){const t=this.map.getContainer().querySelector("[mapboxgl-children]");t==null||t.remove(),Id.savedMaps.push(this)}destroy(){this._map.remove()}redraw(){const e=this._map;!this._inRender&&e.style&&(e._frame&&(e._frame.cancel(),e._frame=null),e._render())}_createShadowTransform(e){const t=mY(e.transform);e.painter.transform=t,this._renderTransform=t}_updateSize(e){const{viewState:t}=e;if(t){const r=this._map;if(t.width!==r.transform.width||t.height!==r.transform.height)return r.resize(),!0}return!1}_updateViewState(e,t){if(this._internalUpdate)return!1;const r=this._map,a=this._renderTransform,{zoom:h,pitch:y,bearing:s}=a,T=r.isMoving();T&&(a.cameraElevationReference="sea");const B=TC(a,{...AC(r.transform),...e});if(T&&(a.cameraElevationReference="ground"),B&&t){const F=this._deferredEvents;F.move=!0,F.zoom||(F.zoom=h!==a.zoom),F.rotate||(F.rotate=s!==a.bearing),F.pitch||(F.pitch=y!==a.pitch)}return T||TC(r.transform,e),B}_updateSettings(e,t){const r=this._map;let a=!1;for(const h of gY)if(h in e&&!Qa(e[h],t[h])){a=!0;const y=r[`set${h[0].toUpperCase()}${h.slice(1)}`];y==null||y.call(r,e[h])}return a}_updateStyle(e,t){if(e.cursor!==t.cursor&&(this._map.getCanvas().style.cursor=e.cursor||""),e.mapStyle!==t.mapStyle){const{mapStyle:r=IC,styleDiffing:a=!0}=e,h={diff:a};return"localIdeographFontFamily"in e&&(h.localIdeographFontFamily=e.localIdeographFontFamily),this._map.setStyle(EC(r),h),!0}return!1}_updateStyleComponents(e,t){const r=this._map;let a=!1;return r.isStyleLoaded()&&("light"in e&&r.setLight&&!Qa(e.light,t.light)&&(a=!0,r.setLight(e.light)),"fog"in e&&r.setFog&&!Qa(e.fog,t.fog)&&(a=!0,r.setFog(e.fog)),"terrain"in e&&r.setTerrain&&!Qa(e.terrain,t.terrain)&&(!e.terrain||r.getSource(e.terrain.source))&&(a=!0,r.setTerrain(e.terrain))),a}_updateHandlers(e,t){var r,a;const h=this._map;let y=!1;for(const s of yY){const T=(r=e[s])!==null&&r!==void 0?r:!0,B=(a=t[s])!==null&&a!==void 0?a:!0;Qa(T,B)||(y=!0,T?h[s].enable(T):h[s].disable())}return y}_queryRenderedFeatures(e){const t=this._map,r=t.transform,{interactiveLayerIds:a=[]}=this.props;try{return t.transform=this._renderTransform,t.queryRenderedFeatures(e,{layers:a.filter(t.getLayer.bind(t))})}catch{return[]}finally{t.transform=r}}_updateHover(e){var t;const{props:r}=this;if(r.interactiveLayerIds&&(r.onMouseMove||r.onMouseEnter||r.onMouseLeave)){const h=e.type,y=((t=this._hoveredFeatures)===null||t===void 0?void 0:t.length)>0,s=this._queryRenderedFeatures(e.point),T=s.length>0;!T&&y&&(e.type="mouseleave",this._onPointerEvent(e)),this._hoveredFeatures=s,T&&!y&&(e.type="mouseenter",this._onPointerEvent(e)),e.type=h}else this._hoveredFeatures=null}_fireEvent(e,t,r){const a=this._map,h=a.transform,y=typeof t=="string"?t:t.type;return y==="move"&&this._updateViewState(this.props,!1),y in i1&&(typeof t=="object"&&(t.viewState=AC(h)),this._map.isMoving())?(a.transform=this._renderTransform,e.call(a,t,r),a.transform=h,a):(e.call(a,t,r),a)}_onBeforeRepaint(){const e=this._map;this._internalUpdate=!0;for(const r in this._deferredEvents)this._deferredEvents[r]&&e.fire(r);this._internalUpdate=!1;const t=this._map.transform;e.transform=this._renderTransform,this._onAfterRepaint=()=>{wC(this._renderTransform,t),e.transform=t}}}Id.savedMaps=[];function vY(){let i=null;if(typeof location<"u"){const e=/access_token=([^&\/]*)/.exec(location.search);i=e&&e[1]}try{i=i||SC.MapboxAccessToken}catch{}try{i=i||SC.REACT_APP_MAPBOX_ACCESS_TOKEN}catch{}return i}const xY=["setMaxBounds","setMinZoom","setMaxZoom","setMinPitch","setMaxPitch","setRenderWorldCopies","setProjection","setStyle","addSource","removeSource","addLayer","removeLayer","setLayerZoomRange","setFilter","setPaintProperty","setLayoutProperty","setLight","setTerrain","setFog","remove"];function bY(i){if(!i)return null;const e=i.map,t={getMap:()=>e,getCenter:()=>i.transform.center,getZoom:()=>i.transform.zoom,getBearing:()=>i.transform.bearing,getPitch:()=>i.transform.pitch,getPadding:()=>i.transform.padding,getBounds:()=>i.transform.getBounds(),project:r=>{const a=e.transform;e.transform=i.transform;const h=e.project(r);return e.transform=a,h},unproject:r=>{const a=e.transform;e.transform=i.transform;const h=e.unproject(r);return e.transform=a,h},queryTerrainElevation:(r,a)=>{const h=e.transform;e.transform=i.transform;const y=e.queryTerrainElevation(r,a);return e.transform=h,y},queryRenderedFeatures:(r,a)=>{const h=e.transform;e.transform=i.transform;const y=e.queryRenderedFeatures(r,a);return e.transform=h,y}};for(const r of wY(e))!(r in t)&&!xY.includes(r)&&(t[r]=e[r].bind(e));return t}function wY(i){const e=new Set;let t=i;for(;t;){for(const r of Object.getOwnPropertyNames(t))r[0]!=="_"&&typeof i[r]=="function"&&r!=="fire"&&r!=="setEventedParent"&&e.add(r);t=Object.getPrototypeOf(t)}return Array.from(e)}const AY=typeof document<"u"?Ot.useLayoutEffect:Ot.useEffect,TY=["baseApiUrl","maxParallelImageRequests","workerClass","workerCount","workerUrl"];function EY(i,e){for(const r of TY)r in e&&(i[r]=e[r]);const{RTLTextPlugin:t="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-rtl-text/v0.2.3/mapbox-gl-rtl-text.js"}=e;t&&i.getRTLTextPluginStatus&&i.getRTLTextPluginStatus()==="unavailable"&&i.setRTLTextPlugin(t,r=>{r&&console.error(r)},!0)}const E0=Ot.createContext(null);function SY(i,e,t){const r=Ot.useContext(fY),[a,h]=Ot.useState(null),y=Ot.useRef(),{current:s}=Ot.useRef({mapLib:null,map:null});Ot.useEffect(()=>{const F=i.mapLib;let V=!0,X;return Promise.resolve(F||t).then(se=>{if(!V)return;if(!se)throw new Error("Invalid mapLib");const ne="Map"in se?se:se.default;if(!ne.Map)throw new Error("Invalid mapLib");if(EY(ne,i),!ne.supported||ne.supported(i))i.reuseMaps&&(X=Id.reuse(i,y.current)),X||(X=new Id(ne.Map,i,y.current)),s.map=bY(X),s.mapLib=ne,h(X),r==null||r.onMapMount(s.map,i.id);else throw new Error("Map is not supported by this browser")}).catch(se=>{const{onError:ne}=i;ne?ne({type:"error",target:null,originalEvent:null,error:se}):console.error(se)}),()=>{V=!1,X&&(r==null||r.onMapUnmount(i.id),i.reuseMaps?X.recycle():X.destroy())}},[]),AY(()=>{a&&a.setProps(i)}),Ot.useImperativeHandle(e,()=>s.map,[a]);const T=Ot.useMemo(()=>({position:"relative",width:"100%",height:"100%",...i.style}),[i.style]),B={height:"100%"};return Ot.createElement("div",{id:i.id,ref:y,style:T},a&&Ot.createElement(E0.Provider,{value:s},Ot.createElement("div",{"mapboxgl-children":"",style:B},i.children)))}const IY=/box|flex|grid|column|lineHeight|fontWeight|opacity|order|tabSize|zIndex/;function ku(i,e){if(!i||!e)return;const t=i.style;for(const r in e){const a=e[r];Number.isFinite(a)&&!IY.test(r)?t[r]=`${a}px`:t[r]=a}}function CY(i,e){const{map:t,mapLib:r}=Ot.useContext(E0),a=Ot.useRef({props:i});a.current.props=i;const h=Ot.useMemo(()=>{let K=!1;Ot.Children.forEach(i.children,ke=>{ke&&(K=!0)});const ue={...i,element:K?document.createElement("div"):null},_e=new r.Marker(ue);return _e.setLngLat([i.longitude,i.latitude]),_e.getElement().addEventListener("click",ke=>{var we,ge;(ge=(we=a.current.props).onClick)===null||ge===void 0||ge.call(we,{type:"click",target:_e,originalEvent:ke})}),_e.on("dragstart",ke=>{var we,ge;const Le=ke;Le.lngLat=h.getLngLat(),(ge=(we=a.current.props).onDragStart)===null||ge===void 0||ge.call(we,Le)}),_e.on("drag",ke=>{var we,ge;const Le=ke;Le.lngLat=h.getLngLat(),(ge=(we=a.current.props).onDrag)===null||ge===void 0||ge.call(we,Le)}),_e.on("dragend",ke=>{var we,ge;const Le=ke;Le.lngLat=h.getLngLat(),(ge=(we=a.current.props).onDragEnd)===null||ge===void 0||ge.call(we,Le)}),_e},[]);Ot.useEffect(()=>(h.addTo(t.getMap()),()=>{h.remove()}),[]);const{longitude:y,latitude:s,offset:T,style:B,draggable:F=!1,popup:V=null,rotation:X=0,rotationAlignment:se="auto",pitchAlignment:ne="auto"}=i;return Ot.useEffect(()=>{ku(h.getElement(),B)},[B]),Ot.useImperativeHandle(e,()=>h,[]),(h.getLngLat().lng!==y||h.getLngLat().lat!==s)&&h.setLngLat([y,s]),T&&!pY(h.getOffset(),T)&&h.setOffset(T),h.isDraggable()!==F&&h.setDraggable(F),h.getRotation()!==X&&h.setRotation(X),h.getRotationAlignment()!==se&&h.setRotationAlignment(se),h.getPitchAlignment()!==ne&&h.setPitchAlignment(ne),h.getPopup()!==V&&h.setPopup(V),FC.createPortal(i.children,h.getElement())}Ot.memo(Ot.forwardRef(CY));function RC(i){return new Set(i?i.trim().split(/\s+/):[])}function MY(i,e){const{map:t,mapLib:r}=Ot.useContext(E0),a=Ot.useMemo(()=>document.createElement("div"),[]),h=Ot.useRef({props:i});h.current.props=i;const y=Ot.useMemo(()=>{const s={...i},T=new r.Popup(s);return T.setLngLat([i.longitude,i.latitude]),T.once("open",B=>{var F,V;(V=(F=h.current.props).onOpen)===null||V===void 0||V.call(F,B)}),T},[]);if(Ot.useEffect(()=>{const s=T=>{var B,F;(F=(B=h.current.props).onClose)===null||F===void 0||F.call(B,T)};return y.on("close",s),y.setDOMContent(a).addTo(t.getMap()),()=>{y.off("close",s),y.isOpen()&&y.remove()}},[]),Ot.useEffect(()=>{ku(y.getElement(),i.style)},[i.style]),Ot.useImperativeHandle(e,()=>y,[]),y.isOpen()&&((y.getLngLat().lng!==i.longitude||y.getLngLat().lat!==i.latitude)&&y.setLngLat([i.longitude,i.latitude]),i.offset&&!Qa(y.options.offset,i.offset)&&y.setOffset(i.offset),(y.options.anchor!==i.anchor||y.options.maxWidth!==i.maxWidth)&&(y.options.anchor=i.anchor,y.setMaxWidth(i.maxWidth)),y.options.className!==i.className)){const s=RC(y.options.className),T=RC(i.className);for(const B of s)T.has(B)||y.removeClassName(B);for(const B of T)s.has(B)||y.addClassName(B);y.options.className=i.className}return FC.createPortal(i.children,a)}Ot.memo(Ot.forwardRef(MY));function Bd(i,e,t,r){const a=Ot.useContext(E0),h=Ot.useMemo(()=>i(a),[]);return Ot.useEffect(()=>{const y=e,s=typeof e=="function"?e:null,{map:T}=a;return T.hasControl(h)||T.addControl(h,y==null?void 0:y.position),()=>{s&&s(a),T.hasControl(h)&&T.removeControl(h)}},[]),h}function RY(i){const e=Bd(({mapLib:t})=>new t.AttributionControl(i),{position:i.position});return Ot.useEffect(()=>{ku(e._container,i.style)},[i.style]),null}Ot.memo(RY);function PY(i){const e=Bd(({mapLib:t})=>new t.FullscreenControl({container:i.containerId&&document.getElementById(i.containerId)}),{position:i.position});return Ot.useEffect(()=>{ku(e._controlContainer,i.style)},[i.style]),null}Ot.memo(PY);function BY(i,e){const t=Ot.useRef({props:i}),r=Bd(({mapLib:a})=>{const h=new a.GeolocateControl(i),y=h._setupUI;return h._setupUI=s=>{h._container.hasChildNodes()||y(s)},h.on("geolocate",s=>{var T,B;(B=(T=t.current.props).onGeolocate)===null||B===void 0||B.call(T,s)}),h.on("error",s=>{var T,B;(B=(T=t.current.props).onError)===null||B===void 0||B.call(T,s)}),h.on("outofmaxbounds",s=>{var T,B;(B=(T=t.current.props).onOutOfMaxBounds)===null||B===void 0||B.call(T,s)}),h.on("trackuserlocationstart",s=>{var T,B;(B=(T=t.current.props).onTrackUserLocationStart)===null||B===void 0||B.call(T,s)}),h.on("trackuserlocationend",s=>{var T,B;(B=(T=t.current.props).onTrackUserLocationEnd)===null||B===void 0||B.call(T,s)}),h},{position:i.position});return t.current.props=i,Ot.useImperativeHandle(e,()=>r,[]),Ot.useEffect(()=>{ku(r._container,i.style)},[i.style]),null}const DY=Ot.memo(Ot.forwardRef(BY));function OY(i){const e=Bd(({mapLib:t})=>new t.NavigationControl(i),{position:i.position});return Ot.useEffect(()=>{ku(e._container,i.style)},[i.style]),null}const FY=Ot.memo(OY);function kY(i){const e=Bd(({mapLib:h})=>new h.ScaleControl(i),{position:i.position}),t=Ot.useRef(i),r=t.current;t.current=i;const{style:a}=i;return i.maxWidth!==void 0&&i.maxWidth!==r.maxWidth&&(e.options.maxWidth=i.maxWidth),i.unit!==void 0&&i.unit!==r.unit&&e.setUnit(i.unit),Ot.useEffect(()=>{ku(e._container,a)},[a]),null}Ot.memo(kY);const LY=RF(()=>Promise.resolve().then(()=>dY),void 0),NY=Ot.forwardRef(function(e,t){return SY(e,t,LY)}),zY=FY,UY=DY,VY={longitude:105.8419,latitude:21.0022,zoom:14,pitch:60,bearing:0,antialias:!0},PC=AL.mapBoxUrl,jY=i=>(Bd(()=>new v7(i)).setProps(i),null),HY=()=>{var y,s,T,B,F,V;const[i,e]=Ot.useState(null),t=new Fj({timestamp:Date.now(),color:[255,255,255],intensity:1}),r=new pP({color:[255,255,255],intensity:1}),a=new lA({sun:t,ambientLight:r}),h=()=>IL.map(X=>new TA({id:`building-layer-${X.id}`,data:[X],scenegraph:X.modelPath,getPosition:se=>se.coordinates,getOrientation:[0,0,90],sizeScale:X.scale||1,pickable:!0,onClick:()=>{console.log("Clicked building:",X.name),console.log("Clicked building:",X)},onHover:se=>{se.object?e({x:se.x,y:se.y,building:X}):e(null)}}));return Dt.jsxs(Dt.Fragment,{children:[Dt.jsxs(NY,{mapStyle:"mapbox://styles/mapbox/light-v9",mapboxAccessToken:PC,initialViewState:VY,onLoad:X=>{const se=X.target,ne=new cY({accessToken:PC,mapboxgl:BB,language:"en",placeholder:"Search for a location",types:"place,locality,neighborhood",marker:!1,flyTo:{zoom:16,speed:1.2,curve:1,easing:K=>K}});se.addControl(ne,"top-left")},children:[Dt.jsx(jY,{layers:h(),effects:[a],controller:!0}),Dt.jsx(UY,{position:"top-right"}),Dt.jsx(zY,{position:"top-right"})]}),i&&Dt.jsxs("div",{className:"absolute z-10 bg-white p-4 rounded-lg shadow-md min-w-[300px] text-dark-green",style:{left:i.x+10,top:i.y+10,pointerEvents:"none"},children:[Dt.jsx("div",{className:"text-lg font-bold mb-3 text-custom-purple",children:(y=i.building)==null?void 0:y.name}),Dt.jsxs("div",{className:"text-sm mb-2 text-dark-green flex items-center gap-2",children:[Dt.jsx("span",{className:"text-base",children:Dt.jsx(ZF,{})}),(s=i.building)==null?void 0:s.address]}),((T=i.building)==null?void 0:T.phone)&&Dt.jsxs("div",{className:"text-sm mb-2 text-dark-green flex items-center gap-2",children:[Dt.jsx("span",{className:"text-base",children:Dt.jsx(YF,{})}),i.building.phone]}),Dt.jsxs("div",{className:`text-sm mb-2 font-semibold flex items-center gap-2 
                        ${((B=i.building)==null?void 0:B.status)==="available"?"text-green-600":"text-red-600"}`,children:[Dt.jsx("span",{className:"text-base",children:Dt.jsx(XF,{})}),"Status:"," ",((F=i.building)==null?void 0:F.status)==="available"?"Available":"Full"]}),Dt.jsxs("div",{className:"text-sm text-dark-green flex items-center gap-2",children:[Dt.jsx("span",{className:"text-base",children:Dt.jsx(qF,{})}),"Patient count: ",(V=i.building)==null?void 0:V.patients]})]})]})},GY=ek(Dt.jsx("path",{d:"M7.41 15.41 12 10.83l4.59 4.58L18 14l-6-6-6 6z"}),"KeyboardArrowUp"),$Y=()=>{const[i,e]=Ot.useState(!1);Ot.useEffect(()=>{const r=()=>{const h=document.querySelector(".overflow-auto");if(h){const y=h.scrollHeight/4;h.scrollTop>y?e(!0):e(!1)}},a=document.querySelector(".overflow-auto");return a?(a.addEventListener("scroll",r),r(),()=>{a.removeEventListener("scroll",r)}):()=>{}},[]);const t=()=>{const r=document.querySelector(".overflow-auto");r&&r.scrollTo({top:0,behavior:"smooth"})};return Dt.jsx("button",{onClick:t,className:`fixed bottom-16 right-6 p-3 rounded-full bg-custom-purple text-white shadow-lg transition-all duration-300 hover:bg-[#004d40] z-[9999] ${i?"opacity-100":"opacity-0 pointer-events-none"}`,"aria-label":"Scroll to top",children:Dt.jsx(GY,{className:"w-6 h-6"})})},WY=i=>{const[e,t]=i.split("/");return`${e}/${t}`},r1=({height:i,position:e,color:t,value:r})=>{const a=Ot.useRef(null),[h,y]=Ot.useState(0),[s,T]=Ot.useState(!1),[B,F]=Ot.useState(null);return NC(!s),_w(()=>{h<i&&y(V=>Math.min(V+.04,i))}),Ot.useEffect(()=>{B&&(B.color.set(s?new vg(t).multiplyScalar(1.5):t),B.emissive.set(s?new vg(t).multiplyScalar(.2):new vg(0)))},[s,t,B]),Ot.useEffect(()=>{a.current&&a.current.position.set(e[0],h/2-1,e[2])},[h,e]),Dt.jsxs(Dt.Fragment,{children:[Dt.jsxs("mesh",{ref:a,position:[e[0],h/2-1,e[2]],onPointerOver:()=>T(!0),onPointerOut:()=>T(!1),children:[Dt.jsx("boxGeometry",{args:[.5,h,.5]}),Dt.jsx("meshStandardMaterial",{ref:F,color:t,emissive:new vg(0),emissiveIntensity:0})]}),s&&Dt.jsx(jC,{position:[e[0],h+.1,e[2]],center:!0,className:"bg-dark-green px-2.5 py-1.5 rounded text-white text-xs whitespace-nowrap pointer-events-none -translate-x-1/2 -translate-y-1/2",children:r.toLocaleString()})]})},n1=({color:i,label:e})=>Dt.jsxs("div",{className:"flex items-center gap-2",children:[Dt.jsx("div",{className:"w-4 h-4 rounded-sm",style:{backgroundColor:i}}),Dt.jsx("span",{className:"text-sm text-dark-green",children:e})]}),qY=()=>Dt.jsxs("div",{className:"flex gap-8 p-4 bg-white rounded-lg shadow-sm absolute bottom-9",children:[Dt.jsx(n1,{color:"mediumseagreen",label:"Deaths"}),Dt.jsx(n1,{color:"gold",label:"Infected"}),Dt.jsx(n1,{color:"mediumpurple",label:"Recovered"})]}),XY=()=>{const{weeklyReport:i}=zC;return i.length?Dt.jsxs("div",{className:"flex flex-col items-center gap-6 relative",children:[Dt.jsx("h2",{className:"text-xl font-bold absolute top-5 text-custom-purple uppercase",children:"Weekly COVID-19 case data report"}),Dt.jsx("div",{className:"w-full h-[500px]",children:Dt.jsxs(UC,{camera:{position:[-2,0,7],fov:75},children:[Dt.jsx("ambientLight",{intensity:1}),Dt.jsx("directionalLight",{position:[0,5,5]}),i.map((e,t)=>Dt.jsxs("group",{position:[t*2-4,-1,0],children:[Dt.jsx(r1,{height:e.totalDeaths/25e3,color:"mediumseagreen",position:[-.5,0,0],value:e.totalDeaths}),Dt.jsx(r1,{height:e.totalInfected/25e3,color:"gold",position:[0,0,0],value:e.totalInfected}),Dt.jsx(r1,{height:e.totalRecovered/25e3,color:"mediumpurple",position:[.5,0,0],value:e.totalRecovered}),Dt.jsx(jC,{position:[0,-1.5,0],center:!0,className:"text-xs text-dark-green whitespace-nowrap -translate-x-1/2",children:WY(e.date)})]},e.date))]})}),Dt.jsx(qY,{})]}):Dt.jsx("p",{children:"No data yet"})},s1=({color:i,label:e,percentage:t})=>Dt.jsxs("div",{className:"flex items-center gap-2",children:[Dt.jsx("div",{className:"w-4 h-4 rounded-sm",style:{backgroundColor:i}}),Dt.jsx("span",{className:"text-sm text-dark-green",children:e}),Dt.jsxs("span",{className:"text-sm font-semibold text-gray-900",children:[Math.round(t),"%"]})]}),ZY=({firstDoseProportion:i,secondDoseProportion:e,noDoseProportion:t})=>Dt.jsxs("div",{className:"flex gap-8 p-4 bg-white rounded-lg shadow-sm absolute bottom-10",children:[Dt.jsx(s1,{color:"mediumseagreen",label:"1 dose",percentage:i*100}),Dt.jsx(s1,{color:"mediumpurple",label:"2 doses",percentage:e*100}),Dt.jsx(s1,{color:"gold",label:"No doses",percentage:t*100})]}),o1=({startAngle:i,endAngle:e,radius:t,height:r,color:a,midAngle:h,percentage:y})=>{const[s,T]=Ot.useState(!1),[B,F]=Ot.useState(i),V=Ot.useRef(null),X=[],se=64;NC(!s);const ne=i%(Math.PI*2),K=e%(Math.PI*2),ue=(B-ne)/se;for(let hi=0;hi<=se;hi++){const Pi=ne+ue*hi,Si=Math.cos(Pi)*t,qt=Math.sin(Pi)*t;X.push(new c1(Si,qt))}X.push(new c1(0,0));const _e=new HF(X),ke={steps:1,depth:r,bevelEnabled:!1},we=.2,ge=Math.cos(h)*(s?we:0),Le=Math.sin(h)*(s?we:0),$e=t*.7,Ye=[Math.cos(h)*$e,Math.sin(h)*$e,r+.2],{positionX:St,positionY:Pt,emissiveIntensity:vt,scale:yt}=yL({positionX:ge,positionY:Le,emissiveIntensity:s?.5:0,scale:s?1.05:1,config:{mass:1,tension:280,friction:60}});return _w(()=>{B<K&&F(hi=>Math.min(hi+.05,K))}),Dt.jsxs("group",{children:[Dt.jsxs(mS.mesh,{ref:V,"position-x":St,"position-y":Pt,scale:yt,onPointerOver:()=>T(!0),onPointerOut:()=>T(!1),castShadow:!0,receiveShadow:!0,children:[Dt.jsx("extrudeGeometry",{args:[_e,ke]}),Dt.jsx(mS.meshStandardMaterial,{color:a,side:l1,emissive:a,emissiveIntensity:vt,shadowSide:l1})]}),B>=K&&Dt.jsx(GF,{position:Ye,rotation:[0,0,0],fontSize:.2,color:"#ffffff",anchorX:"center",anchorY:"middle",fontWeight:600,children:`${Math.round(y)}%`})]})},YY=()=>{const{vaccineReport:i}=zC,e=i.firstDose+i.secondDose+i.noDose,t=Math.PI*2,r=-Math.PI/2,a=i.firstDose/e,h=i.secondDose/e,y=i.noDose/e,s=r+a*t,T=s+h*t,B=r+a*t/2,F=s+h*t/2,V=T+y*t/2;return Dt.jsxs("div",{className:"flex flex-col items-center gap-6 relative",children:[Dt.jsxs("h2",{className:"text-xl font-bold absolute top-5 text-custom-purple uppercase text-center",children:["COVID-19 vaccination report",Dt.jsx("br",{}),Dt.jsx("span",{className:"text-dark-green text-sm lowercase",children:"all information accurate as of the present day"})]}),Dt.jsx("div",{className:"w-full h-[450px]",children:Dt.jsxs(UC,{camera:{position:[0,4,2],fov:70},shadows:!0,children:[Dt.jsx("ambientLight",{intensity:2}),Dt.jsx("pointLight",{position:[10,10,10],intensity:.5}),Dt.jsx("directionalLight",{position:[5,5,5],intensity:1.5,castShadow:!0}),Dt.jsxs("group",{rotation:[-Math.PI/2,0,0],receiveShadow:!0,children:[Dt.jsx(o1,{startAngle:r,endAngle:s,radius:1.5,height:.35,color:"mediumseagreen",midAngle:B,percentage:a*100}),Dt.jsx(o1,{startAngle:s,endAngle:T,radius:1.5,height:.45,color:"mediumpurple",midAngle:F,percentage:h*100}),Dt.jsx(o1,{startAngle:T,endAngle:r+t,radius:1.5,height:.2,color:"gold",midAngle:V,percentage:y*100})]}),Dt.jsx($F,{enableZoom:!1})]})}),Dt.jsx(ZY,{firstDoseProportion:a,secondDoseProportion:h,noDoseProportion:y})]})},KY="/reactjs-covid-visualization-map/images/contact_with_contaminated_surfaces.png",JY="/reactjs-covid-visualization-map/images/fecal_oral.png",QY="/reactjs-covid-visualization-map/images/human_to_human.png",BC=[{image:QY,title:"HUMAN TO HUMAN",percentage:75.13},{image:KY,title:"SURFACES CONTACT",percentage:61.56},{image:JY,title:"FECAL-ORAL",percentage:9.43}],eK=[{numerator:12,description:"Cities with a daily increase of over 10000 COVID-19 infections"},{numerator:10,description:"Cities with a daily death toll exceeding 500 due to COVID-19"},{numerator:35,description:"City with a daily recovery count exceeding 2000 from COVID-19"}],tK=({numerator:i,description:e})=>Dt.jsxs("div",{className:"flex flex-col items-center gap-8 max-w-40",children:[Dt.jsxs("div",{className:"flex items-baseline",children:[Dt.jsx("span",{className:"text-5xl font-bold text-orange-500",children:i}),Dt.jsxs("div",{className:"flex items-center ml-0.5",children:[Dt.jsx("div",{className:"h-8 w-[3px] bg-custom-purple rotate-[25deg] translate-y-4"}),Dt.jsx("span",{className:"text-3xl text-custom-purple translate-y-6 ml-1 font-medium",children:"63"})]})]}),Dt.jsx("p",{className:"text-sm text-dark-green leading-tight",children:e})]}),iK=()=>Dt.jsx("div",{className:"flex justify-center gap-16",children:eK.map(i=>Dt.jsx(tK,{...i},i.description))}),rK=()=>Dt.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-md",children:[Dt.jsxs("div",{className:"flex items-center gap-2 mb-6 font-bold uppercase",children:[Dt.jsx("div",{className:"bg-dark-green text-white  flex items-center justify-center rounded-lg text-4xl  px-4 py-2",children:BC.length}),Dt.jsxs("h2",{className:"text-xl",children:[Dt.jsx("span",{className:"text-custom-purple ",children:" Primary Source of"})," ",Dt.jsx("br",{}),Dt.jsx("span",{className:"text-dark-green",children:"COVID-19 transmission"})]})]}),Dt.jsx("div",{className:"space-y-6",children:BC.map(i=>Dt.jsxs("div",{className:"flex items-center justify-between text-dark-green border-b border-gray-200 pb-4",children:[Dt.jsxs("div",{className:"flex items-center gap-4",children:[Dt.jsx("img",{src:i.image,alt:i.title,className:"w-16 h-auto rounded-lg"}),Dt.jsx("span",{className:"font-medium",children:i.title})]}),Dt.jsxs("div",{className:"text-left text-sm",children:[Dt.jsx("p",{children:"Accounts for"}),Dt.jsxs("p",{className:"font-bold text-custom-purple text-xl",children:[i.percentage,"%"]}),Dt.jsx("p",{children:"of the source of infection"})]})]},i.title))}),Dt.jsx("div",{className:"mt-6 text-xs text-gray-500 italic",children:"Source: Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua."})]}),hK=()=>Dt.jsxs("div",{className:"w-full h-screen px-6 py-4 overflow-auto",children:[Dt.jsxs("div",{className:"text-3xl font-bold mb-6 uppercase flex flex-col tracking-wider","data-aos":"fade-right","data-aos-easing":"ease-out-back","data-aos-duration":"1000",children:[Dt.jsx("span",{className:"text-dark-green",children:"Comprehensive Report"})," ",Dt.jsx("span",{className:"text-custom-purple ml-40",children:"of COVID-19 in Vietnam"})]}),Dt.jsxs("div",{className:"grid grid-cols-2 gap-6 ",children:[Dt.jsxs("div",{className:"w-[70%]","data-aos":"fade-right","data-aos-easing":"ease-out-back","data-aos-duration":"1000",children:[Dt.jsx(YY,{}),Dt.jsx(XY,{})]}),Dt.jsxs("div",{className:"w-full max-w-[800px] flex flex-col gap-12","data-aos":"fade-left","data-aos-easing":"ease-out-back","data-aos-duration":"1000",children:[Dt.jsx(iK,{}),Dt.jsx(rK,{})]})]}),Dt.jsx("h2",{className:"text-xl font-bold uppercase text-custom-purple mb-8",children:"COVID Treatment Centers"}),Dt.jsxs("div",{className:"w-full h-screen relative",children:[Dt.jsx(HY,{}),Dt.jsx($Y,{})]})]});export{hK as default};
